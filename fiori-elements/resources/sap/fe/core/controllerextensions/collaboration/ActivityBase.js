/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/ui/core/ws/SapPcpWebSocket"],function(e,t,o,n){"use strict";var r={};var i=n.SUPPORTED_PROTOCOLS;var s=o.Activity;const a="/collaboration";const c="/collaboration/connected";const l="/collaboration/connection";const u="/collaboration/DraftID";function f(e){return!!e.getProperty(c)}r.isCollaborationConnected=f;function d(o,n,r,i,s,f){let d=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;if(s.getProperty(l)){if(s.getProperty(u)===r){return}else{P(s)}}const p=[o];s.setProperty(a,{activeUsers:p,activities:{}});d=d||t.fromQuery(window.location.search).get("useFLPUser")==="true";const h=b(o,n,r,i,d);s.setProperty(l,h);s.setProperty(u,r);h.attachMessage(function(e){const t=e.getParameter("pcpFields");f(t)});h.attachOpen(function(){s.setProperty(c,true)});h.attachError(function(){e.error(`The connection to the websocket channel ${n} could not be established`);s.setProperty(c,false)});h.attachClose(function(){s.setProperty(c,false)})}r.initializeCollaboration=d;function p(e,t,o,n,r,i){if(f(o)){const a=o.getProperty(l);a.send("",{clientAction:e,clientContent:t,clientTriggeredActionName:n,clientRefreshListBinding:r,clientRequestedProperties:i});if(e===s.Activate||e===s.Discard){P(o)}}}r.broadcastCollaborationMessage=p;function P(e){const t=e.getProperty(l);t===null||t===void 0?void 0:t.close();e.setProperty(a,{})}r.endCollaboration=P;function b(e,o,r,s){let a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;const c=window.location;let l;const u=t.fromQuery(window.location.search).get("useBackendUrl");if(u){l=u.replace("https","wss")}else{l=c.protocol==="https:"?"wss:":"ws:";l+=`//${c.host}`}l+=`${(o.startsWith("/")?"":"/")+o}?draft=${r}&relatedService=${s}`;if(a){l+=`&userID=${encodeURI(e.id)}&userName=${encodeURI(e.initialName||"")}`}return new n(l,[i.v10])}return r},false);