/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/TypeGuards","sap/m/MessageToast","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library"],function(t,e,n,o,r,i,a){"use strict";var s={};var c=n.isPathAnnotationExpression;var l=t.UserStatus;var d=t.UserEditingState;var u=t.shareObject;var g=t.getText;var f=t.CollaborationUtils;const C=a.ValueState;const I=async function(t){let e=A("dialog");if(!e){e=await U(t)}await p(t);e.open()};s.openManageDialog=I;async function U(t){const e=t.getController().getExtensionAPI().loadFragment({name:"sap.fe.core.controllerextensions.collaboration.ManageDialog",id:"manageCollaborationDraft",controller:{share:m,addUser:h,removeUser:D,close:O,addUserChanged:v,formatUserStatus:S,formatUserStatusColor:E}});return e.then(function(e){t.addDependent(e);return e}).catch(function(){throw"not this time"})}async function p(t){const e=t.getModel();const n={$select:"UserID,UserDescription,UserEditingState"};const o=e.bindList("DraftAdministrativeData/DraftAdministrativeUser",t.getBindingContext(),[],[],n);const r=t.getBindingContext("internal");return o.requestContexts(0,100).then(function(e){const n=[];const o=t.getModel("internal").getProperty("/collaboration/activeUsers")||[];const i=f.getMe(t);let a;if((e===null||e===void 0?void 0:e.length)>0){e.forEach(function(t){const e=t.getObject();const r=(i===null||i===void 0?void 0:i.id)===e.UserID;const s=o.find(t=>t.id===e.UserID);let c=e.UserDescription||e.UserID;const u=f.formatInitials(c);c+=r?` (${f.getText("C_COLLABORATIONDRAFT_YOU")})`:"";switch(e.UserEditingState){case d.NoChanges:a=s?l.CurrentlyEditing:l.NoChangesMade;break;case d.InProgress:a=s?l.CurrentlyEditing:l.ChangesMade;break;default:a=l.NotYetInvited}const g={id:e.UserID,name:c,status:a,color:f.getUserColor(e.UserID,o,n),initials:u,me:r};n.push(g)})}else{n.push(i)}r.setProperty("collaboration/UserID","");r.setProperty("collaboration/UserDescription","");r.setProperty("collaboration/invitedUsers",n)}).catch(function(){})}s.readInvitedUsers=p;function h(t){const e=t.getSource();const n=e.getBindingContext("internal");const o=n.getProperty("invitedUsers")||[];const r=e.getModel("internal").getProperty("/collaboration/activeUsers");const i={id:n===null||n===void 0?void 0:n.getProperty("UserID"),name:n===null||n===void 0?void 0:n.getProperty("UserDescription")};if(!(o.findIndex(t=>t.id===i.id)>-1||i.id===i.name&&i.id==="")){i.name=i.name||i.id;i.initials=f.formatInitials(i.name);i.color=f.getUserColor(i.id,r,o);i.transient=true;i.status=l.NotYetInvited;o.unshift(i);n.setProperty("invitedUsers",o);n.setProperty("UserID","");n.setProperty("UserDescription","")}}function v(t){const e=t.getSource();t.getParameter("promise").then(function(t){const n=e.getBindingContext("internal");const o=n.getProperty("invitedUsers")||[];if(o.findIndex(e=>e.id===t)>-1){e.setValueState("Error");e.setValueStateText(g("C_COLLABORATIONDRAFT_INVITATION_USER_ERROR"))}else{e.setValueState("None");e.setValueStateText("")}}).catch(function(){throw"User couldn't be determined at all"})}function D(t){T(t.getSource())}function T(t){const e=t.getBindingContext("pageInternal");const n=t.getBindingContext("internal").getProperty("id");let o=e.getProperty("collaboration/invitedUsers");o=o.filter(t=>t.id!==n);e.setProperty("collaboration/invitedUsers",o)}function A(t){return r.byId(`manageCollaborationDraft--${t}`)}function O(){A("dialog").close()}function y(t){var n,o;const r=t.getModel();const i=r.getMetaModel();const a=i.getMetaPath(t.getPath());const s=e.getInvolvedDataModelObjects(i.getContext(a));const l=(n=s.targetObject.entityType.annotations)===null||n===void 0?void 0:(o=n.UI)===null||o===void 0?void 0:o.HeaderInfo;let d="";const u=l===null||l===void 0?void 0:l.Title;if(u){d=c(u.Value)?t.getProperty(u.Value.path):u.Value}return d||(l===null||l===void 0?void 0:l.TypeName)||""}s.getSharedItemName=y;async function m(t){const e=[];const n=t.getSource();const r=n.getBindingContext();const i=A("userList").getBinding("items").getContexts();let a=0;i.forEach(function(t){e.push({UserID:t.getProperty("id"),UserAccessRole:"O"});if(t.getObject().status===0){a++}});try{await u(r,e);o.show(g("C_COLLABORATIONDRAFT_INVITATION_SUCCESS_TOAST",a.toString(),y(r)))}catch{o.show(g("C_COLLABORATIONDRAFT_INVITATION_FAILED_TOAST"))}O()}s.share=m;async function N(t,e){const n=t.getSource();let o=A("userDetails");if(!o){o=await _(e)}o.setBindingContext(n.getBindingContext("internal"),"internal");o.openBy(n,false)}s.showUserDetails=N;async function _(t){const e=i.load({id:"manageCollaborationDraft",name:"sap.fe.core.controllerextensions.collaboration.UserDetails"});return e.then(function(e){t.addDependent(e);return e}).catch(function(){throw"not this time"})}function S(t){switch(t){case l.CurrentlyEditing:return g("C_COLLABORATIONDRAFT_USER_CURRENTLY_EDITING");case l.ChangesMade:return g("C_COLLABORATIONDRAFT_USER_CHANGES_MADE");case l.NoChangesMade:return g("C_COLLABORATIONDRAFT_USER_NO_CHANGES_MADE");case l.NotYetInvited:default:return g("C_COLLABORATIONDRAFT_USER_NOT_YET_INVITED")}}function E(t){switch(t){case l.CurrentlyEditing:return C.Success;case l.ChangesMade:return C.Warning;case l.NoChangesMade:case l.NotYetInvited:default:return C.Information}}return s},false);