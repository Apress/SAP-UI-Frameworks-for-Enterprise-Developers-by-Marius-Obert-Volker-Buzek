/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/navigation/SelectionVariant","sap/ui/core/Core","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../converters/helpers/Aggregation","./editFlow/NotApplicableContextDialog"],function(t,e,o,n,i,r,a,s,l,p,c,g,u,f,d){"use strict";var v,h,y,m,b,O,C,P,A,x,S,M,_,j,w,N,E,$,D,F,V,I,B;var R=f.AggregationHelper;var T=l.getResourceModel;var L=r.publicExtension;var k=r.privateExtension;var W=r.methodOverride;var z=r.finalExtension;var H=r.extensible;var U=r.defineUI5Class;var J=i.convertTypes;function q(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;G(t,e)}function G(t,e){G=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,o){e.__proto__=o;return e};return G(t,e)}function K(t,e,o,n,i){var r={};Object.keys(n).forEach(function(t){r[t]=n[t]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=o.slice().reverse().reduce(function(o,n){return n(t,e,o)||o},r);if(i&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(i):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(t,e,r);r=null}return r}let Q=(v=U("sap.fe.core.controllerextensions.InternalInternalBasedNavigation"),h=W(),y=L(),m=z(),b=L(),O=z(),C=L(),P=z(),A=L(),x=H(u.Instead),S=L(),M=z(),_=k(),j=L(),w=z(),N=L(),E=z(),$=L(),D=z(),F=L(),V=z(),v(I=(B=function(r){q(l,r);function l(){return r.apply(this,arguments)||this}var g=l.prototype;g.onInit=function t(){this._oAppComponent=this.base.getAppComponent();this._oMetaModel=this._oAppComponent.getModel().getMetaModel();this._oNavigationService=this._oAppComponent.getNavigationService();this._oView=this.base.getView()};g.navigate=function t(o,i,r){const l=t=>{const n=r&&r.navigationContexts,s=n&&!Array.isArray(n)?[n]:n,l=r&&r.semanticObjectMapping,g=r&&r.additionalNavigationParameters,u={semanticObject:o,action:i},f=this.base.getView(),d=f.getController();if(t){this._oView.setBindingContext(t)}if(o&&i){let t=[],n=new p;if(s&&s.length){s.forEach(e=>{if(e.isA&&e.isA("sap.ui.model.odata.v4.Context")){let o=e.getObject();const n=this._oMetaModel.getMetaPath(e.getPath());o=this.removeSensitiveData(o,n);const i=this.prepareContextForExternalNavigation(o,e);u["propertiesWithoutConflict"]=i.propertiesWithoutConflict;t.push(i.semanticAttributes)}else if(!(e&&Array.isArray(e.data))&&typeof e==="object"){t.push(this.removeSensitiveData(e.data,e.metaPath))}else if(e&&Array.isArray(e.data)){t=this.removeSensitiveData(e.data,e.metaPath)}})}if(t&&t.length){n=this._oNavigationService.mixAttributesAndSelectionVariant(t,n.toJSONString())}const v=this._oView.getModel(),h=this.getEntitySet(),y=h?this._oNavigationService.constructContextUrl(h,v):undefined;if(y){n.setFilterContextUrl(y)}if(g){this._applyOutboundParams(n,g)}d.intentBasedNavigation.adaptNavigationContext(n,u);if(l){this._applySemanticObjectMappings(n,l)}this._removeTechnicalParameters(n);const m=d._intentBasedNavigation.getNavigationMode();const b=r&&r.refreshStrategies||{},O=f.getModel("internal");if(O){if((f&&f.getViewData()).refreshStrategyOnAppRestore){const t=f.getViewData().refreshStrategyOnAppRestore||{};e(b,t)}const t=a.getRefreshStrategyForIntent(b,o,i);if(t){O.setProperty("/refreshStrategyOnAppRestore",t)}}const C=function(){sap.ui.require(["sap/m/MessageBox"],function(t){const e=c.getLibraryResourceBundle("sap.fe.core");t.error(e.getText("C_COMMON_HELPER_NAVIGATION_ERROR_MESSAGE"),{title:e.getText("C_COMMON_SAPFE_ERROR")})})};this._oNavigationService.navigate(o,i,n.toJSONString(),undefined,C,undefined,m)}else{throw new Error("Semantic Object/action is not provided")}};const g=this.base.getView().getBindingContext();const u=g&&g.getModel().getMetaModel();if(this.getView().getViewData().converterType==="ObjectPage"&&u&&!s.isStickySessionSupported(u)){n.processDataLossOrDraftDiscardConfirmation(l.bind(this),Function.prototype,this.base.getView().getBindingContext(),this.base.getView().getController(),true,n.NavigationType.ForwardNavigation)}else{l()}};g.prepareContextForExternalNavigation=function t(e,o){const n={},i=o.getPath(),r=o.getModel().getMetaModel(),a=r.getMetaPath(i),s=a.split("/").filter(Boolean);function l(t,e){for(const o in t){if(t[o]===null||typeof t[o]!=="object"){if(!n[o]){n[o]=[]}n[o].push(e)}else{const n=t[o];l(n,`${e}/${o}`)}}}l(e,a);const p=s[0],c=r.getObject(`/${p}/@sapui.name`),g={};let u,f,d;for(const t in n){const i=n[t];let s;if(i.length>1){for(let n=0;n<=i.length-1;n++){const s=i[n];let l=s.replace(s===a?a:`${a}/`,"");l=(l===""?l:`${l}/`)+t;const p=r.getObject(`${s}/@sapui.name`);if(p===c){u=l}if(s===a){f=l}d=l;e[`${a}/${l}`.split("/").filter(function(t){return t!=""}).join(".")]=o.getProperty(l)}s=u||f||d;e[t]=o.getProperty(s);u=undefined;f=undefined;d=undefined}else{const n=i[0];let r=n.replace(n===a?a:`${a}/`,"");r=(r===""?r:`${r}/`)+t;e[t]=o.getProperty(r);g[t]=`${a}/${r}`.split("/").filter(function(t){return t!=""}).join(".")}}for(const t in e){if(e[t]!==null&&typeof e[t]==="object"){delete e[t]}}return{semanticAttributes:e,propertiesWithoutConflict:g}};g.prepareFiltersForExternalNavigation=function t(e,o,n){let i;const r={};const a={};let s,l,p,c,g;function u(t){let e;for(let n in t){if(t[n]){if(n.includes("/")){e=n;const t=n.split("/");n=t[t.length-1]}else{e=o}if(!r[n]){r[n]=[]}r[n].push(e)}}}u(e);for(const t in r){const u=r[t];if(u.length>1){for(let r=0;r<=u.length-1;r++){i=u[r];if(i===o){p=`${o}/${t}`;g=t;s=t;if(n&&n.includes(t)){e[`$Parameter.${t}`]=e[t]}}else{g=i;p=`${o}/${i}`.replaceAll(/\*/g,"");l=i}e[p.split("/").filter(function(t){return t!=""}).join(".")]=e[g];delete e[i]}c=s||l;e[t]=e[c]}else{i=u[0];p=i===o?`${o}/${t}`:`${o}/${i}`.replaceAll("*","");a[t]=p.split("/").filter(function(t){return t!=""}).join(".");if(n&&n.includes(t)){e[`$Parameter.${t}`]=e[t]}}}return{filterConditions:e,filterConditionsWithoutConflict:a}};g.getNavigationMode=function t(){return undefined};g.navigateWithConfirmationDialog=async function t(e,o,n){var i;let r=true;if(n!==null&&n!==void 0&&n.notApplicableContexts&&((i=n.notApplicableContexts)===null||i===void 0?void 0:i.length)>=1){const t=this.getView().getModel().getMetaModel();const e=t.getMetaPath(n.notApplicableContexts[0].getPath());const o=J(t);const i=o.resolvePath(e).target;const a=new d({title:"",entityType:i.entityType,resourceModel:T(this.getView()),notApplicableContexts:n.notApplicableContexts});n.navigationContexts=n.applicableContexts;r=await a.open(this.getView())}if(r){this.navigate(e,o,n)}};g._removeTechnicalParameters=function t(e){e.removeSelectOption("@odata.context");e.removeSelectOption("@odata.metadataEtag");e.removeSelectOption("SAP__Messages")};g.getEntitySet=function t(){return this._oView.getViewData().entitySet};g.removeSensitiveData=function t(e,o){if(e){const{transAggregations:t,customAggregates:s}=this._getAggregates(o,this.base.getView(),this.base.getAppComponent().getDiagnostics());const l=Object.keys(e);if(l.length){delete e["@odata.context"];delete e["@odata.metadataEtag"];delete e["SAP__Messages"];for(const p of l){if(e[p]&&typeof e[p]==="object"){this.removeSensitiveData(e[p],`${o}/${p}`)}if(p.indexOf("@odata.type")>-1){delete e[p];continue}this._deleteAggregates([...t,...s],p,e);const l=this._getPropertyAnnotations(p,o,e,this._oMetaModel);if(l){var n,i,r,a;if((n=l.PersonalData)!==null&&n!==void 0&&n.IsPotentiallySensitive||(i=l.UI)!==null&&i!==void 0&&i.ExcludeFromNavigationContext||(r=l.Analytics)!==null&&r!==void 0&&r.Measure){delete e[p]}else if((a=l.Common)!==null&&a!==void 0&&a.FieldControl){const t=l.Common.FieldControl;if(t["$EnumMember"]&&t["$EnumMember"].split("/")[1]==="Inapplicable"||t["$Path"]&&this._isFieldControlPathInapplicable(t["$Path"],e)){delete e[p]}}}}}}return e};g._deleteAggregates=function t(e,o,n){if(e&&e.indexOf(o)>-1){delete n[o]}};g._getPropertyAnnotations=function t(e,o,n,r){if(n[e]&&o&&!o.includes("undefined")){var a;const t=r.createBindingContext(`${o}/${e}`);const n=i.getInvolvedDataModelObjects(t);return n===null||n===void 0?void 0:(a=n.targetObject)===null||a===void 0?void 0:a.annotations}return null};g._getAggregates=function t(e,o,n){const i=this._getConverterContext(e,o,n);const r=new R(i.getEntityType(),i);const a=r.isAnalyticsSupported();let s,l;if(a){var p,c;s=r.getTransAggregations();if((p=s)!==null&&p!==void 0&&p.length){s=s.map(t=>t.Name||t.Value)}l=r.getCustomAggregateDefinitions();if((c=l)!==null&&c!==void 0&&c.length){l=l.map(t=>t.qualifier)}}s=s?s:[];l=l?l:[];return{transAggregations:s,customAggregates:l}};g._getConverterContext=function t(e,n,i){const r=n.getViewData();let a=r.entitySet;const s=r.contextPath;if(s&&(!a||a.includes("/"))){a=r===null||r===void 0?void 0:r.fullContextPath.split("/")[1]}return o.getConverterContextForPath(e,n.getModel().getMetaModel(),a,i)};g._isFieldControlPathInapplicable=function t(e,o){let n=false;const i=e.split("/");if(i.length>1){n=o[i[0]]&&o[i[0]].hasOwnProperty(i[1])&&o[i[0]][i[1]]===0}else{n=o[e]===0}return n};g._applySemanticObjectMappings=function t(e,o){const n=typeof o==="string"?JSON.parse(o):o;for(let t=0;t<n.length;t++){const o=n[t]["LocalProperty"]&&n[t]["LocalProperty"]["$PropertyPath"]||n[t]["@com.sap.vocabularies.Common.v1.LocalProperty"]&&n[t]["@com.sap.vocabularies.Common.v1.LocalProperty"]["$Path"];const i=n[t]["SemanticObjectProperty"]||n[t]["@com.sap.vocabularies.Common.v1.SemanticObjectProperty"];const r=e.getSelectOption(o);if(r){e.removeSelectOption(o);e.massAddSelectOption(i,r)}}return e};g.navigateOutbound=function e(o,n){var i,r;let a;const s=this.base.getAppComponent().getManifestEntry("sap.app"),l=(i=s.crossNavigation)===null||i===void 0?void 0:(r=i.outbounds)===null||r===void 0?void 0:r[o];if(!l){t.error("Outbound is not defined in manifest!!");return}const p=l.semanticObject,c=l.action,g=l.parameters&&this.getOutboundParams(l.parameters);if(n){a=[];Object.keys(n).forEach(function(t){let e;if(Array.isArray(n[t])){const i=n[t];for(let n=0;n<i.length;n++){var o;e={};e[t]=i[n];(o=a)===null||o===void 0?void 0:o.push(e)}}else{var i;e={};e[t]=n[t];(i=a)===null||i===void 0?void 0:i.push(e)}})}if(a||g){n={navigationContexts:{data:a||g}}}this.base._intentBasedNavigation.navigate(p,c,n)};g._applyOutboundParams=function t(e,o){const n=Object.keys(o);const i=e.getSelectOptionsPropertyNames();n.forEach(function(t){if(!i.includes(t)){e.addSelectOption(t,"I","EQ",o[t])}});return e};g.getOutboundParams=function t(e){const o={};if(e){const t=Object.keys(e)||[];if(t.length>0){t.forEach(function(t){const n=e[t];if(n.value&&n.value.value&&n.value.format==="plain"){if(!o[t]){o[t]=n.value.value}}})}}return o};g.onChevronPressNavigateOutBound=function t(e,o,n,i){const r=e.getAppComponent().getRoutingService().getOutbounds();const a=r[o];let l;if(a&&a.semanticObject&&a.action){const t={intents:{}};const o={};let r;if(n){if(n.isA&&n.isA("sap.ui.model.odata.v4.Context")){r=s.getMetaPathForContext(n);n=[n]}else{r=s.getMetaPathForContext(n[0])}o[r]="self";t["_feDefault"]=o}if(i){const e=`${a.semanticObject}-${a.action}`;t.intents[e]={};t.intents[e][i]="self"}if(a&&a.parameters){const t=a.parameters&&this.getOutboundParams(a.parameters);if(Object.keys(t).length>0){l=t}}e._intentBasedNavigation.navigate(a.semanticObject,a.action,{navigationContexts:n,refreshStrategies:t,additionalNavigationParameters:l});return Promise.resolve()}else{throw new Error(`outbound target ${o} not found in cross navigation definition of manifest`)}};return l}(g),K(B.prototype,"onInit",[h],Object.getOwnPropertyDescriptor(B.prototype,"onInit"),B.prototype),K(B.prototype,"navigate",[y,m],Object.getOwnPropertyDescriptor(B.prototype,"navigate"),B.prototype),K(B.prototype,"prepareContextForExternalNavigation",[b,O],Object.getOwnPropertyDescriptor(B.prototype,"prepareContextForExternalNavigation"),B.prototype),K(B.prototype,"prepareFiltersForExternalNavigation",[C,P],Object.getOwnPropertyDescriptor(B.prototype,"prepareFiltersForExternalNavigation"),B.prototype),K(B.prototype,"getNavigationMode",[A,x],Object.getOwnPropertyDescriptor(B.prototype,"getNavigationMode"),B.prototype),K(B.prototype,"navigateWithConfirmationDialog",[S,M],Object.getOwnPropertyDescriptor(B.prototype,"navigateWithConfirmationDialog"),B.prototype),K(B.prototype,"getEntitySet",[_],Object.getOwnPropertyDescriptor(B.prototype,"getEntitySet"),B.prototype),K(B.prototype,"removeSensitiveData",[j,w],Object.getOwnPropertyDescriptor(B.prototype,"removeSensitiveData"),B.prototype),K(B.prototype,"navigateOutbound",[N,E],Object.getOwnPropertyDescriptor(B.prototype,"navigateOutbound"),B.prototype),K(B.prototype,"getOutboundParams",[$,D],Object.getOwnPropertyDescriptor(B.prototype,"getOutboundParams"),B.prototype),K(B.prototype,"onChevronPressNavigateOutBound",[F,V],Object.getOwnPropertyDescriptor(B.prototype,"onChevronPressNavigateOutBound"),B.prototype),B))||I);return Q},false);