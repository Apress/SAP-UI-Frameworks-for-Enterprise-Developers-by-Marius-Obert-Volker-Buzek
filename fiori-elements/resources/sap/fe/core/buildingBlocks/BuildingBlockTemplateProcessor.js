/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/uid","sap/fe/core/buildingBlocks/AttributeModel","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/TypeGuards","sap/ui/base/BindingParser","sap/ui/core/util/XMLPreprocessor","sap/ui/model/json/JSONModel","./TraceInfo"],function(e,t,n,o,i,s,a,r,l,c,d){"use strict";var u={};var f=a.isFunctionArray;var p=a.isContext;var m=s.isBindingToolkitExpression;var g=s.compileExpression;var h=i.Placement;const b="sap.fe.core.buildingBlocks.BuildingBlockTemplateProcessor";const x="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1";const y=new DOMParser;function v(e,t,n,o){const i=t[o];const s=i===null||i===void 0?void 0:i.getObject();if(n.required===true&&(!i||s===null)){throw new Error(`${e}: Required metadataContext '${o}' is missing`)}else if(s){if(s.hasOwnProperty("$kind")&&s.$kind!==undefined&&n.expectedTypes!==undefined){if(n.expectedTypes.indexOf(s.$kind)===-1){throw new Error(`${e}: '${o}' must be '$kind' '${n.expectedTypes}' but is '${s.$kind}': ${i.getPath()}`)}}else if(s.hasOwnProperty("$Type")&&s.$Type!==undefined&&n.expectedAnnotationTypes){if(n.expectedAnnotationTypes.indexOf(s.$Type)===-1){throw new Error(`${e}: '${o}' must be '$Type' '${n.expectedAnnotationTypes}' but is '${s.$Type}': ${i.getPath()}`)}}}}function C(t,n,o,i){const s=n.metadataContexts&&Object.keys(n.metadataContexts)||[],a=n.properties&&Object.keys(n.properties)||[],r={};const l=i.getAttributeNames();for(const e of l){r[e]=true}s.forEach(function(e){const i=n.metadataContexts[e];v(t,o,i,e);delete r[e]});a.forEach(function(e){const o=n.properties[e];if(!i.hasAttribute(e)){if(o.required&&!o.hasOwnProperty("defaultValue")){throw new Error(`${t}: `+`Required property '${e}' is missing`)}}else{delete r[e]}});Object.keys(r).forEach(function(n){if(n.indexOf(":")<0&&!n.startsWith("xmlns")){e.warning(`Unchecked parameter: ${t}: ${n}`,undefined,b)}})}u.validateMacroSignature=C;const $="sap.ui.core.Element";const w="sap.ui.model.Context";u.SAP_UI_MODEL_CONTEXT=w;function P(e){const t={};const n={dependents:{type:$,slot:"dependents"},customData:{type:$,slot:"customData"},layoutData:{type:$,slot:"layoutData"},...e.aggregations};const o={};for(const n of Object.keys(e.properties)){const i=e.properties[n].type;if(i!==w){t[n]=e.properties[n]}if([w,"object","array"].includes(i)){o[n]=e.properties[n]}}return{...e,properties:t,metadataContexts:o,aggregations:n}}function A(e,t){let n;if(t&&t.startsWith("/")){n=t}else{let o=e.currentContextPath.getPath();if(!o.endsWith("/")){o+="/"}n=o+t}return{model:"metaModel",path:n}}function k(e,t,n){let o;if(n.startsWith("/uid--")&&!e.models.converterContext.getProperty(n)){const t=_(n);e.models.converterContext.setProperty(n,t);o={model:"converterContext",path:n}}else if(t==="metaPath"&&e.currentContextPath||t==="contextPath"){o=A(e,n)}else if(n&&n.startsWith("/")){o={model:"metaModel",path:n}}else{o={model:"metaModel",path:e.bindingContexts.entitySet?e.bindingContexts.entitySet.getPath(n):n}}return o}function O(e,t,n,o,i,s){let a;if(!i&&t.hasAttribute(n)){const o=t.getAttribute(n);a=r.complexParser(o);if(!a){a=k(e,n,o)}}else if(e.bindingContexts.hasOwnProperty(n)){a={model:n,path:""}}else if(s){try{if(o.getContext(`${n}>`)){a={model:n,path:""}}}catch(e){return undefined}}return a}async function E(n,o,i,s){const a=n.properties;const r=Object.keys(a);const l={};for(const n of r){if(a[n].type==="object"){l[n]=a[n].defaultValue&&t(a[n].defaultValue)}else{l[n]=a[n].defaultValue}if(o.hasAttribute(n)&&i&&a[n].isPublic===false){e.error(`Property ${n} was ignored as it is not intended for public usage`)}else if(o.hasAttribute(n)){await s.visitAttribute(o,o.attributes.getNamedItem(n));let e=o.getAttribute(n);if(e!==undefined&&e!==null){if(typeof e==="string"&&!e.startsWith("{")){switch(a[n].type){case"boolean":e=e==="true";break;case"number":e=Number(e);break}}e=e===null?undefined:e;l[n]=e}}}return l}function T(e,t,n,o,i,s,a){t.currentContextPath=t.bindingContexts.contextPath;const r={};const l=e.metadataContexts;const c=Object.keys(l);const d=c.indexOf("contextPath");if(d!==-1){const e=c.splice(d,1);c.splice(0,0,e[0])}for(const d of c){const c=a[d];if(c!==undefined&&typeof c==="object"&&Object.keys(c).length>0){delete e.metadataContexts[d];continue}const u=o&&l[d].isPublic===false&&n.hasAttribute(d);const f=O(t,n,d,i,u,e.isOpen??false);if(f){f.name=d;M(s,i,f);if((d==="entitySet"||d==="contextPath")&&!t.bindingContexts.hasOwnProperty(d)){t.bindingContexts[d]=s[d]}if(d==="contextPath"){t.currentContextPath=s[d]}if(s[d]!==undefined){a[d]=s[d]}else if(typeof a[d]==="string"){delete e.metadataContexts[d]}}else{r[d]=true}}return r}function N(t,n){const o={};if(t&&t.children.length>0){const i=t.children;for(let t=0;t<i.length;t++){const s=i[t];let a=s.getAttribute("key")||s.getAttribute("id");if(a){a=`InlineXML_${a}`;s.setAttribute("key",a);let e={key:a,position:{placement:s.getAttribute("placement")||h.After,anchor:s.getAttribute("anchor")||undefined},type:"Slot"};if(n){e=n(s,e)}o[e.key]=e}else if(s.tagName!=="slot"){e.error(`The aggregation ${s.nodeName} is missing a Key attribute. It is not displayed`)}}}return o}async function j(e,t,n,o,i){const s={};if(e.firstElementChild!==null){let a=e.firstElementChild;while(a!==null){if(a.namespaceURI===x){const e=a.parentNode;if(e){const n=Array.from(e.children).indexOf(a);await t.visitNode(a);a=e.children[n]?e.children[n]:null}else{a=a.nextElementSibling}}else{const e=a.localName;let t=e;if(t[0].toUpperCase()===t[0]){t=n.defaultAggregation||""}const o=n.aggregations[t];if(o!==undefined&&!o.slot){const e=N(a,o.processAggregations);i[t]=e;for(const t in e){n.aggregations[t]=e[t]}}a=a.nextElementSibling}}a=e.firstElementChild;while(a!==null){const r=a.nextElementSibling;const l=a.localName;let c=l;if(c[0].toUpperCase()===c[0]){c=n.defaultAggregation||""}if(Object.keys(n.aggregations).indexOf(c)!==-1&&(!o||n.aggregations[c].isPublic===true)){const o=n.aggregations[c];if(!o.slot&&a!==null&&a.children.length>0){await t.visitNode(a);let n=a.firstElementChild;while(n){const t=n.nextElementSibling;if(!o.hasVirtualNode){const t=document.createElementNS(e.namespaceURI,n.getAttribute("key"));t.appendChild(n);s[n.getAttribute("key")]=t}else{s[n.getAttribute("key")]=n}n.removeAttribute("key");n=t}}else if(o.slot){await t.visitNode(a);if(c!==l){if(!s[c]){const t=document.createElementNS(e.namespaceURI,c);s[c]=t}s[c].appendChild(a)}else{s[c]=a}}}else if(Object.keys(n.properties).indexOf(c)!==-1){await t.visitNode(a);if(n.properties[c].type==="object"){const e={};const t=a.getAttributeNames();for(const n of t){e[n]=a.getAttribute(n)}if(a.children.length){for(let t=0;t<a.children.length;t++){const n=a.children[t];const o=n.localName;const i={};const s=n.getAttributeNames();for(const e of s){i[e]=n.getAttribute(e)}e[o]=i}}i[c]=e}else if(n.properties[c].type==="array"){if(a!==null&&a.children.length>0){const e=a.children;const t=[];for(let n=0;n<e.length;n++){const o=e[n];const i={};const s=o.getAttributeNames();for(const e of s){i[e]=o.getAttribute(e)}t.push(i)}i[c]=t}}}a=r}}return s}function B(e,t,n){let o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(Object.keys(e).length>0){Object.keys(e).forEach(function(i){const s=e[i];if(n!==null&&n!==undefined&&s){const e=s.firstElementChild;if(!["dependents","customData","layoutData"].includes(i)){const o=t[i]!==undefined&&t[i].slot||i;const s=n.querySelector(`slot[name='${o}']`);if(s!==null){const t=S(n,i,e);s.replaceWith(...t.children)}}else if(o&&e!==null){const t=S(n,i,e);n.appendChild(t)}}})}}function S(e,t,n){const o=document.createElementNS(e.namespaceURI,t.replace(/:/gi,"_"));while(n){const e=n.nextElementSibling;o.appendChild(n);n=e}return o}async function I(t,n,i){let s=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;const a=P(t.metadata);const r=a.fragment??`${a.namespace??a.publicNamespace}.${a.xmlTag??a.name}`;const l={};const u=i.getSettings();u.models.converterContext??=new c;if(!u[r]){u[r]={}}const f=await E(a,n,s,i);const m=Object.keys(f);const g=T(a,u,n,s,i,l,f);try{const c=await j(n,i,a,s,f);let m={};if(u.models.viewData){m=u.models.viewData.getProperty("/controlConfiguration")}let g=f;Object.keys(f).forEach(e=>{var n,o,i;let s=f[e];const a=t===null||t===void 0?void 0:(n=t.metadata)===null||n===void 0?void 0:n.properties[e];if(a!==null&&a!==void 0&&a.validate){s=a.validate(s)||s}if((o=s)!==null&&o!==void 0&&(i=o.isA)!==null&&i!==void 0&&i.call(o,w)&&!s.getModel().isA("sap.ui.model.odata.v4.ODataMetaModel")){f[e]=s.getObject()}});f.isPublic=s;const h=new t({...f,...c},m,u);g=h.getProperties();Object.keys(a.metadataContexts).forEach(function(e){if(g.hasOwnProperty(e)){const t=g[e];if(p(t)){l[e]=t}else if(typeof t==="object"){const n=F(t);u.models.converterContext.setProperty(n,t);const o=u.models.converterContext.createBindingContext(n);_(n);l[e]=o}}});const b=new o(n,g,t);l["this"]=b.createBindingContext("/");let x;if(d.isTraceInfoActive()){const e=d.traceMacroCalls(r,a,l,n,i);if(e!==null&&e!==void 0&&e.macroInfo){x=u["_macroInfo"];u["_macroInfo"]=e.macroInfo}}C(r,a,l,n);const y=i.with(l,a.isOpen!==undefined?!a.isOpen:true);const v=n.parentNode;let $;let P;if(v){$=Array.from(v.children).indexOf(n);if(a.fragment){P=y.insertFragment(r,n)}else{const o=await h.getTemplate(n);if(t.isRuntime){for(const e in V){const t=_(e);u.models.converterContext.setProperty(e,t)}}let i="";if(o){let t=false;let s=U(o,true);for(const e of s){const n=document.createNodeIterator(e,NodeFilter.SHOW_TEXT);let o=n.nextNode();if(e.localName==="parsererror"){t=true}while(o){if(o.textContent&&o.textContent.trim().length>0){i=o.textContent}o=n.nextNode()}}if(t){e.error(`Error while processing building block ${a.xmlTag||a.name}`);s=await R(async()=>{var e;const t=await((e=h.getTemplate)===null||e===void 0?void 0:e.call(h,n));return U(t??"",true)})}else if(i.length>0){e.error(`Error while processing building block ${a.xmlTag||a.name}`);const t=L([`Error while processing building block ${a.xmlTag||a.name}`,`Trailing text was found in the XML: ${i}`],s.map(e=>e.outerHTML).join("\n"));s=U(t,true)}n.replaceWith(...s);const r=s.map(async e=>{B(c,a.aggregations,e,false);return y.visitNode(e)});P=Promise.all(r)}else{n.remove();P=Promise.resolve()}}await P;const o=v.children[$];B(c,a.aggregations,o,true);if(o!==undefined){const e=o.querySelectorAll("slot");e.forEach(function(e){e.remove()})}}if(x){u["_macroInfo"]=x}else{delete u["_macroInfo"]}}catch(t){const o={initialProperties:{},resolvedProperties:{},missingContexts:g};for(const e of m){const t=f[e];if(p(t)){o.initialProperties[e]={path:t.getPath(),value:t.getObject()}}else{o.initialProperties[e]=t}}for(const e in f){const t=f[e];if(!m.includes(e)){if(p(t)){o.resolvedProperties[e]={path:t.getPath(),value:t.getObject()}}else{o.resolvedProperties[e]=t}}}e.error(t);const i=L([`Error while processing building block ${a.name}`],n.outerHTML,o,t.stack);const s=U(i,true);n.replaceWith(...s)}}function M(e,t,n){const o=n.name||n.model||undefined;if(e[o]){return}try{let i=n.path;if(n.model!==null){i=`${n.model}>${i}`}const s=t.getSettings();if(n.model==="converterContext"&&n.path.length>0){e[o]=s.models[n.model].getContext(n.path)}else if(!s.bindingContexts[n.model]&&s.models[n.model]){e[o]=s.models[n.model].getContext(n.path)}else{e[o]=t.getContext(i)}}catch(e){}}function D(e){if(e.metadata.namespace!==undefined){l.plugIn(async(t,n)=>I(e,t,n),e.metadata.namespace,e.metadata.xmlTag||e.metadata.name)}if(e.metadata.publicNamespace!==undefined){l.plugIn(async(t,n)=>I(e,t,n,true),e.metadata.publicNamespace,e.metadata.xmlTag||e.metadata.name)}}u.registerBuildingBlock=D;function W(e){if(e.metadata.namespace!==undefined){l.plugIn(null,e.metadata.namespace,e.metadata.xmlTag||e.metadata.name)}if(e.metadata.publicNamespace!==undefined){l.plugIn(null,e.metadata.publicNamespace,e.metadata.xmlTag||e.metadata.name)}}u.unregisterBuildingBlock=W;function L(e,t,n,o){const i=e.map(e=>G`<m:Label text="${X(e)}"/>`);let s="";if(o){const e=btoa(`<pre>${o}</pre>`);s=G`<m:FormattedText htmlText="${`{= BBF.base64Decode('${e}') }`}" />`}let a="";if(n){a=G`<m:VBox>
						<m:Label text="Trace Info"/>
						<code:CodeEditor type="json"  value="${`{= BBF.base64Decode('${btoa(JSON.stringify(n,null,4))}') }`}" height="300px" />
					</m:VBox>`}return G`<controls:FormElementWrapper xmlns:controls="sap.fe.core.controls">
					<m:VBox xmlns:m="sap.m" xmlns:code="sap.ui.codeeditor" core:require="{BBF:'sap/fe/core/buildingBlocks/BuildingBlockFormatter'}">
					${i}
					${s}
						<grid:CSSGrid gridTemplateRows="fr" gridTemplateColumns="repeat(2,1fr)" gridGap="1rem" xmlns:grid="sap.ui.layout.cssgrid" >
							<m:VBox>
								<m:Label text="How the building block was called"/>
								<code:CodeEditor type="xml" value="${`{= BBF.base64Decode('${btoa(t.replaceAll("&gt;",">"))}') }`}" height="300px" />
							</m:VBox>
							${a}
						</grid:CSSGrid>
					</m:VBox>
				</controls:FormElementWrapper>`}const V={};function F(e){const t=`/uid--${n()}`;V[t]=e;return t}function _(e){const t=V[e];delete V[e];return t}let q=false;const R=function(e){q=true;let t;try{t=e()}finally{q=false}return t};function U(e){var t,n;let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(o){e=`<template\n\t\t\t\t\t\txmlns:template="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1"\n\t\t\t\t\t\txmlns:m="sap.m"\n\t\t\t\t\t\txmlns:macros="sap.fe.macros"\n\t\t\t\t\t\txmlns:core="sap.ui.core"\n\t\t\t\t\t\txmlns:mdc="sap.ui.mdc"\n\t\t\t\t\t\txmlns:customData="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1">${e}</template>`}const i=y.parseFromString(e,"text/xml");let s=i.firstElementChild;while(((a=s)===null||a===void 0?void 0:a.localName)==="template"){var a;s=s.firstElementChild}const r=(t=s)!==null&&t!==void 0&&t.parentElement?(n=s)===null||n===void 0?void 0:n.parentElement.children:[s];return Array.from(r)}u.parseXMLString=U;function X(e){return e===null||e===void 0?void 0:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}u.escapeXMLAttributeValue=X;function H(e){var t;const n=U(e,true);if((n===null||n===void 0?void 0:n.length)>0&&((t=n[0])===null||t===void 0?void 0:t.localName)==="parsererror"){const t=n[0].innerText||n[0].innerHTML;return L([t.split("\n")[0]],e)}else{return e}}const G=function(e){let t="";let n;for(var o=arguments.length,i=new Array(o>1?o-1:0),s=1;s<o;s++){i[s-1]=arguments[s]}for(n=0;n<i.length;n++){t+=e[n];const o=i[n];if(Array.isArray(o)&&o.length>0&&typeof o[0]==="string"){t+=o.flat(5).join("\n").trim()}else if(f(o)){t+=o.map(e=>e()).join("\n")}else if(m(o)){const e=g(o);t+=X(e)}else if(typeof o==="undefined"){t+="{this>undefinedValue}"}else if(typeof o==="function"){t+=o()}else if(typeof o==="object"&&o!==null){if(p(o)){t+=o.getPath()}else{const e=F(o);t+=`${e}`}}else if(o&&typeof o==="string"&&!o.startsWith("<")&&!o.startsWith("&lt;")){t+=X(o)}else{t+=o}}t+=e[n];t=t.trim();if(q){return H(t)}return t};u.xml=G;return u},false);