/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/PropertyHelper","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","../templating/DataModelPathHelper"],function(t,e,i,r,o,n,s){"use strict";var a={};var c=s.getTargetObjectPath;var f=s.getTargetNavigationPath;var u=s.enhanceDataModelPath;var l=r.getAssociatedTextPropertyPath;var d=i.isProperty;var p=i.isEntityType;var g=i.isComplexType;var h=e.getInvolvedDataModelObjects;var E=e.convertTypes;function y(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;v(t,e)}function v(t,e){v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,i){e.__proto__=i;return e};return v(t,e)}let m=function(e){y(i,e);function i(){return e.apply(this,arguments)||this}a.SideEffectsService=i;var r=i.prototype;r.init=function t(){this.sideEffectsRegistry={oData:{entities:{},actions:{}},control:{}};this.isInitialized=false;this.initPromise=Promise.resolve(this)};r.addControlSideEffects=function t(e,i){if(i.sourceControlId){const t={...i,fullyQualifiedName:`${e}/SideEffectsForControl/${i.sourceControlId}`};const r=this.sideEffectsRegistry.control[e]||{};r[t.sourceControlId]=t;this.sideEffectsRegistry.control[e]=r}};r.executeAction=function t(e,i,r){const o=i.getModel().bindContext(`${e}(...)`,i);return o.execute(r||i.getBinding().getUpdateGroupId())};r.getConvertedMetaModel=function t(){return E(this.getMetaModel(),this.capabilities)};r.getEntityTypeFromContext=function t(e){const i=e.getModel().getMetaModel(),r=i.getMetaPath(e.getPath()),o=i.getObject(r)["$Type"];return o};r.getODataEntitySideEffects=function t(e){return this.sideEffectsRegistry.oData.entities[e]||{}};r.getGlobalODataEntitySideEffects=function t(e){const i=this.getODataEntitySideEffects(e);const r=[];for(const t in i){const e=i[t];if(!e.sourceEntities&&!e.sourceProperties){r.push(e)}}return r};r.getODataActionSideEffects=function t(e,i){if(i){const t=this.getEntityTypeFromContext(i);if(t){var r;return(r=this.sideEffectsRegistry.oData.actions[t])===null||r===void 0?void 0:r[e]}}return undefined};r.initializeSideEffects=function t(e){this.capabilities=e;if(!this.isInitialized){const t={entities:{},properties:{}};const e=this.getConvertedMetaModel();e.entityTypes.forEach(e=>{this.sideEffectsRegistry.oData.entities[e.fullyQualifiedName]=this.retrieveODataEntitySideEffects(e);this.sideEffectsRegistry.oData.actions[e.fullyQualifiedName]=this.retrieveODataActionsSideEffects(e);this.mapSideEffectSources(e,t)});this.sourcesToSideEffectMappings=t;this.isInitialized=true}};r.removeControlSideEffects=function t(e){Object.keys(this.sideEffectsRegistry.control).forEach(t=>{if(this.sideEffectsRegistry.control[t][e]){delete this.sideEffectsRegistry.control[t][e]}})};r.requestSideEffects=function t(e,i,r){this.logRequest(e,i);return i.requestSideEffects(e,r)};r.requestSideEffectsForODataAction=function t(e,i){var r,o;let n;if((r=e.triggerActions)!==null&&r!==void 0&&r.length){n=e.triggerActions.map(t=>this.executeAction(t,i))}else{n=[]}if((o=e.pathExpressions)!==null&&o!==void 0&&o.length){n.push(this.requestSideEffects(e.pathExpressions,i))}return n.length?Promise.all(n):Promise.resolve([])};r.requestSideEffectsForNavigationProperty=function e(i,r,o){const n=this.getEntityTypeFromContext(r);if(n){const e=`${i}/`;const s=this.getODataEntitySideEffects(n);let a=[];let c=[];let f=[];Object.keys(s).filter(t=>{const r=s[t];return(r.sourceProperties||[]).some(t=>t.startsWith(e)&&t.replace(e,"").indexOf("/")===-1)||(r.sourceEntities||[]).some(t=>t.$NavigationPropertyPath===i)}).forEach(t=>{const e=s[t];if(e.triggerAction){this.executeAction(e.triggerAction,r,o)}a=a.concat(e.targetProperties);c=c.concat(e.targetEntities)});const u=this.removeDuplicateTargets({targetProperties:a,targetEntities:c});f=[...u.targetProperties,...u.targetEntities];if(f.length){return this.requestSideEffects(f,r,o).catch(e=>t.error(`SideEffects - Error while processing SideEffects for Navigation Property ${i}`,e))}}return Promise.resolve()};r.getControlEntitySideEffects=function t(e){return this.sideEffectsRegistry.control[e]||{}};r.getSideEffectWhereEntityIsSource=function t(e){return this.sourcesToSideEffectMappings.entities[e]||[]};r.computeFieldGroupIds=function t(e,i){const r=this.getSideEffectWhereEntityIsSource(e).map(t=>this.getFieldGroupIdForSideEffect(t,true));return r.concat(this.getSideEffectWherePropertyIsSource(i).map(t=>this.getFieldGroupIdForSideEffect(t)))};r.getSideEffectWherePropertyIsSource=function t(e){return this.sourcesToSideEffectMappings.properties[e]||[]};r.addTextProperties=function t(e,i){const r=new Set(e.targetProperties);const o=new Set(e.targetEntities.map(t=>t.$NavigationPropertyPath));const n=e.targetProperties.reduce((t,e)=>t.concat(this.getDataModelPropertiesFromAPath(e,i)),[]);for(const t of n){const e=l(t.targetObject);if(e){const i=u(t,e);const n=f(i,true);const s=c(i,true);if(d(i.targetObject)&&!r.has(s)&&!r.has(`${n}${i.navigationProperties.length?"/":""}*`)&&!o.has(`${n}`)){if(t.targetEntitySet!==i.targetEntitySet&&i.navigationProperties&&i.targetEntityType){o.add(n)}else{r.add(s)}}}}return{targetProperties:Array.from(r),targetEntities:Array.from(o).map(t=>({$NavigationPropertyPath:t}))}};r.convertSideEffects=function t(e,i,r){const o=e.TriggerAction;const n=this.convertSideEffectsFormat(e);let s={targetProperties:n.targetProperties,targetEntities:n.targetEntities};s=this.removeBindingParameter(s,r);s=this.addTextProperties(s,i);s=this.removeDuplicateTargets(s);return{...n,...{targetEntities:s.targetEntities,targetProperties:s.targetProperties,triggerAction:o}}};r.convertSideEffectsFormat=function e(i){const r=e=>e?e.reduce((e,r)=>{const o=r.type&&r.value||r;if(o){e.push(o)}else{t.error(`SideEffects - Error while processing TargetProperties for SideEffects ${i.fullyQualifiedName}`)}return e},[]):e;const o=t=>t?t.map(t=>({$NavigationPropertyPath:t.value})):t;return{fullyQualifiedName:i.fullyQualifiedName,sourceProperties:r(i.SourceProperties),sourceEntities:o(i.SourceEntities),targetProperties:r(i.TargetProperties)??[],targetEntities:o(i.TargetEntities)??[]}};r.getDataModelPropertiesFromAPath=function t(e,i){let r=[];const o=this.getConvertedMetaModel();const n=o.entitySets.find(t=>t.entityType===i)||o.singletons.find(t=>t.entityType===i);if(n){const t=this.getMetaModel(),i=t.createBindingContext(`/${n.name}`);if(i){const t=h(i);const o=u(t,e.replace("*","")||"/"),n=o.targetObject;if(d(n)){if(g(n.targetType)){r=r.concat(n.targetType.properties.map(t=>u(o,t.name)))}else{r.push(o)}}else if(p(n)){r=r.concat(o.targetEntityType.entityProperties.map(t=>u(o,t.name)))}i.destroy()}}return r.filter(t=>t.targetObject)};r.getMetaModel=function t(){const e=this.getContext();const i=e.scopeObject;return i.getModel().getMetaModel()};r.getSideEffectsFromSource=function t(e){var i;let r="";const o=p(e);const n=o?e:e.sourceEntityType;const s=(i=e.annotations)===null||i===void 0?void 0:i.Common;if(n&&s){if(!o){var a;const t=(a=e.parameters)===null||a===void 0?void 0:a.find(t=>t.type===n.fullyQualifiedName);r=(t===null||t===void 0?void 0:t.fullyQualifiedName.split("/")[1])??""}return this.getSideEffectsAnnotationFromSource(e).map(t=>this.convertSideEffects(t,n,r))}return[]};r.getSideEffectsAnnotationFromSource=function t(e){var i;const r=[];const o=(i=e.annotations)===null||i===void 0?void 0:i.Common;for(const t in o){const e=o[t];if(this.isSideEffectsAnnotation(e)){r.push(e)}}return r};r.isSideEffectsAnnotation=function t(e){return(e===null||e===void 0?void 0:e.$Type)==="com.sap.vocabularies.Common.v1.SideEffectsType"};r.logRequest=function e(i,r){const o=i.reduce(function(t,e){return`${t}\n\t\t${e.$NavigationPropertyPath||e||""}`},"");t.debug(`SideEffects - Request:\n\tContext path : ${r.getPath()}\n\tProperty paths :${o}`)};r.removeBindingParameter=function t(e,i){if(i){const t=function(t){return t.replace(new RegExp(`^${i}/?`),"")};return{targetProperties:e.targetProperties.map(e=>t(e)),targetEntities:e.targetEntities.map(e=>({$NavigationPropertyPath:t(e.$NavigationPropertyPath)}))}}return{targetProperties:e.targetProperties,targetEntities:e.targetEntities}};r.removeDuplicateTargets=function t(e){const i=e.targetEntities.map(t=>t.$NavigationPropertyPath);const r=new Set(i);const o=new Set(e.targetProperties);const n=Array.from(r).map(t=>({$NavigationPropertyPath:t}));return{targetProperties:Array.from(o),targetEntities:n}};r.retrieveODataActionsSideEffects=function t(e){const i={};const r=e.actions;if(r){Object.keys(r).forEach(t=>{const r=e.actions[t];const o=new Set;let n=[];let s=[];this.getSideEffectsFromSource(r).forEach(t=>{const e=t.triggerAction;n=n.concat(t.targetProperties);s=s.concat(t.targetEntities);if(e){o.add(e)}});const a=this.removeDuplicateTargets({targetProperties:n,targetEntities:s});i[t]={pathExpressions:[...a.targetProperties,...a.targetEntities],triggerActions:Array.from(o)}})}return i};r.retrieveODataEntitySideEffects=function t(e){const i={};this.getSideEffectsFromSource(e).forEach(t=>{i[t.fullyQualifiedName]=t});return i};r.mapSideEffectSources=function t(e,i){for(const t of this.getSideEffectsAnnotationFromSource(e)){var r;for(const r of t.SourceEntities??[]){var o;const n=r.value?(o=r.$target)===null||o===void 0?void 0:o.targetType:e;if(n){if(!i.entities[n.fullyQualifiedName]){i.entities[n.fullyQualifiedName]=[]}i.entities[n.fullyQualifiedName].push({entity:e.fullyQualifiedName,qualifier:t.qualifier})}}const c=((r=t.SourceProperties)===null||r===void 0?void 0:r.length)===1;for(const r of t.SourceProperties??[]){var n,s;if(!i.properties[(n=r.$target)===null||n===void 0?void 0:n.fullyQualifiedName]){var a;i.properties[(a=r.$target)===null||a===void 0?void 0:a.fullyQualifiedName]=[]}i.properties[(s=r.$target)===null||s===void 0?void 0:s.fullyQualifiedName].push({entity:e.fullyQualifiedName,qualifier:t.qualifier,hasUniqueSourceProperty:c})}}};r.getFieldGroupIdForSideEffect=function t(e){let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;const r=e.qualifier?`${e.entity}#${e.qualifier}`:e.entity;return i||e.hasUniqueSourceProperty===true?`${r}$$ImmediateRequest`:r};r.getInterface=function t(){return this};return i}(o);a.SideEffectsService=m;let P=function(t){y(e,t);function e(){return t.apply(this,arguments)||this}var i=e.prototype;i.createInstance=function t(e){const i=new m(e);return i.initPromise};return e}(n);return P},false);