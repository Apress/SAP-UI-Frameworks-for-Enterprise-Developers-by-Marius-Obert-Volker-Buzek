/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/helpers/LoaderUtils","sap/fe/core/manifestMerger/ChangePageConfiguration","sap/fe/core/TemplateModel","sap/ui/core/Component","sap/ui/core/mvc/View","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/Device","sap/ui/model/base/ManagedObjectModel","sap/ui/model/json/JSONModel","sap/ui/VersionInfo","../helpers/DynamicAnnotationPathHelper"],function(e,t,n,o,i,r,s,a,c,l,u,p,g,d){"use strict";var f=d.resolveDynamicExpression;var h=n.applyPageConfigurationChanges;var v=t.requireDependencies;function m(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;C(e,t)}function C(e,t){C=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,n){t.__proto__=n;return t};return C(e,t)}let w=function(t){m(n,t);function n(){return t.apply(this,arguments)||this}var s=n.prototype;s.init=function e(){const t=[];const n=this.getContext();const o=n.scopeObject;const r=i.getOwnerComponentFor(o);const s=r.getMetaModel();this.pageId=r.getLocalId(o.getId());const a=`${r.getMetadata().getComponentName()}::${this.pageId}`;const l=o.getEnhanceI18n()||[];let u;this.oFactory=n.factory;if(l){u=r.getMetadata().getComponentName();for(let e=0;e<l.length;e++){const t=r.getModel(l[e]);if(t&&t.isA("sap.ui.model.resource.ResourceModel")){l[e]=t}else{l[e]=`${u}.${l[e].replace(".properties","")}`}}}const p=`${r.getMetadata().getName()}_${a}_${sap.ui.getCore().getConfiguration().getLanguageTag()}`;t.push(c.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:o,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.macros.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:l,modelName:"sap.fe.i18n"}}).then(e=>{this.oResourceModelService=e;return e.getResourceModel()}));t.push(c.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:s,appComponent:r,component:o}}).then(e=>{this.oCacheHandlerService=e;return e.validateCacheKey(p,o)}));t.push(g.load().then(function(e){let t="";if(!e.libraries){t=sap.ui.buildinfo.buildtime}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(){return"<NOVALUE>"}));this.initPromise=Promise.all(t).then(async e=>{const t=e[0];const n=e[1];const o=r.getSideEffectsService();o.initializeSideEffects(r.getEnvironmentCapabilities().getCapabilities());const[i,s]=await v(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"]);return this.createView(t,a,n,i,s)}).then(function(e){const t=c.get("sap.fe.core.services.CacheHandlerService").getInstance(s);t.invalidateIfNeeded(e,p,o)})};s.refreshView=function t(n){const o=n.getRootControl();if(o){o.destroy()}else if(this.oView){this.oView.destroy()}return this.createView(this.resourceModel,this.stableId,"",this.TemplateConverter,this.MetaModelConverter).then(function(){n.oContainer.invalidate()}).catch(function(t){n.oContainer.invalidate();e.error(t)})};s.createView=async function t(n,s,a,c,g){this.resourceModel=n;this.stableId=s;this.TemplateConverter=c;this.MetaModelConverter=g;const d=this.getContext();const v=d.settings;const m=v.converterType;const C=d.scopeObject;const w=i.getOwnerComponentFor(C);const y=w.getRoutingService().getTargetInformationFor(C).options.settings.fullContextPath;const M=w.getMetaModel();const V=w.getManifest();const I=new p(l).setDefaultBindingMode("OneWay");const S=new p(V);const O=false;let x,D,P,j;function N(){const e=y.split("/");const t=e.reduce(function(e,t){if(t===""){return e}if(e===""){e=`/${t}`}else{const n=M.getObject(`${e}/$NavigationPropertyBinding/${t}`);if(n&&Object.keys(n).length>0){e+="/$NavigationPropertyBinding"}e+=`/${t}`}return e},"");let o=v.viewType||C.getViewType()||"XML";if(o!=="XML"){o=undefined}return{type:o,preprocessors:{xml:{bindingContexts:{entitySet:t?M.createBindingContext(t):null,fullContextPath:y?M.createBindingContext(y):null,contextPath:y?M.createBindingContext(y):null,converterContext:x.createBindingContext("/",undefined,{noResolve:true}),viewData:j?D.createBindingContext("/"):null},models:{entitySet:M,fullContextPath:M,contextPath:M,"sap.fe.i18n":n,metaModel:M,device:I,manifest:S,converterContext:x,viewData:D},appComponent:w}},id:s,viewName:v.viewName||C.getViewName(),viewData:j,cache:{keys:[a],additionalData:{getAdditionalCacheData:()=>x.getData(),setAdditionalCacheData:e=>{x.setData(e)}}},models:{"sap.fe.i18n":n},height:"100%"}}const T=t=>{e.error(t.message,t);P.viewName=v.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";P.preprocessors.xml.models["error"]=new p(t);return C.runAsOwner(()=>r.create(P).then(e=>{this.oView=e;this.oView.setModel(new u(this.oView),"$view");C.setAggregation("rootControl",this.oView);return a}))};try{var $;const t=await w.getService("routingService");const i=t.getTargetInformationFor(C);const d=V["sap.app"]&&V["sap.app"].crossNavigation&&V["sap.app"].crossNavigation.outbounds||{};const v=C.getNavigation()||{};Object.keys(v).forEach(function(e){const t=v[e];let n;if(t.detail&&t.detail.outbound&&d[t.detail.outbound]){n=d[t.detail.outbound];t.detail.outboundDetail={semanticObject:n.semanticObject,action:n.action,parameters:n.parameters}}if(t.create&&t.create.outbound&&d[t.create.outbound]){n=d[t.create.outbound];t.create.outboundDetail={semanticObject:n.semanticObject,action:n.action,parameters:n.parameters}}});j={appComponent:w,navigation:v,viewLevel:i.viewLevel,stableId:s,contentDensities:($=V["sap.ui5"])===null||$===void 0?void 0:$.contentDensities,resourceModel:n,fullContextPath:y,isDesktop:l.system.desktop,isPhone:l.system.phone};if(C.getViewData){var E,F,R,B,L;Object.assign(j,C.getViewData());const e=(V===null||V===void 0?void 0:(E=V["sap.ui5"])===null||E===void 0?void 0:(F=E.routing)===null||F===void 0?void 0:(R=F.targets)===null||R===void 0?void 0:(B=R[this.pageId])===null||B===void 0?void 0:(L=B.options)===null||L===void 0?void 0:L.settings)||{};j=h(e,j,w,this.pageId)}j.isShareButtonVisibleForMyInbox=b.getShareButtonVisibilityForMyInbox(w);const I=w.getShellServices();j.converterType=m;j.shellContentDensity=I.getContentDensity();j.retrieveTextFromValueList=V["sap.fe"]&&V["sap.fe"].form?V["sap.fe"].form.retrieveTextFromValueList:undefined;D=new p(j);if(j.controlConfiguration){for(const e in j.controlConfiguration){if(e.indexOf("[")!==-1){const t=f(e,M);j.controlConfiguration[t]=j.controlConfiguration[e]}}}g.convertTypes(M,w.getEnvironmentCapabilities().getCapabilities());x=new o(()=>{try{const t=w.getDiagnostics();const n=t.getIssues().length;const o=c.convertPage(m,M,j,t,y,w.getEnvironmentCapabilities().getCapabilities(),C);const i=t.getIssues();const r=i.slice(n);if(r.length>0){e.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core")}return o}catch(t){e.error(t,t);return{}}},M);if(!O){P=N();C.setModel(x,"_pageModel");return C.runAsOwner(()=>r.create(P).catch(T).then(e=>{this.oView=e;this.oView.setModel(new u(this.oView),"$view");this.oView.setModel(D,"viewData");C.setAggregation("rootControl",this.oView);return a}).catch(t=>e.error(t.message,t)))}}catch(t){e.error(t.message,t);throw new Error(`Error while creating view : ${t}`)}};s.getView=function e(){return this.oView};s.getInterface=function e(){return this};s.exit=function e(){if(this.oResourceModelService){this.oResourceModelService.destroy()}if(this.oCacheHandlerService){this.oCacheHandlerService.destroy()}this.oFactory.removeGlobalInstance()};return n}(s);let b=function(e){m(t,e);function t(){var t;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++){o[i]=arguments[i]}t=e.call(this,...o)||this;t._oInstanceRegistry={};return t}var n=t.prototype;n.createInstance=function e(n){t.iCreatingViews++;const o=new w(Object.assign({factory:this},n));return o.initPromise.then(function(){t.iCreatingViews--;return o})};n.removeGlobalInstance=function e(){this._oInstanceRegistry={}};t.getShareButtonVisibilityForMyInbox=function e(t){const n=t.getComponentData();if(n!==undefined&&n.feEnvironment){return n.feEnvironment.getShareControlVisibility()}return undefined};t.getNumberOfViewsInCreationState=function e(){return t.iCreatingViews};return t}(a);return b},false);