/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/strings/hash","sap/ui/core/cache/CacheManager","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory"],function(e,t,n,i){"use strict";var s={};function o(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;r(e,t)}function r(e,t){r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,n){t.__proto__=n;return t};return r(e,t)}function a(e,t,n){return new Promise(function(i){jQuery.ajax(e,{method:"GET"}).done(function(s,o,r){n[e]=r.getResponseHeader("ETag")||r.getResponseHeader("Last-Modified");i(t===n[e])}).fail(function(){n[e]="";i(false)})})}let c=function(n){o(i,n);function i(){return n.apply(this,arguments)||this}s.CacheHandlerService=i;var r=i.prototype;r.init=function e(){const t=this.getContext();this.oFactory=t.factory;const n=t.settings;if(!n.metaModel){throw new Error("a `metaModel` property is expected when instantiating the CacheHandlerService")}this.oMetaModel=n.metaModel;this.oAppComponent=n.appComponent;this.oComponent=n.component;this.initPromise=this.oMetaModel.fetchEntityContainer().then(()=>this);this.mCacheNeedsInvalidate={}};r.exit=function e(){this.oFactory.removeGlobalInstance(this.oMetaModel)};r.validateCacheKey=async function e(n,i){let s=true;let o;try{const e=await t.get(n);const r=this.getETags(i);o=JSON.stringify(r);if(e){const t={};const n=JSON.parse(e.cachedETags);const i=await Promise.all(Object.keys(n).map(function(e){if(n[e]){if(r[e]){t[e]=r[e];return n[e]===r[e]}else{return a(e,n[e],t)}}else{t[e]=r[e];return n[e]===r[e]}}));s=i.indexOf(false)>=0;if(Object.keys(t).some(function(e){return!t[e]})){o=null}else{o=s?JSON.stringify(t):e.viewCacheKey}}else if(Object.keys(r).some(function(e){return!r[e]})){s=true;o=null}}catch(e){s=true;o=null}this.mCacheNeedsInvalidate[n]=s;return o};r.invalidateIfNeeded=function e(n,i,s){const o=JSON.stringify(this.getETags(s));if(this.mCacheNeedsInvalidate[i]||n&&n!==o){const e={};e.cachedETags=o;e.viewCacheKey=n;return t.set(i,e)}else{return Promise.resolve()}};r.getETags=function t(n){const i=this.oMetaModel.getETags();Object.keys(i).forEach(function(e){if(i[e]instanceof Date){i[e]=i[e].toISOString()}});const s=this.oAppComponent.getManifest();const o=e(JSON.stringify({sapApp:s["sap.app"],viewData:n.getViewData()}));i["manifest"]=o;return i};r.getInterface=function e(){return this};return i}(n);s.CacheHandlerService=c;let u=function(e){o(t,e);function t(){var t;for(var n=arguments.length,i=new Array(n),s=0;s<n;s++){i[s]=arguments[s]}t=e.call(this,...i)||this;t._oInstanceRegistry={};return t}var n=t.prototype;n.createInstance=function e(t){const n=t.settings.metaModel.getId();let i=this._oInstanceRegistry[n];if(!i){this._oInstanceRegistry[n]=i=new c(Object.assign({factory:this,scopeObject:null,scopeType:"service"},t))}return i.initPromise.then(()=>this._oInstanceRegistry[n]).catch(e=>{this._oInstanceRegistry[n]=null;throw e})};n.getInstance=function e(t){return this._oInstanceRegistry[t.getId()]};n.removeGlobalInstance=function e(t){this._oInstanceRegistry[t.getId()]=null};return t}(i);return u},false);