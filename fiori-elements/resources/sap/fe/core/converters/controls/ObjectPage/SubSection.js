/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/controls/ObjectPage/HeaderFacet","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/TypeGuards","../../annotations/DataField","../../helpers/ConfigurableObject","../../helpers/ID","../../ManifestSettings","../../objectPage/FormMenuActions","../Common/DataVisualization","../Common/Form"],function(e,t,n,a,i,o,s,r,l,c,d,u,v,f){"use strict";var m={};var p=f.isReferenceFacet;var g=f.createFormDefinition;var b=v.getDataVisualizationConfiguration;var I=u.getVisibilityEnablementFormMenuActions;var F=u.getFormHiddenActions;var h=u.getFormActions;var y=d.ActionType;var U=c.getSubSectionID;var C=c.getSideContentID;var D=c.getFormID;var S=c.getCustomSubSectionID;var A=l.Placement;var T=l.OverrideType;var L=l.insertCustomElements;var E=r.isActionWithDialog;var O=s.isPathAnnotationExpression;var M=o.resolveBindingString;var k=o.ref;var P=o.pathInModel;var N=o.or;var $=o.notEqual;var x=o.not;var w=o.ifElse;var R=o.getExpressionFromAnnotation;var V=o.fn;var H=o.equal;var z=o.compileExpression;var j=o.and;var B=i.KeyHelper;var _=a.IssueType;var G=a.IssueSeverity;var q=a.IssueCategory;var W=n.getStashedSettingsForHeaderFacet;var X=n.getHeaderFacetsFromManifest;var K=n.getDesignTimeMetadataSettingsForHeaderFacet;var Q=t.removeDuplicateActions;var J=t.isActionNavigable;var Y=t.getSemanticObjectMapping;var Z=t.getEnabledForAnnotationAction;var ee=t.getActionsFromManifest;var te=t.ButtonType;let ne;(function(e){e["Unknown"]="Unknown";e["Form"]="Form";e["DataVisualization"]="DataVisualization";e["XMLFragment"]="XMLFragment";e["Placeholder"]="Placeholder";e["Mixed"]="Mixed";e["EmbeddedComponent"]="EmbeddedComponent"})(ne||(ne={}));m.SubSectionType=ne;const ae=["com.sap.vocabularies.UI.v1.LineItem","com.sap.vocabularies.UI.v1.Chart","com.sap.vocabularies.UI.v1.PresentationVariant","com.sap.vocabularies.UI.v1.SelectionPresentationVariant"];function ie(e,t,n){const a=e.reduce((e,t)=>{switch(t.$Type){case"com.sap.vocabularies.UI.v1.ReferenceFacet":e.push(t);break;case"com.sap.vocabularies.UI.v1.CollectionFacet":if(t.Facets.find(e=>e.$Type==="com.sap.vocabularies.UI.v1.CollectionFacet")){e.splice(e.length,0,...t.Facets)}else{e.push(t)}break;case"com.sap.vocabularies.UI.v1.ReferenceURLFacet":break}return e},[]);return a.map(e=>{var i;return ue(e,a,t,0,!(e!==null&&e!==void 0&&(i=e.Facets)!==null&&i!==void 0&&i.length),n)})}m.createSubSections=ie;function oe(e){const t=X(e.getManifestWrapper().getHeaderFacets());const n=[];Object.keys(t).forEach(function(e){n.push(t[e]);return n});const a=n.reduce((e,t)=>{if(t.templateEdit){e.push(t)}return e},[]);return a.map(e=>se(e))}m.createCustomHeaderFacetSubSections=oe;function se(e){const t=S(e.key);const n={id:t,key:e.key,title:e.title,type:ne.XMLFragment,template:e.templateEdit||"",visible:e.visible,level:1,sideContent:undefined,stashed:e.stashed,flexSettings:e.flexSettings,actions:{},objectPageLazyLoaderEnabled:false};return n}const re=(e,t)=>{var n,a;return((n=e.ID)===null||n===void 0?void 0:n.toString())||((a=e.Label)===null||a===void 0?void 0:a.toString())||t};function le(e,t,n){const a=F(t,n)||[],i=h(t,n),o=ee(i,n,e,undefined,undefined,a),s={enabled:T.overwrite,visible:T.overwrite,command:T.overwrite},r=L(e,o.actions,s);return{actions:r?I(Q(r)):e,commandActions:o.commandActions}}function ce(e,t){let n=[];switch(e.$Type){case"com.sap.vocabularies.UI.v1.CollectionFacet":n=e.Facets.filter(e=>p(e)).reduce((e,n)=>fe(e,n,t),[]);break;case"com.sap.vocabularies.UI.v1.ReferenceFacet":n=fe([],e,t);break;default:break}return le(n,e,t)}function de(e){const t=H(R(e),true);return z(w(t,te.Ghost,te.Transparent))}function ue(t,n,a,i,o,s){var r,l,c,d,u,v,f,m;const p=U(t);const I=(r=t.annotations)===null||r===void 0?void 0:(l=r.UI)===null||l===void 0?void 0:l.Hidden;const F=x(H(true,R(I)));const h=z(F);const y=h!==undefined&&typeof h==="string"&&h.indexOf("{=")===0&&!O(I);const C=h&&y?h.substring(h.indexOf("{=")+2,h.lastIndexOf("}"))!==undefined:false;const D=z(R(t.Label));const S={id:p,key:re(t,p),title:D,type:ne.Unknown,annotationPath:a.getEntitySetBasedAnnotationPath(t.fullyQualifiedName),visible:h,isVisibilityDynamic:y,level:i,sideContent:undefined,objectPageLazyLoaderEnabled:a.getManifestWrapper().getEnableLazyLoading()};if(s){S.stashed=W(t,t,a);S.flexSettings={designtime:K(t,t,a)}}let A="";i++;switch(t.$Type){case"com.sap.vocabularies.UI.v1.CollectionFacet":const r=t.Facets;const l=r.map((e,t)=>({index:t,facet:e})).filter(e=>{var t,n;let{facet:a}=e;return ae.includes((t=a.Target)===null||t===void 0?void 0:(n=t.$target)===null||n===void 0?void 0:n.term)});const p=r.filter(e=>!l.find(t=>t.facet===e));if(l.length>0){const n=[];const r=[];const c=[];for(const{facet:e}of l){n.push(ue(e,[],a,i,true,s))}if(p.length>0){e.warning(`Warning: CollectionFacet '${t.ID}' includes a combination of either a chart or a table and other content. This can lead to rendering issues. Consider moving the chart or table into a separate CollectionFacet.`);const n={...t};n.Facets=p;r.push(ue(n,[],a,i,o,s))}if(l.find(e=>{let{index:t}=e;return t===0})){c.push(...n);c.push(...r)}else{c.push(...r);c.push(...n)}const d={...S,type:ne.Mixed,level:i,content:c};return d}else{const e=ce(t,a),n={...S,type:ne.Form,formDefinition:g(t,h,a,e.actions),level:i,actions:e.actions.filter(e=>e.facetName===undefined),commandActions:e.commandActions};return n}case"com.sap.vocabularies.UI.v1.ReferenceFacet":if(!t.Target.$target){A=`Unable to find annotationPath ${t.Target.value}`}else{switch(t.Target.$target.term){case"com.sap.vocabularies.UI.v1.LineItem":case"com.sap.vocabularies.UI.v1.Chart":case"com.sap.vocabularies.UI.v1.PresentationVariant":case"com.sap.vocabularies.UI.v1.SelectionPresentationVariant":const e=b(t.Target.value,be(t,n,a),a,undefined,s);const r=S.title?S.title:"";const l=((c=e.visualizations[0])===null||c===void 0?void 0:(d=c.annotation)===null||d===void 0?void 0:d.title)||((u=e.visualizations[0])===null||u===void 0?void 0:u.title);const p=((v=t.annotations)===null||v===void 0?void 0:(f=v.UI)===null||f===void 0?void 0:(m=f.PartOfPreview)===null||m===void 0?void 0:m.valueOf())!==false;const I=ve(l??"",r,o);const U=w(y,j(C,x(H(D,"undefined")),I),j(h!==undefined,D!=="undefined",D!==undefined,F,I));const T={...S,type:ne.DataVisualization,level:i,presentation:e,showTitle:z(I),isPartOfPreview:p,titleVisible:z(U)};return T;case"com.sap.vocabularies.UI.v1.FieldGroup":case"com.sap.vocabularies.UI.v1.Identification":case"com.sap.vocabularies.UI.v1.DataPoint":case"com.sap.vocabularies.UI.v1.StatusInfo":case"com.sap.vocabularies.Communication.v1.Contact":const L=ce(t,a),E={...S,type:ne.Form,level:i,formDefinition:g(t,h,a,L.actions),actions:L.actions.filter(e=>e.facetName===undefined),commandActions:L.commandActions};return E;default:A=`For ${t.Target.$target.term} Fragment`;break}}break;case"com.sap.vocabularies.UI.v1.ReferenceURLFacet":A="For Reference URL Facet";break;default:break}const T={...S,text:A};return T}m.createSubSection=ue;function ve(e,t,n){return N(x(n),$(M(e),M(t)))}m.getTitleVisibility=ve;function fe(e,t,n){const a=t.Target.$target;const i=t.Target.value;let o={};let s=[];let r;[r]=i.split("@");if(r.length>0){if(r.lastIndexOf("/")===r.length-1){r=r.substr(0,r.length-1)}}else{r=undefined}if(a){switch(a.term){case"com.sap.vocabularies.UI.v1.FieldGroup":s=a.Data;o=ee(n.getManifestControlConfiguration(a).actions,n,undefined,undefined,undefined,undefined,t.fullyQualifiedName).actions;break;case"com.sap.vocabularies.UI.v1.Identification":case"com.sap.vocabularies.UI.v1.StatusInfo":if(a.qualifier){s=a}break;default:break}}e=s.reduce((e,i)=>{var o,s,l,c,d,u,v,f,m,p,g,b,I,F,h,U;switch(i.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":if(((o=i.RequiresContext)===null||o===void 0?void 0:o.valueOf())===true){n.getDiagnostics().addIssue(q.Annotation,G.Low,_.MALFORMED_DATAFIELD_FOR_IBN.REQUIRESCONTEXT)}if(((s=i.Inline)===null||s===void 0?void 0:s.valueOf())===true){n.getDiagnostics().addIssue(q.Annotation,G.Low,_.MALFORMED_DATAFIELD_FOR_IBN.INLINE)}if(((l=i.Determining)===null||l===void 0?void 0:l.valueOf())===true){n.getDiagnostics().addIssue(q.Annotation,G.Low,_.MALFORMED_DATAFIELD_FOR_IBN.DETERMINING)}const C={};if(i.Mapping){C.semanticObjectMapping=Y(i.Mapping)}e.push({type:y.DataFieldForIntentBasedNavigation,id:D(t,i),key:B.generateKeyFromDataField(i),text:(c=i.Label)===null||c===void 0?void 0:c.toString(),annotationPath:"",enabled:i.NavigationAvailable!==undefined?z(H(R((d=i.NavigationAvailable)===null||d===void 0?void 0:d.valueOf()),true)):"true",visible:z(x(H(R((u=i.annotations)===null||u===void 0?void 0:(v=u.UI)===null||v===void 0?void 0:(f=v.Hidden)===null||f===void 0?void 0:f.valueOf()),true))),buttonType:de((m=i.annotations)===null||m===void 0?void 0:(p=m.UI)===null||p===void 0?void 0:p.Emphasized),press:z(V("._intentBasedNavigation.navigate",[R(i.SemanticObject),R(i.Action),C])),customData:z({semanticObject:R(i.SemanticObject),action:R(i.Action)})});break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":const S=n.getManifestControlConfiguration(a).actions;const A=B.generateKeyFromDataField(i);e.push({type:y.DataFieldForAction,id:D(t,i),key:A,text:(g=i.Label)===null||g===void 0?void 0:g.toString(),annotationPath:"",enabled:Z(n,i.ActionTarget),binding:r?`{ 'path' : '${r}'}`:undefined,visible:z(x(H(R((b=i.annotations)===null||b===void 0?void 0:(I=b.UI)===null||I===void 0?void 0:(F=I.Hidden)===null||F===void 0?void 0:F.valueOf()),true))),requiresDialog:E(i),buttonType:de((h=i.annotations)===null||h===void 0?void 0:(U=h.UI)===null||U===void 0?void 0:U.Emphasized),press:z(V("invokeAction",[i.Action,{contexts:V("getBindingContext",[],P("","$source")),invocationGrouping:i.InvocationGrouping==="UI.OperationGroupingType/ChangeSet"?"ChangeSet":"Isolated",label:R(i.Label),model:V("getModel",[],P("/","$source")),isNavigable:J(S&&S[A])}],k(".editFlow"))),facetName:i.Inline?t.fullyQualifiedName:undefined});break;default:break}return e},e);return L(e,o)}function me(e){if(e){var t,n;const a=(t=e.annotations)===null||t===void 0?void 0:(n=t.Common)===null||n===void 0?void 0:n.IsActionCritical;if(e.parameters.length>1||a){return"Dialog"}else{return"None"}}else{return"None"}}m.isDialog=me;function pe(e,t){const n={};Object.keys(e).forEach(a=>n[a]=ge(e[a],a,t));return n}m.createCustomSubSections=pe;function ge(e,t,n){const a=e.sideContent?{template:e.sideContent.template,id:C(t),visible:false,equalSplit:e.sideContent.equalSplit}:undefined;let i=e.position;if(!i){i={placement:A.After}}const o=e.visible!==undefined?e.visible:true;const s=o&&typeof o==="string"&&o.indexOf("{=")===0;const r=ee(e.actions,n);const l={type:ne.Unknown,id:e.id||S(t),actions:r.actions,key:t,title:e.title,level:1,position:i,visible:e.visible!==undefined?e.visible:"true",sideContent:a,isVisibilityDynamic:s,objectPageLazyLoaderEnabled:e.enableLazyLoading??false,componentName:"",settings:""};if(e.template||e.name){l.type=ne.XMLFragment;l.template=e.template||e.name||""}else if(e.embeddedComponent!==undefined){l.type=ne.EmbeddedComponent;l.componentName=e.embeddedComponent.name;if(e.embeddedComponent.settings!==undefined){l.settings=JSON.stringify(e.embeddedComponent.settings)}}else{l.type=ne.Placeholder}return l}m.createCustomSubSection=ge;function be(e,t,n){const a=n.getManifestWrapper();if(a.useIconTabBar()){return Ie(e,t)}else{var i,o,s,r,l,c;const a=n.getEntityType();if((i=a.annotations)!==null&&i!==void 0&&(o=i.UI)!==null&&o!==void 0&&(s=o.Facets)!==null&&s!==void 0&&s.length&&((r=a.annotations)===null||r===void 0?void 0:(l=r.UI)===null||l===void 0?void 0:(c=l.Facets)===null||c===void 0?void 0:c.length)>1){return Ie(e,t)}else{return true}}}function Ie(e,t){return t.every(function(t){if(t!==e){if(t.$Type==="com.sap.vocabularies.UI.v1.ReferenceFacet"){var n,a,i,o,s;const e=t;if(((n=e.Target)===null||n===void 0?void 0:(a=n.$target)===null||a===void 0?void 0:a.term)==="com.sap.vocabularies.UI.v1.LineItem"||((i=e.Target)===null||i===void 0?void 0:(o=i.$target)===null||o===void 0?void 0:o.term)==="com.sap.vocabularies.UI.v1.PresentationVariant"||((s=e.Target.$target)===null||s===void 0?void 0:s.term)==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){var r,l,c,d;return((r=e.annotations)===null||r===void 0?void 0:(l=r.UI)===null||l===void 0?void 0:l.Hidden)!==undefined?(c=e.annotations)===null||c===void 0?void 0:(d=c.UI)===null||d===void 0?void 0:d.Hidden:false}return true}else{const e=t;return e.Facets.every(function(e){var t,n,a,i,o,s;const r=e;if(((t=r.Target)===null||t===void 0?void 0:(n=t.$target)===null||n===void 0?void 0:n.term)==="com.sap.vocabularies.UI.v1.LineItem"||((a=r.Target)===null||a===void 0?void 0:(i=a.$target)===null||i===void 0?void 0:i.term)==="com.sap.vocabularies.UI.v1.PresentationVariant"||((o=r.Target)===null||o===void 0?void 0:(s=o.$target)===null||s===void 0?void 0:s.term)==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){var l,c,d,u;return((l=r.annotations)===null||l===void 0?void 0:(c=l.UI)===null||c===void 0?void 0:c.Hidden)!==undefined?(d=r.annotations)===null||d===void 0?void 0:(u=d.UI)===null||u===void 0?void 0:u.Hidden:false}return true})}}return true})}return m},false);