/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticDateOperators","sap/fe/core/templating/DisplayModeFormatter","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/DraftEditState","sap/ui/core/Core","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/odata/v4/TypeUtil","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/v4/ODataUtils"],function(t,e,n,i,o,r,a,s,l,c,f,d,u,g,p,y,h,C,m,F,v,T,P,S){"use strict";var b=f.ODATA_TYPE_MAPPING;var M=s.getAllCustomAggregates;const E={getFilter:function(t){const e=E.getFilterInfo(t).filters;return e.length?new T(E.getFilterInfo(t).filters,false):undefined},getFilterField:function(t,e,n){return o.getFilterField(t,e,n)},buildProperyInfo:function(t,e){let n;const i={};const r=e.getConverterContextFor(t.annotationPath);const a=r.getDataModelObjectPath().targetObject;const s=o.fetchTypeConfig(a);n=o.fetchPropertyInfo(e,t,s);i[t.key]=s;n=o.assignDataTypeToPropertyInfo(n,e,[],i);return n},createConverterContext:function(t,e,o,s){const l=u.getCustomData(t,"entityType"),c=e||l;const f=t.isA?i.getTargetView(t):null;const d=o||t.getModel().getMetaModel();const g=s||f&&i.getAppComponent(f);const p=a.getInvolvedDataModelObjects(d.createBindingContext(c));let y;if(t.isA&&!t.isA("sap.ui.mdc.filterbar.vh.FilterBar")){y=f&&f.getViewData()||{}}return r.createConverterContextForMacro(p.startingEntitySet.name,d,g===null||g===void 0?void 0:g.getDiagnostics(),n,p.contextLocation,y)},getConvertedFilterFields:function(t,e,n,i,o,r,a){const s=this._getFilterMetaModel(t,i);const l=u.getCustomData(t,"entityType"),c=e||l;const f=this._getFieldsForTable(t,e);const d=this.createConverterContext(t,e,i,o);return this._getSelectionFields(t,e,l,c,f,s,d,n,r,a)},getBindingPathForParameters:function(t,e,i,o){const r=[];i=E.setTypeConfigToProperties(i);for(let a=0;a<o.length;a++){const s=o[a];if(e[s]&&e[s].length>0){const o=n({},e[s][0]);const a=v.getPropertyByKey(i,s);const l=a.typeConfig||m.getTypeConfig(a.dataType,a.formatOptions,a.constraints);const c=h.toType(o,l,t.getTypeUtil());const f=b[l.className];r.push(`${s}=${encodeURIComponent(S.formatLiteral(c.values[0],f))}`)}}const a=t.data("entityType");const s=a.substring(0,a.length-1);const l=s.slice(0,s.lastIndexOf("/"));const c=s.substring(s.lastIndexOf("/")+1);return`${l}(${r.toString()})/${c}`},getEditStateIsHideDraft:function(t){let e=false;if(t&&t.$editState){const n=t.$editState.find(function(t){return t.operator==="DRAFT_EDIT_STATE"});if(n&&(n.values.includes("ALL_HIDING_DRAFTS")||n.values.includes("SAVED_ONLY"))){e=true}}return e},getFilterInfo:function(t,e,n){let i=e&&e.ignoredProperties||[];const o=e&&e.targetControl,r=o?o.data("entityType"):undefined;const a={};let s=t,l,c=[],f,d=e&&e.propertiesMetadata;if(typeof t==="string"){s=p.byId(t)}if(s){l=this._getSearchField(s,i);const t=this._getFilterConditions(e,n,s);let o=s.getPropertyInfoSet?s.getPropertyInfoSet():null;o=this._getFilterPropertiesMetadata(o,s);if(e&&e.targetControl&&e.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(t).forEach(function(e){if(e==="$editState"){delete t["$editState"]}})}let u=s.data("parameters")||[];u=typeof u==="string"?JSON.parse(u):u;if(u&&u.length>0){f=E.getBindingPathForParameters(s,t,o,u);if(Object.keys(t).length){Object.keys(t).forEach(e=>{u.forEach(n=>{if(e===n){const i=t[e][0].values;a[n]=i[0]}})})}}if(t){if(r&&s.data("entityType")!==r){const t=s.getModel().getMetaModel();const e=s.getControlDelegate().fetchPropertiesForEntity(r,t,s);d=e;const n={};for(const t in e){const i=e[t];n[i.name]={hasProperty:true,dataType:i.dataType}}const a=this._getIgnoredProperties(o,n);if(a.length>0){i=i.concat(a)}}else if(!d){d=o}const e=v.getFilterInfo(s,t,E.setTypeConfigToProperties(d),i.concat(u)).filters;c=e?[e]:[]}}return{parameters:a,filters:c,search:l||undefined,bindingPath:f}},setTypeConfigToProperties:function(t){if(t&&t.length){t.forEach(function(t){if(t.typeConfig&&t.typeConfig.typeInstance&&t.typeConfig.typeInstance.getConstraints instanceof Function){return}if(t.path==="$editState"){t.typeConfig=m.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(t.path==="$search"){t.typeConfig=m.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(t.dataType||t.typeConfig&&t.typeConfig.className){t.typeConfig=m.getTypeConfig(t.dataType||t.typeConfig.className,t.formatOptions,t.constraints)}})}return t},getNotApplicableFilters:function(t,e){var n;const i=e.data("entityType"),o=t.data("entityType"),r=t.getModel().getMetaModel().getObject(o),a=[],s=t.getConditions(),l=t.getModel().getMetaModel(),c=i===t.data("entityType"),f=e.isA("sap.ui.mdc.Chart"),g=!f&&e.getParent().getTableDefinition().enableAnalytics,p=!f&&((n=e.control)===null||n===void 0?void 0:n.type)==="TreeTable",y=f?d.parseCustomData(u.getCustomData(e,"applySupported")).enableSearch:!(g||p)||e.getParent().getTableDefinition().enableBasicSearch;if(s&&(!c||g||f)){const n=c?[]:t.getControlDelegate().fetchPropertiesForEntity(i,l,t),o=n.reduce(function(t,e){t[e.name]=e;return t},{}),d=!f&&e.getParent().getTableDefinition().aggregates||{},u={};Object.keys(d).forEach(function(t){const e=d[t];u[e.relativePath]=e});const g=e.getModel().getMetaModel().getObject(e.data("targetCollectionPath")+"/");if(e.isA("sap.ui.mdc.Chart")){const t=e.getModel().getMetaModel().getObject(`${e.data("targetCollectionPath")}@`),n=M(t);Object.keys(n).forEach(function(t){if(!u[t]){const e=n[t];u[t]=e}})}for(const t in s){const e=s[t];let n=true;if(g[t]&&r[t]){n=g[t]["$Type"]===r[t]["$Type"]}if(Array.isArray(e)&&e.length>0&&((!o[t]||o[t]&&!n)&&(!c||t==="$editState"&&f)||u[t])){a.push(t.replace(/\+|\*/g,""))}}}if(!y&&t.getSearch()){a.push("$search")}return a},async _getValueListInfo(t,e){var n;const i=(n=t.getModel())===null||n===void 0?void 0:n.getMetaModel();if(!i){return undefined}const o=t.data("entityType")??"";const r=await i.requestValueListInfo(o+e,true,undefined).catch(()=>null);return r===null||r===void 0?void 0:r[""]},_getConditionValidated:async function(t,e,n){if(!t){return C.NotValidated}const i=new T({path:e,operator:P.EQ,value1:n});const o=t.$model.bindList(`/${t.CollectionPath}`,undefined,undefined,i,{$select:e});const r=(await o.requestContexts()).length>0;if(r){return C.Validated}else{return C.NotValidated}},clearFilterValues:async function(t){var n;if(!t){return}const i=await F.retrieveExternalState(t);const o="$editState";const r=g.ALL.id;const a=e((n=i.filter[o])===null||n===void 0?void 0:n[0]);const s=(a===null||a===void 0?void 0:a.values[0])===r;for(const t of Object.keys(i.filter)){if(t===o&&s){continue}for(const e of i.filter[t]){e.filtered=false}}await F.applyExternalState(t,{filter:i.filter});if(a&&!s){a.values=[r];await F.applyExternalState(t,{filter:{[o]:[a]}})}t.getParent().fireAfterClear()},async _clearFilterValue(t,e){const n=await F.retrieveExternalState(t);if(n.filter[e]){n.filter[e].forEach(t=>{t.filtered=false});await F.applyExternalState(t,{filter:{[e]:n.filter[e]}})}},setFilterValues:async function(e,n){for(var i=arguments.length,o=new Array(i>2?i-2:0),r=2;r<i;r++){o[r-2]=arguments[r]}let a=o===null||o===void 0?void 0:o[0];let s=o===null||o===void 0?void 0:o[1];if(!e){return}if(o.length===2&&(s===undefined||s===null||s==="")&&a&&Object.keys(P).indexOf(a)!==-1){t.warning(`An empty filter value cannot be applied with the ${a} operator`);return}if(s===undefined&&!c.getSemanticDateOperations().includes(a||"")){s=a??[];a=undefined}if(!a){a=P.EQ}const l=["string","number","boolean"];if(s!==undefined&&(!Array.isArray(s)&&!l.includes(typeof s)||Array.isArray(s)&&s.length>0&&!l.includes(typeof s[0]))){throw new Error("FilterUtils.js#_setFilterValues: Filter value not supported; only primitive values or an array thereof can be used.")}let f;if(s!==undefined){f=Array.isArray(s)?s:[s]}const d=await this._getValueListInfo(e,n);const u={};if(n){if(f&&f.length){if(a===P.BT){u[n]=[y.createCondition(a,f,null,null,C.NotValidated)]}else{u[n]=await Promise.all(f.map(async t=>{const e=a===P.EQ?await this._getConditionValidated(d,n,t):C.NotValidated;return y.createCondition(a,[t],null,null,e)}))}}else if(c.getSemanticDateOperations().includes(a||"")){u[n]=[y.createCondition(a,[],null,null,C.NotValidated)]}}await this._clearFilterValue(e,n);if(u[n]){await F.applyExternalState(e,{filter:u})}},conditionToModelPath:function(t){return t.replace(/\//g,"\\")},_getFilterMetaModel:function(t,e){return e||t.getModel().getMetaModel()},_getEntitySetPath:function(t){return t&&l.getEntitySetPath(t)},_getFieldsForTable:function(t,e){const n=[];if(e){const e=i.getTargetView(t);const o=e&&e.getController()&&e.getController()._getControls&&e.getController()._getControls("table");if(o){o.forEach(function(t){n.push(t.getParent().getTableDefinition())})}return n}return[]},_getSelectionFields:function(t,e,n,i,r,s,l,c,f,d){let u=o.getSelectionFields(l,r,undefined,c,d).selectionFields;if((f?f.getControlType(t)==="sap.ui.mdc.FilterBar":t.isA("sap.ui.mdc.FilterBar"))&&e!==n){const t=a.getInvolvedDataModelObjects(s.createBindingContext(i));const e=l.getConverterContextFor(n);const r=e.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];const c={};u.forEach(function(t){c[t.conditionPath]=true});r.forEach(function(e){const n=e.value;if(!c[n]){const e=o.getFilterField(n,l,t.startingEntitySet.entityType);if(e){u.push(e)}}})}if(u){const e=[];u.forEach(function(t){e.push(t.key)});u=this._getSelectionFieldsFromPropertyInfos(t,e,u)}return u},_getSelectionFieldsFromPropertyInfos:function(t,e,n){const i=t.getPropertyInfo&&t.getPropertyInfo()||[];i.forEach(function(t){if(t.name==="$search"||t.name==="$editState"){return}const i=n[e.indexOf(t.key)];if(e.indexOf(t.key)!==-1&&i.annotationPath){t.group=i.group;t.groupLabel=i.groupLabel;t.settings=i.settings;t.visualFilter=i.visualFilter;t.label=i.label;n[e.indexOf(t.key)]=t}if(e.indexOf(t.key)===-1&&!t.annotationPath){n.push(t)}});return n},_getSearchField:function(t,e){return t.getSearch&&e.indexOf("search")===-1?t.getSearch():null},_getFilterConditions:function(t,e,n){const i=e||n.getConditions();if(t&&t.targetControl&&t.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(i).forEach(function(t){if(t==="$editState"){delete i["$editState"]}})}return i},_getFilterPropertiesMetadata:function(t,e){if(!(t&&t.length)){if(e.getPropertyInfo){t=e.getPropertyInfo()}else{t=null}}return t},_getIgnoredProperties:function(t,e){const n=[];t.forEach(function(t){const i=t.name;const o=e[i];if(o&&(!o["hasProperty"]||o["hasProperty"]&&t.dataType!==o.dataType)){n.push(i)}});return n},getFilters:function(t){const{parameters:e,filters:n,search:i}=this.getFilterInfo(t);return{parameters:e,filters:n,search:i}}};return E},false);