/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/type/TypeUtil","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/m/inputUtils/highlightDOMElements","sap/ui/mdc/condition/Condition","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/ValueHelpDelegate","sap/ui/model/FilterType"],function(e,t,n,i,o,r,a,l,s,u){"use strict";const d="sap.fe.core.controls.FilterBar";const c="sap.ui.mdc.filterbar.FilterBarBase";return Object.assign({},s,{isSearchSupported:function(e,t,n){return t.getFilterFields()==="$search"},updateBindingInfo:function(e,n,i){s.updateBindingInfo(e,n,i);if(n.getFilterFields()==="$search"){const e=n.getFilterValue();const o=t.normalizeSearchTerm(e);if(i.parameters){i.parameters.$search=o||undefined}}},updateBinding:function(e,t,n){const i=t.getRootBinding()||t;if(!i.isSuspended()){i.suspend()}if(n.parameters){t.changeParameters(n.parameters)}t.filter(n.filters,u.Application);if(i.isSuspended()){i.resume()}},executeFilter:async function(e,t,n,i){t.getContexts(0,i);await this.checkListBindingPending(e,t,i);return t},checkListBindingPending:async function(e,t,n){if(!t||t.isSuspended()){return false}const i=await t.requestContexts(0,n);return i.length===0},getTypeUtil:function(e){return n},retrieveContent:function(e,t,n){return i.showValueList(e,t,n)},_getConditionPayloadList:function(e){const t=e.payload||{},n=Object.keys(t),i=n.length?t[n[0]]:[];return i},_onConditionPropagationToFilterBar:async function(t,n,i,o){try{const e=await l.retrieveExternalState(o);const s=t.getFilterItems();for(const t of n){const n=this._getConditionPayloadList(t);for(const t of i){const i=t.source.split("/").pop()||"";if(s.find(e=>e.getId().split("::").pop()===i)){for(const o of n){const n=r.createCondition("EQ",[o[t.helpPath]],null,null,a.Validated);e.filter[i]||=[];e.filter[i].push(n)}}}}l.applyExternalState(o,e)}catch(t){const n=t instanceof Error?t.message:String(t);e.error(`ValueHelpDelegate: ${n}`)}},_onConditionPropagationToBindingContext:function(t,n,i){const o=i.getModel().getMetaModel();for(const r of t){const t=this._getConditionPayloadList(r),a=t.length===1?t[0]:undefined;if(t.length>1){e.warning("ValueHelpDelegate: ParameterOut in multi-value-field not supported")}if(a){this._onConditionPropagationUpdateProperty(o,a,n,i)}}},_onConditionPropagationUpdateProperty:function(e,t,n,i){for(const r of n){if(i.getProperty(r.source)!==t[r.helpPath]){var o;const t=((o=i.getPath())===null||o===void 0?void 0:o.split("(")[0])+`/${r.source}`;const n=e===null||e===void 0?void 0:e.getObject(`${t}@com.sap.vocabularies.Common.v1.Text`);if(n!==undefined){const e=n===null||n===void 0?void 0:n.$Path;i.requestSideEffects([e.split("/")[0]])}}i.setProperty(r.source,t[r.helpPath])}},onConditionPropagation:async function(e,t,n,o){if(n!=="ControlChange"){return}const r=e.qualifiers[e.valueHelpQualifier];const a=(r===null||r===void 0?void 0:r.vhParameters)!==undefined?i.getOutParameters(r.vhParameters):[],l=t.getControl(),s=l.getParent();let u=l.getConditions();u=u.filter(function(t){const n=t.payload||{};return n[e.valueHelpQualifier]});if(s.isA(c)){const e=t.getParent();if(e.isA(d)){await this._onConditionPropagationToFilterBar(e,u,a,s)}}else{const e=t.getBindingContext();if(e){this._onConditionPropagationToBindingContext(u,a,e)}}},_createInitialFilterCondition:function(t,n){let i;if(t===undefined||t===null){e.error("ValueHelpDelegate: value of the property could not be requested")}else if(t===""){if(n){i=r.createCondition("Empty",[],null,null,a.Validated)}}else{i=r.createCondition("EQ",[t],null,null,a.Validated)}return i},_getInitialFilterConditionsFromBinding:async function(t,n,i){const o=i.map(e=>e.source);const r=n.getBindingContext();if(!r){e.error("ValueHelpDelegate: No BindingContext");return t}const a=await r.requestProperty(o);for(let e=0;e<i.length;e++){const n=i[e];const o=this._createInitialFilterCondition(a[e],n.initialValueFilterEmpty);if(o){t[n.helpPath]=[o]}}return t},_getInitialFilterConditionsFromFilterBar:async function(e,t,n){const i=t.getParent();const o=await l.retrieveExternalState(i);for(const t of n){const n=t.source.split("/").pop();const i=o.filter[n];if(i){e[t.helpPath]=i}}return e},_partitionInParameters:function(e){const t={constant:[],binding:[],filter:[]};for(const n of e){if(n.constantValue!==undefined){t.constant.push(n)}else if(n.source.indexOf("$filter")===0){t.filter.push(n)}else{t.binding.push(n)}}return t},_tableAfterRenderDelegate:{onAfterRendering:function(e){const t=e.srcControl,n=t.$().find("tbody .sapMText"),i=t.getParent();o(n,i.getFilterValue(),true)}},getInitialFilterConditions:async function(t,n,o){if(n!==null&&n!==void 0&&n.isA("sap.ui.mdc.valuehelp.content.MTable")){const e=n.getTable();e===null||e===void 0?void 0:e.removeEventDelegate(this._tableAfterRenderDelegate);e===null||e===void 0?void 0:e.addEventDelegate(this._tableAfterRenderDelegate,this)}const r={};if(!o){e.error("ValueHelpDelegate: Control undefined");return r}const a=t.qualifiers[t.valueHelpQualifier];const l=(a===null||a===void 0?void 0:a.vhParameters)!==undefined?i.getInParameters(a.vhParameters):[];const s=this._partitionInParameters(l);const u=o.getBindingContext();for(const e of s.constant){const t=this._createInitialFilterCondition(e.constantValue,u?e.initialValueFilterEmpty:false);if(t){r[e.helpPath]=[t]}}if(s.binding.length){await this._getInitialFilterConditionsFromBinding(r,o,s.binding)}if(s.filter.length){await this._getInitialFilterConditionsFromFilterBar(r,o,s.filter)}return r},createConditionPayload:function(e,t,n,i){const o=e.qualifiers[e.valueHelpQualifier],r={},a={};const l=t.getControl();const s=l===null||l===void 0?void 0:l.isA("sap.ui.mdc.MultiValueField");if(!o.vhKeys||o.vhKeys.length===1||s){return undefined}o.vhKeys.forEach(function(e){const t=i.getObject(e);if(t!=null){r[e]=(t===null||t===void 0?void 0:t.length)===0?"":t}});if(Object.keys(r).length){a[e.valueHelpQualifier]=[r]}return a},isFilterableListItemSelected:function(e,t,n,i){var o;if(e.isValueListWithFixedValues!==true&&((o=t.getConfig())===null||o===void 0?void 0:o.maxConditions)===1){return false}const r=n.getBindingContext();i=i.filter(e=>e.validated===a.Validated);const l=i.find(function(n){var i;const o=n.payload,a=e.valueHelpQualifier||"";if(!o&&Object.keys(e.qualifiers)[0]===a){const e=t.getKeyPath();return(r===null||r===void 0?void 0:r.getObject(e))===(n===null||n===void 0?void 0:n.values[0])}const l=(o===null||o===void 0?void 0:(i=o[a])===null||i===void 0?void 0:i[0])||{},s=Object.keys(l);if(s.length){return s.every(function(e){return l[e]===(r===null||r===void 0?void 0:r.getObject(e))})}return false});return l?true:false}})},false);