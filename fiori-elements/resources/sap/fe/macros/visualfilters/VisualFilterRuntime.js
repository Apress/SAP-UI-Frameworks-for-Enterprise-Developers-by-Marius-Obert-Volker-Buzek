/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controls/filterbar/utils/VisualFilterUtils","sap/fe/core/templating/FilterHelper","sap/fe/core/type/TypeUtil","sap/fe/macros/CommonHelper","sap/fe/macros/filter/FilterUtils","sap/ui/core/Core","sap/ui/mdc/condition/Condition","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,r,n,i,o,s,a,l,f,c){"use strict";var u=r.getFiltersConditionsFromSelectionVariant;const g={selectionChanged(r){const n=r.getSource();const i=n.data("outParameter");const o=n.data("valuelistProperty");const s=n.data("dimension");const l=n.data("dimensionText");const f=n.data("multipleSelectionAllowed");const c=n.data("dimensionType");const u=r.getParameter("bar")||r.getParameter("point")||r.getParameter("segment");const g=r.getParameter("selected");const d=n.getModel("$field");let p=d.getProperty("/conditions");if(!i||o!==s){e.error("VisualFilter: Cannot sync values with regular filter as out parameter is not configured properly!")}else{let r=u.getBindingContext().getObject(o);if(r){let e=u.getBindingContext().getObject(l);if(typeof e!=="string"&&!(e instanceof String)){e=undefined}if(g){if(f==="false"){p=[]}if(c==="Edm.DateTimeOffset"){r=t._parseDateTime(r)}const n=a.createItemCondition(r,e||undefined,{},{});p.push(n)}else{p=p.filter(function(e){if(c==="Edm.DateTimeOffset"){return e.operator!=="EQ"||Date.parse(e.values[0])!==Date.parse(r)}return e.operator!=="EQ"||e.values[0]!==r})}d.setProperty("/conditions",p)}else{e.error("VisualFilter: No vaue found for the outParameter")}}},getAggregationSelected(e){var r;let n=[];if(!this.getBindingContext()){return}for(let t=0;t<=e.length-1;t++){const r=e[t];if(r.operator==="EQ"){n.push(r.values[0])}}const i=this.getParent();const o=i.data("dimension");const s=i.data("dimensionType");let a=(r=this.getBindingContext())===null||r===void 0?void 0:r.getObject(o);if(s==="Edm.DateTimeOffset"){a=t._parseDateTime(a)}if(i.data("multipleSelectionAllowed")==="false"&&n.length>1){n=[n[0]]}return n.indexOf(a)>-1},getFiltersFromConditions(){var e,r,a;for(var g=arguments.length,d=new Array(g),p=0;p<g;p++){d[p]=arguments[p]}const m=this.getParent();const h=(e=m.getParent())===null||e===void 0?void 0:(r=e.getParent())===null||r===void 0?void 0:(a=r.getParent())===null||a===void 0?void 0:a.getParent();const y=m.data("inParameters").customData;const P=m.data("draftSupported")==="true";const E=h.getPropertyInfo();const T={};const v=[];let F;let C=[];const L=m.data("parameters").customData;const _=i.parseCustomData(m.data("selectionVariantAnnotation"));const S=m.getBinding("bars")||m.getBinding("points")||m.getBinding("segments");const b=S.getPath();const O=m.getModel().getMetaModel();const I=S.getPath();const D=u(I,O,_,t.getCustomConditions.bind(t));for(const e in E){E[e].typeConfig=n.getTypeConfig(E[e].dataType,{},{})}const M=t.convertFilterCondions(D);Object.keys(M).forEach(function(e){T[e]=M[e];const r=y.find(function(t){return t.valueListProperty===e});const n=r?r.localDataProperty:e;if(!L||L&&L.indexOf(e)===-1){for(const r in E){const i=E[r];if(n===i.name){if(i.typeConfig.baseType==="DateTime"){if(T[e]){T[e].forEach(function(e){e.values[0]=t._formatDateTime(e.values[0])})}}v.push({name:e,typeConfig:i.typeConfig})}}}});y.forEach(function(e,r){if(d[r].length>0){T[e.valueListProperty]=d[r];if(!L||L&&L.indexOf(e.valueListProperty)===-1){for(const r in E){const n=E[r];if(n.name===e.localDataProperty){if(n.typeConfig.baseType==="DateTime"){if(T[e.valueListProperty]){T[e.valueListProperty].forEach(function(e){e.values[0]=t._formatDateTime(e.values[0])})}}v.push({name:e.valueListProperty,typeConfig:n.typeConfig})}}}}});const V=m.getBindingContext("internal");const R=m.data("infoPath");let A;const x=s.getLibraryResourceBundle("sap.fe.macros");const w=i.parseCustomData(m.data("requiredProperties"));if(w.length){const e=Object.keys(T)||[];const t=[];w.forEach(function(r){if(e.indexOf(r)===-1){t.push(r)}});if(!t.length){A=V.getProperty(`${R}/showError`);V.setProperty(R,{errorMessageTitle:"",errorMessage:"",showError:false})}else if(t.length>1){V.setProperty(R,{errorMessageTitle:x.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),errorMessage:x.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF"),showError:true});return}else{const e=O.getObject(`${I}/${t[0]}@com.sap.vocabularies.Common.v1.Label`)||t[0];V.setProperty(R,{errorMessageTitle:x.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),errorMessage:x.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF",e),showError:true});return}}else{A=V.getProperty(`${R}/showError`);V.setProperty(R,{errorMessageTitle:"",errorMessage:"",showError:false})}const B=h.data("entityType").split("/")[1];const j=b.split("/")[1].split("(")[0];if(L&&L.length&&B===j){const e=A?o.getBindingPathForParameters(h,T,E,L):undefined;if(e){S.sPath=e}}if(L&&L.length){L.forEach(function(e){if(T[e]){delete T[e]}})}Object.keys(T).forEach(function(e){T[e].forEach(function(e){if(e.values.length>1){e.values=e.values.slice(0,1)}})});if(Object.keys(T).length>0&&v.length){F=l.getFilterInfo(h,T,v,[]).filters;if(F){if(!F.aFilters){C.push(F)}else if(F.aFilters){C=F.aFilters}}}if(P){C.push(new f("IsActiveEntity",c.EQ,true))}if(C&&C.length>0){S.filter(C)}else if(!Object.keys(T).length){S.filter()}if(A&&S.isSuspended()){S.resume()}return C},getFilterCounts(e){if(this.data("multipleSelectionAllowed")==="false"&&e.length>0){return`(1)`}if(e.length>0){return`(${e.length})`}else{return undefined}},scaleVisualFilterValue(e,r,n,i,o){if(r){return t.getFormattedNumber(o,r,n)}else if(i){return t.getFormattedNumber(o,undefined,undefined,i)}else if(n>0){n=n>2?2:n;return t.getFormattedNumber(o,undefined,n)}else{return e}},fireValueHelp(e){e.getSource().getParent().getParent().getParent().fireValueHelpRequest()}};return g},true);