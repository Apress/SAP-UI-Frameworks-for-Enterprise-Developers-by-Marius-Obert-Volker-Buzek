/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/helpers/BindingToolkit","sap/fe/macros/DelegateUtil","sap/fe/macros/field/FieldRuntime","sap/fe/macros/filter/FilterUtils","sap/ui/core/Component","sap/ui/core/format/NumberFormat","sap/ui/model/Filter"],function(e,t,n,i,o,a,r,s,c){"use strict";var l=n.pathInModel;var f=n.compileExpression;function u(e){let n=[];const i=e.data("hiddenFilters");if(i&&Array.isArray(i.paths)){i.paths.forEach(function(i){const o=t.getFiltersInfoForSV(e,i.annotationPath);n=n.concat(o.filters)})}return n}function g(e){let n=[];const o=i.getCustomData(e,"quickFilterKey");if(o){n=n.concat(t.getFiltersInfoForSV(e,o).filters)}return n}function m(e){return g(e).concat(u(e))}function d(e,t,n){let i;const o=e.data("rowsBindingInfo"),a=e.getModel();const r=n.batchGroupId||"",s=p(e);let l=Array.isArray(n.additionalFilters)?n.additionalFilters:[];const f=s.bindingPath?s.bindingPath:o.path;l=l.concat(s.filters).concat(h(e));const u=new c({filters:l,and:true});const g=a.bindList((t?`${t.getPath()}/`:"")+f,e.getBindingContext(),[],u);return g.fetchFilter(g.getContext()).then(function(e){i=a.bindProperty(`${g.getPath()}/$count`,g.getContext(),{$$groupId:r||"$auto",$filter:e[0],$search:s.search});return i.requestValue()}).then(function(e){i.destroy();g.destroy();return e})}function b(e){const t=s.getIntegerInstance({groupingEnabled:true});return t.format(e)}function p(e){const t=e.getParent().getTableDefinition();let n=[];function i(e){const t=e.getParent().getTableDefinition().aggregates;return Object.keys(t).map(function(e){return t[e].relativePath})}if(t.enableAnalytics){n=n.concat(i(e));if(!t.enableBasicSearch){n=n.concat(["search"])}}return a.getFilterInfo(e.getFilter(),{ignoredProperties:n,targetControl:e})}function h(e){const t=e.getP13nMode();if(t&&t.indexOf("Filter")>-1){const t=(i.getCustomData(e,"sap_fe_ControlDelegate_propertyInfoMap")||[]).filter(function(e){return e&&!(e.filterable===false)}),n=a.getFilterInfo(e,{propertiesMetadata:t});if(n&&n.filters){return n.filters}}return[]}function O(e){const t=p(e);return{filters:t.filters.concat(m(e),h(e)),search:t.search,bindingPath:t.bindingPath}}function P(e){return j(e).promise}function F(e){const t=j(e);if(t.resolve){t.resolve(e);e.data("boundPromiseResolve",null)}}function j(e){if(!e.data("boundPromise")){let t;e.data("boundPromise",new Promise(function(e){t=e}));if(e.isBound()){t(e)}else{e.data("boundPromiseResolve",t)}}return{promise:e.data("boundPromise"),resolve:e.data("boundPromiseResolve")}}function C(n,a){const s=n.getView();const c=s.getBindingContext("internal");if(c){const u=i.getCustomData(a,"targetCollectionPath");if(u){const i=n.getOwnerComponent();const g=r.getOwnerComponentFor(i);const m=g.getMetaModel();const d=g.getShellServices();const b=o._fnFixHashQueryString(d.getHash());const p=a.getParent().getTableDefinition().columns;const h=[];const O=[];const P=[];let F="",j,C;let v;const y=[];let $,S;for(let e=0;e<p.length;e++){j=p[e].annotationPath;if(j){C=m.getObject(j);if(C&&C.$kind==="Property"){F=p[e].annotationPath}else if(C&&C.$Type==="com.sap.vocabularies.UI.v1.DataField"){F=`${u}/${m.getObject(`${j}/Value/$Path`)}`}}if(F!==""){const e=Object.keys(m.getObject(F+"@"));for(let n=0;n<e.length;n++){if(!P.includes(F)&&e[n].indexOf(`@${"com.sap.vocabularies.Common.v1.SemanticObject"}`)===0&&e[n].indexOf(`@${"com.sap.vocabularies.Common.v1.SemanticObjectMapping"}`)===-1&&e[n].indexOf(`@${"com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions"}`)===-1){S=/#(.*)/.exec(e[n]);$=S?S[1]:"";y.push(t.getSemanticObjectPromise(g,s,m,F,$));P.push(F)}}}F=""}if(y.length===0){return Promise.resolve()}else{Promise.all(y).then(function(e){const n=[];let i;const o=e.filter(function(e){if(e.semanticObject&&typeof e.semanticObject.semanticObject==="object"){i=f(l(e.semanticObject.semanticObject.$Path));e.semanticObject.semanticObject=i;e.semanticObjectForGetLinks[0].semanticObject=i;return true}else if(e){return e.semanticObject!==undefined}else{return false}});for(let e=0;e<o.length;e++){v=o[e];if(v&&v.semanticObject&&!(v.semanticObject.semanticObject.indexOf("{")===0)){h.push(v.semanticObjectForGetLinks);O.push({semanticObject:v.semanticObject&&v.semanticObject.semanticObject,unavailableActions:v.unavailableActions,path:o[e].semanticObjectPath});n.push(d.getLinksWithCache([v.semanticObjectForGetLinks]))}}return t.updateSemanticTargets(n,O,c,b)}).catch(function(t){e.error("fnGetSemanticTargetsFromTable: Cannot get Semantic Objects",t)})}}}}function v(e){e.clearSelection();const t=e.getBindingContext("internal");if(t){t.setProperty("deleteEnabled",false);t.setProperty("numberOfSelectedContexts",0);t.setProperty("selectedContexts",[]);t.setProperty("deletableContexts",[])}}const y={getCountFormatted:b,getHiddenFilters:u,getTableFilters:m,getListBindingForCount:d,getFilterInfo:p,getP13nFilters:h,getAllFilterInfo:O,whenBound:P,onTableBound:F,getSemanticTargetsFromTable:C,clearSelection:v};return y},false);