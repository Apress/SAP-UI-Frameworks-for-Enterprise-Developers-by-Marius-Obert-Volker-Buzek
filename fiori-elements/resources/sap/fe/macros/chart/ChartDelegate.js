/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ResourceModelHelper","sap/fe/macros/chart/ChartHelper","sap/fe/macros/chart/ChartUtils","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/FilterUtils","sap/ui/mdc/library","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/odata/v4/vizChart/ChartDelegate","sap/ui/model/Filter","sap/ui/model/FilterOperator","../filterBar/FilterBarDelegate"],function(e,t,r,a,n,o,i,s,l,c,g,f,p,u,d,h){"use strict";var m=n.getResourceModel;var b=a.isMultiValueFilterExpression;var y=a.getSortRestrictionsInfo;var C=a.getFilterRestrictionsInfo;const v=g.ChartItemRoleType;const _=Object.assign({},p);_._setChartNoDataText=function(e,t){let r="";const a=i.getAllFilterInfo(e),n=t.path.startsWith("/")?t.path.substr(1):t.path;const o=function(){if(e.data("multiViews")){return"M_TABLE_AND_CHART_NO_DATA_TEXT_MULTI_VIEW"}else{return"T_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"}};if(e.getFilter()){if(a.search||a.filters&&a.filters.length){r=o()}else{r="T_TABLE_AND_CHART_NO_DATA_TEXT"}}else if(a.search||a.filters&&a.filters.length){r=o()}else{r="M_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT"}e.setNoDataText(m(e).getText(r,undefined,n))};_._handleProperty=function(t,r,a,n,o,i){const l=s.parseCustomData(t.data("applySupported"));const c=y(r);const g=r["@Org.OData.Capabilities.V1.FilterRestrictions"];const f=C(g);const p=this.getModel().getObject(this.getPath());const u=this.getModel().getObject(`${this.getPath()}@sapui.name`);const d=this.getModel();const h=t.getP13nMode();T(t,h);if(p&&p.$kind==="Property"){if(p.$isCollection){return}const r=d.getObject(`${this.getPath()}@`);const s=d.getObject("@sapui.name",d.getMetaContext(this.getPath()));const g=l&&l.GroupableProperties;const m=l&&l.AggregatableProperties;let b=g?A(g,s):false;let y=m?A(m,s):false;if(!g||g&&!g.length){b=r["@Org.OData.Aggregation.V1.Groupable"]}if(!m||m&&!m.length){y=r["@Org.OData.Aggregation.V1.Aggregatable"]}if(!b&&!y){return}I(n,u,b,y);if(y){const e=_._createPropertyInfosForAggregatable(t,u,r,f,c,a,n);e.forEach(function(e){o.push(e)});if(h&&h.includes("Filter")){const e=Object.keys(a);const n=g.map(e=>e.$PropertyPath);e.forEach(e=>{if(!n.includes(e)){o=P(o,u,r,f,c,t,i,p,false,true,undefined,true)}})}}if(b){const a=u||"",n=r["@com.sap.vocabularies.Common.v1.Text"]?r["@com.sap.vocabularies.Common.v1.Text"].$Path:null;let s=false;if(a&&a.indexOf("/")>-1){e.error(`$expand is not yet supported. Property: ${a} from an association cannot be used`);return}if(n&&n.indexOf("/")>-1){e.error(`$expand is not yet supported. Text Property: ${n} from an association cannot be used`);s=true}o=P(o,u,r,f,c,t,i,p,true,false,s)}}};function P(e,t,r,a,n,o,i,s,l,c,g,f){e.push({name:"_fe_groupable_"+t,propertyPath:t,label:r["@com.sap.vocabularies.Common.v1.Label"]||t,sortable:_._getSortable(o,n.propertyInfo[t],false),filterable:a[t]?a[t].filterable:true,groupable:l,aggregatable:c,maxConditions:b(a.propertyInfo[t])?-1:1,sortKey:t,path:t,role:v.category,criticality:i,typeConfig:s.typeConfig,visible:f?!f:true,textProperty:!g&&r["@com.sap.vocabularies.Common.v1.Text"]?r["@com.sap.vocabularies.Common.v1.Text"].$Path:null,textFormatter:r["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]});return e}function T(e,t){var r,a,n;const o=e===null||e===void 0?void 0:(r=e.getModel())===null||r===void 0?void 0:(a=r.getMetaModel())===null||a===void 0?void 0:(n=a.getObject(`${e.data("targetCollectionPath")}@Org.OData.Capabilities.V1.FilterRestrictions`))===null||n===void 0?void 0:n.Filterable;if(o!==undefined&&!o){t=t.filter(e=>e!=="Filter");e.setP13nMode(t)}}function A(e,t){if(e.length){for(const a of e){var r;if((a===null||a===void 0?void 0:a.$PropertyPath)===t||(a===null||a===void 0?void 0:(r=a.Property)===null||r===void 0?void 0:r.$PropertyPath)===t){return true}}}}function I(e,t,r,a){const n=Object.keys(e);if(r&&a&&n.includes(t)){throw new Error("Same property can not be configured as groupable and aggregatable")}}_.formatText=function(e,t){const r=this.textFormatter;if(r.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst"){return`${t} (${e})`}else if(r.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return`${e} (${t})`}else if(r.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){return t}return t?t:e};_.updateBindingInfo=function(e,t){_._setChartNoDataText(e,t);const a=sap.ui.getCore().byId(e.getFilter());const n=e.getConditions();if(!t){t={}}if(a){const n=c.getFilterInfo(a,{});const o=s.parseCustomData(e.data("applySupported"));if(o&&o.enableSearch&&n.search){t.parameters.$search=r.normalizeSearchTerm(n.search)}else if(t.parameters.$search){delete t.parameters.$search}}const o=n?f.getParametersInfo(a,n):null;if(o){t.path=o}const l=i.getAllFilterInfo(e);if(l.filters){l.filters=r.getChartPropertiesWithoutPrefixes(l.filters)}t.filters=l.filters.length>0?new u({filters:l.filters,and:true}):null;t.sorter=this.getSorters(e);_._checkAndAddDraftFilter(e,t)};_.fetchProperties=function(e){const t=this._getModel(e);let r;if(!t){r=new Promise(t=>{e.attachModelContextChange({resolver:t},$,this)}).then(t=>this._createPropertyInfos(e,t))}else{r=this._createPropertyInfos(e,t)}return r.then(function(t){if(e.data){e.data("$mdcChartPropertyInfo",t);l.setCachedProperties(e,t)}return t})};function $(e,t){const r=e.getSource();const a=this._getModel(r);if(a){r.detachModelContextChange($);t.resolver(a)}}_._createPropertyInfos=async function(e,t){const r=`/${e.data("entitySet")}`;const a=t.getMetaModel();const n=await Promise.all([a.requestObject(`${r}/`),a.requestObject(`${r}@`)]);const i=[];let l=n[0];const c=n[1];l=D(l,e);const g=s.parseCustomData(e.data("customAgg"));x(g,e);let f;const p=[];for(const e in c){if(e.startsWith("@Org.OData.Aggregation.V1.CustomAggregate")){f=e.replace("@Org.OData.Aggregation.V1.CustomAggregate#","");const t=f.split("@");if(t.length==2&&t[1]=="com.sap.vocabularies.Common.v1.Label"){g[t[0]]=c[e]}}}const u=s.parseCustomData(e.data("transAgg"));const d={};for(const e in u){const t=u[e].propertyPath;d[t]=d[t]||{};d[t][u[e].aggregationMethod]={name:u[e].name,label:u[e].label}}for(const t in l){if(t.indexOf("$")!==0){p.push(o.fetchCriticality(a,a.createBindingContext(`${r}/${t}`)).then(_._handleProperty.bind(a.getMetaContext(`${r}/${t}`),e,c,d,g,i)))}}await Promise.all(p);return i};function D(e,t){for(const r in e){if(r=="$Key"||r=="$kind"||r=="SAP_Message"){continue}else if(e[r]["$kind"]=="Property"){e[r]["typeConfig"]=t.getTypeUtil().getTypeConfig(e[r].$Type)}else{e[r]["typeConfig"]=null}}return e}function x(t,r){const a=[],n=[];if(t&&Object.keys(t).length>=1){const t=r.getItems();for(const e in t){if(t[e].getType()==="groupable"){a.push(_.getInternalChartNameFromPropertyNameAndKind(t[e].getName(),"groupable"))}else if(t[e].getType()==="aggregatable"){n.push(_.getInternalChartNameFromPropertyNameAndKind(t[e].getName(),"aggregatable"))}}if(n.filter(function(e){return a.indexOf(e)!=-1}).length>=1){e.error("Dimension and Measure has the sameProperty Configured")}}}_._createPropertyInfosForAggregatable=function(e,r,a,n,o,i,s){const l=[];if(Object.keys(i).indexOf(r)>-1){for(const e in i[r]){l.push({name:"_fe_aggregatable_"+i[r][e].name,propertyPath:r,label:i[r][e].label||`${a["@com.sap.vocabularies.Common.v1.Label"]} (${e})`||`${r} (${e})`,sortable:o.propertyInfo[r]?o.propertyInfo[r].sortable:true,filterable:false,groupable:false,aggregatable:true,path:r,aggregationMethod:e,maxConditions:b(n.propertyInfo[r])?-1:1,role:v.axis1,datapoint:null})}}if(Object.keys(s).indexOf(r)>-1){for(const e in s){if(e===r){const r=t({},s[e],{name:"_fe_aggregatable_"+e,groupable:false,aggregatable:true,filterable:false,role:v.axis1,propertyPath:e,datapoint:null});l.push(r);break}}}return l};_.rebind=function(e,t){const r=t.parameters.$search;if(r){delete t.parameters.$search}p.rebind(e,t);if(r){const t=e.getControlDelegate().getInnerChart(e),a=t&&t.getBinding("data");a.suspend();a.setAggregation({search:r});const n={onBeforeRendering:function(){a.resume();t.removeEventDelegate(n)}};t.addEventDelegate(n)}e.fireEvent("bindingUpdated")};_._setChart=function(e,t){const r=e.getParent();t.setVizProperties(e.data("vizProperties"));t.detachSelectData(r.handleSelectionChange.bind(r));t.detachDeselectData(r.handleSelectionChange.bind(r));t.detachDrilledUp(r.handleSelectionChange.bind(r));t.attachSelectData(r.handleSelectionChange.bind(r));t.attachDeselectData(r.handleSelectionChange.bind(r));t.attachDrilledUp(r.handleSelectionChange.bind(r));t.setSelectionMode(e.getPayload().selectionMode.toUpperCase());p._setChart(e,t)};_._getBindingInfo=function(e){if(this._getBindingInfoFromState(e)){return this._getBindingInfoFromState(e)}const r=e.getDelegate().payload;const a=e.getModel()&&e.getModel().getMetaModel();const n=e.data("targetCollectionPath");const o=(a.getObject(`${n}/$kind`)!=="NavigationProperty"?"/":"")+r.contextPath;const i=t({},r.parameters,{entitySet:e.data("entitySet")});return{path:o,events:{dataRequested:e.getParent().onInternalDataRequested.bind(e.getParent())},parameters:i}};_.removeItemFromInnerChart=function(e,t){p.removeItemFromInnerChart.call(this,e,t);if(t.getType()==="groupable"){const t=this._getChart(e);t.fireDeselectData()}};_._getSortable=function(e,t,r){if(r){if(e.data("draftSupported")==="true"){return false}else{return t?t.sortable:true}}return t?t.sortable:true};_._checkAndAddDraftFilter=function(e,t){if(e.data("draftSupported")==="true"){if(!t){t={}}if(!t.filters){t.filters=[];t.filters.push(new u("IsActiveEntity",d.EQ,true))}else{var r,a;(r=t.filters)===null||r===void 0?void 0:(a=r.aFilters)===null||a===void 0?void 0:a.push(new u("IsActiveEntity",d.EQ,true))}}};_.getInternalChartNameFromPropertyNameAndKind=function(e,t){return e.replace("_fe_"+t+"_","")};_.getPropertyFromNameAndKind=function(e,t,r){return r.getPropertyHelper().getProperty("_fe_"+t+"_"+e)};_.getFilterDelegate=function(){return Object.assign({},h,{addItem:function(e,t){const r=_.getInternalChartNameFromPropertyNameAndKind(e,"groupable");return h.addItem(r,t).then(t=>{t===null||t===void 0?void 0:t.bindProperty("conditions",{path:"$filters>/conditions/"+e});return t})}})};return _},false);