/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/merge","sap/ui/base/Object","sap/ui/core/routing/HashChanger","sap/ui/core/UIComponent","sap/ui/thirdparty/URI","sap/ui/util/openWindow","./library","./NavError","./SelectionVariant"],function(e,t,n,a,i,r,o,s,l,c,p,f,u){"use strict";var d={};function h(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;g(e,t)}function g(e,t){g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,n){t.__proto__=n;return t};return g(e,t)}const m=p.NavType;const S=p.ParamHandlingMode;const v=p.SuppressionBehavior;const y=p.Mode;const A="sap-iapp-state";const _="sap-ushell-defaultedParameterNames";let V=function(r){h(p,r);function p(e,t,n){var a;a=r.call(this)||this;a._aTechnicalParamaters=["hcpApplicationId"];a._oLastSavedInnerAppData={sAppStateKey:"",oAppData:{},iCacheHit:0,iCacheMiss:0};a._rIAppStateOld=new RegExp("/"+A+"=([^/?]+)");a._rIAppStateOldAtStart=new RegExp("^"+A+"=([^/?]+)");a._rIAppStateNew=new RegExp("[?&]"+A+"=([^&]+)");a.IAPP_STATE=A;if(!e){throw new f("NavigationHandler.INVALID_INPUT")}if(e instanceof s){a.oRouter=e.getRouter();a.oComponent=e}else{if(typeof e.getOwnerComponent!=="function"){throw new f("NavigationHandler.INVALID_INPUT")}a.oRouter=a._getRouter(e);a.oComponent=e.getOwnerComponent()}if(a.oComponent&&a.oComponent.getAppComponent){a.oComponent=a.oComponent.getAppComponent()}if(typeof a.oRouter==="undefined"||typeof a.oComponent==="undefined"||typeof a.oComponent.getComponentData!=="function"){throw new f("NavigationHandler.INVALID_INPUT")}if(n===S.URLParamWins||n===S.InsertInSelOpt){a.sParamHandlingMode=n}else{a.sParamHandlingMode=S.SelVarWins}if(t===y.ODataV2){a._sMode=t}return a}d.NavigationHandler=p;var g=p.prototype;g._getAppNavigationService=function e(){return sap.ushell.Container.getService("CrossApplicationNavigation")};g._getAppNavigationServiceAsync=function e(){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){return e}).catch(function(){t.error("NavigationHandler: CrossApplicationNavigation is not available.");throw new f("NavigationHandler.NO.XAPPSERVICE")})};g._getRouter=function e(t){return s.getRouterFor(t)};g.registerNavigateCallback=function e(t){this._navigateCallback=t};g.navigate=function e(n,a,i,r,o,s,l){let p,d,h,g,m=false,S={};const v=this;const y=this.oComponent.getComponentData();if(y){g=y.startupParameters;if(g&&g["sap-ushell-next-navmode"]&&g["sap-ushell-next-navmode"].length>0){m=g["sap-ushell-next-navmode"][0]==="explace"}}if(l&&(l==="inplace"||l==="explace")){m=l==="explace"}else if(l){throw new f("NavigationHandler.INVALID_NAV_MODE")}if(s===undefined||s===null){h={}}else{h=s}if(typeof i==="string"){p=i}else if(typeof i==="object"){const e=this._splitInboundNavigationParameters(new u,i,[]).oNavigationSelVar;p=e.toJSONString()}else{throw new f("NavigationHandler.INVALID_INPUT")}S.selectionVariant=new u(p);if(typeof i==="string"){S.selectionVariant=this._removeTechnicalParameters(S.selectionVariant)}S.selectionVariant=S.selectionVariant&&S.selectionVariant.toJSONObject();S=this._removeMeasureBasedInformation(S);S=this._checkIsPotentiallySensitive(S);if(S.selectionVariant){d=this._getURLParametersFromSelectionVariant(new u(S.selectionVariant));p=new u(S.selectionVariant).toJSONString()}else{d={};p=null}const A={target:{semanticObject:n,action:a},params:d||{}};const _=function(e){if(!h.selectionVariant){h.selectionVariant=p}const n=function(){const n=e.hrefForExternalAsync(A,v.oComponent);n.then(function(e){c(e)}).catch(function(e){t.error("Error while retireving hrefForExternal : "+e)})};h=v._removeMeasureBasedInformation(h);return v._fnSaveAppStateAsync(h,o).then(function(t){if(t){A.appStateKey=t.appStateKey;if(l=="explace"){n()}else{const t=e.toExternal(A,v.oComponent);if(v._navigateCallback){v._navigateCallback(t)}}}})};const V=function(e){v.storeInnerAppStateAsync(r,true).then(function(t){if(t){v.replaceHash(t)}return _(e)}).catch(function(e){if(o){o(e)}})};if(l){A.params["sap-ushell-navmode"]=m?"explace":"inplace"}v._getAppNavigationServiceAsync().then(function(e){const t=e.isNavigationSupported([A],v.oComponent);t.done(function(t){if(t[0].supported){if(!m){V(e)}else{_(e)}}else if(o){const e=new f("NavigationHandler.isIntentSupported.notSupported");o(e)}});if(o){t.fail(function(){const e=v._createTechnicalError("NavigationHandler.isIntentSupported.failed");o(e)})}}).catch(function(e){if(o){o(e)}})};g.parseNavigation=function e(){const n=o.getInstance().getHash();const a=this._getInnerAppStateKey(n);let i=this.oComponent.getComponentData();if(i===undefined){t.warning("The navigation Component's data was not set properly; assuming instead that no parameters are provided.");i={}}const r=i.startupParameters;let s=[];if(r&&r[_]&&r[_].length>0){s=JSON.parse(r[_][0])}const l=jQuery.Deferred();const c=this;const p=function(e,t,n,a){const i=c._splitInboundNavigationParameters(new u,e,t);if(i.oNavigationSelVar.isEmpty()&&i.oDefaultedSelVar.isEmpty()){if(a===m.xAppState){const t=c._createTechnicalError("NavigationHandler.getDataFromAppState.failed");n.reject(t,e||{},m.xAppState)}else{n.resolve({},e,m.initial)}}else{const t={};t.selectionVariant=i.oNavigationSelVar.toJSONString();t.oSelectionVariant=i.oNavigationSelVar;t.oDefaultedSelectionVariant=i.oDefaultedSelVar;t.bNavSelVarHasDefaultsOnly=i.bNavSelVarHasDefaultsOnly;n.resolve(t,e,a)}};if(a){this._loadAppState(a,l)}else{const e=i["sap-xapp-state"]!==undefined;if(e){const e=this;this._getAppNavigationServiceAsync().then(function(t){const n=t.getStartupAppState(e.oComponent);n.done(function(e){let t=e.getData();let n;if(t){try{t=JSON.parse(JSON.stringify(t))}catch(e){n=c._createTechnicalError("NavigationHandler.AppStateData.parseError");l.reject(n,r,m.xAppState);return l.promise()}}if(t){const e=new u(t.selectionVariant);const n=c._splitInboundNavigationParameters(e,r,s);t.selectionVariant=n.oNavigationSelVar.toJSONString();t.oSelectionVariant=n.oNavigationSelVar;t.oDefaultedSelectionVariant=n.oDefaultedSelVar;t.bNavSelVarHasDefaultsOnly=n.bNavSelVarHasDefaultsOnly;l.resolve(t,r,m.xAppState)}else if(r){p(r,s,l,m.xAppState)}else{n=c._createTechnicalError("NavigationHandler.getDataFromAppState.failed");l.reject(n,r||{},m.xAppState)}});n.fail(function(){const e=c._createTechnicalError("NavigationHandler.getStartupState.failed");l.reject(e,{},m.xAppState)})}).catch(function(){const e=c._createTechnicalError("NavigationHandler._getAppNavigationServiceAsync.failed");l.reject(e,{},m.xAppState)})}else if(r){p(r,s,l,m.URLParams)}else{l.resolve({},{},m.initial)}}return l.promise()};g.setTechnicalParameters=function e(n){if(!n){n=[]}if(!Array.isArray(n)){t.error("NavigationHandler: parameter incorrect, array of strings expected");throw new f("NavigationHandler.INVALID_INPUT")}this._aTechnicalParamaters=n};g.getTechnicalParameters=function e(){return this._aTechnicalParamaters.concat([])};g._isTechnicalParameter=function e(t){if(t){if(!(t==="sap-ui-fe-variant-id"||t==="sap-ui-fe-table-variant-id"||t==="sap-ui-fe-chart-variant-id"||t==="sap-ui-fe-filterbar-variant-id")){if(t.toLowerCase().indexOf("sap-")===0){return true}else if(this._aTechnicalParamaters.indexOf(t)>=0){return true}}}return false};g._isFEParameter=function e(t){return t.toLowerCase().indexOf("sap-ui-fe")===0};g._removeTechnicalParameters=function e(t){let n,a;const i=t.getSelectOptionsPropertyNames();for(a=0;a<i.length;a++){n=i[a];if(this._isTechnicalParameter(n)){t.removeSelectOption(n)}}return t};g._splitInboundNavigationParameters=function e(t,n,a){if(!Array.isArray(a)){throw new f("NavigationHandler.INVALID_INPUT")}let i,r;const o={};for(i in n){if(!n.hasOwnProperty(i)){continue}if(this._isTechnicalParameter(i)||this._isFEParameter(i)){continue}if(typeof n[i]==="string"){o[i]=n[i]}else if(Array.isArray(n[i])&&n[i].length===1){o[i]=n[i][0]}else if(Array.isArray(n[i])&&n[i].length>1){o[i]=n[i]}else{throw new f("NavigationHandler.INVALID_INPUT")}}const s=new u;const l=new u;const c=t.getParameterNames().concat(t.getSelectOptionsPropertyNames());for(r=0;r<c.length;r++){i=c[r];if(i in o){if(a.indexOf(i)>-1){l.massAddSelectOption(i,t.getValue(i));this._addParameterValues(s,i,"I","EQ",o[i])}else{switch(this.sParamHandlingMode){case S.SelVarWins:l.massAddSelectOption(i,t.getValue(i));break;case S.URLParamWins:this._addParameterValues(l,i,"I","EQ",o[i]);break;case S.InsertInSelOpt:l.massAddSelectOption(i,t.getValue(i));this._addParameterValues(l,i,"I","EQ",o[i]);break;default:throw new f("NavigationHandler.INVALID_INPUT")}}}else if(a.indexOf(i)>-1){s.massAddSelectOption(i,t.getValue(i))}else{l.massAddSelectOption(i,t.getValue(i))}}for(i in o){if(c.indexOf(i)>-1){continue}if(a.indexOf(i)>-1){this._addParameterValues(s,i,"I","EQ",o[i])}else{this._addParameterValues(l,i,"I","EQ",o[i])}}let p=false;if(l.isEmpty()){p=true;const e=s.getSelectOptionsPropertyNames();for(r=0;r<e.length;r++){l.massAddSelectOption(e[r],s.getValue(e[r]))}}return{oNavigationSelVar:l,oDefaultedSelVar:s,bNavSelVarHasDefaultsOnly:p}};g._addParameterValues=function e(t,n,a,i,r){if(Array.isArray(r)){for(let e=0;e<r.length;e++){t.addSelectOption(n,a,i,r[e])}}else{t.addSelectOption(n,a,i,r)}};g.replaceHash=function e(t){const n=this.oRouter.oHashChanger?this.oRouter.oHashChanger:o.getInstance();const a=n.getHash();const i=this._replaceInnerAppStateKey(a,t);n.replaceHash(i)};g.storeInnerAppStateAsync=function e(n,i,r){if(typeof i!=="boolean"){i=true}const s=this;const l=jQuery.Deferred();const c=function(e){const t=s.oRouter.oHashChanger?s.oRouter.oHashChanger:o.getInstance();const n=t.getHash();const a=s._replaceInnerAppStateKey(n,e);t.replaceHash(a)};if(a(n)){l.resolve("");return l.promise()}const p=this._oLastSavedInnerAppData.sAppStateKey;const f=JSON.stringify(n)===JSON.stringify(this._oLastSavedInnerAppData.oAppData);if(f&&p){this._oLastSavedInnerAppData.iCacheHit++;c(p);l.resolve(p);return l.promise()}this._oLastSavedInnerAppData.iCacheMiss++;const u=function(e){if(!r&&!i){c(e)}s._oLastSavedInnerAppData.oAppData=n;s._oLastSavedInnerAppData.sAppStateKey=e;l.resolve(e)};const d=function(e){l.reject(e)};this._saveAppStateAsync(n,u,d).then(function(e){if(e!==undefined){if(!r&&i){c(e)}}}).catch(function(){t.error("NavigationHandler._saveAppStateAsync failed")});return l.promise()};g.storeInnerAppState=function e(n,i){t.error("Deprecated API call of 'sap.fe.navigation.NavigationHandler.storeInnerAppState'. Please use 'storeInnerAppStateAsync' instead",undefined,"sap.fe.navigation.NavigationHandler");if(typeof i!=="boolean"){i=true}const r=this;const s=jQuery.Deferred();const l=function(e){const t=r.oRouter.oHashChanger?r.oRouter.oHashChanger:o.getInstance();const n=t.getHash();const a=r._replaceInnerAppStateKey(n,e);t.replaceHash(a)};if(a(n)){s.resolve("");return s.promise()}const c=this._oLastSavedInnerAppData.sAppStateKey;const p=JSON.stringify(n)===JSON.stringify(this._oLastSavedInnerAppData.oAppData);if(p&&c){this._oLastSavedInnerAppData.iCacheHit++;l(c);s.resolve(c);return s.promise()}this._oLastSavedInnerAppData.iCacheMiss++;const f=function(e){if(!i){l(e)}r._oLastSavedInnerAppData.oAppData=n;r._oLastSavedInnerAppData.sAppStateKey=e;s.resolve(e)};const u=function(e){s.reject(e)};const d=this._saveAppState(n,f,u);if(d!==undefined){if(i){l(d)}}return s.promise()};g.storeInnerAppStateWithImmediateReturn=function e(n,i){t.error("Deprecated API call of 'sap.fe.navigation.NavigationHandler.storeInnerAppStateWithImmediateReturn'. Please use 'storeInnerAppStateAsync' instead",undefined,"sap.fe.navigation.NavigationHandler");if(typeof i!=="boolean"){i=false}const r=this;const o=jQuery.Deferred();if(a(n)){return{appStateKey:"",promise:o.resolve("")}}const s=this._oLastSavedInnerAppData.sAppStateKey;const l=JSON.stringify(n)===JSON.stringify(this._oLastSavedInnerAppData.oAppData);if(l&&s){this._oLastSavedInnerAppData.iCacheHit++;return{appStateKey:s,promise:o.resolve(s)}}this._oLastSavedInnerAppData.iCacheMiss++;const c=function(e){if(!i){r.replaceHash(e)}r._oLastSavedInnerAppData.oAppData=n;r._oLastSavedInnerAppData.sAppStateKey=e;o.resolve(e)};const p=function(e){o.reject(e)};const f=this._saveAppState(n,c,p);return{appStateKey:f,promise:o.promise()}};g.processBeforeSmartLinkPopoverOpens=function e(t,n,a,i){const r=jQuery.Deferred();let o;if(t!=undefined){o=t.semanticAttributes}let s;const l=this;if(i===undefined){s={}}else{s=i}const c=function(e,n){n=s.selectionVariant||n||"{}";const a=v.raiseErrorOnNull|v.raiseErrorOnUndefined;const i=l.mixAttributesAndSelectionVariant(e,n,a);n=i.toJSONString();let o={};o.selectionVariant=i.toJSONObject();o=l._removeMeasureBasedInformation(o);o=l._checkIsPotentiallySensitive(o);e=o.selectionVariant?l._getURLParametersFromSelectionVariant(new u(o.selectionVariant)):{};const c=function(n){if(t===undefined){r.resolve(e,n)}else{t.setSemanticAttributes(e);t.setAppStateKey(n);t.open();r.resolve(t)}};const p=function(e){r.reject(e)};s.selectionVariant=n;s=l._removeMeasureBasedInformation(s);l._saveAppStateAsync(s,c,p)};if(a){const e=this.storeInnerAppStateAsync(a,true);e.done(function(){c(o,n)});e.fail(function(e){r.reject(e)})}else{c(o,n)}return r.promise()};g._getAppStateKeyAndUrlParameters=function e(t){return this.processBeforeSmartLinkPopoverOpens(undefined,t,undefined,undefined)};g._mixAttributesToSelVariant=function e(n,a,i){for(const e in n){if(n.hasOwnProperty(e)){let r=n[e];if(r instanceof Date){r=r.toJSON()}else if(Array.isArray(r)||r&&typeof r==="object"){r=JSON.stringify(r)}else if(typeof r==="number"||typeof r==="boolean"){r=r.toString()}if(r===""){if(i&v.ignoreEmptyString){t.info("Semantic attribute "+e+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue}}if(r===null){if(i&v.raiseErrorOnNull){throw new f("NavigationHandler.INVALID_INPUT")}else{t.warning("Semantic attribute "+e+" is null and ignored for mix in to selection variant");continue}}if(r===undefined){if(i&v.raiseErrorOnUndefined){throw new f("NavigationHandler.INVALID_INPUT")}else{t.warning("Semantic attribute "+e+" is undefined and ignored for mix in to selection variant");continue}}if(typeof r==="string"||r instanceof String){a.addSelectOption(e,"I","EQ",r)}else{throw new f("NavigationHandler.INVALID_INPUT")}}}return a};g.mixAttributesAndSelectionVariant=function e(t,n,a){const i=new u(n);const r=new u;const o=this;const s=i.getFilterContextUrl();if(s){r.setFilterContextUrl(s)}const l=i.getParameterContextUrl();if(l){r.setParameterContextUrl(l)}if(Array.isArray(t)){t.forEach(function(e){o._mixAttributesToSelVariant(e,r,a)})}else{this._mixAttributesToSelVariant(t,r,a)}const c=i.getParameterNames();let p;for(p=0;p<c.length;p++){if(!r.getSelectOption(c[p])){r.addSelectOption(c[p],"I","EQ",i.getParameter(c[p]))}}const f=i.getSelectOptionsPropertyNames();for(p=0;p<f.length;p++){const e=i.getSelectOption(f[p]);if(!r.getSelectOption(f[p])){for(let t=0;t<e.length;t++){r.addSelectOption(f[p],e[t].Sign,e[t].Option,e[t].Low,e[t].High)}}}return r};g._ensureSelectionVariantFormatString=function e(t){if(t===undefined){return undefined}let n=t;if(typeof t==="object"){n=JSON.stringify(t)}return n};g._fnHandleAppStatePromise=function e(t,n,a){t.promise.done(function(){if(n){n(t.appStateKey)}});if(a){const e=this;t.promise.fail(function(){const t=e._createTechnicalError("NavigationHandler.AppStateSave.failed");a(t)})}};g._saveAppStateAsync=function e(t,n,a){const i=this;return this._fnSaveAppStateAsync(t,a).then(function(e){if(e){i._fnHandleAppStatePromise(e,n,a);return e.appStateKey}return undefined})};g._saveAppState=function e(t,n,a){const i=this._saveAppStateWithImmediateReturn(t,a);if(i){this._fnHandleAppStatePromise(i,n,a);return i.appStateKey}return undefined};g._fnSaveAppStateWithImmediateReturn=function e(t,n,a){const i=n.getKey();const r=this._fetchAppDataForSave(t,a);if(!r){return undefined}n.setData(r);const o=n.save();return{appStateKey:i,promise:o.promise()}};g._fetchAppDataForSave=function e(t,a){let r={};if(t.hasOwnProperty("selectionVariant")){r.selectionVariant=t.selectionVariant;if(t.selectionVariant){if(typeof t.selectionVariant==="string"){try{r.selectionVariant=JSON.parse(t.selectionVariant)}catch(e){const t=this._createTechnicalError("NavigationHandler.AppStateSave.parseError");if(a){a(t)}return undefined}}}}if(this._sMode===y.ODataV2){r=n({selectionVariant:{},tableVariantId:"",customData:{}},r);if(t.tableVariantId){r.tableVariantId=t.tableVariantId}if(t.customData){r.customData=t.customData}if(t.presentationVariant){r.presentationVariant=t.presentationVariant}if(t.valueTexts){r.valueTexts=t.valueTexts}if(t.semanticDates){r.semanticDates=t.semanticDates}}else{const e=Object.assign({},t);r=i(e,r)}r=this._checkIsPotentiallySensitive(r);return r};g._fnSaveAppStateAsync=function e(t,n){const a=this;return this._getAppNavigationServiceAsync().then(function(e){return e.createEmptyAppStateAsync(a.oComponent)}).then(function(e){return a._fnSaveAppStateWithImmediateReturn(t,e,n)}).catch(function(e){if(n){n(e)}})};g._saveAppStateWithImmediateReturn=function e(t,n){const a=this._getAppNavigationService().createEmptyAppState(this.oComponent);return this._fnSaveAppStateWithImmediateReturn(t,a,n)};g._loadAppState=function e(t,n){const a=this;this._getAppNavigationServiceAsync().then(function(e){const r=e.getAppState(a.oComponent,t);r.done(function(e){let r={};const o=e.getData();if(typeof o==="undefined"){const e=a._createTechnicalError("NavigationHandler.getDataFromAppState.failed");n.reject(e,{},m.iAppState)}else if(a._sMode===y.ODataV2){r={selectionVariant:"{}",oSelectionVariant:new u,oDefaultedSelectionVariant:new u,bNavSelVarHasDefaultsOnly:false,tableVariantId:"",customData:{},appStateKey:t,presentationVariant:{},valueTexts:{},semanticDates:{}};if(o.selectionVariant){r.selectionVariant=a._ensureSelectionVariantFormatString(o.selectionVariant);r.oSelectionVariant=new u(r.selectionVariant)}if(o.tableVariantId){r.tableVariantId=o.tableVariantId}if(o.customData){r.customData=o.customData}if(o.presentationVariant){r.presentationVariant=o.presentationVariant}if(o.valueTexts){r.valueTexts=o.valueTexts}if(o.semanticDates){r.semanticDates=o.semanticDates}}else{r=i(r,o);if(o.selectionVariant){r.selectionVariant=a._ensureSelectionVariantFormatString(o.selectionVariant);r.oSelectionVariant=new u(r.selectionVariant)}}n.resolve(r,{},m.iAppState)});r.fail(function(){const e=a._createTechnicalError("NavigationHandler.getAppState.failed");n.reject(e,{},m.iAppState)})}).catch(function(){const e=a._createTechnicalError("NavigationHandler._getAppNavigationServiceAsync.failed");n.reject(e,{},m.iAppState)})};g._getInnerAppStateKey=function e(t){if(!t){return undefined}let n=this._rIAppStateNew.exec(t);if(n===null){n=this._rIAppStateOld.exec(t)}if(n===null){n=this._rIAppStateOldAtStart.exec(t)}if(n===null){return undefined}return n[1]};g._replaceInnerAppStateKey=function t(n,a){const i=A+"="+a;if(!n){return"?"+i}const r=function(e){if(e.indexOf("?")!==-1){return e+"&"+i}return e+"?"+i};if(!this._getInnerAppStateKey(n)){return r(n)}if(this._rIAppStateNew.test(n)){return n.replace(this._rIAppStateNew,function(e){return e.replace(/[=].*/gi,"="+a)})}const o=function(e,t){t=t.replace(e,"");return r(t)};if(this._rIAppStateOld.test(n)){return o(this._rIAppStateOld,n)}if(this._rIAppStateOldAtStart.test(n)){return o(this._rIAppStateOldAtStart,n)}e(false,"internal inconsistency: Approach of sap-iapp-state not known, but _getInnerAppStateKey returned it");return undefined};g._getURLParametersFromSelectionVariant=function e(t){const n={};let a=0;let i;if(typeof t==="string"){i=new u(t)}else if(typeof t==="object"){i=t}else{throw new f("NavigationHandler.INVALID_INPUT")}const r=i.getSelectOptionsPropertyNames();for(a=0;a<r.length;a++){const e=i.getSelectOption(r[a]);if(e.length===1&&e[0].Sign==="I"&&e[0].Option==="EQ"){n[r[a]]=e[0].Low}}const o=i.getParameterNames();for(a=0;a<o.length;a++){const e=i.getParameter(o[a]);n[o[a]]=e}return n};g._createTechnicalError=function e(t){return new f(t)};g.setModel=function e(t){this._oModel=t};g._getModel=function e(){return this._oModel||this.oComponent.getModel()};g._removeAllProperties=function e(t){if(t){if(t.selectionVariant){t.selectionVariant=null}if(t.valueTexts){t.valueTexts=null}if(t.semanticDates){t.semanticDates=null}}};g._removeProperties=function e(t,n,a){if(t.length&&a&&(a.selectionVariant||a.valueTexts||a.semanticDates)){t.forEach(function(e){if(a.selectionVariant.SelectOptions){a.selectionVariant.SelectOptions.some(function(t,n){if(e===t.PropertyName){a.selectionVariant.SelectOptions.splice(n,1);return true}return false})}if(a.valueTexts&&a.valueTexts.Texts){a.valueTexts.Texts.forEach(function(t){if(t.PropertyTexts){t.PropertyTexts.some(function(n,a){if(e===n.PropertyName){t.PropertyTexts.splice(a,1);return true}return false})}})}if(a.semanticDates&&a.semanticDates.Dates){a.semanticDates.Dates.forEach(function(t,n){if(e===t.PropertyName){a.semanticDates.Dates.splice(n,1)}})}})}if(n.length&&a&&a.selectionVariant&&a.selectionVariant.Parameters){n.forEach(function(e){a.selectionVariant.Parameters.some(function(t,n){if(e===t.PropertyName||"$Parameter."+e===t.PropertyName){a.selectionVariant.Parameters.splice(n,1);return true}return false})})}};g._isTermTrue=function e(t,n){const a=function(e){if(e){return e.Bool?e.Bool!=="false":true}return false};return!!t[n]&&a(t[n])};g._isExcludedFromNavigationContext=function e(t){return this._isTermTrue(t,"com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext")};g._isPotentiallySensitive=function e(t){return this._isTermTrue(t,"com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive")};g._isMeasureProperty=function e(t){return this._isTermTrue(t,"com.sap.vocabularies.Analytics.v1.Measure")};g._isToBeExcluded=function e(t){return this._isPotentiallySensitive(t)||this._isExcludedFromNavigationContext(t)};g.constructContextUrl=function e(t,n){if(!t){throw new f("NavigationHandler.NO_ENTITY_SET_PROVIDED")}if(n===undefined){n=this._getModel()}return this._constructContextUrl(n)+"#"+t};g._constructContextUrl=function e(t){let n;if(t.isA("sap.ui.model.odata.v2.ODataModel")){n=t._getServerUrl()}else if(t.isA("sap.ui.model.odata.v4.ODataModel")){const e=new l(t.sServiceUrl).absoluteTo(document.baseURI);n=new l("/").absoluteTo(e).toString()}if(n&&n.lastIndexOf("/")===n.length-1){n=n.substr(0,n.length-1)}return n+t.sServiceUrl+"/$metadata"};g._checkIsPotentiallySensitive=function e(a){let i=a;if(a&&a.selectionVariant&&(a.selectionVariant.FilterContextUrl&&a.selectionVariant.SelectOptions||a.selectionVariant.ParameterContextUrl&&a.selectionVariant.Parameters)){const e=this._getModel();if(this.oComponent&&e&&e.isA("sap.ui.model.odata.v2.ODataModel")){const r=[];const o=[];let s,l,c,p,f,u=[],d=[];const h=e.getMetaModel();if(e.getServiceMetadata()&&h!==null&&h!==void 0&&h.oModel){if(a.selectionVariant.FilterContextUrl){u=a.selectionVariant.FilterContextUrl.split("#")}if(u.length===2&&a.selectionVariant.SelectOptions&&this._constructContextUrl(e).indexOf(u[0])===0){l=h.getODataEntitySet(u[1]);if(l){c=h.getODataEntityType(l.entityType)}else{c=h.getODataEntityType(u[1])}if(c){if(c&&c.property){for(s=0;s<c.property.length;s++){if(this._isToBeExcluded(c.property[s])){r.push(c.property[s].name)}}}if(c.navigationProperty){for(s=0;s<c.navigationProperty.length;s++){f=h.getODataAssociationEnd(c,c.navigationProperty[s].name);if(!f||f.type===a.selectionVariant.FilterContextUrl){continue}if(f.multiplicity==="1"||f.multiplicity==="0..1"){p=h.getODataEntityType(f.type);if(p&&p.property){for(let e=0;e<p.property.length;e++){if(this._isToBeExcluded(p.property[e])){r.push(c.navigationProperty[s].name+"."+p.property[e].name)}}}}}}}}if(a.selectionVariant.ParameterContextUrl){d=a.selectionVariant.ParameterContextUrl.split("#")}if(d.length===2&&a.selectionVariant.Parameters&&this._constructContextUrl(e).indexOf(d[0])===0){l=h.getODataEntitySet(d[1]);if(l){c=h.getODataEntityType(l.entityType)}else{c=h.getODataEntityType(u[1])}if(c){if(c.property){for(s=0;s<c.property.length;s++){if(this._isToBeExcluded(c.property[s])){o.push(c.property[s].name)}}}}}if(r.length||o.length){i=n(true,{},i);this._removeProperties(r,o,i)}}else{this._removeAllProperties(i);t.error("NavigationHandler: oMetadata are not fully loaded!")}}else if(this.oComponent&&e&&e.isA("sap.ui.model.odata.v4.ODataModel")){return this._removeSensitiveDataForODataV4(i)}}return i};g._removeMeasureBasedInformation=function e(n){let a=n;if(n.selectionVariant){if(typeof n.selectionVariant==="string"){try{a.selectionVariant=JSON.parse(n.selectionVariant)}catch(e){t.error("NavigationHandler: _removeMeasureBasedInformation parse error")}}a=this._removeMeasureBasedProperties(a)}return a};g._removeMeasureBasedProperties=function e(a){let i=a;const r=[];const o=[];let s,l,c,p,f,u,d,h=[],g=[];if(a&&a.selectionVariant&&(a.selectionVariant.FilterContextUrl&&a.selectionVariant.SelectOptions||a.selectionVariant.ParameterContextUrl&&a.selectionVariant.Parameters)){l=this._getModel();if(this.oComponent&&l&&l.isA("sap.ui.model.odata.v2.ODataModel")){c=l.getMetaModel();if(l.getServiceMetadata()&&c&&c.oModel){if(a.selectionVariant.FilterContextUrl){h=a.selectionVariant.FilterContextUrl.split("#")}if(h.length===2&&a.selectionVariant.SelectOptions&&this._constructContextUrl(l).indexOf(h[0])===0){p=c.getODataEntitySet(h[1]);if(p){f=c.getODataEntityType(p.entityType)}else{f=c.getODataEntityType(h[1])}if(f){if(f&&f.property){for(s=0;s<f.property.length;s++){if(this._isMeasureProperty(f.property[s])){r.push(f.property[s].name)}}}if(f.navigationProperty){for(s=0;s<f.navigationProperty.length;s++){d=c.getODataAssociationEnd(f,f.navigationProperty[s].name);if(!d||d.type===a.selectionVariant.FilterContextUrl){continue}if(d.multiplicity==="1"||d.multiplicity==="0..1"){u=c.getODataEntityType(d.type);if(u&&u.property){for(let e=0;e<u.property.length;e++){if(this._isMeasureProperty(u.property[e])){r.push(f.navigationProperty[s].name+"."+u.property[e].name)}}}}}}}}if(a.selectionVariant.ParameterContextUrl){g=a.selectionVariant.ParameterContextUrl.split("#")}if(g.length===2&&a.selectionVariant.Parameters&&this._constructContextUrl(l).indexOf(g[0])===0){p=c.getODataEntitySet(g[1]);if(p){f=c.getODataEntityType(p.entityType)}else{f=c.getODataEntityType(h[1])}if(f){if(f.property){for(s=0;s<f.property.length;s++){if(this._isMeasureProperty(f.property[s])){o.push(f.property[s].name)}}}}}if(r.length||o.length){i=n(true,{},i);this._removeProperties(r,o,i)}}else{this._removeAllProperties(i);t.error("NavigationHandler: oMetadata are not fully loaded!")}}else if(this.oComponent&&l&&l.isA("sap.ui.model.odata.v4.ODataModel")){return this._removeSensitiveDataForODataV4(i,true)}}return i};g._removeSensitiveDataForODataV4=function e(n,a){var i;const r=this,o=new u(n.selectionVariant),s=this._getModel();let l;if(!s.getMetaModel().getObject("/")){this._removeAllProperties(n);t.error("NavigationHandler: oMetadata are not fully loaded!");return n}if(n.selectionVariant.FilterContextUrl){l=n.selectionVariant.FilterContextUrl.split("#")}if(((i=l)===null||i===void 0?void 0:i.length)===2&&n.selectionVariant.SelectOptions&&this._constructContextUrl(s).indexOf(l[0])===0){o.removeSelectOption("@odata.context");o.removeSelectOption("@odata.metadataEtag");o.removeSelectOption("SAP__Messages");const e=l[1],t=s.getMetaModel(),i=o.getPropertyNames()||[],c=function(n,i){i=i||e;const o=t.getObject("/"+i+"/"+n+"@");if(o){if(a&&o["@com.sap.vocabularies.Analytics.v1.Measure"]||r._checkPropertyAnnotationsForSensitiveData(o)){return true}else if(o["@com.sap.vocabularies.Common.v1.FieldControl"]){const e=o["@com.sap.vocabularies.Common.v1.FieldControl"];if(e["$EnumMember"]&&e["$EnumMember"].split("/")[1]==="Inapplicable"){return true}}}return false};for(let t=0;t<i.length;t++){const n=i[t];if(c(n,e)){o.removeSelectOption(n)}}n.selectionVariant=o.toJSONObject()}return n};g._checkPropertyAnnotationsForSensitiveData=function e(t){return t["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||t["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]};return p}(r);d.NavigationHandler=V;const N=r.extend("sap.fe.navigation.NavigationHandler",V.prototype);return N},false);