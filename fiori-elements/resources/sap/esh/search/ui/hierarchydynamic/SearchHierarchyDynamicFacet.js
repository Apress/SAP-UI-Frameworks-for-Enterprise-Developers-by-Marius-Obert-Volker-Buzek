/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){function e(e,t,r){if(r){return t?t(e):e}if(!e||!e.then){e=Promise.resolve(e)}return t?e.then(t):e}function t(e,t){if(e)throw t;return t}function r(e,t){try{var r=e()}catch(e){return t(true,e)}if(r&&r.then){return r.then(t.bind(null,false),t.bind(null,true))}return t(false,r)}function i(){}function o(e){if(e&&e.then){return e.then(i)}}sap.ui.define(["../tree/TreeNodeFactory","./SearchHierarchyDynamicTreeNode","./StructureTree"],function(i,n,a){function l(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function u(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=s(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var i=0;var o=function(){};return{s:o,n:function(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n=true,a=false,l;return{s:function(){r=r.call(e)},n:function(){var e=r.next();n=e.done;return e},e:function(e){a=true;l=e},f:function(){try{if(!n&&r.return!=null)r.return()}finally{if(a)throw l}}}}function s(e,t){if(!e)return;if(typeof e==="string")return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}function d(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function c(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function f(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||false;i.configurable=true;if("value"in i)i.writable=true;Object.defineProperty(e,i.key,i)}}function h(e,t,r){if(t)f(e.prototype,t);if(r)f(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}function v(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}var y=l(i);var N=l(n);var p=l(a);var b=function(){function i(e){c(this,i);this.model=e.model;this.sina=e.sina;this.dataSource=e.dataSource;this.attributeId=e.attributeId;this.dimension=this.attributeId;this.title=e.title;this.filter=e.filter;this.modelPathPrefix=e.modelPathPrefix;this.isShowMoreDialog=e.isShowMoreDialog;this.handleSetFilter=e.handleSetFilter;this.filterCount=this.filter.rootCondition.getAttributeConditions(this.attributeId).length;this.facetType="hierarchy";this.facetIndex=-1;this.structureTree=new p({rootNode:{id:i.rootNodeId,label:"root"}});this.notDisplayedFilterConditions=[];this.treeNodeFactory=y.create({model:this.model,rootTreeNodePath:"/facets/".concat(this.facetIndex,"/rootTreeNode"),treeNodeConstructor:N,busyIndicator:this.model.busyIndicator});this.rootTreeNode=this.treeNodeFactory.createRootTreeNode({id:i.rootNodeId,label:"Root",count:0,facet:this})}h(i,[{key:"setFilter",value:function e(t){this.filter=t}},{key:"setHandleSetFilter",value:function e(t){this.handleSetFilter=t}},{key:"setFacetIndex",value:function e(t){this.facetIndex=t;this.treeNodeFactory.setRootTreeNodePath("".concat(this.modelPathPrefix,"/").concat(this.facetIndex,"/rootTreeNode"))}},{key:"updateStructureTree",value:function e(t){this.structureTree.update(t)}},{key:"activateFilters",value:function i(){try{const i=this;return e(o(r(function(){return e(i.model._firePerspectiveQuery({preserveFormerResults:false}),function(){i.model.notifyFilterChanged()})},function(e,r){return t(e,r)})))}catch(e){return Promise.reject(e)}}},{key:"updateFromResultSet",value:function e(t){var r=[];var i=u(t.node.childNodes),o;try{for(i.s();!(o=i.n()).done;){var n=o.value;r.push(this.treeNodeFactory.createTempTreeNode({id:n.id,label:n.label,count:n.count,facet:this,expandable:n.hasChildren}))}}catch(e){i.e(e)}finally{i.f()}this.rootTreeNode.updateChildren(r);this.updateStructureTree(t.node);return Promise.resolve()}},{key:"getComplexConditionOfFacet",value:function e(){for(var t=0;t<this.filter.rootCondition.conditions.length;++t){var r=this.filter.rootCondition.conditions[t];if(r.containsAttribute(this.attributeId)){return r}}return null}},{key:"getFilterConditions",value:function e(){var t=[];var r=this.getComplexConditionOfFacet();if(!r){return t}for(var i=0;i<r.conditions.length;++i){var o=r.conditions[i];t.push(o)}return t}},{key:"mixinFilterNodes",value:function e(){this.rootTreeNode.hasFilter=false;this.rootTreeNode.visitChildNodesRecursively(function(e){e.hasFilter=false});var t;var r=[];var i=this.getFilterConditions();for(var o=0;o<i.length;++o){var n=i[o];t=n.value;var a=this.treeNodeFactory.getTreeNode(t);if(a){a.hasFilter=true}else{r.push(n)}}for(var l=0;l<r.length;++l){var u=r[l];t=u.value;if(this.addMissingFilterNode(t)){r.splice(l,1);l--}}this.notDisplayedFilterConditions=r;this.calculateCheckboxStatus();this.calculateFilterCount()}},{key:"calculateFilterCount",value:function e(){var t=this.filter.rootCondition.getAttributeConditions(this.attributeId).length;this.model.setProperty("".concat(this.modelPathPrefix,"/").concat(this.facetIndex,"/filterCount"),t)}},{key:"addMissingFilterNode",value:function e(t){var r=this;var i=function e(t){var i=r.treeNodeFactory.getTreeNode(t.id);if(i){if(i.isVisible()){return i}else{return null}}if(!t.parentNode){throw new Error("program error parent node missing for "+t.id)}var o=e(t.parentNode);if(!o){return null}i=r.treeNodeFactory.createTreeNode({id:t.id,label:t.label,count:0,facet:r});o.addChildTreeNode(i);return i};var o=this.structureTree.getNode(t);if(!o){return false}var n=i(o);if(!n){return false}n.hasFilter=true;return true}},{key:"calculateCheckboxStatus",value:function e(){this.rootTreeNode.selected=false;this.rootTreeNode.partiallySelected=false;this.rootTreeNode.visitChildNodesRecursively(function(e){e.selected=false;e.partiallySelected=false});var t=[];if(!this.rootTreeNode.hasChildNodes()){t.push(this.rootTreeNode)}this.rootTreeNode.visitChildNodesRecursively(function(e){if(!e.hasChildNodes()){t.push(e)}});for(var r=0;r<t.length;++r){var i=t[r];this.calculateCheckboxStatusFromLeafNode(i)}}},{key:"calculateCheckboxStatusFromLeafNode",value:function e(t){var r=t;var i=false;while(r){if(r.selected&&r.partiallySelected){return}if(r.hasFilter){r.selected=true;r.partiallySelected=false;i=true}else{if(i){r.selected=true;r.partiallySelected=true}}r=r.getParentTreeNode()}}},{key:"handleModelUpdate",value:function e(){this.treeNodeFactory.updateUI()}},{key:"delete",value:function e(){this.treeNodeFactory["delete"]()}},{key:"updateNodesFromHierarchyNodePaths",value:function e(t){var r=u(t),i;try{for(r.s();!(i=r.n()).done;){var o=i.value;if(o.name!==this.attributeId){continue}this.structureTree.updateFromHierarchyNodePath(o)}}catch(e){r.e(e)}finally{r.f()}}}]);return i}();v(b,"rootNodeId","$$ROOT$$");return b})})();