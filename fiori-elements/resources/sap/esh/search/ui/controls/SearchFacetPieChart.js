/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../i18n","sap/ui/thirdparty/d3","sap/ui/core/Control"],function(t,e,i){function a(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function r(t,e){if(!(t instanceof e)){throw new TypeError("Cannot call a class as a function")}}function n(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(t,a.key,a)}}function s(t,e,i){if(e)n(t.prototype,e);if(i)n(t,i);Object.defineProperty(t,"prototype",{writable:false});return t}function l(t,e,i){if(e in t){Object.defineProperty(t,e,{value:i,enumerable:true,configurable:true,writable:true})}else{t[e]=i}return t}var d=a(t);var h=i.extend("sap.esh.search.ui.controls.SearchFacetPieChart",{renderer:{apiVersion:2,render:function t(e,i){e.openStart("div",i);e.attr("role","figure");e.openEnd();e.close("div");i.PieChart=o}},metadata:{properties:{oSearchFacetDialog:{type:"sap.esh.search.ui.controls.SearchFacetDialog"}},aggregations:{items:{type:"sap.esh.search.ui.FacetItem",multiple:true}}},constructor:function t(a,r){i.prototype.constructor.call(this,a,r);this.iMissingCnt=0;h.d3=e},setEshRole:function t(e){},getFacetIndexById:function t(e){var i=-1;var a=$("#"+e).parent().parent().parent().parent().parent()[0];var r=a.id;var n=$(".sapUshellSearchFacetIconTabBar");for(var s=0;s<n.length;s++){var l=n[s].id;if(l===r){i=s;break}}return i},getFacetIndexByIdForLargePieChart:function t(e){var i=-1;var a=$("#"+e).parent().parent()[0];var r=a.id;var n=$(".searchFacetLargeChartContainer");for(var s=0;s<n.length;s++){var l=n[s].id;if(l===r){i=s;break}}return i},getPieChartIndexByFacetIndex:function t(e){var i;var a=-1;var r=0;for(var n=0;n<e;n++){i=$($(".sapUshellSearchFacetIconTabBar")[n]).find(".sapMLIBContent")[1].firstChild["id"];if(i.match(/pieChart/)!==null){r++}}a=r;return a},getSumSelected:function t(e){var i;var a=0;if(e){for(var r=0;r<e.length;r++){if(e[r].facetType==="attribute"){for(var n=0;n<e[r].items.length;n++){i=e[r].items[n].value;if(i&&e[r].items[n].selected){a+=i}}}}}return a},getDataForPieChart:function t(e,i,a){var r=[];var n=[];var s;var l=0;var h=-1;var o="";var c=i.oData.count;var u=c;var g=0;this.iMissingCnt=0;for(var f=0;f<e.length;f++){if(e[f].facetType==="attribute"){h++;if(e[f].totalCount){u=e[f].totalCount}n=[];g=0;for(var v=0;v<e[f].items.length;v++){s={};l=e[f].items[v].value;if(l){o=""+l;g+=l;s.filterCondition=e[f].items[v].filterCondition;s.dimension=e[f].items[v].facetTitle;s.label=e[f].items[v].label;s.selected=e[f].items[v].selected;s.filterLabel=e[f].items[v].label;s.id=e[f].items[v].label;s.value=l;s.valueLabel=e[f].items[v].valueLabel;if(o){s.tooltip=e[f].items[v].label+": "+l}else{s.tooltip=e[f].items[v].label}s.filtered=false;s.removed=false;s.fill="#007CAA";s.maxLabelLength=30;n.push(s)}else if(h===a){this.iMissingCnt++}}var p=Math.round(g/u*100);var A=100-p;if(A>0){if(A===100){A=99}var b=18*g/350;var k=""+A;s={};s.filterCondition=null;s.dimension="";s.label=k;s.id="perc_missing";s.value=b;s.valueLabel=k;s.tooltip=d.getText("facetPieChartOverflowText",[k]);s.filtered=false;s.removed=false;s.fill="transparent";s.stroke="none";s.maxLabelLength=30;n.push(s)}r.push(n)}}return r},getDataForPieChartLarge:function t(e){var i=[];var a=0;var r=0;var n;for(var s=0;s<e.length;s++){a=e[s].value;if(a){n={};r=r+a;n.filterCondition=e[s].filterCondition;n.dimension=e[s].facetAttribute;n.label=e[s].label;n.selected=e[s].selected;n.filterLabel=e[s].label;n.id=e[s].label;n.value=a;n.valueLabel=e[s].valueLabel;n.tooltip=e[s].label+"\t: "+a;n.filtered=false;n.removed=false;n.fill="#007CAA";n.maxLabelLength=30;i.push(n)}}return i},directUpdate:function t(e,i,a,r){var n;var s=[];var l=20;var d=null;n=this.getModel();if(!n){n=this.getParent().getModel()}r.pieChartParentClass="sapUshellSearchFacetPieChartLarge";r.height=r.relevantContainerHeight;r.labelHideThreshold=1e-6;$(i).parent().parent().height(r.height);r.width=$(i).parent().parent().width();this.chartElements=this.getDataForPieChartLarge(e);var h=new o(i,r,d,n);for(var c=0;c<l;c++){if(this.chartElements[c]){s.push(this.chartElements[c])}}h.update(s)},onAfterRendering:function t(){var e=this;var i,a,r,n,s,l;var h=null;var o={};if(typeof SVGElement.prototype.blur==="undefined"){SVGElement.prototype.blur=function(){}}n=this.getModel();if(!n){n=this.getParent().getModel("facets")}if(n){s=$("#"+this["sId"])[0];if($(s).parent()[0].className==="sapMLIBContent"){o.pieChartParentClass="sapUshellSearchFacetPieChart";l=this.getFacetIndexById(this["sId"]);s.className=o.pieChartParentClass;i=this.getDataForPieChart(n.oData.facets,n,l);a=i[l];var c=a.map(function(t){return t.tooltip});this.getDomRef().setAttribute("aria-label",c.join("; "));r=new this.PieChart(s,o,h,n);r.update(a);var u=$(this.getDomRef()).closest(".sapUshellSearchFacetIconTabBar").find(".sapUshellSearchFacetInfoZeile")[0];var g=sap.ui.getCore().byId(u.id);if(e.iMissingCnt>0){g.setVisible(true);var f=d.getText("infoZeileNumberMoreSelected",[e.iMissingCnt]);g.setText(f);g.rerender()}else{g.setVisible(false)}}else if($(s)[0].className==="largeChart2piechart"){$(s).attr("tabindex","0")}}}});h.isIE=function t(){if(navigator.appName==="Microsoft Internet Explorer"){return true}return false};var o=function(){function t(e,i,a,n){r(this,t);this.init(e,i,a,n)}s(t,[{key:"init",value:function e(i,a,r,n){this.parent=i;this.application=r;this.model=n;this.chartElements=[];var s=h.d3.select(i);var l=$(i).innerHeight();var d=$(i).innerWidth();if(a.height>l){l=a.height}var o=Math.min(d,l)/2;this.options={"dimension-pie":"YEAR",backgroundWidth:d,backgroundHeight:l,width:d,height:l,innerRadius:0,outerRadius:o*.8,tweenGen:t.Tweens.tweenGenSimple,tweenGenText:t.Tweens.tweenGenSimpleText,arcCalculator:t.generateHistoricalArcCalculator(this),animationduration:1500,labelHideThreshold:.05,easing:"linear",pieChartClass:"sap-piechart",pieChartParentClass:"sapUshellSearchFacetPieChart",color:"blue",strokewidth:1,strokewidthHover:3,padding4click:7,multipleselectable:true,oSearchFacetDialog:null};if(a){for(var c in a){this.options[c]=a[c]}}this.createAttributeService(t,"innerRadius",function(){this.init()});this.createAttributeService(t,"outerRadius",function(){this.init()});this.createAttributeService(t,"tweenGen",function(){this.init()});this.createAttributeService(t,"tweenGenText",function(){this.init()});this.createAttributeService(t,"width",function(){this.init()});this.createAttributeService(t,"height",function(){this.init()});this.createAttributeService(t,"animationduration");this.createAttributeService(t,"labelHideThreshold");this.createAttributeService(t,"arcCalculator");var u=Math.round(this.options.width/2);var g=Math.round(this.options.height/2);this.svg=s.append("svg:svg").attr("width",d).attr("height",l).attr("id",i.id+"_svg").append("svg:g").attr("transform","translate("+u+","+g+")");this.svgArcs=this.svg.append("svg:g");this.svgLabels=this.svg.append("svg:g");this.svg.attr("class",this.options.pieChartClass);this.inittween();this.oldArcs=[];this.clickedSegment={};this.firstUpdate=true}},{key:"getParent",value:function t(){return this.parent}},{key:"createAttributeService",value:function t(e,i,a){e.prototype[i]=function(t){if(t===null){return this.options[i]}this.options[i]=t;if(a){a.call(this)}return this}}},{key:"inittween",value:function t(){var e=this;e.xOrigin=Math.round(e.options.width/2);e.yOrigin=Math.round(e.options.height/2);e.svg.attr("width",this.options.width).attr("height",this.options.height);this.tweenGenArc=function(t,i,a){return e.options.tweenGen(t,i,a,e.options.innerRadius,e.options.outerRadius,e.svgArcGen(t))};this.tweenGenText=function(t,i,a,r){return e.options.tweenGenText(t,i,a,e.options.innerRadius,e.options.outerRadius,e,r)}}},{key:"update",value:function t(e){this.notAnimatedUpdate(e)}},{key:"notAnimatedUpdate",value:function e(i){var a=this;var r=[];if(!i){return}this.chartElements=i;a.svgArcs.selectAll("path").remove();a.svgLabels.selectAll("g").remove();var n=0;for(var s=0;s<i.length;++s){n+=i[s].value}for(var l=0;l<i.length;++l){i[l].percentage=i[l].value/n}r=this.options.arcCalculator.calculateNewArcsOnly(i);var d=this.svgArcs.selectAll("path").data(r,t.getIdOfArc);if(!d.exit().empty()){d.exit().remove()}if(!d.empty()){d.attr("d",function(t){var e=a.svgArcGen(t);return e(t)}).attr("transform",function(e){var i;if(e.data.selected){i=t.translateStr4Padding(e.startAngle,e.endAngle,a.options.padding4click,0,0)}else{i="translate(0,0)"}return i}).style("stroke",function(t){var e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected||t.data.hovered){e="#dadada"}else{e="white"}return e}).style("stroke-width",function(t){var e;if(t.data.selected||t.data.hovered){e=a.options.strokewidthHover}else{e=a.options.strokewidth}return e}).style("opacity",function(t){var e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e}).each(function(t){while(this.hasChildNodes()){this.removeChild(this.lastChild)}h.d3.select(this).append("svg:title").text(""+t.data.tooltip)})}d.enter().append("svg:path").attr("transform",function(e){var i;if(e.data.selected){a.clickedSegment[e.data.id]=this;i=t.translateStr4Padding(e.startAngle,e.endAngle,a.options.padding4click,0,0)}return i}).attr("shape-rendering","geometricPrecision").attr("tabindex","0").style("stroke",function(t){var e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected||t.data.hovered){e="#dadada"}else{e="white"}return e}).style("stroke-width",function(t){var e;if(t.data.selected||t.data.hovered){e=a.options.strokewidthHover}else{e=a.options.strokewidth}return e}).style("opacity",function(t){var e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e}).attr("fill",function(t){return t.data.fill}).on("keydown",function(){var t=h.d3.event;var e=t.keyCode||t.which;if(e==32){t.target.__onclick()}}).on("click",function(e,i){var r;if(e.data.click&&e.data.pieupdateuionly===false){var n=e.data.click(e,i);if(!a.options.multipleselectable&&!n){return}}var s,l;var d;var o=a.getLabelElementtbyLabel(e.data.label);if(o){var u=" ";if(o.childNodes[1]&&o.childNodes[1].childNodes[0]&&o.childNodes[1].childNodes[0].data){u=o.childNodes[1].childNodes[0].data}d=new c(a.options.width,a.options.height,e.startAngle,e.endAngle,a.options.outerRadius,o.childNodes[1].getBoundingClientRect().width,o.childNodes[1].getBoundingClientRect().height,a.svgArcGen(e).centroid(e),u,a.svg);d.update();if(d.labelWidth<o.childNodes[1].getBoundingClientRect().width){a.adjustLabelWidth(o,d.labelWidth)}}if(e.data.selected){if(!a.options.multipleselectable&&Object.keys(a.clickedSegment).length>0){delete a.clickedSegment[e.data.id]}s="translate(0,0)";if(o){l="translate("+d.x+","+d.y+")"}e.data.selected=false;if(a.options.oSearchFacetDialog){r={};r.cnt=a.getNumberOfClickedSegments();r.dataObject=e.data;a.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(r)}else{a.model.removeFilterCondition(e.data.filterCondition,true)}}else{if(!a.options.multipleselectable){if(Object.keys(a.clickedSegment).length>0){for(var g in a.clickedSegment){var f=a.clickedSegment[g];if(typeof f.__onclick==="function"){f.__data__.data.pieupdateuionly=true;f.__onclick.apply(f)}delete a.clickedSegment[g]}}if(Object.keys(a.clickedSegment).length<1){a.clickedSegment[e.data.id]=this}}s=t.translateStr4Padding(e.startAngle,e.endAngle,a.options.padding4click,0,0);if(o){l=t.translateStr4Padding(e.startAngle,e.endAngle,a.options.padding4click,d.x,d.y)}e.data.selected=true;if(e.data.filterCondition){if(a.options.oSearchFacetDialog){r={};r.cnt=a.getNumberOfClickedSegments();r.dataObject=e.data;a.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(r)}else{a.model.addFilterCondition(e.data.filterCondition,true)}}}h.d3.select(this).transition().duration(1e3).ease(h.d3.ease("elastic")).attr("transform",s).style("stroke",function(t){var e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected){e="#dadada"}else{e="white"}return e}).style("stroke-width",function(t){var e;if(t.data.selected){e=a.options.strokewidthHover}else{e=a.options.strokewidth}return e}).style("opacity",function(t){var e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e});var v=a.getLabelElementtbyLabel(e.data.label);if(v){h.d3.select(v).transition().duration(1e3).ease(h.d3.ease("elastic")).attr("transform",l)}}).on("mouseover",function(t,e){if(!a.options.multipleselectable&&Object.keys(a.clickedSegment).length>0){return}if(t.data.selected||t.data.hovered){return}if(t.data.mouseover){var i=t.data.mouseover(t,e);if(!a.options.multipleselectable&&!i){return}}}).on("mouseout",function(t,e){if(t.data.selected){h.d3.select(this).style("opacity",1)}if(!a.options.multipleselectable&&Object.keys(a.clickedSegment).length>0){return}if(t.data.selected){return}if(t.data.mouseout){var i=t.data.mouseout(t,e);if(!a.options.multipleselectable&&!i){return}}}).attr("d",function(t){var e=a.svgArcGen(t);return e(t)}).append("svg:title").text(function(t){return""+t.data.tooltip});d=a.svgLabels.selectAll("g").data(r,t.getIdOfArc);if(!d.exit().empty()){d.exit().remove()}if(!d.empty()){d.style("opacity",function(t){if(t.removed||t.data.percentage<a.options.labelHideThreshold){return 0}return 1}).attr("transform",function(e){var i;var r;if(this.childNodes[1]&&this.childNodes[1].childNodes[0]){r=new c(a.options.width,a.options.height,e.startAngle,e.endAngle,a.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,a.svgArcGen(e).centroid(e),e.data.label,a.svg)}else{r=new c(a.options.width,a.options.height,e.startAngle,e.endAngle,a.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,a.svgArcGen(e).centroid(e)," ",a.svg)}r.update();if(r.labelWidth<this.childNodes[1].getBoundingClientRect().width){a.adjustLabelWidth(this,r.labelWidth)}if(e.data.selected){i=t.translateStr4Padding(e.startAngle,e.endAngle,a.options.padding4click,r.x,r.y)}else{i="translate("+r.x+","+r.y+")"}return i})}if(!d.enter().empty()){var o=d.enter().append("svg:g").style("opacity",0);o.append("svg:text").attr("class","labelshadow").attr("text-anchor","middle").text(function(t){return""+t.data.label}).style("pointer-events","none");o.append("svg:text").attr("class","label").attr("text-anchor","middle").text(function(t){return""+t.data.label}).style("pointer-events","none");o.style("opacity",function(t){if(t.removed||t.data.percentage<a.options.labelHideThreshold){return 0}return 1}).attr("transform",function(e){var i;var r=new c(a.options.width,a.options.height,e.startAngle,e.endAngle,a.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,a.svgArcGen(e).centroid(e),e.data.label,a.svg);r.update();if(r.labelWidth<this.childNodes[1].getBoundingClientRect().width){a.adjustLabelWidth(this,r.labelWidth)}if(e.data.selected){i=t.translateStr4Padding(e.startAngle,e.endAngle,a.options.padding4click,r.x,r.y)}else{i="translate("+r.x+","+r.y+")"}return i})}a.oldArcs=t.removeDeletedArcs(r)}},{key:"getNumberOfClickedSegments",value:function t(){var e=0;var i=this.chartElements;for(var a=0;a<i.length;a++){if(i[a].selected===true){e++}}return e}},{key:"adjustLabelWidth",value:function t(e,i){var a=e.childNodes[0];var r=e.childNodes[1];if(i<=0){a.childNodes[0].data="";r.childNodes[0].data="";return}var n=a.childNodes[0].data.length;a.childNodes[0].data+="...";var s="";while(a.getBBox().width>i){s=a.childNodes[0].data;s=s.substr(0,n-1)+s.substr(n,3);a.childNodes[0].data=s;n--;if(n<=0){a.childNodes[0].data="";break}}r.childNodes[0].data=a.childNodes[0].data}},{key:"getArcsWithLabel",value:function t(e){var i=[];for(var a=0;a<e.length;++a){var r=e[a];if(r.data.percentage>this.options.labelHideThreshold){i.push(r)}}return i}},{key:"svgArcGen",value:function t(){var e=this;var i=h.d3.svg.arc().innerRadius(function(){return e.options.innerRadius}).outerRadius(function(){return e.options.outerRadius}).startAngle(function(t){return t.startAngle}).endAngle(function(t){return t.endAngle});return i}},{key:"getArcElementtbyLabel",value:function t(e){var i=this;i.svgArcs.selectAll("g").each(function(t){if(t.data.label===e){i=this}return});return i}},{key:"getLabelElementtbyLabel",value:function t(e){var i=this;i.svgLabels.selectAll("g").each(function(t){if(t.data.label===e){i=this}});return i}},{key:"insertAfter",value:function e(i,a,r){var n;if(a>=0){var s=i[a];n=t.createZeroArc(s.endAngle,r.data)}else{n=t.createZeroArc(0,r.data)}n.oldArc=r;i.splice(a+1,0,n)}},{key:"generateDefaultArcCalculator",value:function t(){return new f(this)}},{key:"calculateNewArcsOnly",value:function e(i){var a=this;i=i.slice();t.add2arcSequence(i,this.arcSequence);i.sort(function(t,e){return a.arcSequence.getIndex(t.id)-a.arcSequence.getIndex(e.id)});var r=t.arcsGen()(i);return r}},{key:"calculateArcs",value:function e(i,a){var r=t.arcsGen()(a);this.insertMissingArcs(i,r,true);this.insertMissingArcs(r,i,false);return r}},{key:"insertMissingArcs",value:function e(i,a,r){var n=-1;for(var s=0;s<a.length;++s){var l=a[s];var d=t.getIndexById(i,l.data.id);var h=void 0;if(d!==null){h=i[d];h.oldArc=l;n=d;continue}else{if(r){n=this.determineInsertIndex(i,n,a,s)}var o=void 0;if(n>=0){var c=i[n];o=t.createZeroArc(c.endAngle,l.data)}else{o=t.createZeroArc(0,l.data)}o.oldArc=l;i.splice(n+1,0,o);n++}}}},{key:"determineInsertIndex",value:function e(i,a,r,n){var s=r[n];var l=this.arcSequence.getIndex(s.data.id);var d;for(d=a+1;d<i.length;++d){var h=this.arcSequence.getIndex(i[d].data.id);if(h>l){break}if(t.getIndexById(r,i[d].data.id)!==null){break}}return d-1}}],[{key:"removeDeletedArcs",value:function t(e){var i=[];for(var a=0;a<e.length;++a){var r=e[a];if(!r.removed){i.push(r)}}return i}},{key:"createZeroArc",value:function t(e,i){return{startAngle:e,endAngle:e,data:i,removed:true}}},{key:"getIdOfArc",value:function t(e){return e.data.id}},{key:"getIndexById",value:function e(i,a){for(var r=0;r<i.length;++r){var n=i[r];if(t.getIdOfArc(n)===a){return r}}return null}},{key:"add2arcSequence",value:function t(e,i){if(h.isIE()){var a=function t(e){i.getIndex(e.id)};e.forEach(a)}return e}},{key:"translateStr4Padding",value:function t(e,i,a,r,n){var s=i-e;var l=a*Math.sin(s/2);var d=-(a*Math.cos(s/2));var h=l*Math.cos(e)-d*Math.sin(e);d=l*Math.sin(e)+d*Math.cos(e);l=h;var o="translate("+(r+l)+", "+(n+d)+")";return o}},{key:"generateHistoricalArcCalculator",value:function t(e){for(var i=arguments.length,a=new Array(i>1?i-1:0),r=1;r<i;r++){a[r-1]=arguments[r]}return new g(e,a)}}]);return t}();l(o,"Tweens",function(){var t={tweenGenSimple:undefined,tweenGenSimpleText:undefined,translateStr4Padding:undefined,tweenGenEcstasy:undefined,tweenGenLSD:undefined};t.tweenGenSimple=function(t,e,i,a,r,n){var s={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:a,outerRadius:r};var l={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:a,outerRadius:r};var d=h.d3.interpolate(s,l);return function(t){return n(d(t))}};t.tweenGenSimpleText=function(e,i,a,r,n,s,l){var d=" ";if(e.labelElement.childNodes[1]&&e.labelElement.childNodes[1].childNodes[0]&&e.labelElement.childNodes[1].childNodes[0].data){d=e.labelElement.childNodes[1].childNodes[0].data}var o=new c(s.options.width,s.options.height,e.oldArc.startAngle,e.oldArc.endAngle,s.options.outerRadius,e.labelElement.childNodes[1].getBBox().width,e.labelElement.childNodes[1].getBBox().height,s.svgArcGen(e).centroid(e),d,s.svg);o.update();var u=[o.x,o.y];var g=new c(s.options.width,s.options.height,e.startAngle,e.endAngle,s.options.outerRadius,e.labelElement.childNodes[1].getBBox().width,e.labelElement.childNodes[1].getBBox().height,s.svgArcGen(e).centroid(e),d,s.svg);g.update();if(g.labelWidth<e.labelElement.childNodes[1].getBBox().width){s.adjustLabelWidth(e.labelElement,g.labelWidth)}var f=[g.x,g.y];var v=h.d3.interpolateArray(u,f);var p=function i(a){var r;if(l){r=t.translateStr4Padding(e.startAngle,e.endAngle,s.options.padding4click,a[0],a[1])}else{r="translate("+a+")"}return r};return function(t){return p(v(t))}};t.translateStr4Padding=function(t,e,i,a,r){var n=e-t;var s=i*Math.sin(n/2);var l=-(i*Math.cos(n/2));var d=s*Math.cos(t)-l*Math.sin(t);l=s*Math.sin(t)+l*Math.cos(t);s=d;var h="translate("+(a+s)+", "+(r+l)+")";return h};t.tweenGenEcstasy=function(t,e,i,a,r,n){var s=Math.round((a+r)/2);var l;var d;if(e%2){l=r;d=s}else{l=s;d=a}var o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:a,outerRadius:r};var c={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:d,outerRadius:l};var u=h.d3.interpolate(o,c);o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:d,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:d,outerRadius:l};var g=h.d3.interpolate(o,c);o={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:d,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:a,outerRadius:r};var f=h.d3.interpolate(o,c);return function(t){if(t<=.25){return n(u(t*4))}if(t<=.75){return n(g((t-.25)*2))}return n(f((t-.75)*4))}};t.tweenGenLSD=function(t,e,i,a,r,n){var s=Math.round((a+r)/2);var l;var d;if(e%2){l=r;d=s}else{l=s;d=a}var o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:a,outerRadius:r};var c={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:d,outerRadius:l};var u=h.d3.interpolate(o,c);o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:d,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.startAngle+(t.oldArc.endAngle-t.oldArc.startAngle),innerRadius:d,outerRadius:l};var g=h.d3.interpolate(o,c);o={startAngle:t.startAngle,endAngle:t.startAngle+(t.oldArc.endAngle-t.oldArc.startAngle),innerRadius:d,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:d,outerRadius:l};var f=h.d3.interpolate(o,c);o={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:d,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:a,outerRadius:r};var v=h.d3.interpolate(o,c);return function(t){if(t<=.25){return n(u(t*4))}if(t<=.5){return n(g((t-.25)*4))}if(t<=.75){return n(f((t-.5)*4))}return n(v((t-.75)*4))}};return t}());l(o,"arcsGen",function(){return h.d3.layout.pie().value(function(t){return t.value}).sort(null)});var c=function(){function t(e,i,a,n,s,l,d,h,o,c){r(this,t);this.backgroundWidth=e;this.backgroundHeight=i;this.startAngle=a;this.endAngle=n;this.r=s;this.labelPaddingX=3;this.labelPaddingY=3;this.radiusPadding=4.24;this.labelWidth=l+2*this.labelPaddingX;this.labelHeight=d;this.outsetMin=.3;this.outsetMax=1.2;this.outsetStep=.025;this.apexAngle=n-a;this.startLabelWidth=this.labelWidth;this.d3centroid=h;this.text=o;this.svgBackground=c;this.debug=false;this.labelHeight=this.labelHeight+2*this.labelPaddingY;var u=Math.round(this.backgroundWidth/2);var g=Math.round(this.backgroundHeight/2);this.translateStr="translate("+u+","+g+")"}s(t,[{key:"update",value:function t(){var e=Math.max(this.outsetMin,Math.sin(this.apexAngle/2)/(this.apexAngle/2)*2/3);var i=true;var a=Math.max(100,this.labelWidth*2,1/this.outsetStep);var r=0;var n;do{i=true;n=this.calc(e,this.labelWidth);if(e>this.outsetMax||e<this.outsetMin){break}if(this.labelWidth<0){break}var s=void 0,l=void 0,d=void 0,h=void 0;if(r===0){s=this.calc(e+this.outsetStep,this.labelWidth);l=this.calc(e-this.outsetStep,this.labelWidth);d=this.value(s,n);h=this.value(l,n);if(d<h&&h>.5){r=-1;e+=this.outsetStep*r;i=false}else if(d>.5||n.labelWidth<=0){r=1;e+=this.outsetStep*r;i=false}}else{s=this.calc(e+this.outsetStep*r,this.labelWidth);d=this.value(s,n);if(d>.5||n.labelWidth<=0){e+=this.outsetStep*r;i=false}}a--}while(!i&&a>0&&!isNaN(e));n=this.calc(e,this.labelWidth);this.labelWidth=n.labelWidth;var o=n.x;var c=n.y;this.svgBackground.select("circle.centroid").remove();if(this.debug){this.svgBackground.append("svg:circle").attr("class","centroid").attr("cx",n.centroidX).attr("cy",n.centroidY).attr("r",2).style("fill","blue")}this.svgBackground.selectAll("line.helper").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",c-this.labelHeight/2).attr("y2",c-this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",c+this.labelHeight/2).attr("y2",c+this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.startAngle)*(this.r+this.radiusPadding)).attr("x2",this.isStartAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.endAngle)*(this.r+this.radiusPadding)).attr("x2",this.isEndAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding))}if(this.labelWidth<2*this.labelPaddingX){this.labelWidth=0}else if(this.labelWidth<this.startLabelWidth){this.labelWidth=this.labelWidth-2*this.labelPaddingX}this.x=isNaN(o)?0:o;this.y=isNaN(o)?0:c}},{key:"calc",value:function t(e,i){var a,r,n,s,l,d;if(this.startAngle-this.endAngle+2*Math.PI<1e-9){a=0;r=0;s=this.backgroundWidth/2;n=-this.backgroundWidth/2;d=-this.r;l=this.r}else{a=Math.sin(this.apexAngle/2)*this.r*e;r=Math.cos(this.apexAngle/2)*-this.r*e;var h=a*Math.cos(this.startAngle)-r*Math.sin(this.startAngle);r=a*Math.sin(this.startAngle)+r*Math.cos(this.startAngle);a=h;var o=r-this.labelHeight/2;var c=r+this.labelHeight/2;n=Math.max(this.calcLeftBorder(a,o),this.calcLeftBorder(a,c),-this.backgroundWidth/2);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))>1e-9&&a>0&&o<=0&&c>=0){n=Math.max(n,0)}if(!this.doesFitHeight(n,o,c,a<0,true)){n=this.backgroundWidth/2}s=Math.min(this.calcRightBorder(a,o),this.calcRightBorder(a,c),this.backgroundWidth/2);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))>1e-9&&a<0&&o<=0&&c>=0){s=Math.min(s,0)}if(!this.doesFitHeight(s,o,c,a<0,false)){s=-this.backgroundWidth/2}var u=this.calcPerimeterBorder(1,r-this.labelHeight/2);if(u<a){u=this.backgroundWidth/2}var g=this.calcPerimeterBorder(1,r+this.labelHeight/2);if(g<a){g=this.backgroundWidth/2}l=Math.min(u,g,s);var f=this.calcPerimeterBorder(-1,r-this.labelHeight/2);if(f>a){f=-this.backgroundWidth/2}var v=this.calcPerimeterBorder(-1,r+this.labelHeight/2);if(v>a){v=-this.backgroundWidth/2}d=Math.max(f,v,n);if(isNaN(l)){l=s}if(isNaN(d)){d=n}}this.svgBackground.select("line.left").remove();this.svgBackground.select("line.right").remove();this.svgBackground.select("line.perimeterLeft").remove();this.svgBackground.select("line.perimeterRight").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","left").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",n).attr("x2",n);this.svgBackground.append("svg:line").attr("class","right").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",s).attr("x2",s);this.svgBackground.append("svg:line").attr("class","perimeterLeft").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",d).attr("x2",d);this.svgBackground.append("svg:line").attr("class","perimeterRight").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",l).attr("x2",l)}var p=i;i=Math.min(i,Math.floor(s-n));var A=a;A=Math.max(A,d+i/2);A=Math.min(A,l-i/2);if(A-i/2<d-1e-9||A+i/2>l+1e-9){A=(d+l)/2}if(a>=0){A=Math.max(A,n+i/2);A=Math.min(A,s-i/2)}else{A=Math.min(A,s-i/2);A=Math.max(A,n-i/2)}var b=r;return{x:A,y:b,labelWidth:i,labelShortened:i!==p,xSpace:s-n,centroidX:a,centroidY:r,asymmetry:Math.abs(A-a)}}},{key:"value",value:function t(e,i){if(e.labelWidth<0){return-1e4}if(e.labelWidth<i.labelWidth){return-100}if(e.labelWidth>i.labelWidth){return(e.labelWidth-i.labelWidth)*1e3}if(i.labelShortened&&e.labelWidth===i.labelWidth){return(e.xSpace-i.xSpace)*100}return 0}},{key:"doesFitHeight",value:function t(e,i,a,r,n){var s=-Math.cos(this.startAngle)*(this.r+this.radiusPadding);var l=-Math.cos(this.endAngle)*(this.r+this.radiusPadding);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){s=-this.backgroundHeight/2;l=this.backgroundHeight/2}else if(e===0){s=-this.backgroundHeight/2;l=this.backgroundHeight/2}else if(e>0){if(!this.isStartAngleOnRight()){s=-this.backgroundHeight/2}else if(e<=Math.sin(this.startAngle)*(this.r+this.radiusPadding)){s=e/-Math.tan(this.startAngle)}if(!this.isEndAngleOnRight()){l=this.backgroundHeight/2}else if(e<=Math.sin(this.endAngle)*(this.r+this.radiusPadding)){l=e/-Math.tan(this.endAngle)}if(r&&!n&&s>=a){s=-this.backgroundHeight/2}if(r&&!n&&l<=i){l=this.backgroundHeight/2}}else{if(this.isStartAngleOnRight()){s=this.backgroundHeight/2}else if(e>Math.sin(this.startAngle)*(this.r+this.radiusPadding)){s=e/-Math.tan(this.startAngle)}if(this.isEndAngleOnRight()){l=-this.backgroundHeight/2}else if(e>Math.sin(this.endAngle)*(this.r+this.radiusPadding)){l=e/-Math.tan(this.endAngle)}if(!r&&n&&l>=a){l=-this.backgroundHeight/2}if(!r&&n&&s<=i){s=this.backgroundHeight/2}}if(!n){this.svgBackground.selectAll(".rightBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","rightBorder").attr("x",e-3).attr("y",s-3).attr("width",6).attr("height",6).style("fill","green");this.svgBackground.append("svg:circle").attr("class","rightBorder").attr("cx",e).attr("cy",l).attr("this.r",3).style("fill","green")}}else{this.svgBackground.selectAll(".leftBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","leftBorder").attr("x",e-3).attr("y",s-3).attr("width",6).attr("height",6).style("fill","red");this.svgBackground.append("svg:circle").attr("class","leftBorder").attr("cx",e).attr("cy",l).attr("this.r",3).style("fill","red")}}return i>=Math.min(s,l)-1e-9&&a<=Math.max(s,l)+1e-9}},{key:"calcLeftBorder",value:function t(e,i){var a=-this.backgroundWidth/2;if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){return a}if(i<=0){if(i>-Math.cos(this.startAngle)*(this.r+this.radiusPadding)){a=Math.tan(this.startAngle)*-i}}else if(i<-Math.cos(this.endAngle)*(this.r+this.radiusPadding)){a=Math.tan(this.endAngle)*-i}return a}},{key:"calcRightBorder",value:function t(e,i){var a=this.backgroundWidth/2;if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){return a}if(i>=0){if(-i>Math.cos(this.startAngle)*(this.r+this.radiusPadding)){a=Math.tan(this.startAngle)*-i}}else if(-i<Math.cos(this.endAngle)*(this.r+this.radiusPadding)){a=Math.tan(this.endAngle)*-i}return a}},{key:"calcPerimeterBorder",value:function t(e,i){var a=e>0?this.backgroundWidth/2:-this.backgroundWidth/2;a=Math.sqrt(this.r*this.r-i*i);if(e<0){a*=-1}return a}},{key:"isStartAngleOnRight",value:function t(){return this.startAngle>0&&this.startAngle<=2*Math.PI/360*180}},{key:"isEndAngleOnRight",value:function t(){return this.endAngle%(2*Math.PI)<2*Math.PI/360*180}}]);return t}();var u=function(){function t(){r(this,t);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++){i[a]=arguments[a]}this.init(i)}s(t,[{key:"init",value:function t(){this.maxIndex=0;this.objectMap={}}},{key:"getIndex",value:function t(e){var i=this.objectMap[e];if(typeof i!=="undefined"){return i}i=this.maxIndex;this.maxIndex++;this.objectMap[e]=i;return i}}]);return t}();var g=function(){function t(e){r(this,t);this._pieChart=e;for(var i=arguments.length,a=new Array(i>1?i-1:0),n=1;n<i;n++){a[n-1]=arguments[n]}this.init(e,a)}s(t,[{key:"init",value:function t(e){for(var i=arguments.length,a=new Array(i>1?i-1:0),r=1;r<i;r++){a[r-1]=arguments[r]}e.arcSequence=new u(a)}},{key:"calculateNewArcsOnly",value:function t(e){e=e.slice();o.add2arcSequence(e,this._pieChart.arcSequence);var i=o.arcsGen()(e);return i}},{key:"calculateArcs",value:function t(e,i){i=i.slice();o.add2arcSequence(i,this._pieChart.arcSequence);i.sort(function(t,e){return this._pieChart.arcSequence.getIndex(t.id)-this._pieChart.arcSequence.getIndex(e.id)});var a=o.arcsGen()(i);this.insertMissingArcs(e,a);this.insertMissingArcs(a,e);return a}},{key:"insertMissingArcs",value:function t(e,i){var a=0;for(var r=0;r<i.length;++r){var n=i[r];var s=this._pieChart.arcSequence.getIndex(n.data.id);var l=void 0;var d=false;for(;a<e.length;++a){l=e[a];var h=this._pieChart.arcSequence.getIndex(l.data.id);if(h===s){d=true;break}if(h>s){break}}if(d){l.oldArc=n}else{var c=void 0;if(a-1>=0&&a-1<e.length){var u=e[a-1];c=o.createZeroArc(u.endAngle,n.data)}else{c=o.createZeroArc(0,n.data)}e.splice(a,0,c);c.oldArc=n}a++}}}]);return t}();var f=function(){function t(e){r(this,t);for(var i=arguments.length,a=new Array(i>1?i-1:0),n=1;n<i;n++){a[n-1]=arguments[n]}this.init(e,a)}s(t,[{key:"init",value:function t(e){for(var i=arguments.length,a=new Array(i>1?i-1:0),r=1;r<i;r++){a[r-1]=arguments[r]}e.arcSequence=new u(a)}}]);return t}();return h})})();