/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){function e(e,t,r){if(r){return t?t(e):e}if(!e||!e.then){e=Promise.resolve(e)}return t?e.then(t):e}sap.ui.define(["./error/ErrorHandler","./hierarchydynamic/SearchHierarchyDynamicFacetsFormatter","./hierarchystatic/SearchHierarchyStaticFacetsFormatter","./Facet","./FacetItem","./sinaNexTS/sina/ComparisonOperator"],function(t,r,a,i,n,o){function c(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function u(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=f(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var a=0;var i=function(){};return{s:i,n:function(){if(a>=e.length)return{done:true};return{done:false,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n=true,o=false,c;return{s:function(){r=r.call(e)},n:function(){var e=r.next();n=e.done;return e},e:function(e){o=true;c=e},f:function(){try{if(!n&&r.return!=null)r.return()}finally{if(o)throw c}}}}function l(e){return v(e)||d(e)||f(e)||s()}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function f(e,t){if(!e)return;if(typeof e==="string")return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return h(e,t)}function d(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function v(e){if(Array.isArray(e))return h(e)}function h(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function y(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function p(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}function S(e,t,r){if(t)p(e.prototype,t);if(r)p(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}var m=c(t);var g=c(r);var F=c(a);var b=c(i);var D=c(n);var k=o["ComparisonOperator"];var C=function(){function t(e){y(this,t);this.searchFacetDialogModel=e;this.errorHandler=new m({model:e});this.hierarchyDynamicFacetsFormatter=new g(e);this.hierarchyStaticFacetsFormatter=new F(e)}S(t,[{key:"_getAncestorDataSources",value:function e(t){var r=[];var a=t.dataSourceTree.findNode(t.getProperty("/uiFilter/dataSource"));if(a){var i=a.getAncestors().reverse();for(var n=0;n<i.length;n++){var o=i[n].dataSource;var c=new D({label:o.labelPlural,icon:o.icon||"sap-icon://none",filterCondition:o,level:0,value:i[n].count?i[n].count.toString():""});r.push(c)}}return r}},{key:"_getSiblingDataSources",value:function e(t,r){var a=[];var i=t.getProperty("/uiFilter/dataSource");var n=t.dataSourceTree.findNode(i);var o;if(n.parent&&!n.unsureWhetherNodeisBelowRoot){o=n.parent.getChildren()}else{o=[]}if(o.length===0){o.push(n)}for(var c=0,u=o.length;c<u;c++){var s=o[c].dataSource;var f=new D({label:s.labelPlural,icon:s.icon||"sap-icon://none",value:o[c].count,filterCondition:s,selected:i===s,level:r});a.push(f);if(f.selected){a.push.apply(a,l(this._getChildrenDataSources(t,r+1)))}}return a}},{key:"_getChildrenDataSources",value:function e(t,r){var a=[];var i=t.getProperty("/uiFilter/dataSource");var n=t.dataSourceTree.findNode(i).getChildren();for(var o=0,c=n.length;o<c;o++){var u=n[o].dataSource;var l=new D({label:u.labelPlural,icon:u.icon||"sap-icon://none",value:n[o].count?n[o].count.toString():"",filterCondition:u,selected:false,level:r});a.push(l)}return a}},{key:"getDataSourceFacetFromTree",value:function e(t){var r,a;var i=new b({facetType:"datasource",title:"Search In"});var n=t.getProperty("/uiFilter/dataSource");var o=this._getAncestorDataSources(t);(r=i.items).push.apply(r,l(o));var c=this._getSiblingDataSources(t,t.allDataSource===n?0:1);(a=i.items).push.apply(a,l(c));return i}},{key:"_createFacetItemsFromConditionGroup",value:function e(t,r){var a=[];for(var i=0;i<r.conditions.length;i++){var n=r.conditions[i];for(var o=0;o<n.conditions.length;o++){var c=n.conditions[o];var u=void 0;if(c.type===this.searchFacetDialogModel.sinaNext.ConditionType.Simple){u=c.attribute;if(t.getAttributeMetadata(u).isHierarchy){continue}a.push(new D({facetAttribute:u,label:this._formatLabel(c.valueLabel,c.operator),filterCondition:c,selected:true}))}else{u=c.conditions[0].attribute;if(t.getAttributeMetadata(u).isHierarchy){continue}a.push(new D({facetAttribute:u,label:c.valueLabel,filterCondition:c,selected:true}))}}}return a}},{key:"_formatLabel",value:function e(t,r){var a;switch(r){case k.Bw:a=t+"*";break;case k.Ew:a="*"+t;break;case k.Co:a="*"+t+"*";break;default:a=t;break}return a}},{key:"getAttributeFacetsFromPerspective",value:function e(t,r){var a=r.getDataSource();if(a.type===r.sinaNext.DataSourceType.Category){return Promise.resolve([])}var i=t.facets.filter(function(e){return e&&e.type&&e.type===r.sinaNext.FacetType.Chart});var n=[];var o={};var c=u(i),l;try{for(c.s();!(l=c.n()).done;){var s=l.value;var f=new b({title:s.title,facetType:"attribute",dimension:s.query.dimension,totalCount:t.totalCount});if(s.items.length===0){continue}for(var d=0;d<s.items.length;d++){var v=s.items[d];var h="";if(typeof r.config.checkAndSetSpaceIcon==="function"){h=r.config.checkAndSetSpaceIcon(v.icon,s.query.dimension)}else{h=v.icon}var y=new D({facetAttribute:s.query.dimension,label:this._formatLabel(v.dimensionValueFormatted,v.filterCondition.operator),value:v.measureValue,filterCondition:v.filterCondition,icon:h});y.facetTitle=s.title;y["serverSideItem"]=true;f.items.push(y)}o[s.query.dimension]=f;n.push(f)}}catch(e){c.e(e)}finally{c.f()}this.addDataTypeToClientSideFacets(n,r);var p={};var S=this._createFacetItemsFromConditionGroup(a,r.getProperty("/uiFilter/rootCondition"));for(var m=0,g=S.length;m<g;m++){var F=S[m];var k=o[F.facetAttribute];if(k){var C=n.indexOf(k);if(C>0){n.splice(C,1);n.splice(0,0,k)}for(var T=0,w=k.items.length;T<w;T++){var A=k.items[T];if(F.filterCondition.equals(A.filterCondition)){A.selected=true}}}p[F.facetAttribute]=k}return Promise.resolve(n)}},{key:"addDataTypeToClientSideFacets",value:function e(t,r){var a=r.getDataSource();for(var i=0;i<t.length;i++){var n=t[i];try{var o=a.getAttributeMetadata(n.dimension);n.dataType=o.type}catch(e){this.errorHandler.onError(e)}}}},{key:"addQuickSelectDataSourceFacet",value:function e(t,r){if(t.config.quickSelectDataSources.length===0){return}var a=t.config.quickSelectDataSources[0];var i;if(a.type==="quickSelectDataSourceTreeNode"){i=this.createTreeQuickSelectDataSourceFacet(t)}else{i=this.createListQuickSelectDataSourceFacet(t)}r.push(i)}},{key:"createListQuickSelectDataSourceFacet",value:function e(t){return{facetType:"quickSelectDataSource",items:t.config.quickSelectDataSources.map(function(e){return{type:"quickSelectDataSourceListItem",dataSource:e}})}}},{key:"createTreeQuickSelectDataSourceFacet",value:function e(t){var r=this;if(!this.treeQuickSelectDataSourceFacet){this.treeQuickSelectDataSourceFacet={facetType:"quickSelectDataSource",items:[{type:"quickSelectDataSourceTreeNode",children:t.config.quickSelectDataSources.map(function(e){return r.createTreeNodeQuickSelectDataSource(e)})}]}}var a=this.treeQuickSelectDataSourceFacet.items[0];this.expandPathToSelectedDataSource(t,a);return this.treeQuickSelectDataSourceFacet}},{key:"expandPathToSelectedDataSource",value:function e(t,r){function a(e,t){var r=[];function a(e,i){e=e.slice();e.push(i);if(i.getDataSource&&i.getDataSource()===t){r.push(e);return}if(!i.children){return}var n=u(i.children),o;try{for(n.s();!(o=n.n()).done;){var c=o.value;a(e,c)}}catch(e){n.e(e)}finally{n.f()}}a([],e);return r}var i=a(r,t.getDataSource());var n=u(i),o;try{for(n.s();!(o=n.n()).done;){var c=o.value;for(var l=0;l<c.length-1;++l){var s=c[l];s.expanded=true}}}catch(e){n.e(e)}finally{n.f()}}},{key:"createTreeNodeQuickSelectDataSource",value:function e(t){var r=this;var a=[];if(t.children){a=t.children.map(function(e){return r.createTreeNodeQuickSelectDataSource(e)})}return{expanded:false,type:"quickSelectDataSourceTreeNode",label:t.dataSource.labelPlural,icon:t.dataSource.icon,getDataSource:function e(){return t.dataSource},dataSourceId:t.dataSource.id,children:a,toggleExpand:function e(){this.expanded=!this.expanded}}}},{key:"getFacets",value:function t(r,a,i){try{const t=this;var n=[t.getDataSourceFacetFromTree(i)];t.addQuickSelectDataSourceFacet(i,n);if(r===i.appDataSource||r.type===i.sinaNext.DataSourceType.Category){return e(n)}if(!a){return e(n)}var o=[];return e(t.hierarchyDynamicFacetsFormatter.getFacets(a,i),function(r){o.push.apply(o,l(r));return e(t.hierarchyStaticFacetsFormatter.getFacets(a),function(r){o.push.apply(o,l(r));return e(t.getAttributeFacetsFromPerspective(a,i),function(e){o.push.apply(o,l(e));t.sortFacets(o,i);n.push.apply(n,o);t.setFacetIndex(n);return n})})})}catch(e){return Promise.reject(e)}}},{key:"setFacetIndex",value:function e(t){for(var r=0;r<t.length;++r){var a=t[r];if(a.setFacetIndex){a.setFacetIndex(r)}else{a.facetIndex=r}}}},{key:"sortFacets",value:function e(t,r){if(t.length===0){return t}var a=function e(t,r){if(t.position<r.position){return-1}if(t.position>r.position){return 1}return 0};for(var i=0;i<t.length;i++){var n=t[i];if(typeof n.position!=="undefined"){continue}if(r.config.searchInAttibuteFacetPostion){n.position=r.config.searchInAttibuteFacetPostion[n.dimension]||i+1e3}else{n.position=i+1e3}}t.sort(a);return t}},{key:"getDialogFacetsFromMetaData",value:function e(t,r){var a=[];var i=this.getAttributeDialogFacetsFromMetaData(t,r);a.push.apply(a,l(i));var n=this.hierarchyDynamicFacetsFormatter.getFacetsFromMetadata(t,r);a.push.apply(a,l(n));a.sort(function(e,t){return e.title.localeCompare(t.title)});this.setFacetIndex(a);return a}},{key:"getAttributeDialogFacetsFromMetaData",value:function e(t,r){var a=jQuery.map(t.attributeMetadataMap,function(e){return e});var i=[];var n=u(a),o;try{for(n.s();!(o=n.n()).done;){var c=o.value;if((c.usage.Facet||c.usage.AdvancedSearch)&&c.isHierarchy!==true){var l=new b({title:c.label,facetType:"attribute",dimension:c.id,dataType:c.type,matchingStrategy:c.matchingStrategy});if(r.config.showSpaceFacetInShowMoreDialog){if(r.config.showSpaceFacetInShowMoreDialog(c.id)===false){l.visible=false}}var s=this._createFacetItemsFromConditionGroup(r.getDataSource(),r.getProperty("/uiFilter/rootCondition"));var f=0;for(var d=0,v=s.length;d<v;d++){var h=s[d];h.visible=l.visible;if(h.facetAttribute===l.dimension){f++;l.items.splice(0,0,h)}}l["count"]=f;i.push(l)}}}catch(e){n.e(e)}finally{n.f()}return i}},{key:"getDialogFacetsFromChartQuery",value:function e(t,r,a,i){var n=new b({dimension:a});if(t){for(var o=0;o<t.items.length;o++){var c=t.items[o];var u=new D({value:c.measureValue,filterCondition:c.filterCondition,label:c.dimensionValueFormatted,facetAttribute:t.query.dimension});n.items.push(u)}var l;if(i){l=i}else{l=this._createFacetItemsFromConditionGroup(r.getDataSource(),r.getProperty("/uiFilter/rootCondition"))}for(var s=0,f=l.length;s<f;s++){var d=l[s];if(d.facetAttribute===n.dimension){var v=false;for(var h=0,y=n.items.length;h<y;h++){var p=n.items[h];if(d.filterCondition.equals(p.filterCondition)){p.selected=true;v=true}}if(!v){n.items.splice(n.items.length,0,d);if(d.filterCondition.userDefined){d.advanced=true}else{d.listed=true;d.value="";d.valueLabel=""}}else{d.listed=true}}}}return n}},{key:"hasDialogFacetsFromMetaData",value:function e(t){var r=t.getDataSource();var a=jQuery.map(r.attributeMetadataMap,function(e){return e});var i=false;var n=u(a),o;try{for(n.s();!(o=n.n()).done;){var c=o.value;if(c.usage){if(c.usage.Facet||c.usage.AdvancedSearch){i=true;break}}}}catch(e){n.e(e)}finally{n.f()}return i}},{key:"handleDataSourceChanged",value:function e(){this.hierarchyDynamicFacetsFormatter.handleDataSourceChanged();this.hierarchyStaticFacetsFormatter.handleDataSourceChanged()}},{key:"destroy",value:function e(){this.hierarchyDynamicFacetsFormatter.destroy();this.hierarchyDynamicFacetsFormatter=null;this.hierarchyStaticFacetsFormatter.destroy();this.hierarchyStaticFacetsFormatter=null}}]);return t}();return C})})();