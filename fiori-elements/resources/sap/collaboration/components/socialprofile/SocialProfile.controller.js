/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/security/encodeURL","sap/base/util/isEmptyObject","sap/collaboration/components/utils/CommonUtil","sap/collaboration/components/utils/OdataUtil","sap/ui/core/mvc/Controller","sap/ui/model/odata/ODataModel","sap/ui/model/json/JSONModel"],function(e,i,t,s,a,r,o,l){"use strict";sap.ui.controller("sap.collaboration.components.socialprofile.SocialProfile",{onInit:function(){this.getView().getViewData().collaborationHostServiceUrl?this._sJamODataServiceUrl=this.getView().getViewData().collaborationHostServiceUrl:this._sJamODataServiceUrl="/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData";this.getView().getViewData().smiServiceUrl?this._sSMIODataServiceUrl=this.getView().getViewData().smiServiceUrl:this._sSMIODataServiceUrl="/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV";this._oODataUtil=new a;this._oCommonUtil=new s;this._sPrefixId=this.getView().getId();this._sJamURL="";this._sJamUserId="";this._sPopoverPrefix=this.getView().getViewData().popoverPrefix;this._fnUserInfoFetchedCallback=this.getView().getViewData().afterUserInfoRetrieved;this._initializeModels()},onBeforeRendering:function(){if(this._memberId!==this.getView().getViewData().memberId){this.getView().resetHeader();this._clearViewData();this._memberId=this.getView().getViewData().memberId;var e=this.getView().getViewData().memberInfo;if(t(e)){this._getMember()}else{this._setMember(e);if(this._fnUserInfoFetchedCallback){this._fnUserInfoFetchedCallback(e)}}}},_initializeModels:function(){var e=true;this._oJamODataModel=new o(this._sJamODataServiceUrl,e);this._oJSONModel=new l({});this.getView().setModel(this._oJSONModel)},_getMember:function(){var i=this;if(this._oSocialProfileRequest){this._oSocialProfileRequest.abort()}var s="Members_FindByEmail";var a={};a.urlParameters={Email:"'"+i._memberId+"'",$expand:"MemberProfile/PhoneNumbers",$select:"Id,FullName,Title,Email,WebURL,MemberProfile"};a.success=function(e,s){var a=i._oCommonUtil.getODataResult(e);if(!t(a)){var r=a.MemberProfile.PhoneNumbers.results;var o=r.length;for(var l=0;l<o;l++){if(r[l]["PhoneNumberType"]==="Work"){a.MemberProfile.WorkPhoneNumber=r[l]["PhoneNumber"]}if(r[l]["PhoneNumberType"]==="Mobile"){a.MemberProfile.MobilePhoneNumber=r[l]["PhoneNumber"]}}i._oJSONModel.setData(a);i._sJamUserId=a.Id;var m=i._buildThumbnailImageURL(i._sJamUserId);sap.ui.getCore().byId(i._sPrefixId+"_HeaderUserImage").setSrc(m);if(i._fnUserInfoFetchedCallback){i._fnUserInfoFetchedCallback(a)}}};a.error=function(t){if(t.response&&t.response.statusCode){e.error("SAP Jam request failed at sap.collaboration.components.socialprofile.SocialProfileController._getMember()");i.getView().setHeaderNoUser()}};this._oSocialProfileRequest=this._oJamODataModel.read(s,a)},_setMember:function(e){var i={UserImage:e.picture,Id:e.id,FullName:e.fullname,Title:e.title,Email:e.email,MemberProfile:{Address:e.address,WorkPhoneNumber:e.workPhoneNumber,MobilePhoneNumber:e.mobilePhoneNumber}};this._sJamUserId=e.id;this._oJSONModel.setData(i)},_clearViewData:function(){sap.ui.getCore().byId(this._sPrefixId+"_HeaderUserImage").setSrc();sap.ui.getCore().byId(this._sPrefixId+"_FullName").setText();sap.ui.getCore().byId(this._sPrefixId+"_Role").setText();sap.ui.getCore().byId(this._sPrefixId+"_MobileNumber").setText();sap.ui.getCore().byId(this._sPrefixId+"_WorkNumber").setText();sap.ui.getCore().byId(this._sPrefixId+"_Email").setText();sap.ui.getCore().byId(this._sPrefixId+"_CompanyAddress").setText()},_buildThumbnailImageURL:function(e){return this._sJamODataServiceUrl+"/Members('"+i(e)+"')/ThumbnailImage/$value"}})});