/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/security/encodeXML","sap/ui/base/Object","sap/m/SelectDialog"],function(e,t,a,r){"use strict";var i=a.extend("sap.collaboration.components.fiori.sharing.helper.ShareUtil",{constructor:function(e,t,a,r,i,s){this._bIsOkToRefreshSecurityToken=true;this.iGrowingThreshold=10;this.oLangBundle=e;this.oODataUtil=t;this.oSMIODataModel=a;this.oJamODataModel=i;this.oCollaborationHostRestService=s;this.oCommonUtil=r;this.bShareError=false;this.bShareBusinessObjShared;this.bFileUploaded;this.aUploadAttachmentsUploaded=[];this.IdisplaySuccessMessageIntervalId},shareBusinessObject:function(t){var a=this;if(t.mappedExternalObject){if(t.feedContent!==undefined&&t.feedContent.uiUrl!==undefined){var r=t.mappedExternalObject;r.Name=t.externalObject.name;r.Groups=[{__metadata:{uri:"Groups('"+t.groupId+"')"}}];r.Permalink=t.feedContent.uiUrl;var i={async:true,success:function(e,r){a._bIsOkToRefreshSecurityToken=true;a._createGroupFeedEntry_SharedExternalObject(t)},error:function(e){if(e.response.statusCode===409){a._createGroupFeedEntry_SharedExternalObject(t)}else if(e.response.statusCode===403&&a._bIsOkToRefreshSecurityToken){a.oJamODataModel.refreshSecurityToken(function(){a._bIsOkToRefreshSecurityToken=false;a.shareBusinessObject(t)},function(e){a._checkAuthorizationAndDisplayErrorMessage(e.response.statusCode)},true)}else{a._bIsOkToRefreshSecurityToken=true;a._checkAuthorizationAndDisplayErrorMessage(e.response.statusCode)}}};this.oJamODataModel.create("/ExternalObjects",r,i)}else{e.error("feedContent.uiUrl parameter should not be undefined when sharing an external object","sap.collaboration.components.fiori.sharing.helper.ShareUtil.shareBusinessObject()");this.displayErrorMessage()}}else{this._createFeedEntry_ShareObjectLink(t)}},_createGroupFeedEntry_SharedExternalObject:function(e){var a='<?xml version="1.0" encoding="UTF-8"?>'+'<feed xmlns="http://www.w3.org/2005/Atom" xmlns:activity="http://activitystrea.ms/spec/1.0/">'+"<entry>"+"<title> </title>"+'<content type="html">'+t(e.feedContent.note)+"</content>"+"<author>"+"<email>"+t(e.memberEmail)+"</email>"+"<activity:object-type>http://activitystrea.ms/schema/1.0/person</activity:object-type>"+"</author>"+"<activity:verb>http://activitystrea.ms/schema/1.0/share</activity:verb>"+"<activity:object>"+"<id>"+t(e.mappedExternalObject.Exid)+"</id>"+'<title type="html">'+t(e.externalObject.name)+"</title>"+"<activity:object-type>"+t(e.mappedExternalObject.ObjectType)+"</activity:object-type>"+'<link type="text/html" rel="alternate" href="'+t(e.feedContent.uiUrl)+'"/>'+'<link rel="http://www.odata.org" href="'+t(e.mappedExternalObject.ODataLink)+'"/>'+'<link rel="http://www.odata.org/metadata" href="'+t(e.mappedExternalObject.ODataMetadata)+'"/>'+'<link rel="http://www.odata.org/annotation" href="'+t(e.mappedExternalObject.ODataAnnotations)+'"/>'+"<source>"+"<id>tag:www.cubetree.com,2013:/groups/"+t(e.groupId)+"</id>"+"</source>"+"</activity:object>"+"</entry>"+"</feed>";var r=this;var i=function(){if(this.readyState==4){if(this.status==200){r.bShareBusinessObjShared=true;r.displaySuccessMessage(e.groupName)}else{r._checkAuthorizationAndDisplayErrorMessage(this.status)}}};this._createFeedEntryViaRestAPI(a,i)},_createFeedEntry_ShareObjectLink:function(a){this.bShareBusinessObjShared=false;if(a.feedContent){if(a.feedContent.note!==undefined){var r=a.feedContent.note;if(a.feedContent.uiUrl){r=r+"<br/><a href='"+a.feedContent.uiUrl.replace(/'/g,"&apos;")+"'>"+this.oLangBundle.getText("SHARE_OBJECT_LINK")+"</a>"}var i='<?xml version="1.0" encoding="UTF-8"?>'+'<feed xmlns="http://www.w3.org/2005/Atom" xmlns:activity="http://activitystrea.ms/spec/1.0/">'+"<entry>"+"<title>"+t(this.oLangBundle.getText("SHARE_OBJECT_LINK_TITLE"))+"</title>"+'<content type="html">'+t(r)+"</content>"+"<author>"+"<email>"+t(a.memberEmail)+"</email>"+"<activity:object-type>http://activitystrea.ms/schema/1.0/person</activity:object-type>"+"</author>"+"<activity:verb>http://activitystrea.ms/schema/1.0/share</activity:verb>"+"<activity:object>"+"<source>"+"<id>tag:www.cubetree.com,2013:/groups/"+t(a.groupId)+"</id>"+"</source>"+"</activity:object>"+"</entry>"+"</feed>";var s=this;var o=function(){if(this.readyState==4){if(this.status==200){s.bShareBusinessObjShared=true;s._bIsOkToRefreshSecurityToken=true;s.displaySuccessMessage(a.groupName)}else{if(this.status==403&&s._bIsOkToRefreshSecurityToken){s.oJamODataModel.refreshSecurityToken(function(){s._bIsOkToRefreshSecurityToken=false;s._createFeedEntry_ShareObjectLink(a)},function(e){s._checkAuthorizationAndDisplayErrorMessage(e.response.statusCode)},true)}else{s._bIsOkToRefreshSecurityToken=true;s._checkAuthorizationAndDisplayErrorMessage(this.status)}}}};this._createFeedEntryViaRestAPI(i,o)}else{e.error("feedContent.note parameter should not be undefined","sap.collaboration.components.fiori.sharing.helper.ShareUtil._createFeedEntry_ShareObjectLink()");this.displayErrorMessage()}}else{e.error("feedContent parameter should not be undefined","sap.collaboration.components.fiori.sharing.helper.ShareUtil._createFeedEntry_ShareObjectLink()");this.displayErrorMessage()}},_createFeedEntryViaRestAPI:function(e,t){var a={Accept:"application/atom+xml","Content-Type":"application/atom+xml","x-csrf-token":this.oJamODataModel.getSecurityToken()};var r=this.oCollaborationHostRestService.url+"/feed/post";if(this.oCollaborationHostRestService.urlParams!=undefined&&this.oCollaborationHostRestService.urlParams!=""){r=r+"?"+this.oCollaborationHostRestService.urlParams}var i=new window.XMLHttpRequest;i.open("POST",r,true);for(var s in a){i.setRequestHeader(s,a[s])}i.onreadystatechange=t;i.send(e)},uploadAttachments:function(t){for(var a in t.aFilesToUpload){this.oSMIODataModel.create("/UploadTargetFile",null,{async:true,success:function(t,a){e.debug("File was uploaded","sap.collaboration.components.fiori.sharing.helper.ShareUtil.uploadAttachments()")},error:function(t){e.error("Error, file was not uploaded","sap.collaboration.components.fiori.sharing.helper.ShareUtil.uploadAttachments()")},urlParameters:{FileMimeType:"'"+t.aFilesToUpload[a].mimeType+"'",FileName:"'"+t.aFilesToUpload[a].name+"'",FileURL:"'"+t.aFilesToUpload[a].url+"'",FolderId:"'"+t.folderId+"'",GroupId:"'"+t.groupId+"'"}})}},createGroupSelectionDialog:function(e,t,a,i,s,o){var n=this;var l=function(e){var a=e.getParameter("value");n.oGroupSelectionDialog.bindAggregation("items","/Groups/?$filter=substringof('"+a.replace(/'/g,"''")+"',Name)",t)};this.oGroupSelectionDialog=new r(e+"_GroupSelectionDialog",{multiSelect:false,noDataText:this.oLangBundle.getText("GRP_NO_GROUPS_FOUND_TEXT"),rememberSelections:false,growingThreshold:this.iGrowingThreshold,title:this.oLangBundle.getText("GROUP_SELECTION_DIALOG_TITLE"),confirm:a,search:l,liveChange:l}).addStyleClass("sapUiPopupWithPadding");if(i){this.oGroupSelectionDialog.setContentWidth(i.toString()+"px")}if(s){this.oGroupSelectionDialog.setContentHeight(s.toString()+"px")}this.oGroupSelectionDialog.setModel(o);this.oGroupSelectionDialog.bindAggregation("items","/Groups",t);return this.oGroupSelectionDialog},displaySuccessMessage:function(e){var t=true;if(!(this.bShareBusinessObjShared===true||this.bShareBusinessObjShared===undefined)){t=false}var a=true;if(!(this.bFileUploaded===true||this.bFileUploaded===undefined)){t=false}if(this.bShareError===false){if(t===true&&a===true){this.oCommonUtil.showMessage(this.oLangBundle.getText("SHARING_SUCCESS_MSG",[e]),{width:"20em",autoClose:false});clearInterval(this.IdisplaySuccessMessageIntervalId)}}else{clearInterval(this.IdisplaySuccessMessageIntervalId)}},displayErrorMessage:function(){if(!this.bShareError){var e=this.oLangBundle.getText("SHARING_FAILURE_MSG");this.oCommonUtil.displayError(e)}this.bShareError=true},_checkAuthorizationAndDisplayErrorMessage:function(e){var t=this;if(e==401||e==403){t.oCommonUtil.displayError(t.oLangBundle.getText("SHARE_AUTHORIZATION_FAILURE_MSG"))}else{t.displayErrorMessage()}}});return i});