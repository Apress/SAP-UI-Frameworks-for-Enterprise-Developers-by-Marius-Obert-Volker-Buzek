/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/security/encodeURL","./helper/AttachmentsUtil","./helper/ShareUtil","sap/collaboration/components/utils/CommonUtil","sap/collaboration/components/utils/OdataUtil","sap/ui/core/mvc/Controller","sap/ui/thirdparty/jquery","sap/ui/model/odata/ODataModel","sap/ui/model/odata/CountMode","sap/m/StandardListItem","sap/m/library"],function(e,t,i,o,s,a,n,l,r,h,c,d){"use strict";var u=d.ListType;sap.ui.controller("sap.collaboration.components.fiori.sharing.Sharing",{onInit:function(){this.oNoteTextArea=this.getView().oNoteTextArea;this.oAttachmentsInput=this.getView().oAttachmentsInput;this.oTargetFolderInput=this.getView().oTargetFolderInput;this.oODataUtil=undefined;this.sPrefixId=this.getView().getViewData().controlId;this.oLangBundle=this.getView().getViewData().langBundle;this.iJamGroupsCount=0;this.sObjectId=this.getView().getViewData().objectId;this.sObjectShare=this.getView().getViewData().objectShare;this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.oExternalObject=undefined;this.oMappedExternalObject=undefined;this.sMemberEmail=undefined;this.oSharingDialog=this.getView().getViewData().sharingDialog;this.fNoGroupsCallBack=this.getView().getViewData().noGroupsCallBack;this.oCommonUtil=new s;this.oAttachments=this.getView().getViewData().attachments;this.bAttachmentsCB=false;this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId="";this.oItemTemplate=undefined;this.oSelectedGroup=undefined;this.gettingSuggestions=undefined},onBeforeRendering:function(){try{this.sSelectedGroupId="";this.sSelectedGroupName="";if(!this.oSMIODataModel){this.initializeOdataModel()}if(!this.oODataUtil){this.initializeOdataUtils()}if(!this.oAttachmentsUtil){this.initializeAttachmentsUtil()}this.initializeShareUtil();this.preRenderSetup();this.fetchData();this.clearAttachmentsData();this.oAttachments=this.getView().getViewData().attachments;if(this.oAttachments&&this.oAttachments.attachmentsArray){this.aFiles=this.oAttachments.attachmentsArray;if(this.aFiles.length>0){this.getView().oAttachmentsInput.setEnabled(true)}else{this.getView().oAttachmentsInput.setEnabled(false)}if(this.oFileSelectionDialog){var e=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog.setModel(e)}this.showAttachmentsFields(true)}else{this.showAttachmentsFields(false)}if(this.sObjectId!=this.getView().getViewData().objectId){this.sObjectId=this.getView().getViewData().objectId}if(this.sObjectShare!=this.getView().getViewData().objectShare||sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setValue!==this.getView().getViewData().objectShare){this.sObjectShare=this.getView().getViewData().objectShare;sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setInitialValue(this.sObjectShare)}if(this.oObjectDisplay!=this.getView().getViewData().objectDisplay){if(this.oObjectDisplay!=undefined){this.getView().oSharingVBox.removeItem(0)}this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.getView().oSharingVBox.insertItem(this.oObjectDisplay,0)}}catch(e){if(this.oSharingDialog){throw e}this.oCommonUtil.displayError(e)}},onAfterRendering:function(){setTimeout(function(){sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect").focus()}.bind(this),1)},onExit:function(){this.getView().destroyContent()},preRenderSetup:function(){this.getView().oGroupSelect.setEnabled(false);this.setGroupSelectionText("");if(this.oAttachments&&this.oAttachments.attachmentsArray){this.getView().oTargetFolderInput.setEnabled(false)}this.getView().oNoteTextArea.setEnabled(false);if(this.oSharingDialog){this.oSharingDialog.getButtons()[0].setEnabled(false);this.oSharingDialog.getButtons()[1].setEnabled(false)}},fetchData:function(){var t=this;var i=new l.Deferred;i.done(function(e){t.iJamGroupsCount=e;if(t.iJamGroupsCount>0){t.postFetchSetup();setTimeout(function(){t.getView().getContent()[0].getItems()[1].getContent()[1].focus()},50)}else{if(t.fNoGroupsCallBack){t.fNoGroupsCallBack()}}});var o=new l.Deferred;o.done(function(e){if(!t.sJamUrl){t.sJamUrl=e}});var s=new l.Deferred;s.done(function(e){t.oMappedExternalObject=e});s.fail(function(){t.oMappedExternalObject=undefined;e.debug("Mapping Internal BO to External BO failed")});var a=new l.Deferred;a.done(function(e){if(!t.sMemberEmail){t.sMemberEmail=e}});l.when(i,o,s).fail(function(e){if(t.oSharingDialog){t.oSharingDialog.close()}if(e.statusCode===401||e.statusCode===403){t.oCommonUtil.displayError(t.oLangBundle.getText("SHARE_AUTHORIZATION_FAILURE_MSG"))}else{t.oCommonUtil.displayError()}});this.oJamODataModel.read("/Groups/$count",{success:function(e,t){i.resolve(parseInt(t.body))},error:function(e){i.reject(e.response)}});this.oJamODataModel.read("/Self",{success:function(e,t){a.resolve(this.oCommonUtil.getODataResult(e).Email)}.bind(this),error:function(e){a.reject(e.response)}});if(!this.sJamUrl){this.oSMIODataModel.read("/GetCollaborationHostURL",{success:function(e,t){o.resolve(e.GetCollaborationHostURL.URL)},error:function(e){o.reject(e.response)}})}else{o.resolve()}this.oExternalObject=this.getView().getViewData().externalObject;if(this.oExternalObject){this.oSMIODataModel.read("/MapInternalBOToExternalBO",{urlParameters:{ApplicationContext:"'"+t.oExternalObject.appContext+"'",ODataCollection:"'"+t.oExternalObject.collection+"'",ODataKeyPredicate:"'"+t.oExternalObject.key+"'",ODataServicePath:"'"+t.oExternalObject.odataServicePath+"'"},success:function(e,t){s.resolve(e.MapInternalBOToExternalBO)},error:function(e){s.reject(e.response)}})}},postFetchSetup:function(){this.setGroupSelectionEnabled(true)},initializeOdataModel:function(){var e=true;this.sSMIODataServiceUrl=this.getView().getViewData().odataServiceUrl;this.oSMIODataModel=new r(this.sSMIODataServiceUrl,e);this.sJamODataServiceUrl=this.getView().getViewData().collaborationHostODataServiceUrl;this.oJamODataModel=new r(this.sJamODataServiceUrl,e);this.oJamODataModel.setDefaultCountMode(h.Inline)},initializeOdataUtils:function(){this.oODataUtil=new a},initializeAttachmentsUtil:function(){this.oAttachmentsUtil=new i(this.oLangBundle,this.oODataUtil,this.oJamODataModel)},initializeShareUtil:function(){this.oShareUtil=new o(this.oLangBundle,this.oODataUtil,this.oSMIODataModel,this.oCommonUtil,this.oJamODataModel,this.getView().getViewData().collaborationHostRestService)},setGroupSelectionText:function(e){var t=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");t.setValue(e)},setGroupSelectionEnabled:function(e){var t=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");t.setEnabled(e)},setFolderSelectionEnabled:function(e){this.oTargetFolderInput.setEnabled(e)},showAttachmentsFields:function(e){this.getView().AttachmentsInputLayout.setVisible(e);this.getView().oTargetFolderInputLayout.setVisible(e);this.getView().oAttachmentCB.setVisible(e)},clearAttachmentsData:function(){this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId="";this.bAttachmentsCB=false;this.oAttachmentsInput.setValue("");this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.getView().oAttachmentCB.setEnabled(false);this.oTargetFolderInput.setValue("");if(this.oFolderSelectionDialog){this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId())}},onAttachmentsValueHelpPress:function(e){if(this.oSharingDialog){var t=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var i=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth}if(!this.oFileSelectionDialog){var o=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog=this.oAttachmentsUtil.createFileSelectionDialog(this.sPrefixId,o,this.onFileSelectionDialogConfirm(),i,t)}var s=this.oFileSelectionDialog.getBinding("items");s.filter([]);this.oFileSelectionDialog.open()},onFileSelectionDialogConfirm:function(){var e=this;return function(t){e.aSelectedFiles=[];var i=t.getParameter("selectedContexts");for(var o=0;o<i.length;o++){e.aSelectedFiles.push(i[o].getObject())}if(e.aSelectedFiles&&e.aSelectedFiles.length>0){e.postFileSelectionSetup(true)}else{e.postFileSelectionSetup(false)}}},postFileSelectionSetup:function(e){if(e===true){if(this.aSelectedFiles.length==1){this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENT_FIELD_TEXT",[this.aSelectedFiles.length]))}else{this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENTS_FIELD_TEXT",[this.aSelectedFiles.length]))}this.getView().oAttachmentCB.setEnabled(true);if(this.sSelectedGroupId!==""){this.setFolderSelectionEnabled(true)}}else{this.oAttachmentsInput.setValue("");this.bAttachmentsCB=false;this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.postAttachmentCheckBoxSelection();this.getView().oAttachmentCB.setEnabled(false);this.setFolderSelectionEnabled(false)}},onGroupSelectValueHelpPress:function(e){if(!this.oItemTemplate){this.oItemTemplate=new c({title:{parts:["Name","GroupType"],formatter:function(e,t){return e+" ("+t+")"}},type:u.Active,tooltip:"{Name}"})}if(this.oSharingDialog){var t=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var i=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth}if(!this.oGroupSelectionDialog){this.oGroupSelectionDialog=this.oShareUtil.createGroupSelectionDialog(this.sPrefixId,this.oItemTemplate,this._onGroupSelectionDialogConfirm(),i,t,this.oJamODataModel)}else{this.oGroupSelectionDialog.setModel(this.oJamODataModel);this.oGroupSelectionDialog.bindAggregation("items","/Groups",this.oItemTemplate)}this.oGroupSelectionDialog.open()},_onGroupSelectionDialogConfirm:function(){var e=this;return function(t){var i=t.getParameter("selectedContexts");for(var o=0;o<i.length;o++){e.oSelectedGroup=i[o].getObject()}if(e.oSelectedGroup){e.postGroupSelectionSetup(true)}else{e.postGroupSelectionSetup(false)}}},postGroupSelectionSetup:function(e){if(e===true){if(this.oSelectedGroup!==undefined){this.sSelectedGroupId=this.oSelectedGroup.Id.toString();this.sSelectedGroupName=this.oSelectedGroup.Name.toString();this.setGroupSelectionText(this.sSelectedGroupName)}if(this.oAttachments&&this.oAttachments.attachmentsArray){this.sSelectedFolderId="";this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId());var t=this.oAttachmentsUtil.getCurrentFolder();this.oTargetFolderInput.setValue(t.name)}if(this.aSelectedFiles&&this.aSelectedFiles.length>0){this.setFolderSelectionEnabled(true)}if(this.bAttachmentsCB===false){this.getView().oNoteTextArea.setEnabled(true)}if(this.oSharingDialog){this.oSharingDialog.getButtons()[0].setEnabled(true);this.oSharingDialog.getButtons()[1].setEnabled(true)}}else{this.setFolderSelectionEnabled(false);this.getView().oNoteTextArea.setEnabled(false)}},onTargetFolderValueHelpPress:function(e){if(this.oSharingDialog){var t=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var i=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth}if(!this.oFolderSelectionDialog){this.oFolderSelectionDialog=this.oAttachmentsUtil.createFolderSelectionDialog(this.sPrefixId,this.getSelectedGroupId(),this.onFolderSelectionDialogConfirm(),this.onFolderSelectionDialogCancel(),i,t);this.sSelectedFolderId=""}this.oFolderSelectionDialog.getContent()[0].oController.setFolderSelectionDialogTitle(this.oTargetFolderInput.getValue());this.oFolderSelectionDialog.open()},onFolderSelectionDialogConfirm:function(e){var t=this;return function(){var e=t.oAttachmentsUtil.getCurrentFolder();t.sSelectedFolderId=e.id;t.oTargetFolderInput.setValue(e.name)}},onFolderSelectionDialogCancel:function(e){var t=this;return function(e){t.oAttachmentsUtil.setCurrentFolderId(t.sSelectedFolderId)}},onAttachmentCheckBoxSelected:function(){this.bAttachmentsCB=this.getView().oAttachmentCB.getSelected();this.postAttachmentCheckBoxSelection()},atMentionsButtonPressed:function(){this.getView().oNoteTextArea.atMentionsButtonPressed()},onSuggestion:function(t){if(this.gettingSuggestions){this.gettingSuggestions.abort()}var i=this;var o=t.getParameter("value");var s=this.getView().oNoteTextArea;if(o.trim()===""){s.showSuggestions([]);s.setSuggestionHeight(undefined);return}var a=this.getSelectedGroupId();var n="/Members_Autocomplete";var l={async:true,urlParameters:{Query:"'"+o+"'",GroupId:"'"+a+"'",$top:"4"},success:function(e,t){var o=i.oCommonUtil.getODataResult(e);if(o.length===0){s.closeSuggestionPopover();s.setSuggestionHeight(undefined)}else{var a=[];var n=o.length;for(var l=0;l<n;l++){a.push({fullName:o[l].FullName,email:o[l].Email,userImage:i._buildThumbnailImageURL(o[l].Id)})}s.showSuggestions(a);n>=3?s.setSuggestionHeight("12rem"):s.setSuggestionHeight(undefined)}},error:function(t){e.error("Failed to get suggestions: "+t.statusText)}};this.gettingSuggestions=this.oJamODataModel.read(n,l)},postAttachmentCheckBoxSelection:function(){if(this.bAttachmentsCB===true){this.getView().oNoteTextArea.setEnabled(false)}else{if(this.sSelectedGroupId!==""){this.getView().oNoteTextArea.setEnabled(true)}}},getSharingData:function(){var e;if(this.oNoteTextArea.getValue()!==undefined&&this.oNoteTextArea.getValue()!==""||this.sObjectId!==undefined&&this.sObjectId!==""){e={note:this.oNoteTextArea.convertTextWithFullNamesToEmailAliases(),uiUrl:this.sObjectId}}if(JSON.stringify(this.oExternalObject)==="{}"){this.oExternalObject=undefined}return{feedContent:e,groupId:this.getSelectedGroupId(),folderId:this.getSelectedFolderId(),aFilesToUpload:this.aSelectedFiles,externalObject:this.oExternalObject,mappedExternalObject:this.oMappedExternalObject,groupName:this.getSelectedGroupName(),memberEmail:this.sMemberEmail}},getSelectedGroupId:function(){return this.sSelectedGroupId},getSelectedGroupName:function(){return this.sSelectedGroupName},getSelectedFolderId:function(){return this.sSelectedFolderId},shareToJam:function(){var e=this.getSharingData();var t=this;if(e.aFilesToUpload.length===0&&(!e.feedContent||!e.feedContent.uiUrl&&e.feedContent.note.trim()==="")&&!e.externalObject){var i=t.oLangBundle.getText("SHARING_NOTHING_TO_SHARE_MSG");this.oCommonUtil.showMessage(i,{duration:3e3,autoclose:false})}else{if(!this.bAttachmentsCB){this.oShareUtil.shareBusinessObject(e)}if(e.aFilesToUpload.length>0){this.oShareUtil.uploadAttachments(e);var i=this.oLangBundle.getText("SHARING_ACKNOWLEDGMENT_MSG");setTimeout(function(){t.oCommonUtil.showMessage(i,{duration:3e3,width:"30em",autoClose:false})},500)}}},_buildThumbnailImageURL:function(e){return this.oJamODataModel.sServiceUrl+"/Members('"+t(e)+"')/ThumbnailImage/$value"}})});