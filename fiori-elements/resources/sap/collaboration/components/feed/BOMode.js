/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(["./Mode","sap/collaboration/components/utils/PendingRequestsUtil","sap/ui/model/odata/ODataModel","sap/ui/thirdparty/jquery"],function(e,t,o,i){"use strict";var n=e.extend("sap.collaboration.components.feed.BOMode",{constructor:function(o){e.apply(this,[o]);this._sJamBOId=undefined;this._oPendingRequestsUtil=new t;this._oSMIModel=this._oFeedController.getModel("smi");this._oLanguageBundle=this._oFeedController.getLanguageBundle();this._oList.setModel(this._oJamModel);this.FILTER_CONSTANTS={GROUP_WALL:"Group Wall",GROUP_OBJECT_WALL:"Group Object Wall"};o.byId("filter_popover").attachSelectionChange(this.onFilterSelection,this)}});n._sSMIv2ServiceUrl="/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV";n.prototype.start=function(e){if(!(this._oCommonUtil.isObject(e)&&this._oCommonUtil.isString(e.appContext)&&this._oCommonUtil.isString(e.odataServicePath)&&this._oCommonUtil.isString(e.collection)&&this._oCommonUtil.isString(e.key)&&this._oCommonUtil.isString(e.name))){var t="The feedSources' data object is invalid.";this._oFeedController.logError(t);throw new Error(t)}this._sendRequestMapInternalBOToExternalBO(e.appContext,e.collection,e.key,e.odataServicePath).then(function(e,t){return this._sendRequestExternalObjects_FindByExidAndObjectType(e.MapInternalBOToExternalBO.Exid,e.MapInternalBOToExternalBO.ObjectType)}.bind(this),function(e){this._oFeedController.logError("The internal to external mapping for the business object could not be performed.");this._oFeedController.displayErrorMessage(this._oLanguageBundle.getText("SMIV2_INTERNAL_TO_EXTERNAL_BO_MAPPING_COULD_NOT_BE_PERFORMED"));return null}.bind(this)).then(function(e,t){this._sJamBOId=this._oCommonUtil.getODataResult(e).Id;this._oList.attachUpdateFinished(this.onGroupSelectorUpdateFinished,this);this._oList.bindItems({path:"/ExternalObjects('"+this._oCommonUtil.getODataResult(e).Id+"')/Groups",template:this._oListItemTemplate})}.bind(this),function(e){if(e!==null){this._oFeedController.logError("An external object associated with the given Exid and ObjectType could not be found.");this._oFeedController.displayErrorMessage(this._oLanguageBundle.getText("JAM_EXTERNAL_OBJECT_COULD_NOT_BE_FOUND"))}}.bind(this));this._oFeedController.enableGroupFeed();this._oViewDataModel.setProperty("/filterEnabled",true);this._setFilterOptions(e.name);this._oList.attachUpdateFinished(this.onUpdateFinished,this)};n.prototype.stop=function(){this._oPendingRequestsUtil.abortAll();this._oViewDataModel.setProperty("/filterEnabled",false);this._oList.detachUpdateFinished(this.onUpdateFinished,this)};n.prototype._sendFunctionImportODataRequest=function(e,t,o){var n=i.Deferred();var s=e.callFunction(t,{urlParameters:o,success:function(e,t){n.resolve(e,t)},error:function(e){n.reject(e)}});var r=n.promise(s);this._oPendingRequestsUtil.add(r);n.always(function(){this._oPendingRequestsUtil.remove(r)}.bind(this));return r};n.prototype._sendRequestMapInternalBOToExternalBO=function(e,t,o,i){return this._sendFunctionImportODataRequest(this._oSMIModel,"/MapInternalBOToExternalBO",{ApplicationContext:e,ODataCollection:t,ODataKeyPredicate:o,ODataServicePath:i})};n.prototype._sendRequestExternalObjects_FindByExidAndObjectType=function(e,t){return this._sendFunctionImportODataRequest(this._oJamModel,"/ExternalObjects_FindByExidAndObjectType",{Exid:e,ObjectType:t})};n.prototype._setFilterOptions=function(e){var t;e?t=this._oLanguageBundle.getText("GF_FILTER_OBJECT",e):t=this._oLanguageBundle.getText("GF_FILTER_OBJECT_DEFAULT");var o=[{Name:this._oLanguageBundle.getText("GF_FILTER_GROUP"),key:this.FILTER_CONSTANTS.GROUP_WALL},{Name:t,key:this.FILTER_CONSTANTS.GROUP_OBJECT_WALL}];this._oViewDataModel.setProperty("/filter",o);var i=this._oFeedController.byId("filter_popover");i.setSelectedItem(i.getItems()[0])};n.prototype.getAddPostPath=function(){var e=this._oViewDataModel.getProperty("/groupSelected/Id");return"/GroupExternalObjects(GroupId='"+e+"',ExternalObjectId='"+this._sJamBOId+"')/FeedEntries"};n.prototype.displayFeedSourceSelectorPopover=function(e){this._oList.setBusy(true);this._oJamModel.refresh(true);this._oGroupSelectPopover.openBy(e)};n.prototype.onGroupSelected=function(e){var t=e.getSource().getSelectedItem().getBindingContext().getObject();this._oViewDataModel.setProperty("/groupSelected",{Id:t.Id,Name:t.Name,WebURL:t.WebURL});this._oViewDataModel.setProperty("/feedEndpoint","/Groups('"+t.Id+"')/FeedEntries");this._oViewDataModel.setProperty("/filterMessage","");var o=this._oFeedController.byId("filter_popover");o.setSelectedItem(o.getItems()[0]);this._oGroupSelectPopover.close()};n.prototype.onBatchCompleted=function(e){};n.prototype.onGroupSelectorUpdateFinished=function(){var e=this._oList.getItems();var t;var o;if(e.length>0){t=e[0];this._oList.setSelectedItem(t);o=t.getBindingContext().getObject();this._oViewDataModel.setProperty("/groupSelected",o);this._oViewDataModel.setProperty("/feedEndpoint","/Groups('"+o.Id+"')/FeedEntries")}this._oList.detachUpdateFinished(this.onGroupSelectorUpdateFinished,this)};n.prototype.onUpdateFinished=function(){this._oList.setBusy(false)};n.prototype.onFilterSelection=function(e){var t=e.getParameter("listItem");var o=t.getBindingContext().getObject();var i=this._oViewDataModel.getProperty("/groupSelected/Id");switch(o.key){case this.FILTER_CONSTANTS.GROUP_WALL:this._oViewDataModel.setProperty("/filterMessage","");this._oViewDataModel.setProperty("/feedEndpoint","/Groups('"+i+"')/FeedEntries");break;case this.FILTER_CONSTANTS.GROUP_OBJECT_WALL:this._oViewDataModel.setProperty("/filterMessage",this._oLanguageBundle.getText("ST_FILTER_TEXT")+" "+o.Name);this._oViewDataModel.setProperty("/feedEndpoint","/GroupExternalObjects(GroupId='"+i+"',ExternalObjectId='"+this._sJamBOId+"')/FeedEntries");break}};n.prototype.getFeedUpdatesLatestCount=function(){var e=this._oFeedController.byId("timeline").getContent()[0];var t=e?e.getModel().getProperty("/TopLevelId"):"";var o=this._oViewDataModel.getProperty("/groupSelected/Id");if(this._oViewDataModel.getProperty("/filterMessage")===""){return this._sendRequestGroup_SinceLatestCount(t,o)}else{var i=this._sJamBOId;return this._sendRequestGroupExternalObject_SinceLatestCount(t,o,i)}};n.prototype._sendRequestGroup_SinceLatestCount=function(e,t){return this._sendFunctionImportODataRequest(this._oJamModel,"/Group_FeedLatestCount",{LatestTopLevelId:e,Id:t})};n.prototype._sendRequestGroupExternalObject_SinceLatestCount=function(e,t,o){return this._sendFunctionImportODataRequest(this._oJamModel,"/GroupExternalObject_FeedLatestCount",{LatestTopLevelId:e,GroupId:t,ExternalObjectId:o})};n.prototype._initializeModels=function(){e.prototype._initializeModels.apply(this);var t=new o(n._sSMIv2ServiceUrl,true);this._oFeedController.setSmiModel(t)};n.prototype.getSMIv2ServiceUrl=function(){return n._sSMIv2ServiceUrl};return n});