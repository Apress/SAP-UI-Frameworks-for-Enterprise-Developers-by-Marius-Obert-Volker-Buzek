/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","../controls/FilterPopover","../controls/ReplyPopover","../controls/SocialTextArea","./controls/TimelineItemEmbedded","./datahandlers/JamDataHandler","./datahandlers/SMIntegrationDataHandler","./datahandlers/ServiceDataHandler","./datahandlers/TimelineDataHandler","./filter/FilterType","./validation/InputValidator","../utils/CommonUtil","../utils/DateUtil","sap/suite/ui/commons/library","sap/suite/ui/commons/Timeline","sap/suite/ui/commons/TimelineItem","sap/ui/core/CustomData","sap/ui/core/library","sap/ui/core/Item","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ui/model/odata/ODataModel","sap/m/Button","sap/m/library","sap/m/Link","sap/m/Popover","sap/m/ResponsivePopover","sap/m/SelectList","sap/m/StandardListItem"],function(e,t,i,o,s,n,a,r,l,d,u,_,h,c,m,g,p,f,T,b,y,v,I,C,P,S,D,E,B,F){"use strict";var x=T.MessageType;var A=P.ButtonType;var O=P.PlacementType;var M=m.TimelineAxisOrientation;var L=m.TimelineAlignment;var w=y.extend("sap.collaboration.components.socialtimeline.Component",{metadata:{version:"1.0",includes:["../resources/css/SocialTimeline.css"],dependencies:{libs:["sap.collaboration"],components:[],ui5version:""},config:{},customizing:{},rootView:null,publicMethods:["setBusinessObject","setBusinessObjectKey","setBusinessObjectMap","updateTimelineEntry","deleteTimelineEntry"],aggregations:{},properties:{enableSocial:{type:"boolean",group:"Social",defaultValue:true},alignment:{type:"sap.suite.ui.commons.TimelineAlignment",group:"Misc",defaultValue:L.Right},axisOrientation:{type:"sap.suite.ui.commons.TimelineAxisOrientation",group:"Misc",defaultValue:M.Vertical},noDataText:{type:"string",group:"Misc",defaultValue:null},showIcons:{type:"boolean",group:"Misc",defaultValue:true},visible:{type:"boolean",group:"Appearance",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},customFilter:{type:"object[]",group:"Social"}},events:{customActionPress:{}}},_defaultAttributes:{collaborationHostServiceUrl:"/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData",smiServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV",pageSize:10,jamOnly:false},init:function(){this._oLogger=e.getLogger("sap.collaboration.components.socialtimeline.Component");this._oCollaborationHostModel;this._oSMIntegrationModel;this._oTimeline;this._oTimelineModelData={enableSocial:true,alignment:L.Right,axisOrientation:M.Vertical,enableBackendFilter:true,enableScroll:true,forceGrowing:true,noDataText:null,showIcons:true,sort:true,visible:true,width:"100%",timelineData:[],suggestions:[]};this._oTimelineModel=new v(this._oTimelineModelData);this._oTimelineModel.setSizeLimit(1e4);this._oTimelineModel.bindProperty("/enableSocial").attachChange(this._onEnableSocialChange,this);this._iGrowingThreshold=this._defaultAttributes.pageSize;this._oFilterIcon;this._oContextSelect;this._oAddPostButton;this._oBusinessObjectMap={};this._oBusinessObject={};this._oCommonUtil=new h;this._oDateUtil=new c;this._oLanguageBundle=this._oCommonUtil.getLanguageBundle();this._oTimelineDataHandler;this._oJamDataHandler;this._oSMIntegrationDataHandler;this._oFilterPopover;this._oFilterConstants=new u;this._oFilter={};this._oRepliesData;this._oReplyPopover;this._oAddPostPopover;this._oSocialProfile;this._oTimelineUser={};this._oInputValidator;this._oGettingTimelineData;this._initialize();this._oInputValidator=new _(this);y.prototype.init.apply(this)},exit:function(){if(this._oTimeline){this._oTimeline.destroy()}if(this._oAddPostPopover){this._oAddPostPopover.destroy()}if(this._oReplyPopover){this._oReplyPopover.destroy()}if(this._oFilterPopover){this._oFilterPopover.destroy()}if(this._oSocialProfile){this._oSocialProfile.destroy()}if(this._oInputValidator){this._oInputValidator.destroy()}if(this._oFilterIcon){this._oFilterIcon.destroy()}if(this._oContextSelect){this._oContextSelect.destroy()}if(this._oAddPostButton){this._oAddPostButton.destroy()}},onBeforeRendering:function(){if(this._oInputValidator.areSocialFeaturesEnabled()===true){if(!this._oBusinessObject.key||this._oBusinessObject.key===""){this._oTimeline._filterIcon.setEnabled(false);this._oContextSelect.setEnabled(false)}}else{if(!this._oBusinessObject.key||this._oBusinessObject.key===""){this._oTimeline._filterIcon.setEnabled(false)}this._oContextSelect.setVisible(false);this._oAddPostButton.setVisible(false)}this._getLoggedInUser();this._bindTemplates()},onAfterRendering:function(){},createContent:function(){return this._createTimeline()},setProperty:function(e,t){y.prototype.setProperty.call(this,e,t);this._oLogger.info(e+": "+t);switch(e){case"enableSocial":var i=t;if(i===true){i=this._oInputValidator.validateEnableSocial()}this._oTimelineModel.setProperty("/"+e,i);break;case"customFilter":var o=t;this._oInputValidator.validateCustomFilter();if(o&&o.length!==0){this._oTimeline.setCustomFilter(this._getFilter());this._oTimeline._filterIcon.setEnabled(true)}else{this._oTimeline._filterIcon.setEnabled(false)}break;default:this._oTimelineModel.setProperty("/"+e,t);break}},setSettings:function(e){for(var t in e){if(e.hasOwnProperty(t)){this.setProperty(t,e[t])}}},setBusinessObjectMap:function(e){this._oLogger.info("servicePath: "+e.servicePath);this._oLogger.info("collection: "+e.collection);this._oLogger.info("applicationContext: "+e.applicationContext);this._oBusinessObjectMap=e;this._validateBusinessObjectMap();this._defaultAttributes.jamOnly=t(this._oBusinessObjectMap.serviceModel);var i;var o;if(this._defaultAttributes.jamOnly){this._oFilter={type:this._oFilterConstants.FILTER_TYPE.feedUpdates};this._oContextSelect.setVisible(false);this._oTimeline._filterIcon.setVisible(false)}else{this._oContextSelect.setVisible(true);this._oTimeline._filterIcon.setVisible(true);i=this._oInputValidator.createTermsUtilityForBackend(this._oBusinessObjectMap.serviceModel);o=new l(this._oBusinessObjectMap.serviceModel,i)}this._oTimelineDataHandler=new d(this._oBusinessObjectMap,this._oJamDataHandler,this._oSMIntegrationDataHandler,o,i,this._iGrowingThreshold,this._oInputValidator.areSocialFeaturesEnabled(),this._oInputValidator.areBackendFeaturesEnabled())},setBusinessObjectKey:function(e){this._oLogger.info("Business Object Key: "+e);if(!this._oTimelineDataHandler){this._oLogger.error("Function setBusinessObjectMap must be called before calling setBusinessObjectKey for the first time.")}this._oTimeline._filterIcon.setEnabled(true);this._oAddPostButton.setEnabled(false);this._oContextSelect.setEnabled(true);this._oBusinessObject={key:e,name:e};this._oTimelineDataHandler.setBusinessObject(this._oBusinessObject);if(!this._defaultAttributes.jamOnly){this._resetFilterAndContextSelector()}this._refreshTimelineModel()},setBusinessObject:function(e){this._oBusinessObject=e;this._oLogger.info("Business Object Key: "+this._oBusinessObject.key);this._oLogger.info("Business Object Name: "+this._oBusinessObject.name);if(!this._oTimelineDataHandler){this._oLogger.error("Function setBusinessObjectMap must be called before calling setBusinessObject for the first time.")}this._validateBusinessObject();if(this._defaultAttributes.jamOnly){this._oAddPostButton.setEnabled(true)}else{this._oTimeline._filterIcon.setEnabled(true);this._oAddPostButton.setEnabled(false);this._oContextSelect.setEnabled(true);this._oTimelineDataHandler.setBusinessObject(this._oBusinessObject)}if(!this._defaultAttributes.jamOnly){this._resetFilterAndContextSelector()}this._refreshTimelineModel()},updateTimelineEntry:function(e,t){var i=sap.ui.getCore().byId(t);var o=i.getAggregation("embeddedControl");var s=o._oFlexbox.getItems();s[0].setText(e);if(s.length>1){for(var n=1;n<s.length;n++){s[n].destroy()}}var a=i.getModel();var r=this._oTimeline.getContent().indexOf(i);a.getData().timelineData[r].timelineItemData.text=e;a.getData().timelineData[r].timelineItemData.timelineEntryDetails=[]},deleteTimelineEntry:function(e){var t=sap.ui.getCore().byId(e);var i=t.getModel();var o=this._oTimeline.getContent().indexOf(t);i.getData().timelineData.splice(o,1);t.destroy()},_initialize:function(){var e=true;if(!this._oCollaborationHostModel){this._oCollaborationHostModel=new I(this._defaultAttributes.collaborationHostServiceUrl,e)}if(!this._oSMIntegrationModel){this._oSMIntegrationModel=new I(this._defaultAttributes.smiServiceUrl,e)}if(!this._oJamDataHandler){this._oJamDataHandler=new a(this._oCollaborationHostModel)}if(!this._oSMIntegrationDataHandler){this._oSMIntegrationDataHandler=new r(this._oSMIntegrationModel)}},_createTimeline:function(){this._oTimeline=new g(this.getId()+"_timeline",{enableSocial:"{/enableSocial}",alignment:"{/alignment}",axisOrientation:"{/axisOrientation}",enableBackendFilter:"{/enableBackendFilter}",enableScroll:"{/enableScroll}",forceGrowing:"{/forceGrowing}",noDataText:"{/noDataText}",showIcons:"{/showIcons}",visible:"{/visible}",width:"{/width}",sort:"{/sort}",data:[],grow:this._onGrow.bind(this)});this._modifyHeaderBar();this._oTimeline.setModel(this._oTimelineModel);return this._oTimeline},_modifyHeaderBar:function(){var e=this._oTimeline.getHeaderBar();var t=e.getContent();this._oFilterIcon=t[t.length-1];this._oContextSelect=this._createContextSelector();e.insertContent(this._oContextSelect,0);this._oAddPostButton=this._createAddPostButton();e.insertContent(this._oAddPostButton,3)},_createContextSelector:function(){var e=function(e){var t=sap.ui.getCore().byId(this.getId()+"_context_select");var i=sap.ui.getCore().byId(this.getId()+"_context_select_popover");if(i==undefined){var o=[];o.push({context_type:this._oFilterConstants.FILTER_TYPE.systemUpdates,context_text:this._oLanguageBundle.getText("ST_CONTEXT_SYSTEM_UPDATES")});o.push({context_type:this._oFilterConstants.FILTER_TYPE.feedUpdates,context_text:this._oLanguageBundle.getText("ST_CONTEXT_DISCUSSION_POSTS")});var s=new v(o);this.setModel(s,"timeline_context");var n=new b({key:"{context_type}",text:"{context_text}"});var a=new B(this.getId()+"_context_select_list",{selectedKey:this._oFilterConstants.FILTER_TYPE.systemUpdates,selectionChange:[this._onContextSelect,this],width:"15rem"});a.bindAggregation("items",{path:"/",template:n});a.setModel(s);i=new D(this.getId()+"_context_select_popover",{placement:O.VerticalPreferedBottom,title:this._oLanguageBundle.getText("ST_CONTEXT_SELECT_HEADER")});i.addContent(a)}i.getContent()[0].setSelectedKey(this._oFilter.type);i.openBy(t)};var t=new C(this.getId()+"_context_select",{icon:"sap-icon://navigation-down-arrow",iconFirst:false,text:this._oLanguageBundle.getText("ST_CONTEXT_SYSTEM_UPDATES"),type:A.Transparent,press:[e,this]});return t},_createAddPostButton:function(){if(this._oAddPostPopover===undefined){this._oAddPostPopover=new E(this.createId("_addPostPopover"),{placement:O.Auto,title:this._oLanguageBundle.getText("ST_ADD_POST_TITLE"),contentWidth:"25rem",contentHeight:"10rem",content:new s(this.createId("social_TextArea"),{height:"10rem",width:"100%",enableNotifyAll:false,liveChange:[function(e){e.getParameter("value").trim()!==""?this.byId("addPost_postButton").setEnabled(true):this.byId("addPost_postButton").setEnabled(false)},this],suggest:[this._onSuggest,this],afterSuggestionClose:[function(){if(this.gettingSuggestions){this.gettingSuggestions.request.abort()}},this]}),endButton:new C(this.createId("addPost_postButton"),{text:this._oLanguageBundle.getText("ST_ADD_POST_BUTTON"),enabled:false,press:[this._onAddPost,this]}),beginButton:new C(this.createId("addPost_atMentionButton"),{text:"@",press:[function(){this.byId("social_TextArea").atMentionsButtonPressed()},this]})}).setInitialFocus(this.byId("social_TextArea"))}var e=new C(this.createId("_addPostButton"),{icon:"sap-icon://add",type:A.Transparent,enabled:false,press:[function(){this._oAddPostPopover.openBy(this.byId("_addPostButton"))},this]});return e},_refreshTimelineModel:function(){var e=this;this._oTimeline.setBusyIndicatorDelay(0).setBusy(true);this._oGettingTimelineData=this._oTimelineDataHandler.getTimelineData(this._oFilter,this._defaultAttributes.jamOnly?this._oBusinessObject:null).then(function(t){e._oTimeline.setBusy(false);e._oFilter.text===undefined||e._oFilter.text===e._oLanguageBundle.getText("ST_FILTER_ALL")?e._oTimeline.setCustomMessage(""):e._oTimeline.setCustomMessage(e._oLanguageBundle.getText("ST_FILTER_TEXT")+" "+e._oFilter.text);e._oTimeline.destroyContent();e._oTimelineModelData.timelineData=t;e._oTimelineModel.setData(e._oTimelineModelData);e._setReplies()},function(t){e._oCommonUtil.displayError();e._oTimeline.setBusy(false)})},_bindTemplates:function(){if(this._oTimeline.getBinding("content").getPath()!=="/timelineData"){var e=new f({key:"{key}",value:"{value}"});var t=new p({dateTime:"{timelineItemData/dateTime}",userName:"{timelineItemData/userName}",title:"{timelineItemData/title}",icon:"{timelineItemData/icon}",filterValue:"{timelineItemData/filterValue}",userNameClickable:"{/enableSocial}",userNameClicked:this._onUserNameClicked,userPicture:"{timelineItemData/userPicture}",embeddedControl:this._createEmbeddedControl(),customAction:{template:e,path:"timelineItemData/customActionData"},customActionClicked:this._onCustomActionClicked.bind(this),replyCount:"{timelineItemData/replyCount}",replyListOpen:this._onReplyListOpen.bind(this)});this._oTimeline.bindAggregation("content",{path:"/timelineData",template:t})}},_createEmbeddedControl:function(e){var t=e===undefined?"{}":e;var i=new n({timelineItem:t,expandCollapseClick:[function(){this._oTimeline.adjustUI()},this],atMentionClick:[this._getAtMentionClicked,this]});return i},_getFilter:function(){var e=this.getCustomFilter();var t=e.length;for(var o=0;o<t;o++){e[o].type=this._oFilterConstants.FILTER_TYPE.custom}var s=[{text:this._oLanguageBundle.getText("ST_FILTER_ALL"),type:this._oFilterConstants.FILTER_TYPE.systemUpdates}].concat(e);if(!this._oFilterPopover){var n=new v({filter:s});var a=new F({title:"{text}"});this._oFilterPopover=new i(this.getId()+"_filterPopover",{title:this._oLanguageBundle.getText("ST_FILTER_HEADER"),selectionChange:[function(e){this._oFilter=e.getParameter("listItem").getBindingContext().getObject();this._oTimelineDataHandler.reset();this._refreshTimelineModel()},this]}).setModel(n).bindItems("/filter",a);this._oFilterPopover.setSelectedItem(this._oFilterPopover.getItems()[0])}else{this._oFilterPopover.getModel().setProperty("/filter",s)}return this._oFilterPopover},_resetFilterAndContextSelector:function(){this._resetFilter();this._oContextSelect.setText(this._oLanguageBundle.getText("ST_CONTEXT_SYSTEM_UPDATES"))},_resetFilter:function(){this._oTimelineModel.setProperty("/sort",true);this._oFilter={type:this._oFilterConstants.FILTER_TYPE.systemUpdates};if(this._oFilterPopover){this._oFilterPopover.setSelectedItem(this._oFilterPopover.getItems()[0])}},_setReplies:function(){var e=this;var t=this._oTimeline.getContent();t.forEach(function(t){var i=t.getBindingContext().getObject();if(!i._feedEntryData){e._hideReply(t)}else{t.setCustomReply(e._createReplyPopover())}})},_hideReply:function(e){e._replyLink.setVisible(false)},_showSocialProfile:function(e,t,i){if(e){var o=e.getParent().getParent().getParent();if(!o._oSocialProfile){o._oSocialProfile=sap.ui.getCore().createComponent({name:"sap.collaboration.components.socialprofile",id:this.getId()+"_socialProfile"});o._oSocialProfile._defaultAttributes=o._defaultAttributes}var s={openingControl:t,memberId:i};o._oSocialProfile.setSettings(s);o._oSocialProfile.open()}},_getFeedId:function(e){var t=e.getBindingContext().getPath();var i=t.split("/");var o=i[i.length-1];var s=e.getModel().getData().timelineData[o]._feedEntryData.Id;return s},_getLoggedInUser:function(){var e=this;var t=this._oJamDataHandler.getSender();t.promise.done(function(t,i){e._oTimelineUser=t});t.promise.fail(function(t){e._oLogger.error("Failed to get the sender",t.stack)})},_addTimelineItemToTimeline:function(e){var t=this._oTimeline.getModel().getData();t.timelineData.push(e);var i=new p({dateTime:e.timelineItemData.dateTime,userName:e.timelineItemData.userName,title:e.timelineItemData.title,text:e.timelineItemData.text,icon:e.timelineItemData.icon,userNameClickable:true,userNameClicked:this._onUserNameClicked,userPicture:e.timelineItemData.userPicture,embeddedControl:this._createEmbeddedControl(e),replyCount:e.timelineItemData.replyCount,replyListOpen:this._onReplyListOpen.bind(this),customReply:this._createReplyPopover()});this._oTimeline.insertContent(i,0);var o=t.timelineData.indexOf(e);var s=i.getParent().getModel().createBindingContext("/timelineData/"+o);i.setBindingContext(s)},_validateInputParameters:function(){this._oInputValidator=new _(this);if(!this._oInputValidator.areCustomFiltersValid()){this.destroy()}return this._oInputValidator},_validateBusinessObjectMap:function(){if(!this._oInputValidator){this._validateInputParameters()}if(!this._oInputValidator.isBusinessObjectMapValid(this._oBusinessObjectMap)){this.destroy()}},_validateBusinessObject:function(){if(!this._oInputValidator){this._validateInputParameters()}if(!this._oInputValidator.isBusinessObjectValid(this._oBusinessObject)){this.destroy()}},_onContextSelect:function(e){var t=e.getParameter("selectedItem");this._oFilter={type:t.getKey()};if(t.getKey()==this._oFilterConstants.FILTER_TYPE.feedUpdates){this._oTimelineModel.setProperty("/sort",false);this._oFilterIcon.setEnabled(false);this._oAddPostButton.setEnabled(true)}else{if(!this._defaultAttributes.jamOnly){this._resetFilter()}this._oFilterIcon.setEnabled(true);this._oAddPostButton.setEnabled(false)}this._oTimelineDataHandler.reset();this._refreshTimelineModel();var i=sap.ui.getCore().byId(this.getId()+"_context_select_popover");i.close();this._oContextSelect.setText(t.getText())},_onGrow:function(){var e=this;if(!this._oGettingTimelineData||this._oGettingTimelineData.state()!="pending"){this._oGettingTimelineData=this._oTimelineDataHandler.getTimelineData(this._oFilter).then(function(t){var i=e._oTimelineModel.getData();i.timelineData=i.timelineData.concat(t);e._oTimelineModel.setData(i);e._setReplies()},function(t){e._oCommonUtil.displayError()})}else{this._oLogger.info("A previous request is still pending.")}},_onUserNameClicked:function(e){var t=e.getSource().getParent().getParent();var i=e.getSource().getParent();var o=e.getSource();if(!t._oSocialProfile){t._oSocialProfile=sap.ui.getCore().createComponent({name:"sap.collaboration.components.socialprofile",id:this.getId()+"_socialProfile"});t._oSocialProfile._defaultAttributes=t._defaultAttributes}var s=i.getContent().indexOf(o);var n={openingControl:o._userNameLink,memberId:i.getModel().getData().timelineData[s].timelineItemData.userEmail};t._oSocialProfile.setSettings(n);t._oSocialProfile.open()},_onAddPost:function(e){var t=this;var i=this.byId("social_TextArea").convertTextWithFullNamesToEmailAliases();this.byId("_addPostPopover").close();if(i&&i.trim()!==""){this._oTimeline.setBusyIndicatorDelay(0).setBusy(true);this._oJamDataHandler.addPostToExternalObject(i,this._oTimelineDataHandler.getCurrentExternalBO()).then(function(e){t.byId("social_TextArea").clearText();t.byId("addPost_postButton").setEnabled(false);if(t._oFilter.type!==t._oFilterConstants.FILTER_TYPE.systemUpdates&&t._oFilter.type!==t._oFilterConstants.FILTER_TYPE.custom){var i=t._oTimelineDataHandler._mapFeedEntriesToTimelineItems([e])[0];t._addTimelineItemToTimeline(i);if(!t._oTimelineDataHandler.getUserInfoFromBuffer(e.Creator.Email)){t._oTimelineDataHandler.addUserInfoToBuffer(e.Creator)}}}).always(function(){t._oTimeline.setBusy(false)}).fail(function(){t._oCommonUtil.displayError(t._oLanguageBundle.getText("ST_POST_TO_JAM_FAILED"))})}else{this._oLogger.info("Posting an empty comment is not allowed, no feed entry will be created.")}},_onSuggest:function(e){var t=this;if(this.gettingSuggestions){this.gettingSuggestions.request.abort()}var i=e.getSource();var o=e.getParameter("value");if(o.trim()===""){i.showSuggestions([])}else{this.gettingSuggestions=this._oJamDataHandler.getSuggestions(o);this.gettingSuggestions.promise.done(function(e,o){var s=e.results;if(s.length===0){i.closeSuggestionPopover()}else{var n=[];for(var a=0;a<s.length;a++){n.push({fullName:s[a].FullName,email:s[a].Email,userImage:t._buildThumbnailImageURL(s[a].Id)})}i.showSuggestions(n)}});this.gettingSuggestions.promise.fail(function(e){if(e.response&&e.response.statusCode){t._oCommonUtil.displayError(t._oLanguageBundle.getText("ST_GET_SUGGESTIONS_FAILED"))}})}},_onCustomActionClicked:function(e){var t={};var i=e.getSource().getBindingContext();var o=i.getPath();var s=e.getSource().getModel().getProperty(o+"/timelineItemData/customActionData/oDataEntry");t.oDataEntry=s;t.timelineEntryId=e.getParameters().id;t.key=e.getParameters().key;this.fireCustomActionPress(t)},_getAtMentionClicked:function(e){var t=this;var i=[];var o=e.getSource();var s=e.getParameter("link");var n=this._oJamDataHandler.getAtMentions(s.getModel().getData().feedId);n.promise.done(function(e,n){var a=s.getModel().getProperty("/placeholderIndex");i=e.results;t._showSocialProfile(o,s,i[a].Email)});n.promise.fail(function(){t._oLogger.error("Failed to retrieve the @mentions.");t._oCommonUtil.displayError(t._oCommonUtil.getLanguageBundle().getText("ST_GET_ATMENTIONS_FAILED"))})},_onReplyListOpen:function(e){if(!this._bReplyPopoverIsOpen){this._bReplyPopoverIsOpen=true;var t=e.getSource();try{var i=this._getFeedId(t);if(!i){throw new Error("Failed to get the feed entry ID.")}}catch(e){this._oLogger.error("Failed to get the feed entry ID");this._oCommonUtil.displayError(this._oLanguageBundle.getText("ST_GET_REPLIES_FAILED"));return}this._getReplies(i,undefined,t)}},_getReplies:function(e,t,i){var o=this;i.getCustomReply().setBusyIndicatorDelay(0).setBusy(true);this.gettingReplies=this._oJamDataHandler.getReplies(e,t);this.gettingReplies.promise.done(function(e,t){o._oRepliesData=e;var s=e.results.reverse();s.forEach(function(e){e.Creator.ThumbnailImage=o._oTimelineDataHandler.buildImageUrl(e.Creator);e.CreatedAt=o._oDateUtil.formatDateToString(e.CreatedAt)});i.getCustomReply().addReplies({data:s,more:o._oRepliesData.__next?true:false});i.getCustomReply().setBusy(false)});this.gettingReplies.promise.fail(function(e){if(e.response&&e.response.statusCode){o._oCommonUtil.displayError(o._oCommonUtil.getLanguageBundle().getText("ST_GET_REPLIES_FAILED"))}})},_createReplyPopover:function(){this._oReplyPopover=new o({socialTextArea:new s({height:"80px",width:"100%",enableNotifyAll:false,suggestionPlacement:O.Top,suggest:[this._onSuggest,this],afterSuggestionClose:[function(){if(this.gettingSuggestions){this.gettingSuggestions.request.abort()}},this]}),postReplyPress:[this._onPostReplyPress,this],moreRepliesPress:[function(e){var t=e.getSource().getParent();if(this._oRepliesData.__next){this._getReplies(undefined,this._oRepliesData.__next,t)}},this],afterClose:[function(e){if(this.gettingReplies){this.gettingReplies.request.abort()}this._bReplyPopoverIsOpen=false},this]});this._oReplyPopover.getSocialTextArea().attachLiveChange(function(e){e.getParameter("value").trim()!==""?this.enableButton(true):this.enableButton(false)}.bind(this._oReplyPopover));return this._oReplyPopover},_onPostReplyPress:function(e){var t=this;var i=e.getParameter("value");var o=e.getSource().getParent();var s=o.getBindingContext().getObject();var n=s.timelineItemData.feedId;var a=o.getCustomReply();a.setBusyIndicatorDelay(0).setBusy(true);var r=this._oJamDataHandler.postReply(n,i);a._oReplyTextArea.focus();r.promise.done(function(e,i){a.getTextArea().clearText();a.enableButton(false);var s={Text:e.results.Text,Creator:{Email:t._oTimelineUser.Email,FullName:t._oTimelineUser.FullName},CreatedAt:t._oDateUtil.formatDateToString(e.results.CreatedAt)};var n=t._oTimelineDataHandler.getUserPicture(t._oTimelineUser.Email);n?s.Creator.ThumbnailImage=n:s.Creator.ThumbnailImage=t._oTimelineDataHandler.buildImageUrl(e.results);a.addReply(s);a.setBusy(false);o.setReplyCount(o.getReplyCount()+1)});r.promise.fail(function(e){a.setBusy(false);t._oCommonUtil.displayError(t._oLanguageBundle.getText("ST_POST_REPLY_FAILED"))})},_onEnableSocialChange:function(e){var t=e.getSource().getValue();t===true?this._oAddPostButton.setVisible(true):this._oAddPostButton.setVisible(false)},_showFeedUpdatesInTimeline:function(e){var t=this._oTimeline.getMessageStrip();if(e>0){if(!this.byId("refreshLink")){var i=new S(this.createId("refreshLink"),{text:this._oLanguageBundle.getText("GF_REFRESH_FEED"),press:[function(){this._hideFeedUpdatesInTimeline();this._oTimelineDataHandler.reset();this._refreshTimelineModel()},this]});t.setLink(i);t.setType(x.Information);t.setShowIcon(true)}e==1?t.setText(this._oLanguageBundle.getText("GF_NEW_FEED_UPDATE")):t.setText(this._oLanguageBundle.getText("GF_NEW_FEED_UPDATES",e));t.setVisible(true);this._oTimeline.rerender()}},_hideFeedUpdatesInTimeline:function(){var e=this._oTimeline.getMessageStrip();e.close()},_startAutoCheckingForNewUpdates:function(){this._iNewFeedUpdatesCheckerTimeDelay=12e4;this._sNewFeedUpdatesCheckerTimeoutId=setTimeout(this._checkForNewFeedUpdates.bind(this),this._iNewFeedUpdatesCheckerTimeDelay)},_stopAutoCheckingForNewUpdates:function(){clearTimeout(this._sNewFeedUpdatesCheckerTimeoutId)},_checkForNewFeedUpdates:function(){var e=function(e,t){this._showFeedUpdatesInTimeline(e);this._sNewFeedUpdatesCheckerTimeoutId=setTimeout(this._checkForNewFeedUpdates.bind(this),this._iNewFeedUpdatesCheckerTimeDelay)};var t=function(e){this._oLogger.error("Failed to check for new feed updates.");this._sNewFeedUpdatesCheckerTimeoutId=setTimeout(this._checkForNewFeedUpdates.bind(this),this._iNewFeedUpdatesCheckerTimeDelay)};var i=this._oTimeline.getContent()[0];var o=i?i.getBindingContext().getObject()._feedEntryData.TopLevelId:"";var s=this._oTimelineDataHandler.getCurrentExternalBO().Id;this._oJamDataHandler.getFeedUpdatesLatestCount(o,s).done(e.bind(this)).fail(t.bind(this))},_buildThumbnailImageURL:function(e){return this._defaultAttributes.collaborationHostServiceUrl+"/Members('"+e+"')/ThumbnailImage/$value"}});return w});