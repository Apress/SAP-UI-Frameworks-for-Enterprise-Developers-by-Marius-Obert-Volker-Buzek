// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/bootstrap/_SchedulingAgent/state","sap/base/util/LoaderExtensions","sap/base/Log","sap/ushell/Config"],function(e,o,n,i){"use strict";var t={Loaded:"loaded",Wait:"wait",Step:"step",Error:"error",BlockDone:"blockDone",Start:"start",Done:"done",Skipped:"skipped"};var d="sap/ushell/bootstrap/_SchedulingAgent/LoadingConfiguration.json";var a="sap/ushell/bootstrap/_SchedulingAgent/StepConfiguration.json";function s(){return i.last("/core/shell/model/currentState/stateName")}var r={oSchedule:{iBlockIndex:0,aBlocksLoading:[]},initializeSchedule:function(){var n=o.loadResource(a,{async:true});var i=o.loadResource(d,{async:true});var t=Promise.all([n,i]).then(function(o){var n=o[0];var i=o[1];var t=this._validateConfig(i,n);if(t){this.oSchedule.oBlocks=i.LoadingBlocks;this.oSchedule.oSteps=n;this.oSchedule.aBlockOrder=i.OrderOfLoadingBlocks;this.oSchedule.iBlockIndex=0;e.setForModule(e.id.module.flpScheduler.id,e.id.module.flpScheduler.Initialized,"Schedule validated")}else{e.setForModule(e.id.module.flpScheduler.id,e.id.module.flpScheduler.WrongConfiguration,"Configuration error")}return t}.bind(this));return t},getNextLoadingStep:function(){var o={sStatus:t.Start,oContent:{}};if(this.oSchedule.aBlocksLoading.length===0){var n=this._startLoadingBlock();if(n){o.sStatus=t.Done;return o}}var i=this.oSchedule.aBlocksLoading[this.oSchedule.aBlocksLoading.length-1];var d=this.oSchedule.aBlockOrder.indexOf(i);var a=this.oSchedule.aBlockOrder[d+1];if(this.oSchedule.oBlocks[i].bCanBeLoadedConcurrently&&a){this._startLoadingBlock()}var s=true;var r=false;var l,c,u,g,p,S,h,f,L;for(var k=0;k<this.oSchedule.aBlocksLoading.length;k++){l=this.oSchedule.aBlocksLoading[k];c=this.oSchedule.oBlocks[l];u=c.iStepIndex;g=c.LoadingSteps[u];p=u===c.LoadingSteps.length-1;S=this._checkAndUpdateAsyncQueue(c);L=e.isStepLoaded(g.LoadingStep)||e.isStepSkipped(g.LoadingStep);f=e.isStepLoading(g.LoadingStep);s=S.bAllStepsDone&&L;r=S.bAStepIsLoading||f;if(f&&!g.canBeLoadedAsync||r&&p){o.sStatus=t.Wait;continue}if(!p||!L&&!f){if(L||g.canBeLoadedAsync&&f){u+=1}o=this._prepareStepForLoading(c,l,u)}if(s&&p){h=this.oSchedule.aBlocksLoading.indexOf(l);this.oSchedule.aBlocksLoading.splice(h,1);o.sStatus=t.BlockDone;e.setForLoadingBlock(l,e.id.loadingBlock.Done,"","Block removed from loading queue")}if(o.sStatus!==t.wait){break}}return o},dumpSchedule:function(){n.debug(JSON.stringify(this.oSchedule))},_loadingIsEnabled:function(e){var o;if(Array.isArray(e.oConfig.excludedFLPStates)){if(e.oConfig.excludedFLPStates.indexOf(s())>-1){return false}}if(Array.isArray(e.oConfig.mandatoryFLPStates)&&e.oConfig.mandatoryFLPStates.length!==0){if(e.oConfig.mandatoryFLPStates.indexOf(s())===-1){return false}}function n(e){return e.path&&i.last(e.path)!==e.assertionValue}if(e.oConfig.configSwitch){o=[].concat(e.oConfig.configSwitch);if(o.some(n)){return false}}return true},_checkAndUpdateAsyncQueue:function(o){var n=[];var i,t,d;var a=true;var s=false;for(var r=0;r<o.aAsyncStepsLoading.length;r++){d=o.aAsyncStepsLoading[r];i=e.isStepLoaded(d)||e.isStepSkipped(d);t=e.isStepLoading(d);if(t){n.push(d)}a=a&&i;s=s||t}o.aAsyncStepsLoading=n;return{bAllStepsDone:a,bAStepIsLoading:s}},_startLoadingBlock:function(){var o=false;if(this.oSchedule.iBlockIndex<this.oSchedule.aBlockOrder.length){var n=this.oSchedule.aBlockOrder[this.oSchedule.iBlockIndex];this.oSchedule.aBlocksLoading.push(n);this.oSchedule.oBlocks[n].iStepIndex=0;this.oSchedule.oBlocks[n].aAsyncStepsLoading=[];this.oSchedule.iBlockIndex+=1;e.setForLoadingBlock(n,e.id.loadingBlock.Prepared,"","Block added to the loading queue.")}else{o=true}return o},_prepareStepForLoading:function(o,n,i){var d;var a={sStatus:t.Step,oContent:o.LoadingSteps[i],oConfig:this.oSchedule.oSteps[o.LoadingSteps[i].LoadingStep]};if(!this._loadingIsEnabled(a)){a.sStatus=t.Skipped;o.iStepIndex=i;e.setForLoadingStep(a.oContent.LoadingStep,e.id.loadingStep.Skipped,"","Step set to skipped");return a}var s=this._checkDependencies(a,n);if(s.bMissing){a.sStatus=t.Error}else if(s.bAllLoaded){e.setForLoadingStep(a.oContent.LoadingStep,e.id.loadingStep.Prepared,"","Step prepared for control unit");d=a.oContent.canBeLoadedAsync;o.iStepIndex=i;if(d){e.setForLoadingStep(a.oContent.LoadingStep,e.id.loadingStep.Prepared,"","Step set on the async loading queue");o.aAsyncStepsLoading.push(a.oContent.LoadingStep)}}else{a.sStatus=t.Wait;e.setForLoadingStep(a.oContent.LoadingStep,e.id.loadingStep.WaitingForDependencies,"","Step missing dependencies")}return a},_checkDependencies:function(o,n){var i={bAllLoaded:true,bMissing:false};if(o.oConfig.Dependencies){for(var t=0;t<o.oConfig.Dependencies.length;t++){i.bAllLoaded=i.bAllLoaded&&e.isStepLoaded(o.oConfig.Dependencies[t]);if(!e.isStepLoaded(o.oConfig.Dependencies[t])&&!e.isStepLoading(o.oConfig.Dependencies[t])){e.setForLoadingStep(o.oContent.LoadingStep,e.id.loadingStep.Aborted,o.oConfig.Dependencies[t],"Missing a dependency");e.setForLoadingBlock(n,e.id.loadingBlock.Aborted,o.oConfig.Dependencies[t],"A step is missing a dependency");e.setForModule(e.id.module.flpScheduler.id,e.id.module.flpScheduler.LoadingAborted,"Dependencies can not be resolved: a dependency isn't loading before it is required.");i.bMissing=true;i.bAllLoaded=false;break}}}return i},_validateConfig:function(e,o){var n=e&&e.OrderOfLoadingBlocks&&e.LoadingBlocks&&e.OrderOfLoadingBlocks.length&&o;if(!n){return false}var i=e.OrderOfLoadingBlocks.reduce(function(n,i){n=n&&e.LoadingBlocks[i];if(n){var t=e.LoadingBlocks[i];var d=true;if(t.LoadingSteps){var a;for(var s=0;s<t.LoadingSteps.length;s++){a=t.LoadingSteps[s].LoadingStep;d=d&&o[a]}}n=n&&d}return!!n},true);return i}};return r},false);