// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/adapters/cdm/v3/_LaunchPage/readApplications","sap/ushell/adapters/cdm/v3/_LaunchPage/readPages","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/base/util/values","sap/ushell/library","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/base/Log","sap/ushell/utils/UrlParsing"],function(e,t,i,a,n,r,o,s,l){"use strict";var u=r.DisplayFormat;var c=function(){};c.COMPONENT_NAME="sap/ushell/services/SearchableContent";c.prototype.getApps=function(){if(e.last("/core/spaces/enabled")){return this._getPagesAppData().then(this._filterGetApps)}return this._getLaunchPageAppData().then(this._filterGetApps).then(function(e){s.debug("SearchableContent@getApps in classic mode found "+e.length+" apps");return e}).catch(function(e){s.error("SearchableContent@getApps in classic mode failed",e);return Promise.reject(e)})};c.prototype._filterGetApps=function(e){e.forEach(function(e){var t=e.visualizations;var i=[];e.visualizations=[];t.forEach(function(t){var a=JSON.stringify({title:t.title,subtitle:t.subtitle,icon:t.icon,vizType:t.vizType});if(i.indexOf(a)===-1){e.visualizations.push(t);i.push(a)}})});return e.filter(function(e){return e.visualizations.length>0})};c.prototype._getLaunchPageAppData=function(){return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this._oLaunchPageService=e;return this._collectLaunchPageTiles()}.bind(this)).then(function(e){var t=e[0];var i=e[1];var a=t.concat(i);return Promise.all(a.map(function(e){var i=t.includes(e);var a={tileId:null,tile:e};var n;try{if(i){a.tileId=this._oLaunchPageService.getCatalogTileId(e)}else{a.tileId=this._oLaunchPageService.getTileId(e)}n=this._oLaunchPageService.getCatalogTilePreviewTitle(e)}catch(e){s.error("Could not get search data from tile "+a.tileId,e)}if(!n){return new Promise(function(t,a){if(i){this._oLaunchPageService.getCatalogTileViewControl(e).done(t).fail(a)}else{this._oLaunchPageService.getTileView(e).done(t).fail(a)}}.bind(this)).then(function(e){a.view=e;return a}).catch(function(e){s.error("Could not get search data from tile "+a.tileId,e);return a})}return Promise.resolve(a)}.bind(this)))}.bind(this)).then(function(e){var t={};var i=e.map(function(e){try{return this._buildVizDataFromLaunchPageTile(e.tile)}catch(t){s.error("Could not get search data from tile "+e.tileId,t);return null}}.bind(this)).filter(function(e){return e});e.forEach(function(e){var t=e.view;if(t){if(!t.destroy){s.error("The tile with id '"+e.tileId+"' does not implement mandatory function destroy")}else{t.destroy()}}});i.forEach(function(e){var i=e.targetURL;if(i){if(t[i]){t[i].visualizations.push(e)}else{t[i]=this._buildAppDataFromViz(e)}}}.bind(this));return n(t)}.bind(this))};c.prototype._collectLaunchPageTiles=function(){var e=this._oLaunchPageService.getGroups().then(function(e){return e.reduce(function(e,t){return Promise.all([e,this._oLaunchPageService.getGroupTilesForSearch(t)]).then(function(e){var t=e[0];var i=e[1];return t.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));var t=this._oLaunchPageService.getCatalogs().then(function(e){return e.reduce(function(e,t){return Promise.all([e,this._oLaunchPageService.getCatalogTiles(t)]).then(function(e){var t=e[0];var i=e[1];return t.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));return Promise.all([t,e])};c.prototype._getPagesAppData=function(){var e;var t;return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(e){return Promise.all([e.getAllPages({personalizedPages:true}),e.getApplications(),e.getVisualizations(),e.getVizTypes(),sap.ushell.Container.getServiceAsync("ClientSideTargetResolution")])}).then(function(i){var a=i[0];var n=i[1];var r=i[2];var o=i[3];var s=i[4];t={applications:n,visualizations:r,vizTypes:o};e={};this._applyCdmVisualizations(t,e);this._applyCdmPages(t,a,e);return this._filterAppDataByIntent(e,s)}.bind(this)).then(function(){this._applyCdmApplications(t,e);return n(e)}.bind(this))};c.prototype._filterAppDataByIntent=function(e,t){var i=Object.keys(e).map(function(e){return l.isIntentUrlAsync(e).then(function(t){return t?e:null})});return Promise.all(i).then(function(i){var a=i.filter(function(e){return!!e});if(a.length===0){return}return new Promise(function(i,n){t.isIntentSupported(a).then(function(t){Object.keys(t).forEach(function(i){if(!t[i].supported&&e[i]){delete e[i]}})}).always(i)})})};c.prototype._applyCdmApplications=function(e,i){Object.keys(i).forEach(function(a){try{var n=i[a].visualizations;var r=n.find(function(e){return e.target.appId&&e.target.inboundId});if(r){var o=e.applications[r.target.appId];var l=t.getInbound(o,r.target.inboundId);i[a]=this._buildAppDataFromAppAndInbound(o,l);i[a].visualizations=n;i[a].target=n[0].target}else{i[a]=this._buildAppDataFromViz(n[0]);i[a].visualizations=n;i[a].target=n[0].target}}catch(e){s.error("Could not get search data from application "+a,e)}}.bind(this))};c.prototype._applyCdmVisualizations=function(e,t){Object.keys(e.visualizations).forEach(function(i){try{var n={vizId:i,displayFormatHint:u.Standard};var r=a.getVizData(e,n);this._changeVizType(r);var o=r.targetURL;r.preview=true;if(o){if(t[o]){t[o].visualizations.push(r)}else{t[o]={visualizations:[r]}}}}catch(e){s.error("Could not get search data from visualization "+i,e)}}.bind(this))};c.prototype._applyCdmPages=function(e,t,n){t.forEach(function(t){var r=i.getVisualizationReferences(t);r.forEach(function(t){try{if(t.displayFormatHint&&t.displayFormatHint!==u.Standard){t=Object.assign({},t);t.displayFormatHint=u.Standard}var i=a.getVizData(e,t);this._changeVizType(i);var r=i.targetURL;i.preview=true;if(r){if(n[r]){n[r].visualizations.push(i)}else{n[r]={visualizations:[i]}}}}catch(e){s.error("Could not get search data from vizReference "+t.id,e)}}.bind(this))}.bind(this))};c.prototype._changeVizType=function(e){if(e._instantiationData.platform==="CDM"&&!o.isStandardVizType(e.vizType)){e.vizType="sap.ushell.StaticAppLauncher";e._instantiationData.vizType={"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}};c.prototype._buildAppDataFromAppAndInbound=function(e,i){return{id:t.getId(e),title:i.title||t.getTitle(e),subtitle:i.subTitle||t.getSubTitle(e),icon:i.icon||t.getIcon(e),info:i.info||t.getInfo(e),keywords:i.keywords||t.getKeywords(e),visualizations:[]}};c.prototype._buildAppDataFromViz=function(e){return{id:e.vizId,title:e.title,subtitle:e.subtitle,icon:e.icon,info:e.info,keywords:e.keywords,target:e.target,visualizations:[e]}};c.prototype._buildVizDataFromLaunchPageTile=function(e){var t;if(this._oLaunchPageService.getCatalogTileTargetURL(e)&&this._oLaunchPageService.isTileIntentSupported(e)){t={id:this._oLaunchPageService.getTileId(e)||this._oLaunchPageService.getCatalogTileId(e),vizId:this._oLaunchPageService.getCatalogTileId(e)||this._oLaunchPageService.getTileId(e)||"",vizType:"",title:this._oLaunchPageService.getCatalogTilePreviewTitle(e)||this._oLaunchPageService.getCatalogTileTitle(e)||this._oLaunchPageService.getTileTitle(e)||"",subtitle:this._oLaunchPageService.getCatalogTilePreviewSubtitle(e)||"",icon:this._oLaunchPageService.getCatalogTilePreviewIcon(e)||"sap-icon://business-objects-experience",info:this._oLaunchPageService.getCatalogTilePreviewInfo(e)||"",keywords:this._oLaunchPageService.getCatalogTileKeywords(e)||[],target:{type:"URL",url:this._oLaunchPageService.getCatalogTileTargetURL(e)},targetURL:this._oLaunchPageService.getCatalogTileTargetURL(e)};if(e.getChip){t._instantiationData={platform:"LAUNCHPAGE",launchPageTile:e}}else{t._instantiationData={platform:"CDM",vizType:{"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}}}return t};c.hasNoAdapter=true;return c},true);