// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_CommonDataModel/PersonalizationProcessor","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/ushell/services/_CommonDataModel/SiteConverter","sap/base/util/isEmptyObject","sap/base/util/deepClone","sap/base/util/deepExtend","sap/base/util/extend","sap/base/util/Version","sap/ushell/Config","sap/base/util/includes","sap/base/util/values","sap/ushell/library","sap/ushell/utils","sap/ushell/adapters/cdm/v3/_LaunchPage/readApplications","sap/base/Log","sap/ui/core/Manifest"],function(e,t,i,n,r,o,s,a,l,u,p,h,c,f,d,g,P,v){"use strict";var _=f.DisplayFormat;var y=f.ContentNodeType;var m="sap.ushell.services.CommonDataModel";var z={STATIC_LAUNCHER:"sap.ushell.StaticAppLauncher",DYNAMIC_LAUNCHER:"sap.ushell.DynamicAppLauncher",CARD:"sap.ushell.Card"};function b(t,n,o,s){this._oAdapter=t;this._oPersonalizationProcessor=new e;this._oSiteDeferred=new i.Deferred;this._oOriginalSite={};this._oPersonalizedSite={};this._oContentProviderIndex={};this._oSiteConverter=new r;this._oPersonalizationDeltas={};this._bLoadPersonalization=d.isFlpHomeIntent();this._oManifestCache={};this._oGetSitePromise=t.getSite().then(function(e){this._oOriginalSite=a({},e);if(this._bLoadPersonalization){this._loadAndApplyPersonalization(e)}return e}.bind(this)).fail(function(e){this._oSiteDeferred.reject(e);this._bLoadPersonalization=true}.bind(this))}b.prototype._loadAndApplyPersonalization=function(e){var t=new u(e._version);if(t.compareTo("3.1.0")<0){this._oAdapter.getPersonalization(t).then(function(t){if(t){this._oPersonalizationDeltas=s(t)}else{this._oPersonalizationDeltas={version:"3.0.0",_version:"3.0.0"}}this._triggerMixinPersonalisationInSite(e,t)}.bind(this)).fail(this._oSiteDeferred.reject)}else{this._oPersonalizedPages={};this._ensureStandardVizTypesPresent(this._oOriginalSite).then(function(e){this._oOriginalSite=e;this._oOriginalSite=this._ensureProperDisplayFormats(this._oOriginalSite);this._oSiteDeferred.resolve(this._oOriginalSite)}.bind(this))}};b.prototype._applyPagePersonalization=function(e,t){var i=e.identification.id;if(Object.keys(t).length){var n=t.classicHomePage;if(n&&n.version==="3.1.0"){Object.keys(n).forEach(function(e){if(!t[e]){t[e]=n[e]}});delete t.classicHomePage;t._version=t.version}var r=new u(t._version||t.version);if(r.compareTo("3.1.0")<0){t={classicHomePage:t,_version:"3.1.0",version:"3.1.0"}}}this._oPersonalizationDeltas=t;var o=s(t[i],20)||{};var a=this._oSiteConverter.convertTo("3.0.0",s(e,20));return this._triggerMixinPersonalisationInSite(a,o).then(function(e){this._oPersonalizedPages[i]=this._oSiteConverter.convertTo("3.1.0",s(e,20));return this._oPersonalizedPages[i]}.bind(this))};b.prototype._migratePersonalizedPages=function(e){if(typeof this._oAdapter.migratePersonalizedPages!=="function"){return Promise.resolve(e)}return this._oAdapter.migratePersonalizedPages(e).then(function(e){if(e.length===0){return null}return this.save(e)}.bind(this)).then(function(){return e})};b.prototype._triggerMixinPersonalisationInSite=function(e,t){return new Promise(function(i,n){this._oPersonalizationProcessor.mixinPersonalization(e,t).done(function(e){this._oPersonalizedSite=this._ensureCompleteSite(e);this._oPersonalizedSite=this._ensureGroupsOrder(this._oPersonalizedSite);this._ensureStandardVizTypesPresent(this._oPersonalizedSite).then(function(e){this._oPersonalizedSite=e;this._oPersonalizedSite=this._ensureProperDisplayFormats(this._oPersonalizedSite);this._oSiteDeferred.resolve(this._oPersonalizedSite);i(this._oPersonalizedSite)}.bind(this)).catch(n)}.bind(this)).fail(function(e){this._oSiteDeferred.reject(e);n()}.bind(this))}.bind(this))};b.prototype.getHomepageGroups=function(){var e=new i.Deferred;this.getSite().then(function(t){var i=t&&t.site&&t.site.payload&&t.site.payload.groupsOrder?t.site.payload.groupsOrder:[];e.resolve(i)});return e.promise()};b.prototype.getGroups=function(){var e=new i.Deferred;this.getSite().then(function(t){var i=[];Object.keys(t.groups).forEach(function(e){i.push(t.groups[e])});e.resolve(i)});return e.promise()};b.prototype.getGroup=function(e){var t=new i.Deferred;this.getSite().then(function(i){var n=i.groups[e];if(n){t.resolve(n)}else{t.reject("Group "+e+" not found")}});return t.promise()};b.prototype.getSite=function(){if(!this._bLoadPersonalization){this.getSiteWithoutPersonalization().then(this._loadAndApplyPersonalization.bind(this));this._bLoadPersonalization=true}return this._oSiteDeferred.promise()};b.prototype.getSiteWithoutPersonalization=function(){return this._oGetSitePromise};b.prototype.getPage=function(e){var t=p.last("/core/shell/enablePersonalization");var i=p.last("/core/spaces/myHome/enabled");var n=p.last("/core/spaces/myHome/myHomePageId");var r=p.last("/core/stableIDs/enabled");var o=p.last("/core/stableIDs/migratePersonalization");return Promise.resolve(this._oGetSitePromise).then(function(){if(this._oPersonalizedPages[e]){return this._oPersonalizedPages[e]}if(t||i&&e===n){return Promise.all([this._getPageFromAdapter(e),this._oAdapter.getPersonalization(this._oOriginalSite._version)]).catch(function(){return Promise.reject("CommonDataModel Service: Cannot get page "+e)}).then(function(e){return this._applyPagePersonalization(e[0],e[1]).catch(function(){return Promise.reject("Personalization Processor: Cannot mixin the personalization.")})}.bind(this)).then(function(e){if(r&&o){return this._migratePersonalizedPages([e]).then(function(e){return e[0]})}return e}.bind(this))}return this._getPageFromAdapter(e)}.bind(this))};b.prototype._getPageFromAdapter=function(e){if(!this._oAdapter.getPage){return Promise.resolve(s(this._oOriginalSite.pages[e],20))}return this._oAdapter.getPage(e).then(function(t){return Promise.all([this.getCachedVisualizations(),this.getCachedVizTypes()]).then(function(i){var n=i[0];var r=i[1];this._oOriginalSite.pages[e]=t;this._oOriginalSite.visualizations=n;this._oOriginalSite.vizTypes=r;return s(t,20)}.bind(this))}.bind(this))};b.prototype._filterForProperPages=function(e){return e.filter(function(e){return!!e})};b.prototype.getPages=function(e){var t=p.last("/core/shell/enablePersonalization");var i=p.last("/core/spaces/myHome/enabled");var n=p.last("/core/spaces/myHome/myHomePageId");var r=p.last("/core/stableIDs/enabled");var o=p.last("/core/stableIDs/migratePersonalization");return Promise.resolve(this._oGetSitePromise).then(function(){if(t||i){return Promise.all([this._getPagesFromAdapter(e),this._oAdapter.getPersonalization(this._oOriginalSite._version)]).catch(function(){return Promise.reject("CommonDataModel Service: Cannot get pages")}).then(function(e){var i=e[0];var s=e[1];return Promise.all(Object.keys(i).map(function(e){if(this._oPersonalizedPages[e]){return Promise.resolve(this._oPersonalizedPages[e])}if(!t&&e!==n){return Promise.resolve(i[e])}return this._applyPagePersonalization(i[e],s).catch(function(){return Promise.reject("Personalization Processor: Cannot mixin the personalization.")})}.bind(this))).then(function(e){if(r&&o){return this._migratePersonalizedPages(e)}return e}.bind(this)).then(function(e){return this._filterForProperPages(e)}.bind(this))}.bind(this))}return this._getPagesFromAdapter(e).then(function(e){return this._filterForProperPages(c(e))}.bind(this))}.bind(this))};b.prototype._getPagesFromAdapter=function(e){if(!this._oAdapter.getPages){var t={};for(var i in this._oOriginalSite.pages){if(h(e,this._oOriginalSite.pages[i].identification.id)){t[i]=this._oOriginalSite.pages[i]}}return Promise.resolve(s(t,20))}return this._oAdapter.getPages(e).then(function(e){return Promise.all([this.getCachedVisualizations(),this.getCachedVizTypes()]).then(function(t){var i=t[0];var n=t[1];this._oOriginalSite.visualizations=i;this._oOriginalSite.vizTypes=n;Object.keys(e).forEach(function(t){this._oOriginalSite.pages[t]=e[t]}.bind(this));return s(e,20)}.bind(this))}.bind(this))};b.prototype.getAllPages=function(e){if(e&&e.personalizedPages){return this._getAllPersonalizedPages()}return this._getAssignedPageIds().then(function(e){return this.getPages(e)}.bind(this))};b.prototype._getAssignedPageIds=function(){return sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getContentNodes()}).then(function(e){var t=[];e.forEach(function(e){this._collectPageIds(e,t)}.bind(this));return t}.bind(this))};b.prototype._collectPageIds=function(e,t){if(e.type===y.Page){if(t.indexOf(e.id)===-1){t.push(e.id)}}if(e.children!==undefined){e.children.forEach(function(e){this._collectPageIds(e,t)}.bind(this))}};b.prototype._getAllPersonalizedPages=function(){return Promise.resolve(this._oGetSitePromise).then(function(){return Promise.all([this._getAssignedPageIds(),new Promise(function(e,t){this._oAdapter.getPersonalization(this._oOriginalSite._version).done(e).catch(t)}.bind(this))])}.bind(this)).then(function(e){var t=e[0];var i=e[1];var n=[];Object.keys(i).forEach(function(e){if(e==="version"||e==="_version"){return}if(!t.includes(e)){return}var r=i[e];if(Object.keys(r).length>1){n.push(e)}});if(n.length>0){return this.getPages(n)}return[]}.bind(this))};b.prototype.getApplications=function(){return new Promise(function(e,t){this.getSite().then(function(i){var n=i.applications;if(n){e(n)}else{t("CDM applications not found.")}}).fail(t)}.bind(this))};b.prototype.getVizTypes=function(){if(typeof this._oAdapter.getVizTypes==="function"){return Promise.all([this._getSiteProperty("vizTypes"),this._oAdapter.getVizTypes()]).then(function(e){var t=e[0];var i=e[1];return l(t,i)})}return this.getCachedVizTypes()};b.prototype.getCachedVizTypes=function(){var e=Promise.resolve();if(typeof this._oAdapter.getCachedVizTypes==="function"){e=this._oAdapter.getCachedVizTypes()}return Promise.all([this._getSiteProperty("vizTypes"),e]).then(function(e){var t=e[0];var i=e[1];return l(t,i)})};b.prototype.getVizType=function(e){var t=Promise.resolve();if(typeof this._oAdapter.getVizType==="function"){t=this._oAdapter.getVizType(e)}return Promise.all([this._getSiteProperty("vizTypes"),t]).then(function(t){var i=t[0];var n=t[1];if(n){i[e]=n}return i[e]})};b.prototype.getVisualizations=function(){if(typeof this._oAdapter.getVisualizations==="function"){return Promise.all([this._getSiteProperty("visualizations"),this._oAdapter.getVisualizations()]).then(function(e){var t=e[0];var i=e[1];return l(t,i)})}return this.getCachedVisualizations()};b.prototype.getCachedVisualizations=function(){var e=Promise.resolve();if(typeof this._oAdapter.getCachedVisualizations==="function"){e=this._oAdapter.getCachedVisualizations()}return Promise.all([this._getSiteProperty("visualizations"),e]).then(function(e){var t=e[0];var i=e[1];return l(t,i)})};b.prototype._getSiteProperty=function(e){return new Promise(function(i,n){this.getSite().then(function(r){var o=t.get(e,r);if(o){i(o)}else{var s=e.toString();n("CDM "+s+" not found.")}}).fail(n)}.bind(this))};b.prototype.getGroupFromOriginalSite=function(e){var t=new i.Deferred;if(typeof e==="string"&&this._oOriginalSite&&this._oOriginalSite.groups&&this._oOriginalSite.groups[e]){t.resolve(a({},this._oOriginalSite.groups[e]))}else{t.reject("Group does not exist in original site.")}return t.promise()};b.prototype.getOriginalPage=function(e){return s(this._oOriginalSite.pages[e],20)};b.prototype.save=function(e){var t=new i.Deferred;if(this._oOriginalSite._version==="3.1.0"){if(!e){return t.reject("No page id was provided").promise()}if(typeof e==="string"){e=[e]}this._saveCdmVersion31(e).then(t.resolve).catch(t.reject)}else{this._saveCdmVersion30().then(t.resolve).catch(t.reject)}return t.promise()};b.prototype._saveCdmVersion30=function(){var e=this._oOriginalSite;var t=this._oPersonalizedSite;return new Promise(function(i,n){this._oPersonalizationProcessor.extractPersonalization(s(t,20),s(e,20)).done(i).fail(n)}.bind(this)).catch(function(){return Promise.reject("Personalization Processor: Cannot extract personalization.")}).then(function(e){if(!o(e)){if(this._oPersonalizationDeltas.version===undefined||this._oPersonalizationDeltas._version===undefined){this._oPersonalizationDeltas.version=this._oOriginalSite._version;this._oPersonalizationDeltas._version=this._oOriginalSite._version}this._oPersonalizationDeltas=e;return this._setPersonalization(this._oPersonalizationDeltas)}return Promise.resolve()}.bind(this))};b.prototype._saveCdmVersion31=function(e){var t=e.map(function(e){var t=this._oSiteConverter.convertTo("3.0.0",this._oOriginalSite.pages[e]);var i=this._oSiteConverter.convertTo("3.0.0",this._oPersonalizedPages[e]);return new Promise(function(n,r){this._oPersonalizationProcessor.extractPersonalization(s(i,20),s(t,20)).done(function(t){n({pageId:e,personalization:t})}).fail(function(t){P.error("Cannot extract personalization of page "+e+": "+t,null,m);n()})}.bind(this))}.bind(this));return Promise.all(t).then(function(e){var t=false;e.forEach(function(e){if(!e){return}if(!o(e.personalization)){t=true;if(this._oPersonalizationDeltas.version===undefined||this._oPersonalizationDeltas._version===undefined){this._oPersonalizationDeltas.version=this._oOriginalSite._version;this._oPersonalizationDeltas._version=this._oOriginalSite._version}this._oPersonalizationDeltas[e.pageId]=e.personalization}}.bind(this));if(t){return this._setPersonalization(this._oPersonalizationDeltas)}return Promise.resolve()}.bind(this))};b.prototype._setPersonalization=function(e,t){if(this._oPendingPersonalizationDeferred){if(!this._oNextPersonalizationQuery){this._oNextPersonalizationQuery={fnNextCall:null,aPromiseResolvers:[]}}return new Promise(function(i,n){this._oNextPersonalizationQuery.fnNextCall=this._setPersonalization.bind(this,e,t);this._oNextPersonalizationQuery.aPromiseResolvers.push({resolve:i,reject:n})}.bind(this))}this._oPendingPersonalizationDeferred=this._oAdapter.setPersonalization(e,t);return new Promise(function(e,t){this._oPendingPersonalizationDeferred.then(e).fail(t).always(function(){delete this._oPendingPersonalizationDeferred;if(this._oNextPersonalizationQuery){var e=this._oNextPersonalizationQuery.fnNextCall();this._cleanupPersonalizationQueuePromises(e,this._oNextPersonalizationQuery.aPromiseResolvers);delete this._oNextPersonalizationQuery}}.bind(this))}.bind(this))};b.prototype._cleanupPersonalizationQueuePromises=function(e,t){t.forEach(function(t){e.then(t.resolve).catch(t.reject)})};b.prototype.registerContentProvider=function(){P.error("CommonDataModel.registerContentProvider is obsolete and should not be used.")};b.prototype._ensureCompleteSite=function(e){if(e.groups){var t=e.groups;Object.keys(t).forEach(function(e){if(!t[e]){delete t[e]}else{if(!t[e].payload){t[e].payload={}}if(!t[e].payload.links){t[e].payload.links=[]}if(!t[e].payload.tiles){t[e].payload.tiles=[]}if(!t[e].payload.groups){t[e].payload.groups=[]}}})}return e};b.prototype._ensureGroupsOrder=function(e){var i=t.get("site.payload.groupsOrder",e);var n=e.groups;var r=0;if(!i){return e}while(r<i.length){var o=i[r];if(!n[o]){i.splice(r,1)}else{r++}}return e};b.prototype.getPlugins=function(){var e=function(e,i){var n=Object.keys(i).length;if(n===0){return{}}if(!i.hasOwnProperty("Shell-plugin")){P.error("Cannot find inbound with id 'Shell-plugin' for plugin '"+e+"'","plugin startup configuration cannot be determined correctly",m);return{}}if(n>1){P.warning("Multiple inbounds are defined for plugin '"+e+"'","plugin startup configuration will be determined using "+"the signature of 'Shell-plugin' inbound.",m)}var r=t.get("signature.parameters",i["Shell-plugin"])||{};return Object.keys(r).reduce(function(e,i){var n=t.get(i+".defaultValue.value",r);if(typeof n==="string"){e[i]=n}return e},{})};var r=function(e){Object.keys(e).filter(function(t){return typeof e[t]==="object"}).forEach(function(t){e[t]=r(e[t])});return Object.freeze(e)};var o;return function(s){if(s!==undefined){o=s}if(o){return i.when(o)}o={};return this.getSiteWithoutPersonalization().then(function(i){var s=i.applications||{};Object.keys(s).filter(function(e){return t.get("type",this[e]["sap.flp"])==="plugin"},s).forEach(function(i){var r;var s=this[i];var a={};if(!n(s["sap.platform.runtime"])){P.error("Cannot find 'sap.platform.runtime' section for plugin '"+i+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel")}else if(!n(s["sap.platform.runtime"].componentProperties)){P.error("Cannot find 'sap.platform.runtime/componentProperties' "+"section for plugin '"+i+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel")}else{a=s["sap.platform.runtime"].componentProperties}o[i]={url:a.url,component:s["sap.ui5"].componentName};var u=t.get("crossNavigation.inbounds",s["sap.app"])||{};r=e(i,u);var p=l(a.config||{},r);if(p){o[i].config=p}if(a.asyncHints){o[i].asyncHints=a.asyncHints}var h=t.get("deviceTypes",s["sap.ui"]);if(h){o[i].deviceTypes=h}},s);return r(o)},function(e){return e})}}();b.prototype._mapDisplayFormats=function(e){var t={tile:_.Standard,standard:_.Standard,link:_.Compact,compact:_.Compact,flat:_.Flat,flatWide:_.FlatWide,tileWide:_.StandardWide,standardWide:_.StandardWide};var i=Object.keys(t).filter(function(t){return e.indexOf(t)>-1});return i.map(function(e){return t[e]})};b.prototype._ensureProperDisplayFormats=function(e){if(e.vizTypes){Object.keys(e.vizTypes).forEach(function(i){if(e.vizTypes[i]["sap.flp"]&&e.vizTypes[i]["sap.flp"].vizOptions){var n=e.vizTypes[i];var r=t.get("vizOptions.displayFormats.supported",n["sap.flp"]);var o=t.get("vizOptions.displayFormats.default",n["sap.flp"]);if(r){e.vizTypes[i]["sap.flp"].vizOptions.displayFormats.supported=this._mapDisplayFormats(r)}if(o){e.vizTypes[i]["sap.flp"].vizOptions.displayFormats.default=this._mapDisplayFormats([o])[0]}}}.bind(this))}if(e.hasOwnProperty("pages")){Object.keys(e.pages).forEach(function(t){var i=e.pages[t];if(i.payload&&i.payload.sections){var n=i.payload.sections;Object.keys(n).forEach(function(e){var t=n[e];Object.keys(t.viz).forEach(function(e){var i=t.viz[e];if(i.displayFormatHint){var n=this._mapDisplayFormats([i.displayFormatHint])[0];i.displayFormatHint=n||i.displayFormatHint}}.bind(this))}.bind(this))}}.bind(this))}else if(e.hasOwnProperty("groups")){Object.keys(e.groups).forEach(function(t){var i=e.groups[t];i.payload.tiles.forEach(function(e){if(e.displayFormatHint){var t=this._mapDisplayFormats([e.displayFormatHint])[0];e.displayFormatHint=t||e.displayFormatHint}}.bind(this))}.bind(this))}return e};b.prototype._ensureStandardVizTypesPresent=function(e){if(!(e._version&&e._version.startsWith("3."))){return Promise.resolve(e)}if(!e.vizTypes){e.vizTypes={}}var t=[];var i={};i[z.STATIC_LAUNCHER]="sap/ushell/components/tiles/cdm/applauncher/manifest.json";i[z.DYNAMIC_LAUNCHER]="sap/ushell/components/tiles/cdm/applauncherdynamic/manifest.json";i[z.CARD]="sap/ushell/services/_CommonDataModel/vizTypeDefaults/cardManifest.json";Object.keys(i).forEach(function(n){if(!e.vizTypes[n]){var r=i[n];var o=this._loadManifest(r).then(function(t){e.vizTypes[n]=t});t.push(o)}}.bind(this));if(t.length===0){return Promise.resolve(e)}return Promise.all(t).then(function(){return e})};b.prototype._loadManifest=function(e){if(!this._oManifestCache[e]){var t=sap.ui.require.toUrl(e);this._oManifestCache[e]=v.load({manifestUrl:t,async:true}).then(function(e){return e.getRawJson()})}return this._oManifestCache[e].then(function(e){return s(e)})};b.prototype.getMenuEntries=function(e){return new Promise(function(i,n){this.getSite().then(function(n){var r=t.get("menus."+e+".payload.menuEntries",n);i(s(r)||[])})}.bind(this))};b.prototype.getContentProviderIds=function(){return new Promise(function(e,t){this.getSite().then(function(t){var i=Object.keys(t.systemAliases);var n={};c(t.applications).forEach(function(e){var t=g.getContentProviderId(e);if(h(i,t)){n[t]=true}});e(Object.keys(n))})}.bind(this))};b.hasNoAdapter=false;return b},true);