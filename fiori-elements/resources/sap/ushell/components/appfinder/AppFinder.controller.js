// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/extend","sap/ui/core/Core","sap/ui/core/mvc/View","sap/ui/core/mvc/Controller","sap/ui/core/Component","sap/ushell/ui5service/ShellUIService","sap/ushell/EventHub","sap/ushell/components/CatalogsManager","sap/ushell/components/appfinder/VisualizationOrganizerHelper","sap/ui/core/routing/HashChanger","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ui/thirdparty/hasher"],function(e,t,s,n,i,o,r,a,l,u,h,p,c,d){"use strict";return n.extend("sap.ushell.components.appfinder.AppFinder",{onInit:function(){var e=i.getOwnerComponentFor(this.getView());this.oRouter=e.getRouter();var t=this.getView();var n=e.getModel();t.setModel(n);this.bEnableEasyAccessSAPMenu=n.getProperty("/enableEasyAccessSAPMenu");this.bEnableEasyAccessUserMenu=n.getProperty("/enableEasyAccessUserMenu");this.bEnableEasyAccesOnTablet=n.getProperty("/enableEasyAccessOnTablet");var o=this.bEnableEasyAccessSAPMenu||this.bEnableEasyAccessUserMenu;var r=!c.system.phone&&!c.system.tablet||c.system.tablet&&this.bEnableEasyAccesOnTablet||c.system.combi;this.bShowEasyAccessMenu=o&&r;sap.ushell.Container.getRenderer("fiori2").createExtendedShellState("appFinderExtendedShellState",function(){sap.ushell.Container.getRenderer("fiori2").showHeaderItem("backBtn",true)});this.oCatalogsManager=new a("catalogsMgr",{model:n});this.oVisualizationOrganizerHelper=l.getInstance();this.getView().setModel(this._getSubHeaderModel(),"subHeaderModel");this.oConfig=e.getComponentData().config;this.pCatalogView=s.create({id:"catalogView",viewName:"module:sap/ushell/components/appfinder/CatalogView",height:"100%",viewData:{parentComponent:e,subHeaderModel:this._getSubHeaderModel()}});this.oInitPromise=this.pCatalogView.then(function(e){e.addStyleClass("sapUiGlobalBackgroundColor sapUiGlobalBackgroundColorForce");return this.oVisualizationOrganizerHelper.loadAndUpdate()}.bind(this));this.oRouter.attachRouteMatched(this._handleAppFinderNavigation.bind(this));t.createSubHeader();c.resize.attachHandler(this._resizeHandler.bind(this));this.oRouter.oHashChanger=u.getInstance()},onExit:function(){this.pCatalogView.then(function(e){e.destroy()})},_resizeHandler:function(){var e=this._showOpenCloseSplitAppButton();var t=this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonVisible");if(e!==t){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",e);if(e){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)}}this._toggleViewWithToggleButtonClass(e)},_handleAppFinderNavigation:function(s){var n=e({},s);if(this.firstView!==false){if(!this.bShowEasyAccessMenu){this.pCatalogView.then(function(e){this.getView().oPage.addContent(e);setTimeout(function(){h("#catalogSelect").focus()},0)}.bind(this))}this.firstView=false}this.pCatalogView.then(function(e){e.getController().customRouteMatched(n)});var i=this.getView();this._preloadAppHandler();this._getPathAndHandleGroupContext(s);this._toggleViewWithToggleButtonClass(this._showOpenCloseSplitAppButton());if(this.bShowEasyAccessMenu){this.onShow(s)}else if(i._showSearch("catalog")){i.updateSubHeader("catalog",false);this._toggleViewWithSearchAndTagsClasses("catalog")}t.getEventBus().publish("showCatalog");r.emit("CenterViewPointContentRendered","appFinder");r.emit("showCatalog",{sId:"showCatalog",oData:Date.now()});t.getEventBus().publish("launchpad","contentRendered")},_showOpenCloseSplitAppButton:function(){return!c.orientation.landscape||c.system.phone||this.oView.getModel().getProperty("/isPhoneWidth")},_resetSubHeaderModel:function(){this.oSubHeaderModel.setProperty("/activeMenu",null);this.oSubHeaderModel.setProperty("/search",{searchMode:false,searchTerm:null});this.oSubHeaderModel.setProperty("/tag",{tagMode:false,selectedTags:[]});this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",this._showOpenCloseSplitAppButton());this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)},_getSubHeaderModel:function(){if(this.oSubHeaderModel){return this.oSubHeaderModel}this.oSubHeaderModel=new p;this._resetSubHeaderModel();return this.oSubHeaderModel},onTagsFilter:function(e){var t=e.getSource(),s=t.getModel("subHeaderModel"),n=e.getSource().getSelectedItems(),i=n.length>0,o={tagMode:i,selectedTags:[]};n.forEach(function(e){o.selectedTags.push(e.getText())});s.setProperty("/activeMenu",this.getCurrentMenuName());s.setProperty("/tag",o);this.pCatalogView.then(function(e){e.getController().onTag(o)})},searchHandler:function(e){var t=a.prototype.getInstance();t.loadCustomTilesKeyWords();var s=e.getSource().getValue(),n=false;if(s===null){return}var i=this.oSubHeaderModel.getProperty("/search");var o=this.oSubHeaderModel.getProperty("/activeMenu");if(this.getCurrentMenuName()!==o){o=this.getCurrentMenuName()}if(!i.searchMode&&!e.getParameter("clearButtonPressed")){i.searchMode=true}if(i.searchMode&&c.system.phone){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)}if(s!==i.searchTerm){if(this.containsOnlyWhitepaces(s)){s="*"}i.searchTerm=s;n=true}this.oSubHeaderModel.setProperty("/search",i);this.oSubHeaderModel.setProperty("/activeMenu",o);this.oSubHeaderModel.refresh(true);if(n){this.pCatalogView.then(function(e){e.getController().onSearch(i)})}},_preloadAppHandler:function(){setTimeout(function(){var e=d.getHash()||"";if(!e.startsWith("Shell-appfinder")){return}if(sap.ushell.Container){sap.ushell.Container.getRenderer("fiori2").applyExtendedShellState("appFinderExtendedShellState")}this._updateShellHeader(this.oView.oPage.getTitle())}.bind(this),0)},getCurrentMenuName:function(){return this.currentMenu},_navigateTo:function(e){var t=this.oVisualizationOrganizerHelper.getNavigationContextAsText.apply(this);if(t){this.oRouter.navTo(e,{filters:t},true)}else{this.oRouter.navTo(e,{},true)}},_filterSystemModelsOnTablet:function(e){var t=new h.Deferred;if(this.bEnableEasyAccesOnTablet){sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(s){var n=e.reduce(function(e,t){var n;n=s.isNavigationSupported([{target:{semanticObject:"Shell",action:"startWDA"},params:{"sap-system":t.systemId,"sap-ui2-wd-app-id":"."}},{target:{semanticObject:"Shell",action:"startGUI"},params:{"sap-system":t.systemId,"sap-ui2-tcode":"."}}]);e.push(new Promise(function(e,s){n.then(function(s){var n={system:t,isSupported:false};if(s[0].supported||s[1].supported){n.isSupported=true}e(n)}).fail(function(){e({system:t,isSupported:false})})}));return e},[]);Promise.all(n).then(function(e){var s;s=e.reduce(function(e,t){if(t.isSupported){e.push(t.system)}return e},[]);t.resolve(s)})})}else{t.resolve(e)}return t.promise()},getGroupNavigationContext:function(){var e=this.oView.getModel().getProperty("/groupContext");var t=e?e.path:null;if(t){return JSON.stringify({targetGroup:encodeURIComponent(t)})}return null},getSystemsModels:function(){var e=this;if(this.getSystemsPromise){return this.getSystemsPromise}var t=new h.Deferred;this.getSystemsPromise=t.promise();var s=["userMenu","sapMenu"].map(function(t){var s=new p;s.setProperty("/systemSelected",null);s.setProperty("/systemsList",[]);return e.getSystems(t).then(e._filterSystemModelsOnTablet.bind(e)).then(function(e){s.setProperty("/systemsList",e);return s})});h.when.apply(h,s).then(function(e,s){t.resolve(e,s)});return this.getSystemsPromise},onSegmentButtonClick:function(e){this.oSubHeaderModel.setProperty("/search/searchMode",false);this.oSubHeaderModel.setProperty("/search/searchTerm","");var t=e.getParameter("id");this._navigateTo(t)},onShow:function(e){var t=e.getParameter("name");if(t===this.getCurrentMenuName()){return}var n=this.getView();n._updateSearchWithPlaceHolder(t);this._updateCurrentMenuName(t);this.getSystemsModels().then(function(e,t){var o=t.getProperty("/systemsList");var r=e.getProperty("/systemsList");n.oPage.removeAllContent();var a=this.currentMenu==="sapMenu"?o:r;if(a&&a.length){n.updateSubHeader(this.currentMenu,true)}else if(n._showSearch(this.currentMenu)){n.updateSubHeader(this.currentMenu,false)}if(this.currentMenu==="catalog"){this.pCatalogView.then(function(e){n.oPage.addContent(e)})}else if(this.currentMenu==="userMenu"){if(!this.pUserMenuView){this.pUserMenuView=s.create({id:"userMenuView",viewName:"module:sap/ushell/components/appfinder/EasyAccessView",height:"100%",viewData:{menuName:"USER_MENU",easyAccessSystemsModel:e,parentComponent:i.getOwnerComponentFor(this.getView()),subHeaderModel:this._getSubHeaderModel(),enableSearch:this.getView()._showSearch("userMenu")}})}this.pUserMenuView.then(function(e){n.oPage.addContent(e)})}else if(this.currentMenu==="sapMenu"){if(!this.pSapMenuView){this.pSapMenuView=s.create({id:"sapMenuView",viewName:"module:sap/ushell/components/appfinder/EasyAccessView",height:"100%",viewData:{menuName:"SAP_MENU",easyAccessSystemsModel:t,parentComponent:i.getOwnerComponentFor(this.getView()),subHeaderModel:this._getSubHeaderModel(),enableSearch:this.getView()._showSearch("sapMenu")}})}this.pSapMenuView.then(function(e){n.oPage.addContent(e)})}this._setFocusToSegmentedButton(a);this.oSubHeaderModel.setProperty("/activeMenu",this.currentMenu);if(this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonVisible")){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)}this.oSubHeaderModel.refresh(true)}.bind(this))},_updateCurrentMenuName:function(e){if(!this.bShowEasyAccessMenu||e==="sapMenu"&&!this.bEnableEasyAccessSAPMenu||e==="userMenu"&&!this.bEnableEasyAccessUserMenu){this.currentMenu="catalog"}else{this.currentMenu=e}this._toggleViewWithSearchAndTagsClasses(e)},_toggleViewWithSearchAndTagsClasses:function(e){var t=this.getView();if(t._showSearch(e)){t.oPage.addStyleClass("sapUshellAppFinderSearch")}else{t.oPage.removeStyleClass("sapUshellAppFinderSearch")}if(t._showSearchTag(e)){t.oPage.addStyleClass("sapUshellAppFinderTags")}else{t.oPage.removeStyleClass("sapUshellAppFinderTags")}},_toggleViewWithToggleButtonClass:function(e){var t=this.getView();if(e){t.oPage.addStyleClass("sapUshellAppFinderToggleButton")}else{t.oPage.removeStyleClass("sapUshellAppFinderToggleButton")}},_setFocusToSegmentedButton:function(e){var t=this.getView();if(e&&e.length){var s=t.segmentedButton.getSelectedButton();setTimeout(function(){h("#"+s).focus()},0)}else{setTimeout(function(){h("#catalogSelect").focus()},0)}},_getPathAndHandleGroupContext:function(e){var t=e.getParameter("arguments");var s=t.filters;var n;try{n=JSON.parse(s)}catch(e){n=s}this.oVisualizationOrganizerHelper.updateModelWithContext.apply(this,[n])},_updateModelWithGroupContext:function(e){var t=this.oView.getModel(),s=e&&decodeURIComponent(e.targetGroup)||"";var n=t.getProperty(s),i;s=s==="undefined"?undefined:s;i={path:s,id:"",title:n&&n.title};if(s&&s!==""){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){var o=function(){var r=t.getProperty("/groups");if(r.length){n=t.getProperty(s);i.id=e.getGroupId(n.object);i.title=n.title||e.getGroupTitle(n.object);return}setTimeout(o,100)};o()})}t.setProperty("/groupContext",i)},getSystems:function(e){var t=new h.Deferred;sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(s){s.getEasyAccessSystems(e).done(function(e){var s=[];var n=Object.keys(e);for(var i=0;i<n.length;i++){var o=n[i];s[i]={systemName:e[o].text,systemId:o}}t.resolve(s)}).fail(function(e){t.reject("An error occurred while retrieving the systems: "+e)})}).catch(function(){t.reject("cannot get ClientSideTargetResolution service")});return t.promise()},_initializeShellUIService:function(){this.oShellUIService=new o({scopeObject:this.getOwnerComponent(),scopeType:"component"})},_updateShellHeader:function(e){if(!this.oShellUIService){this._initializeShellUIService()}this.oShellUIService.setTitle(e);this.oShellUIService.setHierarchy()},containsOnlyWhitepaces:function(e){if(!e||e===""){return false}return!e.replace(/\s/g,"").length}})});