// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Core","sap/ushell/ui/launchpad/TileState","sap/ushell/EventHub","sap/ushell/utils","sap/ushell/components/DestroyHelper","sap/ushell/components/GroupsHelper","sap/ushell/components/MessagingHelper","sap/ushell/components/HomepageManager","sap/ushell/resources","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement","sap/base/Log","sap/ushell/Config"],function(e,t,a,o,i,r,s,n,l,g,u,c,h,d){"use strict";var p;var v=e.extend("sap.ushell.components.CatalogsManager",{metadata:{publicMethods:["createGroup","createGroupAndSaveTile","createTile","deleteCatalogTileFromGroup","notifyOnActionFailure","resetAssociationOnFailure"]},analyticsConstants:{PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"},_aDoables:[],constructor:function(e,t){this.oLaunchPageServicePromise=sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this.oLaunchPageService=e}.bind(this));this.oTileCatalogToGroupsMap={};this.tagsPool=[];this.iInitialLoad=100;this.oModel=t.model;var a={model:this.oModel};this.oHomepageManager=l.prototype.getInstance();if(!this.oHomepageManager){this.oHomepageManager=new l("dashboardMgr",a)}p=this.getInterface();this.registerEvents()},registerEvents:function(){var e=t.getEventBus();e.subscribe("renderCatalog",this.loadAllCatalogs,this);this._aDoables=[o.on("showCatalog").do(this.updateTilesAssociation.bind(this)),o.on("updateGroups").do(this.updateTilesAssociation.bind(this))]},unregisterEvents:function(){var e=t.getEventBus();e.unsubscribe("renderCatalog",this.loadAllCatalogs,this);this._aDoables.forEach(function(e){e.off()});this._aDoables=[]},getModel:function(){return this.oModel},loadAllCatalogs:function(){var e=new u.Deferred;var t=this;e.resolve();var a=function(){e.done(function(){var e=t.getModel().getProperty("/groups");if(e&&e.length!==0){t.updateTilesAssociation()}})};if(!this.oModel.getProperty("/catalogs")){if(!this.oModel.getProperty("/groups")||this.oModel.getProperty("/groups").length===0){if(!d.last("/core/spaces/enabled")){e=this.oHomepageManager.loadPersonalizedGroups()}}r.destroyFLPAggregationModels(this.oModel.getProperty("/catalogs"));r.destroyTileModels(this.oModel.getProperty("/catalogTiles"));this.oModel.setProperty("/catalogs",[]);this.oModel.setProperty("/catalogSearchEntity",{appBoxes:[],customTiles:[]});this.aPromises=[];c.start("FLP:DashboardManager.GetCatalogsRequest","GetCatalogsRequest","FLP");c.start("FLP:DashboardManager.getCatalogTiles","getCatalogTiles","FLP");c.pause("FLP:DashboardManager.getCatalogTiles");c.start("FLP:DashboardManager.BuildCatalogModelWithRendering","BuildCatalogModelWithRendering","FLP");c.pause("FLP:DashboardManager.BuildCatalogModelWithRendering");sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){e.getCatalogs().done(function(e){var t=e.slice(0,this.iInitialLoad);c.end("FLP:DashboardManager.GetCatalogsRequest");this.aPromises=t.map(this.addCatalogToModel.bind(this));Promise.all(this.aPromises).then(this.processPendingCatalogs.bind(this)).then(function(){this.aPromises=e.slice(this.iInitialLoad).map(this.addCatalogToModel.bind(this));Promise.all(this.aPromises).then(this.processPendingCatalogs.bind(this))}.bind(this)).then(this.onDoneLoadingCatalogs.bind(this,e)).then(a)}.bind(this)).fail(n.showLocalizedErrorHelper("fail_to_load_catalog_msg"))}.bind(this))}else{a()}},updateTilesAssociation:function(){this.mapCatalogTilesToGroups();this.updateCatalogTilesToGroupsMap()},mapCatalogTilesToGroups:function(){var e=this;this.oTileCatalogToGroupsMap={};var t=this.oModel.getProperty("/groups");t.forEach(function(t){["tiles","links"].forEach(function(a){var o=t[a];if(o){for(var i=0;i<o.length;++i){var r=encodeURIComponent(e.oLaunchPageService.getCatalogTileId(o[i].object));var s=e.oTileCatalogToGroupsMap[r]||[];var n=e.oLaunchPageService.getGroupId(t.object);if(s.indexOf(n)===-1&&(typeof t.isGroupVisible==="undefined"||t.isGroupVisible)&&!t.isGroupLocked){s.push(n)}e.oTileCatalogToGroupsMap[r]=s}}})})},updateCatalogTilesToGroupsMap:function(){var e;var t;var a;var o=this.getModel().getProperty("/catalogs");if(o){for(var i=0;i<o.length;i++){var r=o[i].appBoxes;if(r){for(var s=0;s<r.length;s++){var n=r[s];e=encodeURIComponent(this.oLaunchPageService.getCatalogTileId(n.src));a=this.oTileCatalogToGroupsMap[e];t=a||[];n.associatedGroups=t}}var l=o[i].customTiles;if(l){for(var g=0;g<l.length;g++){var u=l[g];e=encodeURIComponent(this.oLaunchPageService.getCatalogTileId(u.src));a=this.oTileCatalogToGroupsMap[e];t=a||[];u.associatedGroups=t}}}}this.getModel().setProperty("/catalogs",o)},addCatalogToModel:function(e){var t={title:this.oLaunchPageService.getCatalogTitle(e),id:this.oLaunchPageService.getCatalogId(e),numberTilesSupportedOnCurrectDevice:0,static:false,customTiles:[],appBoxes:[]};c.resume("FLP:DashboardManager.getCatalogTiles");return new Promise(function(a,o){this.oLaunchPageService.getCatalogTiles(e).done(function(e){c.pause("FLP:DashboardManager.getCatalogTiles");a({oCatalogEntry:e,oCatalogModel:t})}).fail(function(e){n.showLocalizedErrorHelper("fail_to_load_catalog_tiles_msg");o(e)})}.bind(this))},getTagList:function(e){var t={};var a=[];if(this.oModel.getProperty("/tagList")&&this.oModel.getProperty("/tagList").length>0){this.tagsPool.concat(this.oModel.getProperty("/tagList"))}for(var o=0;o<this.tagsPool.length;o++){var i=this.tagsPool[o];if(t[i]){t[i]++}else{t[i]=1}}for(var r in t){a.push({tag:r,occ:t[r]})}var s=a.sort(function(e,t){return t.occ-e.occ});if(e){this.oModel.setProperty("/tagList",s.slice(0,e))}else{this.oModel.setProperty("/tagList",s)}},processPendingCatalogs:function(e){var a=this.oModel.getProperty("/catalogs");var o=t.getEventBus();var r=this.oModel.getProperty("/masterCatalogs")||[{title:n.getLocalizedText("all")}];c.end("FLP:DashboardManager.getCatalogTiles");c.resume("FLP:DashboardManager.BuildCatalogModelWithRendering");var s=e.reduce(function(e,t){return e.then(function(){var e;var o;var i=t.oCatalogEntry;var s=t.oCatalogModel;var n=this.searchModelCatalogByTitle(s.title);if(n.result){o=this.oModel.getProperty("/catalogs")[n.indexOfPreviousInstanceInModel];e=false}else{e=true;o=s}var l=i.map(function(e){return this._processCatalogObjectForModel(o,e)}.bind(this));return Promise.all(l).then(function(){if(o.appBoxes.length>0||o.customTiles.length>0){if(e){a.push(s);r.push({title:s.title})}}if(this.oModel.getProperty("/enableCatalogTagFilter")===true){this.getTagList()}}.bind(this))}.bind(this))}.bind(this),Promise.resolve());return s.then(function(){this.oModel.setProperty("/masterCatalogs",r);this.oModel.setProperty("/catalogs",a);o.publish("launchpad","afterCatalogSegment");setTimeout(function(){i.setPerformanceMark("FLP-TTI-AppFinder",{bUseUniqueMark:true})},0);c.pause("FLP:DashboardManager.BuildCatalogModelWithRendering")}.bind(this))},_processCatalogObjectForModel:function(e,t){var a;if(this._getIsIntentSupported(t)){if(this._getIsAppBox(t)){a=this.createCatalogAppBoxes(t,true);e.appBoxes.push(a);return Promise.resolve()}return this.createCatalogTiles(t).then(function(t){e.customTiles.push(t);if(!this.aFnToGetTileView){this.aFnToGetTileView=[]}}.bind(this))}return Promise.resolve()},loadCustomTilesKeyWords:function(){var e;if(this.aFnToGetTileView){while(this.aFnToGetTileView.length>0){e=this.aFnToGetTileView.pop();e()}}},searchModelCatalogByTitle:function(e){var t=this.oModel.getProperty("/catalogs");var a=false;var o;var i=0;var r=false;var s;for(var n=0;n<t.length;++n){s=t[n];if(s.title===g.i18n.getText("catalogsLoading")){r=true}else if(e===s.title){o=n;i=s.numberOfTiles;a=true;break}}return{result:a,indexOfPreviousInstanceInModel:o,indexOfPreviousInstanceInPage:r?o-1:o,numOfTilesInCatalog:i}},_getCatalogTileId:function(e){var t;var a=d.last("/core/stableIDs/enabled");var o=d.last("/core/spaces/enabled");if(a&&o){t=this.oLaunchPageService.getStableCatalogTileId(e)}if(!t){t=this.oLaunchPageService.getCatalogTileId(e)}return t},createCatalogAppBoxes:function(e,t){var a=encodeURIComponent(this._getCatalogTileId(e));var o=this.oTileCatalogToGroupsMap[a]||[];var i=this.oLaunchPageService.getCatalogTileTags(e)||[];if(i.length>0){this.tagsPool=this.tagsPool.concat(i)}var r;if(e.tileResolutionResult){r=e.tileResolutionResult.navigationMode}return{id:a,associatedGroups:o,src:e,title:this.oLaunchPageService.getCatalogTilePreviewTitle(e),subtitle:this.oLaunchPageService.getCatalogTilePreviewSubtitle(e),icon:this.oLaunchPageService.getCatalogTilePreviewIcon(e),keywords:t?(this.oLaunchPageService.getCatalogTileKeywords(e)||[]).join(","):[],tags:i,navigationMode:r,url:this.oLaunchPageService.getCatalogTileTargetURL(e)}},onDoneLoadingCatalogs:function(e){var a=e.map(function(e){return new Promise(function(t,a){this.oLaunchPageService.getCatalogTiles(e).done(t).fail(a)}.bind(this))}.bind(this));Promise.all(a).then(function(t){var a=true;for(var o=0;o<t.length;o++){if(t[o].length!==0){a=false;break}}if(a||!e.length){this.oModel.setProperty("/catalogsNoDataText",g.i18n.getText("noCatalogs"))}}.bind(this));var o=t.getEventBus();o.publish("launchpad","catalogContentLoaded");var r=e.filter(function(e){var t=this.oLaunchPageService.getCatalogError(e);if(t){h.error("A catalog could not be loaded",t,"sap.ushell.components.CatalogsManager")}return!t}.bind(this));if(r.length!==e.length){n.showLocalizedError("partialCatalogFail")}i.handleTilesVisibility()},createCatalogTiles:function(e){var t=Promise.resolve();var o=e.getChip&&e.getChip().getBaseChipId&&e.getChip().getBaseChipId();if(o&&["X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER","X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER"].indexOf(o)===-1){t=new Promise(function(t,a){this.oLaunchPageService.getCatalogTileViewControl(e).done(t).fail(a)}.bind(this))}return t.then(function(t){var o=encodeURIComponent(this._getCatalogTileId(e));var i=this.oTileCatalogToGroupsMap[o]||[];var r=this.oLaunchPageService.getCatalogTileTags(e)||[];if(r.length>0){this.tagsPool=this.tagsPool.concat(r)}if(!t){t=new a({state:"Loading"})}var s=this.oLaunchPageService.getCatalogTilePreviewTitle(e);if(!s){s=this.oLaunchPageService.getCatalogTileTitle(e)}return{associatedGroups:i,src:e,catalog:e.title,catalogId:e.id,title:s,tags:r,keywords:(this.oLaunchPageService.getCatalogTileKeywords(e)||[]).join(","),id:o,size:this.oLaunchPageService.getCatalogTileSize(e),content:[t],isTileIntentSupported:this.oLaunchPageService.isTileIntentSupported(e),tileType:e.tileType}}.bind(this))},createGroupAndSaveTile:function(e){var a=e.catalogTileContext;var o=e.newGroupName;var r=new u.Deferred;if(i.validHash(o)&&a){this.createGroup(o).then(function(e){var o=this.oHomepageManager.getDashboardView();if(o&&o.getModel().getProperty("/tileActionModeActive")){t.getEventBus().publish("launchpad","AddTileContainerContent")}var i={};this.createTile({catalogTileContext:a,groupContext:e}).done(function(e){i={group:e.group,status:1,action:"addTileToNewGroup"};r.resolve(i)}).fail(function(e){i={group:e.group,status:0,action:"addTileToNewGroup"};r.resolve(i)})}.bind(this))}return r.promise()},createGroup:function(e){var t=this;var a=new u.Deferred;if(!i.validHash(e)){return a.reject({status:0,action:"createNewGroup"})}var o=this.oLaunchPageService.addGroup(e);o.done(function(e){var o=t.oHomepageManager.addGroupToModel(e);a.resolve(o)});o.fail(function(){n.showLocalizedError("fail_to_create_group_msg");var e={status:0,action:"createNewGroup"};a.resolve(e)});return a.promise()},createTile:function(e){var a=this;var o=e.catalogTileContext;var i=e.groupContext;var r=this.oModel.getProperty(i.getPath());var l=r.groupId;var g=new u.Deferred;var c={};var d=t.getEventBus();d.publish("launchpad","addTile",{catalogTileContext:o,groupContext:i});if(!o){h.warning("CatalogsManager: Did not receive catalog tile object. Abort.",this);c={group:r,status:0,action:"add"};return Promise.resolve(c)}var p=this.oLaunchPageService.addTile(o.getProperty("src"),i.getProperty("object"));p.done(function(e){var t=a.oModel.getProperty("/groups");var o=s.getModelPathOfGroup(t,l);var i=a.oLaunchPageService.getTileTitle(e);a.oHomepageManager.addTileToGroup(o,e);c={group:r,status:1,action:"add"};sap.ushell.Container.getServiceAsync("UsageAnalytics").then(function(e){e.logCustomEvent(a.analyticsConstants.PERSONALIZATION,a.analyticsConstants.ADD_TILE,[r.title,i])});g.resolve(c)}).fail(function(){n.showLocalizedError("fail_to_add_tile_msg");c={group:r,status:0,action:"add"};g.resolve(c)});return g.promise()},deleteCatalogTileFromGroup:function(e){var t=this;var a=decodeURIComponent(e.tileId);var o=e.groupIndex;var i=this.oModel.getProperty("/groups/"+o);var r=new u.Deferred;var s=[];var n=[];["tiles","links"].forEach(function(e){i[e].forEach(function(e){var o=t.oLaunchPageService.getCatalogTileId(e.object);if(o===a){var r=new u.Deferred;var l=t.oLaunchPageService.removeTile(i.object,e.object);l.done(function(t){return function(){n.push(e.uuid);t.resolve({status:true})}}(r));l.fail(function(e){return function(){e.resolve({status:false})}}(r));s.push(r)}})});u.when.apply(u,s).done(function(e){var a=s.length===n.length;t.oHomepageManager.deleteTilesFromGroup(i.groupId,n);t.updateTilesAssociation();r.resolve({group:i,status:a,action:"remove"})});return r.promise()},calculateCatalogTileIndex:function(e,t,a){var o=parseInt(e*1e5,10);o+=(t!==undefined?t:0)+a;return o},notifyOnActionFailure:function(e,t){n.showLocalizedError(e,t)},resetAssociationOnFailure:function(e,t){this.notifyOnActionFailure(e,t);this.updateTilesAssociation()},_getIsIntentSupported:function(e){return!!this.oLaunchPageService.isTileIntentSupported(e)},_getIsAppBox:function(e){var t;var a=this.oModel.getProperty("/appFinderDisplayMode");if(a==="tiles"){t=false}else{t=!!(this.oLaunchPageService.getCatalogTileTargetURL(e)&&(this.oLaunchPageService.getCatalogTilePreviewTitle(e)||this.oLaunchPageService.getCatalogTilePreviewSubtitle(e)))}return t},destroy:function(){this.unregisterEvents()}});v.prototype.getInstance=function(){return p};return v});