//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/MessageToast","sap/m/library","sap/ui/core/library","sap/ui/core/format/DateFormat","sap/ui/thirdparty/jquery"],function(e,i,t,a,l){"use strict";var o=i.DeviationIndicator;var s=i.ValueColor;var r=i.FrameType;var n=i.Size;var c=i.LoadState;var h=t.mvc.ViewType;sap.ui.controller("sap.ushell.components.tiles.indicatorDual.DualTile",{getRelativeTime:function(){var e=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();this.cacheTime=l.type(this.cacheTime)=="date"?this.cacheTime:new Date(parseInt(this.cacheTime.substr(6),10));var i=sap.ushell.components.tiles.indicatorTileUtils.util.getTimeDifference(e-this.cacheTime),t,a;switch(i.unit){case"minutes":a=sap.ushell.components.tiles.indicatorTileUtils.util.getMillisecond(i.time,"minutes");e=e-a;t=new Date(e);break;case"hours":a=sap.ushell.components.tiles.indicatorTileUtils.util.getMillisecond(i.time,"hours");e=e-a;t=new Date(e);break;case"days":a=sap.ushell.components.tiles.indicatorTileUtils.util.getMillisecond(i.time,"days");e=e-a;t=new Date(e);break}return t},getTile:function(){return this.oKpiTileView.oGenericTile},setTimeStamp:function(){this.updateTimeStampjobScheduled=false;var e=a.getDateTimeInstance({relative:true,relativeSource:"auto"});var i=e.format(this.getRelativeTime());var t=this.getView().oGenericTile.getTileContent()[0];if(t){if(t.setRefreshOption){t.setRefreshOption(true)}if(t.setTimestamp){t.setTimestamp(i)}}this.updateTimeStampjobScheduled=false;var l=this.oConfig.TILE_PROPERTIES.id+"time";var o=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(l);if(o){clearTimeout(o);o=undefined}sap.ushell.components.tiles.indicatorTileUtils.util.scheduleTimeStampJob.call(this,this.oTileApi.visible.isVisible())},getLocalCache:function(e){var i={};i.ChipId=e.ChipId;i.Data=e.Data;i.CacheMaxAge=e.CacheMaxAgeUnit;i.CacheMaxAgeUnit=e.CacheMaxAgeUnit;i.CacheType=e.CacheType;i.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();return i},refreshPress:function(){this.initProcess(true)},_getView:function(e,i,t){var a=this.oKpiTileView.getViewData();var o=sap.ui.view({type:h.JS,viewName:e,viewData:l.extend(true,{},a,{parentController:this},{deferredObj:i},{refresh:t})});return o},logError:function(){this._updateTileModel({value:"",scale:"",unit:""});if(this.getView().getViewData().deferredObj){this.getView().getViewData().deferredObj.reject()}},doProcess:function(e){sap.ushell.components.tiles.indicatorTileUtils.util.setUnsetCallInProgress(this.oKpiTileView.oConfig.TILE_PROPERTIES.id+"defferedLeft",this.deferred_left);sap.ushell.components.tiles.indicatorTileUtils.util.setUnsetCallInProgress(this.oKpiTileView.oConfig.TILE_PROPERTIES.id+"defferedRight",this.deferred_right);var i=this;this.getView().oGenericTile.removeAllTileContent();var t=this.getView().oGenericTile;this.system=this.oTileApi.url.getApplicationSystem();this.oKpiTileView.oGenericTile.setState(c.Loading);var a=i.tileType.split("-")[1];try{var l;l="sap.ushell.components.tiles.indicatornumeric.NumericTile";this.leftView=i._getView(l,this.deferred_left,e);this.leftView.getController().dataCallInProgress=false;t.addTileContent(this.leftView.oGenericTile.getTileContent()[0]);switch(a){case"CM":l="sap.ushell.components.tiles.indicatorcomparison.ComparisonTile";this.rightView=i._getView(l,this.deferred_right,e);this.rightView.getController().dataCallInProgress=false;t.addTileContent(this.rightView.oGenericTile.getTileContent()[0]);break;case"CT":l="sap.ushell.components.tiles.indicatorcontribution.ContributionTile";this.rightView=i._getView(l,this.deferred_right,e);this.rightView.getController().dataCallInProgress=false;t.addTileContent(this.rightView.oGenericTile.getTileContent()[0]);break;case"AT":l="sap.ushell.components.tiles.indicatordeviation.DeviationTile";this.rightView=i._getView(l,this.deferred_right,e);this.rightView.getController().dataCallInProgress=false;t.addTileContent(this.rightView.oGenericTile.getTileContent()[0]);break;case"TT":l="sap.ushell.components.tiles.indicatorArea.AreaChartTile";this.rightView=i._getView(l,this.deferred_right,e);this.rightView.getController().dataCallInProgress=false;t.addTileContent(this.rightView.oGenericTile.getTileContent()[0]);break}this.leftView.getController().onAfterTileRendering();this.rightView.getController().onAfterTileRendering();var o=this.getView().oGenericTile.getTileContent()[0];if(o&&o.attachRefresh){o.attachRefresh(this.refreshPress.bind(i))}}catch(e){this.logError(e)}},_updateTileModel:function(e){var i=this.getTile().getModel().getData();l.extend(i,e);this.getTile().getModel().setData(i)},setTextInTile:function(){var e=this;var i=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oTileApi);this._updateTileModel({header:i.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(e.oConfig),subheader:i.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(e.oConfig)})},doDummyProcess:function(){var e=this;try{e.setTextInTile();switch(e.tileType){case"DT-CM":e._updateTileModel({value:1,size:n.Auto,frameType:r.TwoByOne,state:c.Loading,valueColor:s.Good,indicator:o.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1,color:"Good"},{title:"Measure 2",value:2,color:"Good"},{title:"Measure 3",value:3,color:"Good"}]});break;case"DT-AT":e._updateTileModel({valueColor:"Good",value:100,frameType:r.TwoByOne,unit:"USD",actual:{value:120,color:s.Good},targetValue:100,thresholds:[{value:0,color:s.Error},{value:50,color:s.Critical},{value:150,color:s.Critical},{value:200,color:s.Error}],showActualValue:true,showTargetValue:true});break;case"DT-CT":e._updateTileModel({value:8888,size:n.Auto,frameType:r.TwoByOne,state:c.Loading,valueColor:s.Error,indicator:o.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral",displayValue:""},{title:"EMEA",value:50,color:"Neutral",displayValue:""},{title:"APAC",value:-20,color:"Neutral",displayValue:""}]});break;case"DT-TT":this._updateTileModel({value:8888,size:n.Auto,frameType:r.TwoByOne,state:c.Loading,valueColor:s.Error,indicator:o.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",width:"100%",height:"100%",chart:{color:"Good",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:20},{day:100,balance:80}]},target:{color:"Error",data:[{day:0,balance:0},{day:30,balance:30},{day:60,balance:40},{day:100,balance:90}]},maxThreshold:{color:"Good",data:[{day:0,balance:0},{day:30,balance:40},{day:60,balance:50},{day:100,balance:100}]},innerMaxThreshold:{color:"Error",data:[]},innerMinThreshold:{color:"Neutral",data:[]},minThreshold:{color:"Error",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:30},{day:100,balance:70}]},minXValue:0,maxXValue:100,minYValue:0,maxYValue:100,firstXLabel:{label:"June 123",color:"Error"},lastXLabel:{label:"June 30",color:"Error"},firstYLabel:{label:"0M",color:"Good"},lastYLabel:{label:"80M",color:"Critical"},minLabel:{},maxLabel:{}});break}}catch(e){}},visibleHandler:function(e){if(!e){if(this.leftView){this.leftView.getController().firstTimeVisible=false}if(this.rightView){this.rightView.getController().firstTimeVisible=false}sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef);sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.trendChartODataReadRef);sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}if(e){if(this.leftView){this.leftView.getController().refreshHandler()}if(this.rightView){this.rightView.getController().refreshHandler()}}},initProcess:function(i){var t=this;this.oKpiTileView=this.getView();this.oResourceBundle=sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle();this.viewData={};t.viewData=this.oKpiTileView.getViewData();this.oTileApi=this.viewData.chip;if(this.oTileApi.visible){this.oTileApi.visible.attachVisible(this.visibleHandler.bind(this))}this.deferred_left=new l.Deferred;this.deferred_right=new l.Deferred;l.when(this.deferred_left,this.deferred_right).done(function(){t.setTextInTile();t.oConfig=t.oKpiTileView.oConfig;t.chipCacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTime(t.oConfig);t.chipCacheTimeUnit=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTimeUnit(t.oConfig);var e=t.leftView.getController().cacheWriteData;var i=t.rightView.getController().cacheWriteData;t.oKpiTileView.oGenericTile.setState(c.Loaded);var a=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oKpiTileView.oConfig,t.system);t.oKpiTileView.oGenericTile.$().wrap("<a href ='"+a+"'></a>");t.oKpiTileView.oGenericTile.attachPress(function(){t.tilePressed=true;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oKpiTileView.oConfig.TILE_PROPERTIES.id,null);window.location.hash=a});var l={};var o={};o.leftData=e;o.rightData=i;l.ChipId=t.oConfig.TILE_PROPERTIES.id;l.Data=JSON.stringify(o);l.CacheMaxAge=Number(t.chipCacheTime);l.CacheMaxAgeUnit=t.chipCacheTimeUnit;l.CacheType=1;var s=t.getLocalCache(l);if(o.leftData&&o.rightData){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,s)}var r=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(t.chipCacheTime&&o.leftData&&o.rightData){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(t.oTileApi,t.oConfig.TILE_PROPERTIES.id,l,false,function(e){if(e){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,e);t.cacheTime=e.CachedTime;t.setTimeStamp.call(t)}})}if(t.chipCacheTime){if(!t.cacheTime){t.cacheTime=r.CachedTime}t.setTimeStamp.call(t);sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(t,t.oTileApi.visible.isVisible())}}).fail(function(){t.oKpiTileView.oGenericTile.setState(c.Failed)});t.tileType=t.oKpiTileView.oConfig.TILE_PROPERTIES.tileType;this.oTileApi=t.viewData.chip;if(this.oTileApi.preview.isEnabled()){this.doDummyProcess();t.oKpiTileView.oGenericTile.attachPress(function(){e.show(t.oResourceBundle.getText("sb.NavigationHelp"))})}else{this.doProcess(i)}},onAfterRendering:function(){this.initProcess()},setNoData:function(){try{this._updateTileModel({value:"",scale:"",unit:"",footerNum:this.oResourceBundle.getText("sb.noDataAvailable"),footerComp:this.oResourceBundle.getText("sb.noDataAvailable")});this.oKpiTileView.oGenericTile.setState(c.Loaded)}catch(e){}},getChipConfiguration:function(e){var i=this;try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(i.oTileApi.configuration.getParameterValueAsString("tileConfiguration"),i.oTileApi.preview.isEnabled(),function(t){i.oConfig=t;e.call()})}catch(e){i.logError(e.message)}}})},true);