// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/ushell/components/shell/Settings/ErrorMessageHelper","sap/ui/core/message/Message","sap/ui/base/Object","sap/ui/core/library","sap/base/util/deepClone"],function(e,t,n,r,s,i,o,a,l,u,d,c,g,f,h){"use strict";var p=f.MessageType;return n.extend("sap.ushell.components.shell.Settings.UserSettings",{onInit:function(){this._aPreviouslySelectedItems=[];if(!i.system.phone){this.getView().byId("userSettingEntryList").addEventDelegate({onAfterRendering:this._listAfterRendering.bind(this)})}this._mLoadedEntryContent=new Map;this._mLoadedWrappers=new Map;this.getView().setModel(new s({entries:{}}),"results");i.orientation.attachHandler(this._fnOrientationChange,this);this._oConfigDoable=o.on("/core/userPreferences/entries").do(this._processNewEntries.bind(this))},_fnOrientationChange:function(){var e=this.getView().byId("settingsApp");this._updateHeaderButtonVisibility(e.isMasterShown())},_formatDescription:function(e,t,n){if(t.length>1){return""}return n[e].valueResult||""},_processNewEntries:function(e){var t=this.getView();var n=t.getModel("results");e.forEach(function(e){var t=n.getProperty("/entries/"+e.id);if(!t){n.setProperty("/entries/"+e.id,{valueResult:null,contentResult:null})}this._setEntryValueResult(e.id)}.bind(this));var r=t.getModel();var s=t.byId("userSettingEntryList");var o=s.getSelectedItem();if(!i.system.phone&&!o){o=s.getItems()[0]}if(o){var a=o.getBindingContextPath();var l=r.getProperty(a);this._aPreviouslySelectedItems=l.tabs.map(function(e){return e.id})}r.setProperty("/entries",this._calculateEntryGroups(e));t.byId("userSettingEntryList").invalidate()},_calculateEntryGroups:function(e){var t=[];var n=new Map;var r=this.getView().getModel("results");e.forEach(function(e){if(e.visible===false){var s=r.getProperty("/entries/"+e.id+"/contentResult");if(s){this.getView().byId("settingsApp").removeDetailPage(s);r.setProperty("/entries/"+e.id+"/contentResult",null)}var i=a.last("UserSettingsOpened")||{};delete i[e.id];a.emit("UserSettingsOpened",i);return}if(e.groupingEnablement){r.setProperty("/entries/"+e.id+"/contentResult",null);var o=n.get(e.groupingId);if(o||o===0){t[o].tabs.push(e);return}n.set(e.groupingId,t.length)}e.tabs=[e];t.push(e)}.bind(this));return t},_afterClose:function(){if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("userActionsMenuHeaderButton").focus()}},_listAfterRendering:function(){var e=this.getView();var t=e.getModel();var n=e.byId("userSettingEntryList");var r=n.getItems();r.forEach(function(e){var n=t.getProperty(e.getBindingContextPath()+"/id");this._setEntryValueResult(n)}.bind(this));if(this._aPreviouslySelectedItems){for(var s=0;s<this._aPreviouslySelectedItems.length;s++){for(var i=0;i<r.length;i++){var o=r[i];if(t.getProperty(o.getBindingContextPath()+"/id")===this._aPreviouslySelectedItems[s]){n.setSelectedItem(o);this._toDetail(o);o.focus();return}}}}var a=r[0];if(a){n.setSelectedItem(a);this._toDetail(a);a.focus()}},_setEntryValueResult:function(t){var n;var r=this.getView().getModel("results");var s=o.last("/core/userPreferences/entries");var i=s.findIndex(function(e){return e.id===t});if(i===-1){return Promise.resolve()}return Promise.resolve().then(function(){var a=s[i].title;var u=s[i].valueArgument;if(typeof u!=="function"){var d=r.getProperty("/entries/"+t+"/valueResult");if(d!==null&&d!==undefined){return d}return u}n=h(r.getProperty("/entries"));n[t].valueResult=l.i18n.getText("genericLoading");r.setProperty("/entries",n);return Promise.resolve().then(u).then(function(e){if(typeof e!=="object"){return e}if(e&&e.value!==undefined){s=o.last("/core/userPreferences/entries");i=s.findIndex(function(e){return e.id===t});if(i>-1){s[i].visible=!!e.value;o.emit("/core/userPreferences/entries",s)}}return e.displayText}).catch(function(t){e.error("Can not load value for "+a+" entry",t);return l.i18n.getText("loadingErrorMessage")})}).then(function(e){n=h(r.getProperty("/entries"));n[t].valueResult=e||"";r.setProperty("/entries",n)})},_navBackButtonPressHandler:function(){var e=this.getView().byId("settingsApp");e.backDetail();this._updateHeaderButtonVisibility(true)},_navToggleButtonPressHandler:function(){var e=this.getView().byId("settingsApp"),t=e.isMasterShown();if(t){e.hideMaster()}else{e.showMaster()}this._updateHeaderButtonVisibility(!t)},_updateHeaderButtonVisibility:function(e){if(i.system.phone){var t=this.getView().byId("userSettingsNavBackButton");t.setVisible(!e)}else{var n=this.getView().byId("userSettingsMenuButton");if(i.orientation.portrait){n.setVisible(true);n.setPressed(e);n.setTooltip(l.i18n.getText(e?"ToggleButtonHide":"ToggleButtonShow"))}else{n.setVisible(false)}}},_itemPress:function(e){this._toDetail(e.getSource().getSelectedItem())},_toDetail:function(e){var t=this.getView();var n=t.getModel();var r=t.getModel("results");var s=e.getBindingContextPath();var a=n.getProperty(s);var l=a.id;var u=r.getProperty("/entries/"+l+"/contentResult");if(a.tabs){this._aPreviouslySelectedItems=a.tabs.map(function(e){return e.id})}else{this._aPreviouslySelectedItems=[l]}if(i.system.phone){e.setSelected(false)}if(u){this._navToDetail(u,t);var d=a.tabs.map(function(e){return e.id}).join("-");var c=this._mLoadedWrappers.get(d);if(c){c.then(function(e){var t=e.getContent()[1];var n=t.getSelectedKey();var r=t.getItems();var s=r.findIndex(function(e){return e.getId()===n});if(s===-1){s=0}this._emitEntryOpened(a.tabs[s].id)}.bind(this));return Promise.resolve()}}return Promise.all([this._createContentWrapper(a),this._createEntryContent(a)]).then(function(e){var n=o.last("/core/userPreferences/entries");var s=n.some(function(e){return e.id===l&&e.visible!==false});if(!s){return}var i=e[0];var u=e[1];this.getView().byId("settingsApp").addDetailPage(i);if(a.tabs.length>1){i.getContent()[1].getItems()[0].addContent(u)}else{i.addContent(u)}var d=i.getId();r.setProperty("/entries/"+l+"/contentResult",d);this._navToDetail(d,t);this._emitEntryOpened(l);return i.getId()}.bind(this))},_createEntryContent:function(e){if(!this._mLoadedEntryContent.get(e.id)){if(typeof e.contentFunc==="function"){this._mLoadedEntryContent.set(e.id,new Promise(function(t){e.contentFunc().then(function(e){if(g.isA(e,"sap.ui.core.Control")){t(e)}else{this._createErrorContent(l.i18n.getText("loadingErrorMessage")).then(t)}}.bind(this)).catch(function(){this._createErrorContent(l.i18n.getText("loadingErrorMessage")).then(t)}.bind(this))}.bind(this)))}else{this._mLoadedEntryContent.set(e.id,this._createErrorContent(l.i18n.getText("userSettings.noContent")))}}return this._mLoadedEntryContent.get(e.id)},_createContentWrapper:function(e){var n=e.tabs.map(function(e){return e.id});var i=n.join("-");if(!this._mLoadedWrappers.get(i)){this._mLoadedWrappers.set(i,r.load({name:"sap.ushell.components.shell.Settings.ContentWrapper",controller:{onTabSelected:function(n){var r=t.byId(n.getParameter("id"));var s=n.getParameter("item");var i=r.indexOfItem(s);var o=e.tabs[i];this._emitEntryOpened(o.id);this._createEntryContent(o).then(function(e){s.addContent(e)})}.bind(this)}}).then(function(t){t.setModel(new s({title:e.title,showHeader:!e.provideEmptyWrapper,tabs:e.tabs}),"entryInfo");return t}))}return this._mLoadedWrappers.get(i).then(function(t){var n=t.getContent()[1];var r=n.getSelectedKey();var s=n.getItems().findIndex(function(e){return e.getId()===r});if(s>-1){var i=e.tabs[s];this._emitEntryOpened(i.id)}return t}.bind(this))},_createErrorContent:function(e){return r.load({name:"sap.ushell.components.shell.Settings.ErrorContent"}).then(function(t){t.setModel(new s({errorMessage:e}));return t})},_navToDetail:function(e,t){var n=t.byId("settingsApp");n.toDetail(e);if(n.getMode()==="ShowHideMode"){n.hideMaster();this._updateHeaderButtonVisibility(false)}},_emitEntryOpened:function(e){var t=a.last("UserSettingsOpened")||{};t[e]=true;a.emit("UserSettingsOpened",t)},updateUserPreferences:function(){e.debug("[000] updateUserPreferences: ","UserSettings.controller");if(this._updateUserPreferencesPromise){return this._updateUserPreferencesPromise}var t,n;this._updateUserPreferencesPromise=new Promise(function(e,r){t=e;n=r});this._updateUserPreferencesPromise.sendRequest=function(){sap.ushell.Container.getServiceAsync("UserInfo").then(function(r){e.debug("[000] updateUserPreferences: sendRequest","UserSettings.controller");r.updateUserPreferences().done(t).fail(n).always(function(){e.debug("[000] updateUserPreferences: sendRequest: _updateUserPreferencesPromise","UserSettings.controller");this._updateUserPreferencesPromise=null}.bind(this))}.bind(this))}.bind(this);return this._updateUserPreferencesPromise},_maybeReload:function(t){var n=false;var r=false;var s=[];var i=[];t.forEach(function(e){if(e&&e.refresh){n=true}if(e&&e.noHash){r=true}if(e&&e.urlParams&&e.urlParams.length>0){s=s.concat(e.urlParams)}if(e&&e.obsoleteUrlParams&&e.obsoleteUrlParams.length>0){i=i.concat(e.obsoleteUrlParams)}});if(n){e.debug("[000]refresh browser with Parameters:",JSON.stringify(s),"UserSettings.controller");if(r){window.location=window.location.href.replace(window.location.hash,"")}else{u.refreshBrowser(s,i)}return true}},_handleSaveButtonPress:function(){d.removeErrorMessages();var t=this.getView().byId("userSettingsDialog");var n=o.last("/core/userPreferences/entries");var r=a.last("UserSettingsOpened")||{};if(Object.keys(r).length===0){this._handleSettingsDialogClose();this._showSuccessMessageToast();return Promise.resolve()}t.setBusy(true);var s=n.reduce(function(t,n){if(r[n.id]){e.debug("[000] _handleSaveButtonPress: oEntry.id: ",n.id,"UserSettings.controller");t.push(this._executeEntrySave(n))}return t}.bind(this),[]);e.debug("[000] _handleSaveButtonPress:_updateUserPreferencesPromise",this._updateUserPreferencesPromise,"UserSettings.controller");if(this._updateUserPreferencesPromise){this._updateUserPreferencesPromise.sendRequest()}return Promise.all(s).then(function(n){e.debug("[000] _handleSaveButtonPress: then save aResults",JSON.stringify(n),"UserSettings.controller");var r=d.filterMessagesToDisplay();var s={};var i="";var o="";t.setBusy(false);this._handleSettingsDialogClose();if(r.length>0){s=r[0];i=s.getDescription();a.emit("UserSettingsOpened",null);r.forEach(function(e){o+="Entry: "+e.getAdditionalText()+" - Error message: "+e.getDescription()+"\n"});e.error("Failed to save the following entries",o);if(this._maybeReload(n)){return}return sap.ushell.Container.getServiceAsync("Message").then(function(e){e.init();e.show(e.Type.ERROR,l.i18n.getText("userSettings.SavingError.SomeChanges"),{details:i})})}this._showSuccessMessageToast();a.emit("UserSettingsOpened",null);this._maybeReload(n)}.bind(this))},_executeEntrySave:function(t){var n,r;function s(e){return e||{}}function i(n){e.debug("[000] _onError: errorInformation",JSON.stringify(n),"UserSettings.controller");var r;var s=t.id;var i=t.title;if(!n){r=l.i18n.getText("userSettings.SavingError.Undefined")}else if(typeof n==="string"){r=n}else if(Array.isArray(n)){n.forEach(function(e){e.setAdditionalText(i);e.setTechnicalDetails({pluginId:s});d.addMessage(e)});return}else if(g.isA(n,"sap.ui.core.message.Message")){n.setAdditionalText(i);n.setTechnicalDetails({pluginId:s});d.addMessage(n);return}else{r=l.i18n.getText("userSettings.SavingError.WithMessage",n.message)}d.addMessage(new c({type:p.Error,additionalText:i,technicalDetails:{pluginId:s},description:r,message:r}))}try{e.debug("[000] onSave: oEntry.id: "+t.id,"UserSettings.controller");this._isExecuteEntrySavedInUserSettingsController=true;n=t.onSave(this.updateUserPreferences.bind(this))}catch(e){return i(e)}if(n){if(n.promise){e.warning("jQuery.promise is used to save "+t.title+" settings entry.\n"+"The using of jQuery.promise for onSave is deprecated. Please use the native promise instead.");r=new Promise(function(e){n.done(function(t){e(s(t))}).fail(function(t){e(i(t))})})}else{r=n.then(s).catch(i)}}else{r=Promise.resolve();e.warning(t.title+" settings might not be saved correctly, it seems like the API contract is not correctly fullfilled.\n"+"Please contact the owner of the setting.")}return r},_showSuccessMessageToast:function(){sap.ui.require(["sap/m/MessageToast"],function(e){var t=l.i18n.getText("savedChanges");e.show(t,{offset:"0 -50"})})},_handleCancel:function(){var t=o.last("/core/userPreferences/entries");var n=a.last("UserSettingsOpened")||{};if(n){t.forEach(function(t){if(n[t.id]&&t.onCancel){try{t.onCancel()}catch(t){e.error("Failed to cancel the following entries",t)}}})}a.emit("UserSettingsOpened",null);this._handleSettingsDialogClose()},_handleSettingsDialogClose:function(){sap.ushell.Container.getUser().resetChangedProperties();if(i.system.phone){this.getView().byId("settingsApp").toMaster("settingsView--userSettingMaster")}this.getView().byId("userSettingsMessagePopoverBtn").setVisible(false);this.getView().byId("userSettingsDialog").close()},onExit:function(){this._oConfigDoable.off();i.orientation.detachHandler(this._fnOrientationChange,this)}})});