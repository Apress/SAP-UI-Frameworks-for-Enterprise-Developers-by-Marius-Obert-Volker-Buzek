// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/base/Log","sap/ushell/resources","sap/base/util/deepClone","sap/ui/thirdparty/jquery"],function(e,t,i,o,n,r,s){"use strict";return e.extend("sap.ushell.components.shell.Settings.notifications.NotificationsSetting",{onInit:function(){this._oModel=new t({rows:[],originalRows:[]});var e=this.getView(),i;e.setBusy(true);e.setModel(n.getTranslationModel(),"i18n");sap.ushell.Container.getServiceAsync("Notifications").then(function(t){this._oNotificationService=t;this._initializeFlags();t.readSettings().done(function(e){i=JSON.parse(e);this._oModel.setProperty("/rows",i.value);this._oModel.setProperty("/originalRows",r(i.value))}.bind(this)).always(function(){e.setBusy(false);e.setModel(this._oModel)}.bind(this))}.bind(this))},onAfterRendering:function(){var e=this._oModel.getProperty("/flags"),t=this._oModel.getProperty("/rows");if(t!==undefined){this._oModel.setProperty("/originalRows",r(t))}if(e!==undefined){this._oModel.setProperty("/originalFlags/highPriorityBannerEnabled",e.highPriorityBannerEnabled)}},onCancel:function(){var e=this._oModel.getProperty("/originalFlags"),t=this._oModel.getProperty("/originalRows");this._oModel.setProperty("/flags/highPriorityBannerEnabled",e.highPriorityBannerEnabled);this._oModel.setProperty("/rows",r(t));this._oModel.setProperty("/originalFlags",{});this._oModel.setProperty("/originalRows",[])},onSave:function(){var e=this._oModel.getProperty("/rows"),t=this._oModel.getProperty("/originalRows"),i,n,r=[],a=[];for(var l=0;l<e.length;l++){i=e[l];n=t[l];if(this._notficationSettingsDiffer(i,n)){r.push(i)}}if(this._flagsHaveChanged()){this._handleFlagsSave()}if(r.length){r.forEach(function(e){a.push(this._oNotificationService.saveSettingsEntry(e))}.bind(this));return new Promise(function(e,t){s.when.apply(s,a).done(function(){e()}).fail(function(e){o.error("Failed to save the notification settings in the notifivation service.",e,"sap.ushell.components.ushell.settings.notifications.NotificationsSetting");t(e)})})}return Promise.resolve()},_flagsHaveChanged:function(){return this._oModel.getProperty("/flags/highPriorityBannerEnabled")!==this._oModel.getProperty("/originalFlags/highPriorityBannerEnabled")},_handleFlagsSave:function(){var e=this._oModel.getProperty("/flags/highPriorityBannerEnabled");this._oModel.setProperty("/originalFlags/highPriorityBannerEnabled",e);this._oNotificationService.setUserSettingsFlags({highPriorityBannerEnabled:e})},_notficationSettingsDiffer:function(e,t){return e.NotificationTypeId!==t.NotificationTypeId||e.PriorityDefault!==t.PriorityDefault||e.DoNotDeliver!==t.DoNotDeliver||e.DoNotDeliverMob!==t.DoNotDeliverMob||e.DoNotDeliverEmail!==t.DoNotDeliverEmail},onSelectMobile:function(e){var t=e.getSource().getBindingContext().getPath();this._oModel.setProperty(t+"/DoNotDeliverMob",!e.getParameter("selected"))},onSelectEmail:function(e){var t=e.getSource().getBindingContext().getPath();this._oModel.setProperty(t+"/DoNotDeliverEmail",!e.getParameter("selected"))},onSelectHighPriority:function(e){var t=e.getSource().getBindingContext().getPath();if(e.getParameter("selected")){this._oModel.setProperty(t+"/PriorityDefault","HIGH")}else{this._oModel.setProperty(t+"/PriorityDefault","")}},onEnableSwitchChange:function(e){var t=e.getParameter("state"),i=e.getSource().getBindingContext().getPath();this._oModel.setProperty(i+"/DoNotDeliver",!t)},_initializeFlags:function(){var e=this._oNotificationService.getUserSettingsFlags(),t=this._oNotificationService._getNotificationSettingsMobileSupport(),i=this._oNotificationService._getNotificationSettingsEmailSupport();e.done(function(e){this._oModel.setProperty("/flags",{});this._oModel.setProperty("/flags/highPriorityBannerEnabled",e.highPriorityBannerEnabled);this._oModel.setProperty("/flags/mobileNotificationsEnabled",t);this._oModel.setProperty("/flags/emailNotificationsEnabled",i);this._oModel.setProperty("/originalFlags",{});this._oModel.setProperty("/originalFlags/highPriorityBannerEnabled",e.highPriorityBannerEnabled)}.bind(this))}})});