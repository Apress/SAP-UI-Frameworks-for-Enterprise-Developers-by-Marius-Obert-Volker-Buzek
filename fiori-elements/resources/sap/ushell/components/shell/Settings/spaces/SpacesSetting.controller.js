// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ushell/EventHub","sap/ushell/Config","sap/ushell/resources","sap/ushell/utils","sap/base/Log"],function(e,s,t,r,o,a,n){"use strict";return e.extend("sap.ushell.components.shell.Settings.spaces.SpacesSetting",{onInit:function(){var e=this.getView().getViewData();this.oUserInfoService=e.UserInfo;var a=this.oUserInfoService.getUser();var n=r.last("/core/spaces/enabled");var i=r.last("/core/homeApp/enabled");var p=r.last("/core/spaces/myHome/enabled");var l=n&&p&&!i;var c=a.getShowMyHome();var d=a.getImportBookmarksFlag();var m=d!=="done"&&d!=="not_required";var h=new s({spaces:{visible:r.last("/core/spaces/configurable"),selected:n},hideEmptySpaces:{visible:n&&r.last("/core/spaces/hideEmptySpaces/enabled"),selected:r.last("/core/spaces/hideEmptySpaces/userEnabled")},showMyHome:{visible:l,selected:c},showMyHomeImport:{visible:l&&c&&m,selected:d==="pending"}});this.getView().setModel(h);this.getView().setModel(o.getTranslationModel(),"i18n");this.oImportBookmarksFlagListener=t.on("importBookmarksFlag").do(this._setMyHomeImportSelected.bind(this))},_setMyHomeImportSelected:function(e){var s=this.getView().getModel();s.setProperty("/showMyHomeImport/selected",e)},onExit:function(){this.oImportBookmarksFlagListener.off()},onSave:function(e){var s=false;var o=false;var i=[];var p=this.getView().getModel();var l=this.oUserInfoService;var c=l.getUser();var d=r.last("/core/spaces/enabled");var m=p.getProperty("/spaces/selected");var h=r.last("/core/spaces/hideEmptySpaces/userEnabled");var g=p.getProperty("/hideEmptySpaces/selected");var y=c.getShowMyHome();var u=p.getProperty("/showMyHome/selected");var v=c.getImportBookmarksFlag()==="pending";var f=p.getProperty("/showMyHomeImport/selected");if(d!==m){c.setChangedProperties({propertyName:"spacesEnabled",name:"SPACES_ENABLEMENT"},d,m);o=true;s=true}if(y!==u){c.setShowMyHome(u);o=true;s=true}if(v!==f){var E=f?"pending":"dismissed";c.setImportBookmarksFlag(E);o=true;if(!s){t.emit("importBookmarksFlag",f)}}if(h!==g){var M=a.setHideEmptySpacesEnabled(g).catch(function(e){p.setProperty("/hideEmptySpaces/selected",h);return Promise.reject(e)});i.push(M)}if(!o&&!i.length){return Promise.resolve()}n.debug("[000] SpacesSetting.controller.save");if(o){var S=new Promise(function(s,t){e().then(function(){c.resetChangedProperty("spacesEnabled");c.resetChangedProperty("showMyHome");c.resetChangedProperty("importBookmarks");s()}).catch(function(e){if(!e.includes("SPACES_ENABLEMENT")&&!e.includes("MYHOME_ENABLEMENT")&&!e.includes("MYHOME_IMPORT_FROM_CLASSIC")){c.resetChangedProperty("spacesEnabled");c.resetChangedProperty("showMyHome");c.resetChangedProperty("importBookmarks");s()}else{p.setProperty("/spaces/selected",d);p.setProperty("/showMyHome/selected",y);c.resetChangedProperty("spacesEnabled");c.resetChangedProperty("showMyHome");c.resetChangedProperty("importBookmarks");t(e)}})});i.push(S)}return Promise.all(i).then(function(){return{refresh:s,noHash:true}})},onCancel:function(){var e=this.getView().getModel();e.setProperty("/spaces/selected",r.last("/core/spaces/enabled"));e.setProperty("/showMyHome/selected",this.oUserInfoService.getUser().getShowMyHome());e.setProperty("/hideEmptySpaces/selected",r.last("/core/spaces/hideEmptySpaces/userEnabled"))}})});