// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/Device","sap/m/library","sap/m/Popover","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/UIComponent","sap/ushell/EventHub","sap/ushell/library","sap/ushell/resources","sap/ushell/utils","sap/ushell/ui/shell/ShellHeadItem"],function(t,i,e,o,n,s,a,r,l,c,h,u){"use strict";var f=e.PlacementType;var d=l.FloatingNumberType;function p(){return sap.ui.getCore().byId("NotificationsCountButton")}return a.extend("sap.ushell.components.shell.Notifications.Component",{metadata:{version:"1.113.0",library:"sap.ushell.components.shell.Notifications",dependencies:{libs:["sap.m"]}},createContent:function(){this._aTimeouts=[];this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.oShellModel=this.oRenderer.shellCtrl.getModel();sap.ushell.Container.getServiceAsync("Notifications").then(function(t){this.oNotificationsService=t;if(this.oNotificationsService.isEnabled()===true){sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);this.oShellModel.setProperty("/enableNotifications",true);this.oNotificationsService.init();if(this.oRenderer.getShellConfig().enableNotificationsUI===true){this.oShellModel.setProperty("/enableNotificationsUI",true);this.oNotificationsService.registerDependencyNotificationsUpdateCallback(this._updateCount.bind(this),true)}this._createNotificationButton(this.oShellModel);this.oRenderer.oShellModel.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);r.on("showNotifications").do(this._toggleNotifications.bind(this))}}.bind(this))},_createNotificationButton:function(t){var e="NotificationsCountButton";var o=new u({id:e,tooltip:c.i18n.getText("notificationsBtn_title"),icon:n.getIconURI("bell"),text:c.i18n.getText("notificationsBtn_title"),ariaLabel:c.i18n.getText("notificationsBtn_title"),ariaHaspopup:"dialog",enabled:true,selected:false,visible:"{/enableNotifications}",floatingNumber:"{/notificationsCount}",floatingNumberMaxValue:i.system.phone?99:999,floatingNumberType:d.Notifications,press:function(){r.emit("showNotifications",Date.now())}});o.setModel(t);o.setModel(c.i18nModel,"i18n")},_handleAlerts:function(t,i,e){(e||[]).forEach(this.handleNotification.bind(this))},handleNotification:function(t){var i=this.oRenderer.addRightFloatingContainerItem({press:function(){if(this.oPopover){this.oPopover.close()}if(window.hasher.getHash()!==t.NavigationTargetObject+"-"+t.NavigationTargetAction){if(t.NavigationTargetObject&&t.NavigationTargetAction){h.toExternalWithParameters(t.NavigationTargetObject,t.NavigationTargetAction,t.NavigationTargetParams)}}this.oNotificationsService.markRead(t.Id)}.bind(this),close:function(){this.oRenderer.removeRightFloatingContainerItem(i.getId(),true)}.bind(this),datetime:c.i18n.getText("notification_arrival_time_now"),title:t.SensitiveText?t.SensitiveText:t.Text,description:t.SubTitle,unread:t.IsRead,priority:"High",hideShowMoreButton:true},true,true);this.oRenderer.showRightFloatingContainer(true);var e=setTimeout(function(){this.oRenderer.removeRightFloatingContainerItem(i.getId(),true)}.bind(this),5200);this._aTimeouts.push(e)},_updateCount:function(){this.oNotificationsService.getUnseenNotificationsCount().done(function(t){this.oShellModel.setProperty("/notificationsCount",parseInt(t,10))}.bind(this)).fail(function(i){t.error("Notifications - call to notificationsService.getCount failed: ",i)})},_getPopover:function(){if(!this._oNotificationsPopoverPromise){this._oNotificationsPopoverPromise=new Promise(function(t,i){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(e){e.create({id:"notificationsView",viewName:"sap.ushell.components.shell.Notifications.Notifications",viewData:{notificationsService:this.oNotificationsService}}).then(function(i){var e=i.byId("notificationIconTabBar");e.setAriaTexts({headerLabel:c.i18n.getText("Notifications.Popover.IconTabBar.Header.AriaLabel")});var n=i.byId("sapUshellNotificationsListDate");n.enhanceAccessibilityState=function(t,i){i.hidden=true;return i};var a=i.byId("sapUshellNotificationsListPriority");a.enhanceAccessibilityState=function(t,i){i.hidden=true;return i};var r=i.byId("sapUshellNotificationsListType");r.enhanceAccessibilityState=function(t,i){i.hidden=true;return i};var l=new o("shellNotificationsPopover",{showHeader:false,placement:f.Bottom,showArrow:true,content:i,beforeClose:function(t){t.getSource().getContent()[0].invalidate();this._resetCount()}.bind(this)});l._oAriaLabelledByText=new s(l.getId()+"-labelledBy",{text:c.i18n.getText("NotificationToggleButton.NoNewNotifications")}).toStatic();l.addDependent(l._oAriaLabelledByText);l.addAriaLabelledBy(l._oAriaLabelledByText);l.addStyleClass("sapUshellNotificationsPopup");l.addStyleClass("sapContrastPlus");t(l)}.bind(this)).catch(i)}.bind(this))}.bind(this))}return this._oNotificationsPopoverPromise},_toggleNotifications:function(t){this._getPopover().then(function(i){var e=p();if(!e.$().width()){e=sap.ui.getCore().byId("endItemsOverflowBtn")}if(i.isOpen()){i.close()}else if(t!==false){this._resetCount();i.openBy(e)}}.bind(this))},_resetCount:function(){this.oShellModel.setProperty("/notificationsCount",0);this.oNotificationsService.notificationsSeen()},exit:function(){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);if(this.oNotificationsService&&this.oNotificationsService.isEnabled()===true){this.oNotificationsService.destroy()}this.oNotificationsService=null;var t=p();if(t){this.oRenderer.hideHeaderEndItem(t,false);t.destroy()}this.oRenderer=null;var i=sap.ui.getCore().byId("notificationsView");if(i){i.destroy();i=null}this._aTimeouts.forEach(window.clearTimeout)}})});