//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/HttpClient","sap/ui/thirdparty/URI","sap/base/util/isEmptyObject","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/Configuration","sap/base/util/ObjectPath"],function(e,t,n,r,s,i,a){"use strict";var o="sap.ushell.utils.DynamicTileRequest";function u(e,t,n,r,i){this.fnSuccess=t;this.fnError=n;this.sUrl=e;this._sODataVersion=a.get(["dataSource","settings","odataVersion"],i);this._bResolveSemanticDateRanges=true;this.oReferenceResolverPromise=sap.ushell.Container.getServiceAsync("ReferenceResolver");this.oPromise=this._resolveUserDefaults(e,r).then(function(e){if(e){this.sUrlResolvedUserDefaults=e;this.refresh()}}.bind(this)).catch(function(e){s.error("Was not able to create a DynamicTileRequest:",e,o)})}u.prototype.refresh=function(){if(!this.oRequest){this.oRequest=this._resolveSemanticDateRanges().then(function(e){if(e){return this._sendRequest(e)}}.bind(this))}};u.prototype._resolveSemanticDateRanges=function(){if(!this._bResolveSemanticDateRanges){return Promise.resolve(this.sUrlResolvedUserDefaults)}return this.oReferenceResolverPromise.then(function(e){return e.resolveSemanticDateRanges(this.sUrlResolvedUserDefaults,this._sODataVersion)}.bind(this)).then(function(e){if(e.ignoredReferences&&e.ignoredReferences.length>0||e.invalidSemanticDates&&e.invalidSemanticDates.length>0){var t=[].concat(e.invalidSemanticDates||[],e.ignoredReferences||[]);s.error("The service URL contains invalid Reference(s): "+t.join(", "),"",o);return}this._bResolveSemanticDateRanges=e.hasSemanticDateRanges;return e.url}.bind(this)).catch(function(e){s.error("Could not resolve semantic date ranges:",e,o);return Promise.reject(e)})};u.prototype._sendRequest=function(n){var r=new t(n).escapeQuerySpace(false);var s=i.getSAPLogonLanguage();if(s&&!r.hasQuery("sap-language")){r.addQuery("sap-language",s)}var a=false;if(r.is("relative")){a=true;r=r.absoluteTo(location.href)}var o=this._getHeaders(a);this.oConfig={headers:o};this._sUrlBasePath=r.origin();this._sUrlRequest=r.href();this.oClient=new e(this._sUrlBasePath,this.oConfig);return this.oClient.get(r.relativeTo(this._sUrlBasePath).href()).then(this._onSuccess.bind(this)).catch(this._onError.bind(this))};u.prototype.abort=function(){if(this.oRequest&&this.oClient){this.oClient.abortAll();this.oClient=null;this.oRequest=null;return true}return false};u.prototype._onSuccess=function(e){var t;try{t=JSON.parse(e.responseText)}catch(e){throw new Error("Was not able to parse response of dynamic tile request")}this.oClient=null;this.oRequest=null;var n;if(typeof t==="object"){t=t.d?t.d:t;var s=r.fromURL(this._sUrlRequest);if(s.get("$inlinecount")==="allpages"){n={number:t.__count}}else if(s.get("$count")==="true"){n={number:t["@odata.count"]}}else{n=this._extractData(t)}}else if(typeof t==="string"||typeof t==="number"){n={number:t}}this.fnSuccess(n)};u.prototype._onError=function(e){this.oClient=null;this.oRequest=null;this.fnError(e)};u.prototype._extractData=function(e){var t=["results","icon","title","number","numberUnit","info","infoState","infoStatus","targetParams","subtitle","stateArrow","numberState","numberDigits","numberFactor"];var r=Object.keys(e).reduce(function(n,r){if(t.indexOf(r)>-1){n[r]=e[r]}return n},{});if(!n(r)){return r}var s=Object.keys(e)[0];if(s!==undefined&&Object.keys(e).length===1){return Object.keys(e[s]).reduce(function(n,r){if(t.indexOf(r)>-1){n[r]=e[s][r]}return n},{})}return{}};u.prototype._getHeaders=function(e){var t={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":i.getLanguage()||"",Accept:"application/json, text/plain"};var n=i.getSAPLogonLanguage();if(n){t["sap-language"]=n}if(e){var r=sap.ushell.Container.getLogonSystem();var s=r&&r.getClient();if(s){t["sap-client"]=s}}return t};u.prototype._resolveUserDefaults=function(e,t){var n;return sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return Promise.all([e.getSystemContext(t),this.oReferenceResolverPromise])}.bind(this)).then(function(t){var r=t[0];n=t[1];return new Promise(function(t,s){n.resolveUserDefaultParameters(e,r).done(t).fail(s)})}).then(function(e){if(e.defaultsWithoutValue&&e.defaultsWithoutValue.length>0){s.error("The service URL contains User Default(s) with no set value: "+e.defaultsWithoutValue.join(", "),"",o);return}if(e.ignoredReferences&&e.ignoredReferences.length>0){var t=e.ignoredReferences.filter(function(e){return!e.startsWith("DynamicDate")});if(t.length>0){s.error("The service URL contains invalid Reference(s): "+t.join(", "),"",o);return}}return e.url})};u.prototype.destroy=function(){this.abort();this.fnError=null;this.fnSuccess=null};return u});