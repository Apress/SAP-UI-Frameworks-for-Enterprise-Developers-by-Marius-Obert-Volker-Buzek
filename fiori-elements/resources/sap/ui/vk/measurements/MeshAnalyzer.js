/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Utils"],function(e){"use strict";var t=new Float64Array(3);var r=new Float64Array(3);var i=new Float64Array(3);var n=new Uint32Array(3);var a=new Float64Array(3*3);function s(e,t){var r=e*3;var i=t*2;this._vertices=new Float64Array((r+i)*3);this._vertexCount=0;this._vertexToVertexIndices=new Uint32Array((e*3+t*2)*2);this._vertexToVertexConnectivity=new Uint32Array((r+i)*2);this._vertexToVertexEdgeId=null;this._triangles=new Uint32Array(e*3);this._triangleFaceId=new Uint32Array(e);this._triangleFaceId.fill(4294967295);this._triangleDoubleSidedFlag=new Uint8Array(e);this._triangleCount=0;this._triangleBoundingSphere=null;this._lines=new Uint32Array(t*2);this._lineCount=0;this._vertexSearchMap=new Map;this._vertexNextIndexWithSameHash=new Uint32Array(e*3);this._indexSearchMap=new Map;this._vertexTriangleIndices=new Uint32Array(e*3);this._vertexTriangleUsage=new Uint32Array(r*2)}s.prototype._pointsEqual=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]};s.prototype._hashTypedArray=function(e){var t=new Uint8Array(e.buffer);var r=2166136261;for(var i=0,n=t.length;i<n;++i){r^=t[i];r+=(r<<1)+(r<<4)+(r<<7)+(r<<8)+(r<<24)}return r>>>0};s.prototype._addVertex=function(e){var t=this._hashTypedArray(e);var r;var i=this._vertexSearchMap.get(t);var n;if(i!==undefined){do{n=i*3;if(this._vertices[n]===e[0]&&this._vertices[n+1]===e[1]&&this._vertices[n+2]===e[2]){return i}r=i;i=this._vertexNextIndexWithSameHash[i]}while(i>0)}n=this._vertexCount*3;this._vertices[n]=e[0];this._vertices[n+1]=e[1];this._vertices[n+2]=e[2];if(r!==undefined){this._vertexNextIndexWithSameHash[r]=this._vertexCount}else{this._vertexSearchMap.set(t,this._vertexCount)}return this._vertexCount++};s.prototype._finishMeshBuildingPart1=function(){this._vertexSearchMap=undefined;this._vertexNextIndexWithSameHash=undefined;this._indexSearchMap=undefined;this._buildVertexTriangleUsage();this._buildFaceIds();var e=this._buildEdges();return e};s.prototype._finishMeshBuildingPart2=function(e){this._vertexTriangleIndices=undefined;this._vertexTriangleUsage=undefined;this._buildEdgeIds(e);this._triangleBoundingSphere=new Float64Array(this._triangleCount*4);this._computeBoundingSpheres()};s.prototype.finishMeshBuilding=function(){var e=this._finishMeshBuildingPart1();this._finishMeshBuildingPart2(e)};s.prototype._buildVertexTriangleUsage=function(){var e=0;var t=this._vertexCount;var r;for(r=0;r<t;++r){this._vertexTriangleUsage[r*2]=e;e+=this._vertexTriangleUsage[r*2+1];this._vertexTriangleUsage[r*2+1]=0}var i;var n;var a;var s=this._triangleCount;for(r=0;r<s;++r){for(a=0;a<3;++a){i=this._triangles[r*3+a];t=this._vertexTriangleUsage[i*2+1];n=this._vertexTriangleUsage[i*2]+t;this._vertexTriangleIndices[n]=r;t++;this._vertexTriangleUsage[i*2+1]=t}}};s.prototype._buildEdges=function(){var e=0;var t;var r;var i;var n;var a;var s;var v;var o;var h;var l=this._lineCount;var u;var _;var g=new Set;var d=this._vertexToVertexIndices;var x;var c=function(t){d[e]=Number(t.split(":")[0]);e++};for(var f=0,p=this._vertexCount;f<p;++f){this._vertexToVertexConnectivity[f*2]=e;u=e;t=this._vertexTriangleUsage[f*2];r=t+this._vertexTriangleUsage[f*2+1];g.clear();for(i=t;i<r;++i){n=this._vertexTriangleIndices[i];_=this._triangleFaceId[n];n*=3;for(a=0;a<3;++a){s=this._triangles[n+a];if(s!==f){x=s+":"+_;if(g.has(x)){g.delete(x)}else{g.add(x)}}}}g.forEach(c);for(v=0;v<l;++v){o=this._lines[v*2];h=this._lines[v*2+1];if(o===f){d[e]=h;e++}else if(h===f){d[e]=o;e++}}this._vertexToVertexConnectivity[f*2+1]=e-u}return e};s.prototype.addTriangle=function(n,a,s){if(this._triangleCount*3+3>this._triangles.length){return-1}t.set([n[0],n[1],n[2]]);r.set([a[0],a[1],a[2]]);i.set([s[0],s[1],s[2]]);if(this._pointsEqual(t,r)||this._pointsEqual(t,i)||this._pointsEqual(r,i)){return-2}if(e.isDegenerateTriangle(t,r,i)){return-3}var v=this._addVertex(t);var o=this._addVertex(r);var h=this._addVertex(i);var l=[h,v,o];if(v<o){if(v<h){l=[v,o,h]}}else if(o<h){l=[o,h,v]}var u=l[0]+":"+l[1]+":"+l[2];var _=this._indexSearchMap.get(u);if(_!==undefined){return _}_=this._indexSearchMap.get(l[0]+":"+l[2]+":"+l[1]);if(_!==undefined){this._triangleDoubleSidedFlag[_]=true;return _}this._indexSearchMap.set(u,this._triangleCount);var g=this._triangleCount*3;this._triangles[g]=l[0];this._triangles[g+1]=l[1];this._triangles[g+2]=l[2];this._vertexTriangleUsage[v*2+1]++;this._vertexTriangleUsage[o*2+1]++;this._vertexTriangleUsage[h*2+1]++;return this._triangleCount++};s.prototype.addLine=function(e,i){if(this._lineCount*2+2>this._lines.length){return-1}t.set([e[0],e[1],e[2]]);r.set([i[0],i[1],i[2]]);if(this._pointsEqual(t,r)){return-2}var n=this._addVertex(t);var a=this._addVertex(r);var s=n<a?[n,a]:[a,n];var v=s[0]+":"+s[1];var o=this._indexSearchMap.get(v);if(o!==undefined){return o}this._indexSearchMap.set(v,this._lineCount);var h=this._lineCount*2;this._lines[h]=s[0];this._lines[h+1]=s[1];return this._lineCount++};s.prototype._buildFaceIds=function(){var t=new Uint8Array(this._triangleCount);var r=[];var i;var n;var a;var s;var v;var o;var h;var l;var u;var _;var g;var d;var x;var c;var f;var p;var T=0;for(var y=0,V=this._triangleCount;y<V;++y){if(t[y]===0){i=this.isTriangleDoubleSided(y);n=this.computeTriangleNormal(y);this._triangleFaceId[y]=T;r.push(y);while(r.length>0){a=r.pop();t[a]=1;s=a*3;for(v=0;v<3;++v){o=this._triangles[s+v];h=this._triangles[s+(v+1)%3];l=this._triangles[s+(v+2)%3];u=this._vertexTriangleUsage[o*2];_=u+this._vertexTriangleUsage[o*2+1];for(g=u;g<_;++g){d=this._vertexTriangleIndices[g];x=false;c=d*3;for(f=0;f<3;++f){p=this._triangles[c+f];if(p===h||p===l){x=true}}if(x&&!t[d]&&this._triangleFaceId[d]!==T){this._triangleFaceId[d]=T;if(e.compareNormal(n,this.computeTriangleNormal(d),i||this.isTriangleDoubleSided(d))){r.push(d)}}}}}T++}}};s.prototype._buildEdgeIds=function(t){this._vertexToVertexEdgeId=new Int32Array(t);var r=new Uint8Array(t);var i=1;var n=new Float64Array(3);var a=new Float64Array(3);var s=new Float64Array(3);var v=new Float64Array(3);var o;var h;var l;var u;var _;var g;var d;var x;var c;var f;var p;var T;for(var y=0,V=this._vertexCount;y<V;++y){n.set(this.getVertex(y));o=this._vertexToVertexConnectivity[y*2];h=o+this._vertexToVertexConnectivity[y*2+1];for(l=o;l<h;++l){if(r[l]===0){r[l]=1;u=this._vertexToVertexIndices[l];if(u<y){this._vertexToVertexEdgeId[l]=0;continue}this._vertexToVertexEdgeId[l]=i;_=y;g=u;a.set(this.getVertex(g));e.computeEdgeDirection(n,a,s);n.set(a);for(d=0;d<2;++d){x=true;while(x){x=false;c=this._vertexToVertexConnectivity[g*2];f=c+this._vertexToVertexConnectivity[g*2+1];for(p=c;p<f;++p){T=this._vertexToVertexIndices[p];if(T!==_&&r[p]===0&&this._vertexToVertexEdgeId[p]!==i){this._vertexToVertexEdgeId[p]=i;a.set(this.getVertex(T));e.computeEdgeDirection(n,a,v);if(e.compareNormal(s,v)){_=g;g=T;r[p]=1;n.set(a);x=true;if(d>0){this._vertexToVertexEdgeId[p]=-this._vertexToVertexEdgeId[p]}break}}}}_=u;g=y;n.set(this.getVertex(y));s[0]=-s[0];s[1]=-s[1];s[2]=-s[2]}i++}}}};s.prototype._computeBoundingSpheres=function(){var t=0;var r=0;var i;var n;var a;for(var s=0,v=this._triangleCount;s<v;++s){i=this.getVertex(this._triangles[t]);n=this.getVertex(this._triangles[t+1]);a=this.getVertex(this._triangles[t+2]);e.computeTriangleBoundingSphere(i,n,a,this._triangleBoundingSphere,r);t+=3;r+=4}};s.prototype.intersectSphere=function(t,r,i,s,v,o,h){var l=a.subarray(0,3);var u=a.subarray(3,6);var _=a.subarray(6,9);var g={faceId:null,faceDistance:null,edgeId:null,edgeDistance:null,vertexId:null,vertexDistance:null};var d=null;var x=null;var c;var f;var p;var T;var y;var V;var I;var C;var w;var S;var U=r*r;var E=s||v;for(var A=0,b=this._triangleCount;A<b;++A){c=e.computePointToPointDistance(this._triangleBoundingSphere,t,A*4);if(c>r+this._triangleBoundingSphere[A*4+3]){continue}for(f=0;f<3;f++){n[f]=this._triangles[A*3+f]}l.set(this.getVertex(n[0]));u.set(this.getVertex(n[1]));_.set(this.getVertex(n[2]));if(i){p=e.getNearestPointOnTriangle(a,t);T=e.computePointToPointDistance2(p,t);if(T>U){continue}if(!g.faceDistance||T<g.faceDistance){g.faceDistance=T;g.faceId=this._triangleFaceId[A]}}if(E){for(y=0;y<3;++y){if(y===0){V=l}else if(y===1){V=u}else{V=_}if(s){I=(y+1)%3;if(I===0){C=l}else if(I===1){C=u}else{C=_}w=e.computeEdgeToPointDistance2(V,C,t);if(w<=U&&(!g.edgeDistance||w<g.edgeDistance)){g.edgeDistance=w;d=n[y];x=n[I]}}if(v){S=e.computePointToPointDistance2(V,t);if(S<=U&&(!g.vertexDistance||S<g.vertexDistance)){g.vertexDistance=S;g.vertexId=n[y]}}}}}if(g.edgeDistance!==null){g.edgeId=this.getEdgeId(d,x)}return g};s.prototype.getEdgeId=function(e,t){var r=e<t?[e,t]:[t,e];var i=this._vertexToVertexConnectivity[r[0]*2];var n=i+this._vertexToVertexConnectivity[r[0]*2+1];for(var a=i;a<n;++a){if(r[1]===this._vertexToVertexIndices[a]){var s=this._vertexToVertexEdgeId[a];return s<0?-s:s}}return null};s.prototype.buildEdgePath=function(e,t){var r=[];var i=0;var n=null;var a=null;var s;var v;var o;var h;var l;var u=-e;while(i<this._vertexCount){s=this._vertexToVertexConnectivity[i*2];v=s+this._vertexToVertexConnectivity[i*2+1];for(o=s;o<v;++o){l=this._vertexToVertexEdgeId[o];if(l===e){n=this._vertexToVertexIndices[o]}else if(l===u){a=this._vertexToVertexIndices[o]}}if(n){h=this.getVertex(i);r.push(h[0]);r.push(h[1]);r.push(h[2]);break}i++}while(n){s=this._vertexToVertexConnectivity[n*2];v=s+this._vertexToVertexConnectivity[n*2+1];h=this.getVertex(n);if(t&&r.length===6){r[3]=h[0];r[4]=h[1];r[5]=h[2]}else{r.push(h[0]);r.push(h[1]);r.push(h[2])}n=null;for(o=s;o<v;++o){if(this._vertexToVertexEdgeId[o]===e){n=this._vertexToVertexIndices[o];break}}}while(a){s=this._vertexToVertexConnectivity[a*2];v=s+this._vertexToVertexConnectivity[a*2+1];h=this.getVertex(a);if(t&&r.length===6){r[0]=h[0];r[1]=h[1];r[2]=h[2]}else{r.unshift(h[0],h[1],h[2])}a=null;for(o=s;o<v;++o){if(this._vertexToVertexEdgeId[o]===u){a=this._vertexToVertexIndices[o];break}}}return r};s.prototype.buildFace=function(t){var r=this._triangleCount;var i=this._triangleFaceId;var n=this._triangleBoundingSphere;var a=this._triangles;var s=0;var v=this._vertices;var o=[1,0,0,0];var h=new Uint32Array(this._vertexCount);var l=0;var u;for(u=0;u<r;++u){if(i[u]===t){l++}}var _=new Uint32Array(l*3);var g=new Float64Array(l*4);var d=new Set;var x;var c;var f;var p;var T;l=0;for(u=0;u<r;++u){if(i[u]===t){for(x=0;x<3;++x){f=a[u*3+x];p=h[f];if(p===0){++s;h[f]=s;p=s}_[l*3+x]=p-1}for(x=0;x<4;++x){g[l*4+x]=n[u*4+x]}for(x=0;x<3;++x){c=_[l*3+x];p=_[l*3+(x+1)%3];if(c<p){T=c+":"+p}else{T=p+":"+c}if(d.has(T)){d.delete(T)}else{d.add(T)}}if(l===0){var y=a[u*3]*3;var V=a[u*3+1]*3;var I=a[u*3+2]*3;o=e.computePlaneEquation(v,y,V,I)}l++}}var C=new Float64Array(s*3);for(u=0,l=this._vertexCount;u<l;++u){p=h[u];if(p!==0){x=(p-1)*3;c=u*3;C[x]=v[c];C[x+1]=v[c+1];C[x+2]=v[c+2]}}var w=[];d.forEach(function(e){p=e.split(":");w.push(Number(p[0]));w.push(Number(p[1]))});return{vertices:C,triangles:_,boundingSpheres:g,edges:w,planeEquation:o}};s.prototype.getTriangleCount=function(){return this._triangleCount};s.prototype.getLineCount=function(){return this._lineCount};s.prototype.getVertexCount=function(){return this._vertexCount};s.prototype.isTriangleDoubleSided=function(e){return this._triangleDoubleSidedFlag[e]>0};s.prototype.getVertex=function(e){var t=e*3;return[this._vertices[t],this._vertices[t+1],this._vertices[t+2]]};s.prototype.computeTriangleNormal=function(t){var r=this._triangles[t*3]*3;var i=this._triangles[t*3+1]*3;var n=this._triangles[t*3+2]*3;var a=[this._vertices[r],this._vertices[r+1],this._vertices[r+2]];var s=e.pointMinusPoint(this._vertices,a,i);var v=e.pointMinusPoint(this._vertices,a,n);var o=e.crossProduct(s,v);var h=e.dotProduct(o,o);if(h===0){return[1,0,0]}h=1/Math.sqrt(h);return[o[0]*h,o[1]*h,o[2]*h]};return s});