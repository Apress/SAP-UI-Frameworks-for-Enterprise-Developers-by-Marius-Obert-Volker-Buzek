/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../ContentManager","../getResourceBundle"],function(e,t){"use strict";var r=e.extend("sap.ui.vk.dvl.ContentManager",{metadata:{library:"sap.ui.vk"}});var n=r.getMetadata().getParent().getClass().prototype;r.prototype.init=function(){if(n.init){n.init.call(this)}this._handleDownloadingProgressProxy=this._handleDownloadingProgress.bind(this);this._graphicsCore=null;this._failedSources=[]};r.prototype.exit=function(){if(this._graphicsCore){this._graphicsCore.destroy();this._graphicsCore=null}if(n.exit){n.exit.call(this)}};var o={},i={antialias:true,alpha:true,premultipliedAlpha:true};r.getRuntimeSettings=function(){return o};r.setRuntimeSettings=function(e){o=e};r.getWebGLContextAttributes=function(){return i};r.setWebGLContextAttributes=function(e){i=Object.assign(i,e)};r.prototype._getGraphicsCore=function(){var e=this;return new Promise(function(t,r){if(e._graphicsCore){t(e._graphicsCore)}else{sap.ui.require(["sap/ui/vk/dvl/GraphicsCore"],function(r){r.create(o,i).then(function(r){e._graphicsCore=r;e._graphicsCore.attachSceneLoadingStarted(e._handleDvlSceneLoadingStarted,e);e._graphicsCore.attachSceneLoadingFinished(e._handleDvlSceneLoadingFinished,e);e._graphicsCore.attachSceneLoadingProgress(e._handleDvlSceneLoadingProgress,e);t(e._graphicsCore)})})}})};r.prototype._handleDownloadingProgress=function(e){var r=e.getParameter("source"),n=e.getParameter("loaded"),o=e.getParameter("total"),i=o?n/o*50:0;this.fireContentChangesProgress({phase:t().getText("PROGRESS_INDICATOR_DOWNLOADING"),source:r,percentage:i})};r.prototype._handleDvlSceneLoadingProgress=function(e){this.fireContentChangesProgress({phase:t().getText("PROGRESS_INDICATOR_RENDERING"),source:e.getParameter("source"),percentage:50+e.getParameter("percentage")*50})};r.prototype._handleDvlSceneLoadingStarted=function(e){};r.prototype._handleDvlSceneLoadingFinished=function(e){};r.prototype.loadContent=function(e,t){this.fireContentChangesStarted();var r=this;this._getGraphicsCore().then(function(n){n.setDecryptionHandler(r._decryptionHandler);n.setAuthorizationHandler(r._authorizationHandler);n.setRetryCount(r._retryCount);n.loadContentResourcesAsync(t,function(o){var i=[];if(o){o.forEach(function(e){i.push({error:e,errorMessage:"Failed to download source '"+(e.source instanceof File?e.source.name:e.source)+"'."})})}var a=e?e:undefined;n.updateSceneTreeAsync(a,t).then(function(e){var t={content:e.scene};if(e.failureReason){i=i.concat(e.failureReason)}if(i.length>0){t.failureReason=i}sap.ui.require(["sap/ui/vk/dvl/Viewport","sap/ui/vk/dvl/ViewStateManager"],function(){r.fireContentChangesFinished(t)})}).catch(function(e){if(typeof e==="string"){i.push({error:e,errorMessage:e})}else{i.push({error:e,errorMessage:e.message?e.message:e.errorMessage})}r.fireContentChangesFinished({content:null,failureReason:i})})},r._handleDownloadingProgressProxy)},function(e){r.fireContentChangesFinished({content:null,failureReason:{error:e,errorMessage:"Failed to create DVL graphics core object."}})});return this};r.prototype.destroyContent=function(e){if(e){this._graphicsCore.destroyScene(e)}return this};r.prototype.collectGarbage=function(){this._graphicsCore.collectGarbage();return this};return r});