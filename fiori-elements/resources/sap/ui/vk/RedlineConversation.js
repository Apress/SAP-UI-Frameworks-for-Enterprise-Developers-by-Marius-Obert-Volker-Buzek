/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/base/ManagedObjectObserver","sap/ui/vk/uuidv4","sap/ui/vk/RedlineElementComment"],function(e,t,n,i){"use strict";var s=e.extend("sap.ui.vk.RedlineConversation",{metadata:{library:"sap.ui.vk",properties:{conversationName:{type:"string"},timestamp:{type:"int"},viewId:{type:"string",defaultValue:""},viewInfo:{type:"any",defaultValue:null},animationOffset:{type:"float",defaultValue:0},measurementScale:{type:"float",defaultValue:1}},aggregations:{comments:{singularName:"comment",type:"sap.ui.vk.RedlineElementComment",multiple:true}}},constructor:function(t,i){e.apply(this,arguments);if(typeof t==="object"){i=t;t=undefined}this._elementId=i&&i.elementId?i.elementId:n()}});s.prototype.getElementId=function(){return this._elementId};s.prototype.addContent=function(e){if(!this._elements){this._elements=new Map}var t;var n;if(e instanceof sap.ui.vk.RedlineElement){t=e.getElementId();n=e.exportJSON()}else{t=e.elementId;n=e}this._elements.set(t,n);return this};s.prototype.removeContent=function(e){if(this._elements){var t;if(e instanceof sap.ui.vk.RedlineElement){t=e.getElementId()}else if(typeof e==="string"){t=e}else{t=e.elementId}this._elements.delete(t)}return this};s.prototype.getContent=function(){var e=[];if(this._elements){e=Array.from(this._elements.values())}return e};s.prototype.addMeasurement=function(e){if(!this._measurements){this._measurements=new Map}this._measurements.set(e.id,e);return this};s.prototype.removeMeasurement=function(e){if(this._measurements){var t;if(typeof e==="string"){t=e}else{t=e.id}this._measurements.delete(t)}return this};s.prototype.getMeasurements=function(){var e=[];if(this._measurements){e=Array.from(this._measurements.values())}return e};s.prototype._activate=function(e){var n=this;if(!this._objectObserver){var i=function(e){if(e.type==="property"){n.addContent(e.object)}};this._objectObserver=new t(i)}this._objectObserver.disconnect();e.importJSON(this.getContent());var s=e.getRedlineElements();for(var r=0;r<s.length;r++){this._objectObserver.observe(s[r],{properties:true})}};s.prototype._deactivate=function(){if(this._objectObserver){this._objectObserver.disconnect()}};s.prototype._createCommentFromJSON=function(e){var t=new i;var n=t.importJSON(e);this.addComment(t);return n};s.prototype.exportJSON=function(){if(this.getContent()){this.getContent().forEach(function(e){if(!e.createTimestamp){e.createTimestamp=Date.now()}if(e.deletedByUser){e.deleteTimestamp=Date.now()}})}var e={conversationId:this.getElementId(),conversationName:this.getConversationName(),timestamp:this.getTimestamp()?this.getTimestamp():Date.now(),sceneView:this.getViewId(),viewInfo:this.getViewInfo(),animationOffset:this.getAnimationOffset(),measurementScale:this.getMeasurementScale(),comments:this.getComments().map(function(e){return e.exportJSON()}),content:this.getContent(),measurements:this.getMeasurements()};return e};s.prototype.importJSON=function(e){var t=new Set;if(e.hasOwnProperty("conversationId")){this._elementId=e.conversationId}if(e.hasOwnProperty("conversationName")){this.setConversationName(e.conversationName)}if(e.hasOwnProperty("timestamp")){this.setTimestamp(e.timestamp)}if(e.hasOwnProperty("sceneView")){this.setViewId(e.sceneView)}if(e.hasOwnProperty("viewInfo")){this.setViewInfo(e.viewInfo)}if(e.hasOwnProperty("animationOffset")){this.setAnimationOffset(e.animationOffset)}if(e.hasOwnProperty("measurementScale")){this.setMeasurementScale(e.measurementScale)}if(e.hasOwnProperty("comments")){var n=e.comments;if(n){for(var i=0;i<n.length;i++){var s=this._createCommentFromJSON(n[i]);if(s){t.add(s)}}}}if(e.hasOwnProperty("content")){var r=e.content;if(r){for(var a=0;a<r.length;a++){var o=r[a].createdByUser;if(o){t.add(o)}var m=r[a].deletedByUser;if(m){t.add(m)}this.addContent(r[a])}}}if(e.hasOwnProperty("measurements")){var f=e.measurements;if(f){for(var p=0;p<f.length;p++){this.addMeasurement(f[p])}}}return t};return s});