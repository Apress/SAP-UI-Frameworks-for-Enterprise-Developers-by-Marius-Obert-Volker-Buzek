/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./CallbackHandler","./TotaraUtils","./GeometryFactory","./ProgressCounter","./RequestQueue","../getResourceBundle","../AnimationRotateType"],function(e,i,t,s,r,a,n,o){"use strict";var h=function(e,t,s){this.root=null;this.onActiveCameraCallbacks=new i;this.onInitialSceneFinishedCallbacks=new i;this.onPartialRetrievalFinishedCallbacks=new i;this.onSceneCompletedCallbacks=new i;this.onSetPlaybackCallbacks=new i;this.onViewFinishedCallbacks=new i;this.onViewGroupFinishedCallbacks=new i;this.onContentChangesProgressCallbacks=new i;this.onInitialViewCompletedCallbacks=new i;Object.assign(this,t);this.sceneId=e;this.loader=s;this.sceneBuilder=s.sceneBuilder;this.requestQueue=new a(this,e);this.phase=h.Phase.Started;this.retrievalType=h.RetrievalType.Initial;this.rootNodeId=null;this.meshNodes=new Map;this.parametricNodeMap=new Map;this.annotationNodeMap=new Map;this.leaderLineMaterialIdMap=new Map;this.imageNoteMaterialIdMap=new Map;this.thumbnailViewMap=new Map;this.viewThumbnailMap=new Map;this.viewAnimatedThumbnailMap=new Map;this.progressCount=new r;this.treeNodes=[];this.viewIdTreeNodesMap=new Map;this.viewIdBoxMap=new Map;this.nodeSidsForPartialTree=new Set;this.replacedNodes=new Map;this.updatedNodes=new Set;this.currentViewId=null;this.initialViewId=null;this.initialViewDecided=false;this.initialViewFired=false;this.eventObject={};this.eventObject.percentage=0;this.loadingGeometry=0};h.Phase={Started:0,FinishedHierarchy:1,FinishedMesh:2,FinishedGeometry:3};h.RetrievalType={Initial:0,Partial:1};h.ProgressPhase={FinishedTree:n().getText("SCENE_CONTEXT_FINISHED_TREE"),FinishedMeshes:n().getText("SCENE_CONTEXT_FINISHED_MESHES"),FinishedMaterials:n().getText("SCENE_CONTEXT_FINISHED_MATERIALS"),FinishedGeomMeshes:n().getText("SCENE_CONTEXT_FINISHED_GEOMETRIES"),LoadingGeomMeshes:n().getText("SCENE_CONTEXT_LOADING_GEOMETRIES"),FinishedTextures:n().getText("SCENE_CONTEXT_FINISHED_TEXTURES")};h.prototype.setOnProgressChanged=function(e){this.progressCount.setOnProgressChanged(e)};h.prototype.isLoadingFinished=function(){if(!this.requestQueue.isEmpty()||this.requestQueue.isWaitingForContent()||this.thumbnailViewMap.size>0||this.viewThumbnailMap.size>0||this.viewAnimatedThumbnailMap.size>0||this.meshNodes.size>0||this.annotationNodeMap.size>0||this.parametricNodeMap.size>0||this.leaderLineMaterialIdMap.size>0||this.imageNoteMaterialIdMap.size>0||this.viewIdTreeNodesMap.size>0||this.nodeSidsForPartialTree.size>0){return false}return true};h.prototype.isSceneCompleted=function(){return!this.requestQueue.meshes.isWaiting()&&!this.requestQueue.annotations.isWaiting()&&!this.requestQueue.materials.isWaiting()&&!this.requestQueue.parametric.isWaiting()&&!this.requestQueue.geomMeshes.isWaiting()&&!this.requestQueue.geometries.isWaiting()&&!this.requestQueue.textures.isWaiting()};h.prototype.isInitialViewCompleted=function(){var e=this.requestQueue.textures.isInitialViewCompleted();var i=this.requestQueue.meshes.isInitialViewCompleted();var t=this.requestQueue.geomMeshes.isInitialViewCompleted();return e&&i&&t};h.prototype._checkSceneCompletion=function(){if(!this.initialViewFired&&this.isInitialViewCompleted()){e.info("initialView completed.");this.initialViewFired=true;this.onInitialViewCompletedCallbacks.execute()}if(this.isSceneCompleted()){if(this.eventObject.percentage<100){this.eventObject.percentage=100;this.onContentChangesProgressCallbacks.execute(this.eventObject)}this.onSceneCompletedCallbacks.execute();e.info("Scene completed.");t.mark("sceneCompleted");this.logPerformance("sceneCompleted")}};h.prototype._fireProgress=function(e){switch(e){case h.ProgressPhase.FinishedTree:this.eventObject.percentage+=10;this.eventObject.phase=h.ProgressPhase.FinishedTree;this.onContentChangesProgressCallbacks.execute(this.eventObject);break;case h.ProgressPhase.FinishedMeshes:if(!this.requestQueue.meshes.isWaiting()){this.eventObject.percentage+=10;this.eventObject.phase=h.ProgressPhase.FinishedMeshes;this.onContentChangesProgressCallbacks.execute(this.eventObject)}break;case h.ProgressPhase.FinishedMaterials:if(!this.requestQueue.materials.isWaiting()){this.eventObject.percentage+=10;this.eventObject.phase=h.ProgressPhase.FinishedMaterials;this.onContentChangesProgressCallbacks.execute(this.eventObject)}break;case h.ProgressPhase.LoadingGeomMeshes:this.eventObject.percentage+=61*(1/this.requestQueue.geomMeshes.globalList.size);if(this.eventObject.percentage>100){this.eventObject.percentage=100}this.loadingGeometry+=61*(1/this.requestQueue.geomMeshes.globalList.size);if(this.loadingGeometry>=60){this.eventObject.phase=h.ProgressPhase.FinishedGeomMeshes}else{this.eventObject.phase=h.ProgressPhase.LoadingGeomMeshes}this.onContentChangesProgressCallbacks.execute(this.eventObject);break;case h.ProgressPhase.FinishedTextures:if(!this.requestQueue.textures.isWaiting()){this.eventObject.percentage+=10;this.eventObject.phase=h.ProgressPhase.FinishedTextures;this.onContentChangesProgressCallbacks.execute(this.eventObject)}break;default:}};h.prototype.dispose=function(){this.sceneId=null;this.progressCount=null;this.requestQueue=null;this.suppressedBoundingBoxListMap=null;this.treeNodes=null;this.nodeSidsForPartialTree=null;this.meshNodes=null;this.annotationNodeMap=null;this.parametricNodeMap=null;this.leaderLineMaterialIdMap=null;this.imageNoteMaterialIdMap=null;this.thumbnailViewMap=null;this.viewThumbnailMap=null;this.viewAnimatedThumbnailMap=null;this.replacedNodes=null;this.updatedNodes=null;this.viewIdTreeNodesMap=null;this.viewIdBoxMap=null;this.onActiveCameraCallbacks=null;this.onInitialSceneFinishedCallbacks=null;this.onPartialRetrievalFinishedCallbacks=null;this.onSceneCompletedCallbacks=null;this.onViewFinishedCallbacks=null;this.onSetPlaybackCallbacks=null;this.onContentChangesProgressCallbacks=null;this.onInitialViewCompletedCallbacks=null};h.prototype.logPerformance=function(e){if(this.progressLogger&&this.token){this.progressLogger.logPerformance(e,this.token)}};h.prototype.setCameraSingle=function(e){this.sceneBuilder.createCamera(e,this.sceneId);return this.sceneBuilder.getCamera(e.id)};h.prototype.getPartialTreeNodes=function(e){var i=[];var t=[];var s,r,a;if(e&&e.length){for(s=0;s<e.length;s++){a=e[s];if(a==null){continue}if(a&&a.children){if(a.entityId!=null&&a.children.length===1){var n=e[a.children[0]];if(n.entityId==null){n.visualisable=false;if(n.visible===false){a.visible=false}else if(a.visible===false){n.visible=false}}}if(a.children){for(r=0;r<a.children.length;r++){var o=a.children[r];e[o].parentNode=a;if(a.renderOrder){e[o].renderOrder=a.renderOrder}}}}}for(s=0;s<e.length;s++){a=e[s];if(a==null){continue}if(a.parent){i.push(a)}else if(!a.parentNode){i.push(a);if(this.rootNodeId){a.parent=this.rootNodeId}}if(this.nodeSidsForPartialTree.has(a.sid)){t.push(a)}}}this.nodeSidsForPartialTree.clear();if(!t.length){return i}i=[];for(r=0;r<t.length;r++){var h=t[r];var l=h.parentNode;while(l){if(this.sceneBuilder.getNode(l.sid,this.sceneId)){h.parent=l.sid;i.push(h);break}else{h=l;l=l.parentNode}}}return i.length?i:t};h.prototype.buildTree=function(e){var i={};if(!this.treeNodes||!this.treeNodes.length){i.error="no tree information";return i}var t=this.treeNodes;var s=this.getPartialTreeNodes(t);this.replacedNodes.clear();var r=[];var a;var n;for(a=0;a<s.length;a++){n=s[a].parent;if(this.sceneBuilder.getNode(n,this.sceneId)){this.buildNode(s[a],n,true,e)}else{r.push(s[a])}}for(a=0;a<r.length;a++){n=r[a].parent;if(this.sceneBuilder.getNode(n,this.sceneId)){this.buildNode(s[a],n,true,e)}else{i.error=(i.error||"")+"parent ${parentSid} does not exist in the scene. \n"}}if(this.retrievalType===h.RetrievalType.Partial){this.sceneBuilder.updateViewsForReplacedNodes(this.treeNodes)}this.treeNodes=[];this.progressCount.mesh.total=this.requestQueue.meshes.globalList.size;return i};h.prototype.buildNode=function(e,i,s,r){if(!e||!i){this.loader.reportError(this,"SceneContext - buildNode - invalid args");return null}var a=this.sceneBuilder.getNode(e.sid,this.sceneId);if(a){this.sceneBuilder.remove(e.sid,this.sceneId)}if(e.suppressed===true){return null}if(!e.sid){this.loader.reportError(this,"sid is missing in treeNode");return null}e.parentId=i;this.sceneBuilder.createNode(e,this.sceneId);var n=e.parametricId;var o=e.meshId;if(n&&o){if(this.sceneBuilder.preferMeshes()){n=null}else{o=null}}if(n){if(this.parametricNodeMap.get(n)==null){this.parametricNodeMap.set(n,[e.sid]);this.requestQueue.parametric.push(n)}else{this.parametricNodeMap.get(n).push(e.sid)}}else if(o&&!this.sceneBuilder.hasMesh(o)){t.pushElementIntoMapArray(this.meshNodes,o,e.sid);if(this.loader.getSkipLowLODRendering()){this.requestQueue.geomMeshes.push(o,null,null,{id:o,isInitial:r})}else{this.requestQueue.meshes.push(o,{id:o,isInitial:r})}}if(e.annotationId&&!this.sceneBuilder.hasAnnotation(e.annotationId)){this._requestAnnotationForNode(e.annotationId,e.sid)}var h=this.sceneBuilder.getNode(e.sid,this.sceneId);if(a&&h){this.replacedNodes.set(a,h)}if(s&&e.children){for(var l=0;l<e.children.length;l++){this.buildNode(this.treeNodes[e.children[l]],e.sid,s,r)}}return h};h.prototype.setTree=function(e){if(e.sid){var i=this.sceneBuilder.getNode(e.sid,this.sceneId);if(!i||i!==this.root){var s=this.root;s.userData.treeNode={sid:e.sid,name:this.root.name?this.root.name:"root"};s.userData.skipIt=!this.root.name;this.sceneBuilder.setRootNode(s,e.sid,this.sceneId,this.vkScene);this.rootNodeId=e.sid}}if(e.camera){e.camera.id="initial";var r=this.setCameraSingle(e.camera);if(r){this.onActiveCameraCallbacks.execute(r)}}t.measure("setTreeMeasure-"+this.sceneId,"setTree-"+this.sceneId)};h.prototype.setTreeNode=function(e){if(!Array.isArray(e.nodes)){return{error:"setTreeNode error: nodes are not properly defined"}}this.treeNodes=this.treeNodes.concat(e.nodes);return{}};h.prototype.suppressSendRequests=function(){this.loader.setSuppressSendRequests(true)};h.prototype.unsuppressSendRequests=function(){this.loader.setSuppressSendRequests(false);this.loader.sendRequest(this.requestQueue)};h.prototype.notifyFinishedTree=function(e,i){this.buildTree(i);this.phase=h.Phase.FinishedHierarchy;this._fireProgress(h.ProgressPhase.FinishedTree);if(this.retrievalType===h.RetrievalType.Initial){this.onInitialSceneFinishedCallbacks.execute(this.initialView)}else if(this.retrievalType===h.RetrievalType.Partial){this.onPartialRetrievalFinishedCallbacks.execute()}this._checkSceneCompletion()};h.prototype.setViewGroup=function(e){this.sceneBuilder.insertViewGroup(e,this.sceneId);if(!Array.isArray(e.views)){return}var i=e.id;var s,r;if(!this.currentViewGroupId){if(this.currentViewId){for(s=0;s<e.views.length;s++){r=e.views[s];if(r.id===this.currentViewId){this.currentViewGroupId=i;break}}}else{this.currentViewGroupId=i}}if(this.currentViewGroupId!==i){return}if(!this.currentViewId){this.currentViewId=e.views[0].id}for(s=0;s<e.views.length;s++){r=e.views[s];var a=this.sceneBuilder.getView(r.id,this.sceneId);for(var n=0;n<2;n++){var o=["thumbnailId","animatedThumbnailId"][n];var h=r[o];if(h!==undefined){r[o]=h=h.toString();if(this.sceneBuilder.hasImage(h)){this.sceneBuilder.setViewThumbnail(h,r.id,this.sceneId);this.loader.onViewGroupUpdatedCallbacks.execute()}else{this.thumbnailViewMap.set(h,r.id);this.requestQueue.thumbnails.push(h,{imageId:h,viewId:r.id})}if(!a){this[["viewThumbnailMap","viewAnimatedThumbnailMap"][n]].set(r.id,h)}}}if(a){a.userData.viewInfo.thumbnailId=r.thumbnailId;a.userData.viewInfo.animatedThumbnailId=r.animatedThumbnailId;continue}this.requestQueue.views.push(r.id,{viewId:r.id,viewGroupId:i})}if(!this.requestQueue.views.isWaiting()){this.sceneBuilder.finalizeViewGroups(this.sceneId);this.loader.onViewGroupUpdatedCallbacks.execute();if(this.requestQueue.sequences.isEmpty()){this.onViewGroupFinishedCallbacks.execute()}}t.measure("setViewGroupMeasure-"+i,"setViewGroup-"+i)};h.prototype.setView=function(e){var i=e.viewId;this.viewIdBoxMap.set(i!==undefined?i:"default",e.box);if(!i){this.setTree(e);this.initialViewDecided=true;return}if(!this.initialViewId&&!this.initialViewDecided){this.initialViewId=i;this.currentViewId=i;this.initialViewDecided=true}var s;if(this.initialViewId===i){if(e.camera){s=e.camera.id}this.setTree(e)}var r=this.viewThumbnailMap.get(i);if(r){this.viewThumbnailMap.delete(i);e.thumbnailId=r}var a=this.viewAnimatedThumbnailMap.get(i);if(a){this.viewAnimatedThumbnailMap.delete(i);e.animatedThumbnailId=a}this.sceneBuilder.insertView(e,this.sceneId);var n=this.sceneBuilder.getView(e.viewId,e.sceneId);if(n&&this.initialViewId===e.viewId){this.initialView=n}var o=[];this.viewIdTreeNodesMap.set(i,o);this.viewIdBoxMap.set(i,e.box);if(e.camera){if(s){e.camera.id=s}this.setCameraSingle(e.camera);this.sceneBuilder.setViewCamera(e.camera.id,i,this.sceneId)}this.logPerformance("setView");t.measure("setViewMeasure-"+i,"setView-"+i)};h.prototype.setViewNode=function(e,i,t){var s={context:this};if(!e.viewId){this.setTreeNode(e,t);return s}if(this.initialViewId===e.viewId){this.setTreeNode(e,t)}var r=this.sceneBuilder.getView(e.viewId,e.sceneId);if(!r){s.error="setViewNode error: setViewNode - no setView was in the chain";return s}if(this.initialViewId===e.viewId){this.initialView=r}var a=this.viewIdTreeNodesMap.get(e.viewId);a=a.concat(e.nodes);this.viewIdTreeNodesMap.set(e.viewId,a);return s};h.prototype.notifyFinishedView=function(e){var i=e.viewId;if(!i){return this.notifyFinishedTree(e)}this.requestQueue.views.pop(i);if(this.initialViewId===i){this.notifyFinishedTree(e,true);this.initialViewId=null}var t=this.sceneBuilder.getView(i,this.sceneId);if(!t){return{error:"notifyFinishedView error: setViewNode - no setView was in the chain"}}if(t.activeCameraId!==undefined){t.setCamera(this.sceneBuilder.getCamera(t.activeCameraId))}this.updatedNodes.clear();var s=this.buildView(i);this.sceneBuilder.setViewNodeInfos(s.nodeInfos,i,this.sceneId);t.updatedNodes=Array.from(this.updatedNodes);if(!this.requestQueue.views.isWaiting()){this.sceneBuilder.finalizeViewGroups(this.sceneId);this.loader.onViewGroupUpdatedCallbacks.execute();if(this.requestQueue.sequences.isEmpty()){this.onViewGroupFinishedCallbacks.execute()}}this.onViewFinishedCallbacks.execute(t);this.logPerformance("notifyFinishedView")};h.prototype.buildView=function(e){var i={};this.treeNodes=this.viewIdTreeNodesMap.get(e);var t=this.getPartialTreeNodes(this.treeNodes);var s=[];for(var r=0;r<t.length;r++){var a=t[r].parent;this.processNodeRecursively(e,t[r],s,a,true)}i.nodeInfos=s;this.treeNodes=[];this.viewIdTreeNodesMap.delete(e);return i};h.prototype.processNodeRecursively=function(e,i,s,r,a){var n=this.sceneBuilder.getNode(i.sid,this.sceneId);var o="annotationId"in i?i.annotationId:null;if(o!=null&&n!=null&&n.userData.annotationType==="html"&&!this.sceneBuilder.hasAnnotation(o)){this._requestAnnotationForNode(o,i.sid)}if(!n){n=this.buildNode(i,r,false);if(!n){return}n.visible=false}if(i.materialId){this._checkIfNeededAndOrderMaterial(i.materialId,true)}var h=i.visible==undefined?true:i.visible;s.push({target:n,visible:h,materialId:i.materialId,opacity:i.opacity,meshId:i.meshId,annotationId:i.annotationId,transform:Array.isArray(i.transform)?t.arrayToColumnMajorMatrixArray16(i.transform):[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]});var l=this.treeNodes;var d=this.sceneBuilder.getChildNodeIds(i.sid,this.sceneId);var u=i.children?i.children.map(function(e){return l[e].sid}):[];var c;var p;for(p=0;p<d.length;p++){c=d[p];for(var f=0;f<u.length;f++){if(c===u[f]){d[p]=undefined;break}}}for(p=0;p<d.length;p++){var g=d[p];if(g!==undefined){var I=this.sceneBuilder.getNode(g,this.sceneId);var m=false;s.push({target:I,visible:m})}}if(i.children){for(p=0;p<i.children.length;p++){this.processNodeRecursively(e,l[i.children[p]],s,i.sid,h)}}if(i.highlightStyleId){this.sceneBuilder.recordHighlightedNodeInView(i.highlightStyleId,i.sid,e,this.sceneId);if(!this.sceneBuilder.highlightStyleExists(i.highlightStyleId)){this.requestQueue.highlights.push(i.highlightStyleId)}}};h.prototype.setAnnotationSingle=function(e){var i=this.annotationNodeMap.get(e.id)||[];this.annotationNodeMap.delete(e.id);var s=function(i){var s=JSON.parse(JSON.stringify(e));if(i){s.nodeId=i}if(s.detailView||s.cutaway){this.sceneBuilder.createDetailView(s,this.sceneId)}else if(s.labelMaterialId||s.label&&s.label.materialId){var r=s.labelMaterialId||s.label.materialId;if(this.sceneBuilder.checkMaterialExists(r,false)){this.sceneBuilder.createImageNote(s,this.sceneId);this.loader.onAnnotationFinishedCallbacks.execute(s.id)}else{this.requestQueue.materials.push(r);t.pushElementIntoMapArray(this.imageNoteMaterialIdMap,r,s)}}else{this.sceneBuilder.createAnnotation(s,this.sceneId);var a=s.leaderLines;if(a){for(var n=0,o=a.length;n<o;n++){var h=a[n];h.annotationId=s.id;if(this.sceneBuilder.checkMaterialExists(h.materialId,false)){this.sceneBuilder.insertLeaderLine(h,this.sceneId)}else{this.requestQueue.materials.push(h.materialId);t.pushElementIntoMapArray(this.leaderLineMaterialIdMap,h.materialId,h)}}}}}.bind(this);if(i.length>0){for(var r=0;r<i.length;r++){s(i[r])}}else{s()}this.requestQueue.annotations.pop(e.id)};h.prototype.setCamera=function(e){if(!Array.isArray(e.cameras)){return{error:"setCamera error: cameras are not properly defined"}}e.cameras.forEach(this.setCameraSingle.bind(this))};h.prototype.allocateMeshBuffer=function(e){var i=e.meshes;for(var t=0,s=i.length;t<s;++t){var r=i[t];var a=r.id;if(!this.sceneBuilder.hasMesh(a)){var n,o,h;this.meshNodes.delete(a);if(Array.isArray(r.submeshes)){for(n=0;n<r.submeshes.length;n++){o=r.submeshes[n];o.meshId=a;this._checkIfNeededAndOrderMaterial(o.materialId,true);h=this.viewIdBoxMap.has(this.currentViewId)?this.viewIdBoxMap.get(this.currentViewId):this.viewIdBoxMap.get("default");this.sceneBuilder.insertSubmesh(o,h)}}this.progressCount.mesh.count++}}};h.prototype.setMesh=function(e,i){var s=e.meshes;if(!Array.isArray(s)){return{error:"setMesh error: meshes are not properly defined"}}var r=this.requestQueue.geomMeshes;s.forEach(function(e){r.pop(e.id)});if(i){var a=new DataView(i.buffer,i.byteOffset,i.byteLength);var n=a.getUint16(2,true),o=0;while(n-- >0&&o<i.byteLength){var h={sceneId:this.sceneId,id:a.getUint32(o+4,true).toString(),box:[a.getFloat32(o+14,true),a.getFloat32(o+18,true),a.getFloat32(o+22,true),a.getFloat32(o+26,true),a.getFloat32(o+30,true),a.getFloat32(o+34,true)]};var l=a.getUint16(o+12,true);o+=38;if(l!==3){h.flags=a.getUint16(o,true);h.quality=a.getFloat32(o+4,true);h.pointCount=a.getUint16(o+8,true);h.elementCount=a.getUint16(o+10,true);h.encodingType=a.getUint16(o+12,true);o+=14}var d=a.getUint32(o,true);var u=i.subarray(o+4,o+4+d);o+=d;this.setGeometry(h,u)}}t.measure("setMeshMeasure-"+this.sceneId,"setMesh-"+this.sceneId);this._checkSceneCompletion()};h.prototype.setMaterialSingle=function(e,i){var t=e.id;this.requestQueue.materials.pop(t);var s;var r=this.sceneBuilder.createMaterial(e);for(s=0;s<r.length;s++){var a=r[s].imageId;this.requestQueue.textures.push(a,{imageId:a,materialId:t,isInitial:i})}var n=this.leaderLineMaterialIdMap.get(t);if(n){this.leaderLineMaterialIdMap.delete(t);for(s=0;s<n.length;s++){this.sceneBuilder.insertLeaderLine(n[s],this.sceneId)}}var o=this.imageNoteMaterialIdMap.get(t);if(o){this.imageNoteMaterialIdMap.delete(t);for(s=0;s<o.length;s++){this.sceneBuilder.createImageNote(o[s],this.sceneId)}}this.loader.onMaterialFinishedCallbacks.execute(t)};h.prototype.setMaterial=function(e,i,s){if(!Array.isArray(e.materials)){return{error:"setMaterial error: materials are not properly defined"}}e.materials.forEach(function(e){this.setMaterialSingle(e,s)}.bind(this));t.measure("setMaterialMeasure-"+this.sceneId,"setMaterial-"+this.sceneId);this._fireProgress(h.ProgressPhase.FinishedMaterials);this._checkSceneCompletion()};h.prototype.setGeometry=function(e,i){var r=e.id;this.requestQueue.geometries.pop(r);if(e.data&&!i){i=t.base64ToUint8Array(e.data)}if(!i||i.length===0){return{error:"setGeometry error: no data for geometry "+r}}var a=s.getGeometryInfo(e,i);if(!a){return{error:"setGeometry error: failed to parse geometry "+r+" data"}}this.sceneBuilder.setGeometry(a);this.loader.onSetGeometryCallbacks.execute({id:r});if(!this.requestQueue.geometries.isWaiting()){this.phase=h.Phase.FinishedGeometry;this.logPerformance("geometryFinished")}this.progressCount.geometry.count++;t.measure("setGeometryMeasure-"+r,"setGeometry-"+r)};h.prototype.setImage=function(i,s){var r=i.id;if(!s){return{error:"setImage error: no image content for "+r}}i.binaryData=s;this.sceneBuilder.createImage(i);if(this.requestQueue.textures.pop(r)){e.info("Received texture image id: "+r);this.loader.onImageFinishedCallbacks.execute({id:r});this._fireProgress(h.ProgressPhase.FinishedTextures);this._checkSceneCompletion()}else if(this.requestQueue.thumbnails.pop(r)){var a=this.thumbnailViewMap.get(r);if(a){this.thumbnailViewMap.delete(r);this.sceneBuilder.setViewThumbnail(r,a,this.sceneId,i.tileWidth);this.loader.onViewGroupUpdatedCallbacks.execute()}}t.measure("setImageMeasure-"+r,"setImage-"+r)};h.prototype.setAnnotation=function(e){if(!Array.isArray(e.annotations)){return{error:"setAnnotation error: annotations are not properly defined"}}e.annotations.forEach(this.setAnnotationSingle,this);this._checkSceneCompletion()};h.prototype.setHighlightStyle=function(e){e.id=e.id.toString();this.sceneBuilder.insertHighlightStyle(e);this.requestQueue.highlights.pop(e.id)};h.prototype.setLineStyle=function(e){e.lineStyles.forEach(function(e){this.sceneBuilder.insertLineStyle(e)},this)};h.prototype.setFillStyle=function(e){e.fillStyles.forEach(function(e){this.sceneBuilder.insertFillStyle(e)},this)};h.prototype.setTextStyle=function(e){e.textStyles.forEach(function(e){this.sceneBuilder.insertTextStyle(e)},this)};h.prototype._checkIfNeededAndOrderMaterial=function(e,i,t){if(e&&this.sceneBuilder.materialNeeded(t)&&this.sceneBuilder.checkMaterialExists(e,i)===false){this.requestQueue.materials.push(e)}};h.prototype.setParametric=function(e){for(var i=0;i<e.parametrics.length;i++){var t=e.parametrics[i];var s=t.id.toString();var r=this.parametricNodeMap.get(s);this.requestQueue.parametric.pop(s);this.parametricNodeMap.delete(s);for(var a=0;r&&a<r.length;a++){if(t.shapes!=null){for(var n=0;n<t.shapes.length;n++){this._checkIfNeededAndOrderMaterial(t.shapes[n].materialID,false,t)}}else{this._checkIfNeededAndOrderMaterial(t.materialID,false,t)}this.sceneBuilder.setParametricContent(r[a],t,this.sceneId)}}this._checkSceneCompletion()};h.prototype.setPlayback=function(e){if(!Array.isArray(e.playbacks)){return{error:"setPlayback error: playbacks are not properly defined"}}var i=this.sceneBuilder.getView(e.viewId,this.sceneId);var t=false;var s,r;if(this.playbackIds){for(s=0;s<e.playbacks.length;s++){r=e.playbacks[s];for(var a=0;a<this.playbackIds.length;a++){if(r.id===this.playbackIds[a]){r.notLoading=false;break}}if(r.notLoading===undefined){r.notLoading=true}}delete this.playbackIds;t=true;if(!i.sortPlaybacks(true)){i.resetPlaybacksStartTimes(true)}}if(Array.isArray(e.joints)){this.sceneBuilder.insertJoints(e.joints,this.sceneId)}for(s=0;s<e.playbacks.length;s++){r=e.playbacks[s];if(r.notLoading){continue}if(r.id==null){r.id=e.viewId+"-playback";r.sequence.id=e.viewId+"-cont";r.sequenceId=r.sequence.id;this.setSequence({sequences:[r.sequence]})}this.sceneBuilder.insertPlayback(r,e.viewId,this.sceneId);if(r.sequenceId){var n=this.sceneBuilder.getSequence(r.sequenceId);if(n){continue}else{this.requestQueue.sequences.push(r.sequenceId)}}}if(!this.requestQueue.sequences.isEmpty()){this.loader.hasAnimation=true}else{this.sceneBuilder.finalizeAnimation();this.sceneBuilder.finalizePlaybacks();this.loader.hasAnimation=false;if(t){this.onSetPlaybackCallbacks.execute(i)}}};h.prototype.setSequenceSingle=function(e,i){var t=e.id;this.requestQueue.sequences.pop(t);function s(e){for(var i in e){if(e.hasOwnProperty(i)){return false}}return true}if(e.nodes){var r=[];for(var a=0;a<e.nodes.length;a++){var n=e.nodes[a];var o=n.rrotate||n.rotate;if(o){var h={};if(o.trackId){h.trackId=o.trackId}else if(i&&o.track!==undefined){h.trackId=i[o.track].id}if(h.trackId){if(!i){this.requestQueue.tracks.push(h.trackId)}}h.sid=n.sid;h.binding="ROTATE";if(o.pivot){h.pivot=o.pivot}if(n.rotate){h.isAbsoluteValue=true}if(s(o)){h.empty=true}r.push(h)}var l=n.rtranslate||n.translate;if(l){var d={};if(l.trackId){d.trackId=l.trackId}else if(i&&l.track!==undefined){d.trackId=i[l.track].id}if(d.trackId){if(!i){this.requestQueue.tracks.push(d.trackId)}}d.sid=n.sid;d.binding="TRANSLATE";if(l.pivot){d.pivot=l.pivot}if(n.translate){d.isAbsoluteValue=true}if(s(l)){d.empty=true}r.push(d)}var u=n.rscale||n.scale;if(u){var c={};if(u.trackId){c.trackId=u.trackId}else if(i&&u.track!==undefined){c.trackId=i[u.track].id}if(c.trackId){if(!i){this.requestQueue.tracks.push(c.trackId)}}c.sid=n.sid;c.binding="SCALE";if(u.pivot){c.pivot=u.pivot}if(n.scale){c.isAbsoluteValue=true}if(s(u)){c.empty=true}r.push(c)}if(n.opacity!==undefined||n.ropacity!==undefined){var p;if(n.opacity){p=n.opacity}else{p=n.ropacity}var f={};if(p.trackId){f.trackId=p.trackId}else if(i&&p.track!==undefined){f.trackId=i[p.track].id}if(f.trackId){if(!i){this.requestQueue.tracks.push(f.trackId)}}f.sid=n.sid;f.binding="OPACITY";if(n.opacity){f.isAbsoluteValue=true}if(s(p)){f.empty=true}r.push(f)}}e.nodes=r}this.sceneBuilder.insertSequence(e,this.sceneId)};h.prototype.setSequence=function(e){if(!Array.isArray(e.sequences)){return{error:"setSequence error: sequences are not properly defined"}}if(Array.isArray(e.joints)){this.sceneBuilder.insertJoints(e.joints,this.sceneId)}for(var i=0;i<e.sequences.length;i++){this.setSequenceSingle(e.sequences[i],e.tracks)}if(e.tracks){this.setTrack(e)}if(this.requestQueue.tracks.isEmpty()){this.loader.hasAnimation=false;this.loader.onSetSequenceCallbacks.execute();if(!this.requestQueue.views.isWaiting()){this.onViewGroupFinishedCallbacks.execute()}}};h.prototype.setTrack=function(e){if(!Array.isArray(e.tracks)){return{error:"setTrack error: tracks are not properly defined"}}var i=[];for(var t=0;t<e.tracks.length;t++){var s=e.tracks[t];this.requestQueue.tracks.pop(s.id);s.times=s.time;if(s.vector3){s.values=s.vector3}else if(s.quaternion){s.values=s.quaternion;s.rotateType=o.Quaternion}else if(s.angleAxis){s.values=s.angleAxis;s.rotateType=o.AngleAxis}else if(s.euler){s.values=s.euler;s.rotateType=o.Euler}else if(s.scalar){s.values=s.scalar}s.cyclicInfo={};s.cyclicInfo.cyclicStart=s.cyclicStart;s.cyclicInfo.cyclicEnd=s.cyclicEnd;i.push(s)}this.sceneBuilder.insertTracks(i);if(!this.requestQueue.tracks.isWaiting()){this.sceneBuilder.finalizeAnimation();this.sceneBuilder.finalizePlaybacks();this.loader.onSetTrackCallbacks.execute();if(!this.requestQueue.views.isWaiting()&&!this.requestQueue.sequences.isWaiting()){this.onViewGroupFinishedCallbacks.execute()}}};h.prototype.notifyError=function(e){if(!e.error){e.error="Unknown error"}return e};h.prototype._requestAnnotationForNode=function(e,i){var t=this.annotationNodeMap.get(e);if(t==null){this.annotationNodeMap.set(e,[i]);this.requestQueue.annotations.push(e)}else if(!t.includes(i)){t.push(i)}return this};return h});