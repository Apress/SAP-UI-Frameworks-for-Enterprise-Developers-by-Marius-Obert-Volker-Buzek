/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/Object","./AnimationTrackType","./findIndexInArray","./AnimationPlayer","./AnimationTrack","./Core"],function(t,e,n,i,a,o){"use strict";var s=t.extend("sap.ui.vk.AnimationSequence",{constructor:function(t,e){this._jsonData={};this._jsonData.id=t;this._jsonData.name=e&&e.name?e.name:"";this._jsonData.duration=e&&e.duration?e.duration:1;this._jsonData.joints=[];this._jsonData.nodes=[];this._trackMap=new Map}});s.prototype.setJSONModel=function(t){this._model=t;return this};s.prototype.getId=function(){return this._jsonData.id};s.prototype.getName=function(){return this._jsonData.name};s.prototype.setName=function(t){this._jsonData.name=t;if(this._model){this._model.updateBindings()}return this};s.prototype.getDuration=function(){return this._jsonData.duration};s.prototype.setDuration=function(t,e){this._jsonData.duration=t;if(this._model){this._model.updateBindings()}if(!e){this._fireSequenceChanged()}return this};s.prototype._findJointIndex=function(t,e){var i=this._jsonData.joints.filter(function(t){return t.node&&t.parent});return n(i,function(n){return(t?n.parent==t:true)&&(e?n.node==e:true)})};s.prototype.setJoint=function(t,e){if(!Array.isArray(t)){t=[t]}t.forEach(function(t){var e=this._findJointIndex(t.parent,t.node);if(e<0){if(!t.parentSid&&t.parent&&t.parent.userData&&t.parent.userData.treeNode){t.parentSid=t.parent.userData.treeNode.sid}if(!t.nodeSid&&t.node&&t.node.userData&&t.node.userData.treeNode){t.nodeSid=t.node.userData.treeNode.sid}t.type="RELATIVE";this._jsonData.joints.push(t)}},this);if(this._model){this._model.updateBindings()}if(!e){this._fireSequenceChanged()}return this};s.prototype.getJoint=function(t){var e;if(!t||!t.parent&&!t.node){e=this._jsonData.joints}else if(t&&t.node){e=this._jsonData.joints.filter(function(e){return e.node==t.node&&(t.parent?e.parent==t.parent:true)})}else if(t&&t.parent&&!t.node){e=this._jsonData.joints.filter(function(e){return e.parent==t.parent})}return e};s.prototype.removeJoint=function(t){var e=[];if(!t){this._jsonData.joints.forEach(function(t){e.push(t.node)});this._jsonData.joints.splice(0)}else if(t&&(t.node||t.parent)){var n;do{n=this._findJointIndex(t.parent,t.node);if(n>=0){e.push(this._jsonData.joints[n].node);this._jsonData.joints.splice(n,1)}}while(n>=0)}if(this._model){this._model.updateBindings()}if(e.length){o.getEventBus().publish("sap.ui.vk","nodeAnimationRemoved",{nodeRefs:e,sequenceId:this._jsonData.id})}return this};s.prototype._findNodeIndex=function(t){return n(this._jsonData.nodes,function(e){return e?e.nodeRef==t:true})};s.prototype.getNodeAnimation=function(t,n){var i=function(t,n){var i=this._findNodeIndex(t);var a,o;if(i!==-1){a=this._jsonData.nodes[i]}if(a){if(n){if(a[n]){o=this._trackMap.get(a[n])}}else{o={nodeRef:t};for(var s in e){var r=e[s];if(a[r]){o[r]=this._trackMap.get(a[r])}}}}return o}.bind(this);var a;if(t&&!Array.isArray(t)){return i(t,n)}else if(!t){a=[];this._jsonData.nodes.forEach(function(t){a.push(i(t.nodeRef,n))},this)}else{a=[];t.forEach(function(t){a.push(i(t,n))},this)}return a};s.prototype.setNodeAnimation=function(t,e,n,i){var a=this._findNodeIndex(t);var o;if(a!==-1){o=this._jsonData.nodes[a]}if(!o){o={};o.nodeRef=t;if(t.userData&&t.userData.treeNode){o.sid=t.userData.treeNode.sid}this._jsonData.nodes.push(o)}o[e]=n.getJSONData();this._trackMap.set(n.getJSONData(),n);n.setJSONModel(this._model);if(this._model){this._model.updateBindings()}if(!i){this._fireSequenceChanged()}return this};s.prototype.removeNodeAnimation=function(t,e,n){var i=this._findNodeIndex(t);if(i===-1){return this}var a=this._jsonData.nodes[i];var s;if(!e){for(var r in a){s=this._trackMap.get(a[r]);if(s){s.setJSONModel(null);this._trackMap.delete(a[r])}}this._jsonData.nodes.splice(i,1)}else{s=this._trackMap.get(a[e]);if(s){s.setJSONModel(null);this._trackMap.delete(a[e]);delete a[e]}}if(this._model){this._model.updateBindings()}if(!n){o.getEventBus().publish("sap.ui.vk","nodeAnimationRemoved",{nodeRefs:[t],property:e,sequenceId:this._jsonData.id})}return this};s.prototype.resetDuration=function(t){var e=0;this._jsonData.nodes.forEach(function(t){var n;for(var i in t){if(i==="sid"){continue}var a=this._trackMap.get(t[i]);if(a){if(a.getKeysCount()){var o=a.getKey(a.getKeysCount()-1);n=o.time}if(n&&n>e){e=n}}}},this);if(e>0){this._jsonData.duration=e;if(this._model){this._model.updateBindings()}}if(!t){this._fireSequenceChanged()}return this};s.prototype.getNodesBoundaryValues=function(t){var e=new Map;var n=function(t,n,i){var a=e.get(t);if(!a){a={};e.set(t,a)}a[n]=i};this._jsonData.nodes.forEach(function(e){for(var a in e){if(a==="sid"){continue}var o=this._trackMap.get(e[a]);if(o&&o.getKeysCount()){var s=i.getBoundaryKey(o,t);n(e.nodeRef,a,s.value)}}}.bind(this));return e};s.prototype._fireSequenceChanged=function(){o.getEventBus().publish("sap.ui.vk","sequenceChanged",{sequenceId:this._jsonData.id})};s.prototype._isNodePropertyDefined=function(t,e){var n=this.getNodeAnimation(t,e);if(n&&n.getKeysCount()){return true}var i={node:t};var a=this.getJoint(i);if(a&&a.length){return true}return false};s.prototype._getCurrentNodesProperties=function(t,n){this._jsonData.nodes.forEach(function(i){var a={};var o=t.getRelativeTransformation(i.nodeRef);for(var s in i){if(s===e.Rotate){a[e.Rotate]=o.quaternion.slice()}else if(s===e.Translate){a[e.Translate]=o.translation.slice()}else if(s===e.Scale){a[e.Scale]=o.scale.slice()}else if(s===e.Opacity){var r=t.getOpacity(i.nodeRef);var d=t.getRestOpacity(i.nodeRef);if(r!==null&&r!==undefined){if(!d){d=1}a[e.Opacity]=r/d}}}n.set(i.nodeRef,a)});this._jsonData.joints.forEach(function(i){if(!i.node||!i.parent){return}var a={};var o=t.getRelativeTransformation(i.node);a[e.Rotate]=o.quaternion.slice();a[e.Translate]=o.translation.slice();a[e.Scale]=o.scale.slice();var s=t.getOpacity(i.node);var r=t.getRestOpacity(i.node);if(s!==null&&s!==undefined){if(!r){r=1}a[e.Opacity]=s/r}n.set(i.node,a)})};s.prototype.getJSONData=function(){return this._jsonData};return s});