/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../measurements/Area","../measurements/Face","../measurements/Utils","./MeasurementToolState","./MeasurementToolGizmo"],function(e,t,r,s,u){"use strict";var i=u.extend("sap.ui.vk.tools.AreaMeasurementToolGizmo",{metadata:{library:"sap.ui.vk"}});var n=i.getMetadata().getParent().getClass().prototype;i.prototype.init=function(){if(n.init){n.init.call(this)}this._pointsCountPerClick=null};i.prototype.beginMeasurementConstruction=function(e){this._surface.beginMeasurementConstruction(e);this._currentMeasurement=e;this._pointsCountPerClick=[]};i.prototype.cancelMeasurementConstruction=function(){this._surface.cancelMeasurementConstruction(this._currentMeasurement);this._currentMeasurement=null;this._pointsCountPerClick=null};i.prototype.endMeasurementConstruction=function(){var e=this._currentMeasurement;this._currentMeasurement=null;this._surface.endMeasurementConstruction(e);this._pointsCountPerClick=null};i.prototype.updateContour=function(e,t){var r=e.length/3;if(this._pointsCountPerClick.length>0){var s=this._pointsCountPerClick[this._pointsCountPerClick.length-1];if(s===1&&r===1){this._currentMeasurement.replaceLastPoint(e)}else{this._currentMeasurement.replaceLastPoints(s,e,t);this._pointsCountPerClick[this._pointsCountPerClick.length-1]=r}}else{this._currentMeasurement.replaceLastPoints(0,e,t);this._pointsCountPerClick.push(r)}};i.prototype._finishArea=function(e){if(this._currentMeasurement.hasSelfIntersections()){return}var t=this._vsm;var r=this._hoverPoint&&this._hoverPoint.nodeRef;this._currentMeasurement.finalize();this._surface.update(this._viewport,this._viewport.getCamera());if(r!=null&&t!=null){t.setOutliningStates([],[r],false,true)}this._state=s.SearchingFirstFeature;if(e){this._currentMeasurement.setFeatures(this._vertexFeatures);for(var u=0,i=this._vertexFeatures.length;u<i;++u){this._surface.removeFeature(this._vertexFeatures[u])}}else if(this._currentFeature){this._currentMeasurement.setFeatures([this._currentFeature]);this._surface.removeFeature(this._currentFeature)}this._currentFeature=null;this.setCurrentFeatureIndex(0);this.endMeasurementConstruction()};i.prototype._updateCurrentFeature=function(t,u,i,n,a){var h=t==null?null:this._getMeshAnalyzer(t);var c=this._computeSphereRadius(u,i);var o=false;var _=false;var l=this._currentMeasurement?this._currentMeasurement.getPoints():null;var F=this._is2D;if(F&&l&&l.length>9&&!r.isClosedContour(l)&&r.computePointToPointDistance(u,l)<c){this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],null,h);this._currentFeature.setValue(l.slice(0,3));return true}if(h!=null){var f=h.intersectSphere(u,c,!F,F,F,n,a);if(F){if(!f.contour&&this._currentMeasurement&&this._state===s.SearchingFirstFeature){this.cancelMeasurementConstruction()}if(f.contour&&this._state===s.SearchingFirstFeature){if(this._replaceCurrentFeature(this._faceFeatures[this._currentFeatureIndex],f.contourId,h)){this._currentFeature.setValue({vertices:f.contour});return true}_=true}else if(f.curvedEdge!=null){if(!this._currentMeasurement){var v=new e({});this.beginMeasurementConstruction(v)}var p=f.curvedEdge;var d=p.length-3;var C=[p[0],p[1],p[2]];var m=[p[d],p[d+1],p[d+2]];var g=r.computePointToPointDistance2(u,C)>r.computePointToPointDistance2(u,m);this.updateContour(p,g);if(this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],f.curvedEdgeId+":"+(g?"r":"l"),h)){this._currentFeature.setValue(g?C:m);return true}}else if(f.vertex!=null){if(this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],f.vertexId,h)){this._currentFeature.setValue(f.vertex);return true}}else if(f.edge!=null){this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],f.edgeId,h);var P=f.edge;this._currentFeature.setValue(r.projectPointToEdge([P[0],P[1],P[2]],[P[3],P[4],P[5]],u));return true}else{this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],null,h);this._currentFeature.setValue(u);return true}}else{if(f.faceId!=null){if(this._replaceCurrentFeature(this._faceFeatures[this._currentFeatureIndex],f.faceId,h)){this._currentFeature.setValue(h.buildFace(f.faceId));return true}_=true}else{o=true}}}else if(F){if(this._currentMeasurement&&this._state===s.SearchingFirstFeature){this.cancelMeasurementConstruction()}this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],null,h);this._currentFeature.setValue(u);return true}if(o&&this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null;return true}return _};i.prototype.setHoverPoint=function(t){var r=this._hoverPoint&&this._hoverPoint.nodeRef;var s=t&&t.nodeRef;if(s!=r){var u=this._vsm;if(u!=null){var i=s!=null?[s]:[];var n=r!=null?[r]:[];u.setOutliningStates(i,n,false,true)}}this._hoverPoint=t;if(!t||t.worldPoint==null){if(this._currentMeasurement){this.cancelMeasurementConstruction()}if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}}else{var a=true;if(s||this._is2D){var h=this._settings;var c=!t.shiftKey&&h.featureEdge;var o=!t.shiftKey&&h.featureFace;a=this._updateCurrentFeature(s,this._hoverPoint.worldPoint,this._viewport,o,c)}else if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}var _=this._currentMeasurement;if(this._currentFeature&&this._currentFeature.isFace){if(!_){_=new e({});this.beginMeasurementConstruction(_)}_.setFromFace(this._currentFeature)}else if(_&&a){var l=this._hoverPoint.worldPoint.slice();if(this._currentFeature&&this._currentFeature.isVertex){var F=this._currentFeature.getValue();l[0]=F[0];l[1]=F[1];l[2]=F[2]}this.updateContour(l,false)}this._surface.update(this._viewport,this._viewport.getCamera())}return this};i.prototype.fixPoint=function(t){this.setHoverPoint(t);var u=this._vsm;var i=this._hoverPoint&&this._hoverPoint.nodeRef;var n=this._state;switch(n){case s.SearchingFirstFeature:if(!t.worldPoint){break}if(this._currentMeasurement){var a=this._currentMeasurement.getPoints();if(!a||!a.length||r.isClosedContour(a)){this._finishArea(false);this._surface.update(this._viewport,this._viewport.getCamera())}else{this._currentMeasurement.duplicateLastPoint();this._pointsCountPerClick.push(1);this._currentFeature=null;this.setCurrentFeatureIndex(1);this._state=s.SearchingSecondFeature}break}var h=t.worldPoint.slice();if(this._currentFeature&&this._currentFeature.isVertex){var c=this._currentFeature.getValue();h[0]=c[0];h[1]=c[1];h[2]=c[2]}var o=new e({points:h});o.duplicateLastPoint();this.beginMeasurementConstruction(o);this._pointsCountPerClick.push(1,1);this._currentFeature=null;this.setCurrentFeatureIndex(1);this._state=s.SearchingSecondFeature;break;case s.SearchingSecondFeature:var _=this._currentMeasurement.getPoints();if(this._currentMeasurement.getArea()&&_.length>9&&r.computePointToPointDistance2(_,_,_.length-3)===0){this._finishArea(true);break}if(!this._currentMeasurement.hasSelfIntersectionsLastEdge()){this._currentMeasurement.duplicateLastPoint();this._pointsCountPerClick.push(1);if(i!=null&&u!=null){u.setOutliningStates([],[i],false,true)}var l=this._currentFeature;var F=l.getContext();var f=l.getFeatureId();var v=l.getValue();this.setCurrentFeatureIndex(this._currentFeatureIndex+1);l=this._vertexFeatures[this._currentFeatureIndex];l.setContext(F);l.setFeatureId(f);l.setValue(v);this._surface.addFeature(l);this._currentFeature=l;this._state=s.SearchingSecondFeature;this._surface.update(this._viewport,this._viewport.getCamera())}break;default:break}return this};i.prototype.escapePressed=function(){switch(this._state){case s.SearchingSecondFeature:if(this._currentFeatureIndex>=2){var e=this._pointsCountPerClick.pop();var t=this._pointsCountPerClick.pop();this._pointsCountPerClick.push(e);this._currentMeasurement.deletePredLastPoints(t);this._surface.removeFeature(this._vertexFeatures[this._currentFeatureIndex-1]);this._vertexFeatures[this._currentFeatureIndex-1].setContext(this._currentFeature.getContext());this._vertexFeatures[this._currentFeatureIndex-1].setFeatureId(this._currentFeature.getFeatureId());this._vertexFeatures[this._currentFeatureIndex-1].setValue(this._currentFeature.getValue());this._surface.removeFeature(this._currentFeature);this._currentFeature=null;this.setCurrentFeatureIndex(this._currentFeatureIndex-1);this._currentFeature=this._vertexFeatures[this._currentFeatureIndex];this._surface.addFeature(this._currentFeature)}else{this._state=s.SearchingFirstFeature;if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}this.setCurrentFeatureIndex(0);this.cancelMeasurementConstruction()}this._surface.update(this._viewport,this._viewport.getCamera());break;case s.SearchingFirstFeature:var r=this._vsm;var u=this._hoverPoint&&this._hoverPoint.nodeRef;if(u!=null&&r!=null){r.setOutliningStates([],[u],false,true)}if(this._currentFeature!=null){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}this._state=s.Off;this._tool.setActive(false,this._viewport);break;default:break}};i.prototype.doubleClick=function(e){this.setHoverPoint(e);var t=this._state===s.SearchingSecondFeature?this._currentMeasurement:null;if(t&&t.getArea()){this._finishArea(true);return true}return false};i.prototype.is2D=function(){return this._is2D};return i});