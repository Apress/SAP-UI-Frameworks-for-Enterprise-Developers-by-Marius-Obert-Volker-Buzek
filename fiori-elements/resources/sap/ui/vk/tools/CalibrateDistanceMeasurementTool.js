/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","./CalibrateDistanceMeasurementToolHandler","./Tool","../getResourceBundle","../measurements/Settings","../measurements/Utils"],function(e,t,i,s,a,r,n,o,l){"use strict";var u=r.extend("sap.ui.vk.tools.CalibrateDistanceMeasurementTool",{metadata:{library:"sap.ui.vk"}});var h=u.getMetadata().getParent().getClass().prototype;u.prototype.init=function(){if(h.init){h.init.call(this)}this._viewport=null;this._handler=new a(this);this._highlightedMeasurementDomRef=null;this.setFootprint(["sap.ui.vk.threejs.Viewport","sap.ui.vk.svg.Viewport"])};u.prototype.setActive=function(e,t,i){h.setActive.call(this,e,t,i);if(this._viewport){if(e){this._addLocoHandler();this._viewport.addStyleClass("sapUiVizKitCalibrateDistanceCursor")}else{this._viewport.removeStyleClass("sapUiVizKitCalibrateDistanceCursor");this.highlightMeasurement(null,this._viewport.getMeasurementSurface());this._removeLocoHandler()}}return this};u.prototype.highlightMeasurement=function(e){var t=this._highlightedMeasurementDomRef;if(e===t){return null}var i=this._viewport.getMeasurementSurface();if(t!=null){i.highlightMeasurement(t._measurement,false)}if(e!=null){if(e._measurement.isDistance){i.highlightMeasurement(e._measurement,true,this._viewport,this._viewport.getCamera())}else{e=null}}this._highlightedMeasurementDomRef=e;return this};u.prototype.calibrateMeasurement=function(a){var r=a._measurement;if(!r.isDistance){return this}var u=this._viewport;var h=u.getMeasurementSurface();var c=o.load();var d=l.getUnitFactor(c.units);var m=h.getScale();var p=r.getDistance();var v=p*d*m;var g={label:n().getText("MEASUREMENTS_CALIBRATION_DISTANCE_LABEL",[l.translateUnits(o.load().units)]),distance:v};var f=new i(g);var _=this;var M=this.getId()+"-calibration-dialog";var C;t.load({name:"sap.ui.vk.measurements.Calibration",id:M,controller:{onResetPressed:function(e){f.setProperty("/distance",p*d)},onOkPressed:function(){if(g.distance<=0){e.error(n().getText("MEASUREMENTS_CALIBRATION_DISTANCE_ERROR_MESSAGE"),{onClose:function(){t.byId(M,"distance").focus()}});return}if(g.distance!==v){h.setScale(g.distance/d/p);h.update(u,u.getCamera())}C.close();_.setActive(false,u)},onCancelPressed:function(){C.close()},onAfterClose:function(){C.destroy();C=null}}}).then(function(e){C=e;C.setModel(f);C.setModel(new s({bundle:n()}),"i18n");C.open()});return this};return u});