/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../thirdparty/three","./Gizmo","./AxisAngleRotationToolGizmoRenderer","./AxisColours","../AnimationTrackType","sap/base/assert"],function(t,e,i,a,o,r,n){"use strict";var s=i.extend("sap.ui.vk.tools.AxisAngleRotationToolGizmo",{metadata:{library:"sap.ui.vk"}});var l=[16711808,o.y,o.z];var h=Math.PI*2,u=Math.PI/2,d=13;var p=e.MathUtils.degToRad,c=e.MathUtils.radToDeg;s.prototype.init=function(){if(i.prototype.init){i.prototype.init.apply(this)}this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new e.Vector3;this._rotationDelta=new e.Vector3;this._viewport=null;this._tool=null;this._sceneGizmo=new e.Scene;var t=new e.DirectionalLight(16777215,.5);t.position.set(1,3,2);this._sceneGizmo.add(t);this._sceneGizmo.add(new e.AmbientLight(16777215,.5));this._gizmo=new e.Group;this._sceneGizmo.add(this._gizmo);this._touchAreas=new e.Group;this._nodes=[];this._matViewProj=new e.Matrix4;this._gizmoSize=96;function a(t,i,a){var o=new e.TorusGeometry(i,16/96,4,a,t===2?Math.PI:h);if(t===0){o.rotateY(u)}else if(t===1){o.rotateX(u)}else{o.rotateZ(-u)}return new e.Mesh(o,new e.MeshBasicMaterial({opacity:.2,transparent:true}))}var o;for(o=0;o<3;o++){this._touchAreas.add(a(o,1,24))}for(o=0;o<3;o++){var r=new e.Mesh(new e.IcosahedronGeometry(.25,0),new e.MeshBasicMaterial({opacity:.2,transparent:true}));r.position.setComponent(o,1.6);this._touchAreas.add(r)}};s.prototype._createGizmoObject=function(){var t=new e.Group;var i=t.userData;function a(t,i,a,o){var r=new e.TorusGeometry(a,1/96,4,o,t===2?Math.PI:h);if(t===0){r.rotateY(u)}else if(t===1){r.rotateX(u)}else{r.rotateZ(-u)}var n=new e.Mesh(r,new e.MeshBasicMaterial({color:i,transparent:true}));n.matrixAutoUpdate=false;n.userData.color=i;return n}function o(t,i){var a=96*3,o=2,r=12*3,n=2*3;t.multiplyScalar(1/a);var s=new e.MeshLambertMaterial({color:i});var l=new e.CylinderGeometry(o,o,a-r,4);var h=(new e.Matrix4).makeBasis(new e.Vector3(t.y,t.z,t.x),t,new e.Vector3(t.z,t.x,t.y));h.setPosition(t.clone().multiplyScalar((a-r)*.5));l.applyMatrix4(h);var u=new e.Mesh(l,s);u.matrixAutoUpdate=false;u.userData.color=i;var d=new e.CylinderGeometry(0,n,r,12,1);h.setPosition(t.clone().multiplyScalar(a-r*.5));d.applyMatrix4(h);var p=new e.Mesh(d,s);p.matrixAutoUpdate=false;u.add(p);return u}var r;for(r=0;r<3;r++){t.add(a(r,l[r],1,128))}i.axisArrow=o(new e.Vector3(3,0,0),l[0]);t.add(i.axisArrow);var n=new e.BufferGeometry;n.setAttribute("position",new e.Float32BufferAttribute(new Float32Array([0,0,0,3,0,0]),3));i.arrowProjection=new e.Line(n,new e.LineDashedMaterial({color:l[0],transparent:true,scale:10,dashSize:1,gapSize:1}));i.arrowProjection.computeLineDistances();t.add(i.arrowProjection);t.add(new e.AxesHelper(1.5));i.arcMeshes=[];for(r=0;r<3;r++){var s=new e.Mesh(new e.BufferGeometry,new e.MeshBasicMaterial({vertexColors:true,opacity:.5,transparent:true,side:e.DoubleSide,depthWrite:false}));s.visible=false;i.arcMeshes.push(s);t.add(s)}i.valueLabels=[];for(r=0;r<3;r++){var p=this._createTextMesh("",64,32,d,16777215,false);p.renderOrder=10;p.material.depthTest=false;p.visible=false;i.valueLabels.push(p);t.add(p)}var c=i.axisTitles=this._createAxisTitles();c.scale.setScalar(1/this._gizmoSize);var v=this._gizmoSize*1.6;c.children[0].position.x=v;c.children[1].position.y=v;c.children[2].position.z=v;t.add(c);return t};s.prototype.hasDomElement=function(){return true};s.prototype.resetValues=function(){this._value.setScalar(0)};s.prototype.show=function(t,e){this._viewport=t;this._tool=e;this.handleSelectionChanged();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true)};s.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false)};s.prototype.getGizmoCount=function(){return this._nodes.length};s.prototype.getTouchObject=function(t){if(this._nodes.length===0){return null}var e=this._gizmo.children[t];v(this._touchAreas.children[2],e.children[2]);v(this._touchAreas.children[0],e.children[0]);this._updateGizmoObjectTransformation(this._touchAreas,t);return this._touchAreas};s.prototype.highlightHandle=function(t,e,i){for(var a=0,o=this._gizmo.children.length;a<o;a++){var r=this._gizmo.children[a];var n=r.userData;for(var s=0;s<3;s++){var l=r.children[s];var h=s===t&&a===e?16776960:l.userData.color;l.material.color.setHex(h);l.material.opacity=t===-1||s===t?1:.35;l.material.visible=i||s===t;var u=n.axisTitles.children[s];u.material.color.setHex(a===e&&s===t-3?16776960:l.userData.color);u.material.opacity=i?1:.35;n.arcMeshes[s].material.visible=i||s===t||s===2&&t===1}}};s.prototype._snapToAxis=function(t){var i=-this._value.y,a=-this._value.z;switch(t){case 0:i+=90;break;case 1:a+=90;break;default:break}this.beginGesture();this._rotate(new e.Euler(0,p(i),p(a)));this.endGesture()};s.prototype.selectHandle=function(t,e){this._gizmoIndex=e;this._handleIndex=t;if(t>=3&&t<6){this._snapToAxis(t-3)}this._updateEditValue();this._viewport.setShouldRenderFrame()};function v(t,e){t.quaternion.copy(e.quaternion);t.position.copy(e.position);t.updateMatrix();t.updateMatrixWorld(true)}function m(t){return c(Math.atan2(t[0],t[2]))}function _(t){return c(Math.atan2(t[1],Math.sqrt(t[0]*t[0]+t[2]*t[2])))}function f(t,e){t=p(t);e=p(e);var i=Math.sin(t),a=Math.cos(t);var o=Math.sin(e),r=Math.cos(e);return[i*r,o,a*r]}function g(t,i,a,o){if(t.userData.angle1===a&&t.userData.angle2===o){return}t.userData.angle1=a;t.userData.angle2=o;var r=(new e.Color).setHex(l[i]);var n=[0,0,0];var s=[r.r,r.g,r.b];var u=new e.Vector3;var d=(i+1)%3,p=(i+2)%3;var c=o-a;var v,m=Math.min(Math.max(Math.ceil(Math.abs(c)*64/Math.PI),1),1e4);var _=Math.min(h/Math.abs(c),1);var f=e.MathUtils.lerp;for(v=0;v<=m;v++){var g=1-v/m;var x=a+c*g;var y=f(_,1,g);u.set(0,0,0).setComponent(d,Math.cos(x)*y).setComponent(p,Math.sin(x)*y);n.push(u.x,u.y,u.z);var z=f(1,.5,g);s.push(r.r*z,r.g*z,r.b*z)}var w=[];for(v=0;v<m;v++){w.push(0,v+1,v+2)}var M=t.geometry;M.setIndex(w);M.setAttribute("position",new e.Float32BufferAttribute(n,3));M.setAttribute("color",new e.Float32BufferAttribute(s,3));t.visible=c!==0}s.prototype._updateGizmoObject=function(t,i,a,o){var r=this._gizmo.children[t];var n=new e.Euler(0,p(a-90),0,"YZX");var s=r.children[2];s.quaternion.setFromEuler(n);s.updateMatrix();n.z=p(o);var l=r.children[0];l.quaternion.setFromEuler(n);l.updateMatrix();l.position.setFromMatrixColumn(l.matrix,0).multiplyScalar(2);l.updateMatrix();var h=r.userData;var u=h.axisArrow;u.quaternion.copy(l.quaternion);u.updateMatrix();var d=h.arrowProjection;var c=Math.cos(n.z);d.quaternion.copy(s.quaternion);d.scale.setScalar(c);d.updateMatrix();d.material.scale=c*10;var m=h.arcMeshes;g(m[0],0,0,p(i));v(m[0],r.children[0]);g(m[1],1,0,p(a));v(m[1],r.children[1]);g(m[2],2,0,p(o));v(m[2],r.children[2]);var _=h.valueLabels;y(_[0],i);y(_[1],a);y(_[2],o)};s.prototype.beginGesture=function(){this._rotationDelta.setScalar(0);this._nodes.forEach(function(t){t.beginAngle=t.angle;t.beginAzimuth=t.azimuth;t.beginElevation=t.elevation})};s.prototype._getNodesProperties=function(){return this.getValues()};s.prototype.endGesture=function(){this._nodes.forEach(function(t){delete t.beginAngle;delete t.beginAzimuth;delete t.beginElevation});var t=this._getNodesProperties();this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z,nodesProperties:t})};function x(t,e){var i=window.devicePixelRatio;var a=t.width;var o=t.height;var r=a*.5;var n=o*.5;var s=Math.min(d*.85*i,r-1);var l=t.getContext("2d");l.font="Bold "+d*i+"px Arial";var h=l.measureText(e);var p=Math.min(h.width*.5-s*.5,r-s-1);l.clearRect(0,0,a,o);l.beginPath();l.arc(r-p,n,s,u,u*3,false);l.lineTo(r+p,n-s);l.arc(r+p,n,s,-u,u,false);l.lineTo(r-p,n+s);l.closePath();l.globalAlpha=.75;l.fillStyle="#fff";l.fill();l.globalAlpha=1;l.lineWidth=i;l.strokeStyle="#000";l.stroke();l.fillStyle="#000";l.textAlign="center";if(sap.ui.Device.browser.chrome||sap.ui.Device.browser.firefox){l.textBaseline="top";l.fillText(e,r,n-h.actualBoundingBoxDescent*.5)}else{l.textBaseline="middle";l.fillText(e,r,n)}}function y(t,e){t.visible=e!==0;if(t.visible&&t.userData.value!==e){t.userData.value=e;var i=e.toLocaleString("fullwide",{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:1})+"°";var a=t.material.map;x(a.image,i);a.needsUpdate=true}}s.prototype._updateEditValue=function(){var t=this._nodes[this._gizmoIndex];if(t){this._value.set(t.angle,t.azimuth,t.elevation)}};s.prototype._calculateRotationQuaternion=function(t){var i=(new e.Vector3).fromArray(f(t.azimuth,t.elevation));var a=this._getEffectiveParent(t.node);if(a!==t.node.parent){i.transformDirection(a.matrixWorld);i.transformDirection(t.node.parent.matrixWorld.clone().invert())}return(new e.Quaternion).setFromAxisAngle(i,p(t.angle))};s.prototype._updateNodeRotation=function(t){var e=this._calculateRotationQuaternion(t);t.node.quaternion.multiplyQuaternions(e,t.quaternion);t.node.updateMatrix();if(t.node.userData){delete t.node.userData.skipUpdateJointNode}this._viewport._viewStateManager._setJointNodeOffsets(t.node,r.Rotate)};s.prototype._rotate=function(t){this._rotationDelta.set(c(t.x),c(t.y),c(t.z));this._nodes.forEach(function(t){t.angle=t.beginAngle+this._rotationDelta.x;t.azimuth=(t.beginAzimuth+this._rotationDelta.y)%360;t.elevation=e.MathUtils.clamp(t.beginElevation+this._rotationDelta.z,-90,90);if(t.azimuth>180){t.azimuth-=360}if(t.azimuth<-180){t.azimuth+=360}this._updateNodeRotation(t)},this);this._updateEditValue();this._viewport.setShouldRenderFrame()};s.prototype._setRotationAxisAngle=function(t,i,a){var o=a-i;if(t!==0){o%=h}var r=new e.Euler;r[["x","y","z"][t]]=o;var n=this._getNodesProperties();if(this._tool.fireEvent("rotating",{x:c(r.x),y:c(r.y),z:c(r.z),nodesProperties:n},true)){this._rotate(r)}};s.prototype.rotate=function(t,i,a){this.beginGesture();this._rotate(new e.Euler(p(t||0),p(i||0),p(a||0)))};s.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2}};s.prototype.getValue=function(){return this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3?this._value.getComponent(this._handleIndex):0};s.prototype.setValue=function(t){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){var i=new e.Euler;i[["x","y","z"][this._handleIndex]]=p(t-this._value.getComponent(this._handleIndex));this.beginGesture();this._rotate(i);this.endGesture()}};s.prototype.rotateBy=function(t){this.beginGesture();this._rotate(new e.Euler(p(t),0,0));this.endGesture()};s.prototype.setAxis=function(t){this.beginGesture();var e=0;var i=0;if(Array.isArray(t)){e=m(t);i=_(t)}else{if("azimuth"in t){e=t.azimuth}if("elevation"in t){i=t.elevation}}this._nodes.forEach(function(t){t.azimuth=e;t.elevation=i;this._updateNodeRotation(t)},this);this._updateEditValue();this._viewport.setShouldRenderFrame();this.endGesture()};s.prototype.getValues=function(){var t=[];this._nodes.forEach(function(e){t.push({node:e.node,angle:e.angle,azimuth:e.azimuth,elevation:e.elevation,axis:f(e.azimuth,e.elevation)})});return t};s.prototype._getNodeInfoByNode=function(t){var e=this._nodes;for(var i=0,a=e.length;i<a;i++){if(e[i].node===t){return e[i]}}return null};s.prototype.setValues=function(t){t.forEach(function(t){var e=this._getNodeInfoByNode(t.node);if(e){e.angle=t.angle;if(t.axis){e.azimuth=m(t.axis);e.elevation=_(t.axis)}else{e.azimuth=t.azimuth;e.elevation=t.elevation}var i=this._calculateRotationQuaternion(e);e.quaternion.multiplyQuaternions(i.invert(),e.node.quaternion);this._updateNodeRotation(e)}},this);this._updateEditValue();this._viewport.setShouldRenderFrame()};s.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};s.prototype._updateSelection=function(t){i.prototype._updateSelection.call(this,t);if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(t)}};s.prototype.handleSelectionChanged=function(t){this._nodes.length=0;this._gizmoIndex=this._handleIndex=-1;if(this._viewport){this._updateSelection(this._viewport._viewStateManager);this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true);this._nodes.forEach(function(t){t.quaternion=t.node.quaternion.clone();t.angle=0;t.azimuth=0;t.elevation=0});var e=this._nodes.length;var i=this._gizmo;while(i.children.length>e){i.remove(i.children[i.children.length-1])}while(i.children.length<e){i.add(this._createGizmoObject())}}};s.prototype._getObjectSize=function(t){var i=new e.Box3;this._nodes[t].node._expandBoundingBox(i,true,false);if(i.isEmpty()){return 0}var a=new e.Vector3;i.getSize(a);return a.length()};s.prototype._updateGizmoObjectTransformation=function(t,e){var i=this._nodes[e].node;var a=this._getEffectiveParent(i);t.position.setFromMatrixPosition(i.matrixWorld);if(a){t.quaternion.setFromRotationMatrix(a.matrixWorld)}else{t.quaternion.set(0,0,0,1)}var o=this._getGizmoScale(t.position);t.scale.setScalar(this._gizmoSize*o);t.updateMatrix();t.updateMatrixWorld(true);return o};s.prototype._getValuePosition=function(t,i,a,o){a=p(a);o=p(o);var r=new e.Euler(0,0,0,"YZX");if(i===0){r.set(0,a,o)}else if(i===1){r.set(0,a*.5,0)}else{r.set(0,a,o*.5)}r.y-=u;t.set(i===0?3.25:1.25,0,0).applyEuler(r)};var z=new e.Vector3;s.prototype._updateGizmoTransformation=function(t,e){var i=this._gizmo.children[t];var a=this._nodes[t];var o=this._updateGizmoObjectTransformation(i,t);i.userData.axisTitles.children.forEach(function(t){t.quaternion.copy(i.quaternion).invert().multiply(e.quaternion)});for(var r=0;r<3;r++){var n=i.userData.valueLabels[r];this._getValuePosition(n.position,r,a.azimuth,a.elevation);n.quaternion.copy(i.quaternion).invert().multiply(e.quaternion);z.copy(n.position).applyMatrix4(i.matrixWorld);n.scale.setScalar(this._getGizmoScale(z)/(o*this._gizmoSize))}};s.prototype._getEditingFormPosition=function(){var t=this._gizmo.children[this._gizmoIndex];var e=this._nodes[this._gizmoIndex];this._updateGizmoObjectTransformation(t,this._gizmoIndex);this._getValuePosition(z,this._handleIndex,e.azimuth,e.elevation);return z.applyMatrix4(t.matrixWorld).applyMatrix4(this._matViewProj)};s.prototype.render=function(){n(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var t=this._viewport.getRenderer(),e=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);t.clearDepth();for(var i=0,a=this.getGizmoCount();i<a;i++){var o=this._nodes[i];this._updateGizmoObject(i,o.angle,o.azimuth,o.elevation);this._updateGizmoTransformation(i,e)}t.render(this._sceneGizmo,e);this._updateEditValue()}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex,["δ","γ","α"][this._handleIndex])};s.prototype._getOffsetForRestTransformation=function(t){};return s});