/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","./Tool","./AnchorPointToolHandler","./AnchorPointToolGizmo","./AnchorPointToolOperation"],function(t,e,i,o,r){"use strict";var n=e.extend("sap.ui.vk.tools.AnchorPointTool",{metadata:{library:"sap.ui.vk",properties:{enableStepping:{type:"boolean",defaultValue:false},showEditingUI:{type:"boolean",defaultValue:false},allowOperation:{type:"sap.ui.vk.tools.AnchorPointToolOperation",defaultValue:r.All},allowContextMenu:{type:"boolean",defaultValue:true},position:{type:"any",defaultValue:null},quaternion:{type:"any",defaultValue:null}},events:{moving:{parameters:{x:"float",y:"float",z:"float"}},moved:{parameters:{x:"float",y:"float",z:"float"}},rotating:{parameters:{x:"float",y:"float",z:"float"}},rotated:{parameters:{x:"float",y:"float",z:"float"}}}},constructor:function(t,o){e.apply(this,arguments);this._viewport=null;this._handler=new i(this);this._gizmo=null}});n.prototype.init=function(){if(e.prototype.init){e.prototype.init.call(this)}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);var t=new o;this.setAggregation("gizmo",t);this.setProperty("position",t._gizmo.position);this.setProperty("quaternion",t._gizmo.quaternion)};n.prototype.setViewport=function(t){if(this._viewport!==t){this._deactivateScreenAlignment()}e.prototype.setViewport.call(this,t);if(t){this.getGizmo()._initAnchorPoint(t)}};n.prototype.setActive=function(t,i,o){e.prototype.setActive.call(this,t,i,o);if(this._viewport){if(t){this._gizmo=this.getGizmo();this._gizmo.show(this._viewport,this);this._addLocoHandler();this._deactivateScreenAlignment()}else{this._removeLocoHandler();if(this._gizmo){this._gizmo.hide();this._gizmo=null}}}return this};n.prototype.queueCommand=function(t){if(this._addLocoHandler()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")){t()}}return this};n.prototype.setShowEditingUI=function(t){this.setProperty("showEditingUI",t,true);if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.setAllowOperation=function(t){this.setProperty("allowOperation",t,true);if(this._gizmo){this._gizmo._updateHandlesVisibility()}if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.move=function(t,e,i){if(this._gizmo){this._gizmo.move(t,e,i)}if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.rotate=function(t,e,i){if(this._gizmo){this._gizmo.rotate(t,e,i)}if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.moveTo=function(e,i){var o=Array.isArray(e)?e:[e];var r=new t.Vector3;if(e instanceof t.Matrix4){e.decompose(r,new t.Quaternion,new t.Vector3)}else if(i){var n=0;var a=new t.Vector3;o.forEach(function(t){t.updateWorldMatrix(false,false);r.add(a.setFromMatrixPosition(t.matrixWorld));n++});r.multiplyScalar(1/n)}else{var s=new t.Box3;o.forEach(function(t){s.expandByObject(t)});s.getCenter(r)}this.getGizmo().setPosition(r);if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.alignTo=function(e){this._deactivateScreenAlignment();var i=new t.Quaternion;if(e instanceof t.Matrix4){e.decompose(new t.Vector3,i,new t.Vector3)}else if(e){e.updateWorldMatrix(false,false);e.matrixWorld.decompose(new t.Vector3,i,new t.Vector3)}this.getGizmo().setQuaternion(i);if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.alignToWorld=function(){this._deactivateScreenAlignment();this.getGizmo().setQuaternion(new t.Quaternion);if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.alignToScreen=function(){if(this._viewport){this._activateScreenAlignment();this.alignToScreenCallback();this._viewport.setShouldRenderFrame()}return this};n.prototype._activateScreenAlignment=function(){if(!this.alignToScreenCallback){this.alignToScreenCallback=function(){var t=this._viewport.getCamera().getCameraRef();this.getGizmo().setQuaternion(t.quaternion)}.bind(this);this._viewport.attachCameraChanged(this.alignToScreenCallback)}};n.prototype._deactivateScreenAlignment=function(){if(this.alignToScreenCallback&&this._viewport){this._viewport.detachCameraChanged(this.alignToScreenCallback);this.alignToScreenCallback=null}};n.prototype.setPosition=function(){throw new Error("The AnchorPointTool position is read-only")};n.prototype.setQuaternion=function(){throw new Error("The AnchorPointTool quaternion is read-only")};return n});