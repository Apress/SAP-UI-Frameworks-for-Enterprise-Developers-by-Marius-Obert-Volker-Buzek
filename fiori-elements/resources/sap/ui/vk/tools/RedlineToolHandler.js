/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider","sap/ui/core/Core"],function(t,e){"use strict";var i=t.extend("sap.ui.vk.tools.RedlineToolHandler",{metadata:{library:"sap.ui.vk"},constructor:function(t){this._priority=30;this._tool=t;this._rect=null;this._zoomFactor=1}});i.prototype.destroy=function(){this._tool=null;this._rect=null};i.prototype.init=function(){this._previousHoverTarget=null};i.prototype.beginGesture=function(t){var e=this._tool.getGizmo();if(e&&this._inside(t)){if(e._textEditingElement){t.handled=true;var i=this.hitTest(t.x,t.y);if(i!==e._textEditingElement){var n=e._textEditingElement.getDomRef();if(n){n.childNodes[0].blur()}return}t.passEvent=true;if(i===e._textEditingElement){return}}this._gesture=true;e._activeElement=t.buttons===1&&e.getAggregation("activeElement")||null;if(e._activeElement){t.handled=true;var r=e.getDomRef().getBoundingClientRect(),o=e._toVirtualSpace(t.x-r.left-window.pageXOffset,t.y-r.top-window.pageYOffset);e._activeElement.setOriginX(o.x);e._activeElement.setOriginY(o.y);e.rerender()}else{this._pivotPoint=e._toVirtualSpace(t.x-this._rect.x,t.y-this._rect.y)}}};i.prototype.move=function(t){var e=this._tool.getGizmo();if(e&&this._gesture){if(e._textEditingElement){t.handled=true;t.passEvent=true}else if(e._activeElement){t.handled=true;var i=e.getDomRef().getBoundingClientRect(),n=t.x-i.left-window.pageXOffset,r=t.y-i.top-window.pageYOffset;e._activeElement.edit(n,r,t.event&&t.event.shiftKey)}}};i.prototype.endGesture=function(t){var e=this._tool.getGizmo();if(e&&this._inside(t)){this._gesture=false;if(e._textEditingElement){t.handled=true;t.passEvent=true}else if(e._activeElement){t.handled=true;e._stopAdding(true)}}};i.prototype.pan=function(t,e){var i=this._tool.getGizmo();if(i&&(t||e)){i.getRedlineElements().forEach(function(n){n.setOriginX(n.getOriginX()+i._toVirtualSpace(t));n.setOriginY(n.getOriginY()+i._toVirtualSpace(e))});i.rerender()}};i.prototype.zoom=function(t,e,i){var n=this._tool.getGizmo();if(n&&t!==1){var r=1-t,o=e!==undefined&&i!==undefined?n._toVirtualSpace(e,i):this._pivotPoint;n.getRedlineElements().forEach(function(e){e.applyZoom(t);var i=e.getOriginX(),n=e.getOriginY();i+=(o.x-i)*r;n+=(o.y-n)*r;e.setOriginX(i);e.setOriginY(n)});n.rerender()}};i.prototype.hitTest=function(t,i){var n;var r=6;var o=6;var s=function(t,i){var n=document.elementFromPoint(t,i);if(n){var r=e.byId(n.id||n.parentNode.id);if(r instanceof sap.ui.vk.RedlineElement){return r}}};n=s(t,i);if(!n){for(var l=i-o;l<i+o;l++){for(var a=t-r;a<t+r;a++){n=s(a,l);if(n){return n}}}}return n?n:null};i.prototype.click=function(t){var e=this.hitTest(t.x,t.y);if(e){this._tool.fireElementClicked({elementId:e.getElementId()})}};i.prototype.doubleClick=function(t){var e=this._tool.getGizmo();if(e&&this._tool.getEditable()){var i=this.hitTest(t.x,t.y);if(i instanceof sap.ui.vk.RedlineElementText){e.editTextElement(i);t.handled=true}}};i.prototype.hover=function(t){var e=this._tool.getGizmo();if(e&&e._textEditingElement){t.passEvent=true;return}var i=this.hitTest(t.x,t.y);if(i&&i.getElementId()!=this._previousHoverTarget){this._previousHoverTarget=i.getElementId();this._tool.fireElementHovered({elementId:i.getElementId()})}else if(!i&&i!=this._previousHoverTarget){this._previousHoverTarget=i;this._tool.fireElementHovered({elementId:null})}};i.prototype.contextMenu=function(t){};i.prototype.getViewport=function(){return this._tool._viewport};i.prototype._getOffset=function(t){var e=t.getBoundingClientRect();var i={x:e.left+window.pageXOffset,y:e.top+window.pageYOffset};return i};i.prototype._inside=function(t){var e=this._tool._viewport.getIdForLabel();var i=document.getElementById(e);if(i==null){return false}var n=this._getOffset(i);this._rect={x:n.x,y:n.y,w:i.offsetWidth,h:i.offsetHeight};return t.x>=this._rect.x&&t.x<=this._rect.x+this._rect.w&&t.y>=this._rect.y&&t.y<=this._rect.y+this._rect.h};return i});