/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../library","./Tool","./RedlineToolHandler","./RedlineToolGizmo","../Redline","../RedlineElementRectangle","../RedlineElementEllipse","../RedlineElementFreehand","../RedlineElementLine","../RedlineElementText"],function(e,t,i,n,r,o,a,l,s,p,d){"use strict";var m=i.extend("sap.ui.vk.tools.RedlineTool",{metadata:{library:"sap.ui.vk",properties:{editable:{type:"boolean",defaultValue:true}},events:{elementCreated:{parameters:{element:"object"}},elementClicked:{parameters:{elementId:"string"}},elementHovered:{parameters:{elementId:"string"}}},aggregations:{redlineElements:{type:"sap.ui.vk.RedlineElement",multiple:true,forwarding:{getter:"getGizmo",aggregation:"redlineElements",forwardBinding:true}}}},constructor:function(e,t){if(m._instance){return m._instance}i.apply(this,arguments);this._viewport=null;this._handler=new n(this);m._instance=this}});m.prototype.init=function(){if(i.prototype.init){i.prototype.init.call(this)}this.setFootprint(["sap.ui.vk.svg.Viewport","sap.ui.vk.threejs.Viewport","sap.ui.vk.dvl.Viewport","sap.ui.vk.NativeViewport"]);this.setAggregation("gizmo",new r)};m.prototype.exit=function(){m._instance=null};m.prototype.setActive=function(e,n,r){i.prototype.setActive.call(this,e,n,r);var o=this._viewport;if(o){if(e){if(o._activateRedline){o._activateRedline()}else if(o instanceof t.threejs.Viewport){o._viewportGestureHandler._activateRedline()}o._redlineHandler=this._handler;this._handler._zoomFactor=1;this._gizmo=this.getGizmo();if(this._gizmo){this._gizmo.show()}this._addLocoHandler()}else{this._removeLocoHandler();if(this._gizmo){this._gizmo.hide();this._gizmo=null}delete o._redlineHandler;if(o._deactivateRedline){o._deactivateRedline()}else if(o instanceof t.threejs.Viewport&&o._viewportGestureHandler){o._viewportGestureHandler._deactivateRedline()}}}return this};var u={rectangle:a,ellipse:l,freehand:s,line:p,text:d};var c={rect:a,ellipse:l,path:s,line:p,text:d};m.prototype.startAdding=function(e){this.getGizmo()._startAdding(e);return this};m.prototype.stopAdding=function(){this.getGizmo()._stopAdding(false);return this};m.prototype.exportJSON=function(){return this.getGizmo().getRedlineElements().map(function(e){return e.exportJSON()})};m.prototype.importJSON=function(t){var i=this.getGizmo();t=Array.isArray(t)?t:[t];t.forEach(function(t){var n=u[t.type];if(n){i.addRedlineElement((new n).importJSON(t))}else{e.warning("Unsupported JSON element type "+t.type)}});i.rerender();return this};m.prototype.exportSVG=function(){var e=document.createElementNS(o.svgNamespace,"svg");this.getGizmo().getRedlineElements().map(function(t){e.appendChild(t.exportSVG())});return e};m.prototype.importSVG=function(t){var i=this.getGizmo();t.childNodes.forEach(function(t){if(t.getAttribute){var n=c[t.tagName];if(n){i.addRedlineElement((new n).importSVG(t))}else{e.warning("Unsupported SVG element type "+n)}}});i.rerender();return this};m.prototype.queueCommand=function(e){if(this._addLocoHandler()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")||this.isViewportType("sap.ui.vk.NativeViewport")){e()}}return this};m.prototype.onElementClicked=function(e){this.fireElementClicked({elementId:e.getParameter("elementId")})};return m});