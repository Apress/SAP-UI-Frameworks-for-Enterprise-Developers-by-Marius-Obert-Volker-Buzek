/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./HitTestToolHandler","./HitTestIdMode","../thirdparty/three"],function(e,t,i,r){"use strict";var s=e.extend("sap.ui.vk.tools.HitTestTool",{metadata:{library:"sap.ui.vk",properties:{IdMode:{type:"sap.ui.vk.tools.HitTestIdMode",defaultValue:i.ThreeJS}},events:{hit:{parameters:{id:"any",object:"any",point:"any",clickType:"sap.ui.vk.tools.HitTestClickType"}}}},constructor:function(i,r){if(s._instance){return s._instance}e.apply(this,arguments);this.setToolid("63150593-75f6-c330-2a7a-c1f85d36b2b9");this._viewport=null;this._handler=new t(this);this._loco=null;s._instance=this}});s.prototype.init=function(){if(e.prototype.init){e.prototype.init.call(this)}this.setFootprint(["sap.ui.vk.threejs.Viewport"])};s.prototype.setActive=function(t,i,r){e.prototype.setActive.call(this,t,i,r);if(this._viewport){if(t){this._prepare()}else{this._removeLocoHandler()}}return this};s.prototype._prepare=function(){if(!this._addLocoHandler()){return false}var e=false;if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){this._dvlRendererId=this._viewport._dvlRendererId;this._dvl=this._viewport._dvl;e=true}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")&&(this._viewport._scene&&this._viewport._scene.getSceneRef())){e=true}return e};s.prototype.queueCommand=function(e){if(this._prepare()){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(e,this._dvlRendererId)}}return this};s.prototype.hitTest=function(e,t,s,o,n){if(this._prepare()){var a=null;if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){return null}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")){if(!s||!o){a=null}else if(this._viewport._renderer){var p=this._viewport._renderer.domElement;var l=new r.Vector2((e-p.offsetLeft)/p.clientWidth*2-1,(p.offsetTop-t)/p.clientHeight*2+1);var d=new r.Raycaster;d.setFromCamera(l,o.getCameraRef());var h=d.intersectObjects(s.getSceneRef().children,true);if(h&&h.length){for(var c in h){var v=h[c];var u=v.object;var f=u.parent;while(f){if(f.userData.closed){u=f}f=f.parent}while(u.parent&&u.userData.skipIt){u=u.parent}if(u.visible&&!u.isBillboard&&!u.isDetailView){v.object=u;a=v;break}}}}}var _=null;if(a){var w;switch(this.getIdMode()){case i.VEsID:w=this._viewport._scene.nodeRefToPersistentId(a.object);break;case i.ThreeJS:w=a.object.id;break;default:w=a.object.id;break}_={id:w,object:a.object,point:a.point,clickType:n};this.fireHit(_)}return _}};return s});