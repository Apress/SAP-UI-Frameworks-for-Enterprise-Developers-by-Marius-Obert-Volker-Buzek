/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","./Gizmo","./AxisColours","../threejs/ThreeUtils","sap/base/assert"],function(t,e,i,o,r,s){"use strict";var n=i.extend("sap.ui.vk.tools.CrossSectionToolGizmo",{metadata:{library:"sap.ui.vk"}});n.prototype.init=function(){if(i.prototype.init){i.prototype.init.apply(this)}this._createEditingForm(t().getText("TOOL_UNITS_MM"),84);this._handleIndex=-1;this._viewport=null;this._tool=null;this._position=new e.Vector3(0,0,0);this._plane=new e.Plane(new e.Vector3(0,0,1),0);this._flip=false;this._matViewProj=new e.Matrix4;this._gizmoSize=144;this._firstShowPress=true;this.setAxis(0)};n.prototype.hasDomElement=function(){return true};n.prototype.show=function(t,i){this._viewport=t;this._tool=i;if(this._firstShowPress){var o=t._scene?t._scene._computeBoundingBox(true,true):new e.Box3;o.getCenter(this._position);this._firstShowPress=false}this._plane.constant=-this._plane.normal.dot(this._position);t.setClippingPlanes([this._plane])};n.prototype.hide=function(){if(this._viewport){this._viewport.setClippingPlanes([]);this._viewport=null}this._handleIndex=-1;this._tool=null;this._updateEditingForm(false,-1)};n.prototype._getOffset=function(){return this._position.getComponent(this._axis)};n.prototype.getAxis=function(){return this._axis};n.prototype.setAxis=function(t){this._handleIndex=-1;this._axis=t;var i=(new e.Vector3).setComponent(t,1);this._plane.normal.set(0,0,0).setComponent(t,this._flip?-1:1);this._plane.constant=-this._plane.normal.dot(this._position);var r=new e.BufferGeometry;var s=new Array(15);var n=new e.Vector3(i.y,i.z,i.x),a=new e.Vector3(i.z,i.x,i.y),h=new e.Vector3;h.sub(n).sub(a).multiplyScalar(.5).toArray(s,0);h.toArray(s,12);h.add(n).toArray(s,3);h.add(a).toArray(s,6);h.sub(n).toArray(s,9);r.setAttribute("position",new e.Float32BufferAttribute(s,3));this._gizmoPlane=new e.Line(r,new e.LineBasicMaterial({color:4210752,transparent:true,linewidth:window.devicePixelRatio}));var p=144,l=window.devicePixelRatio*.5,_=32,u=6,m=48;i=this._plane.normal.clone().multiplyScalar(1/p);var c=0;switch(t){case 0:c=o.x;break;case 1:c=o.y;break;case 2:c=o.z;break;default:break}var d=new e.CylinderGeometry(l,l,p-_,4);var w=(new e.Matrix4).makeBasis(new e.Vector3(i.y,i.z,i.x),i,new e.Vector3(i.z,i.x,i.y));w.setPosition(i.clone().multiplyScalar((p-_)*.5));d.applyMatrix4(w);this._gizmoArrow=new e.Mesh(d,new e.MeshBasicMaterial({color:c}));this._gizmoArrow.userData.color=c;var g=new e.CylinderGeometry(0,u,_,12,1);w.setPosition(i.clone().multiplyScalar(p-_*.5));g.applyMatrix4(w);var x=new e.Mesh(g,new e.MeshBasicMaterial({color:c}));x.matrixAutoUpdate=false;this._gizmoArrow.add(x);var y=new e.CylinderGeometry(m*.5,m*.5,p,12,1);w.setPosition(i.clone().multiplyScalar(p*.5));y.applyMatrix4(w);this._touchMesh=new e.Mesh(y,new e.MeshBasicMaterial({visible:false,side:e.DoubleSide}));this._gizmoArrow.add(this._touchMesh);if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.setFlip=function(t){this._flip=!!t;var e=this._handleIndex;this.setAxis(this._axis);this._handleIndex=e;return this};n.prototype.getTouchObject=function(){return this._touchMesh};var a=new e.Vector3;n.prototype._getDelta=function(){var t=this._viewport._scene._computeBoundingBox(true,true);t.getSize(a);return Math.max(a.x,a.y,a.z)};n.prototype._setOffset=function(t){var i=this._viewport._scene._computeBoundingBox(true,true);t=e.MathUtils.clamp(t,i.min.getComponent(this._axis),i.max.getComponent(this._axis));this._position.setComponent(this._axis,t);this._plane.constant=-this._plane.normal.dot(this._position);this._viewport.setShouldRenderFrame()};n.prototype.getValue=function(){return this._position.getComponent(this._handleIndex)};n.prototype.setValue=function(t){if(this._handleIndex>=0){this._position.setComponent(this._handleIndex,t);this._plane.constant=t;this._viewport.setShouldRenderFrame()}};n.prototype.highlightArrowHandle=function(t){var e=t?16776960:this._gizmoArrow.userData.color;this._gizmoArrow.material.color.setHex(e);this._gizmoArrow.children[0].material.color.setHex(e)};n.prototype.selectHandle=function(t){this._handleIndex=t;this._viewport.setShouldRenderFrame()};n.prototype._adjustBoundingBox=function(t){t.getSize(a);var e=Math.max(a.x,a.y,a.z)*.2;t.expandByScalar(e)};n.prototype._updateGizmo=function(t){var i=this._axis;var o=e.MathUtils.clamp(this._position.getComponent(i),t.min.getComponent(i),t.max.getComponent(i));this._position.setComponent(i,o);this._plane.constant=-this._plane.normal.dot(this._position);this._adjustBoundingBox(t);t.getCenter(this._gizmoPlane.position);this._gizmoPlane.position.setComponent(i,o);t.getSize(this._gizmoPlane.scale);this._gizmoPlane.updateMatrixWorld(true);var r=this._viewport.getCamera().getCameraRef();this._gizmoArrow.position.copy(this._gizmoPlane.position);this._matViewProj.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);this._gizmoArrow.scale.setScalar(this._gizmoSize*this._getGizmoScale(this._gizmoArrow.position));this._gizmoArrow.updateMatrixWorld(true)};n.prototype.expandBoundingBox=function(t){if(this._viewport){var e=this._viewport._scene._computeBoundingBox(true,true);this._updateGizmo(e);t.min.min(e.min);t.max.max(e.max);t.expandByPoint(this._plane.normal.clone().multiply(this._gizmoArrow.scale).add(this._gizmoArrow.position))}};n.prototype._getEditingFormPosition=function(){return this._plane.normal.clone().applyMatrix4(this._gizmoArrow.matrixWorld).applyMatrix4(this._matViewProj)};n.prototype.render=function(){s(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");var t=this._viewport._scene._computeBoundingBox(true,true);this._updateGizmo(t);var e=this._viewport.getRenderer(),i=this._viewport.getCamera().getCameraRef();e.render(this._gizmoPlane,i);e.clearDepth();e.render(this._gizmoArrow,i);this._gizmo=this._gizmoArrow;this._updateEditingForm(this._handleIndex>=0,this._handleIndex)};n.prototype.exit=function(){if(this._gizmoArrow){r.disposeObject(this._gizmoArrow);this._gizmoArrow=null}if(this._gizmoPlane){r.disposeObject(this._gizmoPlane);this._gizmoPlane=null}if(this._touchMesh){r.disposeObject(this._touchMesh);this._touchMesh=null}i.prototype.exit.call(this)};return n});