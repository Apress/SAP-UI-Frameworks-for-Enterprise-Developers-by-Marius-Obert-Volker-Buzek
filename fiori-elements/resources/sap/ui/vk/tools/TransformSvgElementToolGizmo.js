/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Gizmo","./TransformSvgElementToolGizmoRenderer","../svg/Element","./ToolNodeSet"],function(t,e,r,i){"use strict";var a=t.extend("sap.ui.vk.tools.TransformSvgElementToolGizmo",{metadata:{library:"sap.ui.vk"}});a.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._nodes=[];this._cursor=null;this.handleSelectionChanged();t.attachCameraChanged(this._handleChanged,this);if(t._viewStateManager){t._viewStateManager.attachTransformationChanged(this._handleChanged,this)}};a.prototype.hide=function(){if(this._cursor){this._viewport.removeStyleClass(this._cursor);this._cursor=null}if(this._viewport._viewStateManager){this._viewport._viewStateManager.detachTransformationChanged(this._handleChanged,this)}this._viewport.detachCameraChanged(this._handleChanged,this);this._viewport=null;this._tool=null;this._nodes=[]};a.prototype._handleChanged=function(){if(this.getDomRef()){this.rerender()}};a.prototype._getHandleLocalPositions=function(t,e){var r=t.bbox;var i=r.x;var a=r.x+r.width;var n=(i+a)*.5;var o=r.y+r.height*.5;var s=r.height*.5*t.ySign;var h=o-s;var l=o+s;var v=h-48*t.ySign/(this._viewport._camera.zoom*Math.sqrt(e[2]*e[2]+e[3]*e[3]));return[n,h,a,h,a,o,a,l,n,l,i,l,i,o,i,h,n,v,n,o]};a.prototype._selectHandle=function(t,e){this._gizmoIndex=t;this._handleIndex=e;var r=null;if(t>=0){if(e>=0){if(e<8){var i=this._nodes[t];var a=i.node._matrixWorld();var n=Math.round(Math.atan2(a[2],a[3])*4/Math.PI);r=["NSResize","NESWResize","EWResize","NWSEResize"][(16-n+e*i.xSign*i.ySign)%4]}else{r="Rotate"}}else{r="Move"}r="sapUiVkTransformationToolCursor"+r}if(this._cursor!=r){if(this._cursor){this._viewport.removeStyleClass(this._cursor)}if(r){this._viewport.addStyleClass(r)}this._cursor=r}};function n(t){return{x:t[4],y:t[5]}}function o(t){return{x:Math.sqrt(t[0]*t[0]+t[1]*t[1]),y:Math.sqrt(t[2]*t[2]+t[3]*t[3])}}function s(t){return Math.atan2(t[0],t[1])}function h(t){if(t<-Math.PI){return t+Math.PI*2}else if(t>Math.PI){return t-Math.PI*2}return t}function l(t){var e=null;while(t.parent){e=t;t=t.parent}return e&&e.matrix[3]<0?-1:1}function v(t,e,r,i){return t*r+e*i}function d(t){return t[0]*t[3]-t[1]*t[2]}a.prototype.handleSelectionChanged=function(){var t=this._viewport?this._viewport._viewStateManager:null;if(t===null){return}var e=[];if(this._tool){t[this._tool.getNodeSet()===i.Highlight?"enumerateSelection":"enumerateOutlinedNodes"](function(t){var i=t._matrixWorld();var a=d(i)<0?-1:1;if(t.parent){i=r._multiplyMatrices(r._invertMatrix(t.parent._matrixWorld()),i)}e.push({node:t,bbox:t._getBBox(),position:n(i),scale:o(i),angle:s(i),xSign:a,ySign:l(t)})})}if(this._nodes.length===e.length&&this._nodes.every(function(t,r){return e[r].node===t.node})){return}this._nodes=e;if(this.getDomRef()){this.rerender()}};a.prototype._beginGesture=function(){this._nodes.forEach(function(t){var e=t.node;t.beginWorldMatrix=e._matrixWorld();t.bbox=e._getBBox()});this._eventParameters=null};function _(t,e,r,i,a,n){var o=v(t,e,r+a,i+n);var s=v(t,e,r,i);return s!==0?o/s:1}a.prototype._update=function(t,e,i){var a=this._handleIndex;var l=a>=0&&a<8?(a+4)%8:9;var u=1,f=1,c=1,g=0;var p=[];var x;var m={nodesProperties:p};if(a<0){x="moving";m.x=t;m.y=e}else{var y=this._nodes[this._gizmoIndex];var M=y.beginWorldMatrix;var S=this._getHandleLocalPositions(y,M);if(a<8){x="scaling";var w=S[l*2];var C=S[l*2+1];var P=S[a*2];var b=S[a*2+1];var E=v(P-w,b-C,M[0],M[2]);var W=v(P-w,b-C,M[1],M[3]);u=a===0||a===4?1:_(M[0],M[1],E,W,t,e);f=a===2||a===6?1:_(M[2],M[3],E,W,t,e);if(this._tool.getUniformScaleEnabled()^i){if(a===0||a===4){u=f}else if(a===2||a===6){f=u}else{u=f=Math.max(u,f)}}m.x=u;m.y=f}else{x="rotating";var z=r._transformPoint(S[18],S[19],M);var I=r._transformPoint(S[16],S[17],M);var T=Math.atan2(I.x-z.x,I.y-z.y);var R=Math.atan2(I.x-z.x+t,I.y-z.y+e);var N=h(R-T);m.angle=N;c=Math.cos(N);g=Math.sin(N)}}this._nodes.forEach(function(i){var v=i.node;var _=i.beginWorldMatrix.slice();var x={node:v};if(a<0){_[4]+=t;_[5]+=e}else{var m=this._getHandleLocalPositions(i,_);if(a<8){var y=m[l*2];var M=m[l*2+1];_[4]+=y*_[0]+M*_[2];_[5]+=y*_[1]+M*_[3];_[0]*=u;_[1]*=u;_[2]*=f;_[3]*=f;_[4]-=y*_[0]+M*_[2];_[5]-=y*_[1]+M*_[3]}else{var S=r._transformPoint(m[18],m[19],_);var w=new Float32Array([c,-g,g,c,S.x-(S.x*c+S.y*g),S.y-(S.x*-g+S.y*c)]);_=r._multiplyMatrices(w,_)}}i.xSign=d(_)<0?-1:1;if(v.parent){_=r._multiplyMatrices(r._invertMatrix(v.parent._matrixWorld()),_)}if(a<0){var C=n(_);x.x=C.x-i.position.x;x.y=C.y-i.position.y}else if(a<8){var P=o(_);x.x=P.x/i.scale.x;x.y=P.y/i.scale.y}else{x.angle=h(s(_)-i.angle)}v.setMatrix(_);p.push(x)}.bind(this));this.rerender();this._eventParameters=m;this._tool.fireEvent(x,m,true)};a.prototype._endGesture=function(){if(this._eventParameters){var t=this._handleIndex;var e;if(t<0){e="moved"}else if(t<8){e="scaled"}else{e="rotated"}this._tool.fireEvent(e,this._eventParameters,true)}};return a});