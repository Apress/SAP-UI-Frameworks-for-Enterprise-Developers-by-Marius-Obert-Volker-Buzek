/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","../thirdparty/BufferGeometryUtils","./Gizmo","./MoveToolGizmoRenderer","./CoordinateSystem","./GizmoPlacementMode","./AxisColours","../AnimationTrackType","sap/base/assert","sap/base/Log"],function(e,t,i,r,o,a,n,s,l,d,h){"use strict";var c=r.extend("sap.ui.vk.tools.MoveToolGizmo",{metadata:{library:"sap.ui.vk"}});c.prototype.init=function(){if(r.prototype.init){r.prototype.init.apply(this)}this._createEditingForm(e().getText("TOOL_UNITS_MM"),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new t.Vector3;this._moveDelta=new t.Vector3;this._viewport=null;this._tool=null;this._sceneGizmo=new t.Scene;var o=new t.DirectionalLight(16777215,.5);o.position.set(1,3,2);this._sceneGizmo.add(o);this._sceneGizmo.add(new t.AmbientLight(16777215,.5));this._gizmo=new t.Group;this._touchAreas=new t.Group;this._sceneGizmo.add(this._gizmo);this._coordinateSystem=a.World;this._placementMode=n.Default;this._nodes=[];this._matViewProj=new t.Matrix4;this._gizmoSize=96;function l(e,r,o){var a=96,n=1,s=24,l=4,d=48;e.multiplyScalar(1/a);var h=new t.MeshLambertMaterial({color:r,transparent:true});var c=new t.CylinderGeometry(n,n,a-s,4);var m=(new t.Matrix4).makeBasis(new t.Vector3(e.y,e.z,e.x),e,new t.Vector3(e.z,e.x,e.y));m.setPosition(e.clone().multiplyScalar((a-s)*.5));c.applyMatrix4(m);var u=new t.Mesh(c,h);u.matrixAutoUpdate=false;u.userData.color=r;var p=new t.CylinderGeometry(0,l,s,12,1);m.setPosition(e.clone().multiplyScalar(a-s*.5));p.applyMatrix4(m);var f=new t.Mesh(p,h);f.matrixAutoUpdate=false;u.add(f);var _=new t.CylinderGeometry(d*.5,d*.5,d,12,1);_.applyMatrix4(m);var v=new t.CylinderGeometry(d*.5,d*.2,d,12,1);m.setPosition(e.clone().multiplyScalar(a*.5));v.applyMatrix4(m);var y=i.mergeBufferGeometries([_,v]);o.add(new t.Mesh(y,h));return u}function d(e,i,r){var o=new Float32Array(9);o[e]=o[i+6]=1;o[e+3]=o[i+3]=.5;var a=new t.BufferGeometry;var n=new Float32Array(12);n[3+e]=n[6+i]=n[9+e]=n[9+i]=.333;a.setAttribute("position",new t.Float32BufferAttribute(n,3));a.setIndex([0,2,1,1,2,3]);var s=new t.MeshBasicMaterial({color:16776960,opacity:.5,transparent:true,visible:false,side:t.DoubleSide});var l=new t.Mesh(a,s);l.matrixAutoUpdate=false;l.userData.colors=o;var d=new t.BufferGeometry;var h=new Float32Array(9);h[e]=h[e+3]=h[i+3]=h[i+6]=.333;d.setAttribute("position",new t.Float32BufferAttribute(h,3));d.setAttribute("color",new t.Float32BufferAttribute(o,3));var c=new t.Line(d,new t.LineBasicMaterial({vertexColors:true,transparent:true,linewidth:window.devicePixelRatio}));c.matrixAutoUpdate=false;l.add(c);r.add(new t.Mesh(a,new t.MeshBasicMaterial({side:t.DoubleSide})));return l}this._gizmo.add(l(new t.Vector3(1,0,0),s.x,this._touchAreas));this._gizmo.add(l(new t.Vector3(0,1,0),s.y,this._touchAreas));this._gizmo.add(l(new t.Vector3(0,0,1),s.z,this._touchAreas));this._gizmo.add(d(1,2,this._touchAreas));this._gizmo.add(d(2,0,this._touchAreas));this._gizmo.add(d(0,1,this._touchAreas));this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);var h=new t.BufferGeometry;h.setAttribute("position",new t.Float32BufferAttribute(new Float32Array(6),3));this._line=new t.LineSegments(h,new t.LineBasicMaterial);this._line.frustumCulled=false;this._line.visible=false;this._gizmo.add(this._line)};c.prototype.hasDomElement=function(){return true};c.prototype.resetValues=function(){this._value.setScalar(0)};c.prototype.setCoordinateSystem=function(e){this._coordinateSystem=e;var t=e===a.Screen;var i=this._gizmo.children,r=this._touchAreas.children;i[2].visible=i[3].visible=i[4].visible=!t;r[2].visible=r[3].visible=r[4].visible=!t;this._axisTitles.children[2].visible=!t;this._gizmoIndex=this._handleIndex=-1};c.prototype.show=function(e,t){this._viewport=e;this._tool=t;this._nodes.length=0;this._updateSelection(e._viewStateManager);var i=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:i},true)};c.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false)};c.prototype.getGizmoCount=function(){if(this._coordinateSystem===a.Local||this._coordinateSystem===a.Parent){return this._nodes.length}else{return this._nodes.length>0?1:0}};c.prototype.getTouchObject=function(e){if(this._nodes.length===0){return null}this._updateGizmoObjectTransformation(this._touchAreas,e,true);return this._touchAreas};var m=[1,2,4,6,5,3];c.prototype.highlightHandle=function(e,t){var i;for(i=0;i<3;i++){var r=this._gizmo.children[i];var o=m[e]&1<<i;var a=o?16776960:r.userData.color;r.material.color.setHex(a);r.material.opacity=o||t?1:.35;r.children[0].material.color.setHex(a);r.children[0].material.opacity=o||t?1:.35;var n=this._axisTitles.children[i];n.material.color.setHex(a);n.material.opacity=o||t?1:.35}for(i=3;i<6;i++){var s=this._gizmo.children[i];s.material.visible=i===e;var l=s.children[0].geometry.attributes.color;l.copyArray(i===e?[1,1,0,1,1,0,1,1,0]:s.userData.colors);l.needsUpdate=true;s.children[0].material.opacity=i===e||t?1:.35}};c.prototype.selectHandle=function(e,t){this._gizmoIndex=t;this._handleIndex=e;if(this._tool.getAutoResetValues()){this.resetValues()}this._viewport.setShouldRenderFrame()};c.prototype.beginGesture=function(){this._beginValue=this._value.clone();this._moveDelta.setScalar(0);this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(e){var i=e.node;e.matOrigin=i.matrixWorld.clone();e.originLocal=i.position.clone();e.origin=(new t.Vector3).setFromMatrixPosition(i.matrixWorld);if(i.parent){e.matParentInv=(new t.Matrix4).copy(i.parent.matrixWorld).invert()}else{e.matParentInv=new t.Matrix4}})};c.prototype._printEventInfo=function(e,t,i,r,o){h.debug(e+" is fired:"+" x = "+t+"; y = "+i+"; z = "+r);o.forEach(function(e){h.debug("Node: "+e.node.name);if(e.offsetToRest){h.debug("offsetToRest: [ "+e.offsetToRest[0]+", "+e.offsetToRest[1]+", "+e.offsetToRest[2]+" ] ")}else{h.debug("offsetToRest: null")}if(e.offsetToPrevious){h.debug("offsetToPrevious: [ "+e.offsetToPrevious[0]+", "+e.offsetToPrevious[1]+", "+e.offsetToPrevious[2]+" ] ")}else{h.debug("offsetToPrevious: null")}if(e.absolute){h.debug("absolute: [ "+e.absolute[0]+", "+e.absolute[1]+", "+e.absolute[2]+" ] ")}else{h.debug("absolute: null")}if(e.world){h.debug("world: [ "+e.world[0]+", "+e.world[1]+", "+e.world[2]+" ] ")}else{h.debug("world: null")}if(e.restDifference){h.debug("restDifference: [ "+e.restDifference[0]+", "+e.restDifference[1]+", "+e.restDifference[2]+" ] ")}else{h.debug("restDifference: null")}if(e.restDifferenceInCoordinates){h.debug("restDifferenceInCoordinates: [ "+e.restDifferenceInCoordinates[0]+", "+e.restDifferenceInCoordinates[1]+", "+e.restDifferenceInCoordinates[2]+" ] ")}else{h.debug("restDifferenceInCoordinates: null")}})};c.prototype._getOffsetToRestInCoordinateSystem=function(e,i,r){if(r===a.World){return i.toArray()}else if(r===a.Custom){var o=(new t.Matrix4).extractRotation(this._gizmo.matrixWorld);var n=(new t.Matrix4).copy(o).invert();return i.clone().applyMatrix4(n).toArray()}else if(r===a.Local){var s=(new t.Matrix4).extractRotation(e.matrixWorld);var l=(new t.Matrix4).copy(s).invert();return i.clone().applyMatrix4(l).toArray()}else if(r===a.Screen){var d=this._viewport.getRenderer().getSize(new t.Vector2);var h=this._viewport.getCamera().getCameraRef();var c=(new t.Vector4).copy(this._gizmo.position).applyMatrix4(this._matViewProj);var m=(new t.Matrix3).setFromMatrix4(h.matrixWorld);var u=(new t.Matrix3).copy(m).invert();var p=i.clone().applyMatrix3(u);var f=2*c.w/(h.projectionMatrix.elements[0]*d.width);var _=2*c.w/(h.projectionMatrix.elements[5]*d.height);return[p.x/f,p.y/_,0]}};c.prototype._getNodesProperties=function(){var e=[];this._nodes.forEach(function(i){var r=i.node;var o={};o.node=r;var n=this._getEffectiveParent(r);var s=new t.Matrix4;if(n===r.parent){var d=this._viewport._viewStateManager.getRelativeTransformation(r);o.offsetToRestInParent=d.translation.slice();if(r.parent){s=(new t.Matrix4).extractRotation(r.parent.matrixWorld)}o.offsetToPreviousInParent=o.offsetToRestInParent.slice();var h;if(this._playback){h=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(r,l.Translate,this._playback);if(h){o.offsetToPreviousInParent[0]-=h[0];o.offsetToPreviousInParent[1]-=h[1];o.offsetToPreviousInParent[2]-=h[2]}}var c=this._viewport._viewStateManager.getRestTransformation(r);var m=[c.translation[0],c.translation[1],c.translation[2]];if(h){m[0]+=h[0];m[1]+=h[1];m[2]+=h[2]}var u=new t.Quaternion;var p=new t.Vector3;var f=new t.Vector3;r.matrix.decompose(f,u,p);var _=(new t.Matrix4).makeTranslation(-m[0],-m[1],-m[2]);var v=(new t.Matrix4).makeTranslation(-c.translation[0],-c.translation[1],-c.translation[2]);if(p.x===0||p.y===0||p.z===0){p.x=1;p.y=1;p.z=1}var y=(new t.Matrix4).makeScale(1/p.x,1/p.y,1/p.z);var g=(new t.Matrix4).makeRotationFromQuaternion(u.invert());var x=y.clone().multiply(g).multiply(_).multiply(r.matrix);x.decompose(f,u,p);o.offsetToPrevious=f.toArray();var w=y.multiply(g).multiply(v).multiply(r.matrix);w.decompose(f,u,p);o.offsetToRest=f.toArray()}else{if(r.userData.skipUpdateJointNode){this._viewport._viewStateManager._setJointNodeOffsets(r,l.Translate)}if(r.userData&&r.userData.offsetTranslation){o.offsetToRestInParent=r.userData.offsetTranslation.slice()}else{o.offsetToRestInParent=[0,0,0]}o.offsetToPreviousInParent=o.offsetToRestInParent.slice();if(r.userData.skipUpdateJointNode){r.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();r.userData.skipUpdateJointNode=true}var z=this._viewport._viewStateManager.getRestTransformationUsingJoint(r);var M=new t.Vector3;var S=new t.Vector3(z.scale[0],z.scale[1],z.scale[2]);var b=new t.Quaternion(z.quaternion[0],z.quaternion[1],z.quaternion[2],z.quaternion[3]);if(r.userData.offsetScale){S.x*=r.userData.offsetScale[0];S.y*=r.userData.offsetScale[1];S.z*=r.userData.offsetScale[2]}if(r.userData.offsetQuaternion){var P=new t.Quaternion(r.userData.offsetQuaternion[0],r.userData.offsetQuaternion[1],r.userData.offsetQuaternion[2],r.userData.offsetQuaternion[3]);b.multiply(P)}var T=(new t.Matrix4).makeRotationFromQuaternion(b);var D=(new t.Matrix4).makeTranslation(z.translation[0],z.translation[1],z.translation[2]);var I=n.matrixWorld.clone().multiply(D).multiply(T).scale(S);var C=(new t.Matrix4).copy(I).invert().multiply(r.matrixWorld);C.decompose(M,b,S);o.offsetToPrevious=M.toArray();o.offsetToRest=M.toArray()}var V=this._viewport._viewStateManager.getTransformation(r);o.absolute=[V.translation[0],V.translation[1],V.translation[2]];var A=this._viewport._viewStateManager.getTransformationWorld(r);o.world=A.translation;var R;if(this._nodeUserDataMap){R=this._nodeUserDataMap.get(r)}if(R&&R.initialTranslation){o.restDifference=[V.translation[0]-R.initialTranslation[0],V.translation[1]-R.initialTranslation[1],V.translation[2]-R.initialTranslation[2]];if(this._coordinateSystem===a.Parent){o.restDifferenceInCoordinates=o.restDifference.slice()}else{var G=new t.Vector3(o.restDifference[0],o.restDifference[1],o.restDifference[2]).applyMatrix4(s);o.restDifferenceInCoordinates=this._getOffsetToRestInCoordinateSystem(r,G,this._coordinateSystem)}}e.push(o)}.bind(this));return e};c.prototype.endGesture=function(){this._line.visible=false;var e=this._getNodesProperties();var i=this._moveDelta.clone();if(this._coordinateSystem===a.Custom){var r=(new t.Matrix4).extractRotation(this._gizmo.matrixWorld);var o=(new t.Matrix4).copy(r).invert();i.applyMatrix4(o)}delete this._beginValue;this._nodes.forEach(function(e){var t=e.node;if(t.userData){delete t.userData.skipUpdateJointNode}this._viewport._viewStateManager._setJointNodeOffsets(t,l.Translate)}.bind(this));this._tool.fireMoved({x:i.x,y:i.y,z:i.z,nodesProperties:e});this._printEventInfo("Event 'moved'",i.x,i.y,i.z,e)};c.prototype._setOffset=function(e,i){if(this._coordinateSystem===a.Local||this._coordinateSystem===a.Parent){var r=this._nodes[i];var o=r.node;var n=this._getEffectiveParent(o);if(this._coordinateSystem===a.Parent&&n){o=n}var s=(new t.Matrix4).copy(o.matrixWorld).invert();var l=(new t.Vector3).setFromMatrixScale(o.matrixWorld);var d=r.origin.clone().applyMatrix4(s);e=r.origin.clone().add(e).applyMatrix4(s).sub(d).multiply(l)}else if(this._coordinateSystem===a.Screen){var h=this._viewport.getRenderer().getSize(new t.Vector2);var c=this._gizmo.position.clone().applyMatrix4(this._matViewProj);var m=this._gizmo.position.clone().add(e).applyMatrix4(this._matViewProj);e.set(Math.round((m.x-c.x)*.5*h.width),Math.round((m.y-c.y)*.5*h.height),0)}var u=this._getNodesProperties();var p=e.clone();if(this._coordinateSystem===a.Custom){var f=(new t.Matrix4).extractRotation(this._gizmo.matrixWorld);var _=(new t.Matrix4).copy(f).invert();p.applyMatrix4(_)}if(this._tool.fireEvent("moving",{x:p.x,y:p.y,z:p.z,nodesProperties:u},true)){this._printEventInfo("Event 'moving'",p.x,p.y,p.z,u);this._move(e);if(this._coordinateSystem===a.Screen){e.set((new t.Vector3).setFromMatrixColumn(this._matOrigin,0).normalize().dot(e),(new t.Vector3).setFromMatrixColumn(this._matOrigin,1).normalize().dot(e),0)}else if(this._coordinateSystem===a.Custom){var v=this._getAnchorPoint();if(v){var y=(new t.Matrix4).copy(v.matrixWorld).invert();var g=(new t.Vector3).setFromMatrixScale(v.matrixWorld);var x=v.position.clone().applyMatrix4(y);e.copy(v.position.clone().add(e).applyMatrix4(y).sub(x).multiply(g))}}var w=this._line.geometry.getAttribute("position");w.array.set(e.multiplyScalar(-1).toArray());w.needsUpdate=true;this._line.geometry.computeBoundingBox();e.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z));e.multiplyScalar(1/Math.max(e.x,e.y,e.z));this._line.material.color.setRGB(e.x,e.y,e.z);this._line.visible=true}};c.prototype._move=function(e){this._value.addVectors(this._beginValue,e);this._moveDelta.copy(e);this._nodes.forEach(function(e){var t=e.node;if(!t.userData){t.userData={}}t.userData.skipUpdateJointNode=true});if(this._coordinateSystem===a.Local||this._coordinateSystem===a.Parent){this._nodes.forEach(function(t){var i=t.node;var r=this._getEffectiveParent(i);var o=null;if(this._coordinateSystem===a.Parent&&r){o=this._extractBasis(r.matrixWorld)}else{o=this._extractBasis(i.matrixWorld)}var n=t.origin.clone();n.add(o[0].multiplyScalar(e.x)).add(o[1].multiplyScalar(e.y)).add(o[2].multiplyScalar(e.z));i.matrixWorld.setPosition(n);i.matrix.multiplyMatrices(t.matParentInv,i.matrixWorld);i.position.setFromMatrixPosition(i.matrix);i.matrixWorldNeedsUpdate=true}.bind(this))}else{if(this._coordinateSystem===a.Screen){var i=this._viewport.getRenderer().getSize(new t.Vector2);var r=this._viewport.getCamera().getCameraRef();var o=(new t.Vector4).copy(this._gizmo.position).applyMatrix4(this._matViewProj);var n=e.x*2*o.w/(r.projectionMatrix.elements[0]*i.width);var s=e.y*2*o.w/(r.projectionMatrix.elements[5]*i.height);e.setFromMatrixColumn(r.matrixWorld,0).multiplyScalar(n);e.add((new t.Vector3).setFromMatrixColumn(r.matrixWorld,1).multiplyScalar(s))}this._gizmo.position.setFromMatrixPosition(this._matOrigin).add(e);if(this._coordinateSystem===a.Custom){var l=this._getAnchorPoint();if(l){l.position.copy(this._gizmo.position)}}this._nodes.forEach(function(t){if(!t.ignore){var i=t.node;i.matrixWorld.setPosition(t.origin.clone().add(e));i.matrix.multiplyMatrices(t.matParentInv,i.matrixWorld);i.position.setFromMatrixPosition(i.matrix);i.matrixWorldNeedsUpdate=true}})}this._viewport.setShouldRenderFrame()};c.prototype.move=function(e,i,r){this.beginGesture();if(this._coordinateSystem===a.Custom){var o=new t.Vector3(e,i,r);var n=(new t.Matrix4).extractRotation(this._gizmo.matrixWorld);o.applyMatrix4(n);e=o.x;i=o.y;r=o.z}this._move(new t.Vector3(e,i,r||0))};c.prototype.getValue=function(){return this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3?this._value.getComponent(this._handleIndex):0};c.prototype.setValue=function(e){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){this.beginGesture();this._move((new t.Vector3).setComponent(this._handleIndex,e-this._value.getComponent(this._handleIndex)));this.endGesture()}};c.prototype.expandBoundingBox=function(e){if(this._viewport){this._expandBoundingBox(e,this._viewport.getCamera().getCameraRef(),true)}};c.prototype._updateSelection=function(e){r.prototype._updateSelection.call(this,e);if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(e,this._viewport)}};c.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var t=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:t},true);this._gizmoIndex=this._handleIndex=-1}};c.prototype._getSelectionCenter=function(e){r.prototype._getSelectionCenter.apply(this,arguments);var i=this;function o(e,t,i,r){var o=i/2;var a=r/2;e.project(t);e.x=e.x*o+o;e.y=-(e.y*a)+a;return e}function a(e,t,i,r){var o=i/2;var a=r/2;e.x=(e.x-o)/o;e.y=-(e.y-a)/a;e.unproject(t);return e}function s(e,r,o){var n=new t.Vector3(i._gizmoSize,i._gizmoSize,0);var s=new t.Vector3(r-i._gizmoSize,i._gizmoSize,0);var l=new t.Vector3(r-i._gizmoSize,o-i._gizmoSize,0);var d=new t.Vector3(i._gizmoSize,o-i._gizmoSize,0);var h=[a(n,e,r,o),a(s,e,r,o),a(l,e,r,o),a(d,e,r,o)];return h[0].add(h[1]).add(h[2]).add(h[3]).multiplyScalar(.25)}if(this._placementMode===n.OnScreen){var l=this._viewport.getDomRef().getBoundingClientRect();var d=l.width;var h=l.height;var c=this._viewport.getCamera().getCameraRef();var m=o(e.clone(),c,d,h);var u=m.clone();var p=[u.x<this._gizmoSize&&u.setX(i._gizmoSize)||u.x>d-this._gizmoSize&&u.setX(d-i._gizmoSize),u.y<this._gizmoSize&&u.setY(i._gizmoSize)||u.y>h-this._gizmoSize&&u.setY(h-i._gizmoSize)].some(function(e){return e!==false})&&e.copy(a(u,c,d,h));return m.z>1&&e.copy(s(c,d,h))||p||e}else if(this._placementMode===n.ObjectCenter&&this._nodes.length===1){var f=new t.Vector3;if(this._nodes[0].node.userData.boundingBox){this._nodes[0].node.userData.boundingBox.getCenter(f)}else{var _=new t.Box3;_.expandByObject(this._nodes[0].node);_.getCenter(f)}e.copy(f.applyMatrix4(this._nodes[0].node.matrixWorld))}};c.prototype._updateGizmoTransformation=function(e,t){var i=this._updateGizmoObjectTransformation(this._gizmo,e,true);this._updateAxisTitles(this._axisTitles,this._gizmo,t,this._gizmoSize+18,i);this._line.scale.setScalar(1/(this._gizmoSize*i))};c.prototype._getEditingFormPosition=function(){var e=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex,true);var i=(new t.Vector3).setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return i.clone().multiplyScalar((this._gizmoSize+18)*e).add(this._gizmo.position).applyMatrix4(this._matViewProj)};c.prototype.render=function(){d(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var e=this._viewport.getRenderer(),t=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);e.clearDepth();for(var i=0,r=this.getGizmoCount();i<r;i++){this._updateGizmoTransformation(i,t);e.render(this._sceneGizmo,t)}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex)};return c});