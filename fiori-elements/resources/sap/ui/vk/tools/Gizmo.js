/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../library","sap/m/library","sap/m/Input","sap/m/Label","sap/ui/core/library","sap/ui/core/Control","./CoordinateSystem","./AxisColours","./ToolNodeSet","../thirdparty/three","./GizmoPlacementMode","../AnimationTrackType"],function(t,e,i,a,n,o,r,s,l,p,u,c){"use strict";var h=e.InputType;var f=o.extend("sap.ui.vk.tools.Gizmo",{metadata:{library:"sap.ui.vk"},renderer:{render:function(t,e){}}});f.prototype.hasDomElement=function(){return true};f.prototype._drawText=function(t,e,i,a){var n=window.devicePixelRatio;var o=t.width;var r=t.height;var s=o*.5;var l=r*.5;var p=t.getContext("2d");p.clearRect(0,0,o,r);p.font="Bold "+i*n+"px Arial";p.textAlign="center";p.textBaseline="middle";p.fillStyle="#000";p.globalAlpha=.5;p.filter="blur(3px)";p.fillText(e,s+1,l+1);p.fillStyle="#fff";p.globalAlpha=1;p.filter="blur(0px)";p.fillText(e,s,l);if(a){p.beginPath();p.arc(s,l,s-n,0,2*Math.PI,false);p.closePath();p.lineWidth=n*2;p.strokeStyle="#fff";p.stroke()}};f.prototype._createTextMesh=function(t,e,i,a,n,o){var r=window.devicePixelRatio;var s=document.createElement("canvas");s.width=e*r;s.height=i*r;this._drawText(s,t,a,o);var l=new p.Texture(s);l.needsUpdate=true;var u=new p.MeshBasicMaterial({map:l,color:n,transparent:true,alphaTest:.05,premultipliedAlpha:true,side:p.DoubleSide});var c=new p.Mesh(new p.PlaneGeometry(e,i),u);c.userData.color=n;return c};f.prototype._createAxisTitles=function(t,e,i,a){t=t||32;e=e||20;var n=new p.Group;n.add(this._createTextMesh("X",t,t,e,s.x,i));n.add(this._createTextMesh("Y",t,t,e,s.y,i));n.add(this._createTextMesh("Z",t,t,e,s.z,i));if(a){n.add(this._createTextMesh("-X",t,t,e,s.x,i));n.add(this._createTextMesh("-Y",t,t,e,s.y,i));n.add(this._createTextMesh("-Z",t,t,e,s.z,i))}return n};f.prototype._extractBasis=function(t){var e=[new p.Vector3,new p.Vector3,new p.Vector3];t.extractBasis(e[0],e[1],e[2]);e[0].normalize();e[1].normalize();e[2].normalize();return e};f.prototype._updateAxisTitles=function(t,e,i,a,n){var o=this._extractBasis(e.matrixWorld);t.children.forEach(function(t,e){var n=a.constructor===p.Vector3?a.getComponent(e%3):a;t.position.copy(o[e%3]).multiplyScalar(n*(e<3?1:-1));t.quaternion.copy(i.quaternion)});t.position.copy(e.position);t.scale.setScalar(n)};f.prototype._updateSelection=function(t){if(t===null){return false}var e=[];if(this._tool){if(this._tool.getNodeSet()===l.Highlight){t.enumerateSelection(function(t){e.push({node:t})})}else{t.enumerateOutlinedNodes(function(t){e.push({node:t})})}}if(this._nodes.length===e.length&&this._nodes.every(function(t,i){return e[i].node===t.node})){return false}this._cleanTempData();this._nodes=e;e.forEach(function(t){t.ignore=false;var i=t.node.parent;while(i&&!t.ignore){for(var a=0,n=e.length;a<n;a++){if(e[a].node===i){t.ignore=true;break}}i=i.parent}this._getOffsetForRestTransformation(t.node)}.bind(this));return true};f.prototype.setPlacementMode=function(t){this._placementMode=t};f.prototype._getAnchorPoint=function(){return this._viewport?this._viewport._anchorPoint:null};f.prototype._getSelectionCenter=function(t){if(this._nodes.length===1){var e=this._nodes[0].node;t.setFromMatrixPosition(e.matrixWorld);var i;if(this._nodeUserDataMap){i=this._nodeUserDataMap.get(e)}if(this._placementMode===u.Rest&&i&&i.offsetWTranslation){t.x+=i.offsetWTranslation[0];t.y+=i.offsetWTranslation[1];t.z+=i.offsetWTranslation[2]}}else{t.setScalar(0);if(this._nodes.length>0){var a=new p.Vector3;this._nodes.forEach(function(e){var i=e.node;if(i.userData.boundingBox){i.userData.boundingBox.getCenter(a);t.add(a.applyMatrix4(i.matrixWorld))}else{t.add(a.setFromMatrixPosition(i.matrixWorld))}});t.multiplyScalar(1/this._nodes.length)}}};f.prototype._getGizmoScale=function(t){var e=this._viewport.getRenderer();var i=this._viewport.getCamera().getCameraRef();var a=new p.Vector4;a.copy(t).applyMatrix4(this._matViewProj);return a.w*2/(e.getSize(new p.Vector2).x*i.projectionMatrix.elements[0])};f.prototype._getEffectiveParent=function(t){if(this._viewport._viewStateManager){var e=this._viewport._viewStateManager.getJoints();if(e){for(var i=0;i<e.length;i++){var a=e[i];if(!a.node||!a.parent){continue}if(a.node===t){return a.parent}}}}return t.parent};f.prototype._cleanTempData=function(){this._nodes.forEach(function(t){var e=t.node;if(e.userData){delete e.userData.skipUpdateJointNode}});if(this._nodeUserDataMap){this._nodeUserDataMap.clear()}this._sequence=null};f.prototype._prepareForCreatingKey=function(t){this._playback=t};f.prototype._getOffsetForRestTransformation=function(t){if(this._viewport._viewStateManager){if(!this._nodeUserDataMap){this._nodeUserDataMap=new Map}var e=this._nodeUserDataMap.get(t);if(!e){e={};this._nodeUserDataMap.set(t,e)}var i=this._viewport._viewStateManager.getTransformation(t);var a=this._viewport._viewStateManager.getRestTransformation(t);var n=this._viewport._viewStateManager.getRestTransformationWorld(t);var o=this._viewport._viewStateManager.getTransformationWorld(t);if(!a||!n){return}var r=new p.Vector3(a.translation[0],a.translation[1],a.translation[2]);var s=new p.Vector3(a.scale[0],a.scale[1],a.scale[2]);e.quatRest=new p.Quaternion(a.quaternion[0],a.quaternion[1],a.quaternion[2],a.quaternion[3]);e.matRest=(new p.Matrix4).compose(r,e.quatRest,s);e.matRestInv=(new p.Matrix4).copy(e.matRest).invert();e.initialTranslation=i.translation.slice();e.initialScale=i.scale.slice();e.initialQuaternion=new p.Quaternion(i.quaternion[0],i.quaternion[1],i.quaternion[2],i.quaternion[3]);e.matInitial=t.matrix.clone();e.matInitialInv=(new p.Matrix4).copy(t.matrix).invert();e.quatInitialDiff=e.initialQuaternion.clone().multiply(e.quatRest.clone().invert());e.quatInitialDiffInv=e.quatInitialDiff.clone().invert();e.matInitialDiff=t.matrix.clone().multiply(e.matRestInv);e.offsetWTranslation=[n.translation[0]-o.translation[0],n.translation[1]-o.translation[1],n.translation[2]-o.translation[2]];var l=new p.Vector3;var u=new p.Box3;u.expandByObject(t);u.getCenter(l);e.offsetWTranslationCenter=[n.translation[0]+l.x-2*o.translation[0],n.translation[1]+l.y-2*o.translation[1],n.translation[2]+l.z-2*o.translation[2]];var h=[0,0,0];var f=this._viewport._viewStateManager.getAnimationPlayer();if(f){var d=f.getAnimatedProperty(t,c.Rotate);if(d.offsetToPrevious){h=d.offsetToPrevious}}e.euler=new p.Euler(0,0,0);e.startEuler=new p.Euler(0,0,0);e.eulerInParentCoors=new p.Euler(h[0],h[1],h[2]);e.startEulerInParentCoors=new p.Euler(h[0],h[1],h[2])}};f.prototype._updateGizmoObjectTransformation=function(t,e,i){var a=this._viewport.getCamera().getCameraRef();var n=this._getAnchorPoint();var o,s,l;if(n&&this._coordinateSystem===r.Custom){t.position.copy(n.position);t.quaternion.copy(n.quaternion)}else if(this._coordinateSystem===r.Local||this._coordinateSystem===r.Parent){l=this._nodes[e].node;var p=this._getEffectiveParent(l);if(this._coordinateSystem===r.Parent&&p){s=p.matrixWorld}o=l.matrixWorld.clone();if(s){s.decompose(t.position,t.quaternion,t.scale);t.position.setFromMatrixPosition(o)}else{o.decompose(t.position,t.quaternion,t.scale)}var c;if(this._nodeUserDataMap){c=this._nodeUserDataMap.get(l)}if(this._placementMode===u.Rest&&c&&c.offsetWTranslation){if(i){t.position.x+=c.offsetWTranslationCenter[0];t.position.y+=c.offsetWTranslationCenter[1];t.position.z+=c.offsetWTranslationCenter[2]}else{t.position.x+=c.offsetWTranslation[0];t.position.y+=c.offsetWTranslation[1];t.position.z+=c.offsetWTranslation[2]}o.setPosition(t.position)}}else if(this._nodes.length>0){this._getSelectionCenter(t.position);if(this._coordinateSystem===r.Screen){t.quaternion.copy(a.quaternion)}else{t.quaternion.set(0,0,0,1)}}var h=this._getGizmoScale(t.position);t.scale.setScalar(this._gizmoSize*h);if(o){var f=this._extractBasis(s?s:o);t.matrix.makeBasis(f[0],f[1],f[2]);t.matrix.scale(t.scale);t.matrix.copyPosition(o);t.matrixAutoUpdate=false}else{t.matrixAutoUpdate=true}t.updateMatrixWorld(true);return h};f.prototype._expandBoundingBox=function(t,e,i){var a=this.getGizmoCount();if(a>0){this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);for(var n=0;n<a;n++){this._updateGizmoTransformation(n,e);this._sceneGizmo._expandBoundingBox(t,i,false)}}};f.prototype._createEditingForm=function(t,e){this._label=new sap.m.Label({}).addStyleClass("sapUiVkTransformationToolEditLabel");this._units=new sap.m.Label({text:t}).addStyleClass("sapUiVkTransformationToolEditUnits");this._input=new i({width:e+"px",type:h.Number,maxLength:10,textAlign:n.TextAlign.Right,change:function(t){this.setValue(t.getParameter("value"))}.bind(this)});this._editingForm=new sap.m.HBox({items:[this._label,this._input,this._units]}).addStyleClass("sapUiSizeCompact");this._editingForm.onkeydown=this._editingForm.ontap=this._editingForm.ontouchstart=function(t){t.setMarked()}};f.prototype._getValueLocaleOptions=function(){return{useGrouping:false}};f.prototype._updateEditingForm=function(t,e,i){var a=this.getDomRef();if(a){if(t&&this._tool&&this._tool.getShowEditingUI()){this._label.setText(i||["X","Y","Z"][e]);this._label.rerender();var n=this._label.getDomRef();if(n){n.style.color=new p.Color(s[["x","y","z"][e]]).getStyle()}this._input.setValue(this.getValue().toLocaleString("fullwide",this._getValueLocaleOptions()));var o=this._getEditingFormPosition();var r=this._gizmo.position.clone().applyMatrix4(this._matViewProj).sub(o);var l=this._viewport.getDomRef().getBoundingClientRect();var u=a.getBoundingClientRect();var c=r.x>-1e-4;var h=c?u.width:-u.width;var f=u.height*.5;var d=p.MathUtils.clamp(l.width*(o.x*.5+.5)+(c?-20:20),Math.max(h,0),l.width+Math.min(h,0));var m=p.MathUtils.clamp(l.height*(o.y*-.5+.5),f,l.height-f);a.style.left=Math.round(d)+"px";a.style.top=Math.round(m)+"px";a.style.transform="translate("+(c?"-100%":"0%")+", -50%)";a.style.display="block"}else{a.style.display="none"}}};return f});