/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","./AnimationMath","./AnimationTrackType","./AnimationTrackValueType","./glMatrix","sap/ui/core/Core"],function(e,t,a,i,r,n,o){"use strict";var s=e.extend("sap.ui.vk.AnimationPlayer",{metadata:{library:"sap.ui.vk",associations:{viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{viewActivated:{type:"sap.ui.vk.View"},beforeTimeChanged:{time:{type:"float"},nextTime:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"},nextPlayback:{type:"sap.ui.vk.AnimationPlayback"}},timeChanged:{time:{type:"float"},previousTime:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"},previousPlayback:{type:"sap.ui.vk.AnimationPlayback"}},stateChanged:{playing:{type:"boolean"},stopped:{type:"boolean"},endOfAnimation:{type:"boolean"}}}},constructor:function(a,i){e.apply(this,arguments);t.observeLifetime(this)}});s.prototype._getViewStateManager=function(){var e=this.getViewStateManager();return e?o.byId(e):undefined};s.prototype.init=function(){this._step=this._step.bind(this);this._playbackCollection=null;this._currentPlayback=null;this._time=0;this._nodeChanges=new Map;t.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);t.getEventBus().subscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);t.getEventBus().subscribe("sap.ui.vk","playbacksChanged",this._onPlaybacksChanged,this);t.getEventBus().subscribe("sap.ui.vk","trackChanged",this._onTrackChanged,this);t.getEventBus().subscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this)};s.prototype.exit=function(){this._playbackCollection=null;this._currentPlayback=null;t.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);t.getEventBus().unsubscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);t.getEventBus().unsubscribe("sap.ui.vk","playbacksChanged",this._onPlaybacksChanged,this);t.getEventBus().unsubscribe("sap.ui.vk","trackChanged",this._onTrackChanged,this);t.getEventBus().unsubscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this)};s.prototype._onViewApplied=function(e,t,a){if(a.source==null||a.source.getId()!==this.getViewStateManager()){return}var i=a.view;var r=a.ignoreAnimationPosition;this.activateView(i,r)};s.prototype._onSequenceChanged=function(e,t,a){if(this._currentPlayback){var i=this._getViewStateManager();var r=this._currentPlayback.getSequence();if(i&&r){if(r.getId()===a.sequenceId){i.setJoints(r.getJoint(),this._currentPlayback)}}}this._clearPlaybackBoundaryProperties();this._setPlaybackBoundaryProperties()};s.prototype._resetNodesAnimation=function(e,t){if(!Array.isArray(e)){e=[e]}var a=this._getViewStateManager();e.forEach(function(e){if(t){a.resetNodeProperty(e,t)}else{a.resetNodeProperty(e);a.resetNodeProperty(e,i.Opacity)}})};s.prototype._onPlaybacksChanged=function(e,t,a){if(a.operation==="playbackRemoved"&&this._currentPlayback&&this._currentPlayback===a.playback&&this._currentPlayback.getSequence()){var i=this._currentPlayback.getSequence().getNodeAnimation();var r=i.map(function(e){return e.nodeRef});this._resetNodesAnimation(r)}this._clearPlaybackBoundaryProperties()};s.prototype._onTrackChanged=function(e,t,a){if(a.emptyTrack&&this._currentPlayback){var r=this._getViewStateManager();var n=this._currentPlayback.getSequence();if(r&&n){var o=n.getNodeAnimation();o.forEach(function(e){for(var t in i){var n=i[t];var o=e[n];if(o&&o.getId()===a.trackId){r.resetNodeProperty(e.nodeRef,n);return}}})}this._setPlaybackBoundaryProperties()}};s.prototype._onNodeAnimationRemoved=function(e,t,a){if(this._currentPlayback){var i=this._getViewStateManager();var r=this._currentPlayback.getSequence();if(i&&r){if(r.getId()===a.sequenceId){i.setJoints(r.getJoint(),this._currentPlayback);this._resetNodesAnimation(a.nodeRefs,a.property)}}}this._clearPlaybackBoundaryProperties()};s.prototype.getAnimatedProperty=function(e,t){var a={};var r=this._getViewStateManager();if(!r){return null}if(t!==i.Opacity){var n=r.getTransformationWorld(e);if(t===i.Rotate){a.world=n.quaternion}else if(t===i.Translate){a.world=n.translation}else{a.world=n.scale}}var o=this._nodeChanges.get(e);if(!o||o[t]===undefined){a.offsetToPrevious=null;a.offsetToRest=null;if(t===i.Opacity){a.absolute=r.getOpacity(e);a.totalOpacity=r.getTotalOpacity(e)}else{var s=r.getTransformation(e);if(t===i.Rotate){a.absolute=s.quaternion}else if(t===i.Translate){a.absolute=s.translation}else{a.absolute=s.scale}}return a}if(t===i.Opacity){var l=o[t];a.offsetToRest=l;a.offsetToPrevious=o.offsetToPrevious[t];a.opacity=o.absolute.opacity;a.totalOpacity=o["totalOpacity"];return a}var u=o[t];a.offset=u;if(t===i.Rotate){a.absolute=o.absolute.quaternion}else if(t===i.Translate){a.absolute=o.absolute.translate}else{a.absolute=o.absolute.scale}a.offsetToPrevious=o.offsetToPrevious[t];a.offsetToRest=o[t];return a};s.prototype.setTime=function(e,t,a){this._setPlaybackBoundaryProperties();this._setTime(e,t,a);return this};s.prototype._setTime=function(e,t,a){var r=this._time;var n=this._currentPlayback;if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){this._currentPlayback=undefined;this._time=0}else{if(t!=null){e=this._getAbsoluteTime(e,t)}var o=this._getViewStateManager();var s=this._currentPlayback;var l;if(e<0||e>this.getTotalDuration()){l=undefined}else if(t!=null){l=this._playbackCollection.getPlayback(t)}else{l=this._findPlaybackByAbsoluteTime(e)}var u=false;if(l&&l.getReversed()){if(this._currentPlayback&&l.getJSONData().startTime>this._currentPlayback.getJSONData().startTime){u=true}}else if(l&&this._currentPlayback&&l.getJSONData().startTime<this._currentPlayback.getJSONData().startTime){u=true}if(!a&&(e!==this._time||l!==this._currentPlayback)){this.fireBeforeTimeChanged({time:this._time,nextTime:e,currentPlayback:this._currentPlayback,nextPlayback:l})}this._time=e;this._currentPlayback=l;if(o&&this._currentPlayback&&s!==this._currentPlayback){var c=this._currentPlayback.getSequence();if(c){o.setJoints(c.getJoint(),this._currentPlayback)}}else if(!this._currentPlayback||!this._currentPlayback.getSequence()){o.setJoints(undefined)}if(o){var f={nodeRefs:[],positions:[]};var y={nodeRefs:[],opacities:[]};this._collectNodeChanges();this._nodeChanges.forEach(function(e,t){var a={rtranslate:e.rtranslate,rscale:e.rscale,rrotate:e.rrotate,Euler:e.Euler,ropacity:e.offsetToPrevious&&e.offsetToPrevious.ropacity?e.offsetToPrevious.ropacity:e.ropacity};o.setInterpolatedRelativeValues(t,a);var r=o.getRestTransformation(t);var n=o._addToTransformation(r,e.rtranslate,e.rrotate,e.rscale,e.originalRotationType,e.Euler);if(n){f.nodeRefs.push(t);f.positions.push(n);e.absolute={};e.absolute.translate=n.translation;e.absolute.scale=n.scale;e.absolute.quaternion=n.quaternion}if(u&&e[i.Opacity]===undefined){e[i.Opacity]=1;t.userData.opacity=undefined}if(e[i.Opacity]!==undefined){var s=o.getRestOpacity(t);if(s===0){s=1}var l=e[i.Opacity]*s;t.userData.animatedOpacity=true;e.absolute={};e.absolute.opacity=l;y.nodeRefs.push(t);y.opacities.push(l)}},this);o.setTransformation(f.nodeRefs,f.positions);o.setOpacity(y.nodeRefs,y.opacities);o._propagateOpacityToJointChildren(y.nodeRefs,y.opacities);o._setJointNodeMatrix();this._nodeChanges.forEach(function(e,t){if(e[i.Opacity]!==undefined){e.totalOpacity=o.getTotalOpacity(t)}},this)}}if(!a&&(this._time!==r||this._currentPlayback!==n)){this.fireTimeChanged({time:this._time,previousTime:r,currentPlayback:this._currentPlayback,previousPlayback:n})}};s.prototype.getTime=function(){return this._time};s.prototype.getCurrentPlayback=function(){return this._currentPlayback};s.prototype.getCurrentPlaybackTime=function(){var e=this._time;var t=this._playbackCollection.getPlaybacks();if(!Array.isArray(t)||!this.getCurrentPlayback()){return-1}var a=0;while(t[a]!=this.getCurrentPlayback()){e-=t[a].getDuration();a++}return e};s.prototype.getStartTime=function(e){if(!this._playbackCollection){return undefined}if(typeof e==="number"){e=this._playbackCollection.getPlayback(e)}return e?e.getStartTime():undefined};s.prototype.getTotalDuration=function(){if(!this._playbackCollection){return 0}var e=0;this._playbackCollection.getPlaybacks().forEach(function(t){e+=t.getDuration()});return e};s.prototype._step=function(e){this._frameId=undefined;if(!this._lastFrameTimestamp){this._lastFrameTimestamp=e}var t=e-this._lastFrameTimestamp;this._lastFrameTimestamp=e;var a=this.getTime()+t/1e3;var i=a>=0&&a<=this.getTotalDuration();if(a>this.getTotalDuration()){a=this.getTotalDuration()}this.setTime(a);if(i){this._frameId=window.requestAnimationFrame(this._step)}else{this.stop()}};s.prototype._interpolate=function(e,t,i,n,o){if(!t.before&&!t.after){return undefined}if(!t.before){t.before=t.after}if(!t.after){if(e===r.AngleAxis){t.after={value:[0,0,1,0],time:t.before.time}}else{t.after=t.before}}var s;if(t.before.time===t.after.time){s=1}else{s=(t.time-t.before.time)/(t.after.time-t.before.time)}return a.interpolate(e,t.before,t.after,s,i,n,o)};s.getBoundaryKey=function(e,t){var i=e.getKeysCount();if(!i){return null}var n;if(t){n=e.getKey(0)}else{n=e.getKey(i-1)}var o=e.getKeysType();var s,l={};if(o===r.Euler){l[o]=n.value;s=a.neutralEulerToGlMatrixQuat(n.value);l.value=a.glMatrixQuatToNeutral(s);l.time=n.time}else if(o===r.Quaternion){s=a.neutralQuatToGlMatrixQuat(n.value);l.value=a.glMatrixQuatToNeutral(s);l.time=n.time}else if(o!==r.AngleAxis){l.value=n.value;l.time=n.time}else{var u;var c=1;if(t){u=n;if(i>1){u=e.getKey(1);c=0}}else{u=n;if(i>1){n=e.getKey(i-2)}}l=a.interpolate(o,n,u,c,e);l.time=t?n.time:u.time}return l};s.prototype._getKeyFramesBracket=function(e,t){var a=t.getKeysCount();if(a===0){return null}var i={time:e,before:undefined,after:undefined};for(var r=0;r<a;r++){var n=t.getKey(r);if(n.time===e){i.before=i.after=n;break}else if(n.time>e){i.before=r===0?undefined:t.getKey(r-1);i.after=n;break}}if(!i.before&&!i.after&&a>0){i.before=t.getKey(a-1)}if(a>1&&(!i.after&&t.isCycleForward()||!i.before&&t.isCycleBackward())){var o=t.getKey(0).time;var s=t.getKey(a-1).time-o;var l=Math.floor((e-o)/s);var u=e-s*l;return this._getKeyFramesBracket(u,t)}return i};s.prototype._collectNodeChangesFromPlaybackBoundaryKeys=function(e,t,a){var r=t.getSequence();if(!r){return}var n=r.getNodeAnimation();if(!n){return}var o=this._getViewStateManager();var s=this;var l=function(t,a,r){if(!t||!a||r===undefined||r===null){return}var n=e.get(t);if(n&&n.hasOwnProperty(a)){return}if(!n){n={};e.set(t,n)}if(!n.offsetToPrevious){n.offsetToPrevious={}}if(a===i.Opacity){n[a]=r;if(!n.offsetToPrevious[a]){var l=o.getOpacity(t);var u=o.getRestOpacity(t);if(u===0){u=1}if(u>0&&(l!==undefined||l!==null)){var c=o._getEndPropertyInPreviousPlayback(t,a,s._currentPlayback);if(c){l/=c}n.offsetToPrevious[a]=l/u}else{n.offsetToPrevious[a]=1}}}else{n[a]=r.slice();var f=o.getRelativeTransformation(t);if(a===i.Scale){if(!n.offsetToPrevious[a]){n.offsetToPrevious[a]=f.scale.slice();var y=o._getEndPropertyInPreviousPlayback(t,a,s._currentPlayback);if(y){n.offsetToPrevious[a][0]/=y[0];n.offsetToPrevious[a][1]/=y[1];n.offsetToPrevious[a][2]/=y[2]}}}if(a===i.Translate){if(!n.offsetToPrevious[a]){n.offsetToPrevious[a]=f.translation.slice();var h=o._getEndPropertyInPreviousPlayback(t,a,s._currentPlayback);if(h){n.offsetToPrevious[a][0]-=h[0];n.offsetToPrevious[a][1]-=h[1];n.offsetToPrevious[a][2]-=h[2]}}}if(a===i.Rotate){n.offsetToPrevious[a]=[0,0,1,0]}else if(!n.offsetToPrevious[a]){n.offsetToPrevious[a]=[0,0,0]}}};var u;if(a){u=t._getNodeEndPropertiesMap()}else{u=t._getNodeStartPropertiesMap()}if(!u){return}var c=this._currentPlayback&&this._currentPlayback.getSequence();if(c){u.forEach(function(e,t){for(var a in e){if(c._isNodePropertyDefined(t,a)){continue}l(t,a,e[a])}},this)}};s.prototype._collectSequenceNodeChanges=function(e,t,o){var s=o.getSequence();var l=s&&s.getNodeAnimation();if(!l){return}var u=this._getViewStateManager();var c=function(e,s,l,c){if(!e||!s||!l||l.value===undefined||l.value===null){return}var f=t.get(e);if(!f){f={};t.set(e,f)}if(!f.animationProperties){f.animationProperties={}}f.animationProperties[s]=true;if(c){f.originalRotationType=c}if(!f.offsetToPrevious){f.offsetToPrevious={}}var y;if(s===i.Opacity){f[s]=l.value;f.offsetToPrevious[s]=l.value;y=u._getEndPropertyInPreviousPlayback(e,s,o,true);if(y){f[s]*=y}}else{f[s]=l.value.slice();f.offsetToPrevious[s]=l.value.slice();y=u._getEndPropertyInPreviousPlayback(e,s,o);if(y){if(s===i.Translate){f[s][0]+=y[0];f[s][1]+=y[1];f[s][2]+=y[2]}else if(s===i.Scale){f[s][0]*=y[0];f[s][1]*=y[1];f[s][2]*=y[2]}}}if(c===r.Euler||c===r.AngleAxis){f[c]=l[c].slice();f.offsetToPrevious[s]=l[c].slice();if(y){var h=a.neutralQuatToGlMatrixQuat(y);var p=a.neutralQuatToGlMatrixQuat(f[s]);var g=n.quat.multiply(n.quat.create(),p,h);f[s]=a.glMatrixQuatToNeutral(g)}}};var f=o.getReversed();var y=s.getDuration();l.forEach(function(t){var a;for(var n in i){var o=i[n];var s=t[o];if(s&&s.getKeysCount()>0){a=this._getKeyFramesBracket(e,s);if(!a){return}var l=s.getKeysType();var u=null;if(f){if(l===r.AngleAxis){u=this._interpolate(l,a,s,o,true)}else{var h=this._getKeyFramesBracket(y,s);var p=this._interpolate(l,h,s,o);u=this._interpolate(l,a,s,o,p.value)}}else{u=this._interpolate(l,a,s,o)}if(o===i.Rotate){c(t.nodeRef,o,u,l)}else{c(t.nodeRef,o,u)}}}},this)};s.prototype._collectPlaybackNodeChanges=function(e,t,a){var i=a.getSequence();if(!i){return}var r=e-a.getStartTime();if(r<0){return}var n=i.getDuration()*a.getTimeScale()*a.getRepeats();var o=(r-a.getPreDelay())/a.getTimeScale();var s=1e-4;if(o>0&&o%i.getDuration()===0){o=i.getDuration()}else if(o>i.getDuration()+s){o=o%i.getDuration()}else if(o>i.getDuration()){o=i.getDuration()}o=a.getReversed()?i.getDuration()-o:o;if(r<a.getPreDelay()){this._collectSequenceNodeChanges(0,t,a)}else if(r>a.getPreDelay()+n){this._collectSequenceNodeChanges(i.getDuration()*a.getRepeats(),t,a)}else{this._collectSequenceNodeChanges(o,t,a)}};s.prototype._collectNodeChanges=function(){this._nodeChanges.clear();if(!this._currentPlayback){return}var e=this._playbackCollection.getPlaybacks();var t=this.getTime();var a;var i=0;for(a=0;a<e.length;a++){if(this._currentPlayback&&this._currentPlayback!==e[a]){continue}this._collectPlaybackNodeChanges(t,this._nodeChanges,e[a]);i=a}if(!this._currentPlayback.getReversed()){for(a=i-1;a>=0;a--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,e[a],true)}for(a=i+1;a<e.length;a++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,e[a],false)}}else{for(a=i+1;a<e.length;a++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,e[a],false)}for(a=i-1;a>=0;a--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,e[a],true)}}};s.prototype._clearPlaybackBoundaryProperties=function(){if(!this._playbackCollection){return}var e=this._playbackCollection.getPlaybacks();for(var t=0;e&&t<e.length;t++){var a=e[t];if(!a){continue}a._clearNodesBoundaryProperties()}};s.prototype._setPlaybackBoundaryProperties=function(e){if(!this._playbackCollection){return}var t=this._time;var a=this._currentPlayback;var i=false;var r=this._playbackCollection.getPlaybacks();var n;var o=0;var s,l;if(e){this._clearPlaybackBoundaryProperties()}for(n=0;n<r.length;n++){s=r[n];if(!s){continue}var u=this._getViewStateManager();l=s.getSequence();if(u&&l){if(!e&&s._hasCompleteNodesBoundaryProperties()){continue}o=s.getPreDelay();this._setTime(o,n,true);s._setCurrentNodesPropertiesAsBoundary(u,false,e);o+=l.getDuration()*s.getTimeScale()*s.getRepeats();this._setTime(o,n,true);s._setCurrentNodesPropertiesAsBoundary(u,true,e);i=true}}if(i){if(!a){this._time=t;this._setTime(this._time,null,true);this._currentPlayback=a}else{var c=-1;var f=0;for(n=0;n<r.length;n++){s=r[n];if(s===a){c=n;break}var y=0;l=s.getSequence();if(l){y=l.getDuration()*s.getTimeScale()*s.getRepeats()}f+=s.getPreDelay()+y+s.getPostDelay()}if(c!==-1){var h=t-f;this._setTime(h,c,true)}}}};s.prototype.play=function(){this._lastFrameTimestamp=undefined;this._frameId=this._frameId||window.requestAnimationFrame(this._step);t.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:true,stopped:false,endOfAnimation:false});this.fireStateChanged({playing:true,stopped:false});return this};s.prototype.stop=function(){if(this._frameId){window.cancelAnimationFrame(this._frameId);this._frameId=undefined}this._lastFrameTimestamp=undefined;this.fireStateChanged({playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});t.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});return this};s.prototype.activateView=function(e,t){this.stop();var a=this._getViewStateManager();var i=e.getPlaybacks();if(i&&i.length>0){for(var r=0;r<i.length;r++){var n=i[r];var o=n.getSequence();if(o){a._convertTracksToRelative(o,n.getReversed())}}}if(!t){this._playbackCollection=e}else{this._playbackCollection=undefined}this._currentPlayback=undefined;this.setTime(0);if(t){this._playbackCollection=e}this.fireViewActivated({view:e});return this};s.prototype._getAbsoluteTime=function(e,t){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return-1}var a=this._playbackCollection.getPlaybacks();if(t<0||t>=a.length){return-1}var i=this._playbackCollection.getPlayback(t);if(!i||i.getDuration()<e||e<0){return-1}var r=e;var n=0;while(n<t){var o=a[n].getDuration();r+=o;n++}return r};s.prototype._findPlaybackByAbsoluteTime=function(e){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return undefined}var t=this._playbackCollection.getPlaybacks();var a=-1;var i=-1;t.forEach(function(e,t){if(e.getStartTime()>i){a=t;i=e.getStartTime()}});var r=0;while(r<t.length){var n=t[r].getDuration();var o=t[r].getStartTime();if(r!==a&&e>=o&&e<o+n||r===a&&e>=o&&e<=o+n){return t[r]}r++}return undefined};return s});