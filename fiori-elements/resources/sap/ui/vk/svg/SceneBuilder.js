/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./Element","./Ellipse","./Rectangle","./Line","./Polyline","./Path","./Text","./Image","./LinearGradient","./OrthographicCamera","../View","../NodeContentType","../NavigationMode","../TransformationMatrix","../getResourceBundle","../totara/TotaraUtils","../colorToCSSColor"],function(e,t,i,r,a,s,n,o,h,d,l,u,p,c,m,f,_,v){"use strict";var g=function(e,t,i,r){this._rootNode=e;this._contentResource=t;this._resolve=i;this._reject=r;this._cameras=new Map;this._sceneIdTreeNodesMap=new Map;this._sceneIdRootNodeMap=new Map;this._materialMap=new Map;this._annotationsMap=new Map;this._annotationNodesMap=new Map;this._materialNodesMap=new Map;this._nodes=new Map;this._viewGroups=new Map;this._views=new Map;this._viewThumbnails=new Map;this._geometries=new Map;this._geometryMeshes=new Map;this._meshNodes=new Map;this._meshSubmeshes=new Map;this._images=new Map;this._imageTextures=new Map;this._fillStyles=new Map;this._lineStyles=new Map;this._textStyles=new Map;this._joints=new Map;this._yIndex=1;this._materialsByTextureImageId=new Map;if(t){var a=t.getNodeProxy();var s=a.getNodeHierarchy();this._vkScene=s.getScene();var n=t.getSource();if(n&&n.name){this._sceneIdTreeNodesMap.set(n.name,this._nodes);this._sceneIdRootNodeMap.set(n.name,e);this._currentSceneId=n.name}if(this._rootNode){this._rootNode.userData.skipIt=!t.getName()}}};g.prototype.setScene=function(t){if(t.result!==0){var i={status:t.result};switch(t.result){case-1:i.errorText=f().getText("LOADER_FILENOTFOUND");break;case-2:i.errorText=f().getText("LOADER_WRONGFILEFORMAT");break;case-3:i.errorText=f().getText("LOADER_WRONGPASSWORD");break;case-4:i.errorText=f().getText("LOADER_ERRORREADINGFILE");break;case-5:i.errorText=f().getText("LOADER_FILECONTENT");break;default:i.errorText=f().getText("LOADER_UNKNOWNERROR")}this._reject(i)}else{this._yIndex=1;this._rootNode.matrix[3]=t.upAxis===2?-1:1;var r=this._cameras.get(t.cameraId);e.info("setScene",JSON.stringify(t),r);this._resolve({node:this._rootNode,camera:r,backgroundTopColor:t.backgroundTopColor,backgroundBottomColor:t.backgroundBottomColor,contentResource:this._contentResource,builder:this})}};g.prototype.setRootNode=function(e,t,i,r){this._rootNode=e;e.sid=t;this._nodes.set(t,e);this._viewGroups=new Map;this._views=new Map;if(i){this._sceneIdTreeNodesMap.set(i,this._nodes);this._sceneIdRootNodeMap.set(i,e);this._currentSceneId=i}if(r){this._vkScene=r}return this};g.prototype.setNodePersistentId=function(e,t,i){this._resetCurrentScene(i);e.sid=t;this._nodes.set(t,e);return true};g.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;this._contentResource=null;this._resolve=null;this._reject=null;if(this._nodes){this._nodes.clear()}if(this._viewGroups){this._viewGroups.clear()}if(this._views){this._views.clear()}this._cameras.clear();this._materialMap.clear();this._annotationsMap.clear();this._annotationNodesMap.clear();this._materialNodesMap.clear();this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._materialsByTextureImageId.clear();this._viewThumbnails.clear();this._geometries.clear();this._geometryMeshes.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._images.clear();this._imageTextures.clear();this._joints.clear();this._fillStyles.clear();this._lineStyles.clear();this._textStyles.clear()};g.prototype.getNode=function(e,t){if(t){this._resetCurrentScene(t);if(this._nodes){return this._nodes.get(e)}}else{var i=this._sceneIdTreeNodesMap.values();var r=i.next();while(!r.done){var a=r.value.get(e);if(a){return a}r=i.next()}}return null};g.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var t=this._sceneIdTreeNodesMap.get(e);if(t){this._nodes=t}else{this._nodes=new Map}var i=this._sceneIdRootNodeMap.get(e);if(i){this._rootNode=i}else{this._rootNode=null}this._currentSceneId=e}};g.prototype.createCamera=function(e,t){this._resetCurrentScene(t);var i=new l;i.setUpDirection(Array.isArray(e.up)?e.up:[0,1,0]);i.setZoomFactor(e.zoom);i.setPosition(e.origin);this._cameras.set(e.id,i);return i};g.prototype.getCamera=function(e){return this._cameras.get(e)};g.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e)};g.prototype.hasImage=function(e){return this._images.has(e)};g.prototype.hasAnnotation=function(e){return this._annotationsMap.has(e)};function y(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){if(e[t].type===undefined||e[t].type==="mesh"||e[t].type==="line"){return e[t]}}}return null}g.prototype.setMeshNode=function(e,t){this._setMeshNode(this._nodes.get(e),t)};g.prototype.setModelViewVisibilitySet=function(){};g.prototype.setAnimationPlaybacks=function(){};g.prototype.loadingFinished=function(e){};g.prototype.createThumbnail=function(e){var t=this._viewThumbnails.get(e.imageId);if(t){t.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,e.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:t})}}};g.prototype.insertSubmesh=function(e){if(!e.lods){return false}var t=y(e.lods);if(!t){return false}e.boundingBox=t.boundingBox;var i=this._geometries.get(t.id);if(i){var r=this._meshNodes.get(e.meshId);if(r){for(var a=0;a<r.length;a++){this._addGeometryToNode(r[a],i,e)}}}else{_.pushElementIntoMapArray(this._geometryMeshes,t.id,e)}_.pushElementIntoMapArray(this._meshSubmeshes,e.meshId,e)};g.prototype.getViewGroup=function(e,t){this._resetCurrentScene(t);var i=this._viewGroups.get(e);var r=[];if(i&&i.views){for(var a=0;a<i.views.length;a++){var s=i.views[a].id;var n=this._views.get(s);if(n){r.push(n)}}}return r};g.prototype.insertViewGroup=function(e,t){this._resetCurrentScene(t);var i=this._viewGroups.get(e.id);if(!i){i=this._vkScene.createViewGroup({viewGroupId:e.id,name:e.name,description:e.description});this._viewGroups.set(e.id,i)}else{i.setViewGroupId(e.id);i.setName(e.name);i.setDescription(e.description)}i.type=e.type;i.metadata=e.metadata;i.veids=e.veids;i.views=e.views;i.sceneId=e.sceneId;return this};var I={turntable:c.Turntable,orbit:c.Orbit,pan:c.Pan,zoom:c.Zoom};g.prototype.insertView=function(e,t){this._resetCurrentScene(t);var i=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?'<pre class="sapVizKitViewGalleryStepDescriptionPre">'+e.description+"</pre>":e.description,aspectRatio:e.safeAreaAspectRatio,autoPlayAnimation:e.autoPlayAnimation,navigationMode:I[e.navigationMode]||c.NoChange,dimension:2});i.userData={viewInfo:e};if(e.thumbnailId){var r=this._images.get(e.thumbnailId);if(r){i.thumbnailData=r}else{this._viewThumbnails.set(e.thumbnailId,i)}}if(e.cameraId){i.setCamera(this._cameras.get(e.cameraId))}i.type=e.type;i.flyToTime=e.flyToTime;i.preDelay=e.preDelay;i.postDelay=e.postDelay;i.navigationMode=e.navigationMode;var a=this._getSavedColor(e.topColour,localStorage.getItem("color.backgroundTop"));if(a!=null){i.setTopColor(a)}var s=this._getSavedColor(e.bottomColour,localStorage.getItem("color.backgroundBottom"));if(s!=null){i.setBottomColor(s)}i.dimension=e.dimension;i.query=e.query;i.metadata=e.metadata;i.veids=e.veids;i.viewGroupId=e.viewGroupId;i.id=e.viewId;this._views.set(e.viewId,i);if(i.viewGroupId){var n=this._viewGroups.get(i.viewGroupId);if(n){n.addView(i)}}return this};g.prototype.getView=function(e,t){this._resetCurrentScene(t);return this._views.get(e)};g.prototype.setViewCamera=function(e,t,i){this._resetCurrentScene(i);var r=this._cameras.get(e);var a=this._views.get(t);if(r&&a){a.setCamera(r)}return this};g.prototype.getChildNodeIds=function(e,t,i){this._resetCurrentScene(t);var r=this._nodes.get(e);var a=[];if(!r){return a}if(r&&r.children){for(var s=0;s<r.children.length;s++){var n=r.children[s];if(n.userData.treeNode&&n.userData.treeNode.sid){a.push(n.userData.treeNode.sid)}else if(i&&n.userData.submeshInfo&&n.userData.submeshInfo.id){a.push(n.userData.submeshInfo.id)}}}return a};g.prototype.setViewNodeInfos=function(e,t,i){this._resetCurrentScene(i);var r=this._views.get(t);r.setNodeInfos(e);return this};g.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var t=this._viewGroups.entries();var i=t.next();while(!i.done){var r=i.value[1];var a=i.value[0];if(!r||!r.views||!r.views.length){i=t.next();continue}r.removeViews();for(var s=0;s<r.views.length;s++){var n=r.views[s].id;var o=this._views.get(n);if(o&&o.userData.viewInfo.thumbnailId&&!o.thumbnailData){var h=this._images.get(o.userData.viewInfo.thumbnailId);if(h){o.thumbnailData=h}}if(o){o.viewGroupId=a;r.addView(o)}}i=t.next()}return this};g.prototype.setVoxelThreshold=function(e){return this};g.prototype.getVoxelThreshold=function(){return 0};g.prototype.createNode=function(e,i){this._resetCurrentScene(i);var r=e.transform;var a=new t({sid:e.sid,name:e.name,matrix:m.convertTo3x2(r)});this._nodes.set(e.sid,a);var s=a.userData;if(e.metadata){s.metadata=e.metadata}if(e.veids){s.veids=e.veids}if(e.usageIds){s.usageIds=e.usageIds}if(e.parametricId){s.parametricId=e.parametricId}else if(e.meshId){this._setMeshNode(a,e.meshId)}s.treeNode=e;a.setVisible(1,e.visible?e.visible:true);if(e.visualisable===false){s.skipIt=true}if(e.joints){e.joints.forEach(function(e){var t=this._nodes.get(e.parentSid);if(t){t.userData.jointNodes=t.userData.jointNodes||[];t.userData.jointNodes.push(a)}else{_.pushElementIntoMapArray(this._joints,e.parentSid,a)}},this)}var n=this._joints.get(e.sid);if(n){s.jointNodes=s.jointNodes?s.jointNodes.concat(n):n}if(e.viewBox){s.viewBox=e.viewBox}var o=this._nodes.get(e.parentId);(o||this._rootNode).add(a);if(e.contentType==="HOTSPOT"){a._vkSetNodeContentType(p.Hotspot)}else if(e.contentType==="ANNOTATION"){a._vkSetNodeContentType(p.Annotation)}return a};g.prototype.preferMeshes=function(){return false};g.prototype.createAnnotation=function(e,t){_.pushElementIntoMapArray(this._annotationNodesMap,e.annotationId,e.nodeId);var i=this.getAnnotation(e.annotationId);if(i){this.createImageNote(i,t)}};g.prototype.remove=function(e,t){this._resetCurrentScene(t);var i=this;e=[].concat(e);e.forEach(function(e){var r=i._nodes.get(e);if(r){i._nodes.delete(e);for(var a=0;a<r.children.length;a++){var s=r.children[a];if(s.userData&&s.userData.treeNode&&s.userData.treeNode.sid){i.remove(s.userData.treeNode.sid,t)}}}});return this};function w(e){return new Float32Array([Math.max(e[3]-e[0],Number.EPSILON),0,0,Math.max(e[4]-e[1],Number.EPSILON),(e[3]+e[0])*.5,(e[4]+e[1])*.5])}g.prototype._addGeometryToNode=function(e,t,i){var r=i.materialId;var a=this._getMaterial(r);var s=t.data;var o=s.indices;var h=s.points;var d=new Float32Array([1,0,0,1,0,0]);if(t.isPositionQuantized&&i.boundingBox&&i.boundingBox.length===6){d=w(i.boundingBox)}if(i.transform){}var l,u,p,c;var m=o.length;var f=[];if(t.isPolyline){for(l=0,u=-1;l<m;l+=2,u=c){p=o[l]*3;c=o[l+1]*3;if(p!==u){f.push({type:"move",points:[h[p],h[p+this._yIndex]]});f.push({type:"line",points:[h[c],h[c+this._yIndex]]})}else{f[f.length-1].points.push(h[c],h[c+this._yIndex])}}}else{a=Object.assign(Object.assign({},a),{lineColor:[0,0,0,0],lineWidth:0});for(l=0;l<m;l+=3){u=o[l]*3;p=o[l+1]*3;c=o[l+2]*3;f.push({type:"move",points:[h[u],h[u+this._yIndex]]});f.push({type:"line",points:[h[p],h[p+this._yIndex],h[c],h[c+this._yIndex]]});f.push({type:"close"})}}var v=new n({segments:f,isTriangleMesh:!t.isPolyline,matrix:d,material:a,materialID:r,fillStyle:t.isPolyline?null:{colour:a.color},subelement:true});v.uid+="-g";e.add(v);_.pushElementIntoMapArray(this._materialNodesMap,r,v)};g.prototype.setGeometry=function(e){this._geometries.set(e.id,e);var t=this._geometryMeshes.get(e.id);if(t){for(var i=0;i<t.length;i++){var r=t[i];var a=this._meshNodes.get(r.meshId);if(a){for(var s=0;s<a.length;s++){this._addGeometryToNode(a[s],e,r)}}}}if(this._fireSceneUpdated){this._fireSceneUpdated()}return this};g.prototype._setMeshNode=function(e,t){_.pushElementIntoMapArray(this._meshNodes,t,e);var i=this._meshSubmeshes.get(t);if(i){for(var r=0;r<i.length;r++){var a=i[r];var s=y(a.lods);if(s){var n=this._geometries.get(s.id);if(n){this._addGeometryToNode(e,n,a)}}}}};var M=[0,0];var N=[0,0,0,1];var S=[1,1];function b(e){return t._compose(e.t||M,e.r||N,e.s||S)}g.prototype.setParametricContent=function(t,i,r){if(i==null){e.warning("Empty parametric content for node "+t);return}this._resetCurrentScene(r);var a=this._nodes.get(t);a.uid+="-p";var s=i.shapes;if(s){for(var n=0;n<s.length;n++){this._createObject(s[n],a)}}else{this._createObject(i,a)}};function x(e,t,i,r,a){return[e+i*Math.cos(a),t+r*Math.sin(a)]}g.prototype._createObject=function(t,h){t.matrix=b(t);t.subelement=true;if(t.materialID){t.material=this._getMaterial(t.materialID)}if(this._lineStyles&&t.stroke_id!==undefined){t.lineStyle=this._lineStyles.get(t.stroke_id)}if(this._fillStyles&&t.fill_id!==undefined){t.fillStyle=this._fillStyles.get(t.fill_id);if(t.fillStyle.gradient){var l=new d(t.fillStyle);t.fillStyle.fillURL="url(#"+l.uid+")";h.add(l)}}if(this._textStyles&&t.style_id!==undefined){t.style=this._textStyles.get(t.style_id);t.textStyles=this._textStyles}var u;switch(t.type){case"arc":case"ellipticalArc":var p=t.cx||0;var c=t.cy||0;var m=t.major||t.radius;var f=t.minor||t.radius;var v=t.start>t.end?t.start-Math.PI*2:t.start;var g=t.end;t.segments=[{type:"move",points:x(p,c,m,f,v)},{type:"arc",major:m,minor:f,short:Math.abs(g-v)<Math.PI,clockwise:g>v,points:x(p,c,m,f,g)}];u=new n(t);break;case"rectangle":u=new r(t);break;case"line":u=new a(t);break;case"polyline":u=new s(t);break;case"ellipse":case"circle":u=new i(t);break;case"text":if(this._rootNode.matrix[3]<0){t.matrix[2]*=-1;t.matrix[3]*=-1}u=new o(t);break;case"path":u=new n(t);break;default:e.warning("Unsupported parametric type",t.type);u=null;break}if(u){u.userData.po=t;u.uid+="-s";if(t.materialID){_.pushElementIntoMapArray(this._materialNodesMap,t.materialID,u)}h.add(u)}};g.prototype.createImageNote=function(e,t){this._resetCurrentScene(t);if(e.type==="image"){var i=e.label.materialId;if(!i){return}var r=this._getMaterial(i);this._annotationsMap.set(e.id,e);var a=this._annotationNodesMap.get(e.id)||[];this._annotationNodesMap.delete(e.id);if(e.nodeId){a.push(e.nodeId)}for(var s=0;s<a.length;s++){var n=this._nodes.get(a[s]);if(n){var o=new h({materialID:i,material:r,subelement:true,matrix:[1,0,0,-1,0,0]});n.add(o);_.pushElementIntoMapArray(this._materialNodesMap,i,o)}}}};g.prototype.removeNode=function(e){this._nodes.delete(e.sid);e.children.forEach(this.removeNode,this)};g.prototype.createMaterial=function(e){var t=[];var i=e.id;var r=this._getMaterial(i);r.lineColor=e.lineColour;r.lineWidth=e.lineWidth||1;r.lineStyle={width:e.lineWidth||1,haloWidth:e.lineHaloWidth||0,endCapStyle:e.lineEndRound?1:0,dashPattern:e.lineDashPattern||[],dashPatternScale:e.lineDashPatternScale,widthCoordinateSpace:e.lineWidthCoordinateSpace};if(e.emissiveColour){r.color=e.emissiveColour}if(e.opacity!==undefined){r.opacity=e.opacity}if(e.textureEmissive&&e.textureEmissive.length&&e.textureEmissive[0].imageId){var a=e.textureEmissive[0].imageId;if(this._images.has(a)){r.texture=this._images.get(a)}else{var s={imageId:e.textureEmissive[0].imageId};t.push(s);_.pushElementIntoMapArray(this._imageTextures,a,{materialId:i});if(!r.userData){r.userData={}}r.userData.imageIdsToLoad=new Set;r.userData.imageIdsToLoad.add(s.imageId)}r.textureWidth=e.textureEmissive[0].width;r.textureHeight=e.textureEmissive[0].height;_.pushElementIntoMapArray(this._materialsByTextureImageId,a,{materialId:i})}var n=this._materialNodesMap.get(i);if(n){for(var o=0;o<n.length;o++){n[o].setMaterial(r,true)}}return t};g.prototype._getMaterial=function(e){return this._materialMap.get(e)||this._createTemporaryMaterial(e)};g.prototype._createTemporaryMaterial=function(e){var t={materialId:e,lineColor:[0,0,0,1],lineWidth:1};this._materialMap.set(e,t);return t};g.prototype.checkMaterialExists=function(e,t){if(!this._materialMap.get(e)){if(t){this._createTemporaryMaterial(e)}return false}return true};g.prototype.materialNeeded=function(e){return false};g.prototype.getAnnotation=function(e){return this._annotationsMap.get(e)};g.prototype.updateViewsForReplacedNodes=function(e){};g.prototype.insertFillStyle=function(e){this._fillStyles.set(e.veid,e)};g.prototype.insertLineStyle=function(e){this._lineStyles.set(e.veid,e)};g.prototype.insertTextStyle=function(e){this._textStyles.set(e.veid,e)};var T=function(e){var t="";try{var i=32768;var r=0;var a=e.length;var s;while(r<a){s=e.slice(r,Math.min(r+i,a));t+=String.fromCharCode.apply(null,s);r+=i}}catch(e){t=""}return t};g.prototype.createImage=function(t){if(t.binaryData.length<32){e.warning("SceneBuilder.createImage()","Can't create image from empty data");return this}var i=new DataView(t.binaryData.buffer);var r=true;if(i.getUint8(0,true)===parseInt("0xFF",16)&&i.getUint8(1,true)===parseInt("0xD8",16)){r=false}var a=T(t.binaryData);var s="data:image/"+(r?"png":"jpeg")+";base64,"+btoa(a);this._images.set(t.id,s);var n=this._imageTextures.get(t.id);if(n&&n.length){this._imageTextures.delete(t.id);n.forEach(function(e){var i=this._getMaterial(e.materialId);i.texture=s;if(i.userData&&i.userData.imageIdsToLoad&&i.userData.imageIdsToLoad.size){i.userData.imageIdsToLoad.delete(t.id)}var r=this._materialNodesMap.get(e.materialId);if(r){for(var a=0;a<r.length;a++){r[a].setMaterial(i,true)}}}.bind(this))}return this};g.prototype.setViewThumbnail=function(e,t,i,r){this._resetCurrentScene(i);var a=this._views.get(t);var s=this._images.get(e);if(a&&s){if(a.userData!==undefined){if(a.userData.viewInfo.thumbnailId===e){a.thumbnailData=s}}}return this};g.prototype._getSavedColor=function(e,t){if(e&&e.length>2){return v({red:Math.floor(e[0]*255),green:Math.floor(e[1]*255),blue:Math.floor(e[2]*255),alpha:e.length>3?e[3]:1})}else if(t){return t}return undefined};return g});