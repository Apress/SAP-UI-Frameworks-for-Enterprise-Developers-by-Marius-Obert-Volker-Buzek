/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../Core","../ViewportBase","sap/ui/core/ResizeHandler","sap/ui/events/KeyCodes","../Loco","../ViewStateManager","./ViewStateManager","../ViewportHandler","../VisibilityMode","../ZoomTo","../SelectionMode","../NodeContentType","../getResourceBundle","../Messages","./Scene","./OrthographicCamera","../measurements/Surface","./Rectangle","./HotspotHelper","../colorToCSSColor","../cssColorToColor","../colorToABGR","../abgrToColor","sap/base/Log","sap/ui/core/Core"],function(e,t,i,s,r,a,o,n,h,l,u,d,c,f,m,g,p,_,v,y,w,S,C,R,b){"use strict";var x=t.extend("sap.ui.vk.svg.Viewport",{metadata:{library:"sap.ui.vk",events:{cameraChanged:{parameters:{offset:"float[]",zoom:"float"},enableEventBubbling:true},hotspotEnter:{parameters:{nodeRef:"any"},enableEventBubbling:true},hotspotLeave:{parameters:{nodeRef:"any"},enableEventBubbling:true}}}});var V=x.getMetadata().getParent().getClass().prototype;x.prototype.init=function(){if(V.init){V.init.call(this)}this._measurementSurface=new p;this._resizeListenerId=null;this._animLoopRequestId=0;this._animLoopFunction=this._animLoop.bind(this);this._width=this._height=0;this._camera=new g;this._gestureX=0;this._gestureY=0;this._scene=null;this._selectionRect=new _({material:{lineColor:[.75,.75,0,1],lineStyle:{dashPattern:[2,2]}}});this._styles=new Map;this.raster={rasterImage:document.createElement("canvas"),vectorImage:new Image,bmpCanvas:null,rasterMode:false,useRasterMode:false,delayEnd:false,endRasterModeTimer:null,updateImageTimer:null,bmpDrawRequestId:null,nodesThreshold:2500};this.raster.vectorImage.onload=function(){var e=this.raster.vectorImage;var t=this.raster.rasterImage;t.viewBox=e.viewBox;H(t,e.width,e.height);var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);i.drawImage(e,0,0,t.width,t.height);this._requestBmpDraw()}.bind(this);this._viewportHandler=new n(this);this._loco=new r(this);this._loco.addHandler(this._viewportHandler,-1);this._hotspotHelper=new v;this._currentViewIndex=0;this._currentView=null;e.getEventBus().subscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);b.attachLocalizationChanged(this._onLocalizationChanged,this)};x.prototype.exit=function(){b.detachLocalizationChanged(this._onLocalizationChanged,this);e.getEventBus().unsubscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);this._measurementSurface.destroy();this._measurementSurface=null;this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){i.deregister(this._resizeListenerId);this._resizeListenerId=null}this.setScene(null);this._renderer=null;this._loco=null;this._viewportHandler=null;if(V.exit){V.exit.call(this)}var t=this.getTools();for(var s=0;s<t.length;s++){var r=b.byId(t[s]);if(r){r.setActive(false)}}this.raster.rasterMode=false;this.raster.useRasterMode=false};x.prototype._onLocalizationChanged=function(e){var t=this._measurementSurface;if(t&&t.getMeasurements().length>0){t.update(this,this.getCamera())}};x.prototype.onBeforeRendering=function(){if(this._resizeListenerId){i.deregister(this._resizeListenerId);this._resizeListenerId=null}};x.prototype.onAfterRendering=function(){this._resizeListenerId=i.register(this,this._handleResize.bind(this));var e=this.getDomRef();e.append(this._measurementSurface.getDomRef());if(this._scene){var t=this._scene.getRootElement();t._setDomRef(document.getElementById(t.uid));this._svgElement=t.domRef.parentNode}this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}})};x.prototype._handleResize=function(e){var t=this._width;var i=this._height;this._width=e.size.width;this._height=e.size.height;this._camera.update(this._width,this._height,false);if((t===0||i===0)&&(!this._camera._initialZoom||this._camera._initialZoom<0||!this._camera._initialPosition)){this.zoomTo(l.All,null,0,0)}else{this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()})}var s=this._measurementSurface.getDomRef();s.style.width=this._width+"px";s.style.height=this._height+"px";this.fireResize({size:{width:this._width,height:this._height}});if(this._svgElement!=null){this.raster.bmpCanvas=this._svgElement.previousSibling;this._invalidateRasterImage()}return true};x.prototype.setScene=function(e){if(this._scene){this._scene.getDefaultNodeHierarchy().detachNodeCreated(this._nodeCreatedHandler,this)}this._scene=e;this._currentViewIndex=0;this._currentView=null;this._styles.clear();if(e){this.setCamera(new g);var t=this._scene.getDefaultNodeHierarchy();this.raster.useRasterMode=t.findNodesByName().length>this.raster.nodesThreshold;t.attachNodeCreated(this._nodeCreatedHandler,this);var i=e.getInitialView();if(i){this.activateView(i)}this._onContentLoadingFinished()}return this};x.prototype.setCamera=function(e){if(!(e instanceof g)){return this}if(V.setCamera){V.setCamera.call(this,e)}if(e){e.update(this._width,this._height,true);this._updateViewBox()}return this};x.prototype._nodeCreatedHandler=function(e){var t=e.getParameter("nodeRef");if(t._vkGetNodeContentType()===d.Annotation&&t.children&&t.children.length&&t.children[0].type==="Image"){this.invalidate()}};x.prototype.getScene=function(){return this._scene};x.prototype.onSetViewStateManager=function(e){this._viewStateManager=e;e.attachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.attachSelectionChanged(this._onOutliningOrSelectionChanged,this)};x.prototype.onUnsetViewStateManager=function(e){e.detachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.detachSelectionChanged(this._onOutliningOrSelectionChanged,this);this._viewStateManager=null};x.prototype._getViewStateManagerSVG=function(){if(this._viewStateManager){if(this._viewStateManager instanceof o){return this._viewStateManager}if(this._viewStateManager instanceof a&&this._viewStateManager._implementation instanceof o){return this._viewStateManager._implementation}}return null};x.prototype.hitTest=function(e,t,i,s,r){var a=this._getViewStateManagerSVG();if(!a||!this._scene){return null}var o=this._scene.getRootElement();var n=this.getDomRef().getBoundingClientRect();var h=function(e,t){var i;if(r){var s=document.elementsFromPoint(e+n.x,t+n.y);for(var a=0;a<s.length;a++){i=s[a];var h=i!=null&&i.id?o.getElementById(i.id):null;if(!h){return null}var l=h._getSceneTreeElement();if(l&&l._vkGetNodeContentType()!==d.Hotspot){return h}}return null}else{i=document.elementFromPoint(e+n.x,t+n.y);return i!==null&&i.id?o.getElementById(i.id):null}};var l=h(e,t);if(i){var u=3;var c=3;for(var f=t-c;f<t+c&&!l;f++){for(var m=e-u;m<e+u&&!l;m++){l=h(m,f)}}}if(s){return l}return l?l._getSceneTreeElement():null};x.prototype.tap=function(e,t,i){var s=this.hitTest(e,t,true);if(!i){this.tapObject(s);if(s!==null){this.fireNodeClicked({nodeRef:s,x:e,y:t},true,true)}}else if(!this.getFreezeCamera()){if(s&&this._camera.zoomedObject!==s){this._camera.zoomedObject=s;this.zoomTo(l.Node,this._camera.zoomedObject,.5,.1)}else{this._camera.zoomedObject=null;this.zoomTo(l.Visible,null,.5,0)}}return this};x.prototype.tapObject=function(e){var t={picked:e?[e]:[]};this.fireNodesPicked(t);if(this.getSelectionMode()===u.Exclusive){this.exclusiveSelectionHandler(t.picked)}else if(this.getSelectionMode()===u.Sticky){this.stickySelectionHandler(t.picked)}return this};var M={x:-2,y:-2};var I=2;var E=5;x.prototype.onkeydown=function(e){if(!e.isMarked()){switch(e.keyCode){case s.ARROW_LEFT:case s.ARROW_RIGHT:case s.ARROW_UP:case s.ARROW_DOWN:if(e.ctrlKey||e.altKey||e.metaKey){break}var t={x:0,y:0};switch(e.keyCode){case s.ARROW_LEFT:t.x=-1;break;case s.ARROW_RIGHT:t.x=+1;break;case s.ARROW_UP:t.y=-1;break;case s.ARROW_DOWN:t.y=+1;break;default:break}this.beginGesture(M.x,M.y);if(e.shiftKey){this.pan(E*t.x,E*t.y)}else{this.rotate(I*t.x,I*t.y,true)}this.endGesture();e.preventDefault();e.stopPropagation();break;case 189:case s.PLUS:case s.NUMPAD_MINUS:case s.NUMPAD_PLUS:this.beginGesture(this._width*.5,this._height*.5);this.zoom(e.keyCode===s.PLUS||e.keyCode===s.NUMPAD_PLUS?1.02:.98);this.endGesture();e.preventDefault();e.stopPropagation();break;case s.D:if(e.ctrlKey){this._dumpSceneData()}break;default:break}}};x.prototype._onOutliningOrSelectionChanged=function(e){var t=this.getTools();for(var i=0;i<t.length;i++){var s=b.byId(t[i]);var r=s.getGizmoForContainer(this);if(r&&r.handleSelectionChanged){r.handleSelectionChanged(e)}}this._invalidateRasterImage()};x.prototype.setSelectionRect=function(e){var t=document.getElementById(this._selectionRect.uid);if(t){if(e){t.removeAttribute("display");e=this._camera._transformRect(e);t.setAttribute("x",e.x1,e.x2);t.setAttribute("y",e.y1,e.y2);t.setAttribute("width",e.x2-e.x1);t.setAttribute("height",e.y2-e.y1)}else{t.setAttribute("display","none")}}};x.prototype._select=function(e){var t=this._getViewStateManagerSVG();if(t&&this._scene){e=this._camera._transformRect(e);var i=new Set;this._scene.getRootElement()._findRectElementsRecursive(i,e,t._mask);return Array.from(i)}return[]};x.prototype.getImage=function(e,t,i,s,r){return null};x.prototype._setContent=function(e){V._setContent.apply(this,arguments);this.setScene(e instanceof m?e:null);if(this._measurementSurface!=null){this._measurementSurface.setScale(1)}return this};x.prototype.onSetContentConnector=function(e){t.prototype.onSetContentConnector.call(this,e);e.attachContentLoadingFinished(this._onContentLoadingFinished,this)};x.prototype.onUnsetContentConnector=function(e){e.detachContentLoadingFinished(this._onContentLoadingFinished,this);t.prototype.onUnsetContentConnector.call(this,e)};x.prototype._onContentLoadingFinished=function(e){if(this._scene){var t=this._scene.getDefaultNodeHierarchy();if(t){var i=this._getViewStateManagerSVG();var s=i&&i._mask||1;var r=this.getShowAllHotspots()?this.getShowAllHotspotsTintColor():null;var a=t.getHotspotNodeIds();a.forEach(function(e){this._hotspotHelper.updateHotspot(e,undefined);if(r!=null){e.setHotspotColor(s,r)}if(this.getDisableHotspotHovering()){e.addClass("sapUiVizKitNonInteractiveHotspot")}},this)}if(e&&(!this._camera._initialZoom||this._camera._initialZoom===-1)){this.zoomTo(l.All,null,0,0);this._camera._initialZoom=this._camera.getZoomFactor();this._camera._initialPosition=this._camera.getPosition()}this.invalidate()}};function T(e,t,i){return e+(t-e)*i}function B(e,t,i){i=Math.min(Math.max((i-e)/(t-e),0),1);return i*i*i*(i*(i*6-15)+10)}x.prototype._animLoop=function(){this._animLoopRequestId=0;var e=this._anim;if(e){var t=e.start;var i=e.end;var s=Date.now();var r=Math.min(B(0,1,(s-t.time)/e.duration),1);var a=this._camera.offsetX;var o=this._camera.offsetY;var n=this._camera.zoom;this._camera.offsetX=T(t.offsetX,i.offsetX,r);this._camera.offsetY=T(t.offsetY,i.offsetY,r);this._camera.zoom=T(t.zoom,i.zoom,r);if(this._redlineHandler){this._redlineHandler.pan(this._camera.offsetX-a,this._camera.offsetY-o);this._redlineHandler.zoom(this._camera.zoom/n,this._camera.offsetX,this._camera.offsetY)}this.fireCameraChanged({viewBox:this._getViewBox()});if(this._updateViewBox()&&s-t.time<e.duration){this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction)}else{delete this._anim;this._endRasterMode()}}};x.prototype.getCurrentView=function(){return this._currentView};x.prototype._onViewStateApplied=function(e,t,i){if(i.source===this._getViewStateManagerSVG()){this.activateView(i.view)}};x.prototype.activateView=function(t){if(!this._scene){return this}var i=this._scene.getViewGroups();var s=this;if(i){i.forEach(function(e){e.getViews().forEach(function(i){if(i===t){s._currentViewIndex=e.getViews().indexOf(i)}})})}this.fireViewActivated({viewIndex:this._currentViewIndex,view:t});e.getEventBus().publish("sap.ui.vk","viewActivated",{source:this,view:t,viewIndex:this._currentViewIndex});this._currentView=t;var r=t.getCamera();if(r){this.setCamera(r)}var a=t.getTopColor();if(a!=null){if(Array.isArray(a)&&a.length>2){this.setBackgroundColorTop(y({red:Math.floor(a[0]*255),green:Math.floor(a[1]*255),blue:Math.floor(a[2]*255),alpha:a.length>3?a[3]:1}))}else{this.setBackgroundColorTop(a)}}var o=t.getBottomColor();if(o!=null){if(Array.isArray(o)&&o.length>2){this.setBackgroundColorBottom(y({red:Math.floor(o[0]*255),green:Math.floor(o[1]*255),blue:Math.floor(o[2]*255),alpha:o.length>3?o[3]:1}))}else{this.setBackgroundColorBottom(o)}}e.getEventBus().publish("sap.ui.vk","readyForAnimation",{source:this._getViewStateManagerSVG(),view:t,ignoreAnimationPosition:false});this.rerender();this.fireViewFinished({viewIndex:this._currentViewIndex});return this};x.prototype.resetCurrentView=function(){if(this._currentView){this._getViewStateManagerSVG()._resetNodesStatusByCurrentView(this._currentView);this.rerender()}return this};x.prototype.zoomTo=function(e,t,i,s){if(this._width===0||this._height===0||this._scene==null){return this}var r={min:{x:Infinity,y:Infinity},max:{x:-Infinity,y:-Infinity}};var a=this._getViewStateManagerSVG();(Array.isArray(e)?e:[e]).forEach(function(e){switch(e){case l.All:this._scene.getRootElement()._expandBoundingBoxRecursive(r,-1>>>0);break;case l.Visible:if(a){this._scene.getRootElement()._expandBoundingBoxRecursive(r,a._mask)}break;case l.Selected:if(a){a.enumerateSelection(function(e){e._expandBoundingBoxRecursive(r,-1>>>0)})}break;case l.Node:if(!t){return this}if(Array.isArray(t)){t.forEach(function(e){e._expandBoundingBoxRecursive(r,-1>>>0)})}else{t._expandBoundingBoxRecursive(r,-1>>>0)}break;case l.Restore:R.error(c().getText("VIEWPORT_MSG_RESTORENOTIMPLEMENTED"));return this;case l.NodeSetIsolation:R.error(c().getText("VIEWPORT_MSG_NODESETISOLATIONNOTIMPLEMENTED"));return this;case l.RestoreRemoveIsolation:R.error(c().getText("VIEWPORT_MSG_RESTOREREMOVEISOLATIONNOTIMPLEMENTED"));return this;case l.ViewLeft:case l.ViewRight:case l.ViewTop:case l.ViewBottom:case l.ViewBack:case l.ViewFront:return this;default:break}}.bind(this));if(r.min.x>=r.max.x||r.min.y>=r.max.y){r={min:{x:0,y:0},max:{x:1,y:1}}}var o=new g;o._zoomTo(r,this._width,this._height,s);this._activateCamera(o,i);return this};x.prototype._activateCamera=function(e,t){if(t>0&&!this._animLoopRequestId){this._anim={start:{time:Date.now(),offsetX:this._camera.offsetX,offsetY:this._camera.offsetY,zoom:this._camera.zoom},end:{offsetX:e.offsetX,offsetY:e.offsetY,zoom:e.zoom},duration:t*1e3};this._startRasterMode();this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction)}else{if(this._redlineHandler){this._redlineHandler.pan(e.offsetX-this._camera.offsetX,e.offsetY-this._camera.offsetY);this._redlineHandler.zoom(e.zoom/this._camera.zoom,e.offsetX,e.offsetY)}this._camera.zoom=e.zoom;this._camera.offsetX=e.offsetX;this._camera.offsetY=e.offsetY;this._updateViewBox();this._invalidateRasterImage();this.fireCameraChanged({viewBox:this._getViewBox()})}};x.prototype.beginGesture=function(e,t){this._gestureX=(e-this._camera.offsetX)/this._camera.zoom;this._gestureY=(t-this._camera.offsetY)/this._camera.zoom};x.prototype.endGesture=function(){this._gestureX=0;this._gestureY=0;this._endRasterMode()};function H(e,t,i){if(e.width!==t*devicePixelRatio||e.height!==i*devicePixelRatio){e.width=t*devicePixelRatio;e.height=i*devicePixelRatio;e.style.width=t+"px";e.style.height=i+"px"}}x.prototype.invalidate=function(){t.prototype.invalidate.call(this);if(this.raster){this._invalidateRasterImage()}};x.prototype._invalidateRasterImage=function(){if(this.raster.updateImageTimer){clearTimeout(this.raster.updateImageTimer);this.raster.updateImageTimer=null}if(this.raster.useRasterMode){this.raster.updateImageTimer=setTimeout(this._updateRasterImage.bind(this),100)}};x.prototype._updateRasterImage=function(){this.raster.updateImageTimer=null;if(this._svgElement==null||!this.raster.useRasterMode||!this.raster.bmpCanvas){return}var e=Math.round(Math.max(Math.max(this._width,this._height)*.5,512));var t=this._width+e;var i=this._height+e;var s=t/this._width;var r=i/this._height;var a=this._getViewBox();var o=[a[0]-a[2]*(s-1)*.5,a[1]-a[3]*(r-1)*.5,a[2]*s,a[3]*r];this._svgElement.setAttribute("width",t+"px");this._svgElement.setAttribute("height",i+"px");this._svgElement.setAttribute("viewBox",o.join(" "));var n=(new XMLSerializer).serializeToString(this._svgElement);var h="data:image/svg+xml; charset=utf8, "+encodeURIComponent(n);this._svgElement.setAttribute("width","100%");this._svgElement.setAttribute("height","100%");this._svgElement.setAttribute("viewBox",a.join(" "));this.raster.vectorImage.viewBox=o;this.raster.vectorImage.src=h};x.prototype._startRasterMode=function(e){if(this.raster.endRasterModeTimer){clearTimeout(this.raster.endRasterModeTimer);this.raster.endRasterModeTimer=null}if(this.raster.updateImageTimer){clearTimeout(this.raster.updateImageTimer);this.raster.updateImageTimer=null}if(this.raster.rasterMode||!this.raster.useRasterMode||this._svgElement==null){return}this.raster.rasterMode=true;this.raster.delayEnd=e;this._svgElement.style.display="none";this.raster.bmpCanvas.style.display="block";this._requestBmpDraw()};x.prototype._endRasterMode=function(){if(!this.raster.rasterMode){return}var e=function(){this.raster.bmpCanvas.style.display="none";this._svgElement.style.display="";this.raster.rasterMode=false;this._invalidateRasterImage()}.bind(this);if(this.raster.delayEnd){this.raster.endRasterModeTimer=setTimeout(function(){this.raster.endRasterModeTimer=null;e()}.bind(this),500)}else{e()}};x.prototype.pan=function(e,t){if(!this.getFreezeCamera()){this._startRasterMode();this._camera.offsetX+=e;this._camera.offsetY+=t;this._updateViewBox();if(this._redlineHandler){this._redlineHandler.pan(e,t)}this.fireCameraChanged({viewBox:this._getViewBox()})}};x.prototype.rotate=function(e,t){this.pan(e,t)};x.prototype.zoom=function(e){if(!this.getFreezeCamera()){this._startRasterMode(true);var t=this._camera.zoom;this._camera.zoom=Math.max(this._camera.zoom*e,g._MIN_ZOOM);this._camera.offsetX+=this._gestureX*(t-this._camera.zoom);this._camera.offsetY+=this._gestureY*(t-this._camera.zoom);if(this._redlineHandler){this._redlineHandler.zoom(this._camera.zoom/t)}this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()})}};x.prototype.hover=function(e,t){var i=this._getViewStateManagerSVG();if(!i){return}var s=this.getDisableHotspotHovering()?null:this.hitTest(e,t);var r=false;if(this._hotspotElement&&this._hotspotElement!==s){this.fireHotspotLeave({nodeRef:this._hotspotElement});if(!this.getShowAllHotspots()){this._hotspotElement.setHotspotColor(i._mask,null)}this._hotspotElement=null;r=true}if(s&&s._vkGetNodeContentType()===d.Hotspot){this._hotspotElement=s;if(!this.getShowAllHotspots()){s.setHotspotColor(i._mask,this.getHotspotColorABGR())}this.fireHotspotEnter({nodeRef:s});r=true}if(r){this._invalidateRasterImage()}};x.prototype._getViewBox=function(){return this._camera._getViewBox()};x.prototype._requestBmpDraw=function(){if(this.raster.rasterMode){this.raster.bmpDrawRequestId=this.raster.bmpDrawRequestId||window.requestAnimationFrame(this._bmpDraw.bind(this))}};x.prototype._bmpDraw=function(){this.raster.bmpDrawRequestId=null;var e=this._getViewBox();var t=this.raster.rasterImage;var i=this.raster.bmpCanvas;H(i,this._width,this._height);var s=i.getContext("2d");s.resetTransform();s.clearRect(0,0,i.width,i.height);var r=t.viewBox;if(r){var a=this._camera._worldToScreen(r[0],r[1]);var o=this._camera._worldToScreen(e[0],e[1]);s.translate((a.x-o.x)*devicePixelRatio,(a.y-o.y)*devicePixelRatio);s.scale(r[2]*i.width/(e[2]*t.width),r[3]*i.height/(e[3]*t.height));s.imageSmoothingEnabled=true;s.imageSmoothingQuality="high";s.drawImage(t,0,0)}};x.prototype._updateViewBox=function(){if(this._svgElement==null){return false}this._requestBmpDraw();if(this._measurementSurface!=null){this._measurementSurface.update(this,this.getCamera())}this._svgElement.setAttribute("viewBox",this._getViewBox().join(" "));return true};x.prototype.getViewInfo=function(e){var t={};if(e==null){e={}}if(e.camera==null){e.camera=true}if(e.camera){t.camera={viewBox:this._getViewBox()}}if(e.visibility&&this._viewStateManager){var i=e.visibility.mode==null?h.Complete:e.visibility.mode;t.visibility={mode:i};if(i===h.Complete){var s=this._viewStateManager.getVisibilityComplete();t.visibility.visible=s.visible;t.visibility.hidden=s.hidden}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){t.visibility.changes=this._viewStateManager.getVisibilityChanges()}else{R.warning(c().getText(f.VIT32.summary),f.VIT32.code,"sap.ui.vk.threejs.Viewport")}}var r=this._getViewStateManagerSVG();if(e.selection&&r){t.selection=r._getSelectionComplete()}return t};x.prototype.setViewInfo=function(e,t){var i=e.camera;if(i&&i.viewBox){var s=new g;s._setViewBox(i.viewBox,this._width,this._height);this._activateCamera(s,t)}var r=new Map;if(e.visibility||e.selection){var a=this._viewStateManager.getNodeHierarchy(),o=a.findNodesByName();o.forEach(function(e){var t=a.createNodeProxy(e);var i=t.getVeId();a.destroyNodeProxy(t);if(i){r.set(i,e)}})}if(e.visibility){switch(e.visibility.mode){case h.Complete:var n=e.visibility.visible,l=e.visibility.hidden;n.forEach(function(e){this._viewStateManager.setVisibilityState(r.get(e),true,false)},this);l.forEach(function(e){this._viewStateManager.setVisibilityState(r.get(e),false,false)},this);break;case h.Differences:this._viewStateManager.resetVisibility();e.visibility.changes.forEach(function(e){var t=r.get(e);if(t){this._viewStateManager.setVisibilityState(t,!this._viewStateManager.getVisibilityState(t),false)}},this);break;default:R.error(c().getText(f.VIT28.summary),f.VIT28.code,"sap.ui.vk.threejs.Viewport");break}}var u=this._getViewStateManagerSVG();var d=e.selection;if(d&&u){var m=u._getSelectionComplete();if(Array.isArray(d.selected)){var p=[];var _=[];d.selected.forEach(function(e){var t=r.get(e);if(t){p.push(t)}});m.selected.forEach(function(e){var t=r.get(e);if(t&&d.selected.indexOf(e)<0){_.push(t)}});u.setSelectionStates(p,_,false,false)}}return this};x.prototype.queueCommand=function(e){if(this instanceof x){e()}return this};x.prototype.getOutputSize=function(){var e=this.getDomRef().getBoundingClientRect();var t=e.width;var i=e.height;var s;s=Math.min(t,i);return{left:(t-s)*.5,top:(i-s)*.5,sideLength:s}};x.prototype.setShouldRenderFrame=function(){this.invalidate()};x.prototype._isPanoramicActivated=function(){return false};x.prototype.setShowAllHotspots=function(e){this.setProperty("showAllHotspots",e,true);var t=this._getViewStateManagerSVG();if(t){var i=t._mask;var s=t.getNodeHierarchy().getHotspotNodeIds();var r=this._hotspotElement;var a=this.getShowAllHotspotsTintColor();s.forEach(function(t){if(e){t.setHotspotColor(i,a)}else if(t===r){t.setHotspotColor(i,this.getHotspotColorABGR())}else{t.setHotspotColor(i,null)}},this);if(s.length>0){this.invalidate()}}};x.prototype.setDisableHotspotHovering=function(e){this.setProperty("disableHotspotHovering",e,true);if(e){this.hover(0,0)}var t=this._getViewStateManagerSVG();if(t){var i=t.getNodeHierarchy().getHotspotNodeIds();i.forEach(function(t){if(e){t.addClass("sapUiVizKitNonInteractiveHotspot")}else{t.removeClass("sapUiVizKitNonInteractiveHotspot")}})}};x.prototype.setHotspotColorABGR=function(e){this.setProperty("hotspotColorABGR",e,true);this.setProperty("hotspotColor",y(C(e)),true);this.invalidate();return this};x.prototype.setHotspotColor=function(e){this.setProperty("hotspotColor",e,true);this.setProperty("hotspotColorABGR",S(w(e)),true);this.invalidate();return this};x.prototype.showHotspots=function(e,t,i){if(e==null){return this}if(!Array.isArray(e)){e=[e]}var s=t?i||this.getHotspotColorABGR():null;var r=this._getViewStateManagerSVG()._mask;e.forEach(function(e){e.setCustomHotspotColor(r,s)});this.invalidate();return this};x.prototype._getFillStyleId=function(e){if(e.highlightColor||e.tintColor){return null}var t;if(e.fillStyle&&e.fillStyle.veid!==undefined){t="f"+e.fillStyle.veid}else if(e.fill!==undefined&&e.fill[3]===0){t="fn"}else{return null}if(!this._styles.has(t)){var i=[];e._setFillStyleAttributes(function(e,t){i.push(e,t)});this._styles.set(t,i)}return t};x.prototype._getLineStyleId=function(e){if(e.highlightColor||e.tintColor){return null}var t;if(e.lineStyle&&e.lineStyle.veid!==undefined){t="l"+e.lineStyle.veid}else if(e.materialId){t="m"+e.materialId}else{return null}if(!this._styles.has(t)){var i=[];e._setLineStyleAttributes(function(e,t){i.push(e,t)});this._styles.set(t,i)}return t};x.prototype.getMeasurementSurface=function(){return this._measurementSurface};x.prototype.getShowAllHotspotsTintColorDef=function(){var e=this.getShowAllHotspotsTintColor();var t=typeof e==="number"?C(e):w(e);function i(e,t,i,s){var r=(e<<24|t<<16|i<<8|s*255)>>>0;return"#"+r.toString(16).padStart(8,"0")}return{name:"hotspot-effect-"+i(t.red,t.green,t.blue,t.alpha),color:t}};x.prototype._dumpSceneData=function(){var e=this._scene.getDefaultNodeHierarchy();var t=e.findNodesByName();var i=R.getLevel();R.setLevel(R.Level.INFO);R.info("**************************************");R.info("Nodes in the scene: "+t.length);var s=0;var r=0;var a=0;var o=0;var n=document.getElementsByTagName("svg")[0];var h=function(e){s+=e.children.length;var t=e;var i=1;while(t!=n){t=t.parentNode;i++}if(r<i){r=i}if(e.children.length===0){a++;if(e.tagName==="g"){o++}}for(var l=0;l<e.children.length;l++){h(e.children[l])}};h(n);R.info("DOM statistics:");R.info("    Nodes:      "+s);R.info("    Tree depth: "+r);R.info("    Leaf nodes: "+a);R.info("    Empty nodes:"+o);R.info("    Groups:     "+document.getElementsByTagName("g").length);R.info("    Lines:      "+document.getElementsByTagName("line").length);R.info("    Polylines:   "+document.getElementsByTagName("polyline").length);R.info("    Polygons:   "+document.getElementsByTagName("polygon").length);R.info("    Paths:      "+document.getElementsByTagName("path").length);R.info("    Ellipses:   "+document.getElementsByTagName("ellipse").length);R.info("    Rectangles: "+document.getElementsByTagName("rect").length);R.info("    Texts:      "+document.getElementsByTagName("text").length);R.info("    Images:     "+document.getElementsByTagName("image").length);R.info("**************************************");R.setLevel(i)};x.prototype.projectToScreen=function(e,t,i,s){var r=s._worldToScreen(e,t,0);r.z=0;return r};return x});