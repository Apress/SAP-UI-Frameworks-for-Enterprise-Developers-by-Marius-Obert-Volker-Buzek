/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../NodeHierarchy","sap/ui/base/ObjectPool","./Element","./BaseNodeProxy","./NodeProxy","../Messages","../getResourceBundle","../NodeContentType","sap/base/util/uid","sap/base/assert","sap/base/Log"],function(e,t,n,o,r,i,a,d,s,c,u){"use strict";var h={equals:function(e,t){return e===t},contains:function(e,t){return e.indexOf(t)!==-1},startsWith:function(e,t){return e.indexOf(t)===0}};var f=e.extend("sap.ui.vk.svg.NodeHierarchy",{metadata:{library:"sap.ui.vk"},_baseNodeProxyPool:new t(o),constructor:function(t){e.call(this);this._scene=t;this._nodeProxies=[]}});f.prototype.destroy=function(){this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._scene=null;e.prototype.destroy.call(this)};f.prototype.getScene=function(){return this._scene};f.prototype.getSceneRef=function(){return this._scene.getRootElement()};f.prototype.enumerateChildren=function(e,t,n,o){if(typeof e==="function"){o=n;n=t;t=e;e=undefined}var r=this.getChildren(e,n);if(o){r.forEach(t)}else{var i=this._baseNodeProxyPool.borrowObject();try{r.forEach(function(e){i.init(this,e);t(i);i.reset()}.bind(this))}finally{this._baseNodeProxyPool.returnObject(i)}}return this};f.prototype.enumerateAncestors=function(e,t,n){var o=this.getAncestors(e);if(n){o.forEach(t)}else{var r=this._baseNodeProxyPool.borrowObject();try{o.forEach(function(e){r.init(this,e);t(r);r.reset()}.bind(this))}finally{this._baseNodeProxyPool.returnObject(r)}}return this};f.prototype.createNodeProxy=function(e){var t=new r(this,e);this._nodeProxies.push(t);return t};f.prototype.destroyNodeProxy=function(e){var t=this._nodeProxies.indexOf(e);if(t>=0){this._nodeProxies.splice(t,1)[0].destroy()}return this};f.prototype.getChildren=function(e,t){if(typeof e==="boolean"){t=e;e=undefined}e=e||this._scene.getRootElement();return t||!e.closed?e.children:[]};f.prototype.getAncestors=function(e){var t=[];e.traverseAncestors(function(e){t.unshift(e)});if(t.length>0&&t[0]===this._scene.getRootElement()){t.shift()}return t};f.prototype.findNodesByName=function(e){var t=[];if(e===undefined||e===null||e===""||jQuery.isEmptyObject(e)){this._scene.getRootElement().children.forEach(function(e){e.traverse(function(e){t.push(e)})})}else{var n=h[e.predicate||"equals"];if(n===undefined){u.error(a().getText(i.VIT8.summary),i.VIT8.code,"sap.ui.vk.svg.NodeHierarchy")}else if(!Array.isArray(e.value)&&typeof e.value!=="string"){u.error(a().getText(i.VIT6.summary),i.VIT6.code,"sap.ui.vk.svg.NodeHierarchy")}else{var o=Array.isArray(e.value)?e.value:[e.value];if(!e.caseSensitive){for(var r in o){o[r]=o[r].toLowerCase()}}this._scene.getRootElement().children.forEach(function(r){r.traverse(function(r){var i=r.name||"";if(!e.caseSensitive){i=i.toLowerCase()}for(var a in o){if(n(i,o[a])){t.push(r);break}}})})}}return t};f.prototype.createLayerProxy=function(e){return null};f.prototype.destroyLayerProxy=function(e){return this};f.prototype.getLayers=function(){return[]};f.prototype.getHotspotNodeIds=function(){var e=[];this._scene.getRootElement().traverse(function(t){if(t._vkGetNodeContentType()===d.Hotspot){e.push(t)}});return e};f.prototype.attachChanged=function(e,t,n){return this.attachEvent("changed",e,t,n)};f.prototype.detachChanged=function(e,t,n){return this.detachEvent("changed",e,t,n)};f.prototype.fireChanged=function(e,t,n){return this.fireEvent("changed",e,t,n)};f.prototype.attachNodeCreated=function(e,t,n){return this.attachEvent("nodeCreated",e,t,n)};f.prototype.detachNodeCreated=function(e,t,n){return this.detachEvent("nodeCreated",e,t,n)};f.prototype.fireNodeCreated=function(e,t,n){return this.fireEvent("nodeCreated",e,t,n)};f.prototype.attachNodeRemoving=function(e,t,n){return this.attachEvent("nodeRemoving",e,t,n)};f.prototype.detachNodeRemoving=function(e,t,n){return this.detachEvent("nodeRemoving",e,t,n)};f.prototype.fireNodeRemoving=function(e,t,n){return this.fireEvent("nodeRemoving",e,t,n)};f.prototype.attachNodeReplaced=function(e,t,n){return this.attachEvent("nodeReplaced",e,t,n)};f.prototype.detachNodeReplaced=function(e,t,n){return this.detachEvent("nodeReplaced",e,t,n)};f.prototype.fireNodeReplaced=function(e,t,n){return this.fireEvent("nodeReplaced",e,t,n)};f.prototype.attachNodeUpdated=function(e,t,n){return this.attachEvent("nodeUpdated",e,t,n)};f.prototype.detachNodeUpdated=function(e,t,n){return this.detachEvent("nodeUpdated",e,t,n)};f.prototype.fireNodeUpdated=function(e,t,n){return this.fireEvent("nodeUpdated",e,t,n)};f.prototype.createNode=function(e,t,o,r,i){var u=this.getScene().getSceneBuilder();var h=null;if(u){i=i||{};i.name=i.name||t;i.sid=i.sid||s();h=u.createNode(i);if(!e){e=h.parent}}else{if(!e){e=this._scene.getRootElement()}h=new n;h.name=t;e.add(h)}var f=e.children.indexOf(o);c(e.children[e.children.length-1]===h,a().getText("NODEHIERARCHY_MSG_CREATENODEFAILED"));if(f>=0){e.children.splice(f,0,e.children.pop())}if(r){h._vkSetNodeContentType(r)}else{h._vkSetNodeContentType(d.Regular)}if(i&&u){switch(h._vkGetNodeContentType()){case d.Annotation:i.node=h;i.nodeId=h._vkPersistentId();u.createAnnotation(i);break;default:}}this.fireNodeCreated({nodeRef:h,nodeId:h});this.fireChanged();return h};f.prototype.getNodeContentType=function(e){if(e==null){return d.Regular}var t=e._vkGetNodeContentType();if(!t){t=d.Regular}return t};f.prototype.createNodeCopy=function(e,t,n,o){if(!t){t=this._scene.getRootElement()}var r=t.children.indexOf(o);var i=e.clone(true);i.name=n;t.add(i);c(t.children[t.children.length-1]===i,a().getText("NODEHIERARCHY_MSG_CREATENODEFAILED"));if(r>=0){t.children.splice(r,0,t.children.pop())}this.fireNodeCreated({nodeRef:i,nodeId:i});this.fireChanged();return i};f.prototype.removeNode=function(e){var t=[].concat(e);t.forEach(function(e){if(e&&e.parent){this.fireNodeRemoving({nodeRef:e,nodeId:e});e.parent.remove(e)}}.bind(this));var n=this.getScene().getSceneBuilder();if(n){t.forEach(n.removeNode,n)}this.fireChanged();return this};return f});