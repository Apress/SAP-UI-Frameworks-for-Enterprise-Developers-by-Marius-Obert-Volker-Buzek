/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/ui/base/ManagedObject","../thirdparty/html2canvas","../DetailViewType","../DetailViewShape","./OrthographicCamera","./PerspectiveCamera"],function(e,t,r,i,a,o,n){"use strict";var s=t.extend("sap.ui.vk.threejs.DetailView",{metadata:{library:"sap.ui.vk",properties:{name:{type:"string",defaultValue:""},camera:{type:"any",defaultValue:null},type:{type:"sap.ui.vk.DetailViewType",defaultValue:i.DetailView},shape:{type:"sap.ui.vk.DetailViewShape",defaultValue:a.Box},borderWidth:{type:"float",defaultValue:2},backgroundColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},borderColor:{type:"sap.ui.core.CSSColor",defaultValue:"#000"},origin:{type:"any",defaultValue:new e.Vector2(0,0)},size:{type:"any",defaultValue:new e.Vector2(.5,.5)},attachmentPoint:{type:"any",defaultValue:null},metadata:{type:"any",defaultValue:{}},veId:{type:"any",defaultValue:{}},visibleNodes:{type:"any",defaultValue:null},targetNodes:{type:"any",defaultValue:null}}}});s.prototype.init=function(){if(t.prototype.init){t.prototype.init.call(this)}this._backgroundColor=new e.Color;this._node=new e.Group;var r=new e.MeshBasicMaterial({depthTest:false});this._line=new e.Mesh(new e.BufferGeometry,r);this._line.renderOrder=0;this._node.add(this._line);var i=new e.BufferGeometry;i.setIndex([0,1,2]);var a=new e.MeshBasicMaterial({color:this._backgroundColor,depthTest:false});this._triangle=new e.Mesh(i,a);this._triangle.renderOrder=1;this._node.add(this._triangle);this._billboard=new e.Mesh(new e.BufferGeometry,new e.MeshBasicMaterial({depthTest:false}));this._billboard.renderOrder=2;this._node.add(this._billboard);this._border=new e.Mesh(new e.BufferGeometry,r);this._border.renderOrder=3;this._node.add(this._border)};s.prototype.setCamera=function(e){if(e instanceof n||e instanceof o){this.setProperty("camera",e,true)}return this};s.prototype.setShape=function(e){this.setProperty("shape",e,true);return this};s.prototype.setBackgroundColor=function(e){this.setProperty("backgroundColor",e,true);this._backgroundColor.setStyle(e);this._triangle.material.color.copy(this._backgroundColor);return this};s.prototype.setBorderColor=function(e){this.setProperty("borderColor",e,true);this._border.material.map=null;return this};s.prototype.setBorderWidth=function(e){this.setProperty("borderWidth",e,true);this._border.material.map=null;return this};s.prototype.setOrigin=function(t){if(t instanceof e.Vector2){this.setProperty("origin",t,true)}return this};s.prototype.setSize=function(t){if(t instanceof e.Vector2){this.setProperty("size",t,true)}return this};var l=-.5,h=1.5,u=new e.Vector4,p=new e.Vector3,d=new e.Vector3,c=new e.Vector3,f=new e.Vector2,y=new e.Vector2,v=new e.Vector2,b=new e.Matrix4;function _(e,t){return Math.PI*(3*(e+t)-Math.sqrt((3*e+t)*(e+3*t)))}function g(e,t,r,i,a,o){var n=e[t],s=e[t+1],l=e[a],h=e[a+1],u=e[o],p=e[o+1],d=i-s,c=n-r;var f=((l-n)*d+(h-s)*c)/((l-u)*d+(h-p)*c);e[a]=l+(u-l)*f;e[a+1]=h+(p-h)*f}function m(e,t,r,i){f.set(e[r+1]-e[t+1],e[t]-e[r]).normalize().multiplyScalar(i);e[t]+=f.x;e[t+1]+=f.y;e[r]+=f.x;e[r+1]+=f.y}function x(e,t){var r=e.length;for(var i=0;i<6;i+=3){var a=i===0?t*l:t*h;var o=e[i],n=e[i+1];for(var s=i;s<r-6;s+=6){var u=e[s],p=e[s+1];e[s]=o;e[s+1]=n;o=e[s+6];n=e[s+7];m(e,s,s+6,a);if(s>i){g(e,s-6,u,p,s,s+6)}}}}s.prototype._createBoxViewport=function(t,r,i,a){var o=[-t,-r,0,t,-r,0,t,r,0,-t,r,0];var n=this._billboard.geometry;n.setIndex([0,1,2,0,2,3]);n.setAttribute("position",new e.Float32BufferAttribute(o,3));n.setAttribute("uv",new e.Float32BufferAttribute([0,0,1,0,1,1,0,1],2));if(this._border.visible){var s=[],l;for(l=0;l<o.length;l+=3){var h=o[l],u=o[l+1];s.push(h,u,0,h,u,0)}s.push(s[0],s[1],0,s[0],s[1],0);x(s,this._borderWidth);l=s.length-6;s[0]=s[l];s[l+1]=s[1];s[3]=s[l+3];s[l+4]=s[4];this._createBorderGeometry(this._border.geometry,s)}};s.prototype._createCircleViewport=function(t,r,i,a){var o=[0,0,0],n=[.5,.5],s=[];var l=e.MathUtils.clamp(Math.round(_(t,r)/24),32,256);var u=2*Math.PI/l;for(var p=0;p<l;p++){var d=p*u,c=Math.cos(d),y=Math.sin(d);o.push(c*t,y*r,0);n.push(c*.5+.5,y*.5+.5);s.push(0,p+1,p+1<l?p+2:1)}var v=this._billboard.geometry;v.setIndex(s);v.setAttribute("position",new e.Float32BufferAttribute(o,3));v.setAttribute("uv",new e.Float32BufferAttribute(n,2));var b=this._borderWidth*h;this._createCircleBorder(o,t,r,i&&f.set(i.x/(t+b),i.y/(r+b)).length()>1?i:null,a)};s.prototype._createCircleBorder=function(t,r,i,o,n){var s=this._borderWidth,u=[],p,d,c;if(o&&(n!==a.Circle&&n!==a.CircleLine)){u.push(o.x,o.y,0,o.x,o.y,0);var y=Math.PI*.05;var v=Math.atan2(o.y*r,o.x*i)+y;var b=t.length/3-3;y=2*(Math.PI-y)/b;for(p=0;p<=b;p++){var _=v+p*y;d=Math.cos(_)*r;c=Math.sin(_)*i;u.push(d,c,0,d,c,0)}var g=[o.x,o.y,0,u[6],u[7],0,u[u.length-3],u[u.length-2],0];u.push(o.x,o.y,0,o.x,o.y,0);x(u,s);p=u.length-6;var m=f.set(u[9],u[10]).sub(o).length();var w=f.set(u[9]-u[p-3],u[10]-u[p-2]).length()*.5;var M=o.length();M=1-s*2*m/(w*M);u[p+0]=u[0]=o.x*M;u[p+1]=u[1]=o.y*M;u[p+3]=u[3]=o.x;u[p+4]=u[4]=o.y;var C=this._triangle.geometry;M=(1+M)*.5;g[0]*=M;g[1]*=M;C.setAttribute("position",new e.Float32BufferAttribute(g,3));this._triangle.visible=true;this._triangle.material.color.set(n===a.SolidPointer||n===a.SolidArrow?this.getBorderColor():this._backgroundColor)}else{this._line.visible=this._line.visible&&o!==null;for(p=3;p<t.length;p+=3){d=t[p];c=t[p+1];u.push(d,c,0,d,c,0)}u.push(u[0],u[1],0,u[0],u[1],0);x(u,s);p=u.length-6;u[p]=u[0]=t[3]+s*l;u[p+3]=u[3]=t[3]+s*h;u[p+1]=u[1]=t[4];u[p+4]=u[4]=t[4]}this._createBorderGeometry(this._border.geometry,u)};s.prototype._createBorderGeometry=function(t,r){var i,a=r.length/3;var o=[];for(i=2;i<a;i+=2){o.push(i-1,i,i-2,i+1,i,i-1)}var n=[];var s=this._borderU;for(i=0;i<a;i+=2){n.push(0,.5,s,.5)}t.setIndex(o);t.setAttribute("position",new e.Float32BufferAttribute(r,3));t.setAttribute("uv",new e.Float32BufferAttribute(n,2))};s.prototype._createLine=function(e){var t=[0,0,0,0,0,0,e.x,e.y,0,e.x,e.y,0];m(t,0,6,-this._borderWidth);m(t,3,9,this._borderWidth);this._createBorderGeometry(this._line.geometry,t)};s.prototype._updateGeometry=function(e,t,r){var i=this.getShape(),o=this.getAttachmentPoint(),n=this.getOrigin();this._border.visible=i!==a.BoxNoOutline;this._line.visible=i===a.BoxLine||i===a.CircleLine;this._triangle.visible=false;if(o){u.copy(o).applyMatrix4(r.matrixWorldInverse).applyMatrix4(r.projectionMatrix);o=u.w>0?o:null;var s=u.x/u.w*t.x/t.y,l=u.y/u.w;c.set(s-n.x,l-n.y,0).multiplyScalar(t.y)}switch(i){default:case a.Box:case a.BoxLine:case a.BoxNoOutline:this._createBoxViewport(e.x,e.y,o?c:null,i);break;case a.Circle:case a.CircleLine:case a.CirclePointer:case a.CircleArrow:case a.CircleBubbles:case a.SolidPointer:case a.SolidArrow:this._createCircleViewport(e.x,e.y,o?c:null,i);break}if(this._line.visible){this._createLine(c)}};s.prototype._updateBorderTexture=function(t){var r=Math.round(this.getBorderWidth()*t);this._borderWidth=r+2;var i=e.MathUtils.ceilPowerOfTwo(this._borderWidth);this._borderU=this._borderWidth/i;this._borderWidth/=t;var a=new ArrayBuffer(i*4);var o=new Uint32Array(a);var n=new e.Color(this.getBorderColor());n=n.r*255|n.g*255<<8|n.b*255<<16|4278190080;o.fill(n&16777215);for(var s=1;s<=r;s++){o[s]=n}var l=new e.DataTexture(new Uint8Array(a),i,1,e.RGBAFormat,e.UnsignedByteType,e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);l.needsUpdate=true;this._border.material.map=l;this._border.material.needsUpdate=true;this._line.material=this._border.material};function w(e){var t=e.elements;var r=t[15]===1;var i=2/t[0];var a=2/t[5];var o,n;if(r){o=-t[12]*i;n=-t[13]*a}else{o=t[8]*i;n=t[9]*a}var s=(i+o)*.5;var l=o-s;var h=(a+n)*.5;var u=n-h;return{left:l,top:h,right:s,bottom:u}}function M(e,t){var r=e.elements;var i=r[15]===1;r[0]=2/(t.right-t.left);r[5]=2/(t.top-t.bottom);if(i){r[12]=-(t.right+t.left)/(t.right-t.left);r[13]=-(t.top+t.bottom)/(t.top-t.bottom)}else{r[8]=(t.right+t.left)/(t.right-t.left);r[9]=(t.top+t.bottom)/(t.top-t.bottom)}}function C(t,r,i,a){var o=i.x/a.x;var n=i.y/a.y;u.copy(r).applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix);var s=(u.x/u.w-o)*.5+.5;var l=(u.y/u.w-n)*.5+.5;var h=w(t.projectionMatrix);var p={};p.left=e.MathUtils.lerp(h.left,h.right,s);p.right=e.MathUtils.lerp(h.left,h.right,s+o);p.top=e.MathUtils.lerp(h.top,h.bottom,1-l-n);p.bottom=e.MathUtils.lerp(h.top,h.bottom,1-l);M(t.projectionMatrix,p)}var B=new e.Vector2;s.prototype._render=function(t,r,a,o,n){t.getSize(B);var s=t.getPixelRatio(),l=this.getOrigin(),h=this._node,c=h.position;if(!this._border.material.map){this._updateBorderTexture(s)}y.copy(this.getSize()).multiplyScalar(B.y*.5);y.set(Math.round(y.x)<<1,Math.round(y.y)<<1);c.set(l.x*B.y/B.x,l.y,0).unproject(r);u.copy(c).applyMatrix4(r.matrixWorldInverse).applyMatrix4(r.projectionMatrix);var f=(u.x/u.w*.5+.5)*B.x,_=(u.y/u.w*.5+.5)*B.y;var g=u.w/(B.x*r.projectionMatrix.elements[0]);h.scale.setScalar(g);p.setFromMatrixColumn(r.matrixWorld,0).multiplyScalar(g*2*(Math.round(f)-f));d.setFromMatrixColumn(r.matrixWorld,1).multiplyScalar(g*2*(Math.round(_)-_));c.add(p).add(d);h.quaternion.copy(r.quaternion);h.updateMatrix();h.updateMatrixWorld();this._updateGeometry(y,B,r);v.copy(y).multiplyScalar(s);if(!this._renderTarget||this._renderTarget.width!==v.x||this._renderTarget.height!==v.y){this._renderTarget=new e.WebGLRenderTarget(v.x,v.y,{minFilter:e.LinearFilter,magFilter:e.NearestFilter,format:e.RGBFormat});this._billboard.material.map=this._renderTarget.texture;this._billboard.material.needsUpdate=true}var m;if(this.getType()===i.Cutaway){m=r;b.copy(m.projectionMatrix);C(m,c,y,B)}else{m=this.getCamera();m.adjustClipPlanes(o);m.update(y.x,y.y);m=m.getCameraRef()}var x=new Set;a.children.forEach(function(e){if(e.userData._vkDynamicObjects){e.userData._vkDynamicObjects.forEach(function(e){if(e.parent){if(e.userData.is2D||e.isBillboard){if(e.visible){x.add(e)}e.visible=false}else{e._vkUpdate(t,m,y)}}})}});if(n){n.position.copy(m.position);n.updateMatrix();n.updateMatrixWorld()}var w=this.getTargetNodes();var M=this.getTargetNodes();if(Array.isArray(M)){w.forEach(function(e){e.userData._visible=e.visible;e.visible=true})}if(Array.isArray(M)){M.forEach(function(e){e.userData._visible=e.visible;e.visible=false})}t.setClearColor(this._backgroundColor,1);t.setRenderTarget(this._renderTarget);t.clear();t.render(a,m);if(m===r){r.projectionMatrix.copy(b)}if(Array.isArray(w)){w.forEach(function(e){e.visible=e.userData._visible})}if(Array.isArray(M)){M.forEach(function(e){e.visible=e.userData._visible})}t.setRenderTarget(null);t.render(this._node,r);a.children.forEach(function(e){if(e.userData._vkDynamicObjects){e.userData._vkDynamicObjects.forEach(function(e){if(e.parent&&(e.userData.is2D||e.isBillboard)){e.visible=x.has(e)}})}})};return s});