/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","sap/ui/base/EventProvider","./PerspectiveCamera","./OrthographicCamera","../thirdparty/three","../getResourceBundle","../NodeContentType"],function(e,t,a,i,r,o,n){"use strict";var s=t.extend("sap.ui.vk.threejs.ViewportGestureHandler",{metadata:{library:"sap.ui.vk"},constructor:function(t){this._matProj=null;this._viewport=t;this._rect=null;this._evt={x:0,y:0,z:0,d:0,initd:0};this._gesture=false;this._viewport.attachEvent("resize",this,this._onresize);this._nomenu=false;var a=function(t){var a=t;var i=new r.Vector3;var s=new r.Vector2;var h=.001;var l=-Math.PI/2+h;var m=Math.PI/2-h;this.isTurnTableMode=true;this._timeIntervalForCameraAnimation=500;this._startTimeForCameraAnimation=0;this._newCamera=null;this._oldCamera=null;this._animationType=null;this._zoomedNodeRef=null;this._isZoomIn=true;this.beginGesture=function(e,t){var o=a.getScene();if(o==null){return}var n=a.getCamera().getCameraRef();var h=a.getRenderer().getSize(new r.Vector2);s.x=e/h.width*2-1;s.y=t/h.height*-2+1;a._gesturePoint={x:e,y:t};var l=n.userData.isRedlineActivated?null:a.hitTest(e,t,o.getSceneRef(),n);if(l){i.copy(l.point)}else{var m=o._computeBoundingBox(true,true);if(!m.isEmpty()){m.getCenter(i)}else{i.setScalar(0)}}};this.endGesture=function(){};this.pan=function(e,t){if(a.getFreezeCamera()||a.getCamera()===null||e===0&&t===0){return}if(a._redlineHandler){a._redlineHandler.pan(e,t)}else if(a._isPanoramicActivated()){this.rotate(e,t);return}var o=a.getCamera().getCameraRef();var n=a.getRenderer().getSize(new r.Vector2);if(o.view&&o.view.enabled){o.view.offsetX-=e*o.view.width/o.view.fullWidth;o.view.offsetY-=t*o.view.height/o.view.fullHeight;o.updateProjectionMatrix()}else{var s=i.clone().project(o);s.x-=e*2/n.width;s.y+=t*2/n.height;s.unproject(o).sub(i);o.position.add(s);o.updateMatrixWorld()}a.fireCameraChanged({position:o.position.toArray()})};var d=[new r.Vector3(+1,0,0),new r.Vector3(-1,0,0),new r.Vector3(0,+1,0),new r.Vector3(0,-1,0),new r.Vector3(0,0,+1),new r.Vector3(0,0,-1)];this.rotate=function(e,t,o){if(a.getFreezeCamera()||a.getCamera()===null||e===0&&t===0){return}if(a._redlineHandler||a._isPlanarActivated()){this.pan(e,t);return}if(o!==undefined){this.isTurnTableMode=o}var n=a.getCamera().getCameraRef();var s=-.01;if(a._isPanoramicActivated()){var h=a.getRenderer().getSize(new r.Vector2);s=2/(h.x*n.projectionMatrix.elements[0]);i.copy(n.position)}var p=e*s,v=t*s;var c=n.position.clone().sub(i);var u=new r.Vector3,_=(new r.Vector3).setFromMatrixColumn(n.matrixWorld,1).normalize(),f=(new r.Vector3).setFromMatrixColumn(n.matrixWorld,0).normalize();n.getWorldDirection(u);u.normalize();var C=new r.Quaternion;if(this.isTurnTableMode){var g=d[a._upAxis]||d[2];f.sub(g.clone().multiplyScalar(g.dot(f))).normalize();var w=f.clone().cross(u);var y=Math.acos(Math.min(Math.max(w.dot(_),-1),1));if(y!==0){var x=Math.abs(p)+Math.abs(v);if(Math.abs(y)>x){y=Math.sign(y)*x}var M=_.clone().cross(w).normalize();_.applyQuaternion((new r.Quaternion).setFromAxisAngle(M,y))}C.setFromAxisAngle(g,p);var b=Math.atan2(u.y,Math.sqrt(u.x*u.x+u.z*u.z));v=r.MathUtils.clamp(v,l-b,m-b)}else{C.setFromAxisAngle(_,p)}C.multiply((new r.Quaternion).setFromAxisAngle(f,v));c.applyQuaternion(C);u.applyQuaternion(C);_.applyQuaternion(C);c.add(i);if(!n.userData.rotate){n.position.copy(c)}n.up.copy(_);n.lookAt(c.add(u));n.updateMatrixWorld();a.fireCameraChanged({position:n.position.toArray(),quaternion:n.quaternion.toArray()})};this.zoom=function(t){if(t===0||t===1||a.getFreezeCamera()||a.getCamera()===null||a.getScene()===null){return}var n=a.getCamera().getCameraRef();var h=new r.Vector3;if(!n.userData.isRedlineActivated){var l=100;var m=new r.Vector3;var d=!a.getBackgroundProjection();var p=a.getScene()._computeBoundingBox(true,d);p.applyMatrix4(n.matrixWorldInverse);p.min.z=Math.max(p.min.z,n.near);p.max.z=Math.max(p.max.z,n.near);p.applyMatrix4(n.projectionMatrix);p.getSize(m);var v=a.getRenderer().getSize(new r.Vector2);var c=m.x*v.width*.5;var u=m.y*v.height*.5;if(c<l&&u<l&&t<1){return}}var _=a._redlineHandler;if(_){t=Math.min(Math.max(_._zoomFactor*t,1/8),32)/_._zoomFactor;_._zoomFactor*=t;_.zoom(t)}if(n.view&&n.view.enabled){var f=a.getDomRef();var C=a._gesturePoint.x/f.clientWidth;var g=a._gesturePoint.y/f.clientHeight;var w=1/t;n.view.offsetX+=C*n.view.width;n.view.offsetY+=g*n.view.height;n.view.width*=w;n.view.height*=w;n.view.offsetX-=C*n.view.width;n.view.offsetY-=g*n.view.height}else if(n.isPerspectiveCamera){if(a._isPanoramicActivated()){n.fov=Math.min(Math.max(5,n.fov/Math.pow(t,.5)),90)}else{h.set(s.x,s.y,1).unproject(n);h.sub(new r.Vector3(s.x,s.y,-1).unproject(n));var y=i.clone().sub(n.position).length()*(1-1/t);h.setLength(y);n.position.add(h)}}else if(n.isOrthographicCamera){h.set(s.x,s.y,1).unproject(n);h.sub(new r.Vector3(0,0,1).unproject(n));h.multiplyScalar(1-1/t);n.zoom*=t;n.position.add(h)}else{e.error(o().getText("VIEWPORTGESTUREHANDLER_MSG_UNSUPPORTEDCAMERATYPE"))}n.updateProjectionMatrix();n.updateMatrixWorld();var x={position:n.position.toArray()};if(n.isOrthographicCamera){x.zoom=n.zoom}a.fireCameraChanged(x)};this.animateCameraUpdate=function(){if(this._newCamera===null||this._oldCamera===null){return}if(a.getCamera()==null){this._newCamera=null;this._oldCamera=null;return}function e(e,t,a){a=r.MathUtils.clamp((a-e)/(t-e),0,1);return a*a*a*(a*(a*6-15)+10)}var t=Math.min((Date.now()-this._startTimeForCameraAnimation)/this._timeIntervalForCameraAnimation,1);t=e(0,1,t);var i=a.getCamera().getCameraRef();if(i.view&&i.view.enabled){var o=i.view.width;var n=i.view.height;var s=i.view.offsetX+i.view.width*.5;var h=i.view.offsetY+i.view.height*.5;i.view.offsetX=r.MathUtils.lerp(this._oldCamera.view.offsetX,this._newCamera.view.offsetX,t);i.view.offsetY=r.MathUtils.lerp(this._oldCamera.view.offsetY,this._newCamera.view.offsetY,t);i.view.width=r.MathUtils.lerp(this._oldCamera.view.width,this._newCamera.view.width,t);i.view.height=r.MathUtils.lerp(this._oldCamera.view.height,this._newCamera.view.height,t);var l=i.view.offsetX+i.view.width*.5;var m=i.view.offsetY+i.view.height*.5;var d=a._redlineHandler;if(d){var p=o/i.view.width;var v=(s-l)*i.view.fullWidth/o;var c=(h-m)*i.view.fullHeight/n;d._zoomFactor*=p;d.pan(v,c);d.zoom(p,i.view.fullWidth*.5,i.view.fullHeight*.5)}}if(i.isOrthographicCamera&&this._newCamera.isOrthographicCamera&&this._oldCamera.isOrthographicCamera){i.left=r.MathUtils.lerp(this._oldCamera.left,this._newCamera.left,t);i.right=r.MathUtils.lerp(this._oldCamera.right,this._newCamera.right,t);i.top=r.MathUtils.lerp(this._oldCamera.top,this._newCamera.top,t);i.bottom=r.MathUtils.lerp(this._oldCamera.bottom,this._newCamera.bottom,t);if(this._transitionEffect==="zoomIn"){var u=Math.max(this._oldCamera.zoom,this._newCamera.zoom)*5;i.zoom=t<.5?r.MathUtils.lerp(this._oldCamera.zoom,u,t*2):r.MathUtils.lerp(u,this._newCamera.zoom,(t-.5)*2)}else{i.zoom=r.MathUtils.lerp(this._oldCamera.zoom,this._newCamera.zoom,t)}}if(i.isPerspectiveCamera&&this._newCamera.isPerspectiveCamera&&this._oldCamera.isPerspectiveCamera){if(this._transitionEffect==="zoomIn"){var _=Math.min(this._oldCamera.fov,this._newCamera.fov)*.1;i.fov=t<.5?r.MathUtils.lerp(this._oldCamera.fov,_,t*2):r.MathUtils.lerp(_,this._newCamera.fov,(t-.5)*2)}else{i.fov=r.MathUtils.lerp(this._oldCamera.fov,this._newCamera.fov,t)}}i.far=r.MathUtils.lerp(this._oldCamera.far,this._newCamera.far,t);i.near=r.MathUtils.lerp(this._oldCamera.near,this._newCamera.near,t);i.updateProjectionMatrix();i.position.lerpVectors(this._oldCamera.position,this._newCamera.position,t);i.scale.lerpVectors(this._oldCamera.scale,this._newCamera.scale,t);i.up.lerpVectors(this._oldCamera.up,this._newCamera.up,t);var f=this._oldCamera.getWorldDirection(new r.Vector3);var C=this._newCamera.getWorldDirection(new r.Vector3);var g=(new r.Vector3).lerpVectors(f,C,t);i.lookAt(g.add(i.position));if(t===1){this._newCamera=null;this._oldCamera=null;if(this._animationType==="zooming"&&this._zoomedNodeRef){a.fireNodeZoomed({zoomed:this._zoomedNodeRef,isZoomIn:this._isZoomIn})}a.cameraUpdateCompleted({position:i.position.toArray(),quaternion:i.quaternion.toArray()})}a.fireCameraChanged({position:i.position.toArray(),quaternion:i.quaternion.toArray()})};this.startCameraAnimation=function(e,t){this._startTimeForCameraAnimation=Date.now();this._timeIntervalForCameraAnimation=e!==undefined?e:500;this._transitionEffect=t};this.lookAtObject=function(e,t){if(e._vkGetNodeContentType()!==n.Background){this.prepareForCameraUpdateAnimation();var i=a.getCamera().getCameraRef();this._newCamera=i.clone();this._newCamera.lookAt(e.getWorldPosition(new r.Vector3));this._newCamera.up.set(0,1,0);this._newCamera.updateMatrixWorld();this.startCameraAnimation(t)}};this.zoomObject=function(e,t,i){if(a.getScene()==null){return}var o;if(t&&e){o=new r.Box3;e._expandBoundingBox(o,true,true)}else{o=a.getScene()._computeBoundingBox(true,true)}if(e&&(e._vkGetNodeContentType()===n.Background||e._vkGetNodeContentType()===n.Symbol)){o.setFromObject(e)}var s=e&&e._vkGetNodeContentType()===n.Symbol?10:0;this.zoomBox(o,s,i,e,t)};this.zoomBox=function(e,t,i,r,o){this._zoomedNodeRef=r;this._isZoomIn=o;this._animationType="zooming";this._newCamera=a.getCamera().getCameraRef().clone();this._newCamera._vkZoomTo(e,t);if(a.getBackgroundProjection()==="spherical"){this._newCamera.position.setScalar(0)}this.startCameraAnimation(i)};this.prepareForCameraUpdateAnimation=function(){this._oldCamera=a.getCamera().getCameraRef().clone()};this.startAnimatingCameraUpdate=function(e,t,i){var r=a.getCamera().getCameraRef();if(!this._oldCamera){return 0}var o=!!i;var n=1e-4;if(r.isOrthographicCamera&&this._oldCamera.isOrthographicCamera){if(Math.abs(r.left-this._oldCamera.left)>n||Math.abs(r.right-this._oldCamera.right)>n||Math.abs(r.top-this._oldCamera.top)>n||Math.abs(r.bottom-this._oldCamera.bottom)>n||Math.abs(r.zoom-this._oldCamera.zoom)>n){o=true}}else if(r.isPerspectiveCamera&&this._oldCamera.isPerspectiveCamera){if(Math.abs(r.fov-this._oldCamera.fov)>n||Math.abs(r.aspect-this._oldCamera.aspect)>n){o=true}}if(!o){if(Math.abs(r.position.x-this._oldCamera.position.x)>n||Math.abs(r.position.y-this._oldCamera.position.y)>n||Math.abs(r.position.z-this._oldCamera.position.z)>n||Math.abs(r.scale.x-this._oldCamera.scale.x)>n||Math.abs(r.scale.y-this._oldCamera.scale.y)>n||Math.abs(r.scale.z-this._oldCamera.scale.z)>n||Math.abs(r.quaternion.x-this._oldCamera.quaternion.x)>n||Math.abs(r.quaternion.y-this._oldCamera.quaternion.y)>n||Math.abs(r.quaternion.z-this._oldCamera.quaternion.z)>n||Math.abs(r.quaternion.w-this._oldCamera.quaternion.w)>n){o=true}}if(!o){if(!t){a.cameraUpdateCompleted({position:r.position.toArray(),quaternion:r.quaternion.toArray()});return 0}else{e=500}}this._newCamera=a.getCamera().getCameraRef().clone();this.startCameraAnimation(e,i);return e}};this._cameraController=new a(t)}});s.prototype._activateRedline=function(){var e=this._viewport.getCamera().getCameraRef();e.userData.isRedlineActivated=true;var t=this._viewport.getDomRef();e.setViewOffset(t.clientWidth,t.clientHeight,0,0,t.clientWidth,t.clientHeight)};s.prototype._deactivateRedline=function(){var e=this._viewport&&this._viewport.getCamera();if(e){var t=e.getCameraRef();t.userData.isRedlineActivated=false;t.clearViewOffset()}};s.prototype.destroy=function(){this._viewport=null;this._rect=null;this._evt=null;this._gesture=false};s.prototype._getOffset=function(e){var t=e.getBoundingClientRect();var a={x:t.left+window.pageXOffset,y:t.top+window.pageYOffset};return a};s.prototype._inside=function(e){if(this._rect===null||true){var t=this._viewport.getIdForLabel();var a=document.getElementById(t);if(!a){return false}var i=this._getOffset(a);this._rect={x:i.x,y:i.y,w:a.offsetWidth,h:a.offsetHeight}}return e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h};s.prototype._onresize=function(e){this._gesture=false;this._rect=null};s.prototype.beginGesture=function(t){if(this._inside(t)&&!this._gesture){this._gesture=true;var a=t.x-this._rect.x,i=t.y-this._rect.y;this._evt.x=a;this._evt.y=i;this._evt.d=t.d;this._evt.initd=t.d;this._evt.avgd=t.d;this._evt.avgx=0;this._evt.avgy=0;e.debug("Loco: beginGesture: "+a+", "+i);this._cameraController.beginGesture(a,i);t.handled=true;if(document.activeElement){try{document.activeElement.blur()}catch(e){}}var r=document.getElementById(this._viewport.getIdForLabel());r.focus()}this._nomenu=false};s.prototype.move=function(t){if(this._gesture){var a=t.x-this._rect.x,i=t.y-this._rect.y;var o=a-this._evt.x;var n=i-this._evt.y;var s=t.d-this._evt.d;this._evt.x=a;this._evt.y=i;this._evt.d=t.d;this._evt.avgx=this._evt.avgx*.99+o*.01;this._evt.avgy=this._evt.avgy*.99+n*.01;var h=1;if(this._evt.initd>0){h=1+s*(1/this._evt.initd)}else if(t.n===2){if(t.points[0].y>t.points[1].y){h=1-s*.005;if(h<.333){h=.333}}else{h=1+s*.005;if(h>3){h=3}}}if(this._evt.initd>0){var l=Math.sqrt(this._evt.avgx*this._evt.avgx+this._evt.avgy*this._evt.avgy);e.debug("AvgDist: "+l);if(Math.abs(t.d-this._evt.avgd)/this._evt.avgd<l/10){h=1}}h=r.MathUtils.clamp(h,.88,1.12);this._evt.avgd=this._evt.avgd*.97+t.d*.03;switch(t.n){case 1:e.debug("Loco: Rotate: "+o+", "+n);this._cameraController.rotate(o,n);break;case 2:e.debug("Loco: Pan: "+o+", "+n);if(h!=0&&h!=1){e.debug("Loco: Zoom: "+h)}this._cameraController.pan(o,n);if(o<10&&n<10&&h!=0&&h!=1){this._cameraController.zoom(h)}break;default:break}this._nomenu=true;t.handled=true}};s.prototype.endGesture=function(t){if(this._gesture){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: endGesture: "+a+", "+i);this._cameraController.endGesture();this._gesture=false;t.handled=true}};s.prototype.click=function(t){if(this._inside(t)&&t.buttons<=1){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: click: "+a+", "+i);if(this._viewport){this._viewport.tap(a,i,false)}t.handled=true}};s.prototype.doubleClick=function(t){if(this._inside(t)&&t.buttons<=1){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: doubleClick: "+a+", "+i);if(this._viewport){this._viewport.tap(a,i,true)}t.handled=true}};s.prototype.contextMenu=function(e){if(this._inside(e)||this._nomenu||e.buttons===5){this._nomenu=false;e.handled=true}};s.prototype.keyEventHandler=function(e){};s.prototype.getViewport=function(){return this._viewport};s.prototype.activateCamera=function(e,t,o,n){var s=0;this._cameraController.prepareForCameraUpdateAnimation();if(this._viewport.getCamera().getCameraRef().isPerspectiveCamera!=e.isPerspectiveCamera){var h=e.isPerspectiveCamera?new a:new i;h.getCameraRef().copy(e);this._viewport.setCamera(h)}else{this._viewport.getCamera().getCameraRef().copy(e)}var l=this._viewport.getRenderer().getSize(new r.Vector2);this._viewport.getCamera().update(l.width,l.height);if(t>0){s=this._cameraController.startAnimatingCameraUpdate(t,o,n)}else{this._viewport.cameraUpdateCompleted({position:e.position.toArray(),quaternion:e.quaternion.toArray()})}return s};s.prototype.setView=function(t,i){var o=this._viewport.getCamera().getCameraRef();if(o.userData.isRedlineActivated){e.error("setView() method is disabled when Redlining is activated");return this}this._cameraController.prepareForCameraUpdateAnimation();if(t){o.quaternion.copy(t);o.updateMatrixWorld();o.up.setFromMatrixColumn(o.matrixWorld,1).normalize();this._cameraController.zoomObject(null,false,i)}else{o.copy(this._viewport._homeCamera?this._viewport._homeCamera:(new a).getCameraRef());var n=this._viewport.getRenderer().getSize(new r.Vector2);this._viewport.getCamera().update(n.width,n.height);this._cameraController.startAnimatingCameraUpdate(i)}return this};s.prototype.zoomTo=function(t,a,i,r,o,n){if(this._viewport._isPanoramicActivated()||this._viewport._isPlanarActivated()){e.error("zoomTo() method is disabled in navigation scene");return this}var s=this._viewport.getCamera().getCameraRef();this._cameraController.prepareForCameraUpdateAnimation();if(a){s.quaternion.copy(a);s.updateMatrixWorld();s.up.setFromMatrixColumn(s.matrixWorld,1).normalize()}this._cameraController.zoomBox(t,i,r,o,n);return this};s.prototype.zoomObject=function(e,t,a){if(this._viewport._isPanoramicActivated()){this._cameraController.lookAtObject(e,a)}else{this._cameraController.prepareForCameraUpdateAnimation();this._cameraController.zoomObject(e,t,a)}return this};s.prototype.animateCameraUpdate=function(){this._cameraController.animateCameraUpdate()};s.prototype.prepareForCameraUpdateAnimation=function(){this._cameraController.prepareForCameraUpdateAnimation()};s.prototype.startAnimatingCameraUpdate=function(e){this._cameraController.startAnimatingCameraUpdate(e)};return s});