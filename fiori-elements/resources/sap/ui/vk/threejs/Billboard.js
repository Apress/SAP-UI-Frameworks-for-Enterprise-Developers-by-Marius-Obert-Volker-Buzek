/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/ManagedObject","../thirdparty/three","../thirdparty/html2canvas","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","./ThreeUtils","../NodeContentType"],function(t,e,i,r,a,o,n,l,h,s){"use strict";var d=t.extend("sap.ui.vk.threejs.Billboard",{metadata:{library:"sap.ui.vk",properties:{node:{type:"any",defaultValue:new e.Group},text:{type:"string",defaultValue:""},font:{type:"string",defaultValue:""},fontSize:{type:"float",defaultValue:20},fontWeight:{type:"string",defaultValue:"normal"},fontItalic:{type:"boolean",defaultValue:false},textColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},borderColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},borderOpacity:{type:"float",defaultValue:1},backgroundColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},backgroundOpacity:{type:"float",defaultValue:.5},encoding:{type:"sap.ui.vk.BillboardTextEncoding",defaultValue:a.PlainText},width:{type:"float",defaultValue:100},height:{type:"float",defaultValue:100},style:{type:"sap.ui.vk.BillboardStyle",defaultValue:o.None},borderLineStyle:{type:"sap.ui.vk.BillboardBorderLineStyle",defaultValue:n.Solid},borderWidth:{type:"float",defaultValue:2},horizontalAlignment:{type:"sap.ui.vk.BillboardHorizontalAlignment",defaultValue:l.Left},texture:{type:"any",defaultValue:null},material:{type:"any"},link:{type:"string",defaultValue:""},coordinateSpace:{type:"sap.ui.vk.BillboardCoordinateSpace",defaultValue:r.Viewport},position:{type:"any",defaultValue:new e.Vector3(0,0,0)},renderOrder:{type:"int",defaultValue:0}}}});d.prototype._planeGeometry=new e.PlaneGeometry(1,1);d.prototype.init=function(){if(t.prototype.init){t.prototype.init.call(this)}var i=new e.MeshBasicMaterial({depthTest:false,depthWrite:false,transparent:true,alphaTest:.05,premultipliedAlpha:true,side:e.DoubleSide});this.setProperty("material",i,true);this._billboard=new e.Mesh(this._planeGeometry,i);this._needUpdateTexture=true};d.prototype.exit=function(){if(t.prototype.exit){t.prototype.exit.call(this)}if(this._billboard){h.disposeObject(this._billboard);this._billboard=null}};d.prototype.setNode=function(t){if(t instanceof e.Object3D){this.setProperty("node",t,true);t.add(this._billboard);t.matrixAutoUpdate=false;t.isBillboard=true;t.userData.billboard=this;this._traverse(function(t){t.userData.skipIt=true})}return this};d.prototype._traverse=function(t){t(this._billboard)};d.prototype.setEncoding=function(t){this.setProperty("encoding",t,true);this._needUpdateTexture=true;return this};d.prototype.setText=function(t){this.setProperty("text",t,true);this._needUpdateTexture=true;return this};d.prototype.setFont=function(t){this.setProperty("font",t,true);this._needUpdateTexture=true;return this};d.prototype.setFontSize=function(t){this.setProperty("fontSize",t,true);this._needUpdateTexture=true;return this};d.prototype.setFontWeight=function(t){this.setProperty("fontWeight",t,true);this._needUpdateTexture=true;return this};d.prototype.setFontItalic=function(t){this.setProperty("fontItalic",t,true);this._needUpdateTexture=true;return this};d.prototype.setStyle=function(t){this.setProperty("style",t,true);this._needUpdateTexture=true;return this};d.prototype.setWidth=function(t){this.setProperty("width",t,true);this._needUpdateTexture=true;return this};d.prototype.setHeight=function(t){this.setProperty("height",t,true);this._needUpdateTexture=true;return this};d.prototype.setTextColor=function(t){this.setProperty("textColor",t,true);this._needUpdateTexture=true;return this};d.prototype.setBackgroundColor=function(t){this.setProperty("backgroundColor",t,true);this._needUpdateTexture=true;return this};d.prototype.setBackgroundOpacity=function(t){this.setProperty("backgroundOpacity",t,true);this._needUpdateTexture=true;return this};d.prototype.setBorderWidth=function(t){this.setProperty("borderWidth",t,true);this._needUpdateTexture=true;return this};d.prototype.setBorderLineStyle=function(t){this.setProperty("borderLineStyle",t,true);this._needUpdateTexture=true;return this};d.prototype.setBorderColor=function(t){this.setProperty("borderColor",t,true);this._needUpdateTexture=true;return this};d.prototype.setBorderOpacity=function(t){this.setProperty("borderOpacity",t,true);this._needUpdateTexture=true;return this};d.prototype.setHorizontalAlignment=function(t){this.setProperty("horizontalAlignment",t,true);this._needUpdateTexture=true;return this};d.prototype.setLink=function(t){this.setProperty("link",t,true);this._needUpdateTexture=true;return this};d.prototype.setTexture=function(t){this.setProperty("texture",t,true);this._billboard.material.map=t;return this};d.prototype.setMaterial=function(t){this.setProperty("material",t,true);this._billboard.material=t;return this};d.prototype.setRenderOrder=function(t){this.setProperty("renderOrder",t,true);this._traverse(function(e){e.renderOrder=t});return this};d.prototype._renderBackground=function(t,e,i,r){t.fillStyle=this.getBackgroundColor();t.strokeStyle=this.getBorderColor();t.lineWidth=r;switch(this.getBorderLineStyle()){default:t.setLineDash([]);break;case n.Dash:t.setLineDash([r*5,r]);break;case n.Dot:t.setLineDash([r*2,r]);break;case n.DashDot:t.setLineDash([r*5,r,r*2,r]);break;case n.DashDotDot:t.setLineDash([r*5,r,r*2,r,r*2,r]);break}var a=r/2;if(this.getStyle()===o.RectangularShape){t.globalAlpha=this.getBackgroundOpacity();if(t.globalAlpha>0){t.fillRect(0,0,e,i)}t.globalAlpha=r>0?this.getBorderOpacity():0;if(t.globalAlpha>0){t.strokeRect(a,a,e-r,i-r)}}else if(this.getStyle()===o.CircularShape){var l=e/2;var h=i/2;var s=e/2;t.beginPath();t.arc(l,h,s-a,0,2*Math.PI);t.closePath();t.globalAlpha=this.getBackgroundOpacity();if(t.globalAlpha>0){t.fill()}t.globalAlpha=r>0?this.getBorderOpacity():0;if(t.globalAlpha>0){t.stroke()}}t.globalAlpha=1;t.setLineDash([])};d.prototype._getFont=function(t){return(this.getFontItalic()?"italic ":"")+this.getFontWeight()+" "+this.getFontSize()*t+"px "+(this.getFont()||"Arial")};d.prototype._renderPlainText=function(t){var i=document.createElement("canvas");var r=i.getContext("2d");var a=this.getFontSize()*t;var l=this._getFont(t);r.font=l;var h=Math.ceil(a);var s=this.getBorderLineStyle()!==n.None?this.getBorderWidth()*t:0;var d=Math.ceil(a*.2+s);var u=this.getText().split("\n");var p=0;u.forEach(function(t){p=Math.max(p,r.measureText(t).width)});var c=this.getLink();if(c.length>0){p=Math.max(p,r.measureText(c).width)}p=Math.ceil(p*.5)*2;var g=u.length+(c.length>0?1:0);var y=Math.ceil(h*g*.5)*2;var f=p+d*2;var x=y+d*2;if(this.getStyle()===o.CircularShape){f=x=Math.max(f,x)}this._width=f/t;this._height=x/t;i.width=e.MathUtils.ceilPowerOfTwo(f);i.height=e.MathUtils.ceilPowerOfTwo(x);this._renderBackground(r,f,x,s);r.font=l;r.textAlign=this.getHorizontalAlignment();r.textBaseline="middle";var m=["left","center","right"].indexOf(r.textAlign);var v=f+p*(m-1)>>1;var b=x-(g-1)*h>>1;r.fillStyle=this.getTextColor();r.filter="blur(0px)";for(var w in u){r.fillText(u[w],v,b+h*w)}if(c.length>0){r.fillStyle="#00f";r.textAlign="right";r.textBaseline="bottom";r.fillText(c,f-d,x-d)}this._setBillboardTexture(i,f,x)};d.prototype._renderHtmlText=function(t){var r=document.createElement("canvas");var a=r.getContext("2d");var l=this.getBorderLineStyle()!==n.None?this.getBorderWidth()*t:0;var h=Math.ceil(l);var s=Math.ceil(this.getWidth()*t)+h*2;var d=Math.ceil(this.getHeight()*t)+h*2;if(this.getStyle()===o.CircularShape){s=d=Math.max(s,d)}this._width=s/t;this._height=d/t;r.width=e.MathUtils.ceilPowerOfTwo(s);r.height=e.MathUtils.ceilPowerOfTwo(d);this._renderBackground(a,s,d,l);var u=this.getLink();if(u.length>0){a.font=this._getFont(t);a.fillStyle="#00f";a.textAlign="right";a.textBaseline="bottom";a.fillText(u,s-h,d-h)}var p=document.createElement("iframe");p.style.visibility="hidden";p.width=(s-h*2)/t;p.height=(d-h*2)/t;p.sandbox="allow-same-origin";document.body.appendChild(p);var c=p.contentDocument||p.contentWindow.document;c.open();c.close();c.body.innerHTML=this.getText();var g=document.createElement("canvas");g.width=p.width*t;g.height=p.height*t;g.style.width=p.width+"px";g.style.height=p.height+"px";var y=g.getContext("2d");y.scale(t,t);this._billboard.material.visible=false;i(c.body,{canvas:g,backgroundColor:null}).then(function(t){if(t.width>0&&t.height>0){r.getContext("2d").drawImage(t,h,h)}setTimeout(this._setBillboardTexture.bind(this,r,s,d),0);document.body.removeChild(p)}.bind(this))};d.prototype._renderText=function(t){var e=this.getFont()||"Arial";var r=this.getFontSize()*1.333;var l=4;var h=1.2;var s=1.25;var d;var u;var p=document.createElement("canvas");p.id="jDVLAnnotationCanvas-"+Math.random().toString(36).substr(2,9);p.style.visibility="hidden";p.style.display="none";var c=2048;var g=1024;var y=Math.pow(2,Math.ceil(Math.log(t)/Math.LN2));p.width=c*y;p.height=g*y;document.body.appendChild(p);var f=p.getContext("2d");var x=Math.min(Math.max(Math.round(this.getFontWeight()/100),1),9)*100;f.font=x+(this.getFontItalic()?" italic ":" ")+r+"px "+e;var m=Math.ceil(r*h);var v=this.getWidth();var b=this.getHeight();var w=this.getBorderLineStyle()!==n.None?this.getBorderWidth():0;var M=(this.getEncoding()===a.PlainText?1024:v)-(l+w)*2;var T=((this.getEncoding()===a.PlainText?1024:this.getHeight())-(l+w)*2)/m|0;var S=0;var _=0;var C=this.getText();var B=this.getLink();var k=this.getEncoding()===a.PlainText?C.split("\n"):[];k.length=Math.min(k.length,B.length>0?T-1:T);function P(t){return t.substr(0,t.length-2)+"â€¦"}var W=[];if(B.length>0){var D=T-k.length;while(B.length>0&&k.length<D){var A=B;while(f.measureText(A).width>M&&A.length>1){A=A.substring(0,A.length-1)}W.push(A);B=B.substring(A.length,B.length)}if(B.length>0){W[W.length-1]=P(W[W.length-1])}for(var V=0;V<W.length;V++){_=Math.max(f.measureText(W[V]).width,_)}}if(this.getEncoding()===a.PlainText){for(var L=0;L<k.length;L++){S=Math.max(f.measureText(k[L]).width,S)}var U=f.measureText(" ").width;v=Math.max(S,_)+U+l*2;b=(k.length+W.length)*m+l*2}else if(this.getEncoding()===a.HtmlText&&typeof i!="undefined"){d=document.createElement("iframe");d.style.visibility="hidden";d.sandbox="allow-same-origin";document.body.appendChild(d);u=d.contentDocument||d.contentWindow.document;u.open();u.close();u.documentElement.innerHTML=C;(function t(){var e;if(u.styleSheets.length===0){e=u.createElement("style");e.type="text/css";e.appendChild(document.createTextNode(""));u.head.appendChild(e)}e=u.querySelector("style");e.sheet.insertRule("* { margin: 0; padding: 0; line-height: 1; }",0);e.sheet.insertRule("span { line-height: "+s+"; overflow-wrap: break-word;  }",1);var i=e.sheet.cssRules;var r=[];for(var a=0;a<i.length;a++){r.push(i[a].cssText)}e.textContent=r.join("\n");u.body.removeAttribute("style");var o=u.body.querySelectorAll("p");if(o.length>0){o[0].style.marginTop=0;o[0].style.paddingTop="1px";o.forEach(function(t,e){t.style.whiteSpace="normal"})}u.body.querySelectorAll("span").forEach(function(t){var e=t.style.fontFamily.split(",");e.forEach(function(t,i){e[i]='"'+t.trim().replaceAll(/[\u0022\u0027]/g,"")+'"'});t.style.fontFamily=e.join(", ")})})();var E=function(t){function e(t,e){if(e.left<t.left){t.left=e.left}if(e.right>t.right){t.right=e.right}if(e.top<t.top){t.top=e.top}if(e.bottom>t.bottom){t.bottom=e.bottom}}u.body.style.margin=0;u.body.style.padding=0;u.body.style.border=0;var i=u.createElement("div");while(u.body.childNodes.length){var r=u.body.childNodes[0];i.appendChild(r)}u.body.appendChild(i);i.style.margin=0;i.style.padding=0;i.style.border=0;i.style.position="absolute";var a={left:Infinity,top:Infinity,right:-Infinity,bottom:-Infinity};var o;var n;if(t===undefined){i.style.width="min-content";i.style.height="min-content";i.style.overflowWrap="normal";u.querySelectorAll("span").forEach(function(t){e(a,t.getBoundingClientRect())});o=Math.ceil(a.right-a.left);n=Math.ceil(a.bottom-a.top);var h=a.width/a.height;var s=16/9;if(h>s){t={width:o,height:n}}else{var p=o*n;var c=Math.sqrt(p/s);var g=c*s;t={width:Math.ceil(g),height:Math.ceil(c)}}}i.style.width=t.width+"px";i.style.height=t.height+"px";i.style.overflowWrap="normal";u.querySelectorAll("span").forEach(function(t){e(a,t.getBoundingClientRect())});o=Math.ceil(a.right-a.left);if(Math.abs(o-t.width)>l){o=Math.min(o,t.width-2*l)}d.width=o;i.style.width=o+"px";a={left:Infinity,top:Infinity,right:-Infinity,bottom:-Infinity};u.querySelectorAll("p").forEach(function(t){e(a,t.getBoundingClientRect())});n=Math.ceil(a.bottom-a.top);var y={width:o,height:n};while(i.childNodes.length){var f=i.childNodes[0];u.body.appendChild(f)}u.body.removeChild(i);return y};var F={width:Math.ceil(v),height:Math.ceil(b)};F=E(v>0&&b>0?F:undefined);F.width+=l*2;F.height+=l*2;if(v<F.width){v=F.width}if(b<F.height){b=F.height}}v=Math.ceil(v+2*w);b=Math.ceil(b+2*w);if(this.getStyle()===o.CircularShape){v=b=Math.max(v,b)}v*=t;b*=t;var O=Math.pow(2,Math.ceil(Math.log(v)/Math.LN2));var q=Math.pow(2,Math.ceil(Math.log(b)/Math.LN2));O=Math.min(O,p.width);q=Math.min(q,p.height);var I=1;if(v>O||b>q){I=Math.min(O/v,q/b);v*=I;b*=I;t*=I}var j=v;var z=b;this._width=v/t;this._height=b/t;l*=t;w*=t;r*=t;m*=t;S*=t;f.fillStyle=this.getBackgroundColor();f.strokeStyle=this.getBorderColor();f.lineWidth=w;var N=w/2;switch(this.getBorderLineStyle()){default:f.setLineDash([]);break;case n.Dash:f.setLineDash([w*5,w]);break;case n.Dot:f.setLineDash([w*2,w]);break;case n.DashDot:f.setLineDash([w*5,w,w*2,w]);break;case n.DashDotDot:f.setLineDash([w*5,w,w*2,w,w*2,w]);break}var H=this.getBackgroundOpacity();var R=this.getBorderOpacity();if(this.getStyle()===o.RectangularShape){if(H>0){f.globalAlpha=H;f.fillRect(0,0,v,b)}f.globalAlpha=w>0?R:0;if(f.globalAlpha>0){f.strokeRect(N,N,v-w,b-w)}}else if(this.getStyle()===o.CircularShape){var G=v/2;var Q=b/2;var J=Math.min(G,Q);f.beginPath();f.arc(G,Q,J-N,0,2*Math.PI);f.closePath();if(H>0){f.globalAlpha=H;f.fill()}f.globalAlpha=w>0?R:0;if(R>0){f.stroke()}}f.globalAlpha=1;f.setLineDash([]);f.font=x+(this.getFontItalic()?" italic ":" ")+r+"px "+e;f.textAlign="left";f.textBaseline="middle";function K(){if(W.length>0){f.fillStyle="#0000FF";b-=W.length*m;var t=(v-_)*.5;var e=b-w-l+m*.5;for(var i=0;i<W.length;i++){f.fillText(W[i],t,e);e+=m}}}if(this.getEncoding()===a.PlainText){K();f.fillStyle=this.getTextColor();f.strokeStyle=this.getBackgroundColor();f.lineWidth=3;var X=(v-S)*.5;var Y=(b-(k.length-W.length-1)*m)*.5;if(k.length==1){var Z=f.measureText(C);var $=Z.actualBoundingBoxDescent+Z.actualBoundingBoxAscent;f.textAlign="center";f.textBaseline="bottom";X=v*.5;Y=(b-2*w-$)*.5+$+l}for(var tt=0;tt<k.length;tt++){if(this.getStyle()===o.TextGlow){f.strokeText(k[tt],X,Y)}f.fillText(k[tt],X,Y);Y+=m}this._setBillboardTexture(p,j,z);document.body.removeChild(p)}else if(this.getEncoding()===a.HtmlText&&typeof i!="undefined"){K();var et=v-w*2;var it=b-w*2;et/=t;it/=t;d.width=et;d.height=it;d.scale=I;d.sandbox="allow-same-origin";l/=t;u.body.style.width=et-2*l+"px";u.body.style.height=it-2*l+"px";u.body.style.margin=0;u.body.style.padding=l+"px";var rt=document.createElement("canvas");rt.style.width=et+"px";rt.style.height=it+"px";rt.width=et*t;rt.height=it*t;var at=rt.getContext("2d");at.scale(t,t);i(u.documentElement,{canvas:rt,backgroundColor:null,width:et,height:it}).then(function(t){if(t.width>0&&t.height>0){var e=p.getContext("2d");e.scale(I,I);e.drawImage(t,w,w)}setTimeout(this._setBillboardTexture.bind(this,p,j,z),0);document.body.removeChild(d);document.body.removeChild(p)}.bind(this))}else{document.body.removeChild(p)}};d.prototype._setBillboardTexture=function(t,i,r){var a=i/t.width,o=r/t.height;this._billboard.geometry=new e.PlaneGeometry(1,1).setAttribute("uv",new e.Float32BufferAttribute([0,1,a,1,0,1-o,a,1-o],2));var n=new e.CanvasTexture(t);n.magFilter=e.NearestFilter;this._billboard.material.map=n;this._billboard.material.needsUpdate=true;this._billboard.material.visible=true};var u=new e.Vector4,p=new e.Vector3,c=new e.Vector3,g=new e.Vector3,y=new e.Quaternion,f=new e.Vector3;d.prototype._updateTexture=function(){this._width=this.getWidth();this._height=this.getHeight();if(this.getText()&&!this.getTexture()){this._renderText(window.devicePixelRatio)}};d.prototype._update=function(t,i,a){var o=this.getNode();if(!o||!o.visible){return}if(this._needUpdateTexture){this._needUpdateTexture=false;this._updateTexture()}o.matrix.copy(o.parent.matrixWorld).invert();o.matrix.decompose(o.position,o.quaternion,o.scale);o.matrixWorld.identity();var n=this._billboard;var l=this.getPosition();var h=n.position;var s=1;if(l){h.copy(l)}else{h.setScalar(0)}n.quaternion.copy(i.quaternion);var d=this.getCoordinateSpace();if(d===r.Screen){var g=e.MathUtils.lerp(i.near,i.far,1e-4);s=(i.isPerspectiveCamera?2*g:2)/i.projectionMatrix.elements[5];h.set(h.x*s,h.y*s,-g).applyMatrix4(i.matrixWorld);s*=2}else if(d===r.Viewport){if(a.x>a.y){h.x*=a.y/a.x}else{h.y*=a.x/a.y}h.z=-.9999;h.unproject(i);u.copy(h).applyMatrix4(i.matrixWorldInverse).applyMatrix4(i.projectionMatrix);var y=u.x/u.w*.5*a.x,f=u.y/u.w*.5*a.y;s=u.w*2/(a.x*i.projectionMatrix.elements[0]);p.setFromMatrixColumn(i.matrixWorld,0).multiplyScalar(s*(Math.round(y)-y));c.setFromMatrixColumn(i.matrixWorld,1).multiplyScalar(s*(Math.round(f)-f));h.add(p).add(c)}n.scale.set((this._width>=0?this._width:.5*a.x/a.y)*s,(this._height>=0?this._height:.5)*s,1);n.updateMatrix();n.updateMatrixWorld()};d.prototype._ortho2DUpdate=function(t,e){if(!this.visible){return}var i=this.userData.originalTransform;var r=e.near*1.0001;if(Math.abs(i.q.w-1)>.001){r=Math.min(r+e.near*i.s.length()*.5,(e.near+e.far)*.5)}this.position.copy(i.p).multiplyScalar(2/e.projectionMatrix.elements[5]);this.position.z=-1;this.position.multiplyScalar(r).applyMatrix4(e.matrixWorld);y.copy(e.quaternion).multiply(i.q);this.quaternion.copy(y);this.scale.copy(i.s).multiplyScalar(r*.5);this.scale.z=Math.min(r-e.near,this.scale.z*.001);this.matrixWorld.compose(this.position,this.quaternion,this.scale);this.matrix.copy(this.parent.matrixWorld).invert().multiply(this.matrixWorld);this.matrix.decompose(this.position,this.quaternion,this.scale);this.updateMatrixWorld(true)};d.prototype._billboardViewUpdate=function(t,i,r,a){if(!this.visible){return}this.parent.matrixWorld.decompose(g,y,f);y.invert().multiply(i.quaternion);this.quaternion.copy(y);if(this._vkGetNodeContentType()===s.Symbol){if(a===undefined){var o=(new e.Vector3).setFromMatrixColumn(i.matrixWorld,2);this._vkSetOpacity(Math.max(o.dot(this.userData.direction),0)*.8+.2)}u.copy(this.getWorldPosition(g));u.applyMatrix4(i.matrixWorldInverse).applyMatrix4(i.projectionMatrix);var n=u.w*2/(t.getSize(new e.Vector2).x*i.projectionMatrix.elements[0]);this.scale.setScalar(n);if(!this.userData._symbolCenterFixed){if(!this.userData.boundingBox||this.userData.boundingBox.isEmpty()){this._vkCalculateObjectOrientedBoundingBox();if(this.userData.boundingBox.isEmpty()){return}}var l=this.userData.boundingBox.getCenter(new e.Vector3).multiplyScalar(-1);this.traverse(function(t){if(t.geometry){t.position.add(l);t.updateMatrix()}});this._vkCalculateObjectOrientedBoundingBox();this.userData._symbolCenterFixed=true}}this.updateMatrix();this.updateMatrixWorld()};d.prototype._lockToViewportUpdate=function(t,e){var i=0;this.children.forEach(function(t){if(t.visible&&Math.abs(t.quaternion.w-1)>.001){i=Math.max(i,t.scale.length())}});var r=Math.min(e.near*(1.0001+i*.5),(e.near+e.far)*.5);this.position.setFromMatrixColumn(e.matrixWorld,2).multiplyScalar(-r);this.position.add(e.position);this.scale.setScalar(r*2/e.projectionMatrix.elements[5]);this.matrixWorld.compose(this.position,e.quaternion,this.scale);this.matrix.copy(this.parent.matrixWorld).invert().multiply(this.matrixWorld);this.matrix.decompose(this.position,this.quaternion,this.scale);this.updateMatrixWorld(true)};return d});