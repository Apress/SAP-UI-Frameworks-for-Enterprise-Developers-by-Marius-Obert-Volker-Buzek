/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../Scene","./NodeHierarchy","../RenderMode","../thirdparty/three","../thirdparty/BufferGeometryUtils","./ThreeExtensions","./ThreeUtils","sap/base/util/uid"],function(e,t,r,i,a,n,o,s,l){"use strict";var u=t.extend("sap.ui.vk.threejs.Scene",{metadata:{library:"sap.ui.vk"},constructor:function(e){t.call(this);this._id=l();this._scene=e;this._sceneBuilder=null;this._defaultNodeHierarchy=null;this._currentViewStateManager=null;this._animationSequenceMap=new Map;this._initialView=null;this._materialMap=new Map;this._annotationMap=new Map}});u.prototype.init=function(){this._outlineColor=new a.Vector4(0,0,0,1);this._outlineMaterial=new a.ShaderMaterial({uniforms:{color:{value:this._outlineColor}},vertexShader:["attribute vec3 normal1;","attribute vec3 normal2;","#include <clipping_planes_pars_vertex>","uniform vec4 color;","varying vec4 vColor;","void main() {","\t#include <begin_vertex>","\t#include <project_vertex>","\t#include <clipping_planes_vertex>","\tvec3 eyeDirection = mvPosition.xyz;","\tvec3 n1 = normalMatrix * normal1;","\tvec3 n2 = normalMatrix * normal2;","\tvColor = color;","\tvColor.a *= step(dot(eyeDirection, n1) * dot(eyeDirection, n2), 0.0);","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","varying vec4 vColor;","void main() {","\t#include <clipping_planes_fragment>","\tif (vColor.a < 0.01) discard;","\tgl_FragColor = vColor;","}"].join("\n"),depthWrite:false,depthFunc:a.LessEqualDepth,polygonOffset:true,polygonOffsetFactor:-4,blending:a.NormalBlending,clipping:true});this._solidWhiteMaterial=new a.MeshBasicMaterial({color:16777215})};u.prototype.clearThreeScene=function(){if(!this._scene){return}var e=[];var t=[];s.getAllTHREENodes([this._scene],e,t);var r=this._scene.userData;if(r.geometryClusters){e=e.concat(r.geometryClusters);delete r.geometryClusters}if(r.currentClusters){r.currentClusters.clear()}r.instanceDataTexture=null;r.currentInstanceIndex=0;var i=new Map;var n=new Map;e.forEach(function(e){if(e instanceof a.Mesh){if(!i.has(e.geometry.uuid)){s.disposeGeometry(e);i.set(e.geometry.uuid,true)}if(e.material){if(!n.has(e.material.uuid)){s.disposeMaterial(e.material);n.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!n.has(e.userData.originalMaterial.uuid)){s.disposeMaterial(e.userData.originalMaterial);n.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});t.forEach(function(e){e.parent.remove(e)});i.clear();n.clear()};u.prototype.destroy=function(){this.clearThreeScene();if(this._defaultNodeHierarchy){this._defaultNodeHierarchy.destroy();this._defaultNodeHierarchy=null}s.disposeMaterial(this._solidWhiteMaterial);s.disposeMaterial(this._outlineMaterial);this._sceneBuilder=null;this._scene=null;this._currentViewStateManager=null;this._animationSequenceMap.clear();this._materialMap.clear();t.prototype.destroy.call(this)};u.prototype.setDoubleSided=function(e){this.setProperty("doubleSided",e,true);this._scene.traverse(function(t){if(t.material!==undefined){var r=t.userData;var i=a.FrontSide;var n;if(r.originalMaterial){if(r.originalMaterial.userData===undefined){r.originalMaterial.userData={}}n=r.originalMaterial.userData;if(n.originalMaterialSide===undefined){n.originalMaterialSide=r.originalMaterial.side}i=n.originalMaterialSide}else{if(t.material.userData===undefined){t.material.userData={}}n=t.material.userData;if(n.originalMaterialSide===undefined){n.originalMaterialSide=t.material.side}i=n.originalMaterialSide}t.material.side=e?a.DoubleSide:i}});return this};u.prototype.setViewStateManager=function(e){this._currentViewStateManager=e;return this};u.prototype.getViewStateManager=function(){return this._currentViewStateManager};u.prototype.getId=function(){return this._id};u.prototype.getDefaultNodeHierarchy=function(){if(!this._defaultNodeHierarchy){this._defaultNodeHierarchy=new r(this)}return this._defaultNodeHierarchy};u.prototype._computeBoundingBox=function(e,t,r){var i=new a.Box3;if(this._scene){var n=this._scene.userData;var o=n.geometryClusters;if(e&&o&&o.length>100){var s;for(var l=0,u=o.length;l<u;++l){s=o[l].geometry.boundingBox;if(s){i.union(s)}}}else{this._scene._expandBoundingBox(i,e,t,r)}}return i};u.prototype.getSceneRef=function(){return this._scene};u.prototype.setSceneBuilder=function(e){this._sceneBuilder=e};u.prototype.getSceneBuilder=function(){return this._sceneBuilder};u.prototype.nodeRefToPersistentId=function(e){return Array.isArray(e)?e.map(function(e){return e._vkPersistentId()}):e._vkPersistentId()};u.prototype.persistentIdToNodeRef=function(e){var t=this._sceneBuilder;if(Array.isArray(e)){return e.map(function(e){return t?t.getNode(e):null})}else{return t?t.getNode(e):null}};u.prototype.setNodePersistentId=function(e,t,r){return this._sceneBuilder?this._sceneBuilder.setNodePersistentId(e,t,r):false};u.prototype._addAnnotation=function(e,t){this._annotationMap.set(e,t)};u.prototype._hasAnnotation=function(e){return this._annotationMap.has(e)};u.prototype._getAnnotations=function(){return this._annotationMap};u.prototype._removeAnnotationsForNode=function(e){this._annotationMap.forEach(function(t){if(t.node===e){this._annotationMap.delete(t.annotation.id)}},this)};u.prototype.setAnnotationPersistentId=function(e,t,r){var i=this._annotationMap.get(e.id);if(i){this._annotationMap.delete(e.id);i.annotation.id=t;this._annotationMap.set(t,i);return true}return false};u.prototype.enumerateMaterials=function(){if(!this._defaultNodeHierarchy){return[]}var e=this._defaultNodeHierarchy.createNodeProxy(this._scene);if(e){return e.enumerateMaterials(true)}else{return[]}};var f=0;function c(e,t){var r=e.x-t.x;if(r<-f){return true}if(r>f){return false}var i=e.y-t.y;if(i<-f){return true}if(i>f){return false}return e.z-t.z<-f}function d(e,t,r){if(t<r){var i=p(e,t,r);d(e,t,i-1);d(e,i+1,r)}return e}function p(e,t,r){var i=e[r],a=t;for(var n=t;n<r;n++){if(c(e[n],i)){h(e,n,a);a++}}h(e,r,a);return a}function h(e,t,r){if(t!=r){var i=e[t];e[t]=e[r];e[r]=i}}function v(e,t){var r=new a.BufferGeometry;Object.setPrototypeOf(r,v.prototype);r.type="OutlineGeometry";var i=e&&e.isBufferGeometry&&e.getAttribute("position");if(!i||!e.index){return}e.computeBoundingBox();var n=new a.Vector3;e.boundingBox.getSize(n);f=Math.max(n.x,n.y,n.z)*1e-4;var o=i.count;var s=e.index.array;var l=s.length;if(o===0||l<3){return}var u,p,h,y;var M=new Array(o);for(u=0;u<o;u++){M[u]=(new a.Vector3).fromArray(i.array,u*i.itemSize);M[u].index=u}d(M,0,M.length-1);var m=[],_=[];m.push(M[0]);_[M[0].index]=m.length-1;for(u=1;u<o;u++){if(c(m[m.length-1],M[u])){m.push(M[u])}_[M[u].index]=m.length-1}var g=[];for(h=0;h<l;h+=3){var x=_[s[h]];var b=_[s[h+1]];var w=_[s[h+2]];if(x!==b&&b!==w&&w!==x){g.push(x,b,w)}}s=g;M=m;l=s.length;var B={},S;var D=new a.Vector3,A=new a.Vector3,N=new a.Vector3;var I=new Array(l/3);for(h=0,y=0;h<l;h+=3,y++){A.copy(M[s[h+1]]).sub(M[s[h]]);N.copy(M[s[h+2]]).sub(M[s[h]]);I[y]=(new a.Vector3).crossVectors(A,N).normalize();for(u=0,p=2;u<3;p=u++){var V=s[h+p];var C=s[h+u];S=Math.min(V,C)+","+Math.max(V,C);if(B[S]===undefined){B[S]={index1:V,index2:C,face1:y,face2:undefined}}else{B[S].face2=y}}}var O=Math.cos(a.MathUtils.DEG2RAD*(t!==undefined?t:1));var k=[];var z=[];var G=[];for(S in B){var H=B[S];if(H.face2===undefined||I[H.face1].dot(I[H.face2])<=O&&D.copy(M[H.index2]).sub(M[H.index1]).cross(I[H.face1]).dot(I[H.face2])>0){var E=M[H.index1];k.push(E.x,E.y,E.z);E=M[H.index2];k.push(E.x,E.y,E.z);var P=I[H.face1];z.push(P.x,P.y,P.z);z.push(P.x,P.y,P.z);if(H.face2!==undefined){var T=I[H.face2];G.push(T.x,T.y,T.z);G.push(T.x,T.y,T.z)}else{G.push(0,0,0);G.push(0,0,0)}}}r.setAttribute("position",new a.Float32BufferAttribute(k,3));r.setAttribute("normal1",new a.Float32BufferAttribute(z,3));r.setAttribute("normal2",new a.Float32BufferAttribute(G,3));return r}v.prototype=Object.create(a.BufferGeometry.prototype);v.prototype.constructor=v;function y(e){return e===null||e.min.x>=e.max.x&&e.min.y>=e.max.y&&e.min.z>=e.max.z}function M(e){var t=e&&e.geometry;var r=t&&t.isBufferGeometry&&t.getAttribute("position");if(!r){return null}var i=e.userData.renderGroup;if(i){var n=t.getAttribute("position").array;var o=t.getIndex().array;var s=i.firstVertex;var l=i.start;var u=i.count;var f=new Uint16Array(u);for(var c=0;c<u;++c){f[c]=o[l+c]-s}t=new a.BufferGeometry;t.setAttribute("position",new a.BufferAttribute(n.subarray(s*3,i.lastVertex*3),3));t.setIndex(new a.BufferAttribute(f,1))}else{t=t.clone()}if(!t.index){var d=[];for(var p=0,h=r.count;p<h;p++){d.push(p)}t.setIndex(d)}return t}function m(e){var t=null;if(e.isMesh&&!y(e.geometry.boundingBox)&&!e.userData.skipIt){var r=M(e);if(r){t=r}}for(var i=0,a=e.children.length;i<a;i++){var o=e.children[i];if(o.isMesh&&!y(o.geometry.boundingBox)&&o.userData.skipIt){var s=M(o);if(s){o.updateMatrix();s.applyMatrix4(o.matrix);t=t?n.mergeBufferGeometries([t,s]):s}}}return t}function _(e,t){var r=e.userData;if(r.defaultMaterial===undefined){r.defaultMaterial=r.originalMaterial||e.material}e.material=t;r.originalMaterial=null;e._vkUpdateMaterialColor();e._vkUpdateMaterialOpacity()}function g(e){var t=e.userData;if(t.defaultMaterial){e.material=t.defaultMaterial;delete t.defaultMaterial;t.originalMaterial=null;e._vkUpdateMaterialColor();e._vkUpdateMaterialOpacity()}}u.prototype._createOutlineGeometry=function(t){if(this._scene){this._scene._vkTraverseMeshNodes(function(r){if(r.isOutline){r.visible=true}else{if(!r.hasOutline){try{var n=m(r);if(n!==null){r.hasOutline=true;var o=new v(n);var s=o.getAttribute("position");if(s&&s.count>0){o.boundingBox=new a.Box3;var l=new a.LineSegments(o,this._outlineMaterial);l.isOutline=true;l.renderOrder=r.renderOrder+.5;l.matrixWorldNeedsUpdate=true;r.add(l)}}}catch(t){e.error("Unable to create outline geometry for node "+r.name,t)}}if(r.isMesh&&r.material&&!r.material.isLineBasicMaterial&&!r.material.isLineMaterial){switch(t){case i.LineIllustration:_(r,this._solidWhiteMaterial);break;case i.ShadedIllustration:var u=(r.userData.defaultMaterial||r.userData.originalMaterial||r.material).clone();if(u.emissive){u.color.multiplyScalar(.5);u.emissive.multiplyScalar(.5).addScalar(.5)}else{u.color.multiplyScalar(.5).addScalar(.5)}_(r,u);break;default:g(r);break}}}}.bind(this))}};u.prototype._hideOutlineGeometry=function(){if(this._scene){this._scene._vkTraverseMeshNodes(function(e){if(e.isOutline){e.visible=false}if(e.isMesh){g(e)}})}};u.prototype.getInitialView=function(){return this._initialView};u.prototype.setInitialView=function(e){this._initialView=e};u.prototype.getMaterial=function(e){return this._materialMap.get(e)};u.prototype.setMaterial=function(e,t){this._materialMap.set(e,t)};u.prototype.clearMaterials=function(){this._materialMap.forEach(function(e,t){e.destroy()});this._materialMap.clear()};u.prototype._getNativeMaterial=function(e){var t=e?this._materialMap.get(e):null;return t?t.getMaterialRef():null};u.prototype._setNodeMaterial=function(e,t){var r=this._getNativeMaterial(t);e.children.forEach(function(e){if(e.material){if(r){if(e.userData.materialId!==t){this._sceneBuilder._setSubmeshMaterial(e,r,t)}}else{var i=e.userData.initialMaterialId;if(i&&e.userData.materialId!==i){var a=this._getNativeMaterial(i);if(a){this._sceneBuilder._setSubmeshMaterial(e,a,i)}}}}}.bind(this))};return u});