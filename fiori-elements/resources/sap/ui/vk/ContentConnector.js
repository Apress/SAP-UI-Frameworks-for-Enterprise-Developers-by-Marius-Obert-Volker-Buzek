/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/base/Object","sap/ui/base/ManagedObjectObserver","sap/ui/core/Element","./Messages","./getResourceBundle","./ContentResource","./Core","sap/base/Log"],function(e,t,n,a,s,r,o,i,u){"use strict";var c=a.prototype;var l=a.extend("sap.ui.vk.ContentConnector",{metadata:{library:"sap.ui.vk",aggregations:{contentResources:{type:"sap.ui.vk.ContentResource",bindable:"bindable"},viewStateManagers:{type:"sap.ui.vk.ViewStateManagerBase"},defaultViewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false,visibility:"hidden"},contentManagers:{type:"sap.ui.vk.ContentManager",visibility:"hidden"}},defaultAggregation:"contentResources",events:{contentChangesStarted:{parameters:{}},contentChangesFinished:{parameters:{content:{type:"any"},failureReason:{type:"any"}}},contentChangesProgress:{parameters:{phase:{type:"string"},percentage:{type:"float"},source:{type:"any"}}},contentLoadingFinished:{parameters:{source:{type:"any"},node:{type:"any"}}},contentReplaced:{parameters:{newContent:{type:"any"},oldContent:{type:"any"}}},contentDestroying:{parameters:{content:{type:"any"},preventGarbageCollection:{type:"function"}}}}},constructor:function(e,t){this._inLoading=false;this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdateTimerId=null;this._content=null;this._contentManager=null;this._decryptionHandler=null;this._authorizationHandler=null;this._retryCount=1;c.constructor.apply(this,arguments);i.observeLifetime(this)}});l.prototype.isTreeBinding=function(e){return e==="contentResources"};l.prototype.init=function(){if(c.init){c.init.call(this)}this._selfObserver=new n(this._observeChanges.bind(this));this._selfObserver.observe(this,{aggregations:["contentResources","viewStateManagers"]})};l.prototype.destroy=function(){l._cleanAssociatedLoaders();this._selfObserver.disconnect();this._selfObserver=null;if(this._scheduleContentResourcesUpdateTimerId){clearTimeout(this._scheduleContentResourcesUpdateTimerId);this._scheduleContentResourcesUpdateTimerId=null}this._delayContentResourcesUpdate=false;this._setContent(null,null);c.destroy.call(this)};l.prototype._observeChanges=function(e){if(e.name==="contentResources"){this._scheduleContentResourcesUpdate()}else if(e.name==="viewStateManagers"){if(e.mutation==="insert"){e.child.setContentConnector(this)}else if(e.mutation==="remove"){e.child.setContentConnector(null)}}};l.prototype.invalidate=function(e){if(e instanceof o){this._scheduleContentResourcesUpdate();return}c.invalidate.apply(this,arguments)};l.prototype._scheduleContentResourcesUpdate=function(){if(this._inLoading){this._delayContentResourcesUpdate=true;return this}if(!this._scheduleContentResourcesUpdateTimerId){this._scheduleContentResourcesUpdateTimerId=setTimeout(function(){this._scheduleContentResourcesUpdateTimerId=null;var e=this.getContentResources();if(e.length>0){this._collectContentResourceSourceTypeInformation(e).then(function(t){if(t.dimensions.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:r().getText(s.VIT17.cause)}});u.error(r().getText(s.VIT17.summary),s.VIT17.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(t.contentManagerClassNames.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:r().getText(s.VIT35.cause)}});u.error(r().getText(s.VIT35.summary),s.VIT35.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(t.contentManagerClassNames.length===0){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:r().getText(s.VIT36.cause)}});u.error(r().getText(s.VIT36.summary),s.VIT36.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(t.contentManagerClassNames.length===1){var n=this;this._getContentManagerByClassName(t.contentManagerClassNames[0]).then(function(t){if(n._contentManager&&t!==n._contentManager){n.fireContentChangesStarted();n._setContent(null,null);n.fireContentChangesFinished({content:null})}t.loadContent(n._content,e)})}}.bind(this))}else{setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null})}.bind(this),0)}}.bind(this),0)}return this};l.prototype._handleContentChangesStarted=function(e){this._inLoading=true;this.fireContentChangesStarted()};l.prototype._handleContentChangesFinished=function(e){var t=e.getParameter("content");this._setContent(t,e.getSource());this.fireContentChangesFinished({content:t,failureReason:e.getParameter("failureReason")});this._inLoading=false;if(this._delayContentResourcesUpdate){this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdate()}};l.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};l.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};l.prototype._getContentManagerByClassName=function(e){var t;var n=this.getAggregation("contentManagers",[]);for(var a=0,s=n.length;a<s;++a){t=n[a];if(t.getMetadata().getName()===e){return Promise.resolve(t)}}var r=this;return new Promise(function(t,n){sap.ui.require([e.replace(/\./g,"/")],function(e){var n=new e;r.addAggregation("contentManagers",n);n.attachContentChangesStarted(r._handleContentChangesStarted,r);n.attachContentChangesFinished(r._handleContentChangesFinished,r);n.attachContentChangesProgress(r._handleContentChangesProgress,r);n.attachContentLoadingFinished(r._handleContentLoadingFinished,r);r._assignDecryptionHandler([n]);r._assignAuthorizationHandler([n]);r._assignRetryCount([n]);t(n)})})};l.prototype.getContent=function(){return this._content};l.prototype.getContentManager=function(){return this._contentManager};l.prototype.getDefaultViewStateManager=function(){return this.getAggregation("defaultViewStateManager")};l.prototype._assignDecryptionHandler=function(e){for(var t=0;t<e.length;t++){e[t].setDecryptionHandler(this._decryptionHandler)}};l.prototype._assignAuthorizationHandler=function(e){for(var t=0;t<e.length;t++){e[t].setAuthorizationHandler(this._authorizationHandler)}};l.prototype._assignRetryCount=function(e){for(var t=0;t<e.length;t++){e[t].setRetryCount(this._retryCount)}};l.prototype.setDecryptionHandler=function(e){this._decryptionHandler=e;this._assignDecryptionHandler(this.getAggregation("contentManagers",[]));return this};l.prototype.setAuthorizationHandler=function(e){this._authorizationHandler=e;this._assignAuthorizationHandler(this.getAggregation("contentManagers",[]));return this};l.prototype.setRetryCount=function(e){this._retryCount=Math.max(e,0);this._assignRetryCount(this.getAggregation("contentManagers",[]));return this};l.prototype._setContent=function(t,n){var a=this._content;var s=this._contentManager;if(a!==t){this._content=t;this._contentManager=n;this.destroyAggregation("defaultViewStateManager");if(n){var r=n.getMetadata().getName();var o;if(r==="sap.ui.vk.threejs.ContentManager"){o="sap.ui.vk.threejs.ViewStateManager"}else if(r==="sap.ui.vk.dvl.ContentManager"){o="sap.ui.vk.dvl.ViewStateManager"}else if(r==="sap.ui.vk.svg.ContentManager"){o="sap.ui.vk.svg.ViewStateManager"}if(o){var i=e.get(o);var u=new i(this.getId()+"-defaultviewstatemanager",{contentConnector:this});this.setAggregation("defaultViewStateManager",u)}}this.fireContentReplaced({oldContent:a,newContent:t});if(a){var c=false;this.fireContentDestroying({content:a,preventGarbageCollection:function(e){c=e}});s.destroyContent(a);if(!c){s.collectGarbage()}}}return this};var g=[{pattern:/(^threejs[:.])|(^(threejs|stream|vds4)$)/,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"},{pattern:/^vdsl?$/,dimension:3,contentManagerClassName:"sap.ui.vk.dvl.ContentManager"},{pattern:/^(png|jpg|jpeg|gif|bmp|tiff?|svg)$/,dimension:2,contentManagerClassName:"sap.ui.vk.ImageContentManager"},{pattern:/^(stream2d|vds4-2d)$/,dimension:2,contentManagerClassName:"sap.ui.vk.svg.ContentManager"}];var h=function(e){return new Promise(function(t,n){var a=g.slice();var s=function(r){if(r>=a.length){n();return}var o=a[r];(function(){var t=e.getSourceType();if(t){t=t.toLowerCase()}if(typeof o==="function"){return o(e)}else if(typeof o.pattern==="string"){var n=o.pattern.toLowerCase();if(n===t){return Promise.resolve(o)}}else if(o.pattern instanceof RegExp){if(o.pattern.test(t)){return Promise.resolve(o)}}return Promise.reject()})().then(function(e){t({dimension:e.dimension,contentManagerClassName:e.contentManagerClassName,settings:e.settings})},function(){s(r+1)})};s(0)})};l.addContentManagerResolver=function(e){if(typeof e==="function"){g.unshift(e)}else{g.unshift({pattern:e.pattern,dimension:e.dimension,contentManagerClassName:e.contentManagerClassName,settings:e.settings})}return this};l.removeAllContentManagerResolvers=function(){g=[];return this};l.removeContentManagerResolver=function(e){var t=typeof e==="function",n=typeof e==="string",a=e instanceof RegExp,s=typeof e==="object"&&!a;for(var r=0,o=g.length;r<o;++r){if(t&&g[r]===e){g.splice(r,1);return true}else if(typeof g[r]==="object"){if(s){if(e.pattern&&g[r].pattern===e.pattern){g.splice(r,1);return true}}else if(a){if(g[r].pattern.source===e.source){g.splice(r,1);return true}}else if(n){if(g[r].pattern instanceof RegExp){if(g[r].pattern.source===e){g.splice(r,1);return true}}else if(g[r].pattern===e){g.splice(r,1);return true}}}}return false};l._cleanAssociatedLoaders=function(){for(var e=0,t=g.length;e<t;++e){var n=g[e];if(n.settings&&n.settings.loader&&n.settings.loader.exit){n.settings.loader.exit()}}};l.prototype._collectContentResourceSourceTypeInformation=function(e){var t=false;var n=false;var a={};var s={};var r=[];e.forEach(function e(t){r.push(t);t.getContentResources().forEach(e)});return Promise.all(r.map(function(e){return h(e).then(function(e){a[e.dimension]=true;s[e.contentManagerClassName]=true;return e},function(){if(e.getSourceType()){n=true}else{t=true}return false})})).then(function(e){for(var o=0,i=r.length;o<i;++o){if(e[o]){r[o]._contentManagerResolver=e[o]}}return{noSourceTypes:t,unknownSourceTypes:n,dimensions:Object.getOwnPropertyNames(a).sort(),contentManagerClassNames:Object.getOwnPropertyNames(s)}})};return l});