/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/core/Popup","sap/ui/core/ResizeHandler","sap/ui/core/delegate/ScrollEnablement","sap/ui/Device","sap/m/library","sap/m/Label","sap/m/OverflowToolbar","sap/m/OverflowToolbarButton","sap/m/Button","sap/m/OverflowToolbarToggleButton","sap/m/ToggleButton","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/ToolbarSpacer","sap/m/OverflowToolbarLayoutData","./ContainerBaseRenderer","./MapContainerButtonType","./getResourceBundle","sap/base/util/uid","sap/base/Log"],function(t,e,n,o,i,s,a,r,l,u,c,h,p,d,g,f,S,_,C,m,y,v,b){"use strict";var B=e.extend("sap.ui.vk.ContainerBase",{metadata:{library:"sap.ui.vk",properties:{showFullScreen:{type:"boolean",group:"Misc",defaultValue:true},showSettings:{type:"boolean",group:"Misc",defaultValue:true},showSelection:{type:"boolean",group:"Misc",defaultValue:true},fullScreen:{type:"boolean",group:"Misc",defaultValue:false},title:{type:"string",group:"Misc",defaultValue:""},autoAdjustHeight:{type:"boolean",group:"Misc",defaultValue:false}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.vk.ContainerContent",multiple:true,singularName:"content"},toolbar:{type:"sap.m.Toolbar",multiple:false,visibility:"hidden"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{contentChange:{parameters:{selectedItemId:"string"}},settingsPressed:{}}}});B.prototype.switchContent=function(t){this.setSelectedContent(t);this.rerender()};B.prototype.updateContainer=function(){this._contentChanged=true;this.rerender()};B.prototype.setSelectedContent=function(t){this._oSelectedContent=t};B.prototype.getSelectedContent=function(){return this._oSelectedContent};B.prototype.init=function(){this._selectionState="SINGLE";this._firstTime=true;this._aContentIcons=[];this._selectedContent=null;this._oSelectedContent=null;this._bSegmentedButtonSaveSelectState=false;this._oMenu=null;this._customButtons=[];var t=new _({priority:sap.m.OverflowToolbarPriority.High});var e=sap.m.ButtonType.Transparent;this._oFullScreenButton=new c({layoutData:t,type:e,icon:"sap-icon://full-screen",text:y().getText("CONTAINERBASE_FULLSCREEN"),tooltip:y().getText("CONTAINERBASE_FULLSCREEN"),press:function(){this._bSegmentedButtonSaveSelectState=true;this._toggleFullScreen()}.bind(this)});this._oSettingsButton=new c({layoutData:t.clone(),type:e,icon:"sap-icon://action-settings",text:y().getText("CONTAINERBASE_SETTINGS"),tooltip:y().getText("CONTAINERBASE_SETTINGS"),press:function(){this._bSegmentedButtonSaveSelectState=true;this.fireSettingsPressed()}.bind(this)});this._oSelectionButtonSingle=new f({icon:"sap-icon://map-container/selection-single",tooltip:y().getText("CONTAINERBASE_MENU_SINGLE"),press:this._handleSelection.bind(this,"SINGLE")});this._oSelectionButtonRectangle=new f({icon:"sap-icon://map-container/selection-rectangle",tooltip:y().getText("CONTAINERBASE_MENU_RECT"),press:this._handleSelection.bind(this,"RECT")});this._oSelectionButtonLasso=new f({icon:"sap-icon://map-container/selection-lasso",tooltip:y().getText("CONTAINERBASE_MENU_LASSO"),press:this._handleSelection.bind(this,"LASSO")});this._selectionMenu=new g({items:[this._oSelectionButtonSingle,this._oSelectionButtonRectangle,this._oSelectionButtonLasso]});this._oPopup=new o({modal:true,shadow:false,autoClose:false});this._oContentSegmentedButton=new g({layoutData:t.clone(),select:this._onContentButtonSelect.bind(this)});this._oContTitle=new l;this._oToolbar=new u({width:"auto"}).addStyleClass("sapUiVkContainerBaseToolbar");this.setAggregation("toolbar",this._oToolbar);this.sResizeListenerId=null;if(a.system.desktop){this.sResizeListenerId=i.register(this,jQuery.proxy(this._performHeightChanges,this))}else{a.orientation.attachHandler(this._performHeightChanges,this);a.resize.attachHandler(this._performHeightChanges,this)}var s=[{name:"selection-lasso",unicode:"E000"},{name:"selection-rectangle",unicode:"E001"},{name:"selection-single",unicode:"E002"}],r="map-container",h="map-container";s.forEach(function(t){n.addIcon(t.name,r,h,t.unicode)})};B.prototype.exit=function(){if(this._oFullScreenButton){this._oFullScreenButton.destroy();this._oFullScreenButton=undefined}if(this._oPopup){this._oPopup.destroy();this._oPopup=undefined}if(this._oContentSegmentedButton){this._oContentSegmentedButton.destroy();this._oContentSegmentedButton=undefined}if(this._oSelectedContent){this._oSelectedContent.destroy();this._oSelectedContent=undefined}if(this._oToolbar){this._oToolbar.destroy();this._oToolbar=undefined}if(a.system.desktop&&this.sResizeListenerId){i.deregister(this.sResizeListenerId);this.sResizeListenerId=null}else{a.orientation.detachHandler(this._performHeightChanges,this);a.resize.detachHandler(this._performHeightChanges,this)}};B.prototype.setFullScreen=function(t){if(this._firstTime){return}if(this.getFullScreen()==t){return}var e=this.getProperty("fullScreen");if(e!==t){this._toggleFullScreen()}};B.prototype.onAfterRendering=function(){var t=this;if(this.sResizeListenerId===null&&a.system.desktop){this.sResizeListenerId=i.register(this,jQuery.proxy(this._performHeightChanges,this))}if(this.getAutoAdjustHeight()||this.getFullScreen()){setTimeout(function(){t._performHeightChanges()},500)}this._firstTime=false;if(this.getSelectedContent()!==null){var e=this.getSelectedContent().getContent();if(e instanceof sap.ui.vbm.GeoMap||e instanceof sap.ui.vbm.AnalyticMap){if(this.getShowSelection()){if(this._selectionState==="LASSO"){e.setLassoSelection(true)}else if(this._selectionState==="RECT"){e.setRectangularSelection(true)}else if(this._selectionState==="SINGLE"){e.setRectangularSelection(false);e.setLassoSelection(false)}}}}};B.prototype.onBeforeRendering=function(){var t=this;if(t._contentChanged){t._contentChange()}t._oToolbar.getContent().forEach(function(e){var n=e.getId();var o=e["getPressed"]?e.getPressed():null;for(var i in t._customButtons){if(t._customButtons[i].button&&t._customButtons[i].button.getId()==n){t._customButtons[i].toggled=o}}});t._oToolbar.removeAllContent();t._addToolbarContent()};B.prototype.setTitle=function(t){this._oContTitle.setText(t);this.setProperty("title",t,true)};B.prototype.addContent=function(t){this.addAggregation("content",t);this._contentChanged=true};B.prototype.insertContent=function(t,e){this.insertAggregation("content",t,e);this._contentChanged=true};B.prototype.updateContent=function(){this.updateAggregation("content");this._contentChanged=true};B.prototype._toggleFullScreen=function(){var t=this.getProperty("fullScreen");var e;var n;var o;if(t){this._closeFullScreen();this.setProperty("fullScreen",false,true);o=this.getSelectedContent().getContent();e=o.getId();o.setWidth("100%");n=this._contentHeight[e];if(n){o.setHeight(n)}this.invalidate()}else{var i=this.getAggregation("content");this._contentHeight={};if(i){for(var s=0;s<i.length;s++){o=i[s].getContent();e=o.getId();if(jQuery.isFunction(o.getHeight)){n=o.getHeight()}else{n=0}this._contentHeight[e]=n}}this._openFullScreen(true);this.setProperty("fullScreen",true,true)}var a=t?"sap-icon://full-screen":"sap-icon://exit-full-screen";this._oFullScreenButton.setIcon(a);this._oFullScreenButton.focus()};B.prototype._openFullScreen=function(t){if(t!==null&&t===true){this._oScrollEnablement=new s(this,this.getId()+"-wrapper",{horizontal:true,vertical:true})}this.$content=this.$();if(this.$content){this.$tempNode=jQuery("<div></div>");this.$content.before(this.$tempNode);this._$overlay=jQuery("<div id='"+v()+"'></div>");this._$overlay.addClass("sapUiVkContainerBaseOverlay");this._$overlay.append(this.$content);this._oPopup.setContent(this._$overlay)}else{b.warning("Overlay: content does not exist or contains more than one child")}this._oPopup.open(200,undefined,undefined,jQuery("body"))};B.prototype._closeFullScreen=function(){if(this._oScrollEnablement!==null){this._oScrollEnablement.destroy();this._oScrollEnablement=null}this.$tempNode.replaceWith(this.$content);this._oToolbar.setDesign(sap.m.ToolbarDesign.Auto);this._oPopup.close();this._$overlay.remove()};B.prototype._performHeightChanges=function(){if(this.getAutoAdjustHeight()||this.getFullScreen()){var t=this.$();if(t.find(".sapUiVkContainerBaseToolbarArea").children()[0]&&t.find(".sapUiVkContainerBaseContentArea").children()[0]){var e=this.getSelectedContent().getContent();if(e.getDomRef().offsetWidth!==this.getDomRef().clientWidth){this.rerender()}}}};B.prototype._switchContent=function(t){var e=this._findContentById(t);this.setSelectedContent(e);this.fireContentChange({selectedItemId:t});this.rerender()};B.prototype._contentChange=function(){var t=this.getContent();this._oContentSegmentedButton.removeAllButtons();this._destroyButtons(this._aContentIcons);this._aContentIcons=[];if(t.length===0){this._oContentSegmentedButton.removeAllButtons();this._setDefaultOnSegmentedButton();this.switchContent(null)}if(t){for(var e=0;e<t.length;e++){var n=t[e].getContent();if(n.setWidth){n.setWidth("100%")}var o=new f({icon:t[e].getIcon(),tooltip:t[e].getTitle(),key:n.getId()});this._aContentIcons.push(o);this._oContentSegmentedButton.addItem(o);if(e===0){this.setSelectedContent(t[e])}}}this._contentChanged=false};B.prototype._onContentButtonSelect=function(t){var e=t.getParameter("key");this._switchContent(e)};B.prototype._findContentById=function(t){var e=null;var n=this.getAggregation("content");if(n){for(var o=0;!e&&o<n.length;o++){if(n[o].getContent().getId()===t){e=n[o]}}}return e};B.prototype._addToolbarContent=function(){this._oToolbar.addContent(new S);if(this._aContentIcons.length>1){this._oToolbar.addContent(this._oContentSegmentedButton)}if(this.getSelectedContent()!==null){var t=this.getSelectedContent().getContent();if(t instanceof sap.ui.vbm.GeoMap||t instanceof sap.ui.vbm.AnalyticMap){if(this.getShowSelection()){this._oToolbar.addContent(this._selectionMenu)}}}this._customButtons.forEach(function(t){if(t.visible){var e={type:sap.m.ButtonType.Transparent,layoutData:new _({priority:sap.m.OverflowToolbarPriority.High})};if("active"in t){e.enabled=t.active}if("icon"in t){e.icon=t.icon}if("activeIcon"in t){e.activeIcon=t.activeIcon}if("text"in t){e.text=t.text}if("tooltip"in t){e.tooltip=t.tooltip}if("press"in t){e.press=t.press}switch(t.type){case m.Click:t.button=t.overflow?new c(e):new h(e);break;default:if("toggled"in t){e.pressed=t.toggled}t.button=t.overflow?new p(e):new d(e);break}this._oToolbar.addContent(t.button)}},this);if(this.getShowSettings()){this._oToolbar.addContent(this._oSettingsButton)}if(!a.system.phone&&this.getShowFullScreen()){this._oToolbar.addContent(this._oFullScreenButton)}};B.prototype._setDefaultOnSegmentedButton=function(){if(!this._bSegmentedButtonSaveSelectState){this._oContentSegmentedButton.setSelectedButton(null)}this._bSegmentedButtonSaveSelectState=false};B.prototype._destroyButtons=function(t){t.forEach(function(t){t.destroy()})};B.prototype._handleSelection=function(t){var e=this.getSelectedContent().getContent();if(e instanceof sap.ui.vbm.GeoMap||e instanceof sap.ui.vbm.AnalyticMap){if(t==="LASSO"){e.setLassoSelection(true);this._selectionState=t}else if(t==="RECT"){e.setRectangularSelection(true);this._selectionState=t}else if(t==="SINGLE"){e.setRectangularSelection(false);e.setLassoSelection(false);this._selectionState=t}}};return B});