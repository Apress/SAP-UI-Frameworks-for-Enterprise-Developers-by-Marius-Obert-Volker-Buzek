/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/export/ExportBase","sap/ui/export/ExportUtils","sap/ui/export/library","sap/ui/model/odata/v4/ODataModel","./ExportDialog","sap/m/BusyDialog"],function(e,t,r,o,i,n,a,s){"use strict";var u=r.extend("sap.ui.export.PortableDocument",{constructor:function(e,t){r.call(this,e,t);["paperSize","orientation","font","fontSize","doEnableAccessibility","fitToPage","signature","signatureReason","pdfArchive","showPageNumber"].forEach(function(t){if(typeof e[t]!=="undefined"){this._mSettings[t]=e[t]}}.bind(this))}});u.prototype.processDataSource=function(t){var r=null;var o=typeof t;if(!t){return null}if(o!="object"){e.error("Spreadsheet#processDataSource: Unable to apply data source of type "+o);return null}if(t.dataUrl&&t.serviceUrl){r=t}if(t.isA&&t.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){r=this.createDataSourceFromBinding(t)}return r};u.prototype.createDataSourceFromBinding=function(t){var r=null;if(t.isA(["sap.ui.model.ClientListBinding","sap.ui.model.ClientTreeBinding"])){e.error("Unable to create dataSource configuration due to not supported Binding: "+t.getMetadata().getName())}if(typeof t.getDownloadUrl==="function"){var i=t.getModel(),n=o.interceptUrl(t.getDownloadUrl("pdf")),a=o.interceptUrl(i.sServiceUrl),s=i.isA("sap.ui.model.odata.v4.ODataModel");var u=new URL(n,document.baseURI);u.hash="";this._oModel=i;u.search=u.search.split("&").filter(function(e){return e.indexOf("$format")==-1}).join("&");r={type:"odata",version:s?4:2,dataUrl:u.toString(),serviceUrl:this._resolveServiceUrl(a),headers:s?i.getHttpHeaders(true):i.getHeaders()}}return r};u.prototype._resolveServiceUrl=function(e){var t,r;e+=e.endsWith("/")?"":"/";t=/^[\./]/.test(e);r=this._mCapabilities.DocumentDescriptionReference;if(typeof r!=="string"){return e.split("/").slice(0,-5).join("/")+"/default/iwbep/common/0001/"}r=r.endsWith("/")?r:r.split("/").slice(0,-1).join("/")+"/";var o=new URL(e,document.baseURI);o=new URL(r,o.href);return t?o.pathname:o.href};u.prototype._createDocumentDescription=function(e){var t=e.workbook;var r,o;r={Title:t.context.title,Format:{PaperSize:e.paperSize,Orientation:e.orientation,FontSize:Number(e.fontSize),FitToPage:{IsEnabled:e.fitToPage,MinimumFontSize:4}},PDFStandard:{DoEnableAccessibility:e.doEnableAccessibility,UsePDFAConformance:e.pdfArchive},Signature:{DoSign:e.signature,Reason:e.signatureReason},CoverPage:[],TableColumns:[]};if(t.hierarchyLevel&&t.drillState){r.Hierarchy={DistanceFromRootElement:t.hierarchyLevel,DrillStateElement:t.drillState}}if(e.showPageNumber){r["Footer"]={Center:{Type:"PAGENUM"}}}o=t.context.metainfo;if(o instanceof Array){if(e.dataSource.version==2){o.forEach(function(e){e.items.forEach(function(t){var o={Title:e.name,Name:t.key,Value:t.value};r["CoverPage"].push(o)})})}else{o.forEach(function(e){var t={Title:e.name,Content:[]};e.items.forEach(function(e){t["Content"].push({Name:e.key,Value:e.value})});r["CoverPage"].push(t)})}}t.columns.filter(function(e,t,r){var o=Array.isArray(e.property)?e.property[0]:e.property;return r.findIndex(function(e){var t=Array.isArray(e.property)?e.property[0]:e.property;return o===t})===t}).forEach(function(e){r["TableColumns"].push({Name:Array.isArray(e.property)?e.property[0]:e.property,Header:e.label})});return r};u.prototype._getEntitySetName=function(e){var t,r;r=e&&e.version||2;if(this._mCapabilities&&typeof this._mCapabilities.DocumentDescriptionCollection==="string"){t=this._mCapabilities.DocumentDescriptionCollection}return t||(r==4?"MyDocumentDescriptions":"SAP__MyDocumentDescriptions")};u.prototype._getModel=function(e){var t=e.version||2;return t===4?new n({serviceUrl:e.serviceUrl,synchronizationMode:"None"}):this._oModel};u.prototype.setDefaultExportSettings=function(e){var r=e&&e.workbook&&e.workbook.context;if(!(r instanceof Object)){r=e.workbook.context={}}if(typeof r.title==="string"&&r.title){return Promise.resolve()}return t.getLibraryResourceBundle("sap.ui.export",true).then(function(e){r.title=e.getText("XLSX_DEFAULT_TITLE")})};u.prototype.postDocumentDescription=function(e,t){var r,o,i;o=this._getModel(t);i="/"+this._getEntitySetName(t);if(!o||!o.isA(["sap.ui.model.odata.v4.ODataModel","sap.ui.model.odata.v2.ODataModel"])){return Promise.reject("Unsupported Model")}return new Promise(function(t,n){if(o.isA("sap.ui.model.odata.v4.ODataModel")){r=o.bindList(i);r.attachCreateCompleted(function(e){var r=e.getParameter("success");if(r){t(e.getParameter("context").getObject()["Id"])}else{n()}});r.create(e)}else{var a=o.bUseBatch;o.setUseBatch(false);o.create(i,e,{success:function(e){o.setUseBatch(a);t(e["Id"])},error:function(e){o.setUseBatch(a);n(e)}})}})};u.prototype.createBuildPromise=function(e){var r=this;var n;var u;var c=t.getLibraryResourceBundle("sap.ui.export");u=new s("PDFExportBusyDialog",{title:c.getText("PROGRESS_TITLE"),text:c.getText("PDF_GENERATION_IN_PROGRESS"),showCancelButton:true,close:function(e){if(e.getParameter("cancelPressed")){r.cancel()}u.destroy();u=null}});n=r._createDocumentDescription(e);u.open();var l={rows:e.dataSource.count,cutOff:this._mCapabilities.ResultSizeDefault,fileType:i.FileType.PDF};var p=Promise.resolve();if(l.rows>l.cutOff){p=a.showWarningDialog(l)}return p.then(function(){return r.postDocumentDescription(n,e.dataSource)}).then(function(t){return u&&r.sendRequest(e.dataSource.dataUrl,t)}).then(function(t){o.saveAsFile(t,e.fileName)}).catch(function(e){if(!e){return}e.text().then(function(e){a.showErrorMessage(e)}).catch(function(){a.showErrorMessage(c.getText("PDF_GENERIC_ERROR"))})}).finally(function(){u&&u.close()})};u.prototype.sendRequest=function(e,t){return new Promise(function(r,o){var i=this.request=new XMLHttpRequest;i.open("GET",e);i.responseType="blob";i.setRequestHeader("Accept",this.getMimeType());i.setRequestHeader("SAP-Document-Description-Id",t);i.addEventListener("abort",function(){o(null)});i.addEventListener("error",function(){o("Error occured while requesting data")});i.addEventListener("load",function(){var e=i.status;if(e>=200&&e<400){r(i.response)}else{o(i.response)}});i.send()}.bind(this))};u.prototype.getMimeType=function(){return"application/pdf"};u.prototype.cancel=function(){if(this.request&&this.request.readyState!=XMLHttpRequest.DONE){this.request.abort();this.request=null}};u.prototype.destroy=function(){r.prototype.destroy.apply(this,arguments);this._oModel=null};return u});