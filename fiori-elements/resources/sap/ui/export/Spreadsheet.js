/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Core","./ExportDialog","sap/ui/export/ExportBase","sap/ui/Device","sap/ui/export/SpreadsheetExport","sap/base/Log","sap/ui/export/ExportUtils","sap/ui/export/library"],function(e,t,r,o,i,s,n,a){"use strict";var u="sap.ui.export.Spreadsheet";var c=r.extend(u,{constructor:function(e){r.call(this,e);this._mSettings.customizing={};this._mSettings.showProgress=true;this._mSettings.worker=true;["showProgress","worker"].forEach(function(t){if(typeof e[t]!=="undefined"){this._mSettings[t]=e[t]}}.bind(this));this.codeListsPromise=this.codeListsPromise instanceof Promise?this.codeListsPromise:Promise.resolve()}});function p(e,t,r){if(!(r[e]instanceof Object)){r[e]={}}if(!isNaN(t.digits)){r[e].scale=t.digits}if(!isNaN(t.UnitSpecificScale)){r[e].scale=t.UnitSpecificScale}if(isNaN(r[e].scale)){delete r[e]}}c.prototype.setDefaultExportSettings=function(t){var r,o,i;o=t.customizing.currency={};var s=e.getConfiguration().getFormatSettings().getCustomCurrencies();if(s){for(r in s){p(r,s[r],o)}}return this.codeListsPromise.then(function(e){var r,s,n;if(!Array.isArray(e)){return}i=t.customizing.unit={};r=e[0];s=e[1];for(n in r){p(n,r[n],o)}for(n in s){p(n,s[n],i)}}).then(function(){return e.getLibraryResourceBundle("sap.ui.export",true)}).then(function(e){var r=t.workbook.context;if(!(r instanceof Object)){r=t.workbook.context={}}if(!r.title){r.title=e.getText("XLSX_DEFAULT_TITLE")}if(!r.sheetName){r.sheetName=e.getText("XLSX_DEFAULT_SHEETNAME")}})};c.requestCodeLists=function(e){if(!e.isA(["sap.ui.model.odata.ODataMetaModel","sap.ui.model.odata.v4.ODataMetaModel"])){return Promise.resolve([null,null])}return Promise.all([e.requestCurrencyCodes(),e.requestUnitsOfMeasure()]).catch(function(e){s.warning(u+": Code lists cannot be processed due to the following error - "+e);return Promise.resolve([null,null])})};c.prototype.attachBeforeSave=function(e,t,r){return this.attachEvent("beforeSave",e,t,r)};c.prototype.detachBeforeSave=function(e,t){return this.detachEvent("beforeSave",e,t)};c.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null}return this};c.prototype.getMimeType=function(){return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};c.prototype.onprogress=function(e,t){var r;if(isNaN(e)||isNaN(t)){return}r=Math.round(e/t*100);s.debug("Spreadsheet export: "+r+"% loaded.")};c.prototype.createDataSourceFromBinding=function(e){var t=[];if(e.isA("sap.ui.model.ClientListBinding")){var r=[];e.getAllCurrentContexts().forEach(function(e){r.push(e.getObject())});t={data:r,type:"array"}}if(e.isA("sap.ui.model.ClientTreeBinding")){s.error("Unable to create dataSource configuration due to not supported Binding: "+e.getMetadata().getName())}if(typeof e.getDownloadUrl==="function"){var o=e.getModel(),i=e.getDownloadUrl("json"),a=o.sServiceUrl,u=o.isA("sap.ui.model.odata.v4.ODataModel");i=n.interceptUrl(i);a=n.interceptUrl(a);t={type:"odata",dataUrl:i,serviceUrl:a,headers:u?o.getHttpHeaders(true):o.getHeaders(),count:n.getCountFromBinding(e),useBatch:u||o.bUseBatch};if(o.getMetaModel()&&typeof o.getMetaModel().requestCurrencyCodes==="function"&&typeof o.getMetaModel().requestUnitsOfMeasure==="function"){this.codeListsPromise=c.requestCodeLists(o.getMetaModel(),this._mSettings)}}return t};c.prototype.processDataSource=function(e){var t=null;var r=typeof e;if(!e){return null}if(r=="string"){return{count:this._mSettings.count,dataUrl:e,type:"odata",useBatch:false}}if(r!="object"){s.error("Spreadsheet#processDataSource: Unable to apply data source of type "+r);return null}if(e instanceof Array){t={data:e,type:"array"}}if(e.dataUrl){t=e}if(e.isA&&e.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){t=this.createDataSourceFromBinding(e)}return t};c.prototype.createBuildPromise=function(e){var r=this;return new Promise(function(s,u){var c;var p=1048576;var f=o.system.desktop?2e6:1e5;var l=e.dataSource.type=="array"?e.dataSource.data.length:e.dataSource.count;var d=e.workbook.columns.length;function g(o){if(o.progress){if(c){c.updateStatus(o.fetched,o.total)}r.onprogress(o.fetched,o.total)}if(o.finished&&r.process!==null){r.process=null;if(!o.spreadsheet){u();return}var i=r.fireEvent("beforeSave",{data:o.spreadsheet,exportDialog:c},true,true);if(i){if(c){window.setTimeout(c.finish,1e3)}n.saveAsFile(new Blob([o.spreadsheet],{type:r.getMimeType()}),e.fileName)}s()}if(typeof o.error!="undefined"){var a=o.error.message||o.error;r.process=null;if(c){c.finish()}u(a);t.showErrorMessage(a)}}function h(){if(!e.showProgress){if(r.process){u("Cannot start export: the process is already running");return}r.process=i.execute(e,g);return}t.getProgressDialog().then(function(t){c=t;if(r.process){u("Cannot start export: the process is already running");return}c.oncancel=function(){return r.process&&r.process.cancel()};c.open();c.updateStatus(0,e.dataSource.count);r.process=i.execute(e,g)})}if(d<=0){u("No columns to export.")}else if(l*d>f||!l||l>=p){var m={rows:l,columns:d,sizeLimit:l*d>f,cutOff:p,fileType:a.FileType.XLSX};t.showWarningDialog(m).then(h).catch(function(){u("Export cancelled by the user.")})}else{h()}})};return c});