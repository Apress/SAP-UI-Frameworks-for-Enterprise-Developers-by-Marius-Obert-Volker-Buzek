/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/Container","sap/ui/mdc/valuehelp/base/DialogTab","sap/ui/mdc/util/loadModules","sap/ui/Device","sap/m/VBox","sap/m/FlexItemData","sap/ui/model/resource/ResourceModel","sap/ui/mdc/util/Common","sap/ui/mdc/enum/SelectType","sap/base/strings/formatMessage","sap/ui/core/library","sap/ui/core/InvisibleMessage"],function(e,t,n,i,o,a,r,s,l,u,p,h){"use strict";var d=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){d=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc")});var c,g,f,v,C,y;var _,m,b,I,T;var S=p.InvisibleMessageMode;var M=e.extend("sap.ui.mdc.valuehelp.Dialog",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContainer","sap.ui.core.PopupInterface"],properties:{_selectedContentKey:{type:"string",visibility:"hidden"},_quickSelectEnabled:{type:"boolean",visibility:"hidden",defaultValue:false},_selectableContents:{type:"object[]",visibility:"hidden",defaultValue:[]},groupConfig:{type:"object",defaultValue:{}}},defaultAggregation:"content"}});function k(){if(i.system.desktop){return"700px"}if(i.system.tablet){return i.orientation.landscape?"600px":"600px"}}function P(){if(i.system.desktop){return"1080px"}if(i.system.tablet){return i.orientation.landscape?"920px":"600px"}}function B(e){var t=this.getContent();return t.filter(function(t){return!!t.getVisible()&&t.getGroup&&t.getGroup()===e}).length>1}M.prototype._handleContentSelectionChange=function(e){this.fireRequestDelegateContent({container:this.getId(),contentId:e});return this._getRetrieveDelegateContentPromise().then(function(){var t=this.getProperty("_selectedContentKey");var n=this.getContent();var i=t&&n&&n.find(function(e){return e.getId()===t});if(i){if(i.setCollectiveSearchSelect){i.setCollectiveSearchSelect(undefined)}i.onHide();this._unbindContent(i)}return this._renderSelectedContent(e)}.bind(this))};M.prototype._onTabBarSelect=function(e){var t=e&&e.getParameter("key");this._handleContentSelectionChange(t)};M.prototype.invalidate=function(t){if(t){var n=this.getContent();var i=n.indexOf(t);if(this._oIconTabBar&&i!==-1&&!this._bIsBeingDestroyed){var o=this._oIconTabBar.getItems();if(o[i]){o[i].invalidate(t)}}else{e.prototype.invalidate.apply(this,arguments)}}};M.prototype._getUIAreaForContent=function(){var t=this.getAggregation("_container");if(t){return t.getUIArea()}return e.prototype._getUIAreaForContent.apply(this,arguments)};M.prototype._handleConfirmed=function(e){this.fireConfirm({close:true})};M.prototype._handleClosed=function(t){var n=this.getSelectedContent();if(n){n.onHide()}this.getContent().forEach(function(e){e.onContainerClose()});this.setProperty("_selectedContentKey",this._sInitialContentKey);e.prototype._handleClosed.apply(this,arguments)};M.prototype._getContainer=function(){if(!this.getModel("$i18n")){this.setModel(new r({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n")}var e=this.getAggregation("_container");if(!e){return this._retrievePromise("dialog",function(){return n(["sap/m/Dialog","sap/m/Button","sap/ui/model/base/ManagedObjectModel","sap/m/library"]).then(function(e){c=e[0];f=e[1];v=e[2];g=e[3];var t=g.ButtonType;if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc")}this.oButtonOK=new f(this.getId()+"-ok",{text:this._oResourceBundle.getText("valuehelp.OK"),enabled:"{$valueHelp>/_valid}",type:t.Emphasized,press:this._handleConfirmed.bind(this),visible:{parts:["$valueHelp>/_config/maxConditions","$help>/_quickSelectEnabled"],formatter:function(e,t){return e!==1||!t}}});this.oButtonCancel=new f(this.getId()+"-cancel",{text:this._oResourceBundle.getText("valuehelp.CANCEL"),press:this._handleCanceled.bind(this)});this._oManagedObjectModel=new v(this);var n=new c(this.getId()+"-dialog",{contentHeight:k(),contentWidth:P(),horizontalScrolling:false,verticalScrolling:false,title:{parts:["$help>/title","$help>/_selectableContents"],formatter:function(e,t){if(t&&t.length==1){var n=t[0];var i=n.getFormattedShortTitle()?n.getFormattedShortTitle():n.getTitle();if(i){e=this._oResourceBundle.getText("valuehelp.DIALOGSHORTTITLECOLONTITLE",[i,e])}}return e}.bind(this)},stretch:i.system.phone,resizable:true,draggable:true,afterOpen:this._handleOpened.bind(this),afterClose:this._handleClosed.bind(this),buttons:[this.oButtonOK,this.oButtonCancel]});n.setModel(this._oManagedObjectModel,"$help");this.setAggregation("_container",n,true);n.isPopupAdaptationAllowed=function(){return false};n.addStyleClass("sapMdcValueHelp");n.addStyleClass("sapMdcValueHelpTitle");var a=new o(this.getId()+"-Content",{fitContainer:true});a.addStyleClass("sapMdcValueHelpPanel");n.addContent(a);return n}.bind(this))}.bind(this))}return e};M.prototype._placeContent=function(e){var n=e.getContent()[0];var i=this.getProperty("_selectableContents");if(!i.length){return Promise.resolve(e)}var o=i.length>1;var r=[];if(o){r.push(this._getIconTabBar(e))}else{if(!this._oStandaloneTab){this._oStandaloneTab=new t(this.getId()+"-Standalone-DT",{content:{path:"/_selectableContents/0/displayContent",model:"$help"},layoutData:new a({growFactor:1,minHeight:"0"})})}r.push(this._oStandaloneTab)}if(x(this.getMaxConditions(),this.getContent())){r.push(this._getTokenizerPanel())}return Promise.all(r).then(function(t){n.removeAllItems();t.forEach(function(e){n.addItem(e)});if(o){e.addStyleClass("sapMdcValueHelpTitleShadow")}else{e.removeStyleClass("sapMdcValueHelpTitleShadow")}return e})};M.prototype._handleSelect=function(t){e.prototype._handleSelect.apply(this,arguments);if(this.getProperty("_quickSelectEnabled")&&this._isSingleSelect()){if(t.getParameter("type")==="Add"){this.fireConfirm({close:true})}}};M.prototype._observeChanges=function(t){if(t.name==="content"){var n=this.getContent();this.setProperty("_quickSelectEnabled",n&&n.every(function(e){return e.isQuickSelectSupported()}));this._updateInitialContentKey();if(t.mutation==="insert"&&!this.getProperty("_selectedContentKey")){this.setProperty("_selectedContentKey",this._sInitialContentKey)}this.setProperty("_selectableContents",this._getSelectableContents());if(x(this.getMaxConditions(),this.getContent())){var i=this.getAggregation("_container");if(i&&i.getContent()[0].getItems().length===1){Promise.all([this._getTokenizerPanel()]).then(function(e){e.forEach(function(e){i.getContent()[0].addItem(e)})})}}}e.prototype._observeChanges.apply(this,arguments)};M.prototype._updateInitialContentKey=function(){var e=this.getContent().find(function(e){return!!e.getVisible()});this._sInitialContentKey=e&&e.getId()};M.prototype.getSelectedContent=function(){var e=this.getProperty("_selectedContentKey");return this.getContent().find(function(t){return t.getId()===e})};M.prototype._getSelectableContents=function(){var e=this.getSelectedContent();var t=e&&e.getGroup&&e.getGroup();var n=e?t:"";var i=[n];return this.getContent().filter(function(t){if(!t.getVisible()){return false}var n=t.getGroup&&t.getGroup();var o=n&&B.call(this,n);if(o&&t!==e){if(i.indexOf(n)>=0){return false}else{i.push(n)}}return true}.bind(this))};M.prototype._updateGroupSelectModel=function(){if(this._oGroupSelectModel){var e=this.getSelectedContent();var t=e&&e.getGroup&&e.getGroup();var n=t?this.getContent().filter(function(e){return!!e.getVisible()&&e.getGroup&&e.getGroup()===t}):[];this._oGroupSelectModel.setData(n.reduce(function(e,t){e.entries.push({key:t.getId(),text:t.getFormattedTitle()});return e},{entries:[]}));if(this._oGroupSelect){var i=this._oGroupSelect.getSelectedItemKey();var o=n.map(function(e){return e.getId()});var a=this.getProperty("_selectedContentKey");if(o.indexOf(i)==-1||i!==a){this._oGroupSelect.setSelectedItemKey(n[0].getId())}}}};M.prototype._retrieveGroupSelect=function(){return this._retrievePromise("collectiveSearchSelect",function(){return n(["sap/ui/mdc/filterbar/vh/CollectiveSearchSelect","sap/m/VariantItem","sap/ui/model/json/JSONModel"]).then(function(e){var t=e[0];var n=e[1];var o=e[2];if(!this._oGroupSelectModel){this._oGroupSelectModel=new o}if(!this._oGroupSelect){var a=new n(this.getId()+"-collSearchItem",{key:"{$select>key}",text:"{$select>text}"});this._oGroupSelect=new t(this.getId()+"--Select",{title:"{$i18n>COL_SEARCH_SEL_TITLE}",items:{path:"$select>/entries",template:a},select:function(e){this._handleContentSelectionChange(e.getParameter("key"))}.bind(this),selectedItemKey:this.getSelectedContent().getId(),maxWidth:i.system.phone?"5em":"25rem"});this._oGroupSelect.setModel(this._oGroupSelectModel,"$select")}return this._oGroupSelect}.bind(this))}.bind(this))};M.prototype._getIconTabBar=function(){if(!this._oIconTabBar){return this._retrievePromise("IconTabBar",function(){return n(["sap/m/IconTabBar","sap/m/IconTabFilter"]).then(function(e){C=e[0];y=e[1];var n=g.IconTabHeaderMode;this._oIconTabBar=new C(this.getId()+"-ITB",{expandable:false,upperCase:false,stretchContentHeight:true,headerMode:n.Inline,select:this._onTabBarSelect.bind(this),layoutData:new a({growFactor:1}),selectedKey:"{path: '$help>/_selectedContentKey', mode: 'OneWay'}"});this._oIconTabBar.addStyleClass("sapUiNoContentPadding");var i=new y(this.getId()+"-ITF",{key:{path:"$help>id"},content:new t(this.getId()+"-DT",{content:{path:"$help>displayContent"}}),text:{parts:["$help>","$valueHelp>/conditions"],formatter:function(e,t){var n="none";if(e){var i=e.getGroup&&e.getGroup();var o=e.getCount(t,i);n=i?this._getFormattedContentGroupLabel(i,o):e.getFormattedTitle(o)}return n}.bind(this)}});this._oIconTabBar.bindAggregation("items",{path:"/_selectableContents",model:"$help",templateShareable:false,template:i});return this._oIconTabBar}.bind(this))}.bind(this))}return this._oIconTabBar};M.prototype._getFormattedContentGroupLabel=function(e,t){var n=this.getGroupConfig();var i=n&&n[e];var o=i&&(t?i.label:i.nnLabel);o=o&&u(o,t?t:"");o=o||this._oResourceBundle.getText(t?"valuehelp.SELECTFROMLIST":"valuehelp.SELECTFROMLISTNONUMBER",t);return o};M.prototype._getTokenizerPanel=function(e){if(!this.oTokenizerPanel){return this._retrievePromise("TokenizerPanel",function(){return n(["sap/m/Panel","sap/m/HBox","sap/m/VBox","sap/ui/mdc/field/FieldMultiInput","sap/m/Token","sap/ui/model/Filter","sap/ui/mdc/field/ConditionType"]).then(function(e){_=e[0];m=e[1];o=e[2];b=e[3];I=e[4];T=e[5];var t=e[6];var n=g.BackgroundDesign;var i=g.ButtonType;this.oTokenizerPanel=new _(this.getId()+"-TokenPanel",{backgroundDesign:n.Transparent,expanded:true,visible:{parts:["$valueHelp>/_config/maxConditions","$help>/content"],formatter:x},headerText:{parts:["$valueHelp>/conditions","$help>/_selectableContents"],formatter:function(e,t){var n=0;for(var i=0;i<e.length;i++){var o=e[i];if(o.isEmpty!==true){n++}}var a;if(t&&t.length==1){a=t[0].getFormattedTokenizerTitle(n);return a}else{a=this._oResourceBundle.getText("valuehelp.TOKENIZERTITLE");if(n===0){a=this._oResourceBundle.getText("valuehelp.TOKENIZERTITLENONUMBER")}return u(a,n)}}.bind(this)}});this.oTokenizerPanel.addStyleClass("sapMdcTokenizerPanel");var r=new m(this.getId()+"-TokenBox",{fitContainer:true,width:"100%"});var s=E.call(this);this._oConditionType=new t(s);this._oConditionType._bVHTokenizer=true;this.oTokenMultiInput=new b(this.getId()+"-Tokenizer",{width:"100%",showValueHelp:false,editable:true,ariaAttributes:{role:"listbox",aria:{readonly:true,roledescription:this._oResourceBundle.getText("valuehelp.TOKENIZER_ARIA_ROLE_DESCRIPTION")}},tokenUpdate:function(e){if(e.getParameter("removedTokens")){var t=e.getParameter("removedTokens");var n=this.getModel("$valueHelp").getObject("/conditions");var i=[];t.forEach(function(e,t){var o=e.getBindingContext("$valueHelp").sPath;var a=parseInt(o.slice(o.lastIndexOf("/")+1));i.push(n[a])});this.fireSelect({type:l.Remove,conditions:i})}}.bind(this),layoutData:new a({growFactor:1,maxWidth:"calc(100% - 2rem)"})});this.oTokenMultiInput._setValueVisible=function(e){this.$("inner").css("opacity","0")};var p=this.oTokenMultiInput.onAfterRendering;this.oTokenMultiInput.onAfterRendering=function(){p.apply(this.oTokenMultiInput,arguments);this.oTokenMultiInput._setValueVisible();this.oTokenMultiInput.setValue("")}.bind(this);w.call(this,true);this.oRemoveAllBtn=new f(this.getId()+"-TokenRemoveAll",{press:function(e){this.fireSelect({type:l.Set,conditions:[]});this.oInvisibleMessage.announce(d.getText("valuehelp.REMOVEALLTOKEN_ANNOUNCE"),S.Polite)}.bind(this),type:i.Transparent,icon:"sap-icon://decline",tooltip:"{$i18n>valuehelp.REMOVEALLTOKEN}",layoutData:new a({growFactor:0,baseSize:"2rem"})});this.oRemoveAllBtn.addStyleClass("sapUiTinyMarginBegin");r.addItem(this.oTokenMultiInput);r.addItem(this.oRemoveAllBtn);this.oTokenizerPanel.addContent(r);return this.oTokenizerPanel}.bind(this))}.bind(this))}else{var t=E.call(this);this._oConditionType.setFormatOptions(t)}return this.oTokenizerPanel};function x(e,t){var n=e!==1;if(n&&t&&t.every(function(e){return!e.getRequiresTokenizer()})){n=false}return n}function E(){var e=this.getModel("$valueHelp");var t=e?e.getProperty("/_config"):{};var n=this.getParent();var i=this.getControl();return{maxConditions:-1,valueType:t.dataType,operators:t.operators,display:t.display,fieldHelpID:n&&n.getId(),control:i,delegate:i&&i.getControlDelegate&&i.getControlDelegate(),delegateName:i&&i.getDelegate&&i.getDelegate()&&i.getDelegate().name,payload:i&&i.getPayload&&i.getPayload(),convertWhitespaces:true}}function w(e){if(this.oTokenMultiInput){var t=this.oTokenMultiInput.getBindingInfo("tokens");if(e){if(!t){var n=new T({path:"isEmpty",operator:"NE",value1:true});this._oConditionType.setFormatOptions(E.call(this));var i=new I(this.getId()+"-Token",{text:{path:"$valueHelp>",type:this._oConditionType}});this.oTokenMultiInput.bindAggregation("tokens",{path:"/conditions",model:"$valueHelp",templateShareable:false,template:i,filters:n})}}else if(t){this.oTokenMultiInput.unbindAggregation("tokens")}}}M.prototype._open=function(e){this._mAlreadyShownContents={};if(e){this._updateInitialContentKey();var t=function(){this._renderSelectedContent(this._sInitialContentKey,function(){var t=this.getContent().find(function(e){return e.getId()===this.getProperty("_selectedContentKey")}.bind(this));var n=t.getInitialFocusedControl();if(n){e.setInitialFocus(n)}e.open();this.getContent().forEach(function(e){e.onContainerOpen()})}.bind(this))}.bind(this);if(x(this.getMaxConditions(),this.getContent())&&e.getContent()[0].getItems().length===1){Promise.all([this._getTokenizerPanel()]).then(function(n){n.forEach(function(t){e.getContent()[0].addItem(t)});t()})}else{if(this.oTokenMultiInput){w.call(this,true)}t()}}};M.prototype._renderSelectedContent=function(e,t){var n=this.getContent().find(function(t){return t.getId()===e});if(!n){throw new Error("sap.ui.mdc.ValueHelp: No content found.")}var i=[n.getContent()];var o=n.getGroup&&n.getGroup();var a;if(o&&B.call(this,o)){a=this._retrieveGroupSelect();i.push(a)}var r=!this._mAlreadyShownContents[e];return Promise.all(i).then(function(){this._bindContent(n)}.bind(this)).then(function(){return Promise.resolve(n.onBeforeShow(r))}).then(function(){this._mAlreadyShownContents[e]=true;this.setProperty("_selectedContentKey",e);this.setProperty("_selectableContents",this._getSelectableContents());this._oManagedObjectModel.checkUpdate(true,false,function(e){if(e.getPath().indexOf("displayContent")>=0){return true}});if(a){this._updateGroupSelectModel()}if(n.setCollectiveSearchSelect){n.setCollectiveSearchSelect(a?this._oGroupSelect:undefined)}if(t){t()}return this._retrievePromise("open").then(function(){n.onShow(r);return n})}.bind(this))};M.prototype._close=function(){var e=this.getAggregation("_container");if(e){e.close();if(this.oTokenMultiInput){w.call(this,false)}}};M.prototype.getValueHelpIcon=function(){return"sap-icon://value-help"};M.prototype.getAriaAttributes=function(e){return{contentId:null,ariaHasPopup:"dialog",role:null,roleDescription:null}};M.prototype.isMultiSelect=function(){return this.getMaxConditions()!==1};M.prototype.init=function(){e.prototype.init.apply(this,arguments);this.oInvisibleMessage=h.getInstance()};M.prototype.exit=function(){s.cleanup(this,["_oManagedObjectModel","_oResourceBundle","oButtonOK","oButtonCancel","oTokenizerPanel","oTokenMultiInput","_oIconTabBar","_oGroupSelect","_oGroupSelectModel","_sInitialContentKey","_mAlreadyShownContents","oInvisibleMessage","_oStandaloneTab"]);e.prototype.exit.apply(this,arguments)};return M});