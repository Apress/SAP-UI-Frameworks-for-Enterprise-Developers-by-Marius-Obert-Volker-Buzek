/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/Container","sap/ui/mdc/util/loadModules","sap/ui/dom/units/Rem","sap/ui/thirdparty/jquery","sap/ui/core/library"],function(t,e,n,o,i){"use strict";var r,a,s,p,l;var u=i.ValueState;var h=t.extend("sap.ui.mdc.valuehelp.Popover",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.ITypeaheadContainer","sap.ui.mdc.valuehelp.IDialogContainer","sap.ui.core.PopupInterface"],properties:{opensOnClick:{type:"boolean",defaultValue:false},opensOnFocus:{type:"boolean",defaultValue:false}},defaultAggregation:"content"}});h.prototype.invalidate=function(e){if(e){var n=this.getAggregation("_container");var o=this._oCurrentContent;if(n&&o&&e===o&&!this._bIsBeingDestroyed){n.invalidate(e)}else{t.prototype.invalidate.apply(this,arguments)}}};h.prototype._getUIAreaForContent=function(){var e=this.getAggregation("_container");if(e){return e.getUIArea()}return t.prototype._getUIAreaForContent.apply(this,arguments)};h.prototype._getContent=function(){var t=this.getContent();return t&&t[0]};h.prototype._getContainer=function(){var t=this.getAggregation("_container");var n=function(t,e){if(t&&t.getValueState&&t.getValueState()!==u.None){e.setText(t.getValueStateText());e.setValueState(t.getValueState());e.setVisible(true)}else{e.setVisible(false)}};if(!t){return e(["sap/m/Popover","sap/m/library","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/ValueStateHeader"]).then(function(e){r=e[0];a=e[1];s=e[2];p=e[3];l=e[4];var o=new l;n(this.getControl(),o);t=new r(this.getId()+"-pop",{contentHeight:"auto",placement:a.PlacementType.VerticalPreferredBottom,showHeader:false,showArrow:false,title:this.getTitle(),titleAlignment:a.TitleAlignment.Center,afterOpen:this._handleOpened.bind(this),afterClose:this._handleClosed.bind(this),customHeader:o}).addStyleClass("sapMdcValueHelpPopover").addStyleClass("sapMComboBoxBasePicker").addStyleClass("sapMComboBoxBasePicker-CTX");if(o){o.setPopup(t)}t.isPopupAdaptationAllowed=function(){return false};t.addStyleClass(this._isSingleSelect()?"sapMdcValueHelpSingleSelect":"sapMdcValueHelpMultiSelect");t.addDelegate({onsapshow:this._handleRequestSwitchToDialog.bind(this)});t._getAllContent=function(){var t=this.getParent();var e=[];if(t){if(this._oCurrentContent){e.push(this._oCurrentContent)}}return e}.bind(this);var i=this._getContent();var u=this._getContainerConfig(i);if(u){t.setShowArrow(!!u.showArrow);t.setShowHeader(!!u.showHeader);t.setResizable(!!u.resizable);if(u.getContentWidth){t.setContentWidth(u.getContentWidth())}}this.setAggregation("_container",t,true);return t}.bind(this))}n(this.getControl(),t.getCustomHeader());return t};var g=function(){var t=this.getAggregation("_container");var e=this._getContent();var o=e&&this._getContainerConfig(e);if(t&&o&&o.getContentHeight){var i=o.getContentHeight();var r=t.$().find(".sapMPopoverCont").height();var a=r<n.toPx("30rem");t.setContentHeight(!i||a||r>=i?"auto":"30rem");t.invalidate()}};h.prototype.providesScrolling=function(){return true};h.prototype._observeChanges=function(e){if(e.name==="content"){var n=e.child;if(e.mutation==="remove"){n.detachEvent("contentUpdated",g,this);n.detachNavigated(this._handleNavigated,this)}else{n.attachEvent("contentUpdated",g,this)}}t.prototype._observeChanges.apply(this,arguments)};h.prototype._placeContent=function(t){var e=this._getContent();var n=e&&e.getContent();var o=this._getContainerConfig(e);var i=o&&o.getFooter&&o.getFooter();return Promise.all([n,i]).then(function(e){this._oCurrentContent=e[0];var n=e[1];if(n&&t.getFooter()!=n&&n.isA&&n.isA("sap.m.Toolbar")){t.setFooter(n);return t}if(n){if(!t.getFooter()){var o=[new p(this.getId()+"-Spacer")].concat(n);var i=new s(this.getId()+"-TB",{content:o}).setModel(this._oManagedObjectModel,"$help");t.setFooter(i)}else{}}else if(t.getFooter()){t.setFooter()}return t}.bind(this))};h.prototype._open=function(e,n){if(e.isOpen()){return}t.prototype._open.apply(this,arguments);var i=this._getContent();Promise.resolve(i&&i.onBeforeShow(true)).then(function(){var t=this.getValueHelpDelegate();var e=this.getValueHelpDelegatePayload();return Promise.resolve(n?t.showTypeahead(e,i):true).then(function(t){return t?Promise.resolve(t):Promise.reject(t)})}.bind(this)).then(function(){var t=this.getControl();var n=t&&t.getFocusElementForValueHelp?t.getFocusElementForValueHelp(this.isTypeahead()):t;if(n&&n.getDomRef()){e.setContentMinWidth(o(n.getDomRef()).outerWidth()+"px");if(!this.isFocusInHelp()){e.setInitialFocus(n)}e.openBy(n)}}.bind(this)).catch(function(t){this._cancelPromise("open");if(t&&t instanceof Error){throw t}}.bind(this))};h.prototype._close=function(){t.prototype._close.apply(this,arguments);var e=this.getAggregation("_container");if(e){e.close()}};h.prototype._handleOpened=function(){g.call(this);t.prototype._handleOpened.apply(this,arguments);var e=this._getContent();if(e){e.onContainerOpen();e.onShow(true)}};h.prototype._handleConfirmed=function(t){this.fireConfirm({close:t.getParameter("close")||this._isSingleSelect()})};h.prototype._handleClosed=function(e){var n=this._getContent();if(n){n.onHide();n.onContainerClose()}var o=this.getAggregation("_container");if(o){o._oPreviousFocus=null}t.prototype._handleClosed.apply(this,arguments)};h.prototype.removeFocus=function(){var t=this._getContent();if(t){t.removeFocus()}};h.prototype._navigate=function(t){var e=this._getContent();if(e){e.navigate(t)}};h.prototype.getItemForValue=function(t){var e=this._getContent();if(e){return e.getItemForValue(t)}};h.prototype.isValidationSupported=function(t){var e=this._getContent();if(e){return e.isValidationSupported()}};h.prototype.getUseAsValueHelp=function(){var t=this._getContent();return t&&t.getUseAsValueHelp&&t.getUseAsValueHelp()};h.prototype.getValueHelpIcon=function(){var t=this._getContent();return t&&t.getValueHelpIcon()};h.prototype.getAriaAttributes=function(e){var n=this._getContent();var o=n&&n.getAriaAttributes(e);if(o){return{contentId:o.contentId,ariaHasPopup:o.ariaHasPopup,role:this.isDialog()?"combobox":null,roleDescription:o.roleDescription}}return t.prototype.getAriaAttributes.apply(this,arguments)};h.prototype.shouldOpenOnFocus=function(){return this.getOpensOnFocus()};h.prototype.shouldOpenOnClick=function(){var t=this._getContent();return this.isPropertyInitial("opensOnClick")?!!t&&t.shouldOpenOnClick():this.getOpensOnClick()};h.prototype.shouldOpenOnNavigate=function(){var t=this._getContent();this._bindContent(t);return!!t&&t.shouldOpenOnNavigate()};h.prototype.isNavigationEnabled=function(t){if(this.isOpen()||this.getUseAsValueHelp()){var e=this._getContent();return!!e&&e.isNavigationEnabled(t)}return false};h.prototype.isFocusInHelp=function(){var t=this._getContent();return!!t&&t.isFocusInHelp()};h.prototype.isMultiSelect=function(){var t=this._getContent();return!!t&&t.isMultiSelect()};h.prototype.isTypeaheadSupported=function(){var t=this._getContent();return t&&t.isSearchSupported()};h.prototype.exit=function(){if(this._oCurrentContent){if(!this._oCurrentContent.bIsDestroyed){this._oCurrentContent.destroy()}this._oCurrentContent=null}t.prototype.exit.apply(this,arguments)};return h});