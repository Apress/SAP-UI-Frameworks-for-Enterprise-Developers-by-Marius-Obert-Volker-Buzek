/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/enum/ProcessingStrategy","sap/ui/mdc/condition/FilterOperatorUtil","./SelectionController","sap/ui/mdc/p13n/P13nBuilder","sap/base/Log","sap/base/util/merge","sap/base/util/deepEqual"],function(t,e,n,r,i,o,a){"use strict";var s=n.extend("sap.ui.mdc.p13n.subcontroller.FilterController",{constructor:function(){n.apply(this,arguments);this._bResetEnabled=true}});s.prototype.getStateKey=function(){return"filter"};s.prototype.getUISettings=function(){return{title:sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("filter.PERSONALIZATION_DIALOG_TITLE"),tabText:sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("p13nDialog.TAB_Filter"),afterClose:function(t){var e=t.getSource();if(e){var n=e.getContent()[0];if(n.isA("sap.m.p13n.Container")){n.removeView("Filter")}else{e.removeAllContent()}}e.destroy()}}};s.prototype.getCurrentState=function(){return this.getAdaptationControl().getCurrentState()[this.getStateKey()]};s.prototype.getChangeOperations=function(){return{add:"addCondition",remove:"removeCondition"}};s.prototype.getBeforeApply=function(){var t=this.getAdaptationControl().getInbuiltFilter();var e=t?t.createConditionChanges():Promise.resolve([]);return e};s.prototype.getFilterControl=function(){return this.getAdaptationControl().isA("sap.ui.mdc.IFilter")?this.getAdaptationControl():this.getAdaptationControl()._oP13nFilter};s.prototype.sanityCheck=function(t){s.checkConditionOperatorSanity(t);return t};s.checkConditionOperatorSanity=function(t){for(var n in t){var r=t[n];for(var o=0;o<r.length;o++){var a=r[o];var s=a.operator;if(!e.getOperator(s)){r.splice(o,1);if(t[n].length==0){delete t[n]}i.warning("The provided conditions for field '"+n+"' contain unsupported operators - these conditions will be neglected.")}}}};s.prototype._getPresenceAttribute=function(t){return"active"};s.prototype.initAdaptationUI=function(t,e){var n=this.mixInfoAndState(t);return this.getAdaptationControl().retrieveInbuiltFilter().then(function(t){t.setP13nData(n);t.setLiveMode(false);t.setProperty("_useFixedWidth",false);t.getTitle=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("filter.PERSONALIZATION_DIALOG_TITLE")};this._oAdaptationFB=t;return t.createFilterFields().then(function(){this._oPanel=t;return t}.bind(this))}.bind(this))};s.prototype.update=function(t){if(this._oPanel){var e=this.mixInfoAndState(t);this._oPanel.setP13nData(e);var n=this.getAdaptationControl();var r=n&&n.getInbuiltFilter();if(r){r.createFilterFields()}}};s.prototype.getDelta=function(e){if(e.applyAbsolute===t.FullReplace){Object.keys(e.existingState).forEach(function(t){if(!e.changedState.hasOwnProperty(t)){e.changedState[t]=[]}})}return u(e)};var u=function(t){var e=[];var n=t.changedState;var r=t.existingState;var o=t.control;var a=t.hasOwnProperty("applyAbsolute")?t.applyAbsolute:true;var s=t.propertyInfo;for(var u in n){var c=p(s,u);if(!c&&o.isA("sap.ui.mdc.Control")&&o.isPropertyHelperFinal()){i.warning("property '"+u+"' not supported");continue}var f=l(u,n[u],r[u],o,a);e=e.concat(f)}return e};var p=function(t,e){return t.some(function(t){var n=t.name===e||e=="$search";n=n?n:t.path===e;return n})};var c=function(t,e,n,r){delete r.filtered;var i={selectorElement:e,changeSpecificData:{changeType:t,content:{name:n,condition:r}}};return i};var l=function(t,n,r,i,s){var u,p=[];var l=o([],n);var f=r?o([],r):[];if(a(n,f)){return p}var d=function(t,n){var r;do{r=false;for(var i=0;i<t.length;i++){var o=t[i];var a=e.indexOfCondition(o,n);if(a>-1){t.splice(i,1);if(s){n.splice(a,1)}r=true;break}}}while(r)};d(n,f);if(n.length>0||f.length>0){f.forEach(function(n){var r=e.indexOfCondition(n,l);var o=r>-1&&l[r].filtered===false;if(s||o){u=c("removeCondition",i,t,n);p.push(u)}});n.forEach(function(e){if(s||(!e.hasOwnProperty("filtered")||e.filtered!==false)){u=c("addCondition",i,t,e);p.push(u)}})}return p};s.prototype.model2State=function(){var t={},e=this.getCurrentState();this.getP13nData().items.forEach(function(n){if(n.active&&Object.keys(e).includes(n.name)){t[n.name]=e[n.name]}});return t};s.prototype.mixInfoAndState=function(t){var e=this.getCurrentState()||{};var n=this.prepareAdaptationData(t,function(t,n){var r=e[t.name];t.active=r&&r.length>0?true:false;return!(n.filterable===false)});r.sortP13nData({visible:"active",position:undefined},n.items);return n};s.prototype.changesToState=function(t,e,n){var r={};t.forEach(function(t){var e=o({},t.changeSpecificData.content);var n=e.name;if(!r[n]){r[n]=[]}if(t.changeSpecificData.changeType===this.getChangeOperations()["remove"]){e.condition.filtered=false}r[n].push(e.condition)}.bind(this));return r};return s});