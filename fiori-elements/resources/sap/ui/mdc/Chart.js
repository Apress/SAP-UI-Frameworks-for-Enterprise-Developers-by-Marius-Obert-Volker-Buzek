/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/mdc/Control","./chart/ChartSettings","./ChartRenderer","sap/base/Log","./chart/ChartToolbar","./chart/PropertyHelper","sap/ui/mdc/mixin/FilterIntegrationMixin","sap/ui/model/base/ManagedObjectModel","sap/ui/mdc/p13n/subcontroller/ChartItemController","sap/ui/mdc/p13n/subcontroller/FilterController","sap/ui/mdc/p13n/subcontroller/SortController","sap/ui/mdc/p13n/subcontroller/ChartTypeController","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/chart/DrillBreadcrumbs","sap/ui/mdc/actiontoolbar/ActionToolbarAction","sap/ui/core/library","sap/ui/events/KeyCodes","sap/ui/mdc/util/InfoBar","sap/ui/core/format/ListFormat","sap/ui/mdc/enum/ProcessingStrategy"],function(t,e,i,r,o,n,a,s,l,h,p,u,g,c,d,f,y,b,C,m,_){"use strict";var v;var I=y.TitleLevel;var D=e.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/chart/Chart.designtime",interfaces:["sap.ui.mdc.IFilterSource","sap.ui.mdc.IxState"],defaultAggregation:"items",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/ChartDelegate"}},header:{type:"string",group:"Misc",defaultValue:null},noDataText:{type:"string",defaultValue:"No data"},p13nMode:{type:"sap.ui.mdc.ChartP13nMode[]",defaultValue:[]},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},ignoreToolbarActions:{type:"sap.ui.mdc.ChartToolbarActionType[]",defaultValue:[]},minWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"240px",invalidate:true},minHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"400px",invalidate:true},sortConditions:{type:"object"},filterConditions:{type:"object",defaultValue:{}},showChartTooltip:{type:"boolean",group:"Misc",defaultValue:true},autoBindOnInit:{type:"boolean",group:"Misc",defaultValue:true},chartType:{type:"string",group:"Misc",defaultValue:"column"},showSelectionDetails:{type:"boolean",group:"Misc",defaultValue:true},propertyInfo:{type:"object",defaultValue:[]},headerLevel:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:I.Auto},headerVisible:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_getToolbar",aggregation:"actions"}},_toolbar:{type:"sap.ui.mdc.chart.ChartToolbar",multiple:false,visibility:"hidden"},_breadcrumbs:{type:"sap.m.Breadcrumbs",multiple:false,visibility:"hidden"},_innerChart:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false},_infoToolbar:{type:"sap.ui.mdc.util.InfoBar",multiple:false,visibility:"hidden"},variant:{type:"sap.ui.fl.variants.VariantManagement",multiple:false},noData:{type:"sap.ui.core.Control",multiple:false}},associations:{filter:{type:"sap.ui.mdc.IFilter",multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}}}},renderer:r});var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");s.call(D.prototype);D.prototype.init=function(){this._oManagedObjectModel=new l(this);this.setModel(this._oManagedObjectModel,"$mdcChart");this._bNewP13n=true;e.prototype.init.apply(this,arguments);this._setupPropertyInfoStore("propertyInfo");this._setPropertyHelperClass(a)};D.prototype.setP13nMode=function(t){var e=null;if(t&&t.length>=1){e=[];var i=t.reduce(function(t,e,i){t[e]=true;return t},{});if(i.Item){e.push("Item")}if(i.Sort){e.push("Sort")}if(i.Filter){e.push("Filter")}if(i.Type){this._typeBtnActive=true;e.push("Type")}else{this._typeBtnActive=false}}else{e=t}this.setProperty("p13nMode",e,true);this._updateAdaptation(this.getP13nMode());return this};D.prototype._updateAdaptation=function(t){var e={controller:{}};var i={Item:new h({control:this}),Sort:new u({control:this}),Filter:new p({control:this}),Type:new g({control:this})};if(t&&t.length>0){t.forEach(function(t){var r=t;var o=i[t];if(o){e.controller[r]=o}});this.getEngine().register(this,e)}};D.prototype.setFilterConditions=function(t){this.setProperty("filterConditions",t,true);var e=this.getInbuiltFilter();if(e){e.setFilterConditions(t)}this._updateInfoToolbar();return this};D.prototype.getConditions=function(){return this.getInbuiltFilter()?this.getInbuiltFilter().getConditions():[]};D.prototype._registerInnerFilter=function(t){t.attachSearch(function(){this._rebind()},this)};D.prototype.applySettings=function(t,i){this._setPropertyHelperClass(a);e.prototype.applySettings.apply(this,arguments);this.initializedPromise=new Promise(function(t,e){this._fnResolveInitialized=t;this._fnRejectInitialized=e}.bind(this));this.innerChartBoundPromise=new Promise(function(t,e){this._fnResolveInnerChartBound=t;this._fnRejectInnerChartBound=e}.bind(this));var r=this._loadDelegate().then(function(t){return t}).then(function(t){return this.initControlDelegate(t)}.bind(this)).catch(function(t){this._fnRejectInitialized(t)}.bind(this));var o=[r];if(this.isFilteringEnabled()){o.push(this.retrieveInbuiltFilter())}Promise.all(o).then(function(){this._initInnerControls()}.bind(this))};D.prototype._initInnerControls=function(){this.getControlDelegate().initializeInnerChart(this).then(function(t){this.setBusyIndicatorDelay(0);this.getControlDelegate().createInitialChartContent(this);this._renderOverlay(true);if(this.getAutoBindOnInit()){this.setBusy(true);this._createContentfromPropertyInfos(t)}this.setAggregation("_innerChart",t);if(this.getP13nMode().includes("Filter")){this._initInfoToolbar()}this._bInnerChartReady=true;this._fnResolveInitialized();this.invalidate()}.bind(this)).catch(function(t){this._fnRejectInitialized(t)}.bind(this));this._getToolbar().createToolbarContent(this)};D.prototype._initInfoToolbar=function(){this.setAggregation("_infoToolbar",new C(this.getId()+"--infoToolbar",{infoText:this._getFilterInfoText(),press:function(){this.finalizePropertyHelper().then(function(){return i.showPanel(this,"Filter")}.bind(this)).then(function(t){t.attachEventOnce("afterClose",function(){var t=this.getFilterConditions();var e=!Object.keys(t).find(function(e){return t[e]&&t[e].length>0});if(e&&this.getAggregation("_toolbar")){this.getAggregation("_toolbar").getSettingsButton().focus()}}.bind(this))}.bind(this))}.bind(this),removeAllFilters:function(t){this.getEngine().createChanges({control:this,key:"Filter",state:{},applyAbsolute:_.FullReplace});this._getToolbar().getSettingsButton().focus()}.bind(this)}));if(this.getDomRef()){this.getDomRef().setAttribute("aria-labelledby",this.getAggregation("_infoToolbar").getACCTextId())}};D.prototype._updateInfoToolbar=function(){if(this.getP13nMode().includes("Filter")&&this.getAggregation("_infoToolbar")){this.getAggregation("_infoToolbar").setInfoText(this._getFilterInfoText())}};D.prototype._getFilterInfoText=function(){if(this.getInbuiltFilter()){var t;var e=this._getLabelsFromFilterConditions();var i=m.getInstance();if(e.length>0){if(e.length>1){t=T.getText("chart.MULTIPLE_FILTERS_ACTIVE",[e.length,i.format(e)])}else{t=T.getText("chart.ONE_FILTER_ACTIVE",e[0])}}return t}return undefined};D.prototype._createContentfromPropertyInfos=function(t){this.getControlDelegate().checkAndUpdateMDCItems(this).then(function(){this.getControlDelegate().createInnerChartContent(this,this._innerChartDataLoadComplete.bind(this)).then(function(){this._createBreadcrumbs();this._oObserver=new c(this._propagateItemChangeToInnerChart.bind(this));this._oObserver.observe(this,{aggregations:["items"]});this._propagatePropertiesToInnerChart();this._fnResolveInnerChartBound()}.bind(this))}.bind(this))};D.prototype._createBreadcrumbs=function(){if(!this._oBreadcrumbs){this._oBreadcrumbs=new d(this.getId()+"--breadcrumbs");this._oBreadcrumbs.updateDrillBreadcrumbs(this,this.getControlDelegate().getDrillableItems(this));this.setAggregation("_breadcrumbs",this._oBreadcrumbs)}};D.prototype._loadDelegate=function(){return new Promise(function(t){var e=[this.getDelegate().name];function i(e){t(e)}sap.ui.require(e,i)}.bind(this))};D.prototype.isFilteringEnabled=function(){return this.getP13nMode().indexOf("Filter")>-1};D.prototype.getAdaptationUI=function(){return this.getControlDelegate().getAdaptionUI(this)};D.prototype._propagateItemChangeToInnerChart=function(t){if(this._bIsDestroyed){return}this.setBusy(true);switch(t.mutation){case"insert":var e;if(t.child&&t.child.getType()){e=this.getItems().filter(function(e){return e.getType()===t.child.getType()}).indexOf(t.child)}else{e=this.getItems().indexOf(t.child)}this.getControlDelegate().insertItemToInnerChart(this,t.child,e);break;case"remove":this.getControlDelegate().removeItemFromInnerChart(this,t.child);break;default:o.error("Unknown mutation on MDC Chart Item Aggregation. This will not sync to inner chart!");break}this._rebind();this._oBreadcrumbs.updateDrillBreadcrumbs(this,this.getControlDelegate().getDrillableItems(this))};D.prototype._rebind=function(){if(!this._bInnerChartReady){this.initialized().then(function(){this._rebind()}.bind(this));return}this.setBusy(true);if(!this.getControlDelegate().getInnerChartBound(this)){this._createContentfromPropertyInfos();return}var t=this.getControlDelegate()._getBindingInfo(this);this.getControlDelegate().updateBindingInfo(this,t);this.getControlDelegate().rebind(this,t)};D.prototype._getToolbar=function(){if(this.getAggregation("_toolbar")){return this.getAggregation("_toolbar")}else{var t=new n(this.getId()+"--toolbar",{design:"Transparent"});this.setAggregation("_toolbar",t);return t}};D.prototype._updateToolbar=function(){if(this.getAggregation("_toolbar")){this.getAggregation("_toolbar").updateToolbar(this)}else{o.warning("Trying to uipdate Chart Toolbar, but toolbar is not yet initialized. This will not work!")}};D.prototype._getInnerChart=function(){if(this._bInnerChartReady){return this.getControlDelegate().getInnerChart(this)}else{o.error("Trying to acces inner chart while inner chart is not yet initialized!")}};D.prototype.initialized=function(){return this.initializedPromise};D.prototype.innerChartBound=function(){return this.innerChartBoundPromise};D.prototype.zoomIn=function(t){if(!t){t=10}this.getControlDelegate().zoomIn(this,t)};D.prototype.zoomOut=function(t){if(t){t=10}this.getControlDelegate().zoomOut(this,t)};D.prototype.getZoomState=function(){return this.getControlDelegate().getZoomState(this)};D.prototype.getSelectionHandler=function(){return this.getControlDelegate().getInnerChartSelectionHandler(this)};D.prototype.getChartTypeLayoutConfig=function(){return this.getControlDelegate().getChartTypeLayoutConfig()};D.prototype.getAllowedRolesForKinds=function(){return this.getControlDelegate().getAllowedRolesForKinds()};D.prototype.setLegendVisible=function(t){this.setProperty("legendVisible",t);try{this.getControlDelegate().setLegendVisible(this,t)}catch(t){o.info("Trying to set legend visiblity for Chart before delegate was initialized")}return this};D.prototype.setShowChartTooltip=function(t){this.setProperty("showChartTooltip",t);try{this.getControlDelegate().setChartTooltipVisibility(this,t)}catch(t){o.info("Trying to set tooltip visibility before delegate was initialized")}return this};D.prototype.destroy=function(){this._bIsDestroyed=true;e.prototype.destroy.apply(this,arguments)};D.prototype._showDrillDown=function(t){if(!this.oDrillPopover){if(v){this.oDrillPopover=v.createDrillDownPopover(this);this.oDrillPopover.attachAfterClose(function(){delete this.oDrillPopover}.bind(this));return v.showDrillDownPopover(this,t)}return new Promise(function(e,i){sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(i){v=i;this.oDrillPopover=v.createDrillDownPopover(this);this.oDrillPopover.attachAfterClose(function(){delete this.oDrillPopover}.bind(this));v.showDrillDownPopover(this,t).then(function(t){e(t)})}.bind(this))}.bind(this))}else if(this.oDrillPopover){this.oDrillPopover.close()}};D.prototype._propagatePropertiesToInnerChart=function(){this.setLegendVisible(this.getLegendVisible());this.setShowChartTooltip(this.getShowChartTooltip());this.setChartType(this.getChartType())};D.prototype.getChartTypeInfo=function(){var e;try{e=this.getControlDelegate().getChartTypeInfo(this)}catch(r){var i=t.getLibraryResourceBundle("sap.chart.messages");if(!e){e={icon:"sap-icon://vertical-bar-chart",text:T.getText("chart.CHART_TYPE_TOOLTIP",[i.getText("info/bar")])}}}return e};D.prototype.getAvailableChartTypes=function(){return this.getControlDelegate().getAvailableChartTypes(this)};D.prototype.setChartType=function(t){this.setProperty("chartType",t);try{this.getControlDelegate().setChartType(this,t)}catch(t){o.info("Trying to set chart type for Chart before delegate was initialized")}return this};D.prototype.setNoData=function(t){this.setAggregation("noData",t);try{this.getControlDelegate().changedNoDataStruct(this)}catch(t){}return this};D.prototype.setHeaderVisible=function(t){this.setProperty("headerVisible",t,true);if(this.getAggregation("_toolbar")){this.getAggregation("_toolbar").setHeaderVisible(t)}return this};D.prototype.getManagedObjectModel=function(){return this._oManagedObjectModel};D.prototype._innerChartDataLoadComplete=function(t){this._checkStyleClassesForDimensions();this.setBusy(false);this._renderOverlay(false);this.getControlDelegate().requestToolbarUpdate(this)};D.prototype._checkStyleClassesForDimensions=function(){var t=this.getItems().some(function(t){return t.getType()==="groupable"});if(!t&&this.hasStyleClass("sapUiMDCChartGrid")){this.removeStyleClass("sapUiMDCChartGrid");this.addStyleClass("sapUiMDCChartGridNoBreadcrumbs")}else if(t&&this.hasStyleClass("sapUiMDCChartGridNoBreadcrumbs")){this.removeStyleClass("sapUiMDCChartGridNoBreadcrumbs");this.addStyleClass("sapUiMDCChartGrid")}};D.prototype.getCurrentState=function(){var t={};var e=this.getP13nMode();if(e){if(e.indexOf("Item")>-1){t.items=this._getVisibleProperties()}if(e.indexOf("Sort")>-1){t.sorters=this._getSortedProperties()}if(e.indexOf("Filter")>-1){t.filter=this.getFilterConditions()}if(e.indexOf("Type")>-1){t.chartType=this.getChartType()}}return t};D.prototype._getVisibleProperties=function(){var t=[];this.getItems().forEach(function(e){t.push({name:e.getName(),role:e.getRole()})});return t};D.prototype._getSortedProperties=function(){return this.getSortConditions()?this.getSortConditions().sorters:[]};D.prototype._getTypeBtnActive=function(){return!!this._typeBtnActive};D.prototype.setNoDataText=function(t){this.setProperty("noDataText",t);try{this.getControlDelegate().setNoDataText(this,t)}catch(t){}return this};D.prototype._onFiltersChanged=function(t){if(this._bInnerChartReady&&this.getControlDelegate()&&this.getControlDelegate().getInnerChartBound(this)&&t.getParameter("conditionsBased")){this._renderOverlay(true)}};var A=function(t){var e=false;if(t&&(t.indexOf("Sort")>-1||t.indexOf("Item")>-1||t.indexOf("Filter")>-1)){e=true}return e};D.prototype._onModifications=function(t){if(A(t)){this.rebind()}};D.prototype.setVariant=function(t){this.setAggregation("variant",t);if(this.getAggregation("_toolbar")){this.getAggregation("_toolbar").addVariantManagement(t)}return this};D.prototype._renderOverlay=function(t){try{this.getControlDelegate().showOverlay(this,t)}catch(t){o.error("sap.ui.mdc.Chart: Tried to render overlay on not initiailized chart. This will not work!")}};D.prototype.addAction=function(t){if(t.getMetadata().getName()!=="sap.ui.mdc.actiontoolbar.ActionToolbarAction"){t=new f(t.getId()+"-action",{action:t})}return e.prototype.addAggregation.apply(this,["actions",t])};D.prototype.setHeaderLevel=function(t){if(this.getAggregation("_toolbar")){this.getAggregation("_toolbar")._setHeaderLevel(t)}this.setProperty("headerLevel",t);return this};D.prototype.getVariant=function(){var t=this.getAggregation("_toolbar");return t?t._getVariantReference():this.getAggregation("variant")};D.prototype.onkeydown=function(t){if(t.isMarked()){return}if((t.metaKey||t.ctrlKey)&&t.which===b.COMMA){var e=this._getToolbar()._oSettingsBtn;if(e&&e.getVisible()&&e.getEnabled()){e.firePress();t.setMarked();t.preventDefault()}}};return D});