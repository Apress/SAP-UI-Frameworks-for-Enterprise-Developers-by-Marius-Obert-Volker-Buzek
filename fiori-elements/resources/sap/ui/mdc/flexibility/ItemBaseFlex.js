/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/p13n/Engine","sap/base/Log","sap/ui/mdc/flexibility/Util","sap/ui/fl/changeHandler/Base","sap/ui/fl/changeHandler/condenser/Classification"],function(e,t,n,i,r){"use strict";var a={beforeAddItem:function(e,t,n,i){return e.addItem.call(e,t,n,i)},afterRemoveItem:function(e,t,n,i){return e.removeItem.call(e,t,n,i)},findItem:function(e,t,n){return Promise.resolve()},beforeApply:function(e,t,n){return},afterApply:function(e,t,n){return},determineAggregation:function(e,t){var n;return Promise.resolve().then(e.getControlMetadata.bind(e,t)).then(function(i){n=i.getDefaultAggregation().name;return e.getAggregation(t,n)}).then(function(e){return{name:n,items:e}})},_getExistingAggregationItem:function(e,t,n){var i=t.modifier;return this.determineAggregation(i,n).then(function(t){var n,r=t.items;if(r){n=this.findItem(i,r,e.name)}return n}.bind(this))},_getDelegate:function(e){return new Promise(function(t,n){sap.ui.require([e],t,n)})},_getOperationText:function(e){return e?"reverted ":"applied "},_getChangeTypeText:function(e){return e?"add":"remove"},_applyAdd:function(e,t,r,a){var o=a===n.REVERT;this.beforeApply(e.getChangeType(),t,o);var g=r.modifier,d=o?e.getRevertData():e.getContent();var s=d.name;var u;var f;var h;var c;var l=this.determineAggregation(g,t).then(function(e){h=e;f=h.items;u=d.index>-1?d.index:f.length;return this._getExistingAggregationItem(d,r,t)}.bind(this)).then(function(e){if(e){return e}else{return g.getProperty(t,"delegate").then(function(e){return this._getDelegate(e.name)}.bind(this)).then(function(e){return this.beforeAddItem(e,s,t,r,d)}.bind(this)).then(function(e){return e})}}.bind(this)).then(function(e){if(!e){throw new Error("No item in"+h.name+"  created. Change to "+this._getChangeTypeText(!o)+"cannot be "+this._getOperationText(o)+"at this moment")}if(f.indexOf(e)<0){g.insertAggregation(t,h.name,e,u)}else{return i.markAsNotApplicable("The specified change is already existing - change appliance ignored",true)}c=e.getId?e.getId():e.id;return e}.bind(this)).then(function(){if(o){e.resetRevertData()}else{e.setRevertData({name:d.name,index:u,item:c})}this.afterApply(e.getChangeType(),t,o)}.bind(this));return l},_applyRemove:function(e,t,r,a){var o=a===n.REVERT;this.beforeApply(e.getChangeType(),t,o);var g=r.modifier,d=o?e.getRevertData():e.getContent();var s;var u;var f;var h;var c=this.determineAggregation(g,t).then(function(e){s=e;return this._getExistingAggregationItem(d,r,t)}.bind(this)).then(function(e){f=e;if(!f){return i.markAsNotApplicable("The specified change is already existing - change appliance ignored",true)}else{return g.findIndexInParentAggregation(f)}}).then(function(e){u=e;return g.removeAggregation(t,s.name,f)}).then(function(){return g.getProperty(t,"delegate").then(function(e){return this._getDelegate(e.name)}.bind(this)).then(function(n){return this.afterRemoveItem(n,f,t,r).then(function(n){if(n&&f){h=g.getId(f);g.destroy(f,"KeepDom")}this.afterApply(e.getChangeType(),t,o)}.bind(this))}.bind(this))}.bind(this)).then(function(){if(o){e.resetRevertData()}else{e.setRevertData({name:d.name,index:u,item:h})}});return c},_applyMove:function(e,t,r,a){var o;var g=a===n.REVERT;this.beforeApply(e.getChangeType(),t,g);if(this._bSupressFlickering){this._delayInvalidate(t)}var d=r.modifier;var s=g?e.getRevertData():e.getContent();var u;var f;var h;var c=this.determineAggregation(d,t).then(function(e){f=e;return this._getExistingAggregationItem(s,r,t)}.bind(this)).then(function(e){u=e}).then(function(){if(!u){return i.markAsNotApplicable("The specified change is already existing - change appliance ignored",true)}else{o=u.getId?u.getId():u.id;return d.findIndexInParentAggregation(u)}}).then(function(e){h=e;if(t.moveColumn){return t.moveColumn(u,s.index)}else{return d.removeAggregation(t,f.name,u).then(function(){return d.insertAggregation(t,f.name,u,s.index)})}}).then(function(){if(g){e.resetRevertData()}else{e.setRevertData({name:s.name,index:h,item:o})}this.afterApply(e.getChangeType(),t,g)}.bind(this));return c},_removeIndexFromChange:function(e){var t=e.getContent();delete t.index;e.setContent(t)},createAddChangeHandler:function(){return n.createChangeHandler({apply:this._applyAdd.bind(this),revert:this._applyRemove.bind(this),getCondenserInfo:function(e,t){var n=t.modifier.bySelector(e.getSelector(),t.appComponent);return this.determineAggregation(t.modifier,n).then(function(t){return{affectedControl:{idIsLocal:false,id:e.getRevertData().item},targetContainer:e.getSelector(),targetAggregation:t.name,classification:r.Create,setTargetIndex:function(e,t){e.getContent().index=t},getTargetIndex:function(e){return e.getContent().index}}})}.bind(this)})},createRemoveChangeHandler:function(){return n.createChangeHandler({apply:this._applyRemove.bind(this),complete:this._removeIndexFromChange.bind(this),revert:this._applyAdd.bind(this),getCondenserInfo:function(e,t){var n=t.modifier.bySelector(e.getSelector(),t.appComponent);return this.determineAggregation(t.modifier,n).then(function(t){return{affectedControl:{idIsLocal:false,id:e.getRevertData().item},targetContainer:e.getSelector(),targetAggregation:t.name,classification:r.Destroy,sourceIndex:e.getRevertData().index}})}.bind(this)})},createMoveChangeHandler:function(){return n.createChangeHandler({apply:this._applyMove.bind(this),revert:this._applyMove.bind(this),getCondenserInfo:function(e,t){var n=t.modifier.bySelector(e.getSelector(),t.appComponent);return this.determineAggregation(t.modifier,n).then(function(t){return{affectedControl:{idIsLocal:false,id:e.getRevertData().item},targetContainer:e.getSelector(),targetAggregation:t.name,classification:r.Move,sourceIndex:e.getRevertData().index,sourceContainer:e.getSelector(),sourceAggregation:t.name,setTargetIndex:function(e,t){e.getContent().index=t},getTargetIndex:function(e){return e.getContent().index}}})}.bind(this)})}};return a});