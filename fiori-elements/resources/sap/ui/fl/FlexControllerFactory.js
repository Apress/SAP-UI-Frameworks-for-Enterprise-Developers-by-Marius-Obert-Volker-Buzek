/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/FlexController","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/variants/VariantModel","sap/base/Log","sap/ui/performance/Measurement"],function(e,t,n,r,o,a,i,s,l,p){"use strict";var c={};c._instanceCache={};c._componentInstantiationPromises=new WeakMap;var u={};c.create=function(t){var n=c._instanceCache[t];if(!n){n=new e(t);c._instanceCache[t]=n}return n};c.createForControl=function(e){try{var n=t.getAppComponentForControl(e);var r=a.getFlexReferenceForControl(n||e);return c.create(r)}catch(e){l.error(e.message,undefined,"sap.ui.fl.FlexControllerFactory")}};function f(e,r){if(t.getUshellContainer()){return Promise.resolve(e)}var o=window.sessionStorage.getItem("sap.ui.rta.restart."+n.CUSTOMER);if(o){var i=a.getFlexReferenceForControl(r);if(o!==i&&o!=="true"){l.error("an application component was started "+"which does not match the component for which the restart was triggered:\n"+"Triggering component: "+o+"\n"+"Started component: "+i);return Promise.resolve(e)}return new Promise(function(t,n){Promise.all([sap.ui.getCore().loadLibrary("sap.ui.rta",{async:true}),r.rootControlLoaded()]).then(function(){sap.ui.require(["sap/ui/rta/api/startKeyUserAdaptation"],function(n){n({rootControl:r});t(e)})}).catch(function(e){n(e)})})}return Promise.resolve(e)}c.getChangesAndPropagate=function(e,n){if(t.isApplicationComponent(e)){var r=e.getId();o.rebuildFilteredResponse(a.getFlexReferenceForControl(e));var s=o.initialize({componentId:r,asyncHints:n.asyncHints}).then(d.bind(this,e)).then(function(){if(u[r]){u[r].forEach(function(t){var n=e.getModel(i.getVariantModelName());t.setModel(n,i.getVariantModelName())});delete u[r]}});c._componentInstantiationPromises.set(e,s);return s}else if(t.isEmbeddedComponent(e)){var l=t.getAppComponentForControl(e);if(l&&t.isApplicationComponent(l)){if(c._componentInstantiationPromises.has(l)){return c._componentInstantiationPromises.get(l).then(function(){var t=l.getModel(i.getVariantModelName());e.setModel(t,i.getVariantModelName())})}u[l.getId()]=u[l.getId()]||[];u[l.getId()].push(e)}return Promise.resolve()}};function d(e){var t=e.getManifestObject();var n=c.createForControl(e,t);var o;return n._oChangePersistence.loadChangesMapForComponent(e).then(function(t){var a=r.applyAllChangesForControl.bind(r,t,e,n);a._bIsSapUiFlFlexControllerApplyChangesOnControl=true;e.addPropagationListener(a);o=new s({},{flexController:n,appComponent:e});return o.initialize()}).then(function(){e.setModel(o,i.getVariantModelName());p.end("flexProcessing");return o}).then(function(t){return f(t,e)})}return c},true);