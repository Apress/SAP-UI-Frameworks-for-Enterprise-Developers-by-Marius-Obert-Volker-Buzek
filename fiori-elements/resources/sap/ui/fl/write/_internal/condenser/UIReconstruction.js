/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/ObjectPath","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(n,e,t,i,r,a,f,c){"use strict";var o={};var s={create:r,destroy:a,move:f};function u(n,t){e(n,function(n,i){e(i,function(e,r){t(i,n,r,e)})})}function l(n,e,t){n.splice(t,0,n.splice(e,1)[0])}function h(n,e){var t={};u(n,function(n,i,r,a){var f=r[c.TARGET_UI];var o=r[c.INITIAL_UI];e.forEach(function(n){var e=f.indexOf(n.affectedControl)>-1||o.indexOf(n.affectedControl)>-1;if(a===n.targetAggregation&&e){if(!t[i]){t[i]={}}var r=t[i];if(!r[a]){r[a]=[]}var c=r[a];c.push(n)}})});return t}function d(n){return!n.some(function(n){return n.classification!==i.Create})}function v(n){return!n.some(function(n){return c.isUnknown(n)})}function g(n){return n.getTargetIndex(n.change)}function E(n){n.sort(function(n,e){var t=g(n);var i=g(e);return t-i})}function I(n){return!n.some(function(n){return!c.isUnknown(n)})}function T(e,t){var i;if(e.length<t.length){i=t.slice(e.length);if(!I(i)){return false}t=t.slice(0,e.length)}else if(e.length>t.length){i=e.slice(t.length,e.length);if(!I(i)){return false}e=e.slice(0,t.length)}return n(e,t)}function p(n,e,t,i,r){var a={};r.forEach(function(n){var i=n.targetContainer;if(!a[i]){a[i]={}}var r=a[i];if(!r[e]){r[e]=c.initializeArrayWithPlaceholders(0,t.length-1)}s[n.classification].simulate(r[e],n,t)});var f=a[n][e];if(T(i,f)){return true}return false}function _(n,e){function t(n,e){if(g(e)!==n){var t=e.change.getState();e.setTargetIndex(e.change,n);e.change.setState(t);if(e.change.isPersisted()){e.change.condenserState="update"}}}function r(e,r,a){a[c.TARGET_UI].forEach(function(e,r){if(!c.isUnknown(e)){var a=n[e];var f=a[c.INDEX_RELEVANT];u(f,function(n,e,a,f){if(f!==i.Destroy){a.forEach(t.bind(this,r))}})}})}u(e,r)}function A(n,e){u(e,function(e,t,i,r){var a=i[c.INITIAL_UI];var f=i[c.TARGET_UI];if(T(a,f)){f.forEach(function(e){var t=n[e];if(t!==undefined){u(t[c.INDEX_RELEVANT],function(n,e,t){t.forEach(function(n){n.change.condenserState="delete"})});delete t[c.INDEX_RELEVANT]}});delete e[r]}})}function U(n,e){u(e,function(e,i,r,a){var f=r[c.INITIAL_UI];var o=r[c.TARGET_UI];f.forEach(function(e,i){var r=n[e];if(!r||!t.get([c.INDEX_RELEVANT,a],r)){var f=c.PLACEHOLDER+i;var s=o.indexOf(e);if(s>=0){o[s]=f}}})})}o.swapChanges=function(n,e){var t=n.map(function(n){return e.indexOf(n)}).sort();n.forEach(function(n){e[t.shift()]=n})};o.sortIndexRelatedChanges=function(n,e){var t=[];var i=h(n,e);u(i,function(e,i,r,a){var f=n[i][a][c.TARGET_UI];var o=n[i][a][c.INITIAL_UI];var s=true;if(v(f)||d(r)){E(r)}else if(!p(i,a,o,f,r)){s=false;var u=r.length;while(u!==0&&!s){var h=0;var g=1;while(g<r.length&&!s){l(r,h,g);s=p(i,a,o,f,r);h++;g++}u--}}if(!s){throw Error("no correct sorting found for the container: "+i)}t.push(r.map(function(n){return n.change}))});return t};o.addChange=function(n,e){return s[e.classification].addToReconstructionMap(n,e)};o.compareAndUpdate=function(n,e){A(n,e);U(n,e);_(n,e)};return o});