/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/core/Element","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/core/Core"],function(e,n,t,r,a,c,i,o,l,p,s,g,h,f,u){"use strict";var C={create:function(n){var r;if(e(i.getChangeTypes(),n.changeSpecificData.changeType)){r=s.getFlexControllerInstance(n.selector);var c=r.getComponentName();var o;if(n.changeSpecificData.layer){o=n.changeSpecificData.layer;delete n.changeSpecificData.layer}var l={changeType:n.changeSpecificData.changeType,content:n.changeSpecificData.content};if(n.changeSpecificData.texts){l.texts=n.changeSpecificData.texts}return f.createDescriptorInlineChange(l).then(function(e){return(new g).createNew(c,e,o,n.selector)}).catch(function(e){t.error("the change could not be created.",e.message);throw e})}if(n.changeSpecificData.changeType==="codeExt"){return p.createControllerExtensionChange(n.changeSpecificData)}if(n.selector.name&&n.selector.view){r=s.getFlexControllerInstance(n.selector.view)}else{r=s.getFlexControllerInstance(n.selector)}if(n.selector instanceof a){return r.createBaseChange(n.changeSpecificData,n.selector)}if(n.selector.name&&n.selector.view){return r.createChangeWithExtensionPointSelector(n.changeSpecificData,n.selector)}return r.createChangeWithControlSelector(n.changeSpecificData,n.selector)},apply:function(e){if(!(e.element instanceof c)){return Promise.reject("Please provide an Element")}var t=s.getFlexControllerInstance(e.element);e.appComponent=s.getAppComponentForSelector(e.element);if(!e.modifier){e.modifier=r}return o.applyChangeOnControl(e.change,e.element,n(e,["element","change"])).then(function(n){var r=t.getOpenDependentChangesForControl(e.change.getSelector(),e.appComponent);if(r.length>0){return C.revert({change:e.change,element:e.element}).then(function(){var n=u.getLibraryResourceBundle("sap.ui.fl");var t=r.map(function(e){return e.getId()}).join(", ");throw Error(n.getText("MSG_DEPENDENT_CHANGE_ERROR",[e.change.getId(),t]))})}return n})},revert:function(e){var n;var t=[];if(e.element instanceof c){n=s.getAppComponentForSelector(e.element)}var a={modifier:r,appComponent:n};if(!Array.isArray(e.change)){return l.revertChangeOnControl(e.change,e.element,a)}var i=e.change.slice(0).reverse();return i.reduce(function(n,r){return n.then(function(){return l.revertChangeOnControl(r,e.element,a).then(function(e){t.unshift(e)})})},Promise.resolve()).then(function(){return t})},getChangeHandler:function(e){var n=e.controlType||e.modifier.getControlType(e.element);return h.getChangeHandler(e.changeType,n,e.element,e.modifier,e.layer)}};return C});