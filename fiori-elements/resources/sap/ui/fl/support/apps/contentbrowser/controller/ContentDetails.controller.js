/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Dialog","sap/m/Text","sap/m/Button","sap/m/Input","sap/ui/fl/support/apps/contentbrowser/lrepConnector/LRepConnector","sap/ui/fl/support/apps/contentbrowser/utils/DataUtils","sap/ui/fl/Layer","sap/m/library","sap/ui/model/json/JSONModel","sap/ui/core/UIComponent"],function(e,t,n,a,i,o,s,r,l,c,d){"use strict";var u=l.ButtonType;return e.extend("sap.ui.fl.support.apps.contentbrowser.controller.ContentDetails",{oSelectedContentModel:undefined,oDataUtils:s,onInit:function(){this._initAndBindSelectedContentModel();var e=d.getRouterFor(this);e.getRoute("ContentDetails").attachMatched(this._onRouteMatched,this);e.getRoute("ContentDetailsFlip").attachMatched(this._onRouteMatched,this)},_initAndBindSelectedContentModel:function(){this.oSelectedContentModel=new c;this.getView().setModel(this.oSelectedContentModel,"selectedContent")},_onRouteMatched:function(e){var t=this;var n=e.getParameter("arguments");var a={};a.layer=n.layer;a.namespace=decodeURIComponent(n.namespace);a.fileName=n.fileName;a.fileType=n.fileType;if(a.namespace[a.namespace.length-1]!=="/"){a.namespace+="/"}var i=a.namespace+a.fileName+"."+a.fileType;var s=t.getView().getContent()[0];s.setBusy(true);return o.getContent(a.layer,i,null,null,true).then(t._onContentReceived.bind(t,a,s,i),function(){s.setBusy(false)})},_onContentReceived:function(e,t,n,a){var i=this;e.data=s.formatData(a,e.fileType);if(e.fileType){return o.getContent(e.layer,n,true).then(i._onContentMetadataReceived.bind(i,e,t),function(){t.setBusy(false)})}return Promise.resolve()},_onContentMetadataReceived:function(e,t,n){e.metadata=n;this.oSelectedContentModel.setData(e);e.metadata.some(function(e){if(e.name==="layer"){if(e.value==="CUSTOMER"){this.getView().byId("activeVersionCheckBox").setVisible(true)}else{this.getView().byId("activeVersionCheckBox").setVisible(false)}return true}}.bind(this));var a=sap.ui.getCore();var i=this.getView().createId("contentDetailsIconTabBar");var o=a.byId(i);if(o){var s=o.getItems()[0];if(o.getSelectedKey()!==s.getId()){o.setSelectedItem(s)}}t.setBusy(false)},onEditClicked:function(){var e=this.getView().getModel("selectedContent");var t=e.getData();var n=d.getRouterFor(this);n.navTo("ContentDetailsEdit",{layer:t.layer,namespace:encodeURIComponent(t.namespace),fileName:t.fileName,fileType:t.fileType})},onDeleteClicked:function(){var e=this;var i=new t({title:"{i18n>confirmDeletionTitle}",type:"Message",content:new n({text:"{i18n>questionFileDeletion}"}),beginButton:new a({text:"{i18n>confirm}",type:u.Reject,press:function(){i.close();e._selectTransportAndDeleteFile()}}),endButton:new a({text:"{i18n>cancel}",press:function(){i.close()}}),afterClose:function(){i.destroy()}});this.getView().addDependent(i);i.open()},_selectTransportAndDeleteFile:function(){var e=this;var o=this.getView().getModel("selectedContent");var s=this.getView().byId("activeVersionCheckBox").getSelected();var l=o.getData();var c=l.layer;var d="";var p;var f;var m;l.metadata.some(function(e){if(e.name==="layer"){d=e.value;return true}});l.metadata.some(function(e){if(e.name==="transportId"){p=e.value;return true}});try{f=JSON.parse(l.data).packageName}catch(e){}var v=l.namespace;var h=l.fileName;var C=l.fileType;if(d===r.USER||d==="LOAD"||d==="VENDOR_LOAD"||!p&&(!f||f==="$TMP")){m=undefined;e._deleteFile(d,v,h,C,m,c,s)}else if(p==="ATO_NOTIFICATION"){m=p;e._deleteFile(d,v,h,C,m,c,s)}else{var y=new i({placeholder:"Transport ID or ATO_NOTIFICATION"});var g=new t({title:"{i18n>transportInput}",type:"Message",content:[new n({text:"{i18n>transportInputDescription}"}),y],beginButton:new a({text:"{i18n>confirm}",type:u.Accept,press:function(){m=y.getValue();g.close();e._deleteFile(d,v,h,C,m,c)}}),endButton:new a({text:"{i18n>cancel}",press:function(){g.close()}}),afterClose:function(){g.destroy()}});this.getView().addDependent(g);g.open()}},_deleteFile:function(e,t,n,a,i,s,r){return o.deleteFile(e,t,n,a,i,r).then(function(){var e=d.getRouterFor(this);e.navTo("LayerContentMaster",{layer:s,namespace:encodeURIComponent(t)})}.bind(this))}})});