/*!
* OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/changes/ExtensionPointState","sap/ui/fl/Utils","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/base/SyncPromise","sap/base/util/merge","sap/ui/core/Configuration"],function(n,e,t,i,o,r,a,s){"use strict";var u;function f(n,e,t,i,o){return o(n,true).then(function(o){o.forEach(function(n,o){e.splice(t+o+i,0,n)});n.index+=i;return o.length-1})}function l(n,e,t){var i=[];var o=[];var a=0;var s;t.forEach(function(t,r){if(t._isExtensionPoint){t.targetControl=n.targetControl;t.aggregationName=n.aggregationName;t.fragmentId=n.fragmentId;t.index=r;if(s){s._nextSibling=t}s=t;t.referencedExtensionPoint=n;i.push(function(){return f(t,o,r,a,e).then(function(n){a+=n})})}else{o.push(t)}});if(i.length>0){return i.reduce(function(n,e){return n.then(e)},r.resolve()).then(function(){return o})}return r.resolve(o)}function g(n,r){var s=i.getAppComponentForControl(n.targetControl);var f={};var l=a({defaultContent:[]},n);f.appComponent=s;f.modifier=o;f.viewId=n.view.getId();f.componentId=s.getId();return u.registerExtensionPoint(l).then(e.initialize.bind(e,f)).then(t.enhanceExtensionPointChanges.bind(t,f,n)).then(u.createDefaultContent.bind(this,n,r,g)).then(u.addDefaultContentToExtensionPointInfo.bind(this,l,r))}u={oExtensionPointRegistry:undefined,oRegistryPromise:Promise.resolve(),registerExtensionPoint:function(n){if(s.getDesignMode()){if(u.oExtensionPointRegistry){u.oExtensionPointRegistry.registerExtensionPoint(n);return r.resolve()}u.oRegistryPromise=u.oRegistryPromise.then(function(){return new Promise(function(e,t){sap.ui.require(["sap/ui/fl/write/_internal/extensionPoint/Registry"],function(t){u.oExtensionPointRegistry=t;t.registerExtensionPoint(n);e()},function(n){t(n)})})});return u.oRegistryPromise}return r.resolve()},createDefaultContent:function(n,e,t,i){if(i.length===0){return n.createDefault().then(l.bind(undefined,n,t)).then(function(t){if(!e){t.forEach(function(e,t){o.insertAggregation(n.targetControl,n.aggregationName,e,n.index+t,n.view)});n.ready(t)}return t})}return r.resolve([])},addDefaultContentToExtensionPointInfo:function(n,e,t){if(!e){n.defaultContent=n.defaultContent.concat(t)}return t},applyExtensionPoint:function(e){var t=g(e,false);n.addPreConditionForInitialChangeApplying(t);return t}};return u});