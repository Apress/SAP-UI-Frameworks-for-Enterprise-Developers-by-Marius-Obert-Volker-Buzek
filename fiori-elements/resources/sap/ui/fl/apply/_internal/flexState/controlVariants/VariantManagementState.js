/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,t,n,a,r,i,c,f,o,s,u,g){"use strict";var l={};var v={};function d(e){var t=[];if(e.variantData.instance.getVariantReference()){t=l.getControlChangesForVariant(Object.assign(e,{vReference:e.variantData.instance.getVariantReference()}));return t.filter(function(t){return u.compareAgainstCurrentLayer(t.getLayer(),e.variantData.instance.getLayer())===-1})}return t}function p(e){var t=l.getContent(e.reference);var n=r.get([e.vmReference,"variants"],t);return n||[]}function C(e,t,n){var a=t.changeType;if(!e){e={}}if(!e[a]){e[a]=[]}if(n){e[a].push(t);return true}return e[a].some(function(n,r){if(n.fileName===t.fileName){e[a].splice(r,1);return true}})}function m(e,t){var n=S(e);t[n].push(e)}function h(e,t){var n=S(e);var a=-1;t[n].some(function(t,n){if(t.fileName===e.fileName){a=n;return true}});if(a>-1){t[n].splice(a,1)}}function V(e,t){var n=S(e);t[n]=t[n].map(function(t){return e.fileName===t.fileName?e:t})}function S(e){switch(e.fileType){case"change":return"variantDependentControlChanges";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";default:}}l.addUpdateStateListener=function(e,t){v[e]=t};l.removeUpdateStateListener=function(e){delete v[e]};l.getContent=function(e){return s.getVariantsState(e)};l.addFakeStandardVariant=function(e,t,n){s.setFakeStandardVariant(e,t,n)};l.clearFakedStandardVariants=function(e,t){s.resetFakedStandardVariants(e,t)};l.getControlChangesForVariant=function(e){var t=[];var n=l.getVariant(e);if(n){t=n.controlChanges.filter(function(t){return e.includeDirtyChanges!==false||t.getState()===o.LifecycleState.PERSISTED})}return t};l.getVariantChangesForVariant=function(e){var t=l.getVariant(e);return t&&t.variantChanges||{}};l.getVariant=function(e){var t;var n=l.getContent(e.reference);e.vReference=e.vReference||n[e.vmReference].defaultVariant;var a=p(e);a.some(function(n){if(n.instance.getId()===e.vReference){t=n;return true}});return t};l.getCurrentVariantReference=function(e){var t=l.getContent(e.reference);var n=t[e.vmReference];return n.currentVariant||n.defaultVariant};l.getVariantManagementReferences=function(e){var t=l.getContent(e);return Object.keys(t)};l.addVariantToVariantManagement=function(e){var t=l.getContent(e.reference);var n=t[e.vmReference].variants.slice().splice(1);var a=f.getIndexToSortVariant(n,e.variantData);if(e.variantData.instance.getVariantReference()){var r=d(e);e.variantData.controlChanges=r.concat(e.variantData.controlChanges)}t[e.vmReference].variants.splice(a+1,0,e.variantData);return a+1};l.removeVariantFromVariantManagement=function(e){var t;var n=l.getContent(e.reference);var a=n[e.vmReference].variants.some(function(n,a){if(n.instance.getId()===e.variant.getId()){t=a;return true}});if(a){n[e.vmReference].variants.splice(t,1)}return t};l.setVariantData=function(e){var t=l.getContent(e.reference);var n=t[e.vmReference].variants;var a=n[e.previousIndex];if(a.instance.getId()!==e.vmReference){n.splice(e.previousIndex,1);var r=f.getIndexToSortVariant(n.slice(1),a);n.splice(r+1,0,a);return r+1}n.splice(e.previousIndex,1,a);return e.previousIndex};l.addChangeToVariant=function(e){var t=l.getControlChangesForVariant(e);var a=t.map(function(e){return e.getId()});if(!n(a,e.change.getId())){var r=l.getVariant(e);r.controlChanges=t.concat([e.change]);return true}return false};l.removeChangeFromVariant=function(e){var t=l.getControlChangesForVariant(e);var n=l.getVariant(e);var a=false;if(n){n.controlChanges=t.filter(function(t){if(!a&&t.getId()===e.change.getId()){a=true;return false}return true})}return a};l.getInitialChanges=function(e){var t=l.getContent(e.reference);return Object.keys(t).reduce(function(n,a){if(e.vmReference&&e.vmReference===a||!e.vmReference){var r=t[a].currentVariant?"currentVariant":"defaultVariant";var i=Object.assign({},e,{vmReference:a,vReference:t[a][r],includeDirtyChanges:false});return n.concat(l.getControlChangesForVariant(i))}return n},[])};l.fillVariantModel=function(e){var t=l.getContent(e.reference);return Object.keys(t).reduce(function(n,a){n[a]={defaultVariant:t[a].defaultVariant,variants:[]};if(t[a].currentVariant){n[a].currentVariant=t[a].currentVariant}p(Object.assign(e,{vmReference:a})).forEach(function(e,t){var r=e.instance;n[a].variants[t]=JSON.parse(JSON.stringify({key:r.getId(),title:r.getName(),layer:r.getLayer(),favorite:r.getFavorite(),executeOnSelect:r.getExecuteOnSelection(),visible:r.getVisible(),author:r.getSupportInformation().user,contexts:r.getContexts()}))});return n},{})};l.updateChangesForVariantManagementInMap=function(e){var t=l.getContent(e.reference);var n=t[e.vmReference];if(e.changeContent.fileType==="ctrl_variant_change"){n.variants.some(function(t){if(t.instance.getId()===e.changeContent.selector.id){C(t.variantChanges,e.changeContent,e.add)}})}else if(e.changeContent.fileType==="ctrl_variant_management_change"){C(n.variantManagementChanges,e.changeContent,e.add)}};l.setCurrentVariant=function(e){var t=l.getContent(e.reference);if(r.get([e.vmReference],t)){t[e.vmReference].currentVariant=e.newVReference}};l.updateVariantsState=function(e){var t=l.getContent(e.reference);if(a(t)){i.error("Variant state is not initialized yet");return}var n=s.getFlexObjectsFromStorageResponse(e.reference);if(e.changeToBeAddedOrDeleted){var r=e.changeToBeAddedOrDeleted.convertToFileContent();switch(e.changeToBeAddedOrDeleted.getState()){case o.LifecycleState.NEW:m(r,n);e.changeToBeAddedOrDeleted.setState(o.LifecycleState.PERSISTED);break;case o.LifecycleState.DELETE:h(r,n);break;case o.LifecycleState.DIRTY:V(r,n);e.changeToBeAddedOrDeleted.setState(o.LifecycleState.PERSISTED);break;default:}if(v[e.reference]){v[e.reference]()}}};l.waitForInitialVariantChanges=function(e){var t=l.getInitialChanges({vmReference:e.vmReference,reference:e.reference});var n=t.reduce(function(t,n){var a=n.getSelector();var r=c.bySelector(a,e.appComponent);if(r&&g.indexOfObject(t,{selector:r})===-1){t.push({selector:r})}return t},[]);return n.length?e.flexController.waitForChangesToBeApplied(n):Promise.resolve()};return l});