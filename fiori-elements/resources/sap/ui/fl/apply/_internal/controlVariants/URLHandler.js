/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/Utils","sap/base/Log","sap/base/util/deepEqual","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher","sap/base/util/includes","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState"],function(e,a,r,t,n,o,i,s,l,p,m,c){"use strict";var d={};var u={};function f(e,a){var r=[];return e.reduce(function(e,t){var n=a.getVariantManagementReference(t).variantManagementReference;if(n){if(p(r,n)){e.updateRequired=true;return e}r.push(n)}if(n&&a.oData[n].currentVariant!==t){e.updateRequired=true;if(a.oData[n].currentVariant!==a.oData[n].defaultVariant){e.parameters.push(a.oData[n].currentVariant)}}else{e.parameters.push(t)}return e},{updateRequired:false,parameters:[]})}function v(e,a){var r=o.get(["params",m.VARIANT_TECHNICAL_PARAMETER],e);if(r){var t=f(r,a);if(t.updateRequired){u.update({updateURL:!a._bDesignTimeMode,parameters:t.parameters,updateHashEntry:true,model:a})}}}function A(e,a){try{var t=e.getUShellService("URLParsing");if(t){var n=t.parseShellHash(a);v(n,e)}}catch(e){r.error(e.message)}var o=e.getUShellService("ShellNavigation");return o&&o.NavigationFilterStatus.Continue}function h(e){var a=e.getUShellService("ShellNavigation");if(!d[e.sFlexReference]){d[e.sFlexReference]=A.bind(null,e);if(a){a.registerNavigationFilter(d[e.sFlexReference])}}}function R(e){var a=e.getUShellService("ShellNavigation");if(a){a.unregisterNavigationFilter(d[e.sFlexReference]);delete d[e.sFlexReference]}}function g(e){var a=e.model;var n=a.getUShellService("URLParsing");var o=a.getUShellService("CrossApplicationNavigation");var i=n&&n.parseShellHash(l.getHash());if(i&&i.params){var s=Object.assign({},i.params);var p=a.oAppComponent&&a.oAppComponent.getComponentData&&a.oAppComponent.getComponentData()&&a.oAppComponent.getComponentData().technicalParameters;if(!p){r.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged")}if(e.parameters.length===0){delete i.params[m.VARIANT_TECHNICAL_PARAMETER];p&&delete p[m.VARIANT_TECHNICAL_PARAMETER]}else{i.params[m.VARIANT_TECHNICAL_PARAMETER]=e.parameters;p&&(p[m.VARIANT_TECHNICAL_PARAMETER]=e.parameters)}if(e.silent){l.changed.active=false;l.replaceHash(n.constructShellHash(i));l.changed.active=true}else if(!t(s,i.params)){o.toExternal({target:{semanticObject:i.semanticObject,action:i.action,context:i.contextRaw},params:i.params,appSpecificRoute:i.appSpecificRoute,writeHistory:false})}}}function C(e){var a={index:-1};var r=e.model;var t=r.getUShellService("URLParsing");var o=t&&t.parseShellHash(l.getHash()).params;if(o){a.parameters=[];if(r._bDesignTimeMode){o[m.VARIANT_TECHNICAL_PARAMETER]=u.getStoredHashParams(e)}if(Array.isArray(o[m.VARIANT_TECHNICAL_PARAMETER])){o[m.VARIANT_TECHNICAL_PARAMETER]=o[m.VARIANT_TECHNICAL_PARAMETER].map(decodeURIComponent);o[m.VARIANT_TECHNICAL_PARAMETER].some(function(t,n){var o=c.getVariant({vmReference:e.vmReference,vReference:t,reference:r.oChangePersistence.getComponentName()});if(o){a.index=n;return true}})}}return n(a,o&&o[m.VARIANT_TECHNICAL_PARAMETER]&&{parameters:o[m.VARIANT_TECHNICAL_PARAMETER]})}function E(e){var a=e.getUShellService("URLParsing");var r=a&&a.parseShellHash(l.getHash());return r&&r.params&&r.params[m.VARIANT_TECHNICAL_PARAMETER]}u.variantTechnicalParameterName="sap-ui-fl-control-variant-id";u.initialize=function(e){var a=e.model;var r=a.getUShellService("URLParsing");var t=r&&r.parseShellHash(l.getHash());var n=t&&t.params&&t.params[m.VARIANT_TECHNICAL_PARAMETER];u.attachHandlers(e);u.update({model:a,parameters:n,updateHashEntry:Array.isArray(n)&&n.length>0});v(t,a)};u.updateVariantInURL=function(e){var a=u.removeURLParameterForVariantManagement(e);if(!a.parameters){return}var r=a.parameters||[];var t=a.index;var n=e.newVReference===e.model.oData[e.vmReference].defaultVariant;if(!n){if(t===-1){r=r.concat([e.newVReference])}else{r=r.slice(0,t).concat([e.newVReference],r.slice(t))}}if(!n||t>-1){u.update({parameters:r,updateURL:!e.model._bDesignTimeMode,updateHashEntry:true,model:e.model})}};u.removeURLParameterForVariantManagement=function(e){var a=C(e);if(a.index>-1){a.parameters.splice(a.index,1)}return a};u.attachHandlers=function(a){function r(){return a.model._oVariantSwitchPromise.then(function(){a.model._oHashData.controlPropertyObservers.forEach(function(e){e.destroy()});R(a.model);a.model.destroy();a.model.oComponentDestroyObserver.unobserve(a.model.oAppComponent,{destroy:true});a.model.oComponentDestroyObserver.destroy()})}h(a.model);if(!a.model.oComponentDestroyObserver&&a.model.oAppComponent instanceof e){a.model.oComponentDestroyObserver=new s(r.bind(null));a.model.oComponentDestroyObserver.observe(a.model.oAppComponent,{destroy:true})}};u.registerControl=function(e){if(e.updateURL){e.model._oHashData.variantControlIds.push(e.vmReference)}};u.update=function(e){if(!e.model._oHashData){e.model._oHashData={hashParams:[],controlPropertyObservers:[],variantControlIds:[]}}if(!e||!Array.isArray(e.parameters)){r.info("Variant URL parameters could not be updated since invalid parameters were received");return}if(e.updateURL){g(e)}if(e.updateHashEntry&&!i(e.model)){e.model._oHashData.hashParams=e.parameters}};u.getStoredHashParams=function(e){return Array.prototype.slice.call(e.model._oHashData.hashParams)};u.handleModelContextChange=function(e){var a="modelContextChange";function r(a,r){var t=r.model.getVariantManagementReferenceForControl(a.getSource());var n=r.model._oHashData.variantControlIds;var o=n.indexOf(t);if(o>-1){n.slice(o).forEach(function(a){if(C({vmReference:a,model:e.model}).index===-1){r.model.switchToDefaultForVariantManagement(a)}})}}var t=new s(function(t){if(t.current===true&&t.old===false){t.object.attachEvent(a,{model:e.model},r)}else if(t.current===false&&t.old===true){t.object.detachEvent(a,r)}});t.observe(e.vmControl,{properties:["resetOnContextChange"]});e.model._oHashData.controlPropertyObservers.push(t);if(e.vmControl.getResetOnContextChange()!==false){e.vmControl.attachEvent(a,{model:e.model},r)}};u.clearAllVariantURLParameters=function(e){if(E(e.model)){u.update({updateURL:true,parameters:[],updateHashEntry:false,model:e.model})}};return u});