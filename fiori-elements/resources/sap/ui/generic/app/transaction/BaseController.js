/*
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/base/EventProvider","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/DraftUtil","sap/ui/generic/app/util/Queue","sap/base/Log"],function(e,t,r,o,s){"use strict";var n=e.extend("sap.ui.generic.app.transaction.BaseController",{metadata:{publicMethods:["hasClientMessages","triggerSubmitChanges","attachFatalError","detachFatalError","destroy"]},constructor:function(a,u,i){if(!a){throw new Error("No model")}if(a.bUseBatch==false){s.error("sap.ui.generic.app.transaction.BaseController: Only ODataModel with batch mode enabled are supported!");n.prototype.NonBatchEventHandlers={};a.attachRequestCompleted(function(e){var t=e.getParameters().ID;var r=n.prototype.NonBatchEventHandlers[t];if(r&&e.getParameters().success){r.success();delete n.prototype.NonBatchEventHandlers[t]}else if(r&&!e.getParameters().success){r.error();delete n.prototype.NonBatchEventHandlers[t]}})}e.apply(this,arguments);this.sName="sap.ui.generic.app.transaction.BaseController";this._oModel=a;this._oMeta=a.getMetaModel();this._oDraftUtil=new r;this._oModelUtil=new t(a);if(u){this._oQueue=u}else{this._oQueue=new o;this._bOwnsQueue=true}if(i){this._oDraftMergeTimer=i}else{this._oDraftMergeTimer={nTimeoutID:null}}this._initCounts()}});n.prototype.attachFatalError=function(e,t){this.attachEvent("fatalError",e,t)};n.prototype.detachFatalError=function(e,t){this.detachEvent("fatalError",e,t)};n.prototype._prepareCallAction=function(e,r,o){var s,n,a,u,i;if(!e){throw new Error("Invalid Function Import")}o.urlParameters=o.urlParameters||{};o.functionImport=this._oMeta.getODataFunctionImport(e.split("/")[1]);if(!o.functionImport){throw new Error("Unknown Function Import "+e)}if(r){u=t.getEntitySetFromContext(r);s=this._oMeta.getODataEntitySet(u,false);n=this._oMeta.getODataEntityType(s.entityType,false);i=n.key.propertyRef;a=r.getObject()}if(a){this._getActionParameters(a,o,i);this._getAdditionalActionParameters(a,o,i);this._getActionRequestHeaders(r,a,o)}return o};n.prototype._callAction=function(e,t,r){var o=this;if(!r.urlParameters||!r.functionImport){r=this._prepareCallAction(e,t,r)}return new Promise(function(e,t){var s,n;s="/"+r.functionImport.name;n=o._getRequestCallbacks(e,t);o._oModel.callFunction(s,{method:r.functionImport.httpMethod,urlParameters:r.urlParameters,success:n.success,error:n.error,batchGroupId:r.batchGroupId,changeSetId:r.changeSetId,headers:r.headers,expand:r.expand})})};n.prototype._createFunctionContext=function(e,t){var r={};var o;var s;var n=this;r.result=new Promise(function(e,t){o=n._getRequestCallbacks(e,t)});this._getActionRequestHeaders(e,e.getObject(),t);s=this._oModel.callFunction("/"+t.functionImport.name,{method:t.functionImport.httpMethod,urlParameters:t.urlParameters,success:o.success,error:o.error,batchGroupId:t.batchGroupId,changeSetId:t.changeSetId,headers:t.headers,eTag:n._oModel.getETag(e.getPath()),expand:t.expand});r.context=s.contextCreated();r.abort=s.abort;return r};n.prototype._getActionRequestHeaders=function(e,t,r){var o;if(!r.headers){r.headers={}}if(!r.headers["If-Match"]&&r.functionImport["sap:action-for"]){o=this._oModel.getETag(null,e,t);if(o){r.headers["If-Match"]=o}}};n.prototype._getActionParameters=function(e,t,r){var o,n,a=r.length,u={},i;i=t.functionImport["sap:action-for"];n=function(e){if(t.functionImport.parameter){var r,o=t.functionImport.parameter.length;for(r=0;r<o;r++){if(t.functionImport.parameter[r].name===e){return true}}}return false};if(!t.functionImport.parameter&&i){s.error("Action doesn't have any parameters");throw new Error("Action doesn't have any parameters")}for(o=0;o<a;o++){if(n(r[o].name)){t.urlParameters[r[o].name]=e[r[o].name]}else if(i&&(r[o].name!="IsActiveEntity"||r[o].name!="DraftUUID")){s.error("Action does not contain a equally-named parameter for key property: "+r[o].name);throw new Error("Action does not contain a equally-named parameter for key property: "+r[o].name)}}return u};n.prototype._getAdditionalActionParameters=function(e,t,r){var o,n=0,a;var u=function(e){var t=0,o=r.length;for(t=0;t<o;t++){if(r[t].name===e){return true}}return false};if(t.functionImport.parameter){n=t.functionImport.parameter.length}if(n>r.length){for(o=0;o<n;o++){a=t.functionImport.parameter[o];if(!u(a.name)){var i=a.nullable==="true"?true:false;if(!t.urlParameters.hasOwnProperty(a.name)&&!i){s.error("Unknown parameter "+a.name);throw new Error("Unknown parameter "+a.name)}}}}};n.prototype._read=function(e,t,r){var o=this;var s,n;if(t.readParameters){n=t.readParameters}else if(t.urlParameters){n=t.urlParameters}if(r){return o._oModel.requestSideEffects(t.context,{groupId:t.batchGroupId,urlParameters:n})}return new Promise(function(r,a){s=o._getRequestCallbacks(r,a);o._oModel.read(e,{context:t.context,success:s.success,error:s.error,batchGroupId:t.batchGroupId,changeSetId:t.changeSetId,urlParameters:n})})};n.prototype._remove=function(e,t){var r=this;return new Promise(function(o,s){var n=r._getRequestCallbacks(o,s);r._oModel.remove(e,{success:n.success,error:n.error,eTag:"*",batchGroupId:t.batchGroupId,changeSetId:t.changeSetId,headers:t.headers})})};n.prototype._syncRemove=function(e,t,r,o){var s=this._getRequestCallbacks(r,o);return this._oModel.remove(e,{success:s.success,error:s.error,eTag:"*",batchGroupId:t.batchGroupId,changeSetId:t.changeSetId})};n.prototype._submitChanges=function(e){var t=this;if(!this._checkSubmit(e)){return Promise.resolve({context:e&&e.context})}if(this._oModel.bUseBatch==true){return new Promise(function(r,o){var s=t._getRequestCallbacks(r,o);t._oModel.submitChanges({batchGroupId:e.batchGroupId,success:s.success,error:s.error,eTag:e.eTag})})}else{return new Promise(function(r,o){var s=t._getRequestCallbacks(r,o);if(e.batchGroupId&&this._oModel.mDeferredRequests&&this._oModel.mDeferredRequests[e.batchGroupId]&&this._oModel.mDeferredRequests[e.batchGroupId].changes){var a=this._oModel.mDeferredRequests[e.batchGroupId].changes[e.changeSetId]||[];for(var u=0;u<a.length;u++){if(a[u].request._aborted==undefined||a[u].request._aborted==false){n.prototype.NonBatchEventHandlers[a[u].request.requestID]={success:s.success,error:s.error}}}}if(e.batchGroupId&&this._oModel.mDeferredRequests&&this._oModel.mDeferredRequests[e.batchGroupId]&&this._oModel.mDeferredRequests[e.batchGroupId].requests){var i=this._oModel.mDeferredRequests[e.batchGroupId].requests;for(var u=0;u<i.length;u++){if(i[u].request._aborted==undefined||i[u].request._aborted==false){n.prototype.NonBatchEventHandlers[i[u].request.requestID]={success:s.success,error:s.error}}}}t._oModel.submitChanges({batchGroupId:e.batchGroupId,eTag:e.eTag})}.bind(this))}};n.prototype._checkSubmit=function(e){if(this._oModel.hasPendingChanges()){e.pendingChanges=true;return true}if(e.forceSubmit&&e.forceSubmit==true){if(e.batchGroupId&&this._oModel.mDeferredRequests&&this._oModel.mDeferredRequests[e.batchGroupId]&&this._oModel.mDeferredRequests[e.batchGroupId].changes){var t=this._oModel.mDeferredRequests[e.batchGroupId].changes;var r=[];var o=[];var s;for(var n in t){if(t.hasOwnProperty(n)){r.push(n)}}for(var a=0;a<r.length;a++){s=this._oModel.mDeferredRequests[e.batchGroupId].changes[r[a]]||[];o=o.concat(s)}for(var a=0;a<o.length;a++){if(o[a].request._aborted==undefined||o[a].request._aborted==false){return true}}}if(e.batchGroupId&&this._oModel.mDeferredRequests&&this._oModel.mDeferredRequests[e.batchGroupId]&&this._oModel.mDeferredRequests[e.batchGroupId].requests){var u=this._oModel.mDeferredRequests[e.batchGroupId].requests||[];for(var a=0;a<u.length;a++){if(u[a].request._aborted==undefined||u[a].request._aborted==false){return true}}}}return false};n.prototype.triggerSubmitChanges=function(e){var t=this,r,o;e=e||{};e.successMsg=e.successMsg||"Action succeeded";e.failedMsg=e.failedMsg||"Action failed";o=function(e){t.fireEvent("fatalError",{response:e});throw e};if(this._oDraftMergeTimer.nTimeoutID){clearTimeout(this._oDraftMergeTimer.nTimeoutID);this._oDraftMergeTimer.nTimeoutID=null}r=function(){return t._submitChanges(e).then(function(r){var s=function(e,r){try{t._checkImplicitError({httpResponse:e,responseData:e.data},r);return t._normalizeResponse({httpResponse:e,responseData:e.data},true)}catch(e){o(e)}};var n;var a;var u=[];if(r&&r.responseData&&r.responseData.__batchResponses){if(r.responseData.__batchResponses.length==1&&r.responseData.__batchResponses[0].__changeResponses&&r.responseData.__batchResponses[0].__changeResponses.length==1){return s(r.responseData.__batchResponses[0].__changeResponses[0],e)}for(var i=0;i<r.responseData.__batchResponses.length;i++){n=r.responseData.__batchResponses[i];if(n.__changeResponses){for(var c=0;c<n.__changeResponses.length;c++){a=n.__changeResponses[c];u.push(s(a,e))}}else{return s(n,e)}}}else{try{t._checkImplicitError(r,e);return t._normalizeResponse(r,true)}catch(e){o(e)}}return u},function(e){var r=t._normalizeError(e);o(r)})};return this._oQueue.enqueue(r,{draftSave:e.draftSave,actionInvokedWithPendingChanges:e.actionInvokedWithPendingChanges})};n.prototype._updateEntity=function(e,t,r){var o=this;return new Promise(function(s,n){var a=o._getRequestCallbacks(s,n);var u={success:a.success,error:a.error,batchGroupId:"changes",changeSetId:"changes"+r};o._oModel.update(e,t,u)})};n.prototype.addOperationToQueue=function(e,t){this._oQueue.enqueue(e,t)};n.prototype.attachBeforeQueueItemProcess=function(e){this._oQueue._attachEvent("beforeQueueItemProcess",e)};n.prototype.detachBeforeQueueItemProcess=function(e){this._oQueue._detachEvent("beforeQueueItemProcess",e)};n.prototype.attachOnQueueCompleted=function(e){this._oQueue._attachEvent("onQueueCompleted",e)};n.prototype.detachOnQueueCompleted=function(e){this._oQueue._detachEvent("onQueueCompleted",e)};n.prototype.attachOnQueueFailed=function(e){this._oQueue._attachEvent("onQueueFailed",e)};n.prototype.detachOnQueueFailed=function(e){this._oQueue._detachEvent("onQueueFailed",e)};n.prototype.hasClientMessages=function(){if(this._oModelUtil.hasClientMessages()){return Promise.reject(new Error("Client messages detected"))}return null};n.prototype._normalizeResponse=function(e,t){if(e&&(e.httpResponse||e.responseData)){return{data:e.responseData,response:e.httpResponse||null,context:t?this._oModelUtil.getContextFromResponse(e.responseData):null}}return e};n.prototype._normalizeError=function(e){if(e&&e.message){return{response:e}}return e};n.prototype._returnPromiseAll=function(e){return Promise.all(e).then(function(e){if(e.length){return e[0]}return e})};n.prototype._atLeastOnePromiseResolved=function(e,t){var r=[];var o=Promise.resolve(null);var s=false;var n=e.length;var a=function(e){if(!t){r.push(e);s=true}else if(n-1>r.length&&t){r.push(e);s=true}};e.forEach(function(e,t){o=o.then(function(){return e}).then(a,function(e){r.push(e)},this)});return o.then(function(){if(s){return Promise.resolve(r)}else{return Promise.reject(r)}})};n.prototype._checkImplicitError=function(e,t){var r,o,s,n=false;if(this._mCounts.requestSent===1&&this._mCounts.requestCompleted===1){n=true}this._initCounts();if(t.pendingChanges&&n){if(e&&e.httpResponse){r=e.httpResponse}if(r&&r.response&&r.response.statusCode){s=parseInt(r.response.statusCode);if(s<200||s>299){o=this._parseError(r);throw this._normalizeError(o)}}}};n.prototype._parseError=function(e){var t={};if(e.message){t.message=e.message}if(e.response){t.statusCode=e.response.statusCode;t.statusText=e.response.statusText;t.headers=e.response.headers;t.responseText=e.response.body}return t};n.prototype._initCounts=function(){this._mCounts={requestSent:0,requestCompleted:0}};n.prototype._getRequestCallbacks=function(e,t){var r=this;this._mCounts.requestSent++;return{success:function(t,o){r._mCounts.requestCompleted++;e({responseData:t,httpResponse:o})},error:function(e){r._mCounts.requestCompleted++;t(e)}}};n.prototype.destroy=function(){if(this._oModelUtil){this._oModelUtil.destroy()}if(this._oQueue&&this._bOwnsQueue){this._oQueue.destroy()}this._oModel=null;this._oMeta=null;this._oDraftUtil=null;this._oModelUtil=null;this._oDraftMergeTimer=null};return n},true);