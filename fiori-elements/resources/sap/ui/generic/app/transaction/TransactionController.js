/*
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./BaseController","./DraftController","sap/ui/generic/app/util/ModelUtil","sap/base/util/extend","sap/base/Log"],function(t,e,r,n,a,o){"use strict";var i=e.extend("sap.ui.generic.app.transaction.TransactionController",{metadata:{publicMethods:["destroy","setBatchStrategy","getDraftController","invokeAction","editEntity","deleteEntity","deleteEntities","propertyChanged","hasClientValidationErrors","resetChanges","getDefaultValues","getDefaultValuesFunction","updateMultipleEntities"]},constructor:function(t,r,n,a){e.apply(this,[t,r,a]);this.sName="sap.ui.generic.app.transaction.TransactionController";this._oDraft=null;n=n||{};if(!n.noBatchGroups){t.setDeferredGroups(["Changes"]);t.setChangeGroups({"*":{groupId:"Changes",changeSetId:"Changes",single:false}})}return this.getInterface()}});i.prototype.setBatchStrategy=function(t){var e,r=this._oModel.getChangeGroups();for(e in r){r[e].single=t}this._oModel.setChangeGroups(r)};i.prototype.getDraftController=function(){if(!this._oDraft){this._oDraft=new r(this._oModel,this._oQueue,this._oDraftMergeTimer)}return this._oDraft};i.prototype.editEntity=function(t,e,r){var a=this;return new Promise(function(o){var i,s;i=a.getDraftController().getDraftContext();s=n.getEntitySetFromContext(t);if(i.isDraftEnabled(s)&&a._oDraftUtil.isActiveEntity(t.getObject())){return o(a.getDraftController().createEditDraftEntity(t,e,r))}return o({context:t})})};i.prototype.deleteEntity=function(e,r,n){var a,o,i=this,s,l,u;if(typeof e=="string"){s=e}else if(typeof e=="object"&&e instanceof sap.ui.model.Context){l=e;s=l.getPath()}r=r||{};t.extend(r,{batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes were discarded",failedMsg:"Discarding of changes failed",forceSubmit:true,context:l});var c=n?"lenient":"strict";r.headers={Prefer:"handling="+c};if(i._oModel.getObject(s)&&i._oDraftUtil.isActiveEntity(i._oModel.getObject(s))!==undefined&&!i._oDraftUtil.isActiveEntity(i._oModel.getObject(s))){if(!l){l=new sap.ui.model.Context(this._oModel,s)}u=i.getDraftController();a=u.discardDraft(l,r)}else{a=this._remove(s,r)}a.then(function(t){return i._normalizeResponse(t,true)},function(t){var e=i._normalizeError(t);throw e});o=this.triggerSubmitChanges(r);return this._returnPromiseAll([a,o])};i.prototype.deleteEntities=function(e,r){var n,a=[],o=this,i,s,l;r=r||{};var u=r.bIsStrict?"strict":"lenient";r.headers=r.headers||{};r.headers.Prefer="handling="+u;t.extend(r,{batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes were discarded",failedMsg:"Discarding of changes failed",forceSubmit:true});var c=function(t){return o._normalizeResponse(t,true)};var h=function(t){var e=o._normalizeError(t);throw e};for(var f=0;f<e.length;f++){s=null;if(typeof e[f]=="string"){i=e[f]}else if(typeof e[f]=="object"&&e[f]instanceof sap.ui.model.Context){s=e[f];i=s.getPath()}if(o._oModel.getObject(i)&&o._oDraftUtil.isActiveEntity(o._oModel.getObject(i))!==undefined&&!o._oDraftUtil.isActiveEntity(o._oModel.getObject(i))){r.changeSetId="Changes";if(!s){s=new sap.ui.model.Context(this._oModel,i)}l=o.getDraftController();n=l.discardDraft(s,r).then(c,h)}else{r.changeSetId="ActiveChanges";n=this._remove(i,r).then(c,h)}a.push(n)}n=this.triggerSubmitChanges(r);a.push(n);return this._atLeastOnePromiseResolved(a,true)};i.prototype.invokeAction=function(t,e,r){var n=this,a,o;a=this.hasClientMessages();if(a){return a}r={batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Call of action succeeded",failedMsg:"Call of action failed",urlParameters:r.urlParameters,forceSubmit:true,context:e};a=this._callAction(t,e,r).then(function(t){return n._normalizeResponse(t,true)},function(t){var e=n._normalizeError(t);throw e});this._oModel.refresh(true,false,"Changes");o=this.triggerSubmitChanges(r);return this._returnPromiseAll([a,o])};i.prototype.resetChanges=function(t){this._oModel.resetChanges(t)};i.prototype.propertyChanged=function(t,e,r){var n,a,o={batchGroupId:"Changes",changeSetId:"Changes",binding:r};n=this.getDraftController().getDraftContext();if(n.checkUpdateOnChange(t,e)){a=r.getBoundContext();if(n.hasDraftPreparationAction(a)){return this.getDraftController().saveAndPrepareDraftEntity(a,o)}o.onlyIfPending=true;return this.triggerSubmitChanges(o)}o.onlyIfPending=true;o.noShowResponse=true;o.noBlockUI=true;return this.triggerSubmitChanges(o)};i.prototype.getDefaultValues=function(t,e,r,i){var s,l,u=t[0];if(!u&&!(u instanceof sap.ui.model.Context)){throw new Error("No context")}var c=n.getEntitySetFromContext(u);if(!c&&c===""){throw new Error("No EntitySet found in the current context")}var h=u.getModel().getMetaModel();var f=h.getODataEntityType(h.getODataEntitySet(c).entityType);if(r){f["navigationProperty"].forEach(function(t){if(t.name===r){s=t}});var g=h.getODataEntityType(h.getODataAssociationEnd(f,r).type);l=g.property}else if(i){s=h.getODataFunctionImport(i);l=s.parameter}else{s=h.getODataEntitySet(c);l=f.property}var d=this.getDefaultValuesFunction(s);if(d){var p=d.split("/")[1];if(t.length>1&&h.getODataFunctionImport(p).parameter){o.error("Parameterised DefaultValuesFunction not to be called with multiple selections");throw new Error("Parameterised DefaultValuesFunction not to be called with multiple selections")}var C={successMsg:"Call of action succeeded",failedMsg:"Call of action failed",urlParameters:null,forceSubmit:true,context:u,headers:{"If-Match":"*"}};var y=this._callAction(d,u,C).then(function(t){if(t.httpResponse.statusCode==="200"){var r=t.responseData[p]||t.responseData;var n={};l.forEach(function(t){if(r.hasOwnProperty(t.name)){n[t.name]=r[t.name]}});var o=[];e.forEach(function(t){var e={};for(var r in t){if(t[r]!==""){e[r]=t[r]}}o.push(a({},e,n))});return o}});var v=this.triggerSubmitChanges(C);return this._returnPromiseAll([y,v])}else{return e}};i.prototype.getDefaultValuesFunction=function(t){var e=t["com.sap.vocabularies.Common.v1.DefaultValuesFunction"];var r=e?"/"+e.String:null;return r};i.prototype.updateMultipleEntities=function(t){var e=[];var r=this;var n=function(t){return r._normalizeResponse(t,true)};var a=function(t){var e=r._normalizeError(t);throw e};for(var o=0;o<t.length;o++){var i=this._updateEntity(t[o].sContextPath,t[o].oUpdateData,o).then(n,a);e.push(i)}return this._atLeastOnePromiseResolved(e)};i.prototype.destroy=function(){e.prototype.destroy.apply(this,[]);if(this._oDraft){this._oDraft.destroy()}this._oDraft=null};return i},true);