/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/comp/library","./Util","./ColumnHelper","sap/base/Log","sap/ui/mdc/p13n/P13nBuilder","sap/ui/model/json/JSONModel"],function(t,e,n,o,a,i,r){"use strict";var s=t.extend("sap.ui.comp.personalization.BaseController",{metadata:{abstract:true,library:"sap.ui.comp",properties:{type:{type:"string",defaultValue:null},itemType:{type:"string",defaultValue:null},ignoreColumnKeys:{type:"object",defaultValue:[]},additionalIgnoreColumnKeys:{type:"object",defaultValue:[]},stableColumnKeys:{type:"string[]",defaultValue:[]},columnHelper:{type:"sap.ui.comp.personalization.ColumnHelper",defaultValue:null},columnKeys:{type:"string[]",defaultValue:[]},tableType:{type:"string",defaultValue:null},messageStrip:{type:"sap.m.MessageStrip"}},associations:{table:{type:"sap.ui.core.Control",multiple:false}},events:{beforePotentialTableChange:{},afterPotentialTableChange:{},afterPotentialModelChange:{parameters:{json:{type:"object"}}}}}});s.prototype.exit=function(){if(this.getModel()){this.getModel().destroy()}if(this._oAdaptationModel){this._oAdaptationModel.destroy();this._oAdaptationModel=null;this.oPanel=null}};s.prototype.setModelFunction=function(){var t=this;return function(){if(!this.getModel("$sapmP13nPanel")){this.setModel(t.getInternalModel(),"$sapmP13nPanel")}}};s.prototype.setTable=function(t){this.setAssociation("table",t);this.setTableType(n.getTableType(this.getTable()));return this};s.prototype.getTable=function(){var t=this.getAssociation("table");if(typeof t==="string"){t=sap.ui.getCore().byId(t)}return t};s.prototype.getColumnMap=function(){return this.getColumnHelper().getColumnMap()};s.prototype.createControlDataStructure=function(t){t=t||[];var e={};e[this.getType()]={};e[this.getType()][this.getItemType()]=t;return e};s.prototype.createColumnKeysStructure=function(t){t=t||[];var e={};e[this.getType()]={};e[this.getType()][this.getItemType()]=t.map(function(t){return{columnKey:t}});return e};s.prototype.checkConsistency=function(){var t=this.getColumnMap();this.getIgnoreColumnKeys().some(function(e){if(t[e]&&t[e].getVisible()){throw"The provided 'ignoreColumnKeys' for '"+this.getType()+"' are inconsistent. No columns specified as ignored is allowed to be visible."}},this);var e=this.getColumnKeys();Object.keys(t).forEach(function(t){if(e.indexOf(t)<0){throw"The provided 'columnKeys' and columns are inconsistent. For the column '"+t+"' no entry in 'columnKeys' exists."}});var n=this.getStableColumnKeys();n.forEach(function(e,n){if(t[e].getIndex()!=n){throw"The provided 'stableColumnKeys' are inconsistens. Please provide 'stableColumnKeys' by ascending indices of the columns, starting from index 0."}})};s.prototype.initializeInternalModel=function(t){["controlDataInitial","controlDataBase","controlData","alreadyKnownRuntimeData","alreadyKnownPersistentData"].forEach(function(e){if(!t.getProperty("/"+e)){t.setProperty("/"+e,{})}t.setProperty("/"+e+"/"+this.getType(),this.createControlDataStructure()[this.getType()])},this);["ignoreData"].forEach(function(e){if(!t.getProperty("/"+e)){t.setProperty("/"+e,{})}t.setProperty("/"+e+"/"+this.getType(),this.createColumnKeysStructure()[this.getType()])},this);["persistentDataChangeType","persistentDeltaDataChangeType"].forEach(function(n){if(!t.getProperty("/"+n)){t.setProperty("/"+n,{})}t.setProperty("/"+n+"/"+this.getType(),e.personalization.ChangeType.Unchanged);t.setProperty("/"+n+"/"+this.getType(),e.personalization.ChangeType.Unchanged)},this);["controlDataReduce","transientData","beforeOpenData","variantDataInitial"].forEach(function(e){if(!t.getProperty("/"+e)){t.setProperty("/"+e,undefined)}});this.setModel(t,"$sapuicomppersonalizationBaseController")};s.prototype._extendPropertyWithControlDataStructure=function(t){var e=this.getInternalModel();if(e.getProperty("/"+t)){return}e.setProperty("/"+t,{});e.setProperty("/"+t+"/"+this.getType(),this.createControlDataStructure()[this.getType()])};s.prototype.getInternalModel=function(){return this.getModel("$sapuicomppersonalizationBaseController")};s.prototype.calculateIgnoreData=function(){var t=this.getIgnoreColumnKeys().concat(this.getAdditionalIgnoreColumnKeys());t=t.filter(function(e,n){return t.indexOf(e)===n});var e=this.createColumnKeysStructure(t);this.setIgnoreData2Model(e)};s.prototype.calculateControlData=function(){var t=n.copy(this.getControlDataBase());this._deselectIgnoreDataFromJson(t);this.setControlData2Model(t)};s.prototype.calculateControlDataReduce=function(){var t=n.copy(this.getControlDataBase());this._removeIgnoreDataFromJson(t);this.setControlDataReduce2Model(t)};s.prototype.calculateTransientData=function(t){t=n.copy(t);this._removeIgnoreDataFromJson(t);this.setTransientData2Model(t)};s.prototype.calculatePersistentChangeTypesFromJson=function(t,n){var o=this.getPersistentDeltaDataChangeType();var a=this.getUnionData(this.getControlDataInitial(),t);o[this.getType()]=this.getChangeType(a,this.getAlreadyKnownPersistentData());this.setPersistentDeltaDataChangeType(o);o=this.getPersistentDataChangeType();if(n===e.personalization.ResetType.ResetFull){o[this.getType()]=this.getChangeType(t,this.getControlDataInitial())}else if(n===e.personalization.ResetType.ResetPartial){o[this.getType()]=this.getChangeType(t,this.getVariantDataInitial())}this.setPersistentDataChangeType(o)};s.prototype._removeIgnoreDataFromJson=function(t){if(!this.getIgnoreData()[this.getType()]){return}this.getIgnoreData()[this.getType()][this.getItemType()].forEach(function(e){var o=n.getIndexByKey("columnKey",e.columnKey,t[this.getType()][this.getItemType()]);if(o>-1){t[this.getType()][this.getItemType()].splice(o,1)}},this)};s.prototype._deselectIgnoreDataFromJson=function(t){if(!this.getIgnoreData()[this.getType()]){return}this.getIgnoreData()[this.getType()][this.getItemType()].forEach(function(e){var o=n.getIndexByKey("columnKey",e.columnKey,t[this.getType()][this.getItemType()]);if(o>-1){this.handleIgnore(t,o)}},this)};s.prototype.updateControlDataBaseFromJson=function(t){var e=this.getIgnoreData();var o=n.copy(this.getControlDataBase());var a=n.copy(this.getControlDataBase());var i=n.copy(t);o[this.getType()][this.getItemType()]=this.getControlDataBase()[this.getType()][this.getItemType()].filter(function(t){return n.getIndexByKey("columnKey",t.columnKey,e[this.getType()][this.getItemType()])>-1},this);i[this.getType()][this.getItemType()]=t[this.getType()][this.getItemType()].filter(function(t){return n.getIndexByKey("columnKey",t.columnKey,e[this.getType()][this.getItemType()])<0},this);a[this.getType()][this.getItemType()]=i[this.getType()][this.getItemType()];if(this.getType()==="columns"){if(a[this.getType()][this.getItemType()].length!==i[this.getType()][this.getItemType()].length){throw"the updated columns are inconsistent with 'controlDataBase'"}a[this.getType()][this.getItemType()].some(function(t){if(n.getIndexByKey("columnKey",t.columnKey,i[this.getType()][this.getItemType()])<0){throw"the columnKey '"+t.columnKey+"' is not contained in 'controlDataBase'"}},this)}var r=n.copy(this.getControlDataBase());r[this.getType()][this.getItemType()]=a[this.getType()][this.getItemType()].concat(o[this.getType()][this.getItemType()]);Object.keys(r[this.getType()]).forEach(function(e){if(!Array.isArray(r[this.getType()][e])){r[this.getType()][e]=t[this.getType()][e]}},this);this.setControlDataBase2Model(r);this.fireAfterPotentialModelChange({json:r})};s.prototype.extendControlDataInitial=function(t){this._extendData("controlDataInitial",t)};s.prototype.extendControlDataBase=function(t){this._extendData("controlDataBase",t)};s.prototype.extendVariantDataInitial=function(t){this._extendData("variantDataInitial",t)};s.prototype.extendAlreadyKnownRuntimeData=function(t){this._extendData("alreadyKnownRuntimeData",t)};s.prototype.extendAlreadyKnownPersistentData=function(t){this._extendData("alreadyKnownPersistentData",t)};s.prototype._extendData=function(t,e){if(!e||!e[this.getType()]||!this._getInternalModelData(t)){return}var o=n.copy(e);var a=this.getInternalModel();Object.keys(o[this.getType()]).forEach(function(e){if(Array.isArray(o[this.getType()][e])){o[this.getType()][e].forEach(function(o){var i=this._getInternalModelData(t)[this.getType()][e];if(n.getIndexByKey("columnKey",o.columnKey,i)>-1){throw"columnKey '"+o.columnKey+"' does already exist in internal model"}a.setProperty("/"+t+"/"+this.getType()+"/"+e+"/"+i.length+"/",o)},this);return}a.setProperty("/"+t+"/"+this.getType()+"/"+e+"/",o[this.getType()][e])},this)};s.prototype.setControlDataInitial2Model=function(t){this._setModelData("controlDataInitial",t)};s.prototype.setControlDataBase2Model=function(t){this._setModelData("controlDataBase",t)};s.prototype.setControlData2Model=function(t){this._setModelData("controlData",t)};s.prototype.setAlreadyKnownRuntimeData2Model=function(t){this._setModelData("alreadyKnownRuntimeData",t)};s.prototype.setAlreadyKnownPersistentData2Model=function(t){this._setModelData("alreadyKnownPersistentData",t)};s.prototype.setVariantDataInitial2Model=function(t){this._extendPropertyWithControlDataStructure("variantDataInitial");this._setModelData("variantDataInitial",t)};s.prototype.setIgnoreData2Model=function(t){this._setModelData("ignoreData",t)};s.prototype.setPersistentDataChangeType=function(t){this._setModelData("persistentDataChangeType",t)};s.prototype.setPersistentDeltaDataChangeType=function(t){this._setModelData("persistentDeltaDataChangeType",t)};s.prototype.setControlDataReduce2Model=function(t){this._extendPropertyWithControlDataStructure("controlDataReduce");this._setModelData("controlDataReduce",t)};s.prototype.setTransientData2Model=function(t){this._extendPropertyWithControlDataStructure("transientData");this._setModelData("transientData",t)};s.prototype.setBeforeOpenData2Model=function(t){this._extendPropertyWithControlDataStructure("beforeOpenData");this._setModelData("beforeOpenData",t)};s.prototype._setModelData=function(t,e){this.getInternalModel().setProperty("/"+t+"/"+this.getType(),e?n.copy(e)[this.getType()]:undefined)};s.prototype.getControlDataInitial=function(){return this._getInternalModelData("controlDataInitial")};s.prototype.getControlDataBase=function(){return this._getInternalModelData("controlDataBase")};s.prototype.getControlData=function(){return this._getInternalModelData("controlData")};s.prototype.getAlreadyKnownRuntimeData=function(){return this._getInternalModelData("alreadyKnownRuntimeData")};s.prototype.getAlreadyKnownPersistentData=function(){return this._getInternalModelData("alreadyKnownPersistentData")};s.prototype.getVariantDataInitial=function(){return this._getInternalModelData("variantDataInitial")};s.prototype.getIgnoreData=function(){return this._getInternalModelData("ignoreData")};s.prototype.getPersistentDataChangeType=function(){return this._getInternalModelData("persistentDataChangeType")};s.prototype.getPersistentDeltaDataChangeType=function(){return this._getInternalModelData("persistentDeltaDataChangeType")};s.prototype.getControlDataReduce=function(){return this._getInternalModelData("controlDataReduce")};s.prototype.getTransientData=function(){return this._getInternalModelData("transientData")};s.prototype.getBeforeOpenData=function(){return this._getInternalModelData("beforeOpenData")};s.prototype.isEqualAdditionalIgnoreColumnKeys=function(t){var e=this.getAdditionalIgnoreColumnKeys();if(e.length!==t.length){return false}return!e.some(function(e){return t.indexOf(e)<0})};s.prototype._getInternalModelData=function(t){return this.getInternalModel().getProperty("/"+t)};s.prototype.determineMissingColumnKeys=function(t){if(!t||!t[this.getType()]||!t[this.getType()][this.getItemType()]){return this.createColumnKeysStructure()}var e=this.getColumnMap();var o=this.getIgnoreData();var a=t[this.getType()][this.getItemType()].filter(function(t){return!e[t.columnKey]}).filter(function(t){return n.getIndexByKey("columnKey",t.columnKey,o[this.getType()][this.getItemType()])<0},this).map(function(t){return t.columnKey});return this.createColumnKeysStructure(a)};s.prototype.extractIgnoreDataFromJson=function(t){if(!t||!t[this.getType()]||!t[this.getType()][this.getItemType()]){return null}var e=this.getIgnoreData();var o=t[this.getType()][this.getItemType()].filter(function(t){return n.getIndexByKey("columnKey",t.columnKey,e[this.getType()][this.getItemType()])>-1},this);return o.length?this.createControlDataStructure(o):null};s.prototype.getTable2Json=function(t){var e=this.createControlDataStructure();var n=this.getColumnMap();var o=this.getColumnKeys();t[this.getType()][this.getItemType()].forEach(function(t){var i=n[t.columnKey];if(!i){a.warning("Column with columnKey '"+t.columnKey+"' does not exist.");return}var r=this.getColumn2Json(i,t.columnKey,o.indexOf(t.columnKey));if(r){e[this.getType()][this.getItemType()].push(r)}},this);this.getAdditionalData2Json(e,this.getTable());return e};s.prototype.getTable2JsonTransient=function(t){var e=this.createControlDataStructure();var o=this.getColumnMap();var a,i;var r;t[this.getType()][this.getItemType()].forEach(function(t){var n=false;if(this.getType()==="columns"){this.getStableColumnKeys().forEach(function(e){if(e==t.columnKey){n=true}})}var s=o[t.columnKey];if(!s||n){return}if(s.isA("sap.ui.table.Column")){if(!s.getLabel()){throw"The column '"+t.columnKey+"' should have a 'label' aggregation otherwise the column can not be identified in the personalization dialog."}a=s.getLabel().getText();r=s.getTooltip();i=r&&typeof r==="object"&&r.isA("sap.ui.core.TooltipBase")?r.getTooltip_Text():s.getTooltip_Text()}if(s.isA("sap.m.Column")){if(!s.getHeader()){throw"The column '"+t.columnKey+"' should have a 'header' aggregation otherwise the column can not be identified in the personalization dialog."}a=s.getHeader().getText();r=s.getHeader().getTooltip();i=r&&typeof r==="object"&&r.isA("sap.ui.core.TooltipBase")?r.getTooltip_Text():s.getHeader().getTooltip_Text()}if(s.isA("sap.ui.comp.personalization.ColumnWrapper")){if(!s.getLabel()){throw"The column '"+t.columnKey+"' should have a 'label' aggregation otherwise the column can not be identified in the personalization dialog."}a=s.getLabel();r=s.getTooltip();i=r&&typeof r==="object"&&r.isA("sap.ui.core.TooltipBase")?r.getTooltip_Text():s.getTooltip_Text()}var l=this.getColumn2JsonTransient(s,t.columnKey,a,i);if(l){e[this.getType()][this.getItemType()].push(l)}},this);n.sortItemsByText(e[this.getType()][this.getItemType()],"text");return e};s.prototype.getColumn2Json=function(t,e,n){};s.prototype.getAdditionalData2Json=function(t,e){};s.prototype.getColumn2JsonTransient=function(t,e){};s.prototype.handleIgnore=function(t,e){};s.prototype.fixConflictWithIgnore=function(t,e){};s.prototype.syncJson2Table=function(t){};s.prototype.getPanel=function(){};s.prototype.getAdaptationUI=function(){return this.oPanel&&!this.oPanel.bIsDestroyed?this.oPanel:null};s.prototype.retrieveAdaptationUI=function(t){return this.getPanel(t)};s.prototype.getAdaptationData=function(){var t=this.getTransientData();var e=this.getInternalModel().getProperty("/controlDataReduce");var n=e[this.getType()][this.getItemType()].reduce(function(t,e,n){t[e.columnKey]=Object.assign({},e);t[e.columnKey].position=n;return t},{});var o=[];t[this.getType()][this.getItemType()].forEach(function(t,e){o.push(this._transformAdaptationData(n[t.columnKey],t))}.bind(this));this._sortAdaptationData(o);return o};s.prototype._transformAdaptationData=function(t,e){return{position:t?t.position:-1,name:e.columnKey,label:e.text,tooltip:e.tooltip}};s.prototype._sortAdaptationData=function(t){i.sortP13nData({visible:"visible",position:"position"},t)};s.prototype._getPresenceAttribute=function(){return"visible"};s.prototype._getP13nBuilder=function(){return i};s.prototype.getChangeType=function(t,e){};s.prototype.getChangeData=function(t,e){};s.prototype.getUnionData=function(t,e){};s.prototype.getResetWarningText=function(){return undefined};return s});