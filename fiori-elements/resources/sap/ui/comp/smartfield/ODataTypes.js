/*
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/model/SimpleType","sap/ui/core/format/NumberFormat","sap/ui/model/odata/type/Boolean","sap/ui/comp/smartfield/type/Double","sap/ui/comp/smartfield/type/DateTime","sap/ui/comp/odata/type/StringDate","sap/ui/comp/odata/type/FiscalDate","sap/ui/comp/odata/type/NumericText","sap/ui/comp/smartfield/type/DateTimeOffset","sap/ui/model/odata/type/DateTimeWithTimezone","sap/ui/comp/smartfield/type/Decimal","sap/ui/comp/smartfield/type/Int16","sap/ui/comp/smartfield/type/Int32","sap/ui/comp/smartfield/type/Int64","sap/ui/comp/smartfield/type/Byte","sap/ui/comp/smartfield/type/SByte","sap/ui/comp/smartfield/type/String","sap/ui/comp/smartfield/type/TextArrangementString","sap/ui/comp/smartfield/type/TextArrangementGuid","sap/ui/comp/smartfield/type/AbapBool","sap/ui/comp/smartfield/type/Currency","sap/ui/comp/smartfield/type/Time","sap/ui/comp/smartfield/type/Guid","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/odata/FiscalMetadata","sap/ui/comp/smartfield/type/Unit"],function(t,e,r,n,i,a,o,s,p,u,l,m,c,f,y,g,d,h,C,v,D,T,F,_,x,w){"use strict";var S=function(t){this._oParent=t};S.prototype.getType=function(e,v,D,w){w=w||{};var S=this._oParent.getBindingInfo("value"),O=S&&S.binding&&S.binding.getType(),A=w.composite&&O instanceof t;if(O&&!A){return b(O)}if(e&&e.property&&e.property.type){if(!O){D=this.getConstraints(e.property,D);v=this.getFormatOptions(e.property,v)}switch(e.property.type){case"Edm.Boolean":return new r(v,D);case"Edm.Double":return new n(v,D);case"Edm.Decimal":case"Edm.Single":return new l(v,this._getDecimalConstraints(e,D));case"Edm.Int16":return new m(v,D);case"Edm.Int32":return new c(v,D);case"Edm.Int64":return new f(v,D);case"Edm.Byte":return new y(v,D);case"Edm.SByte":return new g(v,D);case"Edm.DateTimeOffset":if(this.isWithTimeZone(e)){return new u(v)}return new p(v,D);case"Edm.DateTime":return new i(v,this._getDateTimeConstraints(e,D));case"Edm.String":if(this.isTimeZone(e)){return new u(v)}if(this.isCalendarDate(e)){return new a(v)}var E=x.getFiscalAnotationType(e.property);if(E){return new o(v,D,{anotationType:E})}if(!O){D=this._getStringConstraints(e)}if(O&&!D){D=O.oConstraints}if(D&&D.isDigitSequence&&!w.composite){return new s(v,D)}if(w.composite){v=Object.assign({},v,this._getTextArrangementFormatOptions());return new h(v,D,this._getTextArrangementOptions(w))}return new d(v,D);case"Edm.Time":return new T(v,D);case"Edm.Guid":var B={},I=this._getTextArrangementFormatOptions();if(_.hasTextArrangementAnnotation(e.property)&&I&&I.textArrangement==="descriptionOnly"){B={validateException:{resourceBundle:"sap.ui.comp",text:"ENTER_AN_EXISTING_DESCRIPTION"}}}if(w.composite){v=Object.assign({},v,this._getTextArrangementFormatOptions());return new C(v,D,this._getTextArrangementOptions(w))}return new F(v,D,B);default:return null}}return null};function b(t){var e=t.parseValue,r=t.destroy;t.parseValue=function(t,r){var n=e.apply(this,arguments);if(typeof this.oFieldControl==="function"){this.oFieldControl(t,r)}return n};t.destroy=function(){r.apply(this,arguments);this.oFieldControl=null};return t}S.prototype.getConstraints=function(t,e){return Object.assign({},e,{nullable:_.isNullable(t),skipDecimalsValidation:_.isSkippingMeasuredQuantityCheck(t)})};S.prototype.getFormatOptions=function(t,e){var r={};if(_.isUpperCase(t)){r.displayFormat="UpperCase"}return Object.assign({},e,r)};S.prototype._getDateTimeConstraints=function(t,e){var r={},n;if(t.property["sap:display-format"]==="Date"||this.isCalendarDate(t)){r={displayFormat:"Date"}}for(n in e){r[n]=e[n]}return r};S.prototype.getMaxLength=function(t,e){var r=[],n,i=0;if(e&&e.constraints){if(e.constraints.maxLength&&e.constraints.maxLength>-1){r.push(e.constraints.maxLength)}}if(e&&e.type&&e.type.oConstraints){if(e.type.oConstraints.maxLength&&e.type.oConstraints.maxLength>-1){r.push(e.type.oConstraints.maxLength)}}if(t&&t.property&&t.property.maxLength){var a=parseInt(t.property.maxLength);if(a>-1){r.push(a)}}var o=this._oParent.getMaxLength();if(o>0){r.push(o)}var s=r.length;while(s--){n=r[s];if(n>0){if(i>0){if(n<i){i=n}}else{i=n}}}return i};S.prototype._getDecimalConstraints=function(t,e){var r=t.property;e=e||{};if(r.precision){e.precision=parseInt(r.precision)}if(r.scale){e.scale=parseInt(r.scale)}if(r["sap:variable-scale"]){e.variableScale=r["sap:variable-scale"]==="true"}return e};S.prototype._getTextArrangementFormatOptions=function(){return{textArrangement:this._oParent.getControlFactory()._getDisplayBehaviourConfiguration()}};S.prototype._getStringConstraints=function(t,e){e=e||{};var r=this._oParent.getBindingInfo("value"),n=this.getMaxLength(t,r),i;if(r&&r.type&&r.type.oConstraints){if(r.type.oConstraints.equals){i=r.type.oConstraints.equals}}if(n>0||i){if(n>0){e.maxLength=n}if(i){e.equals=i}}if(_.isDigitSequence(t.property)){e.isDigitSequence=true}return e};S.prototype._getTextArrangementOptions=function(t){var e=this._oParent.getControlFactory().oTextArrangementDelegate;return{keyField:t.keyField,descriptionField:t.descriptionField,valueListNoValidation:t.valueListNoValidation,valueList:t.valueList,onBeforeValidateValue:e.onBeforeValidateValue.bind(e),delegate:t.delegate}};S.prototype.isCalendarDate=function(t){var e=t.property["com.sap.vocabularies.Common.v1.IsCalendarDate"];if(e&&e.Bool){return e.Bool?e.Bool!=="false":true}return false};S.prototype.isTimeZone=function(t){return t.property["com.sap.vocabularies.Common.v1.IsTimezone"]&&t.property["com.sap.vocabularies.Common.v1.IsTimezone"].Bool!=="false"};S.prototype.isWithTimeZone=function(t){return t.property["com.sap.vocabularies.Common.v1.Timezone"]?true:false};S.prototype.getDisplayFormatter=function(t,e){e=e||{};if(e.currency){return this.getCurrencyDisplayFormatter(e)}else if(e.type&&e.type.oConstraints&&e.type.oConstraints.scale&&t.scale){t.scale=e.type.oConstraints.scale}return this.getUOMDisplayFormatter(t,e)};S.prototype.getCurrencyDisplayFormatter=function(t){var e={showMeasure:false,emptyString:NaN},r;this._enhanceFormatOptions(e);r=new D(e);return function(e,n,i){var a,o,s,p,u,l=this&&this.oParent&&this.oParent.oParent,m=l&&l.isA("sap.ui.comp.smartfield.SmartField")&&l.isFormContextType();if(!e||!n||n==="*"){return""}if(!t.currency){a=e+=" ";return a}if(isNaN(parseFloat(e))){return e.toString()+" "}a=r.formatValue([e,n,i],"string");p=i&&i[n]&&i[n].digits;s=r&&r.oOutputFormat&&r.oOutputFormat.oLocaleData.getCurrencyDigits(n);o=p||s;if(o===0&&!m){a+=" "}u=3-o;if(u&&!m&&a){a=a.padEnd(a.length+u," ")}else{a+=" "}if(t.mask){return S.maskValue(a)}return a}};S.prototype.getUOMDisplayFormatter=function(t,e){var r={showMeasure:false,emptyString:NaN},n;this._enhanceFormatOptions(r);n=new w(r,{scale:t&&t.scale?t.scale:0});return function(t,r,i){var a,o,s=this&&this.oParent&&this.oParent.oParent,p=s&&s.isA("sap.ui.comp.smartfield.SmartField")&&s.isFormContextType();if(!t&&t!==0||!r&&r!==""||r==="*"){return""}if(isNaN(parseFloat(t))){return t.toString()+" "}a=n.formatValue([t,r,i],"string");o=i&&i[r]&&i[r].UnitSpecificScale;if((o===0||o===null)&&!p){a+=" "}if(!p&&s&&s.getControlContext&&s.getControlContext()===""&&a&&o){a=a.padEnd(a.length+1," ")}if(p){a+=" "}if(e&&e.mask){return S.maskValue(a)}return a}};S.maskValue=function(t){if(t){return t.replace(new RegExp(".","igm"),"*")}return t};S.prototype.getCurrencyType=function(t){if(t){var e=this._getDecimalConstraints(t),r=this.getConstraints(t.property,e),n=O(r),i=A(e);this._enhanceFormatOptions(n);return new D(n,this.getConstraints(t.property,i))}return null};S.prototype.getUoMType=function(t){var e=["edm.int16","edm.int32","edm.byte","edm.double"];if(t){var r=this._getDecimalConstraints(t),n=this.getConstraints(t.property,r),i=O(n);if(e.includes(t.property.type.toLowerCase())){i.parseAsString=false;n.type=t.property.type}this._enhanceFormatOptions(i);return new w(i,n)}return null};function O(t){var e=t.nullable?null:0;return{showMeasure:false,parseAsString:true,emptyString:e,precision:t.precision}}function A(t){return{precision:t.precision,scale:t.scale,variableScale:t.variableScale}}S.prototype.getAbapBoolean=function(){return new v};S.prototype.destroy=function(){this._oParent=null};S.prototype._enhanceFormatOptions=function(t){var e=this._getCustomDataConfiguration();if(typeof e.preserveDecimals==="boolean"){t.preserveDecimals=e.preserveDecimals}};S.prototype._getCustomDataConfiguration=function(){var t={},e;if(this._oParent){e=this._oParent.data("preserveDecimals");if(e){t.preserveDecimals=e==="true"}}return t};return S},true);