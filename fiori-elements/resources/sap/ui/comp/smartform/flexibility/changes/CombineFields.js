/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/smartform/flexibility/changes/RenameField","sap/ui/core/Configuration"],function(e,n){"use strict";var t={};function r(e,n,t){return Promise.all(n.map(function(n){if(!t.found){t.index++;return e.getProperty(n,"mandatory").then(function(e){t.found=t.found||e})}return undefined}))}function o(e,n){var t={found:false,index:-1};return n.reduce(function(n,o){return n.then(e.getAggregation.bind(e,o,"fields")).then(function(n){if(!t.found){return r(e,n,t)}return undefined})},Promise.resolve()).then(function(){return t.found?t.index:-1})}t._getPreviousLabelPropertyOnControl=function(e,n,t){return Promise.resolve().then(n.getProperty.bind(n,e,t)).then(function(r){if(r&&typeof r!=="string"){t="text";e=r}return n.getPropertyBindingOrProperty(e,t)}).then(function(e){return e?e:"$$Handled_Internally$$"})};function i(e){return!!e.newElementId}function l(e,n,t){var r=e.modifier;var o=e.appComponent;var l=e.view;if(i(n)){return r.getAggregation(t,"dependents").then(function(i){var u=i.find(function(e){return r.bySelector(n.newElementId,o,l)});if(u){return r.removeAggregation(t,"dependents",u).then(function(){return u})}return r.createControl("sap.ui.comp.smartform.GroupElement",e.appComponent,e.view,n.newElementId)})}return Promise.resolve(r.bySelector(n.sourceSelector,o,l))}function u(e,n,t,r){return r.getAggregation(e,"groupElements").then(function(e){var r=e.indexOf(n);return t.reduce(function(n,t){var o=e.indexOf(t);if(o>-1&&o<r){n=n-1}return n},r)})}function a(e,n,t,r,o,i,l){if(o.newElementId||e!==n){var u=t.getParent(e);return l.reduce(function(o,l,u){return o.then(t.removeAggregation.bind(t,e,"elements",l)).then(t.insertAggregation.bind(t,n,"elements",l,i+u,r))},Promise.resolve()).then(t.removeAggregation.bind(t,u,"groupElements",e)).then(t.insertAggregation.bind(t,u,"dependents",e,0,r)).then(function(){return i+(l.length||0)})}return Promise.resolve(0)}t.applyChange=function(t,r,g){var c=t.getContent();var s=g.modifier;var d=g.appComponent;var f=g.view;var m=s.bySelector(c.sourceSelector,d,f);var v=s.getParent(m);var p=[];var h;var b;var S;var P;var C=c.combineFieldSelectors.map(function(e){return s.bySelector(e,d,f)});return l(g,c,v).then(function(e){if(e){return u(v,m,C,s).then(function(n){if(n>-1){P=n;m=e}}).then(this._collectRevertDataForElements.bind(this,s,C,d,e,v))}return this._collectRevertDataForElements(s,C,d)}.bind(this)).then(function(e){S=e}).then(function(){return o(s,C).then(function(e){if(e>0){s.setProperty(m,"elementForLabel",e)}})}).then(function(){var e=n.getRTL();var r=0;return C.reduce(function(n,o,i){return n.then(function(n){r=r+n;var l="fieldLabel"+i.toString();b=t.getText(l);if(b&&b!==h){if(e){p.unshift(b)}else{p.push(b)}h=b}return s.getAggregation(o,"elements")}).then(function(e){return a(o,m,s,f,c,r,e)})},Promise.resolve(0))}).then(function(){return e.setLabelPropertyOnControl(m,p.join("/"),s,"label")}).then(function(){if(i(c)){return s.insertAggregation(v,"groupElements",m,P,f)}return undefined}).then(function(){t.setRevertData(S)})};t._collectRevertDataForElements=function(e,n,t,r,o){var i={elementStates:[]};var l=0;var u=0;var a=[];if(r){a.push(r);a=a.concat(n)}return Promise.all(a.map(function(n){var r=e.getParent(n)||o;return Promise.all([e.getAggregation(n,"elements"),e.getAggregation(r,"groupElements"),this._getPreviousLabelPropertyOnControl(n,e,"label"),e.getProperty(n,"elementForLabel")]).then(function(o){u=l+o[0].length-1;i.elementStates.push({groupElementSelector:e.getSelector(e.getId(n),t),parentSelector:e.getSelector(e.getId(r),t),groupElementIndex:o[1].indexOf(n),firstFieldIndex:l,lastFieldIndex:u,label:o[2],elementForLabel:o[3]});l=u+1})}.bind(this))).then(function(){return i})};t.revertChange=function(n,t,r){var o=n.getRevertData();var l=r.modifier;var u=r.appComponent;var a=[];o.elementStates=o.elementStates.sort(function(e,n){return e.groupElementIndex-n.groupElementIndex});return o.elementStates.reduce(function(e,t){var r=l.bySelector(t.parentSelector,u);var o=l.bySelector(t.groupElementSelector,u);return e.then(l.getAggregation.bind(l,r,"groupElements")).then(function(e){if(e.indexOf(o)===-1){return Promise.resolve().then(l.removeAggregation.bind(l,r,"dependents",o)).then(l.insertAggregation.bind(l,r,"groupElements",o,t.groupElementIndex))}else{return Promise.resolve().then(l.getAggregation.bind(l,o,"elements")).then(function(e){a=e;return l.removeAllAggregation(o,"elements")}).then(function(){if(i(n.getContent())){return l.removeAggregation(r,"groupElements",o).then(l.insertAggregation.bind(l,r,"dependents",o))}return undefined})}})},Promise.resolve()).then(function(){return o.elementStates.reduce(function(n,t){var r;var o;return n.then(function(){r=l.bySelector(t.groupElementSelector,u);var e=[];for(var n=t.firstFieldIndex;n<=t.lastFieldIndex;n++){e.push(l.insertAggregation(r,"elements",a[n],a.length))}return Promise.all(e)}).then(function(){o=t.label;if(o==="$$Handled_Internally$$"){o=undefined;return l.getAggregation(r,"fields")}return undefined}).then(function(n){if(n&&n.length){var i=n[t.elementForLabel];l.setProperty(i,"textLabel",undefined)}l.setProperty(r,"elementForLabel",t.elementForLabel);return e.setLabelPropertyOnControl(r,o,l,"label")})},Promise.resolve())}).then(n.resetRevertData.bind(n))};t.completeChangeContent=function(e,n,t){var r=t.modifier;var o=t.view;var i=t.appComponent;var l={};if(n.newElementId){l.newElementId=n.newElementId}var u=n.combineElementIds;if(u&&u.length>=2){l.combineFieldSelectors=u.map(function(e){return r.getSelector(e,i)});e.addDependentControl(u,"combinedFields",t)}else{throw new Error("oSpecificChangeInfo.combineElementIds attribute required")}if(n.sourceControlId){l.sourceSelector=r.getSelector(n.sourceControlId,i);e.addDependentControl(n.sourceControlId,"sourceControl",t)}else{throw new Error("oSpecificChangeInfo.sourceControlId attribute required")}var a;var g;var c;for(var s=0;s<l.combineFieldSelectors.length;s++){var d=l.combineFieldSelectors[s];c=r.bySelector(d,i,o);a=c.getLabelText();if(a){g="fieldLabel"+s;e.setText(g,a,"XFLD")}}e.setContent(l)};t.getChangeVisualizationInfo=function(e){var n=e.getContent();return{displayControls:[n.newElementId],affectedControls:[n.sourceSelector],descriptionPayload:{originalSelectors:n.combineFieldSelectors}}};return t},true);