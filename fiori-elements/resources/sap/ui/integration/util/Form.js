/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/library","sap/base/Log","sap/base/util/deepExtend","./Validators","./BindingResolver"],function(e,t,o,r,i,a){"use strict";var n=t.ValueState;var s=e.extend("sap.ui.integration.util.Form",{constructor:function(t){e.apply(this);this._oCard=t},metadata:{library:"sap.ui.integration"}});s.prototype.init=function(){this._mControls=new Map};s.prototype.exit=function(){this._mControls.clear();delete this._mControls;delete this._oCard};s.prototype.addControl=function(e,t,o,r){if(!this._isValidControlId(o.id)){return}this._syncToFormModelOn(e,t,o,r)};s.prototype.validate=function(e,t){var o=false;this._mControls.forEach(function(t){if(this._validateControl(t,e)){o=true}}.bind(this));if(o&&!t){this._oCard._fireStateChanged()}};s.prototype.resolveControl=function(e){var t={},o,r=this.getModel("messages").getProperty("/records"),i=r.find(function(t){return t.bindingPath==="/"+e.id}),a=this._mControls.get(e.id);if(i&&(a&&a._bShowValueState)){t.valueState={message:i.message,type:i.type}}if(e.type==="ComboBox"){o=this.getModel("form").getProperty("/"+e.id);t.selectedKey=o.key;o=o.value}else{o=this.getModel("form").getProperty("/"+e.id)}t.value=o;return t};s.prototype.setControlValue=function(e){if(!this._isControlDataValid(e)){return}var t=e.id,o=this._mControls.get(t);if(o.isA("sap.m.ComboBox")){this._setComboBoxValue(o,e)}if("value"in e&&o.isA(["sap.m.TextArea","sap.m.Input"])){o.setValue(e.value)}this._validateAndUpdate(o)};s.prototype.updateModel=function(){this._mControls.forEach(this._updateModel.bind(this))};s.prototype._setComboBoxValue=function(e,t){var o;if("key"in t){e.setSelectedKey(t.key)}if("value"in t&&!("key"in t)){o=e.getItems().find(function(e){return e.getText()===t.value});if(o){e.setSelectedItem(o)}else{e.setSelectedKey("");e.setValue(t.value)}}};s.prototype._isValidControlId=function(e){if(!e){o.error("Each input control must have an ID.","sap.ui.integration.widgets.Card");return false}if(this._mControls.has(e)){o.error("Duplicate form control ID - '"+e+"'","sap.ui.integration.widgets.Card");return false}return true};s.prototype._syncToFormModelOn=function(e,t,o,r){this._prepareValidationForControl(t,o,r);t.attachEvent(e,this._validateAndUpdate,this);if(o.value&&!a.isBindingInfo(o.value)){this._updateModel(t)}this._mControls.set(o.id,t)};s.prototype._updateModel=function(e){this.getModel("form").setProperty("/"+e._oItem.id,l(e))};s.prototype._validateAndUpdate=function(e){var t=e.getSource?e.getSource():e;this._validateControl(t,true);this._updateModel(t);this._oCard._fireStateChanged()};s.prototype._isControlDataValid=function(e){if(!e){return false}var t=e.id;if(!t){o.error("Form control data is missing property 'id'.","sap.ui.integration.widgets.Card");return false}var r=this._mControls.get(t);if(!r){o.error("Form control with ID - '"+t+"' does not exist.","sap.ui.integration.widgets.Card");return false}if(r.isA(["sap.m.TextArea","sap.m.Input"])&&!("value"in e)){o.error("Form data for control ID - '"+t+"' is missing property 'value'.","sap.ui.integration.widgets.Card");return false}if(r.isA("sap.m.ComboBox")){if("value"in e||"key"in e){return true}o.error("Form data for control ID - '"+t+"' requires properties 'key' or 'value'.","sap.ui.integration.widgets.Card");return false}return true};s.prototype._prepareValidationForControl=function(e,t,o){var i=r({},t);if(i.validations){i.validations.forEach(function(e,t){if(e.pattern){e.pattern=this._oCard.getManifestEntry(o+"/validations/"+t)["pattern"]}}.bind(this))}e._oItem=i};s.prototype._validateControl=function(e,t){var o=this._oCard.getAggregation("_extension"),r=e._oItem,i=e.getBindingContext(),n=i?i.getPath():"",s=false,l;this._removeMessageFromControl(e);if(!r||!r.validations){return s}l=a.resolveValue(r.validations,e,n);s=!l.every(function(i){return this._checkValidationItem(i,e,r,t,o)}.bind(this));this._updateMessageModel();return s};s.prototype._checkValidationItem=function(e,t,o,r,a){var s=i[this._getFormControlType(o)],u,d,p,f,g=this.getModel("i18n").getResourceBundle(),c=true;for(var h in e){u=e[h];if(h==="validate"){p=this._getExtensionFunctionName(u,a);if(p){f=a[p]}}else{f=s[h]}if(typeof f!=="function"){continue}d=f(l(t),u);if(!d){this._addMessageToControl(t,r,{type:e.type||n.Error,message:e.message||g.getText(s[h+"Txt"],u),bindingPath:"/"+o.id});c=false;break}}return c};s.prototype._addMessageToControl=function(e,t,o){var r=this.getModel("messages"),i=r.getData();i.records.push(o);r.setData(i);if(t||e._bShowValueState){e._bShowValueState=true;e.setValueState(o.type);e.setValueStateText(o.message)}this._updateMessageModel()};s.prototype._removeMessageFromControl=function(e){var t=this.getModel("messages"),o="/"+e._oItem.id,r=t.getData(),i=false;e.setValueState(n.None);for(var a=0;a<r.records.length;a++){if(r.records[a].bindingPath===o){r.records.splice(a,1);i=true;break}}if(i){t.setData(r)}this._updateMessageModel()};s.prototype._updateMessageModel=function(){var e=this.getModel("messages"),t=e.getProperty("/records");e.setProperty("/hasErrors",t.some(function(e){return e.type===n.Error}));e.setProperty("/hasWarnings",t.some(function(e){return e.type===n.Warning}))};s.prototype.getRequiredValidationValue=function(e){var t=e.validations||[],o,r,i;for(r=0;r<t.length;r++){o=t[r];for(i in o){if(i==="required"){return o[i]}}}return false};s.prototype._getExtensionFunctionName=function(e,t){if(!e.startsWith("extension.")){o.error("Validation function should start with 'extension'.");return false}if(!t){o.error("Extension is not defined.");return false}var r=e.replace("extension.","");if(!t[r]){o.error("No such function.",r,"sap.ui.integration.widgets.Card");return false}return r};s.prototype._getFormControlType=function(e){switch(e.type){case"ComboBox":return"keyValuePair";default:return"string"}};function l(e){if(e.isA("sap.m.ComboBox")){e.synchronizeSelection();return{key:e.getSelectedKey(),value:e.getValue()}}else{return e.getValue()}}return s});