/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/ResizeHandler","./adapter3d/thirdparty/three","./adapter3d/thirdparty/OrbitControls","./adapter3d/Utilities","./ViewportRenderer","sap/base/Log","./library"],function(e,t,r,i,a,o,s,n){"use strict";var h="sap.ui.vbm.Viewport";var d=e.extend("sap.ui.vbm.Viewport",{metadata:{library:"sap.ui.vbm",properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},cameraHistoryLength:{type:"int",defaultValue:0},cameraHistoryPos:{type:"int"}},events:{cameraChange:{parameters:{historyPos:{type:"int"},historyLength:{type:"int"}}}}},renderer:o});var l=1e-6;var c=.6;var p=5e4;var m=85;var _=d.getMetadata().getParent().getClass().prototype;d.prototype.init=function(){if(_.init){_.init.call(this)}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._renderer=new r.WebGLRenderer({antialias:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.shadowMap.enabled=true;this._renderer.domElement.tabIndex=-1;this._renderer.domElement.setAttribute("role",sap.ui.core.AccessibleRole.Img);this._renderer.domElement.id=this.getId()+"-canvas";this._scene=new r.Scene;this._root=new r.Group;this._root.scale.set(-1,1,1);this._root.rotateX(r.Math.degToRad(90));this._root.matrixAutoUpdate=false;this._root.updateMatrix();this._scene.add(this._root);this._mapPlane=new r.Mesh(new r.PlaneGeometry(p,p,1,1),new r.MeshBasicMaterial({color:2128813,side:r.DoubleSide}));this._mapPlane.name="MapPlane";this._mapPlane.layers.set(2);this._mapPlane.visible=false;this._mapPlane.matrixAutoUpdate=false;this._mapPlane.updateMatrix();this._root.add(this._mapPlane);this._scene.background=new r.Color("white");this._scene.add(new r.AmbientLight(2105376,1));var e=new r.DirectionalLight(3355443,1);e.position.set(0,0,-1);e.matrixAutoUpdate=false;e.updateMatrix();this._scene.add(e);var t=new r.DirectionalLight(5329243,1);t.position.set(-2,-1.1,2.5);t.matrixAutoUpdate=false;t.updateMatrix();this._scene.add(t);var a=new r.DirectionalLight(5987163,2);a.position.set(2,1.5,.5);a.matrixAutoUpdate=false;a.updateMatrix();this._scene.add(a);this._light=new r.DirectionalLight(15658734,1);this._lightPos=new r.Vector3(0,0,0);this._scene.add(this._light);this._camera=new r.PerspectiveCamera(30,window.innerWidth/window.innerHeight,.1,2e3);this._camera.layers.enable(0);this._camera.layers.enable(1);this._scene.add(this._camera);this._camera.position.set(0,30,30);this._camera.lookAt(new r.Vector3(0,0,0));this._cameraHome=undefined;this._flyToRequestId=undefined;this._resetTimerId=undefined;this._cameraHistory=[];this._cameraChangeEvent={};this._bbox=new r.Box3;this._cameraController=new i(this._camera,this._renderer.domElement);this._cameraController.listenToKeyEvents(this._renderer.domElement);this._cameraController.addEventListener("end",this._cameraEnd.bind(this));this._cameraController.addEventListener("change",this._cameraUpdate.bind(this));this._cameraController.update()};d.prototype.getOrbitControl=function(){return this._cameraController};d.prototype.exit=function(){if(this._resizeListenerId){t.deregister(this._resizeListenerId);this._resizeListenerId=null}this._stopRenderLoop();this._cameraController.dispose();this._cameraController=null;this._renderer.dispose();this._renderer=null;this._scene=null;this._camera=null;if(_.exit){_.exit.call(this)}};d.prototype.getRoot=function(){return this._root};d.prototype.getScene=function(){return this._scene};d.prototype.getCamera=function(){return this._camera};d.prototype.getCameraHistoryLength=function(){return this._cameraHistory.length};d.prototype.setCameraHistoryLength=function(){s.error("cameraHistoryLength is read only property","",h);return this};d.prototype.setCameraHistoryPos=function(e){if(this._cameraHistory.length>0&&e>=0&&e<this._cameraHistory.length){if(e!==this.getCameraHistoryPos()){this.setProperty("cameraHistoryPos",e,true);delete this._cameraHistory[e].tag;this._fireCameraChange();this._flyTo(this._cameraController.saveState(),this._cameraHistory[e],c)}}return this};d.prototype.applyCameraHome=function(e){if(this._cameraHome){this._applyCamera(this._cameraHome,e)}};d.prototype.worldToScreen=function(e){var t=this.getDomRef();if(!t){return undefined}var i=t.getBoundingClientRect();var a=this.getCamera();var o=(new r.Matrix4).multiplyMatrices(a.projectionMatrix,(new r.Matrix4).getInverse(a.matrixWorld));var s=e.clone().applyMatrix4(o);var n=Math.floor((+s.x*.5+.5)*i.width+.5);var h=Math.floor((-s.y*.5+.5)*i.height+.5);return new r.Vector2(n,h)};d.prototype.onBeforeRendering=function(){if(this._resizeListenerId){t.deregister(this._resizeListenerId);this._resizeListenerId=null}this._stopRenderLoop()};d.prototype.onAfterRendering=function(){var e=this.getDomRef();e.appendChild(this._renderer.domElement);this._resizeListenerId=t.register(this,this._handleResize.bind(this));this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}});this._startRenderLoop()};d.prototype._handleResize=function(e){if(!this._camera||!this._renderer){return false}var t=e.size.width;var r=e.size.height;if(this._camera){this._camera.aspect=t/r;this._camera.updateProjectionMatrix()}this._renderer.setSize(t,r,false)};d.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction)}return this};d.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0}return this};d.prototype._renderLoop=function(){this._cameraController.update();this._camera.getWorldDirection(this._lightPos);this._lightPos.negate();this._light.position.copy(this._lightPos);this._renderer.render(this._scene,this._camera);this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction)};function u(e,t,r,i){return t+r*((e=e/i-1)*e*e+1)}function g(e){var t=Math.min((Date.now()-e.when)/1e3,e.length);var r=e.tempTarget;r.x=u(t,e.from.target.x,e.to.target.x-e.from.target.x,e.length);r.y=u(t,e.from.target.y,e.to.target.y-e.from.target.y,e.length);r.z=u(t,e.from.target.z,e.to.target.z-e.from.target.z,e.length);var i=u(t,e.distanceFrom,e.distanceTo-e.distanceFrom,e.length);var a=u(t,0,e.angle,e.length);var o=e.tempPos.copy(e.dir).applyAxisAngle(e.axis,a).multiplyScalar(i).add(r);this._cameraController.reset({position:o,target:r,zoom:1});if(t<e.length){this._flyToRequestId=window.requestAnimationFrame(g.bind(this,e))}else{this._flyToRequestId=undefined}}d.prototype._flyTo=function(e,t,i){var o=t.position.clone().sub(t.target);var s=e.position.clone().sub(e.target);var n=o.length();var h=s.length();var d=Math.acos(a.clamp(s.dot(o)/(n*h),-1,1));var l={to:t,from:e,when:Date.now(),length:i,angle:d,axis:s.clone().cross(o).normalize(),distanceTo:n,distanceFrom:h,dir:s.normalize(),tempPos:new r.Vector3,tempTarget:new r.Vector3};if(this._flyToRequestId){window.cancelAnimationFrame(this._flyToRequestId)}this._flyToRequestId=window.requestAnimationFrame(g.bind(this,l))};d.prototype._cameraEnd=function(e){var t=this._cameraController.saveState();var r=this.getCameraHistoryPos();var i=r>=0?this._cameraHistory[r]:undefined;if(i==undefined||t.target.distanceToSquared(i.target)>l||t.position.distanceToSquared(i.position)>l){this._pushCameraChange(t)}};function f(){if(this._cameraHistory.length>0){delete this._cameraHistory[this._cameraHistory.length-1].tag}this._resetTimerId=undefined}d.prototype._cameraUpdate=function(e){if(e.tag){if(this._resetTimerId){window.clearTimeout(this._resetTimerId)}this._resetTimerId=window.setTimeout(f.bind(this),500);var t=this._cameraController.saveState();var r=this.getCameraHistoryPos();t.tag=e.tag;var i=r>=0?this._cameraHistory[r]:{};if(t.tag&&t.tag===i.tag){this._cameraHistory[r]=t}else{this._pushCameraChange(t)}}this._updateCamera();this._updateController()};d.prototype._fireCameraChange=function(){this._cameraChangeEvent.historyPos=this.getCameraHistoryPos();this._cameraChangeEvent.historyLength=this._cameraHistory.length;this.fireCameraChange(this._cameraChangeEvent)};d.prototype._pushCameraChange=function(e){var t=this.getCameraHistoryPos();this._cameraHistory.splice(t>=0?t+1:0,this._cameraHistory.length);this._cameraHistory.push(e);this.setProperty("cameraHistoryPos",this._cameraHistory.length-1,true);this._fireCameraChange()};d.prototype._setCameraHome=function(e){this._cameraHome=e};d.prototype._applyCamera=function(e,t){var r=this._cameraController.saveState();if(e.target.distanceToSquared(r.target)>l||e.position.distanceToSquared(r.position)>l){this._pushCameraChange(e);if(t){this._flyTo(this._cameraController.saveState(),e,c)}else{this._cameraController.reset(e)}}};d.prototype._getCameraState=function(){return this._cameraController.saveState()};d.prototype._intersectMapPlane=function(e){e.layers.set(2);var t=e.intersectObjects([this._mapPlane],false);return t};var y=new r.Box3,v=new r.Matrix4;function C(e,t){var r,i=e.geometry;e.updateWorldMatrix(false,false);if(e.visible&&i){if(!i.boundingBox){i.computeBoundingBox()}if(e.isInstancedMesh){for(r=0;r<e.count;++r){e.getMatrixAt(r,v);y.copy(i.boundingBox);y.applyMatrix4(v);t.union(y)}}else{y.copy(i.boundingBox);y.applyMatrix4(e.matrixWorld);t.union(y)}}var a=e.children;for(r=0;r<a.length;++r){C(a[r],t)}}d.prototype._resetBBox=function(){this._bbox.makeEmpty()};d.prototype._getBBox=function(){if(this._bbox.isEmpty()){C(this.getScene(),this._bbox)}return this._bbox};d.prototype._updateCamera=function(){var e=this._getBBox();if(!e.isEmpty()){var t=new r.Sphere;e.getBoundingSphere(t);if(t.radius===0){t.radius=1}this._camera.updateMatrixWorld(false);t.center.applyMatrix4(this._camera.matrixWorldInverse);var i=a.clamp(-t.center.z-t.radius,t.radius*.001,-t.center.z-t.radius);var o=i+t.radius*2,s=false;if(Math.abs(this._camera.near-i)>=this._camera.near*.03){this._camera.near=i;s=true}if(Math.abs(this._camera.far-o)>=this._camera.far*.03){this._camera.far=o;s=true}if(s){this._camera.updateProjectionMatrix()}}};d.prototype._updateController=function(){var e=this._cameraController.target.clone().sub(this._camera.position).normalize();var t=new r.Vector3(0,this._camera.position.y>0?1:-1,0);var i=new r.Plane(t),a=new r.Vector3;var o=new r.Ray(this._camera.position,e);if(o.intersectPlane(i,a)){if(r.Math.radToDeg(this._camera.position.clone().sub(a).angleTo(t))<m){this._cameraController.target.copy(a)}}};return d});