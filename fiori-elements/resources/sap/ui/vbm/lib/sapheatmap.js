/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./sapvbi"],function(){"use strict";VBI.Tex=null;VBI.Shader=null;VBI.FB=null;VBI.Vals=null;VBI.Ro=null;VBI.Hm=null;VBI.Hook=function(){if(window.WebGLRenderingContext){var t=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(i){var e=["","MS","WEBKIT","MOZ","O"];var s,r;if((s=t.call(this,i))===null){for(var h=0,n=e.length;h<n;++h){r=e[h];if((s=t.call(this,r+"_"+i))!==null){return s}}return null}else{return s}};WebGLRenderingContext.prototype.getExtensions=function(t){return this.getExtension("OES_texture_float")}}}();VBI.Shader=function(){function t(t,i,e){this.m_GL=t;this.m_UL={};this.m_Prog=this.m_GL.createProgram();this.m_VS=this.m_GL.createShader(this.m_GL.VERTEX_SHADER);this.m_FS=this.m_GL.createShader(this.m_GL.FRAGMENT_SHADER);this.m_GL.attachShader(this.m_Prog,this.m_VS);this.Compile(this.m_VS,i);this.m_GL.attachShader(this.m_Prog,this.m_FS);this.Compile(this.m_FS,e);this.Link()}t.prototype.getShaderVar=function(t){return this.m_GL.getAttribLocation(this.m_Prog,t)};t.prototype.Compile=function(t,i){this.m_GL.shaderSource(t,i);this.m_GL.compileShader(t);if(!this.m_GL.getShaderParameter(t,this.m_GL.COMPILE_STATUS)){jQuery.sap.log.error("Shader Compilation Error");jQuery.sap.log.error(this.m_GL.getShaderInfoLog(t))}};t.prototype.Link=function(){this.m_GL.linkProgram(this.m_Prog);if(!this.m_GL.getProgramParameter(this.m_Prog,this.m_GL.LINK_STATUS)){jQuery.sap.log.error("Shader Link Error");jQuery.sap.log.error(this.m_GL.getProgramInfoLog(this.m_Prog))}};t.prototype.Apply=function(){this.m_GL.useProgram(this.m_Prog);return this};t.prototype.getLoc=function(t){var i=this.m_UL[t];if(typeof i==="undefined"){i=this.m_UL[t]=this.m_GL.getUniformLocation(this.m_Prog,t)}return i};t.prototype.SetInt=function(t,i){this.m_GL.uniform1i(this.getLoc(t),i);return this};return t}();VBI.FB=function(){function t(t){this.m_GL=t;this.m_FB=this.m_GL.createFramebuffer()}t.prototype.destroy=function(){return this.m_GL.deleteFramebuffer(this.m_FB)};t.prototype.BindFB=function(){this.m_GL.bindFramebuffer(this.m_GL.FRAMEBUFFER,this.m_FB);return this};t.prototype.UnBindFB=function(){this.m_GL.bindFramebuffer(this.m_GL.FRAMEBUFFER,null);return this};t.prototype.SetTex=function(t){this.m_GL.framebufferTexture2D(this.m_GL.FRAMEBUFFER,this.m_GL.COLOR_ATTACHMENT0,this.m_GL.TEXTURE_2D,t.m_Tex,0);var i=this.m_GL.checkFramebufferStatus(this.m_GL.FRAMEBUFFER);if(i!==this.m_GL.FRAMEBUFFER_COMPLETE){return null}return this};return t}();VBI.Tex=function(){function t(t,i){var e;this.m_GL=t;i=i?i:{};this.m_colFmt=this.m_GL[((e=i.colfmt)!=null?e:"rgba").toUpperCase()];if(typeof i.type==="number"){this.type=i.type}else{this.type=this.m_GL[((e=i.type)!=null?e:"unsigned_byte").toUpperCase()]}this.m_Tex=this.m_GL.createTexture()}t.prototype.destroy=function(){return this.m_GL.deleteTexture(this.m_Tex)};t.prototype.BindTex=function(t){if(t==null){t=0}this.m_GL.activeTexture(this.m_GL.TEXTURE0+t);this.m_GL.bindTexture(this.m_GL.TEXTURE_2D,this.m_Tex);return this};t.prototype.AdjustSize=function(t,i){this.m_W=t;this.m_H=i;this.m_GL.texImage2D(this.m_GL.TEXTURE_2D,0,this.m_colFmt,t,i,0,this.m_colFmt,this.type,null);return this};t.prototype.SetImage=function(t){this.m_W=t.width;this.m_H=t.height;this.m_GL.texImage2D(this.m_GL.TEXTURE_2D,0,this.m_colFmt,this.m_colFmt,this.type,t);return this};t.prototype.SetFilterNearest=function(){this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_MAG_FILTER,this.m_GL.NEAREST);this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_MIN_FILTER,this.m_GL.NEAREST);return this};t.prototype.SetWrapEdge=function(){this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_WRAP_S,this.m_GL.CLAMP_TO_EDGE);this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_WRAP_T,this.m_GL.CLAMP_TO_EDGE);return this};return t}();VBI.Ro=function(){function t(t,i,e){this.m_GL=t;this.m_W=i;this.m_H=e;var s=this.m_GL.getExtensions();var r=null;if(s){r=this.m_GL.FLOAT}this.m_Tex=new VBI.Tex(this.m_GL,{type:r});this.m_Tex.BindTex(0);this.m_Tex.AdjustSize(i,e);this.m_Tex.SetFilterNearest();this.m_Tex.SetWrapEdge();this.m_FB=new VBI.FB(this.m_GL);this.m_FB.BindFB();if(!this.m_FB.SetTex(this.m_Tex)){this.m_FB.UnBindFB();this.m_Tex=new VBI.Tex(this.m_GL,{type:null});this.m_Tex.BindTex(0);this.m_Tex.AdjustSize(i,e);this.m_Tex.SetFilterNearest();this.m_Tex.SetWrapEdge();this.m_FB=new VBI.FB(this.m_GL);this.m_FB.BindFB();this.m_FB.SetTex(this.m_Tex);this.m_FB.UnBindFB()}else{this.m_FB.UnBindFB()}}t.prototype.Apply=function(){return this.m_FB.BindFB()};t.prototype.BindRo=function(t){return this.m_Tex.BindTex(t)};t.prototype.UnBindRo=function(){this.m_FB.UnBindFB()};t.prototype.AdjustSize=function(t,i){this.m_W=t;this.m_H=i;return this.m_Tex.BindTex(0).AdjustSize(t,i)};return t}();VBI.Vals=function(){function t(t,i,e){this.m_GL=t;this.m_nPointChunk=10240;this.m_nVertexSize=8;this.m_W=i;this.m_H=e;this.m_Shader=new VBI.Shader(this.m_GL,"uniform vec4 uTM;"+"attribute vec4 aPos;"+"attribute float aValue;"+"varying vec3 vData;"+"void main(){"+"  gl_Position = vec4(aPos.xy * uTM.xy + uTM.zw, 0.0, 1.0);"+"  vData.xy = aPos.zw;"+"  vData.z = aValue;"+"}","#ifdef GL_FRAGMENT_PRECISION_HIGH\n"+"  precision highp int;"+"  precision highp float;\n"+"#else\n"+"  precision mediump int;"+"  precision mediump float;\n"+"#endif\n"+"varying vec3 vData;"+"void main(){"+"  float f = smoothstep(1.0, 0.0, length(vData.xy)) * vData.z;"+"  gl_FragColor = vec4(f);"+"}");this.m_Shader.aPos=this.m_Shader.getShaderVar("aPos");this.m_Shader.aValue=this.m_Shader.getShaderVar("aValue");this.m_Shader.uTM=this.m_Shader.getLoc("uTM");this.m_Ro=new VBI.Ro(this.m_GL,this.m_W,this.m_H);this.m_VB=this.m_GL.createBuffer();this.m_vBuf=new Float32Array(this.m_nPointChunk*this.m_nVertexSize*6);this.m_IB=this.m_GL.createBuffer();var s=new Uint16Array(this.m_nPointChunk*6);for(var r=0,h=0;r<s.length;h+=4){s[r++]=h;s[r++]=h+1;s[r++]=h+2;s[r++]=h+2;s[r++]=h+1;s[r++]=h+3}this.m_GL.bindBuffer(this.m_GL.ELEMENT_ARRAY_BUFFER,this.m_IB);this.m_GL.bufferData(this.m_GL.ELEMENT_ARRAY_BUFFER,s,this.m_GL.STATIC_DRAW);this.m_nIdx=0;this.m_nPoints=0}t.prototype.AdjustSize=function(t,i){this.m_W=t;this.m_H=i;this.m_Ro.AdjustSize(this.m_W,this.m_H);return};t.prototype.Render=function(){if(this.m_nPoints>0){var t=this.m_GL;t.enable(t.BLEND);this.m_Ro.Apply();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.m_IB);t.bindBuffer(t.ARRAY_BUFFER,this.m_VB);t.bufferData(t.ARRAY_BUFFER,this.m_vBuf,t.STREAM_DRAW);this.m_Shader.Apply();t.enableVertexAttribArray(1);t.vertexAttribPointer(this.m_Shader.aPos,4,t.FLOAT,false,20,0);t.vertexAttribPointer(this.m_Shader.aValue,1,t.FLOAT,false,20,16);t.uniform4f(this.m_Shader.uTM,2/this.m_W,2/this.m_H,-1,-1);t.drawElements(t.TRIANGLES,this.m_nPoints*6,t.UNSIGNED_SHORT,0);t.disableVertexAttribArray(1);this.m_Ro.UnBindRo();t.disable(t.BLEND);this.m_nPoints=0;this.m_nIdx=0}};t.prototype.Clear=function(){this.m_Ro.Apply();this.m_GL.clearColor(0,0,0,0);this.m_GL.clear(this.m_GL.COLOR_BUFFER_BIT);return this.m_Ro.UnBindRo()};t.prototype.AddPoint=function(t,i,e,s){if(this.m_nPoints+1>=this.m_nPointChunk){this.Render()}i=this.m_H-i;this.PushVertex(t-s,i-s,-1,-1,e);this.PushVertex(t+s,i-s,+1,-1,e);this.PushVertex(t-s,i+s,-1,+1,e);this.PushVertex(t+s,i+s,+1,+1,e);this.m_nPoints+=1;return this.m_nPoints};t.prototype.PushVertex=function(t,i,e,s,r){var h=this.m_vBuf;var n=this.m_nIdx;h[n++]=t;h[n++]=i;h[n++]=e;h[n++]=s;h[n++]=r;this.m_nIdx=n};return t}();VBI.Hm=function(){function t(t){var i;var e;var s=t.scene;if(typeof(t.alphaBounds=="undefined")){t.alphaBounds=[0,1]}if(typeof(t.alpha=="undefined")){t.alpha=true}this.m_Canv=t.canvas;this.m_W=t.width;this.m_H=t.height;this.m_aFunc=t.aFunc.toFixed(8);this.m_cFunc=t.cFunc.toFixed(8);if(!this.m_Canv){this.m_Canv=document.createElement("canvas");this.m_Canv.setAttribute("role",sap.ui.core.AccessibleRole.Img)}var r={depth:false,antialias:false,alpha:true};if(!this.m_GL){this.m_GL=this.m_Canv.getContext("experimental-webgl",r)}if(!this.m_GL){this.m_GL=this.m_Canv.getContext("webgl",r)}if(!this.m_GL){jQuery.sap.log.error("WebGL not supported");return}this.m_GL.blendFunc(this.m_GL.ONE,this.m_GL.ONE);this.m_GL.enableVertexAttribArray(0);if(t.colorTexture){this.m_ColorTexture=new VBI.Tex(this.m_GL,{colfmt:"rgba"});this.m_ColorTexture.BindTex(0);this.m_ColorTexture.SetFilterNearest();this.m_ColorTexture.SetWrapEdge();this.m_ColorTexture.AdjustSize(2,2);this.m_ColorTexture.BindTex(0);this.m_ColorTexture.SetImage(t.colorTex);if(!t.colorTex.IsLoaded){s.RenderAsync(false)}e="uniform sampler2D colTex; "+"vec3 calcCol( float g ){ "+"  return texture2D( colTex, vec2( g, 0.5 )).rgb; "+"}"}else{e="vec3 calcCol( float g ){ "+"  return smoothstep( vec3( 0.0, 0.0, 1.0 ), vec3( 1.0, 1.0, 0.0 ), vec3( g ) ); "+"}"}if(t.alpha){i="vec4 calcAlpha(vec3 c,float i){ "+"  float a = smoothstep("+t.alphaBounds[0].toFixed(8)+","+t.alphaBounds[1].toFixed(8)+", pow(i, 1.0)); "+"  return vec4( c*a, a); "+"}"}else{i="vec4 calcAlpha(vec3 c, float i){ "+"  return vec4(c, 1.0);"+"}"}var h="#ifdef GL_FRAGMENT_PRECISION_HIGH \n"+"  precision highp int;"+"  precision highp float; \n"+"#else \n"+"  precision mediump int;"+"  precision mediump float; \n"+"#endif \n"+"uniform sampler2D src;"+"varying vec2 txy;";var n="void main(){ "+"  float f = clamp( texture2D(src, txy).r, 0.0, 1.0 ); "+"  vec3 color = calcCol(pow(f, "+this.m_cFunc+")); "+"  gl_FragColor = calcAlpha(color, pow(f, "+this.m_aFunc+")); "+"}";this.m_Shader=new VBI.Shader(this.m_GL,"attribute vec4 pos; "+"varying vec2 txy; "+"void main(){ "+"  txy = pos.xy * 0.5 + 0.5; "+"  gl_Position = pos; "+"}",h+e+"\n"+i+n);if(this.m_W==null){this.m_W=this.m_Canv.offsetWidth||2}if(this.m_H==null){this.m_H=this.m_Canv.offsetHeight||2}this.m_Canv.width=this.m_W;this.m_Canv.height=this.m_H;var m=new Float32Array([-1,-1,0,1,1,-1,0,1,-1,1,0,1,1,1,0,1]);this.m_Geo=this.m_GL.createBuffer();this.m_GL.viewport(0,0,this.m_W,this.m_H);this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_Geo);this.m_GL.bufferData(this.m_GL.ARRAY_BUFFER,m,this.m_GL.STATIC_DRAW);this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,null);this.m_V=new VBI.Vals(this.m_GL,this.m_W,this.m_H)}t.prototype.AdjustSize=function(){if(!this.m_GL){return}var t=this.m_Canv.offsetHeight||2;var i=this.m_Canv.offsetWidth||2;if(this.m_W!==i||this.m_H!==t){this.m_GL.viewport(0,0,i,t);this.m_Canv.width=i;this.m_Canv.height=t;this.m_W=i;this.m_H=t;this.m_V.AdjustSize(this.m_W,this.m_H)}};t.prototype.RenderColors=function(){if(!this.m_GL){return}this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_Geo);this.m_GL.vertexAttribPointer(0,4,this.m_GL.FLOAT,false,0,0);this.m_V.m_Ro.BindRo(0);if(this.m_ColorTexture){this.m_ColorTexture.BindTex(1)}this.m_Shader.Apply();this.m_Shader.SetInt("src",0);this.m_Shader.SetInt("colTex",1);this.m_GL.drawArrays(this.m_GL.TRIANGLE_STRIP,0,4);return};t.prototype.RenderValues=function(){if(!this.m_GL){return}if(this.m_V){this.m_V.Render()}};t.prototype.Render=function(){this.RenderValues();this.RenderColors()};t.prototype.Clear=function(){return this.m_V?this.m_V.Clear():null};t.prototype.AddPoint=function(t,i,e,s){return this.m_V?this.m_V.AddPoint(t,i,e,s):null};return t}();VBI.CreateHM=function(t){return new VBI.Hm(t)}});