/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./sapvbi"],function(){"use strict";VBI.ScenePointerEvents=function(e,t){e.m_Gesture=null;this.m_Events=["msgesturehold","msgesturestart","msgestureend","msgesturechange","msgestureinertiastart","gesturehold","gesturestart","gestureend","gesturechange","gestureinertiastart","pointerdown","pointermove","pointerup","mspointerdown","mspointermove","mspointerup"];this.clear=function(){for(var e=0,n=this.m_Events.length;e<n;++e){t["on"+this.m_Events[e]]=null}};this.subscribe=function(){var n=this.m_Events;for(var r=0,o=n.length;r<o;++r){var i;if(n[r].slice(0,2)=="ms"){i="process"+n[r].slice(2)}else{i="process"+n[r]}if(!e[i]){if(VBI.m_bTrace){VBI.Trace("Error: Handler "+i+" not defined")}}t["on"+n[r]]=e[i]}};e.processgesturehold=function(t){if(VBI.m_bTrace){VBI.Trace("processgesturehold")}e.DispatchEvent(t,"sapsecclick");t.preventDefault()};e.processgesturestart=function(e){if(VBI.m_bTrace){VBI.Trace("processgesturestart")}};e.processgestureend=function(t){if(VBI.m_bTrace){VBI.Trace("processgestureend")}if(e.m_Gesture){e.m_Gesture.target=null}e.m_Gesture=null};e.processgesturechange=function(t){if(VBI.m_bTrace){VBI.Trace("processgesturechange mode: "+e.m_nInputMode)}if(e.m_nInputMode!=VBI.InputModeDefault&&e.m_nInputMode!=VBI.InputModeTrackMap){e.DispatchEvent(t,"sapmove");return}if(VBI.m_bTrace){VBI.Trace("processgesturechange");VBI.Trace("rotation:"+t.rotation);VBI.Trace("scale:"+t.scale);VBI.Trace("trans:"+t.translationX+","+t.translationY)}var n=t.gestureObject;var r=Math.round(n.tx)-n.txdone;var o=Math.round(n.ty)-n.tydone;var i=Math.round(t.translationX)+r;var s=Math.round(t.translationY)+o;n.tx+=t.translationX;n.ty+=t.translationY;n.txdone+=i;n.tydone+=s;if(VBI.m_bTrace){VBI.Trace("done:"+n.txdone+","+n.tydone);VBI.Trace("calc:"+n.tx+","+n.ty)}if(i||s){if(VBI.m_bTrace){VBI.Trace("scene.processgesturechange move")}e.MoveMap(i,s)}if(t.scale!=1){e.ZoomMap(t.scale,t.offsetX,t.offsetY);e.TriggerReRenderTimer(400)}t.stopPropagation();t.preventDefault();return true};e.processgestureinertiastart=function(e){if(VBI.m_bTrace){VBI.Trace("processgestureinertiastart")}e.preventDefault()};e.processpointerdown=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processpointerdown ")}e.onsapdown(t);var n=e.m_Gesture;if(n&&t.pointerType!=n.pointerType){if(VBI.m_bTrace){VBI.Trace("processpointerdown gesture pointer type mismatch or gesture hasn't been started")}e.m_Gesture.target=null;n=e.m_Gesture=null}if(!n){if(VBI.m_bTrace){VBI.Trace("processpointerdown create gesture")}n=e.m_Gesture=new window.MSGesture;n.pointerCount=0;n.target=t.srcElement;n.pointerType=t.pointerType;n.tx=0;n.ty=0;n.txdone=0;n.tydone=0}if(t.pointerType==n.pointerType){n.addPointer(t.pointerId);n.pointerCount++}return};e.processpointerup=function(t){if(VBI.m_bTrace){VBI.Trace("processpointerup")}if(e.m_Gesture){e.m_Gesture.pointerCount--;if(!e.m_Gesture.pointerCount){e.m_Gesture.target=null;e.m_Gesture=null}}return e.onsapup(t)};e.processpointermove=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processpointermove")}e.m_currentMouseX=t.clientX;e.m_currentMouseY=t.clientY;e.onsapmove(t);return};this.subscribe()};VBI.SceneTouchEvents=function(e,t){var n=e.m_SuppressedNavigation.move&&e.m_SuppressedNavigation.zoom;this.m_Events=["touchstart","touchend","touchmove","touchcancel"];this.clear=function(){for(var n=0,r=this.m_Events.length;n<r;++n){t.removeEventListener(this.m_Events[n],e["process"+this.m_Events[n]])}};this.subscribe=function(){var n=this.m_Events;for(var r=0,o=n.length;r<o;++r){var i="process"+n[r];if(e[i]){t.addEventListener(n[r],e[i])}else if(VBI.m_bTrace){VBI.Trace("Error: Handler "+i+" not defined")}}};e.processtouchstart=function(t){var r=false;var o=e.m_Ctx;if(o.m_strOpenMenu){o.m_Menus.findMenuByID(o.m_strOpenMenu).close();o.m_strOpenMenu=undefined}if(o.m_HitMenu){o.m_HitMenu.close();o.m_HitMenu.destroy()}if(VBI.m_bTrace){VBI.Trace("processtouchstart")}if(e.m_TapTimer){window.clearInterval(e.m_TapTimer)}if(e.DispatchEvent(t,"sapdown")==true){return}e.m_Touches.push(t);e.m_TouchStarted=true;e.m_Touches.m_bMoveWasDone=false;if(t.touches.length==1&&!e.m_SuppressedNavigation.move){e.SetInputMode(VBI.InputModeDefault);var i=t.touches[0];e.m_currentMouseX=i.clientX;e.m_currentMouseY=i.clientY;if(VBI.m_bTrace){VBI.Trace("processtouchstart"+"X:"+e.m_currentMouseX+"Y:"+e.m_currentMouseY)}e.RestartContextMenuTimer(t,i,700);r=true}else if(t.touches.length==2){e.SetInputMode(VBI.InputModeDefault);var s=t.touches[0];var a=t.touches[1];var c=(a.clientX+s.clientX)/2;var u=(a.clientY+s.clientY)/2;e.m_currentMouseX=c;e.m_currentMouseY=u;e.m_midPointX=c;e.m_midPointY=u;var m=Math.sqrt(Math.pow(s.clientX-a.clientX,2)+Math.pow(s.clientY-a.clientY,2));e.m_currentTouchDistance=m;if(VBI.m_bTrace){VBI.Trace("processtouchstart"+"X1:"+s.clientX+"Y1:"+s.clientY+"X2:"+a.clientX+"Y2:"+a.clientY)}r=true}if(r&&!n){t.preventDefault();return false}};e.RestartContextMenuTimer=function(t,n,r){if(e.m_ContextMenuTimer){window.clearInterval(e.m_ContextMenuTimer)}e.m_ContextMenuTimer=window.setInterval(function(){window.clearInterval(e.m_ContextMenuTimer);e.m_ContextMenuTimer=null;e.onPseudoRightClick(t,n)},r)};e.onPseudoRightClick=function(t,n){e.SetInputMode(VBI.InputModeDefault);if(VBI.m_bTrace){VBI.Trace("Pseudo Right Click")}if(e.DispatchEvent(t,"sapsecclick")==true){e.m_Touches=[];return}var r;if(r=e.m_Ctx.m_Actions.findAction("ContextMenu",e,"Map")){e.m_Touches=[];var o=e.GetInternalDivClientRect();e.m_Ctx.FireAction(r,e,"Map",null,{x:n.clientX-o.left,y:n.clientY-o.top,scene:e.m_ID})}};e.IsDoubleTap=function(e){if(e.length<4){return null}var t=e.length-4;var n=e.length-2;if(e[t].type=="touchstart"&&e[t].touches.length!=1){return null}if(e[n].type=="touchstart"&&e[n].touches.length!=1){return null}var r=e[t].touches[0].clientX-e[n].touches[0].clientX;var o=e[t].touches[0].clientY-e[n].touches[0].clientY;if(r*r+o*o>1e3){return null}var i=e.length-3;var s=e.length-1;var a=e[s].timeStamp-e[i].timeStamp;if(a>300){return null}return[e[n].touches[0].clientX,e[n].touches[0].clientY]};e.IsTwoFingerTap=function(e){if(e.length<2||e.m_bMoveWasDone){return null}var t=e.length-2;var n=e.length-1;if(e[t].type!="touchstart"||e[t].touches.length!=2){return null}var r=e[n].timeStamp-e[t].timeStamp;if(r>300){return null}var o=e[t].touches;return[(o[0].clientX+o[1].clientX)/2,(o[0].clientY+o[1].clientY)/2]};e.IsSingleTap=function(e){if(e.length!=2||e.m_bMoveWasDone){return null}var t=e.length-2;var n=e.length-1;if(e[t].type!="touchstart"||e[t].touches.length!=1){return null}if(e[n].type!="touchend"){return null}var r=[e[t].touches[0].clientX,e[t].touches[0].clientY];r.timeTouchDown=e[n].timeStamp-e[t].timeStamp;return r};e.processtouchend=function(t){if(e.m_DesignVO){if(e.DispatchEvent(t,"sapup")==true){return}}if(!e.m_Touches.length){return}if(t.m_delayedExamination){e.m_Touches.pop()}if(VBI.m_bTrace){VBI.Trace("touchend")}window.clearInterval(e.m_ContextMenuTimer);e.m_ContextMenuTimer=null;if(e.DispatchEvent(t,"sapup")==true){e.m_Touches=[];return}var r=e.GetInternalDivClientRect();if(r.width!=e.m_nDivWidth||r.height!=e.m_nDivHeight){e.resizeCanvas(0)}e.m_Touches.push(t);var o;if(o=e.IsDoubleTap(e.m_Touches)){if(e.DispatchEvent(t,"sapdblclick")==true){e.m_Touches=[];t.stopPropagation();return}if(!e.m_SuppressedNavigation.zoom){e.AnimateZoom(true,o[0],o[1],5)}e.m_Touches=[]}else if(o=e.IsTwoFingerTap(e.m_Touches)){if(!e.m_SuppressedNavigation.zoom){e.AnimateZoom(false,o[0],o[1],5)}e.m_Touches=[]}else{if(!(e.m_nInputMode==VBI.InputModeTrackMap)){e.InternalRenderLayer(e.m_Canvas[e.m_nOverlayIndex],false,true,true,e.m_Canvas[0].m_nExactLOD)}}if(e.m_Touches.length>2){e.m_Touches.splice(0,e.m_Touches.length-2)}e.SetInputMode(VBI.InputModeDefault);if(o=e.IsSingleTap(e.m_Touches)){if(o.timeTouchDown<300&&!t.m_delayedExamination){e.m_TapTimer=window.setInterval(function(){t.m_delayedExamination=true;e.processtouchend(t);window.clearInterval(e.m_TapTimer)},300)}else{if(e.DispatchEvent(t,"sapclick")){e.m_Touches=[];t.stopPropagation();return}var i,s=e.m_Ctx.m_Actions;if(s){if(i=s.findAction("Click",e,"Map")){var a=e.GetInternalDivClientRect();e.m_Ctx.FireAction(i,e,"Map",null,{x:o[0]-a.left,y:o[1]-a.top})}}e.m_Touches=[]}}if(!n){t.preventDefault()}};e.processtouchcancel=function(t){if(VBI.m_bTrace){VBI.Trace("touchcancel")}if(e.DispatchEvent(t,"sapup")==true){return}e.SetInputMode(VBI.InputModeDefault);if(!n){t.preventDefault()}};e.processtouchmove=function(t){if(VBI.m_bTrace){VBI.Trace("touchmove")}if(e.m_DesignVO){if(e.DispatchEvent(t,"sapmove")==true){return}}if(!e.m_Touches.length||!e.m_currentMouseX){return}var r,o,i={},s;if(t.touches.length==1){i=t.touches[0];r=i.clientX-e.m_currentMouseX;o=i.clientY-e.m_currentMouseY;if(e.m_TouchStarted){var a=sap.ui.Device.support.retina?4:2;if(Math.abs(r)<a||Math.abs(o)<a){t.stopPropagation();return true}else{e.m_TouchStarted=false;e.m_currentMouseX=i.clientX;e.m_currentMouseY=i.clientY}}}if(VBI.m_bIsAndroid&&t.touches.length==2){var c=t.touches[0];s=t.touches[1];r=c.clientX+s.clientX-2*e.m_currentMouseX;o=c.clientY+s.clientY-2*e.m_currentMouseY;if(r==0&&o==0){t.stopPropagation();return true}}e.m_Touches.m_bMoveWasDone=true;window.clearInterval(e.m_ContextMenuTimer);e.m_ContextMenuTimer=null;var u=false;e.m_nTapCount=0;e.SetInputMode(VBI.InputModeTrackMap);if(t.touches.length==1){e.RestartContextMenuTimer(t,i,1100);if(VBI.m_bTrace){VBI.Trace("ontouchmove "+"X1:"+i.pageX+"Y1:"+i.pageY)}e.m_currentMouseX=i.clientX;e.m_currentMouseY=i.clientY;e.MoveMap(r,o);u=true}else if(t.touches.length==2&&!e.m_SuppressedNavigation.zoom){var m=e.GetInternalDivClientRect();if(m.width!=e.m_nDivWidth||m.height!=e.m_nDivHeight){e.resizeCanvas(0)}s=t.touches[0];var l=t.touches[1];var p=s.clientX+(l.clientX-s.clientX)/2;var f=s.clientY+(l.clientY-s.clientY)/2;var _=e.m_Canvas[0].getBoundingClientRect();p-=_.left;f-=_.top;var h=Math.sqrt(Math.pow(s.clientX-l.clientX,2)+Math.pow(s.clientY-l.clientY,2));if(Math.abs(e.m_currentTouchDistance-h)>10){var d=h>e.m_currentTouchDistance?true:false;e.m_currentTouchDistance=h;if(VBI.m_bTrace){VBI.Trace("ontouchmove "+" X1:"+s.pageX+" Y1:"+s.pageY+" X2:"+l.pageX+" Y2:"+l.pageY)}e.ZoomMap(d?e.m_nLodFactorZoomIn:e.m_nLodFactorZoomOut,p,f,e.m_nTicksInALod);e.TriggerReRenderTimer(400)}u=true}if(u&&!n){t.stopPropagation();return true}};e.SetInputModeTrackMap=function(t){if(!t){e.m_currentMouseX=0;e.m_currentMouseY=0}};this.subscribe()};VBI.SceneEvent=function(e,t){this.m_DeviceHandlers=[];VBI.m_bMouseSupported=false;this.m_Events=["mousedown","mouseup","mousemove","mousewheel","wheel","mouseout","click","dblclick","contextmenu","selectstart","dragstart","dragenter","dragover","dragleave","drop","dragend","keydown","keypress","keyup"];t.dropzone="true";if(sap.ui.Device.support.pointer&&navigator.msMaxTouchPoints){this.m_DeviceHandlers.push(new VBI.ScenePointerEvents(e,t))}this.clear=function(){var e;for(e=0;e<this.m_DeviceHandlers.length;++e){this.m_DeviceHandlers[e].clear()}this.m_DeviceHandlers=[];for(e=0;e<this.m_Events.length;++e){var n="on"+this.m_Events[e];if(t[n]){t[n]=null}}};this.subscribe=function(){var n=this.m_Events;for(var r=0,o=n.length;r<o;++r){var i;if(n[r].slice(0,2)=="ms"){i="process"+n[r].slice(2)}else if(e.m_SuppressedNavigation.zoom&&(n[r]==="wheel"||n[r]==="mousewheel")){continue}else{i="process"+n[r]}if(!e[i]){jQuery.sap.log.error("Handler "+i+" not defined")}t["on"+n[r]]=e[i]}};if(sap.ui.Device.support.touch&&!(sap.ui.Device.support.pointer&&navigator.msMaxTouchPoints)){this.m_DeviceHandlers.push(new VBI.SceneTouchEvents(e,t));if(!sap.ui.Device.system.desktop){return}}VBI.m_bMouseSupported=true;e.SetInputModeTrackMap=function(t){if(t){document.addEventListener("mouseup",e.processmouseup,true);document.addEventListener("mousemove",e.processmousemove,true)}else{e.m_currentMouseX=0;e.m_currentMouseY=0;document.removeEventListener("mouseup",e.processmouseup,true);document.removeEventListener("mousemove",e.processmousemove,true)}};e.onsapdown=function(t){if(VBI.m_bTrace){VBI.Trace("scene.onsapdown")}e.m_currentMouseDownX=t.clientX;e.m_currentMouseDownY=t.clientY;e.m_currentMouseX=t.clientX;e.m_currentMouseY=t.clientY;if(e.DispatchEvent(t,"sapdown")==true){return true}};e.onsapup=function(t){if(VBI.m_bTrace){VBI.Trace("scene.onsapup")}if(e.DispatchEvent(t,"sapup")==true){return}if(e.vbiclass=="3DScene"){return}e.SetInputMode(VBI.InputModeDefault);t.preventDefault();return false};e.onsapclick=function(t){if(VBI.m_bTrace){VBI.Trace("scene.onsapclick")}var n=e.m_currentMouseDownX-t.clientX;var r=e.m_currentMouseDownY-t.clientY;if(n*n+r*r<=5){if(VBI.m_bTrace){VBI.Trace("process click dispatch")}if(e.DispatchEvent(t,"sapclick")==true){if(VBI.m_bTrace){VBI.Trace("process click handled in dispatch")}return}if(e.Click){var o=e.m_Canvas[e.m_nOverlayIndex].getBoundingClientRect();t.m_clientX=t.clientX-o.left;t.m_clientY=t.clientY-o.top;if(e.Click(t)){return}}var i,s=e.m_Ctx.m_Actions;if(s){if(i=s.findAction("Click",e,"Map")){e.m_Ctx.FireAction(i,e,"Map",null,e.GetEventVPCoordsObj(t))}t.preventDefault()}}};e.onsapmove=function(t){if(VBI.m_bTrace){VBI.Trace("scene.onsapmove")}if(e.DispatchEvent(t,"sapmove")==true){return true}if(e.vbiclass=="3DScene"){return true}e.SetToolTip("");e.SetCursor("default");e.InternalSetHotItem(null,null);return false};e.processmousedown=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processmousedown")}if(e.m_Gesture){return}if(e.onsapdown(t)){return}if(e.vbiclass=="3DScene"){return}if(!e.m_SuppressedNavigation.move&&t.type.indexOf("pointer")<0&&(!sap.ui.Device.os.macintosh||t.which==1)){if(VBI.m_bTrace){VBI.Trace("set input mode track map")}e.SetInputMode(VBI.InputModeTrackMap);e.m_Canvas[e.m_nLabelIndex].focus({preventScroll:true})}};e.BuildKeyEventParams=function(e){return{key:e.key,code:e.keyCode,shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey,meta:e.metaKey}};e.processkeyup=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processkeyup")}if(t.code==undefined){t.code=t.keyCode}var n=e.m_KeysDown.indexOf(t.code);var r=e.m_KeysSkipUp.indexOf(t.code);var o=e.m_KeysSkipPress.indexOf(t.code);if(n!=-1){e.m_KeysDown.splice(n,1)}if(o!=-1){e.m_KeysSkipPress.splice(o,1)}if(r!=-1){e.m_KeysSkipUp.splice(r,1);return}if(e.m_Ctx.m_Actions){var i=e.m_Ctx.m_Actions.findAction("KeyUp",e);if(i){e.m_Ctx.FireAction(i,e,this,null,e.BuildKeyEventParams(t))}}};e.processkeypress=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processkeypress")}if(t.code==undefined){t.code=t.keyCode}var n=e.m_KeysSkipPress.indexOf(t.code);if(n!=-1){e.m_KeysSkipPress.splice(n,1);return}if(e.m_KeysDown.indexOf(t.code)==-1){return}if(e.m_Ctx.m_Actions){var r=e.m_Ctx.m_Actions.findAction("KeyPress",e);if(r){e.m_Ctx.FireAction(r,e,this,null,e.BuildKeyEventParams(t))}}};e.processkeydown=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processkeydown")}if(e.DispatchEvent(t,"sapkeydown")==true){return}t.m_Repeat=t.repeat;if(t.code==undefined){t.code=t.keyCode}if(e.m_KeysDown.indexOf(t.code)!=-1){t.m_Repeat=true}else{e.m_KeysDown.push(t.code)}if(t.m_Repeat&&!e.m_Ctx.m_Control.getAllowKeyEventRepeat()){if(e.m_KeysSkipPress.indexOf(t.code)==-1){e.m_KeysSkipPress.push(t.code)}return}if(t.code==e.m_lastKey&&e.m_lastKeyDown!=null&&Date.now()-e.m_lastKeyDown<e.m_Ctx.m_Control.getKeyEventDelay()){if(e.m_KeysSkipPress.indexOf(t.code)==-1){e.m_KeysSkipPress.push(t.code)}if(!t.m_Repeat){if(e.m_KeysSkipUp.indexOf(t.code)==-1){e.m_KeysSkipUp.push(t.code)}}return}e.m_lastKey=t.code;e.m_lastKeyDown=Date.now();var n=e.GetInternalDivClientRect();if(n.width!=e.m_nDivWidth||n.height!=e.m_nDivHeight){e.resizeCanvas(0)}var r=true;if(e.m_Ctx.m_Actions){var o=e.m_Ctx.m_Actions.findAction("KeyDown",e);if(o){r=e.m_Ctx.FireAction(o,e,this,null,e.BuildKeyEventParams(t),null,true)}}if(r){var i=false;switch(t.keyCode){case 72:e.GoToInitialStart();i=true;break;case 90:e.endTrackingMode();new e.RectangularZoom;e.m_Ctx.onChangeTrackingMode(VBI.InputModeRectZoom,true);i=true;break;case 82:e.endTrackingMode();new e.RectSelection;e.m_Ctx.onChangeTrackingMode(VBI.InputModeRectSelect,true);i=true;break;case 65:e.endTrackingMode();new e.LassoSelection;e.m_Ctx.onChangeTrackingMode(VBI.InputModeLassoSelect,true);i=true;break}if(!e.m_SuppressedNavigation.zoom){var s=0;switch(t.keyCode){case 107:case 171:case 187:s=1;break;case 109:case 173:case 189:s=-1;break}if(s!=0){var a=e.GetCenterPos();var c=e.getCanvas().m_nExactLOD;var u=e.GetMinLOD();if(s>0&&c==u&&c!=Math.ceil(c)){c=Math.ceil(c)}else{c+=s}e.AnimateZoomToGeo(a,Math.round(c),5);i=true}}if(!e.m_SuppressedNavigation.move){var m=20;switch(t.keyCode){case 37:e.MoveMap(m,0);i=true;break;case 39:e.MoveMap(-m,0);i=true;break;case 38:e.MoveMap(0,m);i=true;break;case 40:e.MoveMap(0,-m);i=true;break}}if(i){t.preventDefault()}}};e.processcontextmenu=function(t){if(t.target!=e.m_Canvas[e.m_nLabelIndex]){return}if(VBI.m_bTrace){VBI.Trace("scene.processcontextmenu")}if(e.DispatchEvent(t,"sapsecclick")==true){return}var n,r=e.m_Ctx.m_Actions;if(r){if(n=r.findAction("ContextMenu",e,"Map")){e.m_Ctx.FireAction(n,e,"Map",null,e.GetEventVPCoordsObjWithScene(t))}t.preventDefault()}};e.processmouseout=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processmouseout")}if(e.DispatchEvent(t,"sapout")==true){return}e.InternalSetHotItem(null,null);return false};e.processdblclick=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processdblclick")}if(e.DispatchEvent(t,"sapdblclick")==true){return}return};e.processclick=function(t){if(t.target!=e.m_Canvas[e.m_nLabelIndex]){return}if(VBI.m_bTrace){VBI.Trace("scene.processclick")}if(e.m_Gesture){return}return e.onsapclick(t)};e.processmouseup=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processmouseup")}e.dragclear();return e.onsapup(t)};e.processmousemove=function(t){if(VBI.m_bTrace){VBI.Trace("scene.processmousemove")}if(e.m_DragInfo){if(e.m_DragInfo.bDragStart){return false}return}var n=t.clientX-e.m_currentMouseX;var r=t.clientY-e.m_currentMouseY;e.m_currentMouseX=t.clientX;e.m_currentMouseY=t.clientY;if(e.m_Gesture){return}if(e.onsapmove(t)){return}if(e.m_nInputMode==VBI.InputModeTrackMap){if(!(t.buttons==1||t.which==1)){e.SetInputMode(VBI.InputModeDefault);return false}if(n||r){e.MoveMap(n,r)}return false}t.preventDefault()};e.processmousewheel=function(t){e.processcommonwheel(t,t.wheelDelta);return false};e.processwheel=function(t){e.processcommonwheel(t,-t.deltaY);return false};e.processcommonwheel=function(t,n){var r=e.m_Canvas[e.m_nLabelIndex].getBoundingClientRect();t.m_OffsetX=t.clientX-r.left;t.m_OffsetY=t.clientY-r.top;t.m_Delta=n;var o=Date.now();if(e.m_LastCWEvent!=undefined&&o-e.m_LastCWEvent<200){return}e.m_LastCWEvent=o;if(VBI.m_bTrace){VBI.Trace("processcommonwheel")}if(e.DispatchEvent(t)==true){return}if(e.vbiclass=="3DScene"){t.preventDefault()}else if(!e.m_SuppressedNavigation.zoom&&t.m_Delta){var r=e.GetInternalDivClientRect();if(r.width!=e.m_nDivWidth||r.height!=e.m_nDivHeight){e.resizeCanvas(0)}if(e.m_nZoomMode){var i=e.m_Canvas[0].getBoundingClientRect();e.AnimateZoom(t.m_Delta>0,t.m_OffsetX+i.left,t.m_OffsetY+i.top,5,t)}else{e.ZoomMap(t.m_Delta>0?e.m_nLodFactorZoomIn:e.m_nLodFactorZoomOut,t.m_OffsetX,t.m_OffsetY,e.m_nTicksInALod)}t.preventDefault()}return};e.dragclear=function(t){var n=document.getElementById(e.m_Target.id+"-transparentImg");if(n){e.m_Div.removeChild(n)}e.m_DragInfo=null;VBI.m_DndTarget=null};e.processdragleave=function(e){return};e.processdragend=function(t){t.preventDefault();t.stopPropagation();e.dragclear();return true};e.processselectstart=function(t){if(t.target.dragDrop&&e.m_DragInfo){t.target.dragDrop()}t.preventDefault();return true};e.processdragstart=function(t){if(e.m_DragInfo){if(e.m_DragInfo.strExtData){t.dataTransfer.setData("text",e.m_DragInfo.strExtData)}else{t.dataTransfer.setData("text","")}t.dataTransfer.effectAllowed="copy";e.m_DragInfo.bDragStart=true;VBI.m_DndTarget=t.target;if(t.dataTransfer.setDragImage||VBI.Utilities.SetDragImage){var n=VBI.Utilities.GetTransparentImage();n.id=e.m_Target.id+"-transparentImg";e.m_Div.appendChild(n);if(t.dataTransfer.setDragImage){t.dataTransfer.setDragImage(n,0,0)}else{VBI.Utilities.SetDragImage(n,0,0)}}if(e.m_Gesture){e.m_Gesture.target=null;e.m_Gesture=null}return true}return false};e.processdragenter=function(e){if(!e.dataTransfer){return false}if(e.dataTransfer){try{e.dataTransfer.dropEffect="copy"}catch(e){jQuery.sap.log.warning("scene.processdragenter exception occured: "+e.message)}}e.preventDefault();return true};e.processdragover=function(t){if(!t.dataTransfer){return false}if(e.m_Gesture){return}if(e.m_DragInfo&&e.m_DragInfo.bDragStart){e.DispatchEvent(t,"sapdrag")}else{t.preventDefault()}return};e.DesignCreateObject=function(t,n,r){var o=null;if(typeof t=="string"){o=t}else{o=JSON.stringify(t)}if(o.indexOf("{POS}")>=0){if(n){var i=""+n[0]+";"+n[1]+";"+"0.0";var s=o.replace(/{POS}/g,i);r(s)}else{new e.DesignPositionArray(null,o,r,"{POS}",1)}}else if(o.indexOf("{POSARRAY}")>=0){new e.DesignPositionArray(n?[n[0],n[1],0]:null,o,r,"{POSARRAY}",null)}else{r(t)}return};e.processdrop=function(t){if(!t.dataTransfer){e.dragclear();return false}if(e.m_DragInfo&&e.m_DragInfo.bDragStart){e.DispatchEvent(t,"sapdrop");t.preventDefault();t.stopPropagation();e.dragclear();return true}var n=t.dataTransfer.getData("text");var r=e.m_Canvas[0].getBoundingClientRect();var o=e.GetPosFromPoint([t.clientX-r.left,t.clientY-r.top,0]);var i=null,s=e.m_Ctx.m_Actions;if(s){i=e.m_Ctx.m_Actions.findAction("Drop",e,"Map")}var a=null;if(i){a=function(n){var r=e.GetEventVPCoordsObj(t);r.content=n;e.m_Ctx.FireAction(i,e,"Map",null,r)}}else{a=e.m_Ctx.m_Control.load.bind(e.m_Ctx.m_Control)}e.DesignCreateObject(n,o,a);t.preventDefault();t.stopPropagation();e.dragclear();return true};e.DesignTrack=function(t){this.m_Tcx=t;this.onsapkeydown=function(e){if(e.keyCode==27){this.UnHook(false);e.preventDefault();return true}};this.onsapclick=function(e){if(VBI.m_bTrace){VBI.Trace("Track sapclick")}this.UnHook();return false};this.onsapdown=function(e){if(VBI.m_bTrace){VBI.Trace("Track sapdown")}e.preventDefault();return true};this.onsapmove=function(e){if(VBI.m_bTrace){VBI.Trace("Track sapmove")}var t=this.m_Tcx;t.m_ClientX=e.offsetX;t.m_ClientY=e.offsetY;if(t.m_CBDrag){if(VBI.m_bTrace){VBI.Trace("Track sapmove: orig type "+e.type)}t.m_CBDrag(t,e)}e.preventDefault();e.stopPropagation();return true};this.onsapup=function(e){if(VBI.m_bTrace){VBI.Trace("Track sapup")}var t=this.m_Tcx;t.m_ClientX=e.offsetX;t.m_ClientY=e.offsetY;if(t.m_CBDrop){t.m_CBDrop(t,e)}if(t.m_CBEnd){t.m_CBEnd(t,e)}this.UnHook();e.preventDefault();e.stopPropagation();return true};this.Hook=function(){e.SetInputMode(VBI.InputModeTrackObject);e.m_DesignVO=this};this.UnHook=function(){if(e.m_DesignVO!=this){return}if(e.m_nInputMode==VBI.InputModeTrackObject){e.SetInputMode(VBI.InputModeDefault)}else{jQuery.sap.log.error("Wrong InputMode in UnHook: "+e.m_nInputMode)}e.m_DesignVO=null;this.m_Tcx=null;e.RenderAsync(true)};this.Render=function(e,t){return};this.Hook()};e.DesignPositionArray=function(t,n,r,o,i){this.m_PosArray=t?t:[];this.m_PosMove=null;this.m_Func=r;this.m_PlaceHolder=o;e.SetCursor("crosshair");this.onsapkeydown=function(e){if(e.keyCode==27){this.UnHook(false);e.preventDefault();return true}};this.onsapclick=function(t){if(VBI.m_bTrace){VBI.Trace("this.onsapclick "+t.type)}var n=e.m_Canvas[e.m_nOverlayIndex].getBoundingClientRect();var r=e.GetPosFromPoint([t.clientX-n.left,t.clientY-n.top,0]);var o=[r[0],r[1],0];var s=this.m_PosArray.length;var a=s/3;if(a>=1&&this.m_PosArray[s-3]==o[0]&&this.m_PosArray[s-2]==o[1]&&this.m_PosArray[s-1]==o[2]){return true}for(var c=0,u=o.length;c<u;++c){this.m_PosArray.push(o[c])}a=this.m_PosArray.length/3;e.RenderAsync(true);t.preventDefault();if(i&&a>=i){this.UnHook(true)}return true};this.onsapdown=function(e){e.preventDefault();return true};this.onsapmove=function(t){jQuery.sap.log.debug("this.onsapmove");jQuery.sap.log.error("Wrong InputMode in onsapmove: "+e.m_nInputMode);var n=e.m_Canvas[0].getBoundingClientRect();this.m_PosMove=e.GetPosFromPoint([t.clientX-n.left,t.clientY-n.top,0]);e.RenderAsync(true);t.preventDefault();return true};this.onsapdblclick=function(e){this.UnHook(true);return true};this.Hook=function(){e.SetInputMode(VBI.InputModeTrackDesign);e.m_DesignVO=this};this.UnHook=function(t){if(e.m_nInputMode==VBI.InputModeTrackDesign){e.SetInputMode(VBI.InputModeDefault)}else{jQuery.sap.log.error("Wrong InputMode in UnHook: "+e.m_nInputMode)}this.m_PosMove=null;var r=VBI.Types.vector2string(this.m_PosArray);var o=n.replace(new RegExp(this.m_PlaceHolder,"g"),r);e.m_DesignVO=null;e.RenderAsync(true);if(t&&this.m_Func){this.m_Func(o)}};this.Render=function(t,n){var r,o=1;if(!this.m_PosArray.length){return}var i=false;var s=this.m_PosArray.concat(this.m_PosMove);var a=e.GetNearestPosArray(s);var c=e.GetPointArrayFromPosArray(a,false);n.strokeStyle="rgba( 255, 0, 20, 0.5 )";n.lineWidth=o;var u=o*o/2;n.beginPath();var m=[c[0],c[1]];n.moveTo(c[0],c[1]);for(var l=0,p,f;l<c.length/3;++l){r=[c[l*3],c[l*3+1],0];if((p=m[0]-r[0])*p+(f=m[1]-r[1])*f<u){continue}i=true;n.lineTo(r[0],r[1]);m=r}if(i){n.stroke()}};this.Hook()};this.subscribe()};VBI.ThumbnailEvent=function(e,t){this.m_DeviceHandlers=[];this.m_Events=["click","contextmenu"];if(sap.ui.Device.support.touch&&!(sap.ui.Device.support.pointer&&navigator.msMaxTouchPoints)){var n=["touchstart","touchend"];if(!sap.ui.Device.system.desktop){this.m_Events=n}else{this.m_Events=this.m_Events.concat(n)}}this.clear=function(){var e;for(e=0;e<this.m_DeviceHandlers.length;++e){this.m_DeviceHandlers[e].clear()}this.m_DeviceHandlers=[];for(e=0;e<this.m_Events.length;++e){var n="on"+this.m_Events[e];if(t[n]){t[n]=null}}};this.subscribe=function(){var n=this.m_Events;for(var r=0,o=n.length;r<o;++r){var i;if(n[r].slice(0,2)=="ms"){i="process"+n[r].slice(2)}else{i="process"+n[r]}if(!e[i]){jQuery.sap.log.error("Handler "+i+" not defined")}t["on"+n[r]]=e[i]}};e.processclick=function(t){if(VBI.m_bTrace){VBI.Trace("thumbnail.processclick")}var n,r=e.m_Ctx.m_Actions;if(r){if(n=r.findAction("Click",e,"Thumbnail")){e.m_Ctx.FireAction(n,e,"Thumbnail",null,e.GetEventVPCoordsObj(t))}t.preventDefault()}};e.processcontextmenu=function(t){if(VBI.m_bTrace){VBI.Trace("thumbnail.processcontextMenu")}var n,r=e.m_Ctx.m_Actions;if(r){if(n=r.findAction("ContextMenu",e,"Thumbnail")){e.m_Ctx.FireAction(n,e,"Thumbnail",null,e.GetEventVPCoordsObj(t))}t.preventDefault()}};e.onPseudoThumbRightClick=function(t,n){if(VBI.m_bTrace){VBI.Trace("Pseudo Right Click")}var r;if(r=e.m_Ctx.m_Actions.findAction("ContextMenu",e,"Thumbnail")){e.m_Touches=[];var o=e.GetInternalDivClientRect();e.m_Ctx.FireAction(r,e,"Thumbnail",null,{x:n.clientX-o.left,y:n.clientY-o.top,scene:e.m_ID})}};e.RestartThumbnailCMTimer=function(t,n,r){if(e.m_ContextMenuTimer){window.clearInterval(e.m_ContextMenuTimer)}e.m_ContextMenuTimer=window.setInterval(function(){window.clearInterval(e.m_ContextMenuTimer);e.m_ContextMenuTimer=null;e.onPseudoThumbRightClick(t,n)},r)};e.processtouchstart=function(t){var n=true;if(VBI.m_bTrace){VBI.Trace("processtouchstart")}e.m_Touches.push(t);if(t.touches.length==1){var r=t.touches[0];e.m_currentMouseX=r.clientX;e.m_currentMouseY=r.clientY;e.RestartThumbnailCMTimer(t,r,700);n=true}if(n){t.preventDefault();t.stopPropagation();return false}};e.IsSingleTapOnThumb=function(e){if(e.length!=2){return null}var t=e.length-2;var n=e.length-1;if(e[t].type!="touchstart"||e[t].touches.length!=1){return null}if(e[n].type!="touchend"){return null}var r=[e[t].touches[0].clientX,e[t].touches[0].clientY];r.timeTouchDown=e[n].timeStamp-e[t].timeStamp;return r};e.processtouchend=function(t){if(!e.m_Touches.length){return}if(VBI.m_bTrace){VBI.Trace("touchend")}window.clearInterval(e.m_ContextMenuTimer);e.m_ContextMenuTimer=null;e.m_Touches.push(t);var n,r,o=e.m_Ctx.m_Actions;if((n=e.IsSingleTapOnThumb(e.m_Touches))&&o){if(r=o.findAction("Click",e,"Thumbnail")){var i=e.GetInternalDivClientRect();e.m_Ctx.FireAction(r,e,"Thumbnail",null,{x:n[0]-i.left,y:n[1]-i.top})}}e.m_Touches=[];t.stopPropagation();t.preventDefault()};this.subscribe()}});