/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./sapvbi"],function(){"use strict";VBI.Windows=function(){var e={};e.vbiclass="Windows";e.m_WindowArray=[];e.find=function(t){for(var n=0,i=e.m_WindowArray.length;n<i;++n){if(e.m_WindowArray[n].m_ID==t){return e.m_WindowArray[n]}}return null};e.clear=function(){for(var t=0;t<e.m_WindowArray.length;++t){e.m_WindowArray[t].clear()}e.m_WindowArray=[]};e.create=function(e,t){var n=null;switch(e.type){case"callout":n=new VBI.CalloutWindow;break;case"legend":n=new VBI.LegendWindow;break;default:n=new VBI.Window;break}if(n){n.load(e,t)}return n};e.load=function(t,n){var i,o,r;if(t.Remove){if(jQuery.type(t.Remove)=="object"){if(t.Remove.name){e.Remove(t.Remove.name)}}else if(jQuery.type(t.Remove)=="array"){for(o=0,r=t.Remove.length;o<r;++o){if(t.Remove[o].name){e.Remove(t.Remove[o].name)}}}}if(t.Set){var a;if(jQuery.type(t.Set)=="object"){if(t.Set.name){a=e.find(t.Set.name);if(a){a.load(t.Set.Window,n);return}else{a=e.create(t.Set.Window,n);e.Add(a);return}}e.clear();if(t.Set.Window){if(jQuery.type(t.Set.Window)=="object"){a=e.create(t.Set.Window,n);e.Add(a)}else if(jQuery.type(t.Set.Window)=="array"){i=t.Set.Window;for(o=0;o<i.length;++o){a=e.create(i[o],n);e.Add(a)}return}}}else if(jQuery.type(t.Set)=="array"){i=t.Set;for(o=0;o<i.length;++o){var l=i[o];if(l.name){a=e.find(l.name);if(a){a.load(l.Window,n)}else{a=e.create(l.Window,n);e.Add(a)}}}}}};e.Add=function(t){e.m_WindowArray.push(t)};e.Remove=function(t){var n=null;for(var i=0,o=e.m_WindowArray.length;i<o;++i){if((n=e.m_WindowArray[i]).m_ID==t){n.clear();e.m_WindowArray.splice(i,1);break}}};e.Awake=function(t){for(var n=0;n<e.m_WindowArray.length;++n){e.m_WindowArray[n].Awake(t)}};e.GetMainWindow=function(){for(var t=0;t<e.m_WindowArray.length;++t){if(e.m_WindowArray[t].m_refParent==null){return e.m_WindowArray[t]}}return null};e.NotifyDataChange=function(){var t=e.m_WindowArray;for(var n=0;n<t.length;++n){t[n].NotifyDataChange()}return null};e.NotifyResize=function(){var t=e.m_WindowArray;for(var n=0;n<t.length;++n){t[n].NotifyResize()}return null};e.NotifySceneMove=function(t){var n=e.m_WindowArray;for(var i=0,o=n.length;i<o;++i){n[i].NotifySceneMove(t)}return null};e.NotifySceneZoom=function(t){var n=e.m_WindowArray;for(var i=0,o=n.length;i<o;++i){n[i].NotifySceneZoom(t)}return null};e.Render=function(){var t=e.m_WindowArray;for(var n=0;n<t.length;++n){t[n].Render()}return null};e.RenderAsync=function(){var t=e.m_WindowArray;for(var n=0;n<t.length;++n){t[n].RenderAsync(true)}return null};return e};VBI.Window=function(){this.vbiclass="Window";this.m_ID="";this.m_Caption="";this.m_Type="";this.m_bModal=true;this.m_refScene=null;this.m_refSceneInstance=null;this.m_refParent=null;this.m_Width=null;this.m_Height=null;this.m_Div=null;this.m_Ctx=null;this.BaseLoad=function(e,t,n){if(t.id){e.m_ID=t.id}if(t.caption){e.m_Caption=t.caption}if(t.refParent){e.m_refParent=t.refParent}if(t.modal){e.m_bModal=t.ref=="true"?true:false}if(t.width){e.m_Width=parseInt(t.width,10)}if(t.height){e.m_Height=parseInt(t.height,10)}e.m_Ctx=n;if(t.refScene){e.m_refScene=t.refScene}else if(VBI.m_bTrace){VBI.Trace("Error: no scene assigned to window")}};this.BaseClear=function(){var e=this.GetScene();if(e){e.m_Parent=null}this.m_refParent=null;this.m_refScene=null;this.m_refSceneInstance=null;this.m_Ctx=null;this.m_Div=null};this.clear=function(){this.BaseClear()};this.load=function(e,t){this.BaseLoad(this,e,t)};this.GetScene=function(){if(this.m_refSceneInstance){return this.m_refSceneInstance}this.m_refSceneInstance=this.m_Ctx&&this.m_Ctx.m_SceneManager?this.m_Ctx.m_SceneManager.GetSceneByName(this.m_refScene):null;if(this.m_refSceneInstance){this.m_refSceneInstance.m_Parent=this}return this.m_refSceneInstance};this.GetHostingScene=function(){if(!this.m_refParent){return null}var e=this.m_Ctx.m_Windows.find(this.m_refParent);if(e){return e.GetScene()}return null};this.NotifyDataChange=function(){var e=this.GetScene();if(e){e.NotifyDataChange()}};this.NotifyResize=function(){return};this.NotifySceneMove=function(e){return};this.NotifySceneZoom=function(e){return};this.Render=function(){var e=this.GetScene();if(e){e.Render()}};this.RenderAsync=function(){var e=this.GetScene();if(e){if(e.RenderAsync){e.RenderAsync(true)}else{e.Render()}}};this.Awake=function(e){var t=this.GetScene();if(t){t.Awake(e)}else if(VBI.m_bTrace){VBI.Trace("Error: Awake no scene assigned to window")}};this.Create=function(e){};this.Destroy=function(){}};VBI.CalloutWindow=function(){var e=new VBI.Window;e.m_oCallout=null;e.load=function(t,n){e.BaseLoad(e,t,n);e.m_Pos=new VBI.AttributeProperty(t,"pos",null,n);e.m_OffsetX=new VBI.AttributeProperty(t,"offsetX",null,n,0);e.m_OffsetY=new VBI.AttributeProperty(t,"offsetY",null,n,0)};e.clear=function(){e.UnRegisterEvents();e.Remove();e.BaseClear();e.m_oCallout=null};e.processclosebuttonclick=function(t){e.m_Ctx.onCloseWindow(e.m_ID,e.m_oCallout.m_Content);e.clear();t.preventDefault();t.stopPropagation()};e.IsValid=function(){return e.m_oCallout&&e.m_oCallout.m_Div?true:false};e.NotifySceneMove=function(t){e.UpdatePosition()};e.NotifySceneZoom=function(t){e.UpdatePosition()};e.CalcDivPosition=function(){if(!e.IsValid()){return undefined}var t=VBI.m_bIsPhone;if(t){return undefined}var n=e.m_OffsetX.GetValueLong();var i=e.m_OffsetY.GetValueLong();var o=e.m_Pos.GetValueVector(e.m_Ctx);var r=e.GetHostingScene();var a=r.m_Canvas[r.m_nOverlayIndex];var l=a.getPixelLeft();var m=a.getPixelTop();var s=r.m_Canvas[0].m_nExactLOD;var _=parseInt(Math.pow(2,s)*r.m_nWidthCanvas/r.m_nTilesX*r.m_Proj.m_nXYRatio,10);var u=(r.m_nDivWidth-_)/2;var c=r.m_nDivWidth-u;var d=[];var f,v;var h;if(o.length>5){var g=a.getPixelWidth();var p=a.getPixelHeight();a.setPixelWidth(r.m_nWidthCanvas);a.setPixelHeight(r.m_nHeightCanvas);r.m_ZoomFactors[0]=g/r.m_nWidthCanvas;r.m_ZoomFactors[1]=p/r.m_nHeightCanvas;var C=r.GetNearestPosArray(o);var y=r.GetPointFromPos([C.m_MinX,C.m_MaxY,0],false);var w=r.GetPointFromPos([C.m_MaxX,C.m_MinY,0],false);h=r.GetInstanceOffsets([y[0],y[1],w[0],w[1]]);var D=h.length?r.GetPointArrayFromPosArray(C,false):null;var L;var b=r.GetInternalDivClientRect();var x=b.width/r.m_ZoomFactors[0];var A=b.height/r.m_ZoomFactors[1];var I=l/r.m_ZoomFactors[0];var P=m/r.m_ZoomFactors[1];var S=[-I,-P,-I+x,-P+A];for(f=0,v=h.length;f<v;++f){L=VBI.Utilities.GetMidpointsForLine(D,h[f],S);if(L.aPos.length>L.max){d=L.aPos[L.max];d[0]*=r.m_ZoomFactors[0];d[1]*=r.m_ZoomFactors[1];break}}a.setPixelWidth(g);a.setPixelHeight(p)}else{d=r.GetPointFromPos(o,true);if(d[0]+l<u){while(d[0]+l<u){d[0]+=_}}else if(d[0]+l>c){while(d[0]+l>c){d[0]-=_}}}if(d.length>1){d[0]+=l;d[1]+=m;d[0]+=n;d[1]+=i;var W=e.m_oCallout.GetAnchorPoint();d[0]-=W[0];d[1]-=W[1]}else{d.push(-1e3,-1e3)}return d};e.UpdatePosition=function(){if(!e.IsValid()){return}var t=e.CalcDivPosition();if(t){e.m_oCallout.m_Div.style.left=Math.round(t[0])+"px";e.m_oCallout.m_Div.style.top=Math.round(t[1])+"px"}else{e.m_oCallout.m_Div.style.top="";e.m_oCallout.m_Div.style.left="0px";e.m_oCallout.m_Div.style.bottom="0px"}e.m_oCallout.m_Div.style.visibility="visible"};e.Create=function(t){if(e.m_refParent&&!e.m_oCallout){var n=e.GetHostingScene();if(n){e.m_oCallout=VBI.Utilities.CreateDetail(t+"-"+e.m_ID,0,0,e.m_Width,e.m_Height,e.m_Caption,5);e.m_oCallout.m_Div.style.visibility="hidden";e.RegisterEvents();n.m_WindowLayerDiv.appendChild(e.m_oCallout.m_Div);e.m_Ctx.onOpenWindow(e.m_ID,e.m_oCallout.m_Content);e.UpdatePosition()}}};e.RegisterEvents=function(){var t=e.processclosebuttonclick.bind(e);e.m_oCallout.m_CloseButton.onclick=t;e.m_oCallout.m_CloseButton.ontouchend=t};e.UnRegisterEvents=function(){if(!e.m_oCallout||!e.m_oCallout.m_CloseButton){return}e.m_oCallout.m_CloseButton.onclick=null;e.m_oCallout.m_CloseButton.ontouchend=null};e.Remove=function(){var t=e.m_oCallout;if(!t||!t.m_Div){return}var n=t.m_Div;while(n.firstChild){n.removeChild(n.firstChild)}if(n.parentElement){n.parentElement.removeChild(n)}e.m_oCallout=null};e.Awake=function(t){if(this.m_refParent){this.Create(t)}var n=this.GetScene();if(n){n.m_Div=e.m_oCallout.m_Content;n.Awake(t)}else if(VBI.m_bTrace){VBI.Trace("Error: Awake no scene assigned to window")}};return e};VBI.LegendWindow=function(){var e=new VBI.Window;e.m_oLegend=null;e.m_Props=[];e.m_Data=[];e.m_bRenew=false;e.m_Position=[];e.m_bCreated=false;e.load=function(t,n){e.BaseLoad(e,t,n);e.m_Props.push(e.m_DataSource=new VBI.NodeProperty(t,"datasource",null,n));e.m_Props.push(e.m_Colors=new VBI.AttributeProperty(t,"colors",e.m_DataSource,n));e.m_Props.push(e.m_Images=new VBI.AttributeProperty(t,"images",e.m_DataSource,n));e.m_Props.push(e.m_Texts=new VBI.AttributeProperty(t,"texts",e.m_DataSource,n));e.m_Props.push(e.m_Tooltips=new VBI.AttributeProperty(t,"tooltips",e.m_DataSource,n));e.m_Position=[];if(t.top&&t.right){e.m_Position.push(parseInt(t.right,10));e.m_Position.push(parseInt(t.top,10))}};e.clear=function(){e.UnRegisterEvents();e.Remove();e.BaseClear();e.m_oLegend=null;if(e.m_Props){for(var t=0;t<e.m_Props.length;++t){e.m_Props[t].clear()}e.m_Props=[]}e.m_Data=[]};e.invalidate=function(){e.m_bRenew=true};e.IsValid=function(){return e.m_oLegend&&e.m_oLegend.m_Div?true:false};e.NotifySceneMove=function(e){};e.NotifySceneZoom=function(e){};e.LegendChanged=function(){var t=e.m_DataSource.GetCurrentNode(e.m_Ctx);if(t){var n=t.m_dataelements.length;if(n!=e.m_Data.length){return true}for(var i=0;i<n;++i){e.m_DataSource.Select(i);var o=e.m_Texts.GetValueString(e.m_Ctx);if(o!=e.m_Data[i].text){return true}if(e.m_Data[i].type==1){if(e.m_Data[i].value!=e.m_Images.GetValueString(e.m_Ctx)){return true}}else if(e.m_Data[i].type==2){if(e.m_Data[i].value!=e.m_Colors.GetValueColor(e.m_Ctx)){return true}}}}else{return true}return false};e.ApplyData=function(){var t=e.m_DataSource.GetCurrentNode(e.m_Ctx);if(t){var n=t.m_dataelements.length;for(var i=0;i<n;++i){var o;var r;var a={};e.m_DataSource.Select(i);a.text=e.m_Texts.GetValueString(e.m_Ctx);if(a.text){a.type=0;r=e.m_Images.GetValueString(e.m_Ctx);if(r){a.type=1;a.value=r}else{o=e.m_Colors.GetValueColor(e.m_Ctx);if(o){a.type=2;a.value=o}}e.m_Data.push(a)}}}};e.NotifyResize=function(){if(e.m_bCreated){e.calcMaxHeight()}};e.NotifyDataChange=function(){if(e.m_Props){for(var t=0,n=e.m_Props.length;t<n;++t){e.m_Props[t].NotifyDataChange(e.m_Ctx)}}if(e.LegendChanged()){e.m_Data=[];if(e.m_oLegend&&e.m_oLegend.m_Table){while(e.m_oLegend.m_Table.rows.length>0){e.m_oLegend.m_Table.deleteRow(-1)}e.ApplyData();e.FillContent();e.calcMaxHeight()}}};e.Create=function(t){var n=e.m_oLegend&&!e.m_oLegend.m_Div.parentNode;if(e.m_bRenew){e.m_Data=[];if(e.m_oLegend&&e.m_oLegend.m_Table){while(e.m_oLegend.m_Table.rows.length>0){e.m_oLegend.m_Table.deleteRow(-1)}e.ApplyData();e.FillContent()}e.m_bRenew=false}else if(e.m_refParent&&!e.m_oLegend||n){var i=e.GetHostingScene();if(i){var o=this.m_Ctx.m_Actions.findAction("Click",i,e.m_ID)?true:false;e.m_oLegend=VBI.Utilities.CreateLegend(t+"-"+e.m_ID,0,e.m_Caption,5,o);if(!n){e.ApplyData()}e.FillContent();e.m_Expanded=true;e.RegisterEvents();e.m_oLegend.m_Div=i.m_LegendLayerDiv.appendChild(e.m_oLegend.m_Div);if(e.m_Position.length==2){if(!isNaN(e.m_Position[0])){e.m_oLegend.m_Div.style.right=e.m_Position[0]+"px";e.m_oLegend.m_Div.style.left=""}if(!isNaN(e.m_Position[1])){e.m_oLegend.m_Div.style.top=e.m_Position[1]+"px"}}e.calcMaxHeight()}}e.m_bCreated=true};e.getId=function(t,n){return e.m_oLegend.m_Table.id+"-"+n+"-"+t};e.FillContent=function(){if(!e.m_Data.length){return}for(var t=0;t<e.m_Data.length;++t){var n=e.m_oLegend.m_Table.insertRow(-1);n.id=e.getId(t,"content-tablerow");n.setAttribute("role",sap.ui.core.AccessibleRole.Row);n.setAttribute("tabindex","-1");var i=n.insertCell(0);i.setAttribute("role",sap.ui.core.AccessibleRole.GridCell);i.setAttribute("tabindex","-1");var o=e.m_Data[t];if(o.type==2){var r=VBI.Utilities.CreateGeoSceneDivCSS(e.getId(t,"content-celldiv"),"vbi-legend-content-celldiv-square");r.setAttribute("role",sap.ui.core.AccessibleRole.GridCell);r.setAttribute("tabindex","-1");r.style.backgroundColor=o.value;i.appendChild(r)}else if(o.type==1){var a=e.m_Ctx.GetResources().GetImage(o.value,null,null,e.invalidate.bind());if(a){var l=a.cloneNode(true);l.setAttribute("role",sap.ui.core.AccessibleRole.Img);l.setAttribute("tabindex","-1");l.className="vbi-legend-content-celldiv";l.id=e.getId(t,"content-celldiv");i.appendChild(l)}}else{i.className="vbi-legend-content-celltext-group";i.setAttribute("role",sap.ui.core.AccessibleRole.ColumnHeader);i.setAttribute("tabindex","0");i.colSpan=2;i.innerHTML=jQuery.sap.encodeHTML(o.text)}if(o.type>0){var m=n.insertCell(1);m.setAttribute("role",sap.ui.core.AccessibleRole.GridCell);m.setAttribute("tabindex","-1");m.className="vbi-legend-content-celltext";m.id=e.getId(t,"content-celltext");m.innerHTML=jQuery.sap.encodeHTML(o.text)}}};e.processtouchend=function(t){document.removeEventListener("touchend",e.processtouchend,true);document.removeEventListener("touchmove",e.processtouchmove,true)};e.processmouseup=function(t){document.removeEventListener("mouseup",e.processmouseup,true);document.removeEventListener("mousemove",e.processmousemove,true)};e.movelegend=function(t){var n=t.slice(0);var i=e.GetHostingScene();if(n[0]<i.m_Div.clientLeft){n[0]=i.m_Div.clientLeft}if(n[0]+e.m_oLegend.m_Div.clientWidth>i.m_Div.clientLeft+i.m_Div.clientWidth){n[0]=i.m_Div.clientLeft+i.m_Div.clientWidth-e.m_oLegend.m_Div.clientWidth}if(n[1]<i.m_Div.clientTop){n[1]=i.m_Div.clientTop}if(n[1]+e.m_oLegend.m_Header.clientHeight>i.m_Div.clientTop+i.m_Div.clientHeight){n[1]=i.m_Div.clientTop+i.m_Div.clientHeight-e.m_oLegend.m_Header.clientHeight}jQuery(e.m_oLegend.m_Div).css("top",n[1]+"px");jQuery(e.m_oLegend.m_Div).css("right",i.m_Div.clientWidth-e.m_oLegend.m_Div.clientWidth-n[0]+"px");jQuery(e.m_oLegend.m_Div).css("left","");e.calcMaxHeight()};e.processtouchmove=function(t){var n=t.changedTouches[0];var i=parseInt(n.pageX,10);var o=parseInt(n.pageY,10);var r=[i-e.m_offset[0],o-e.m_offset[1]];e.movelegend(r)};e.processmousemove=function(t){if(t.which==1){var n=[t.pageX-e.m_offset[0],t.pageY-e.m_offset[1]];e.movelegend(n)}};e.processmousedragstart=function(t){if(t.which==1){e.m_offset=[t.pageX-e.m_oLegend.m_Div.offsetLeft,t.pageY-e.m_oLegend.m_Div.offsetTop];document.addEventListener("mouseup",e.processmouseup,true);document.addEventListener("mousemove",e.processmousemove,true);t.preventDefault();t.stopPropagation()}};e.processtouchdragstart=function(t){var n=t.changedTouches[0];var i=parseInt(n.pageX,10);var o=parseInt(n.pageY,10);e.m_offset=[i-e.m_oLegend.m_Div.offsetLeft,o-e.m_oLegend.m_Div.offsetTop];document.addEventListener("touchend",e.processtouchend,true);document.addEventListener("touchmove",e.processtouchmove,true);t.preventDefault();t.stopPropagation()};e.collapse=function(t){if(e.m_Expanded){e.m_oLegend.m_ButtonCol.style.visibility="hidden";e.m_oLegend.m_ButtonExp.style.visibility="";e.m_oLegend.m_Content.style.display="none";e.m_Expanded=false}};e.calcMaxHeight=function(){var t=e.GetHostingScene().m_Div.clientHeight;if(t){var n=e.m_oLegend.m_Header.clientHeight;var i=parseInt(e.m_oLegend.m_Div.style.top,10);var o=i+n;var r=t-o;e.m_oLegend.m_Content.style.maxHeight=r+"px"}};e.expand=function(t){if(!e.m_Expanded){e.m_oLegend.m_ButtonCol.style.visibility="";e.m_oLegend.m_ButtonExp.style.visibility="hidden";e.m_oLegend.m_Content.style.display="";e.m_Expanded=true}};e.clickTable=function(t){var n=t.target||t.srcElement;var i;var o=n.id.match(/\d+/g);if(o&&o.length){i=o[o.length-1]}else{o=n.parentNode.id.match(/\d+/g);if(o&&o.length){i=o[o.length-1]}}if(i){var r=e.GetHostingScene();var a={row:i,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,metaKey:t.metaKey,altKey:t.altKey};var l=null,m=this.m_Ctx.m_Actions;if(r&&m){l=this.m_Ctx.m_Actions.findAction("Click",r,e.m_ID)}if(l){this.m_Ctx.FireAction(l,r.m_ID,l.m_refVO,null,a)}}};e.RegisterEvents=function(){var t=e.processmousedragstart.bind(e);e.m_oLegend.m_Header.onmousedown=t;var n=e.processtouchdragstart.bind(e);e.m_oLegend.m_Header.ontouchstart=n;var i=e.collapse.bind(e);e.m_oLegend.m_ButtonCol.onclick=i;var o=e.expand.bind(e);e.m_oLegend.m_ButtonExp.onclick=o;var r=e.clickTable.bind(e);e.m_oLegend.m_Table.onclick=r;e.m_oLegend.m_Header.style.cursor=e.m_oLegend.m_Table.style.cursor="pointer"};e.UnRegisterEvents=function(){if(!e.m_oLegend){return}if(e.m_oLegend.m_Header){e.m_oLegend.m_Header.onmousedown=null;e.m_oLegend.m_Header.ontouchstart=null}if(e.m_oLegend.m_ButtonCol){e.m_oLegend.m_ButtonCol.onclick=null}if(e.m_oLegend.m_ButtonExp){e.m_oLegend.m_ButtonExp.onclick=null}if(e.m_oLegend.m_Table){e.m_oLegend.m_Table.onclick=null}};e.Remove=function(){var t=e.m_oLegend;if(!t||!t.m_Div){return}var n=t.m_Div;while(n.firstChild){n.removeChild(n.firstChild)}if(n.parentElement){n.parentElement.removeChild(n)}e.m_oLegend=null};e.Awake=function(t){if(e.m_refParent){e.Create(t)}var n=this.GetScene();if(n){n.Awake(t)}else if(VBI.m_bTrace){VBI.Trace("Error: Awake no scene assigned to window")}};return e}});