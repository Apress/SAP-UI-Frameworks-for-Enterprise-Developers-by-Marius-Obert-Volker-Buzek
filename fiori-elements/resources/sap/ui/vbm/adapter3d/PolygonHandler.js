/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./thirdparty/three","sap/base/Log"],function(e,t,r,o){"use strict";var n="sap.ui.vbm.PolygonHandler";var s=r.Vector3;var i=r.Matrix4;var a=t.propertyAdded;var l=t.propertyRemoved;var c=t.propertyChanged;var h=t.updateProperty;var d=t.getColor;var u=t.rgbaToString;var p=t.equalsRGBA;var f=t.createMaterial;var m=t.createLineMaterial;var g=e.extend("sap.ui.vbm.adapter3d.PolygonHandler",{constructor:function(t){e.call(this);this._root=t;this._hotInstance=null;this._instances=new Map;this._meshes=new Map;this._borders=new Map}});var y=2e3;var b=2e3;g.prototype.destroy=function(){this._root=null;this._hotInstance=null;this._meshes.forEach(function(e,t){t.forEach(function(e){this._deleteObject3D(e.object3D)},this)},this);this._borders.forEach(function(e,t){t.forEach(function(e){this._deleteObject3D(e.object3D)},this)},this);this._instances.clear();this._instances=null;this._meshes.clear();this._meshes=null;this._borders.clear();this._borders=null;e.prototype.destroy.call(this)};g.prototype.update=function(){var e=this._updateMeshes()||false;e=this._updateBorders()||e;if(this._hotInstance&&e){this._updateHot(this._hotInstance,true)}};g.prototype.addInstance=function(e){this._instances.set(e,{instance:e,indices:[],vertices:[],normal:null,lines:null,matrix:new i,color:null,colorHot:null,colorBorder:null,colorBorderHot:null,mesh:null,border:null});this.updateInstance(e)};g.prototype.updateInstance=function(e){var r=this._instances.get(e),s=false,i=false;if(r){if(c(e,["pos","rot","scale"])){t.getInstanceMatrix(e,r.matrix);s=i=true}if(c(e,"OuterNormal")){r.normal=t.toVector3(e.OuterNormal||"0;0;1").normalize();s=true}if(c(e,"posarray")){this._getGeometry(e,r.indices,r.vertices);s=i=true}if(c(e,["color","selectColor","VB:s"])){var u=d(e,e.color,false);if(!r.color||!p(u,r.color)){this._removeInstanceFromMesh(r);r.color=u;r.colorHot=d(e,e.color,true);s=true}}if(l(e,"colorBorder")){this._removeInstanceFromBorder(r);r.lines=r.colorBorder=r.colorBorderHot=null}else if(e.colorBorder){if(a(e,"colorBorder")||c(e,"posarray")){r.lines=this._getBorderGeometry(r.indices,r.vertices);i=true}if(c(e,["colorBorder","selectColor,","VB:s"])){var f=d(e,e.colorBorder,false);if(!r.colorBorder||!p(f,r.colorBorder)){this._removeInstanceFromBorder(r);r.colorBorder=f;r.colorBorderHot=d(e,e.colorBorder,true);i=true}}}if(c(e,"hotDeltaColor")){r.colorHot=d(e,e.color,true);if(r.colorBorder){r.colorBorderHot=d(e,e.colorBorder,true)}}h(e,["pos","rot","scale","OuterNormal","posarray","color","colorBorder","selectColor","hotDeltaColor","VB:s"]);if(s){this._requestMeshUpdate(r)}if(e.colorBorder){if(i){this._requestBorderUpdate(r)}}}else{o.error("Unable to find polygon instance data","",n)}};g.prototype.removeInstance=function(e){var t=this._instances.get(e);if(t){if(this._hotInstance===e){this._hotInstance=null}this._instances.delete(e);this._removeInstanceFromMesh(t);this._removeInstanceFromBorder(t);e._last={}}else{o.error("Unable to find polygon instance data","",n)}};g.prototype.updateHotInstance=function(e){if(this._hotInstance){this._updateHot(this._hotInstance,false)}if(e&&e.isPolygon){this._updateHot(e,true)}this._hotInstance=e&&e.isPolygon?e:null};g.prototype._updateHot=function(e,t){var r=this._instances.get(e),s,i,a,l;if(r){if(r.mesh){s=r.mesh.material;i=r.mesh.object3D;a=i.geometry;if(a.groups.length){a.groups=[];i.material=i.material[0]}if(t){l=r.mesh.instances.get(r);s.color.copy(r.colorHot.rgb);s.opacity=r.colorHot.opacity;s.transparent=s.opacity<1;s.needsUpdate=true;i.material=[i.material,s];a.addGroup(l.start,r.indices.length,1);if(l.start!==0){a.addGroup(0,l.start,0)}if(l.start+r.indices.length<a.index.count){a.addGroup(l.start+r.indices.length,a.index.count-l.start-r.indices.length,0)}}}if(r.border){s=r.border.material;i=r.border.object3D;a=i.geometry;var c=a.getAttribute("position");if(a.groups.length){a.groups=[];i.material=i.material[0]}if(t){l=r.border.instances.get(r);s.color.copy(r.colorBorderHot.rgb);s.opacity=r.colorBorderHot.opacity;s.transparent=s.opacity<1;s.needsUpdate=true;i.material=[i.material,s];var h=r.lines.length/3;a.addGroup(l.start,h,1);if(l.start!==0){a.addGroup(0,l.start,0)}if(l.start+h<c.count){a.addGroup(l.start+h,c.count-l.start-h,0)}}}}else{o.error("Unable to find polygon instance data","",n)}};g.prototype._getGeometry=function(e,t,o){var n,s=[],i=e.posarray.split(";");o.length=t.length=0;for(n=0;n<i.length/3;++n){var a=parseFloat(i[n*3+0]);var l=parseFloat(i[n*3+1]);var c=parseFloat(i[n*3+2]);s.push(new r.Vector2(a,l));o.push(a,l,c)}var h=r.ShapeUtils.triangulateShape(s,[]);for(n=0;n<h.length;++n){t.push(h[n][0],h[n][1],h[n][2])}};g.prototype._getBorderGeometry=function(e,t){var o=new r.BufferGeometry;o.setIndex(e);o.setAttribute("position",new r.Float32BufferAttribute(t,3));var n=new r.EdgesGeometry(o);var s=n.getAttribute("position").array;n.dispose();o.dispose();return s};g.prototype._updateMeshes=function(){var e=[],t=false,o=this._hotInstance?this._instances.get(this._hotInstance):null;this._meshes.forEach(function(n,i){for(var a=0;a<n.length;){if(n[a].dirty){var l,c,h,d=[],u=[],p=[],m=n[a];this._deleteObject3D(m.object3D);m.object3D=null;m.hitInfo.length=0;m.instances.forEach(function(e,t){c=t;e.start=d.length;for(l=0,h=u.length/3;l<c.indices.length;++l){d.push(h+c.indices[l])}var r=c.indices.length/3;m.hitInfo.length+=r;m.hitInfo.fill(c.instance,m.hitInfo.length-r,m.hitInfo.length);if(c.matrix._identity){for(l=0;l<c.vertices.length/3;++l){u.push(c.vertices[l*3],c.vertices[l*3+1],c.vertices[l*3+2]);p.push(c.normal.x,c.normal.y,c.normal.z)}}else{var o=new s;for(l=0;l<c.vertices.length/3;++l){o.set(c.vertices[l*3],c.vertices[l*3+1],c.vertices[l*3+2]);o.applyMatrix4(c.matrix);u.push(o.x,o.y,o.z);p.push(c.normal.x,c.normal.y,c.normal.z)}}});if(d.length){var g=new r.BufferGeometry;g.setIndex(d);g.setAttribute("position",new r.Float32BufferAttribute(u,3));g.setAttribute("normal",new r.Float32BufferAttribute(p,3));g.computeBoundingBox();g.computeBoundingSphere();var y=f(true);y.color.copy(c.color.rgb);y.opacity=c.color.opacity;y.transparent=y.opacity<1;y.needsUpdate=true;m.object3D=new r.Mesh(g,y);m.object3D.matrixAutoUpdate=false;m.object3D.layers.set(0);this._root.add(m.object3D);m.object3D._instanceHitTest=this._instanceHitTest.bind(m);m.triangleCount=d.length/3}if(o&&m.instances.has(o)){t=true}m.dirty=false}if(n[a].object3D){a++}else{n.splice(a,1)}}if(!n.length){e.push(i)}},this);e.forEach(function(e){this._meshes.delete(e)},this);return t};g.prototype._updateBorders=function(){var e=[],t=false,o=this._hotInstance?this._instances.get(this._hotInstance):null;this._borders.forEach(function(n,i){for(var a=0;a<n.length;){if(n[a].dirty){var l,c,h=[],d=n[a];this._deleteObject3D(d.object3D);d.object3D=null;d.instances.forEach(function(e,t){c=t;e.start=h.length/3;if(c.matrix._identity){for(l=0;l<c.lines.length;++l){h.push(c.lines[l])}}else{var r=new s;for(l=0;l<c.lines.length/3;++l){r.set(c.lines[l*3],c.lines[l*3+1],c.lines[l*3+2]);r.applyMatrix4(c.matrix);h.push(r.x,r.y,r.z)}}});if(h.length){var u=new r.BufferGeometry;u.setAttribute("position",new r.Float32BufferAttribute(h,3));u.computeBoundingBox();var p=m();p.color.copy(c.colorBorder.rgb);p.opacity=c.colorBorder.opacity;p.transparent=p.opacity<1;p.needsUpdate=true;d.object3D=new r.LineSegments(u,p);d.object3D.matrixAutoUpdate=false;d.object3D.layers.set(1);this._root.add(d.object3D);d.lineCount=h.length/6}if(o&&d.instances.has(o)){t=true}d.dirty=false}if(n[a].object3D){a++}else{n.splice(a,1)}}if(!n.length){e.push(i)}},this);e.forEach(function(e){this._borders.delete(e)},this);return t};g.prototype._requestMeshUpdate=function(e){if(e.mesh){e.mesh.dirty=true}else{var t=u(e.color);var r=this._meshes.get(t);if(!r){r=[];this._meshes.set(t,r)}for(var o=0;o<r.length;++o){if(r[o].triangleCount+e.indices.length/3<=y){e.mesh=r[o];break}}if(!e.mesh){e.mesh={dirty:true,object3D:null,material:f(true),triangleCount:0,hitInfo:[],instances:new Map};r.push(e.mesh)}e.mesh.instances.set(e,{start:0});e.mesh.dirty=true;e.mesh.triangleCount+=e.indices.length/3}};g.prototype._requestBorderUpdate=function(e){if(e.border){e.border.dirty=true}else{var t=u(e.colorBorder);var r=this._borders.get(t);if(!r){r=[];this._borders.set(t,r)}for(var o=0;o<r.length;++o){if(r[o].lineCount+e.lines.length/6<=b){e.border=r[o];break}}if(!e.border){e.border={dirty:true,object3D:null,material:m(),lineCount:0,instances:new Map};r.push(e.border)}e.border.instances.set(e,{start:0});e.border.dirty=true;e.border.lineCount+=e.lines.length/6}};g.prototype._removeInstanceFromMesh=function(e){if(e.mesh){if(e.mesh.instances.delete(e)){e.mesh.triangleCount-=e.indices.length/3;e.mesh.dirty=true;e.mesh=null}else{o.error("Unable to find instance data in polygon mesh data","",n)}}};g.prototype._removeInstanceFromBorder=function(e){if(e.border){if(e.border.instances.delete(e)){e.border.lineCount-=e.lines.length/6;e.border.dirty=true;e.border=null}else{o.error("Unable to find instance data in polygon border data","",n)}}};g.prototype._deleteObject3D=function(e){if(e){if(e.parent){e.parent.remove(e)}if(e.geometry){e.geometry.dispose()}t.toArray(e.material).forEach(function(e){e.dispose()})}};g.prototype._instanceHitTest=function(e){return e.faceIndex>=0?this.hitInfo[e.faceIndex]:null};return g});