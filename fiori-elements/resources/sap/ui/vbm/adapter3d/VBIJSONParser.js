/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./ObjectFactory","sap/base/Log","./../library"],function(e,t,n,i,r){"use strict";var a="sap.ui.vbm.VBIJSONParser";var s=t.toArray;var o=e.extend("sap.ui.vbm.adapter3d.VBIJSONParser",{constructor:function(t){e.call(this);this._context=t;this._factory=new n}});o.prototype.loadVBIJSON=function(e){if(e&&e.SAPVB){if(e.SAPVB.Resources){this._processResources(e.SAPVB.Resources)}if(e.SAPVB.Config){this._processConfig(e.SAPVB.Config)}if(e.SAPVB.DataTypes){this._processDataTypes(e.SAPVB.DataTypes)}if(e.SAPVB.Data){this._processData(e.SAPVB.Data)}if(e.SAPVB.Scenes){this._processScenes(e.SAPVB.Scenes)}if(e.SAPVB.Windows){this._processWindows(e.SAPVB.Windows)}if(e.SAPVB.Actions){this._processActions(e.SAPVB.Actions)}if(e.SAPVB.Automation){this._processAutomation(e.SAPVB.Automation)}if(e.SAPVB.Data||e.SAPVB.Scenes){this._refreshVisualObjects()}}return this};var u=function(e,t,n,i){i=s(i);for(var r=0,a=n.length;r<a;++r){var o=n[r];var u=i.length>r?i[r]:o;if(t.hasOwnProperty(o)){e[u]=t[o]}}return e};o.prototype._processResources=function(e){s(e.Set.Resource).forEach(function(e){this._context.resources.set(e.name,e.value)},this);return this};o.prototype._processConfig=function(e){s(e.Set.P).forEach(function(e){this._context.config.set(e.name,e.value)},this);return this};o.prototype._processDataTypes=function(e){if(e&&e.Set&&!Array.isArray(e.Set)&&!e.Set.name){this._context.dataTypes.splice(0);var t=function(e){var n=u(this._factory.createDataType(),e,["name","key","minSel","maxSel"]);s(e.A).forEach(function(e){n.attributes.push(u(this._factory.createDataTypeAttribute(),e,["name","alias","type"]))},this);s(e.N).forEach(function(e){n.dataTypes.push(t(e))});return n}.bind(this);s(e.Set.N).forEach(function(e){this._context.dataTypes.push(t(e))},this)}else{i.error("DataTypes: only the Set verb with no type attribute is supported.","",a)}return this};o.prototype._findDataTypeByPath=function(e){var t=function(n,i){if(i>e.length){return undefined}var r=e[i-1];for(var a=0,s=n.length;a<s;++a){var o=n[a];if(o.name===r){if(i===e.length){return o}else{return t(o.dataTypes,i+1)}}}return undefined};return t(this._context.dataTypes,1)};o.prototype._findDataTypeByDataNodePath=function(e){var t=[];for(var n=0,i=(e.length+1)/2;n<i;++n){t.push(e[n*2])}return this._findDataTypeByPath(t)};o.prototype._processData=function(e){s(e.Remove).forEach(function(e){if(e.type!=="E"){i.error("Data: the Remove verb is supported for the 'E' type only.",e.type,a);return}if(!e.name){i.error("Data: the Remove verb must have the non-empty name attribute.","",a);return}var t=this._findDataTypeByPath(e.name.split("."));if(!t){i.error("Data: the Remove verb is supported for data nodes with data types only.",e.name,a);return}var n=t.getKeyAttribute();if(!n){i.error("Data: the Remove verb is supported for data types with keys only.",e.name,a);return}var r=s(e.N.E).map(function(e){return e[n.alias]});var o=this._findDataNodeByPath(e.name.split("."));if(!o){if(r.length>0){i.warning("Data: unknown data node.",e.name,a)}return}this._removeDataInstancesByKey(o,n.name,r)},this);var t=function(e,n,r){var o=this._findDataTypeByPath(r);var u=o&&o.getKeyAttribute();s(n.E).forEach(function(n,s){var c=u?sap.ui.vbm.findInArray(e,function(e){return e[u.name]===n[u.alias]}):e[s];if(!c){c=this._factory.createDataInstance();if(u){e.push(c)}else{e[s]=c}}c.isDirty=true;for(var h in n){if(h==="N"){if(n.N.name){t(c[n.N.name]||(c[n.N.name]=this._factory.createDataNode()),n.N,r.concat(n.N.name))}else{i.error("Data: child data nodes must have names.","",a)}}else{var f=o.getAttributeByAlias(h);if(f){c[f.name]=n[h]}else{c[h]=n[h]}}}},this)}.bind(this);var n=s(e.Set);if(n.length===1&&!n[0].name){this._removeAllDataNodes();s(n.N).forEach(function(e){t(this._context.data[e.name]=this._factory.createDataInstance(),e,[e.name])},this)}else if(n.length>0){if(n.some(function(e){return!e.name})){i.error("Data: if there are multiple Set verbs then all Set verbs must have the non-empty name attribute.","",a);return this}if(n.some(function(e){return!e.N||s(e.N).length>1})){i.error("Data: all Set verbs with the name attribute must have the single N element.","",a);return this}n.forEach(function(e){var n=e.name.split(".");if(n.length!==1){i.error("Compound data node paths are not supported yet.","",a)}t(this._findDataNodeByPath(n)||(this._context.data[e.name]=this._factory.createDataNode()),e.N,[n[0]])},this)}return this};o.prototype._findDataNodeByPath=function(e){if(e.length>1){i.error("Compound paths for data nodes are not supported yet.",e,a);return undefined}return this._context.data[e[0]]};o.prototype._getDataValueByPath=function(e){if(e.length%2!==1){i.error("The absolute path to data value must contain an odd number of elements.",e.join("."),a);return undefined}var t;var n;for(var r=0,s=e.length;r<s;++r){var o=e[r];if(r%2===0){if(r===s-1){return n&&n[o]}else{t=(r==0?this._context.data:n)[o];if(t===undefined){return undefined}}}else{n=t[o];if(n===undefined){return undefined}}}return undefined};o.prototype._removeAllDataNodes=function(){for(var e in this._context.data){this._clearDataNode(this._context.data[e]);delete this._context.data[e]}return this};o.prototype._clearDataNode=function(e){e.splice(0).forEach(this._clearDataInstance,this);return this};o.prototype._clearDataInstance=function(e){if(e.visualObject){this._removeVisualObject(e.visualObject)}for(var t in e){if(Array.isArray(e[t])){this._clearDataNode(e[t]);delete e[t]}}return this};o.prototype._removeDataInstancesByKey=function(e,t,n){for(var i=e.length-1;i>=0&&n.length>0;--i){var r=e[i];var a=r[t];for(var s=n.length-1;s>=0;--s){if(a===n[s]){this._clearDataInstance(r);e.splice(i,1);n.splice(s,1);break}}}return this};o.prototype._processScenes=function(e){var t=function(e,t){u(e,t,["id","type","initialStartPosition","initialPitch","initialYaw","initialZoom"],["id","type","position","pitch","yaw","zoom"]);if(e.position||e.zoom||e.pitch||e.yaw){this._context.setupView={position:e.position,zoom:e.zoom,pitch:e.pitch,yaw:e.yaw,home:true,flyTo:false}}s(t.VO).forEach(function(t){var n=e.getVisualObjectGroupById(t.id);if(!n){n=this._factory.createVisualObjectGroup(e);for(var r in t){switch(r){case"id":case"datasource":case"type":n[r]=t[r];break;case"DragSource":case"DropTarget":break;default:if(r.endsWith(".bind")){n.isDataBound=true;var s=r.split(".")[0];var o=t[r].split(".");if(t["datasource"]){o.shift()}n.template[s]={path:o}}else{n.template[r]={value:t[r]}}break}}}else{i.warning("Scenes: cannot modify existing VO group.",t.id,a)}},this);return e}.bind(this);if(e.Remove){this._removeScenes(s(e.Remove).map(function(e){return e.name}))}if(e.Set){var n=s(e.Set);if(n.length===1&&!n[0].name){this._removeScenes(this._context.scenes.map(function(e){return e.id}))}else if(n.length>0){if(n.some(function(e){return!e.name})){i.error("Scenes: if there are multiple Set verbs then all Set verbs must have the non-empty name attribute.","",a);return this}if(n.some(function(e){return!e.Scene||s(e.Scene).length>1})){i.error("Scene: all Set verbs with the name attribute must have the single Scene element.","",a);return this}if(n.some(function(e){return e.name!==e.Scene.id})){i.error("Scene: the Set's attribute 'name' must equal the Set.Scene's attribute 'id'.","",a);return this}this._removeScenes(n.map(function(e){return e.name}))}n.forEach(function(e){s(e.Scene||e.SceneGeo).forEach(function(n){var i=this._factory.createScene(!!e.SceneGeo);t(i,n);this._context.scenes.push(i);this._context.sceneQueues.toAdd.push(i)},this)},this)}if(e.Merge){var r=s(e.Merge);if(r.length>0){if(r.some(function(e){return!e.name})){i.error("Scenes: all Merge elements must have the name attribute.","",a);return this}if(r.some(function(e){return!e.Scene||s(e.Scene).length>1})){i.error("Scenes: all Merge verbs must have the single Scene element.","",a);return this}if(r.some(function(e){return e.name!==e.Scene.id})){i.error("Scenes: the Merge's attribute 'name' must equal the Merge.Scene's attribute 'id'.","",a);return this}r.forEach(function(e){s(e.Scene||e.SceneGeo).forEach(function(n){var i=this._findSceneById(e.name);if(i){t(i,n);this._context.sceneQueues.toUpdate.push(i)}},this)},this)}}return this};o.prototype._findSceneById=function(e){for(var t=0,n=this._context.scenes.length;t<n;++t){var i=this._context.scenes[t];if(i.id===e){return i}}return undefined};o.prototype._removeScenes=function(e){for(var t=this._context.scenes.length-1;t>=0&&e.length>0;--t){var n=this._context.scenes[t];var i=n.id;for(var r=e.length-1;r>=0;--r){if(e[r]===i){this._context.sceneQueues.toRemove.push(n);this._context.scenes.splice(t,1);e.splice(r,1);n.voGroups.forEach(function(e){for(var t=e.vos.length-1;t>=0;--t){this._removeVisualObject(e.vos[t])}},this);break}}}return this};o.prototype._processVisualObjectGroup=function(e){if(e.isDataBound&&e.datasource){var t=e.datasource.split(".");var n=this._findDataNodeByPath(t);if(n){var i=this._findDataTypeByDataNodePath(t);if(i){e.maxSel=i.maxSel;e.minSel=i.minSel;var r=i.getKeyAttribute();if(r){e.keyAttributeName=r.name}}n.forEach(function(t){if(t.visualObject){if(t.isDirty||e.isDirty){this._queueVisualObjectToUpdate(e.scene,this._populateVisualObject(t.visualObject,t))}}else{this._queueVisualObjectToAdd(e.scene,this._populateVisualObject(this._factory.createVisualObject(e),t))}},this)}}else if(e.vos.length===0){this._queueVisualObjectToAdd(e.scene,this._populateVisualObject(this._factory.createVisualObject(e)))}else if(e.vos.length===1){this._queueVisualObjectToUpdate(e.scene,this._populateVisualObject(e.vos[0]))}return this};o.prototype._removeVisualObject=function(e){var t=e.voGroup.vos;var n=t.indexOf(e);if(n>=0){t.splice(n,1)}var i=e.voGroup.selected;var r=i.indexOf(e);if(r>=0){i.splice(r,1)}var a=e.voGroup.scene;e.voGroup=null;if(e.dataInstance){e.dataInstance.visualObject=null;e.dataInstance=null}this._queueVisualObjectToRemove(a,e);return this};o.prototype._populateVisualObject=function(e,t){var n=e.voGroup;var i=n.template;for(var r in i){var a=i[r],s;if("path"in a){if(t){s=t[a.path[0]];if(s!==undefined){e[r]=s}}else{s=this._getDataValueByPath(a.path);if(s!=undefined){e[r]=s}}}else{e[r]=a.value}}if(t){if(n.keyAttributeName){e.id=t[n.keyAttributeName]}t.visualObject=e;e.dataInstance=t;e["VB:c"]=t["VB:c"];var o=e["VB:s"]&&e["VB:s"]!=="false"?true:false;var u=t["VB:s"]&&t["VB:s"]!=="false"?true:false;if(o!==u){if(o){if(n.minSel==="0"||n.selected.length>1){n.selected.splice(n.selected.indexOf(e),1);e["VB:s"]="false"}}else if(n.maxSel!=="0"){if(n.maxSel==="1"){n.selected.splice(0).forEach(function(e){e["VB:s"]="false";this._queueVisualObjectToUpdate(n.scene,e)},this)}n.selected.push(e);e["VB:s"]="true"}}}return e};var c=function(e,t,n){if(e.has(t)){e.get(t).push(n)}else{e.set(t,[n])}return n};o.prototype._queueVisualObjectToAdd=function(e,t){c(this._context.voQueues.toAdd,e,t);return this};o.prototype._queueVisualObjectToUpdate=function(e,t){c(this._context.voQueues.toUpdate,e,t);return this};o.prototype._queueVisualObjectToRemove=function(e,t){c(this._context.voQueues.toRemove,e,t);return this};o.prototype._refreshVisualObjects=function(){this._context.scenes.forEach(function(e){e.voGroups.forEach(this._processVisualObjectGroup,this)},this);this._resetDirtyFlag();return this};o.prototype._processWindows=function(e){var t=function(e){for(var t=0,n=this._context.windows.length;t<n;++t){var i=this._context.windows[t];if(i.id===e){return{window:i,index:t}}}return{}}.bind(this);if(e.Remove){s(e.Remove).forEach(function(e){var n=t(e.name);if(n.window){this._context.windows.splice(n.index,1);this._context.windowQueues.toRemove.push(n.window)}},this)}if(e.Set){var n=s(e.Set);if(n.length===1&&!n[0].name){this._context.windows.splice(0).forEach(function(e){this._context.windowQueues.toRemove.push(e)},this)}else if(n.length>0){if(n.some(function(e){return!e.name})){i.error("Windows: if there are multiple Set verbs then all Set verbs must have the non-empty name attribute.","",a);return this}if(n.some(function(e){return!e.Window||s(e.Window).length>1})){i.error("Window: all Set verbs with the name attribute must have the single Window element.","",a);return this}if(n.some(function(e){return e.name!==e.Window.id})){i.error("Window: the Set's attribute 'name' must equal the Set.Window's attribute 'id'.","",a);return this}}n.forEach(function(e){s(e.Window).forEach(function(e){var n=t(e.id).window;if(n){this._context.windowQueues.toUpdate.push(n)}else{n=this._factory.createWindow();this._context.windows.push(n);this._context.windowQueues.toAdd.push(n)}u(n,e,["id","type","caption","refScene","refParent","width","height","modal"]);if("pos.bind"in e){n.pos=this._getDataValueByPath(e["pos.bind"])}else if("pos"in e){n.pos=e.pos}},this)},this)}return this};o.prototype._processActions=function(e){if(e&&e.Set&&e.Set.Action){Array.prototype.push.apply(this._context.actions,s(e.Set.Action))}return this};o.prototype._processAutomation=function(e){if(e&&e.Call){s(e.Call).forEach(function(e){switch(e.handler){case"FLYTOHANDLER":var t=s(e.Param);var n=sap.ui.vbm.findInArray(this._context.scenes,function(e){return e.id===(sap.ui.vbm.findInArray(t,function(e){return e.name==="scene"})||{})["#"]||""});if(n){var i=(sap.ui.vbm.findInArray(t,function(e){return e.name==="x"})||{})["#"]||"0";var r=(sap.ui.vbm.findInArray(t,function(e){return e.name==="y"})||{})["#"]||"0";var a=(sap.ui.vbm.findInArray(t,function(e){return e.name==="z"})||{})["#"]||"0";n.position=i+";"+r+";"+a;n.zoom=(sap.ui.vbm.findInArray(t,function(e){return e.name==="lod"})||{})["#"]||"0";n.pitch=(sap.ui.vbm.findInArray(t,function(e){return e.name==="pitch"})||{})["#"]||"0";n.yaw=(sap.ui.vbm.findInArray(t,function(e){return e.name==="yaw"})||{})["#"]||"0";this._context.setupView={position:n.position,zoom:n.zoom,pitch:n.pitch,yaw:n.yaw,flyTo:true}}break;default:break}},this)}return this};o.prototype._resetDirtyFlag=function(){for(var e in this._context.data){(function e(t){t.forEach(function(t){t.isDirty=false;for(var n in t){if(Array.isArray(t[n])){e(t[n])}}})})(this._context.data[e])}this._context.scenes.forEach(function(e){e.voGroups.forEach(function(e){e.isDirty=false})});return this};o.prototype.getAttributeAlias=function(e,t){for(var n=0;n<this._context.dataTypes.length;++n){var i=this._context.dataTypes[n];if(i.name===e){for(var r=0;r<i.attributes.length;++r){var a=i.attributes[r];if(a.name===t){return a.alias}}}}return undefined};return o});