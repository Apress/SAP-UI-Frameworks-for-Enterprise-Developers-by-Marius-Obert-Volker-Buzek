/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./thirdparty/three","sap/base/Log"],function(e,t,r){"use strict";var a="sap.ui.vbm.adapter3d.Utilities";var o=t.Color;var n=t.Vector3;var i=t.Matrix4;var l=t.Math.degToRad;var s=e.extend("sap.ui.vbm.adapter3d.Utilities",{});s.refCountPropertyName="_sapRefCount";s.refCountable=function(e){return e.hasOwnProperty(s.refCountPropertyName)};s.refCountableDispose=function(e){return e.hasOwnProperty(s.refCountPropertyName)&&e[s.refCountPropertyName]===0};s.addRef=function(e){if(!e.hasOwnProperty(s.refCountPropertyName)){e[s.refCountPropertyName]=0}e[s.refCountPropertyName]+=1};s.subRef=function(e){if(e.hasOwnProperty(s.refCountPropertyName)){e[s.refCountPropertyName]-=1;return e[s.refCountPropertyName]===0}return false};s.toArray=function(e){return e===undefined?[]:[].concat(e)};s.toBoolean=function(e){var t=e.charAt(0);return t==="t"||t!==""&&t!=="f"&&t!==" "&&t!=="0"};s.toFloat=function(e){return parseFloat(e)};s.toVector3=function(e,t){var r=e.split(";");if(r.length!==3){return t?t.set(0,0,0):new n(0,0,0)}var a=parseFloat(r[0]),o=parseFloat(r[1]),i=parseFloat(r[2]);return t?t.set(a,o,i):new n(a,o,i)};s.threeJsToVb=function(e,t){return t?t.set(-e.x,e.z,-e.y):new n(-e.x,e.z,-e.y)};s.vbToThreeJs=function(e,t){return t?t.set(-e.x,-e.z,e.y):new n(-e.x,-e.z,e.y)};s.toColor=function(){var e="\\s*(\\d+)\\s*";var t="\\s*(?:0[xX])([\\da-fA-F]+)\\s*";var n=e+"(,|;)"+e+"\\2"+e;var i=e+"(,|;)"+e+"\\2"+e+"\\2"+e;var l=t+"(,|;)"+t+"\\2"+t;var s=t+"(,|;)"+t+"\\2"+t+"\\2"+t;var c=new RegExp("^\\s*RGB\\("+n+"\\)\\s*$");var f=new RegExp("^\\s*RGB\\("+l+"\\)\\s*$");var p=new RegExp("^\\s*RGBA\\("+i+"\\)\\s*$");var u=new RegExp("^\\s*RGBA\\("+s+"\\)\\s*$");var y=new RegExp("^\\s*ARGB\\("+i+"\\)\\s*$");var v=new RegExp("^\\s*ARGB\\("+s+"\\)\\s*$");var m=new RegExp("^\\s*HLS\\("+n+"\\)\\s*$");var h=new RegExp("^\\s*HLS\\("+l+"\\)\\s*$");var d=new RegExp("^\\s*HLSA\\("+i+"\\)\\s*$");var C=new RegExp("^\\s*HLSA\\("+s+"\\)\\s*$");var g=new RegExp("^"+e+"$");var w=new RegExp("^"+t+"$");return function(e){var t;var n;var i=1;if(t=e.match(c)){n=new o(parseInt(t[1],10)/255,parseInt(t[3],10)/255,parseInt(t[4],10)/255)}else if(t=e.match(f)){n=new o(parseInt(t[1],16)/255,parseInt(t[3],16)/255,parseInt(t[4],16)/255)}else if(t=e.match(p)){n=new o(parseInt(t[1],10)/255,parseInt(t[3],10)/255,parseInt(t[4],10)/255);i=t[5]/255}else if(t=e.match(u)){n=new o(parseInt(t[1],16)/255,parseInt(t[3],16)/255,parseInt(t[4],16)/255);i=t[5]/255}else if(t=e.match(y)){n=new o(parseInt(t[3],10)/255,parseInt(t[4],10)/255,parseInt(t[5],10)/255);i=t[1]/255}else if(t=e.match(v)){n=new o(parseInt(t[3],16)/255,parseInt(t[4],16)/255,parseInt(t[5],16)/255);i=t[1]/255}else{r.warning("Cannot convert color, use default",e,a);n=new o(.5,.5,.5)}return{rgb:n,opacity:i}}}();s.toColorDelta=function(){var e="\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*";var t=new RegExp("^\\s*RHLS\\("+e+";"+e+";"+e+"\\)\\s*$");var o=new RegExp("^\\s*RHLSA\\("+e+";"+e+";"+e+";"+e+"\\)\\s*$");return function(e){var i;var l;var s=1;if(i=e.match(t)){l=new n(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]))}else if(i=e.match(o)){l=new n(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));s=parseFloat(i[4])}else{r.warning("Cannot convert color delta, use default",e,a);l=new n(1,1,1)}return{hls:l,opacity:s}}}();s.multiplyColors=function(e,t,r){r.r=s.clamp(e.r*t.r,0,1);r.g=s.clamp(e.g*t.g,0,1);r.b=s.clamp(e.b*t.b,0,1)};s.isColorDelta=function(e){return e.startsWith("RHLS")};s.applyDeltaHLS=function(e,t){var r=e.getHSL({});r.h=r.h+t.x;r.s=s.clamp(r.s*t.z,0,1);r.l=s.clamp(r.l*t.y,0,1);e.setHSL(r.h,r.s,r.l)};s.rgbaToString=function(e){return e.rgb.getHexString()+Math.round(e.opacity*255).toString(16)};s.equalsRGBA=function(e,t){return e.rgb.equals(t.rgb)&&e.opacity===t.opacity};s.getColor=function(e,t,r){var a=s.toColor(t);var o=s.toBoolean(e["VB:s"]);if(o){var n=s.isColorDelta(e.selectColor);var i=n?s.toColorDelta(e.selectColor):s.toColor(e.selectColor);if(n){s.applyDeltaHLS(a.rgb,i.hls);a.opacity=s.clamp(a.opacity*i.opacity,0,1)}else{a.rgb.copy(i.rgb);a.opacity=i.opacity}}if(r){var l=s.isColorDelta(e.hotDeltaColor);var c=l?s.toColorDelta(e.hotDeltaColor):s.toColor(e.hotDeltaColor);if(l){s.applyDeltaHLS(a.rgb,c.hls);a.opacity=s.clamp(a.opacity*c.opacity,0,1)}else{a.rgb.copy(c.rgb);a.opacity=c.opacity}}return a};s.applyColor=function(e,t,r,a,o){var n=s.toColor(t);var i=s.toBoolean(e["VB:s"]);var l,c,f,p;if(i){l=s.isColorDelta(e.selectColor);c=l?s.toColorDelta(e.selectColor):s.toColor(e.selectColor)}if(a){f=s.isColorDelta(e.hotDeltaColor);p=f?s.toColorDelta(e.hotDeltaColor):s.toColor(e.hotDeltaColor)}var u="_sapReference";s.toArray(r).forEach(function(e){e.traverse(function(e){s.toArray(e.material).forEach(function(e){if(o!==undefined){e.map=o}var t=e[u]||(e[u]={rgb:e.color.clone(),opacity:e.opacity});s.multiplyColors(t.rgb,n.rgb,e.color);e.opacity=s.clamp(t.opacity*n.opacity,0,1);if(i){if(l){s.applyDeltaHLS(e.color,c.hls);e.opacity=s.clamp(e.opacity*c.opacity,0,1)}else{e.color.copy(c.rgb);e.opacity=c.opacity}}if(a){if(f){s.applyDeltaHLS(e.color,p.hls);e.opacity=s.clamp(e.opacity*p.opacity,0,1)}else{e.color.copy(p.rgb);e.opacity=p.opacity}}e.transparent=e.opacity<1})})})};s.clamp=function(e,t,r){if(e<t){return t}if(e>r){return r}return e};s.swap=function(e,t,r){var a=e[t];e[t]=e[r];e[r]=a};s.makeDataUri=function(e){return e&&"data:text/plain;base64,"+e};s.base64ToArrayBuffer=function(e){var t=atob(e);var r=new Uint8Array(t.length);for(var a=0;a<t.length;++a){r[a]=t.charCodeAt(a)}return r.buffer};s.getInstanceTransform=function(e,t,o,c,f){s.toVector3(e.pos,t);s.toVector3(e.scale,c);var p=s.toVector3(e.rot);o.set(l(p.x),l(p.y),l(p.z),"YXZ");var u;if(e.isPolygon){u=new n(0,0,0)}else if(e.isBox||e.isCylinder){u=new n(0,0,-1)}else if(e.isModel){u=new n(0,0,-1*(f.min.z>0?f.min.z:f.max.z))}else{r.error("Unsupported instance type","",a)}if(o.x!==0||o.y!==0||o.z!==0||c.x!==1||c.y!==1||c.z!==1){var y=new i;y.makeRotationFromEuler(o);var v=new i;v.makeScale(c.x,c.y,c.z);v.multiply(y);u.applyMatrix4(v)}u.z=-u.z;t.sub(u)};s.getInstanceMatrix=function(e,r,a){var o=new n,i=new t.Euler,l=new n;s.getInstanceTransform(e,o,i,l,a);if(o.x!==0||o.y!==0||o.z!==0||i.x!==0||i.y!==0||i.z!==0||l.x!==1||l.y!==1||l.z!==1){var c=new t.Quaternion;c.setFromEuler(i,false);r.compose(o,c,l);r._identity=false}else{r.identity();r._identity=true}};s.createMaterial=function(e){return new t.MeshPhongMaterial({color:16777215,opacity:1,shininess:1,specular:1052681,side:e?t.DoubleSide:t.FrontSide})};s.createLineMaterial=function(){return new t.LineBasicMaterial({color:16777215,opacity:1,linewidth:1})};s.propertyAdded=function(e,t){return e[t]&&!e._last[t]};s.propertyRemoved=function(e,t){return!e[t]&&e._last[t]};s.propertyChanged=function(e,t){if(Array.isArray(t)){for(var r=0;r<t.length;++r){if(e[t[r]]!==e._last[t[r]]){return true}}return false}else{return e[t]!==e._last[t]}};s.updateProperty=function(e,t){if(Array.isArray(t)){t.forEach(function(t){e._last[t]=e[t]})}else{e._last[t]=e[t]}};s.normalizeObject3D=function(e,r,a){var o=(new t.Box3).setFromObject(e);var l=o.getCenter(new n);o.min.sub(new n(l.x,l.y,-l.z));o.max.sub(new n(l.x,l.y,-l.z));var c=Math.max(Math.abs(o.min.x),Math.abs(o.min.y),Math.abs(o.min.z),Math.abs(o.max.x),Math.abs(o.max.y),Math.abs(o.max.z));if(c){c=1/c}o.min.set(o.min.x*c,o.min.y*c,-o.min.z*c);o.max.set(o.max.x*c,o.max.y*c,-o.max.z*c);s.swap(o,"min","max");if(a){a.copy(o)}var f=(new i).makeScale(c,c,c);var p=(new i).makeTranslation(-l.x,-l.y,-l.z);e.updateMatrix();f.multiply(p);f.multiply(e.matrix);if(r){r.copy(f)}else{f.decompose(e.position,e.quaternion,e.scale)}};s.cloneMaterials=function(e){if(e){if(Array.isArray(e)){return e.map(function(e){return e.clone()})}return e.clone()}return e};s.getAttributeAlias=function(e,t,r){for(var a=0;a<e.dataTypes.length;++a){var o=e.dataTypes[a];if(o.name===t){for(var n=0;n<o.attributes.length;++n){var i=o.attributes[n];if(i.name===r){return i.alias}}}}return undefined};s.layersEnabled=function(e,t){return(e.mask&(1<<t|0))!==0};s.parseKeyboardShortcut=function(e){var t=[];var r={},a=false,o;r.ctrlKey=false;r.altKey=false;r.shiftKey=false;if(typeof e==="string"){o=e.split(",")}else{o=e;r.keyCode=o;t.push(r);return t}o.forEach(n);function n(e){if(e.includes("CTRL")){r.ctrlKey=true;a=true}if(e.includes("ALT")){r.altKey=true;a=true}if(e.includes("SHIFT")){r.shiftKey=true;a=true}if(a){var o=e.split("+");r.keyCode=o[o.length-1]}else{r.keyCode=e}t.push({shiftKey:r.shiftKey,ctrlKey:r.ctrlKey,altKey:r.altKey,keyCode:r.keyCode});r.ctrlKey=false;r.altKey=false;r.shiftKey=false;r.keyCode=""}return t};s.matchKeyboardShortcut=function(e,t){var r=false,a=0,o=false,n=0;if(e.altKey){a++;o=true}if(e.shiftKey){a++;o=true}if(e.ctrlKey){a++;o=true}for(var i=0;i<t.length;i++){var l=false,s=0,c=0,f=false;if(t[i].altKey||t[i].shiftKey||t[i].ctrlKey){f=true;if(t[i].altKey){n++}if(t[i].ctrlKey){n++}if(t[i].shiftKey){n++}}if(e.keyCode==t[i].keyCode){s++;l=true}else{l=false;r=false;continue}if(e.altKey||t[i].altKey){if(e.altKey==t[i].altKey){s++;c++}}if(e.shiftKey||t[i].shiftKey){if(e.shiftKey==t[i].shiftKey){s++;c++}}if(e.ctrlKey||t[i].ctrlKey){if(e.ctrlKey==t[i].ctrlKey){s++;c++}}if(s>1&&l==true&&c==a&&a==n||(s=1&&l==true&&f==false&&o==false)){r=true;break}}return r};return s});