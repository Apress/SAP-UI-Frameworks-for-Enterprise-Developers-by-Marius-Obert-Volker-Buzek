/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/core/Popup","sap/ui/core/theming/Parameters","sap/ui/core/RenderManager","./library","./ToolPopupRenderer","sap/ui/core/ResizeHandler","sap/ui/core/library","sap/base/assert","sap/base/Log","sap/ui/core/Configuration","sap/ui/dom/jquery/rect","sap/ui/dom/jquery/control","sap/ui/dom/jquery/Selectors"],function(t,e,o,i,r,s,n,a,p,u,h,l,c){"use strict";var d=u.OpenState;var f=e.extend("sap.ui.ux3.ToolPopup",{metadata:{deprecated:true,interfaces:["sap.ui.core.PopupInterface"],library:"sap.ui.ux3",properties:{title:{type:"string",group:"Misc",defaultValue:null},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},iconHover:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},iconSelected:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},modal:{type:"boolean",group:"Behavior",defaultValue:false},inverted:{type:"boolean",group:"Misc",defaultValue:true},autoClose:{type:"boolean",group:"Misc",defaultValue:false},maxHeight:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},maxWidth:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},openDuration:{type:"int",group:"Misc",defaultValue:400},closeDuration:{type:"int",group:"Misc",defaultValue:400}},defaultAggregation:"content",aggregations:{buttons:{type:"sap.ui.core.Control",multiple:true,singularName:"button"},content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},associations:{initialFocus:{type:"sap.ui.core.Control",multiple:false},opener:{type:"sap.ui.core.Control",multiple:false},defaultButton:{type:"sap.ui.core.Control",multiple:false}},events:{open:{},close:{allowPreventDefault:true},enter:{parameters:{originalEvent:{type:"object"},originalSrcControl:{type:"sap.ui.core.Control"}}},iconChanged:{},closed:{},opened:{}}}});f.ARROW_LEFT=new RegExp(/my:(left|begin)([-+]\d*\%?)?\|[a-z]+([-+]\d*\%?)? at:(right|end)\|[a-z]+/);f.ARROW_RIGHT=new RegExp(/my:(right|end)([-+]\d*\%?)?\|[a-z]+([-+]\d*\%?)? at:(left|begin)\|[a-z]+/);f.ARROW_UP=new RegExp(/my:[a-z]+([-+]\d*\%?)?\|top([-+]\d*\%?)? at:[a-z]+\|bottom/);f.ARROW_DOWN=new RegExp(/my:[a-z]+([-+]\d*\%?)?\|bottom([-+]\d*\%?)? at:[a-z]+\|top/);(function(){f.prototype.init=function(){this.oPopup=null;this._bPositionSet=false;this._mParameters={};this._mParameters.that=this;this._mParameters.firstFocusable=this.getId()+"-firstFocusable";this._mParameters.lastFocusable=this.getId()+"-lastFocusable";this._bFocusSet=false;this._proxyOpened=t.proxy(u,this);this._proxyClosed=t.proxy(_,this);this._proxyFixSize=t.proxy(a,this);this._proxyOnResize=t.proxy(m,this);P(this)};f.prototype.exit=function(){if(this.oPopup){this.oPopup.detachOpened(this._proxyOpened);this.oPopup.detachClosed(this._proxyClosed);this.oPopup.destroy();delete this.oPopup}delete this._bPositionSet;delete this._mParameters;delete this._bFocusSet;delete this._bPreventRestoreFocus;delete this._proxyOpened;delete this._proxyClosed;delete this._bRTL;delete this._sArrowDir;delete this._oArrowIcon;delete this._bThemeInverted;delete this._sInitialFocusId};var e=function(t){var e=t;h(!!e,"No ToolPopup instance given for _fnGetInitialFocus");if(!e._bFocusSet){o(e)}else{e._sInitialFocusId=e.oPopup._sInitialFocusId}return e._sInitialFocusId};var o=function(e){var o;var i;var r=e;var s=[r._mParameters.firstFocusable,r._mParameters.lastFocusable];var n=t(":sapTabbable",r.$()).get();for(var a=0;a<n.length;a++){if(s.indexOf(n[a].id)===-1){o=n[a];break}}i=t(o).control();if(i[0]){var p=i[0].getFocusDomRef();o=p||o}else{o=s[0]?window.document.getElementById(s[0]):null}if(o){if(o){o.focus()}r._sInitialFocusId=o.id}};function n(t,e){var o,i;if(!e){return null}o=sap.ui.getCore().byId(e);while(!o&&o!==t){if(!e||!document.getElementById(e)){return null}i=document.getElementById(e).parentNode;e=i.id;o=sap.ui.getCore().byId(e)}return o}f.prototype.getFocusDomRef=function(){var t;var o=n(this,this._sInitialFocusId);if(!o){this._bFocusSet=false;t=e(this);o=n(this,t)}return o?o.getDomRef():this.getDomRef()};f.prototype.onfocusin=function(e){this._mParameters.event=e;this._mParameters.$FocusablesContent=t(":sapTabbable",this.$("content"));this._mParameters.$FocusablesFooter=t(":sapTabbable",this.$("buttons"));this.oPopup.focusTabChain(this._mParameters)};var a=function(){var e=this.$();var o=0;var i=this.getMaxHeight();var r=i?parseInt(i):0;var s=this.getMaxWidth();if(s){var n=parseInt(s);var a=e.css("border-left-width");var p=parseInt(a);var u=e.css("border-right-width");var h=parseInt(u);var c=e.css("padding-left");var d=parseInt(c);var f=e.css("padding-right");var g=parseInt(f);n-=p+d+g+h;e.css("max-width",n+"px")}else{e.css("max-width","")}var P=e.css("padding-top");var v=parseInt(P);var _=e.css("padding-bottom");var m=parseInt(_);var w=e.css("border-top-width");var I=parseInt(w);var b=e.css("border-bottom-width");var x=parseInt(b);var A=v+m+I+x;var R=t(document).scrollTop();var C=e.rect();var T=C.top-R+e.outerHeight(true);var U=t(window).height();var O=T>U&&r===0;var F=0;if(O){var D=t(document.getElementById(this.getOpener()));var H=D.rect();var S=H.top-R+D.outerHeight(true);var W=this.oPopup._getPositionOffset();if(T>S&&W.length>0){F=Math.abs(parseInt(W[1]));if(T-F<U){O=false;var M="Offset of "+F+" pushes ToolPopup out of the window";l.warning(M,"","sap.ui.ux3.ToolPopup")}}r=r?r:U-C.top}e.toggleClass("sapUiUx3TPLargeContent",O);if(r||O){e.css("max-height",r+"px");var z=this.$("title");var B=this.$("title-separator");var E=this.$("buttons");var L=this.$("buttons-separator");o=r>0?r:U-C.top-m-F;o-=A;o-=z.outerHeight(true);o-=B.outerHeight(true);o-=L.outerHeight(true);o-=E.length>0?E.outerHeight(true):0;o=parseInt(o);var N=this.$("content");N.css("max-height",o+"px");N.toggleClass("sapUiUx3TPLargeContent",true)}y(this)};var u=function(){this._proxyFixSize();if(!this._sInitialFocusId){var o=e(this);if(o!==sap.ui.getCore().getCurrentFocusedControlId()){var i=t(document.getElementById(o));i.trigger("focus")}}if(!this._sResizeID){this._sResizeID=p.register(this.$("content")[0],this._proxyOnResize)}this.fireOpened()};f.prototype.isOpen=function(){return this.oPopup&&(this.oPopup.getOpenState()=="OPENING"||this.oPopup.getOpenState()=="OPEN")};f.prototype.willBeClosed=function(){var t=this.oPopup&&this.oPopup.getOpenState();return t!==d.OPENING&&t!==d.OPEN};f.prototype.open=function(t,e){this._my=t;this._at=e;this._sArrowDir=v(this);var o=null;this.sOffset="";x(this);if(!this._bPositionSet){var r=0;var s=0;if(!this._my){this._my=i.Dock.BeginTop}if(!this._at){this._at=i.Dock.EndTop}o=this.getOpener()?window.document.getElementById(this.getOpener()):null;if(o){switch(this._sArrowDir){case"Up":r=0;s=this.iArrowWidth;break;case"Down":r=0;s=-this.iArrowWidth;break;case"Right":r=-this.iArrowWidth;break;case"Left":default:r=this.iArrowWidth;break}r=parseInt(r);s=parseInt(s);this.sOffset=""+r+" "+s;this.setPosition(this._my,this._at,o,this.sOffset,"none")}else{this.setPosition(i.Dock.BeginTop,i.Dock.BeginTop,window,"0 0","fit");l.warning("No opener set. Using a default position for Popup","","sap.ui.ux3.ToolPopup")}this._bPositionSet=false}this._ensurePopup();var n=this.getAutoClose();var a=this.getModal();if(n&&a){l.warning("A modal & autoclose ToolPopup will not work properly. Therefore 'autoclose' will be deactived!");n=false}this.oPopup.setAutoClose(n);this.oPopup.setModal(a);this._oPreviousFocus=i.getCurrentFocusInfo();this.fireOpen();g(this);this.oPopup.open(this.getOpenDuration(),this._my,this._at,o,this.sOffset,"",true);y(this);return this};var g=function(t){if(!t.getOpener()){var e="";if(t.oPopup){if(t.oPopup._oPosition.of instanceof sap.ui.core.Element){e=t.oPopup._oPosition.of.getId()}else{if(t.oPopup._oPosition.of.length>0){e=t.oPopup._oPosition.of[0].id}else{e=t.oPopup._oPosition.of.id}}}if(e!==""){t.setAssociation("opener",e,true)}else{l.error("Neither an opener was set properly nor a corresponding one can be distinguished","","sap.ui.ux3.ToolPopup")}}};var P=function(t){var e=Object.assign({sapUiUx3ToolPopupArrowWidth:"13px",sapUiUx3ToolPopupArrowHeight:"24px",sapUiUx3ToolPopupArrowRightMarginCorrection:"-2px",sapUiUx3ToolPopupArrowRightMarginCorrectionInverted:"-7px"},r.get({name:["sapUiUx3ToolPopupArrowWidth","sapUiUx3ToolPopupArrowHeight","sapUiUx3ToolPopupArrowRightMarginCorrection","sapUiUx3ToolPopupArrowRightMarginCorrectionInverted"],callback:function(){t.invalidate()}}));var o="sapUiUx3ToolPopupArrowWidth";t.sArrowWidth=e[o];t.iArrowWidth=parseInt(t.sArrowWidth);o="sapUiUx3ToolPopupArrowHeight";t.sArrowHeight=e[o];t.iArrowHeight=parseInt(t.sArrowHeight);o="sapUiUx3ToolPopupArrowRightMarginCorrection";t.sArrowPadding=e[o];t.iArrowPadding=parseInt(t.sArrowPadding);o="sapUiUx3ToolPopupArrowRightMarginCorrectionInverted";t.sArrowPaddingInverted=e[o];t.iArrowPaddingInverted=parseInt(t.sArrowPaddingInverted)};var v=function(e){var o="Left";var i=e._my;var r=e._at;if(!i&&e.oPopup){i=e.oPopup._oPosition.my}if(!r&&e.oPopup){r=e.oPopup._oPosition.at}e._bHorizontalArrow=false;if(i&&r){var s=i.split(" ");var n=r.split(" ");var a="my:"+s[0]+"|"+s[1];a+=" at:"+n[0]+"|"+n[1];if(f.ARROW_LEFT.exec(a)){e._bHorizontalArrow=true;o="Left"}else if(f.ARROW_RIGHT.exec(a)){e._bHorizontalArrow=true;o="Right"}else if(f.ARROW_UP.exec(a)){o="Up"}else if(f.ARROW_DOWN.exec(a)){o="Down"}if(e.getDomRef()&&e.isOpen()){var p=e.$();var u=p.rect();var h=t(document.getElementById(e.getOpener()));var l=h.rect();if(l){if(e._bHorizontalArrow){var c=u.left+p.outerWidth(true)+e.iArrowWidth;var d=l.left+h.outerWidth(true);if(c<=d){o="Right"}else{o="Left"}}else{var g=u.top+p.outerHeight(true)+e.iArrowWidth;var P=l.top+h.outerHeight(true);if(g<=P){o="Down"}else{o="Up"}}}}}return o};var y=function(e){var o="",i=0,r=0,s=e.iArrowHeight/2,n=c.getRTL(),a,p=e.$().rect(),u=t(document.getElementById(e.getOpener())),h=u.rect(),d=0,f=e.$("arrow");if(!e.getDomRef()){return}e._sArrowDir=v(e);a=e._sArrowDir;if(n){if(e._sArrowDir==="Right"){a="Left"}else if(e._sArrowDir==="Left"){a="Right"}}if(!h){l.warning("Opener wasn't set properly. Therefore arrow will be at a default position","","sap.ui.ux3.ToolPopup")}if(!e._my&&e.oPopup){e._my=e.oPopup._oPosition.my}if(e._bHorizontalArrow){o="top";if(h){d=parseInt(e.$().css("border-top-width"))||0;r=parseInt(h.top-d-p.top);i=Math.round(r+h.height/2-s);i=i+s>p.height?i-e.iArrowHeight:i}}else{o="left";if(h){if(n){o="right";d=parseInt(e.$().css("border-right-width"))||0;r=parseInt(p.left+p.width-h.left-h.width-d)}else{d=parseInt(e.$().css("border-left-width"))||0;r=parseInt(h.left-p.left-d)}i=Math.round(r+h.width/2-s);i=i+s>p.width?i-e.iArrowHeight:i}}if(!h){i=e.iArrowHeight}var g="";if(f.hasClass("sapUiUx3TPNewArrow")){g="sapUiUx3TPNewArrow sapUiUx3TPNewArrow"}else{g=e.isInverted()?"sapUiUx3TPArrow sapUiTPInverted sapUiUx3TPArrow":"sapUiUx3TPArrow sapUiUx3TPArrow"}f.attr("class",g+a);if(a==="Right"){var P=p.width;if(e.isInverted()){P+=e.iArrowPaddingInverted}else{P+=e.iArrowPadding}if(n){f.css("right",P+"px")}else{f.css("left",P+"px")}}else{f.css({left:"",right:""})}i=parseInt(i);i=i<-d?-d:i;f.css(o,i+"px")};f.prototype.onsapescape=function(){if(this.fireClose()){this.close()}};var _=function(t){if(!this._bPreventRestoreFocus){i.applyFocusInfo(this._oPreviousFocus)}if(this.getDomRef()){s.preserveContent(this.getDomRef());this.$().remove()}this.fireClosed()};f.prototype.close=function(t){if(this.oPopup&&this.oPopup.isOpen()){if(this._sResizeID){p.deregister(this._sResizeID);delete this._sResizeID}this.oPopup.close(this.getCloseDuration());this._bPreventRestoreFocus=t}return this};f.prototype.getEnabled=function(){var t=this.oPopup?this.oPopup.getOpenState():d.CLOSED;return t===d.OPENING||t===d.OPEN};f.prototype.onsapenter=function(e){var o=this.getDefaultButton();var i=sap.ui.getCore().byId(o);if(o&&i&&t.contains(this.getDomRef(),i.getDomRef())){if(i instanceof sap.ui.commons.Button){var r=i.$();r.trigger("click");r.trigger("focus")}}e.preventDefault();e.stopPropagation()};f.prototype.onBeforeRendering=function(){P(this);var t=this.getInitialFocus()||this._sInitialFocusId;var e=this.getDefaultButton();this._bFocusSet=true;if(t){this.oPopup.setInitialFocusId(t)}else if(e){this.oPopup.setInitialFocusId(e)}else{this._bFocusSet=false}this._bRTL=c.getRTL()};f.prototype._ensurePopup=function(){if(!this.oPopup){this.oPopup=new i(this,false,true,false);this.oPopup.attachOpened(this._proxyOpened);this.oPopup.attachClosed(this._proxyClosed);var e=this;this.oPopup._applyPosition=function(){i.prototype._applyPosition.apply(e.oPopup,arguments);var o=e.oPopup._oLastPosition.of;if(!o){e.oPopup.close()}else{var r=t(document.getElementById(o.id));if(e._bPositionSet){if(!r.hasClass("sapUiUx3ShellTool")){e._my=e.oPopup._oLastPosition.my;e._at=e.oPopup._oLastPosition.at}}y(e)}}}return this.oPopup};var m=function(){if(this.getContent().length){this._proxyFixSize();this.oPopup._applyPosition(this.oPopup._oLastPosition)}};f.prototype.setPosition=function(){this._ensurePopup();this.oPopup.setPosition.apply(this.oPopup,arguments);this._bPositionSet=true;g(this);return this};var w=function(t,e){var o=t;if(e==="content"){I(o)}else if(e==="buttons"){b(o)}o._proxyFixSize();o.oPopup._applyPosition(o.oPopup._oLastPosition)};var I=function(t){var e=t.getDomRef("content");e.innerHTML="";var o=t.getContent();var i=sap.ui.getCore().createRenderManager();for(var r=0;r<o.length;r++){i.renderControl(o[r])}i.flush(e,true);i.destroy()};var b=function(e){var o=e.getDomRef("buttons");var i=e.getDomRef("buttons-separator");var r=e.getButtons();if(r.length===0){t(o).addClass("sapUiUx3TPButtonRowHidden");t(i).addClass("sapUiUx3TPButtonRowHidden")}else{t(o).removeClass("sapUiUx3TPButtonRowHidden");t(i).removeClass("sapUiUx3TPButtonRowHidden");o.innerHTML="";var s=sap.ui.getCore().createRenderManager();for(var n=0;n<r.length;n++){s.renderControl(r[n])}s.flush(o,true);s.destroy()}};f.prototype.addContent=function(t){this.addAggregation("content",t,true);if(this.isOpen()){w(this,"content")}return this};f.prototype.insertContent=function(t,e){this.insertAggregation("content",t,e,true);if(this.isOpen()){w(this,"content")}return this};f.prototype.removeContent=function(t){this.removeAggregation("content",t,true);if(this.isOpen()){w(this,"content")}return this};f.prototype.addButton=function(t){this.addAggregation("buttons",t,true);if(this.isOpen()){w(this,"buttons")}return this};f.prototype.insertButton=function(t,e){this.insertAggregation("buttons",t,e,true);if(this.isOpen()){w(this,"buttons")}return this};f.prototype.removeButton=function(t){this.removeAggregation("button",t,true);if(this.isOpen()){w(this,"buttons")}return this};var x=function(t){var e="sapUiUx3ToolPopupInverted";e=r.get({name:e,callback:function(o){t._bThemeInverted=e==="true";t.invalidate()}})||"true";t._bThemeInverted=e==="true"};f.prototype.onThemeChanged=function(){x(this)};f.prototype.isInverted=function(){x(this);return this.getInverted()&&this._bThemeInverted};f.prototype.setAutoCloseAreas=function(t){this._ensurePopup();return this.oPopup.setAutoCloseAreas(t)};f.prototype.addFocusableArea=function(t){this._ensurePopup();if(typeof t==="string"){this.oPopup._addFocusableArea("channelId","eventId",{id:t});return this}else{l.error("Wrong type of focusable area ID - string expected","","sap.ui.ux3.ToolPopup")}};f.prototype.removeFocusableArea=function(t){this._ensurePopup();if(typeof t==="string"){this.oPopup._removeFocusableArea("channelId","eventId",{id:t});return this}else{l.error("Wrong type of focusable area ID - string expected","","sap.ui.ux3.ToolPopup")}}})();f.prototype.setIcon=function(t){this.setProperty("icon",t,true);this.fireIconChanged();return this};f.prototype.setIconHover=function(t){this.setProperty("iconHover",t,true);this.fireIconChanged();return this};f.prototype.setIconSelected=function(t){this.setProperty("iconSelected",t,true);this.fireIconChanged();return this};f.prototype.getIconSelected=function(){return this.getProperty("iconSelected")||this.getProperty("iconHover")};f.prototype.setMaxWidth=function(t){var e=/[0-9]+px/;if(e.test(t)){this.setProperty("maxWidth",t)}else{l.error("Only values in pixels are possible","","sap.ui.ux3.ToolPopup")}return this};return f});