/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/m/Button","sap/m/Dialog","sap/m/DialogRenderer","sap/m/HBox","sap/m/Table","sap/m/ColumnListItem","sap/m/Column","sap/ui/model/odata/v4/ODataModel","sap/m/Select","sap/m/Label","sap/m/Input","sap/ui/layout/form/SimpleForm","sap/ui/core/IconPool","sap/ui/core/Icon","sap/m/Page","sap/m/Breadcrumbs","sap/m/Link","sap/m/Text","./CloudFileInfo","./library","sap/m/library","sap/ui/core/library","sap/ui/layout/FixFlex","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/Title","sap/m/ColumnPopoverSelectListItem","sap/m/ColumnHeaderPopover","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/m/SearchField","sap/m/OverflowToolbarLayoutData","sap/ui/Device","sap/base/Log","sap/ui/model/odata/type/DateTimeOffset","sap/ui/core/Item","sap/ui/core/SortOrder","sap/m/IllustratedMessage","sap/m/IllustratedMessageType","sap/m/IllustratedMessageSize","sap/ui/core/format/FileSizeFormat"],function(e,t,i,n,o,a,s,r,l,h,u,d,c,m,g,p,C,f,b,F,S,T,I,y,w,v,_,L,N,x,B,D,k,E,P,M,O,V,A,R,U){"use strict";var z=S.DialogType;var K=S.ButtonType;var j=T.ValueState;var H=F.FilePickerModes;var $=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var W=t.extend("sap.suite.ui.commons.CloudFilePicker",{metadata:{library:"sap.suite.ui.commons",properties:{serviceUrl:{type:"sap.ui.core.URI",group:"Data",defaultValue:""},sharedModel:{type:"object",group:"Misc",defaultValue:null},confirmButtonText:{type:"string",group:"Data",defaultValue:$.getText("CFP_BUTTON_SELECT")},filePickerMode:{type:"sap.suite.ui.commons.FilePickerModes",group:"Data",defaultValue:"All"},title:{type:"string",group:"Data",defaultValue:$.getText("CFP_TITLE")},enableDuplicateCheck:{type:"boolean",group:"Data",defaultValue:false},duplicateMessage:{type:"string",group:"Data"},suggestedFileName:{type:"string",group:"Data"},fileNameMandatory:{type:"boolean",group:"Data",defaultValue:false}},events:{select:{parameters:{replaceExistingFile:"boolean",selectedFileName:"string",selectedFiles:{type:"sap.suite.ui.commons.CloudFileInfo[]"},selectedFolder:{type:"sap.suite.ui.commons.CloudFileInfo"}}},cancel:{}}},constructor:function(){t.prototype.constructor.apply(this,arguments);this.oTableControl=null;this.oSelectControl=null;this.oBreadcrumbLinkControl=null;this.oFileNameControl=null;this.aVisibleLinks=null;this.oNavigationMap=null;this.oConfirmationButton=null;this.oNewFolderButton=null;this.oNewFolderColumnListItem=null;this.oCurrentParentData=null;this.setResizable(true);this.setDraggable(true);this._createDialogContent();this._createButton();if(k.system.phone){this.setStretch(true)}else{this.setStretch(false);this.setContentWidth("780px");this.setContentHeight("48.75rem")}this.setHorizontalScrolling(false);this.setVerticalScrolling(false);this.setTitle(this.getTitle());this.setBusyIndicatorDelay(0);this.setBusy(true)},renderer:i});W.prototype._createDialogContent=function(){var e=this.getServiceUrl(),t=this.getSharedModel();if(!e&&!t){E.error("Invalid Configuration")}if(!t&&e){t=new r({serviceUrl:e,synchronizationMode:"None",earlyRequests:true})}if(t){t.setSizeLimit(200)}this.setModel(t);var i=this._createCloudDropdownAndFileNameField();this.oBreadcrumbLinkControl=this._createBreadcrumbLinks();var n=this._createTableContent();var o=new I({fixContent:[i,this.oBreadcrumbLinkControl],flexContent:n});this.addContent(o)};W.prototype._createCloudDropdownAndFileNameField=function(){var t=new h({text:$.getText("CFP_LOCATION"),showColon:true,labelFor:this.getId()+"-cloudSpaceSelect"}).addStyleClass(k.system.desktop?"sapUiTinyMarginTop":"");this.oSelectControl=new l({id:this.getId()+"-cloudSpaceSelect",forceSelection:false,change:function(e){this.oTableControl.setBusyIndicatorDelay(0);this.oTableControl.setNoDataText(" ");this.oFileNameControl.setValue(this.getSuggestedFileName());this.oBreadcrumbLinkControl.destroyLinks();this._initializeVisibleLinks();var t=e.getParameters().selectedItem;this._loadFileShareRootFolder(t.getKey())}.bind(this)}).bindItems({path:"/FileShares",events:{dataReceived:function(t){var i=t.getParameters();if(i.error||!Object.keys(i.data).length&&!t.getSource().getCurrentContexts().length){this.setBusy(false);var n=new V({illustrationType:A.ErrorScreen,illustrationSize:R.Spot,enableVerticalResponsiveness:true,title:$.getText("CFP_NO_FILESHARE_FOUND"),description:$.getText("CFP_NO_FILESHARE_FOUND_RELOAD"),additionalContent:[new e({text:$.getText("CFP_BUTTON_RELOAD"),press:function(){this.oSelectControl.getBinding("items").refresh()}})]});this.oTableControl.setNoData(n)}else{if(t.getSource()&&t.getSource().getContexts()&&t.getSource().getContexts().length){var o=t.getSource().getContexts()[0].sPath;var a=o.split(/[']/)[1];this.oSelectControl.setSelectedKey(a);setTimeout(function(){this._initializeVisibleLinks()}.bind(this));this._loadFileShareRootFolder(this.oSelectControl.getSelectedKey())}}}.bind(this)},template:new M({key:"{FileShare}",text:{parts:["FileShare","FileShareDescription"],formatter:function(e,t){return t?t:e}}})});var i=new d({layout:"ResponsiveGridLayout",singleContainerFullSize:false});i.addContent(t);i.addContent(this.oSelectControl);var n=new h({text:$.getText("CFP_FILENAME"),showColon:true,labelFor:this.getId()+"-fileName"}).addStyleClass(k.system.desktop?"sapUiTinyMarginTop":"");this.oFileNameControl=new u({id:this.getId()+"-fileName",liveChange:function(e){this.oTableControl.removeSelections();var t=this.oNavigationMap.get(this.aVisibleLinks[this.aVisibleLinks.length-1].fileShareItemId);this._setConfirmationButtonEnabled(null,t,true)}.bind(this)});i.addContent(n);i.addContent(this.oFileNameControl);if(this.getFilePickerMode()===H.FileOnly){this.oFileNameControl.setVisible(false)}else{this.oFileNameControl.setValue(this.getSuggestedFileName())}return i};W.prototype._createBreadcrumbLinks=function(){this.oBreadcrumbLinkControl=new p(this.getId()+"-breadcrumbs").addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginEnd");this.oNavigationMap=new Map;this._initializeVisibleLinks();return this.oBreadcrumbLinkControl};W.prototype._initializeVisibleLinks=function(){var e=this.oSelectControl.getSelectedItem()?this.oSelectControl.getSelectedItem().getText():"";var t={fileShareItemId:"Root",title:e};this.aVisibleLinks=[t];this.oBreadcrumbLinkControl.setCurrentLocationText(e);this.oNavigationMap.clear()};W.prototype._createTableContent=function(){this.oNewFolderButton=new e({text:$.getText("CFP_TITLE_NEWFOLDER"),type:K.Transparent,enabled:false,press:function(){this._createNewFolderInline()}.bind(this)});this.oTableControl=new o({headerToolbar:new y({content:[new v({text:$.getText("CFP_LIST_HEADER")}),new w,new B({layoutData:new D({minWidth:"200px",maxWidth:"300px",shrinkable:true,moveToOverflow:false}),visible:false}),this.oNewFolderButton],design:"Transparent"}),columns:[new s({header:new f({text:$.getText("CFP_NAME")}),customData:[new N({key:"bindingProperty",value:"FileShareItemName"})],width:"auto",importance:"High"}),new s({hAlign:"Left",header:new f({text:$.getText("CFP_TYPE")}),customData:[new N({key:"bindingProperty",value:"FileShareItemContentType"})],width:"17%",importance:"High"}),new s({header:new f({text:$.getText("CFP_OWNER")}),customData:[new N({key:"bindingProperty",value:"CreatedByUser"})],width:"17%",importance:"Low",visible:k.system.phone?false:true}),new s({hAlign:"End",header:new f({text:$.getText("CFP_TITLE_LAST_CHANGED_ON")}),customData:[new N({key:"bindingProperty",value:"LastChangeDateTime"})],width:"17%",importance:"Low",visible:k.system.phone?false:true}),new s({hAlign:"End",header:new f({text:$.getText("CFP_FILESIZE")}),customData:[new N({key:"bindingProperty",value:"FileShareItemContentSize"})],width:"10%",importance:"Low",visible:k.system.phone?false:true})],autoPopinMode:true,sticky:["HeaderToolbar","ColumnHeaders"],headerDesign:"Plain",noDataText:" ",mode:"SingleSelectMaster",itemPress:function(e){this.oTableControl.setBusyIndicatorDelay(0);this.oTableControl.setNoDataText(" ");var t=e.getParameters().listItem;var i=t.getBindingContext();var n=i.getObject("FileShareItemKind")==="folder";if(n){var o=this._createSelectionParameter(t);var a=o.getFileShareItemId();o.path=i.getCanonicalPath();this.oCurrentParentData=o;this.oNavigationMap.set(a,o);var s=i.getModel().createBindingContext(o.path);this.aVisibleLinks.push({fileShareItemId:a,title:t.getCells()[0].getItems()[1].getText()});this._updateBreadcrumbLinks();this.oTableControl.setBindingContext(s)}else{var r=i.getProperty("FileShareItemName");this.oFileNameControl.setValue(r)}}.bind(this),items:{path:"_Children",parameters:{$$operationMode:"Server"},sorter:[new x({path:"FileShareItemKind",descending:true}),new x({path:"FileShareItemName",descending:false})],events:{dataReceived:function(){this.oTableControl.setNoData(null);this.oTableControl.setNoDataText($.getText("CFP_NO_DATA_FILESHARE"));this.setBusy(false)}.bind(this)},template:new a({cells:[new n({items:[new m({src:{parts:["FileShareItemKind","FileShareItemContentType","isDocumentCreationAllowed"],formatter:function(e,t,i){if(e==="folder"){if(i==="No"){return"sap-icon://locked"}else{return"sap-icon://folder-full"}}else{return c.getIconForMimeType(t)}}}}).addStyleClass("sapUiTinyMarginEnd"),new f({text:"{FileShareItemName}"})]}),new f({text:"{FileShareItemHumanContentType}"}),new f({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${CreatedByUser}}"}),new f({text:{parts:["FileShareItemKind","LastChangeDateTime"],formatter:function(e,t){if(e==="folder"){return""}else{var i=new P({style:"short"});return i.formatValue(new Date(t),"string")}}}}),new f({text:{parts:["FileShareItemKind","FileShareItemContentSize"],formatter:function(e,t){if(e!=="folder"){var i=U.getInstance({binaryFilesize:false,maxFractionDigits:1,maxIntegerDigits:3}).format(t.split(",").join(""));return i}else{return""}}}})],type:"{= ${FileShareItemKind} === 'folder' ? 'Navigation' : 'Active'}"})},updateFinished:function(e){if(!this.oTableControl.getBusy()){if(this.oCurrentParentData&&Object.keys(this.oCurrentParentData).length!==0){this._setConfirmationButtonEnabled(this.oCurrentParentData.getProperty("isDocumentCreationAllowed"));this._enableDisableNewFolderBtn()}}}.bind(this)});this.oTableControl.bActiveHeaders=true;this.oTableControl.attachEvent("columnPress",function(e){var t=e.getParameter("column"),i=t.getCustomData()[0].getValue();if(i==="CreatedByUser"||i==="FileShareItemContentSize"||i==="FileShareItemContentType"){return}var n=[new _({icon:"sap-icon://sort-ascending",action:function(){this._fHandleSorting(t,true)}.bind(this)}),new _({icon:"sap-icon://sort-descending",action:function(){this._fHandleSorting(t,false)}.bind(this)})];var o=new L({items:[n]});o.openBy(t)}.bind(this));var t=new g({showHeader:false,content:[this.oTableControl],enableScrolling:true});return t};W.prototype._createNewFolderInline=function(){var e=new u({placeholder:"Enter Folder Name",width:"100%",visible:true,value:$.getText("CFP_TITLE_NEWFOLDER")});e.attachBrowserEvent("focusout",function(t){if(this._checkForDuplicateInTable(this.oTableControl,t.target.value.toLowerCase())){e.setValueState(j.Error);e.setValueStateText($.getText("CFP_FOLDER_EXIST"))}else{e.setValueState(j.None);e.setValueStateText("");this._makeNewFolderEntry(t.target.value)}}.bind(this));this.oNewFolderColumnListItem=new a({cells:[new n({items:[e]}),new f({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${FileShareItemContentType}}"}),new f({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${CreatedByUser}}"}),new f({text:{parts:["FileShareItemKind","LastChangeDateTime"],formatter:function(e,t){if(e==="folder"){return""}else{if(t){var i=new P({style:"short"});return i.formatValue(new Date(t),"string")}}}}}),new f({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${FileShareItemContentSize}}"})]});this._setConfirmationButtonEnabled(false);this.oNewFolderButton.setEnabled(false);this.oTableControl.insertItem(this.oNewFolderColumnListItem);setTimeout(function(){e.focus()})};W.prototype._checkForDuplicateInTable=function(e,t){var i=e.getItems().find(function(e,i){if(i>0&&e.getCells()[0].getItems()[1].getText().toLowerCase()===t){return true}return false});return!!i};W.prototype._enableDisableNewFolderBtn=function(){if(this.oNavigationMap.size&&this.oCurrentParentData.getProperty("isDocumentCreationAllowed")){this.oNewFolderButton.setEnabled(true)}else{this.oNewFolderButton.setEnabled(false)}};W.prototype._makeNewFolderEntry=function(e){this.setBusy(true);var t=this.oTableControl.getBinding("items"),i,n=new Promise(function(e){i=e});this.oTableControl.removeItem(this.oNewFolderColumnListItem);this.oNewFolderColumnListItem.destroy();var o=t.create({FileShareItemName:e,FileShareItemKind:"folder"},true,false,false);var a=function(e){var n=e.getParameter("context"),s=e.getParameter("success");if(n===o){t.detachCreateCompleted(a,this);i(s)}};t.attachCreateCompleted(a,this);var s=function(){o.created().then(undefined,function(e){E.trace("transient creation context deleted")}).catch(function(e){E.trace("transient creation context deletion error",e)})};n.then(function(e){if(!e){s();t.resetChanges();this.setBusy(false)}else{o.created();this.oTableControl.setSelectedItem(this.oTableControl.getItems().length>0?this.oTableControl.getItems()[0]:null);this.setBusy(false)}}.bind(this))};W.prototype._warningMessageDialog=function(i){var n=new t({type:z.Message,title:$.getText("CFP_TITLE_WARNING"),state:j.Warning,content:new f({text:i}),beginButton:new e({type:K.Emphasized,text:$.getText("CFP_BUTTON_OK"),press:function(){n.close()}})});n.open()};W.prototype._fHandleSorting=function(e,t){var i=t?O.Ascending:O.Descending;if(i===e.getSortIndicator()){i=O.None}this.oTableControl.getColumns().forEach(function(e){e.setSortIndicator("None")});e.setSortIndicator(i);var n=e.data("bindingProperty");var o=this.oTableControl.getBinding("items");o.sort([new x("FileShareItemKind",true),new x(n,!t)])};W.prototype._resetAndApplyDefaultSorting=function(){this.oTableControl.getColumns().forEach(function(e){e.setSortIndicator("None")});var e=this.oTableControl.getBinding("items");e.sort([new x("FileShareItemKind",true),new x("FileShareItemName",false)])};W.prototype._updateBreadcrumbLinks=function(){if(this.aVisibleLinks&&this.aVisibleLinks.length>1){var e=this.aVisibleLinks.slice().reverse();var t=[];e.forEach(function(e,i,n){if(i==0){this.oBreadcrumbLinkControl.setCurrentLocationText(e.title)}else{var o=new C({text:e.title,press:function(e){if(this.oNewFolderColumnListItem&&this.oTableControl.indexOfItem(this.oNewFolderColumnListItem)>-1){this.oTableControl.removeItem(this.oNewFolderColumnListItem);this.oNewFolderColumnListItem.destroy()}var t=this.oBreadcrumbLinkControl.indexOfLink(e.getSource());var i=this.aVisibleLinks.splice(t+1);var n,o;this._updateBreadcrumbLinks();if(this.aVisibleLinks.length>1){n=this.oNavigationMap.get(this.aVisibleLinks[this.aVisibleLinks.length-1].fileShareItemId);this.oCurrentParentData=n;for(var a in i){this.oNavigationMap.delete(i[a].fileShareItemId)}this._setConfirmationButtonEnabled(null,n);o=this.getModel().createBindingContext(n.path);this.oTableControl.setBindingContext(o)}else{n=this.oNavigationMap.get(this.aVisibleLinks[this.aVisibleLinks.length-1].fileShareItemId);this.oCurrentParentData=n;this._setConfirmationButtonEnabled(null,n);this._loadFileShareRootFolder(this.oSelectControl.getSelectedKey())}}.bind(this)});t.push(o)}}.bind(this));t.reverse();if(this.oBreadcrumbLinkControl.getLinks()){this.oBreadcrumbLinkControl.removeAllLinks()}for(var i=0;i<t.length;i++){this.oBreadcrumbLinkControl.addLink(t[i])}}else{this.oBreadcrumbLinkControl.destroyLinks();this._initializeVisibleLinks();this._enableDisableNewFolderBtn()}this._setConfirmationButtonEnabled(false)};W.prototype._loadFileShareRootFolder=function(e){this.oNavigationMap.clear();var t="/FileShares("+"'"+e+"'"+")/_Root";var i=this.getModel().bindContext(t);i.requestObject().then(function(e){var t=this._createSelectionParameter(e,i.getBoundContext(e));this._setConfirmationButtonEnabled(null,t)}.bind(this));var n=this.getModel().createBindingContext(t);this.oTableControl.setBindingContext(n)};W.prototype._createButton=function(){this.oConfirmationButton=new e({text:this.getConfirmButtonText(),type:K.Emphasized,enabled:false,press:function(){var e=this.oFileNameControl.getValue();if(this.getFilePickerMode()===H.FileOnly||e){if(this.getEnableDuplicateCheck()&&this._checkForDuplicate(this.oTableControl,e.toLowerCase())){this._showOverwriteMessage(e)}else{this._closeDialog()}}else{this._closeDialog()}}.bind(this)});this.addButton(this.oConfirmationButton);this.addButton(new e({text:$.getText("CFP_BUTTON_CANCEL"),press:function(){this.fireCancel();this.close();setTimeout(function(){this.destroy()}.bind(this))}.bind(this)}));this._setConfirmationButtonEnabled(false)};W.prototype._setConfirmationButtonEnabled=function(e,t,i){var n=false;if(this.oFileNameControl&&this.oFileNameControl.getValue()){n=this.oFileNameControl.getValue()!==""}if(this.getFilePickerMode()===H.FileOnly){this.oConfirmationButton.setEnabled(e)}else if(t&&t.getIsDocumentCreationAllowed()){if(this.getFileNameMandatory()){n||e?this.oConfirmationButton.setEnabled(true):this.oConfirmationButton.setEnabled(false)}else{this.oConfirmationButton.setEnabled(true)}}else if(i){if(this.getFileNameMandatory()){this.oConfirmationButton.setEnabled(t&&t.getIsDocumentCreationAllowed()?n:false)}}else{this.oConfirmationButton.setEnabled(e?e:false)}};W.prototype._checkForDuplicate=function(e,t){var i=e.getItems().find(function(i){if(i.getCells()[0].getItems()[1].getText().toLowerCase()===t){e.setSelectedItem(i);return true}return false});return!!i};W.prototype._showOverwriteMessage=function(i){var n=this.getDuplicateMessage();if(!n){n=$.getText("CFP_MESSAGE_DUPLICATE",i)}var o=new t({type:z.Message,title:$.getText("CFP_TITLE_WARNING"),state:j.Warning,content:new f({text:n}),beginButton:new e({type:K.Emphasized,text:$.getText("CFP_BUTTON_YES"),press:function(){o.close();this._closeDialog(true)}.bind(this)}),endButton:new e({text:$.getText("CFP_BUTTON_NO"),press:function(){o.close()}})});o.open()};W.prototype._closeDialog=function(e){var t={};if(this.aVisibleLinks.length>1){t.selectedFolder=this.oNavigationMap.get(this.aVisibleLinks[this.aVisibleLinks.length-1].fileShareItemId)}else{t.selectedFolder=new b;t.selectedFolder.setFileShareId(this.oSelectControl.getSelectedKey())}t.selectedFileName=this.oFileNameControl.getValue();t.replaceExistingFile=!!e;t.selectedFiles=[];var i=this.oTableControl.getSelectedItem();if(i){t.selectedFiles.push(this._createSelectionParameter(i))}this.fireEvent("select",t);this.close();setTimeout(function(){this.destroy()}.bind(this))};W.prototype._createSelectionParameter=function(e,t){var i=new b;var n;if(!t){n=e.getBindingContext()}else{n=t}i.setFileShareId(n.getObject("FileShare"));i.setFileShareItemId(n.getObject("FileShareItem"));i.setParentFileShareItemId(n.getObject("ParentFileShareItem"));i.setIsFolder(n.getObject("FileShareItemKind")==="folder");i.setFileShareItemName(n.getObject("FileShareItemName"));i.setCreatedByUser(n.getObject("CreatedByUser"));i.setCreationDateTime(n.getObject("CreationDateTime"));i.setLastChangedByUser(n.getObject("LastChangedByUser"));i.setLastChangeDateTime(n.getObject("LastChangeDateTime"));i.setFileShareItemContent(n.getObject("FileShareItemContent"));i.setFileShareItemContentType(n.getObject("FileShareItemContentType"));i.setFileShareItemContentSize(n.getObject("FileShareItemContentSize"));i.setFileShareItemContentLink(n.getObject("FileShareItemContentLink"));i.setIsDocumentCreationAllowed(n.getObject("isDocumentCreationAllowed"));return i};return W});