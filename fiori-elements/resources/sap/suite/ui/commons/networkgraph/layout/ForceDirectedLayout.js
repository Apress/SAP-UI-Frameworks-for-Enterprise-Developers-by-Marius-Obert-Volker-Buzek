/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/suite/ui/commons/library","./LayoutAlgorithm","./Geometry","./LayoutTask","sap/ui/performance/Measurement"],function(t,e,i,o,n){"use strict";var r=e.extend("sap.suite.ui.commons.networkgraph.layout.ForceDirectedLayout",{metadata:{properties:{optimalDistanceConstant:{type:"float",defaultValue:.2},maxIterations:{type:"int",defaultValue:200},maxTime:{type:"int",defaultValue:2e3},initialTemperature:{type:"float",defaultValue:200},coolDownStep:{type:"float",defaultValue:1},staticNodes:{type:"string[]",defaultValue:[]}}}});var a=t.networkgraph.LayoutRenderType,s=200,h=2.3999632297286535;r.prototype.getLayoutRenderType=function(){return a.Forces};r.prototype.isLayered=function(){return false};r.prototype.layout=function(){return new o(function(t,e,i){var o=this.getParent();if(!o){e("The algorithm must be associated with a graph.");return}this.oGraph=o;n.start("NetworkGraph - ForceDirectedLayout","Layouting of a graph "+o.getId());this._initPhyllotaxisPattern();this._runSimulation();this._normalizeLines();this._alignCoordinatesWithView();t()}.bind(this))};r.prototype._initPhyllotaxisPattern=function(){var t=s*Math.sqrt(this.oGraph.getNodes().length),e=0,o={center:{x:0,y:0},apex:{x:0,y:0}};this.aCenters=[];this.oGraph.getNodes().forEach(function(n,r){if(this.getStaticNodes().indexOf(n.getKey())>-1){n.center={x:n.getCenterPosition().x,y:n.getCenterPosition().y}}else{o.apex.x=Math.sqrt(r+1)*s;o.apex.y=0;e+=h;o=i.getRotatedVector(o,e);n.center={x:o.apex.x+t,y:o.apex.y+t}}this.aCenters.push(n.center)}.bind(this))};r.prototype._runSimulation=function(){var t=this.getMaxIterations(),e=this.getInitialTemperature(),o=this.getCoolDownStep(),n=this.getMaxTime()>0?this.getMaxTime()+Date.now():0,r=0,a,s,h,p,u,y,c;var d=i.getBoundingBox(this.aCenters),g=(d.p2.x-d.p1.x)*(d.p2.y-d.p1.y),f=this.getOptimalDistanceConstant()*Math.sqrt(g/this.oGraph.getNodes().length);var l=function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},x=function(t){return t*t/f},m=function(t){return f*f/t};while(e>0&&r<t&&(n===0||Date.now()<n)){this.oGraph.getNodes().forEach(function(t){t.disp={x:0,y:0}});this.oGraph.getNodes().forEach(function(t){this.oGraph.getNodes().forEach(function(e){if(t.getKey()===e.getKey()){return}a=i.getPointDif(t.center,e.center);s=Math.max(1,l(a)-(t._getCircleSize()/2+e._getCircleSize()/2));t.disp.x+=a.x/s*m(s);t.disp.y+=a.y/s*m(s)})}.bind(this));this.oGraph.getLines().forEach(function(t){p=t.getFromNode();u=t.getToNode();if(p.getKey()===u.getKey()){return}a=i.getPointDif(p.center,u.center);s=l(a);y=a.x/s*x(s);c=a.y/s*x(s);p.disp.x-=y;p.disp.y-=c;u.disp.x+=y;u.disp.y+=c});this.oGraph.getNodes().forEach(function(t){if(this.getStaticNodes().indexOf(t.getKey())>-1){return}s=l(t.disp);h=Math.min(s,e)/s;t.center.x+=t.disp.x*h;t.center.y+=t.disp.y*h}.bind(this));e-=o;r++}this.oGraph.getNodes().forEach(function(t){t.setX(t.center.x-t._iWidth/2);t.setY(t.center.y-t._iHeight/2)})};r.prototype.destroy=function(){this.aCenters=null;this.oGraph=null;e.prototype.destroy.apply(this)};return r});