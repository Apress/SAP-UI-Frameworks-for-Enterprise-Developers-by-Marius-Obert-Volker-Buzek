/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/suite/ui/commons/library","./LayoutAlgorithm","./Geometry","./KlayWrapper","./LayoutTask","sap/ui/performance/Measurement"],function(t,e,o,i,r,a){"use strict";var n=t.networkgraph.Orientation,s=t.networkgraph.NodePlacement,h=t.networkgraph.LayoutRenderType;var d=34,p=25,u=17,g=4,c="N_",l="G_",f=2;var y=function(){var t={};t[s.BrandesKoepf]="BRANDES_KOEPF";t[s.LinearSegments]="LINEAR_SEGMENTS";t[s.Simple]="SIMPLE";return Object.freeze(t)}();var _=e.extend("sap.suite.ui.commons.networkgraph.layout.LayeredLayout",{metadata:{library:"sap.suite.ui.commons",properties:{nodeSpacing:{type:"float",defaultValue:55},lineSpacingFactor:{type:"float",defaultValue:.25},nodePlacement:{type:"sap.suite.ui.commons.networkgraph.NodePlacement",defaultValue:s.BrandesKoepf},mergeEdges:{type:"boolean",defaultValue:false}}}});_.prototype.getLayoutRenderType=function(){return h.LayeredWithGroups};_.prototype.layout=function(){return new r(function(t,e,o){var r=this.getParent();if(!r){e("The algorithm must be associated with a graph.");return}if(this._hasHierarchicalGroups()){e("Layered layout algorithm doesn't support hierarchical groups.");return}this.oGraph=r;this.oKGraph={children:[],edges:[]};this.mLineMap={};a.start("NetworkGraph - LayeredLayout","Layouting of a graph "+r.getId());r.getGroups().forEach(this._addGroupToKlay,this);r.getNodes().forEach(this._addNodeToKlay,this);r.getLines().forEach(this._addLineToKlay,this);i.layout({graph:this.oKGraph,options:this._getOptions(),success:function(e){if(o.isTerminated()){t();return}this._copyStuffWithoutPrefixes(e);e.children.forEach(function(t){this._extractNodeFromKlay(t)},this);e.edges.forEach(function(t){this._extractLineFromKlay(t)},this);this._dealWithOrientation();this._makeExpandedGroupsBoxesAroundNodes();this._shrinkGroupsDownward();this._stretchLinesToCircleNodeAxes();this._alignCoordinatesWithView();a.end("NetworkGraph - LayeredLayout");t()}.bind(this),error:function(t){e(t)}})}.bind(this))};_.prototype._buildNodeForKlay=function(t){var e={},o=t._isCircle();if(o||t.getCoreNodeSize()&&t._isCustom()){var i=o?t._getCircleSize():t.getCoreNodeSize();if(this.oGraph.getOrientation()!==n.TopBottom&&this.oGraph.getOrientation()!==n.BottomTop){var r=t._iHeight-i+g;e={additionalPortSpace:"top="+g+", bottom="+r}}else{var a=(t._iWidth-i)/2+g;e={additionalPortSpace:"top="+a+", bottom="+a}}}return{id:c+t.getKey(),width:t._iWidth,height:t._iHeight,properties:e}};_.prototype._addGroupToKlay=function(t){if(t._isIgnored()){return}var e=2*t._getBorderSize(),o={id:l+t.getKey(),width:t._iWidth+e,height:t._iHeight+e};this.oKGraph.children.push(o);if(!t.getCollapsed()){t.aNodes.forEach(function(t){if(!t._isIgnored()){if(!o.children){o.children=[]}o.children.push(this._buildNodeForKlay(t))}},this)}};_.prototype._addNodeToKlay=function(t){if(!t._oGroup&&!t._isIgnored()){this.oKGraph.children.push(this._buildNodeForKlay(t))}};_.prototype._addLineToKlay=function(t){var e,o,i;if(!t._isIgnored()){e=t.getFromNode()._oGroup&&t.getFromNode()._oGroup.getCollapsed()?l+t.getFromNode()._oGroup.getKey():c+t.getFrom();o=t.getToNode()._oGroup&&t.getToNode()._oGroup.getCollapsed()?l+t.getToNode()._oGroup.getKey():c+t.getTo();i=e+"->"+o+"["+this.oKGraph.edges.length+"]";this.oKGraph.edges.push({id:i,source:e,target:o});this.mLineMap[i]=t}};_.prototype._getOptions=function(){var t=this.oGraph.getOrientation(),e;switch(t){case n.LeftRight:case n.RightLeft:e="RIGHT";break;case n.TopBottom:case n.BottomTop:e="DOWN";break;default:e="RIGHT"}return{direction:e,spacing:this.getNodeSpacing(),nodePlace:y[this.getNodePlacement()],edgeSpacingFactor:this.getLineSpacingFactor(),mergeEdges:this.getMergeEdges()}};_.prototype._extractNodeFromKlay=function(t){var e=t.id.substring(0,f)===c?this.oGraph.getNodeByKey(t.originalId):undefined,o;if(!e){e=this.oGraph.mGroups[t.originalId];if(e&&!e.getCollapsed()&&t.children){t.children.forEach(function(e){o=this.oGraph.getNodeByKey(e.originalId);if(o){o.setX(Math.round(e.x+t.x));o.setY(Math.round(e.y+t.y))}},this)}}if(e){e.setX(Math.round(t.x));e.setY(Math.round(t.y))}};_.prototype._extractLineFromKlay=function(t){var e=this.mLineMap[t.id];e.setSource({x:Math.round(t.sourcePoint.x),y:Math.round(t.sourcePoint.y)});e.setTarget({x:Math.round(t.targetPoint.x),y:Math.round(t.targetPoint.y)});e.clearBends();if(t.bendPoints){t.bendPoints.forEach(function(t){e.addBend({x:Math.round(t.x),y:Math.round(t.y)})})}if(e.getFromNode()._oGroup&&!e.getFromNode()._oGroup.getCollapsed()){e._shift({x:e.getFromNode()._oGroup.getX(),y:e.getFromNode()._oGroup.getY()})}};_.prototype._dealWithOrientation=function(){if(!this.oGraph._bIsRtl&&this.oGraph.getOrientation()===n.RightLeft||this.oGraph._bIsRtl&&this.oGraph.getOrientation()!==n.RightLeft){this._verticalMirror(true)}if(this.oGraph.getOrientation()===n.BottomTop){this._horizontalMirror(true)}};_.prototype._makeExpandedGroupsBoxesAroundNodes=function(){var t=[],e;this.oGraph.getGroups().forEach(function(i){if(i.getCollapsed()||i.aNodes.length===0){return}t=this._getNodesPoints(i.aNodes);e=o.getBoundingBox(t);o.enlargeBox(e,p);i.setX(Math.round(e.p1.x));i.setY(Math.round(e.p1.y-d));i._iWidth=e.p2.x-e.p1.x;i._iHeight=e.p2.y-e.p1.y+d},this)};_.prototype._shrinkGroupsDownward=function(){var t;this.oGraph.getGroups().forEach(function(e){if(e.getCollapsed()){return}e.aNodes.forEach(function(o){t=(e.getY()+e._iHeight-o.getY())/e._iHeight;o.setY(o.getY()+t)});e.setY(e.getY()+u);e._iHeight-=u})};_.prototype._copyStuffWithoutPrefixes=function(t){t.children.forEach(function(t){t.originalId=t.id.substring(f);if(t.children){t.children.forEach(function(t){t.originalId=t.id.substring(f)})}});t.edges.forEach(function(t){t.originalSource=t.source.substring(f);t.originalTarget=t.target.substring(f)})};return _});