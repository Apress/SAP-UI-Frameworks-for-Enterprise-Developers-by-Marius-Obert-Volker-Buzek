/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","sap/base/Log","sap/ui/events/KeyCodes","sap/suite/ui/microchart/MicroChartUtils","sap/m/library","./ColumnMicroChartRenderer","sap/ui/dom/jquery/Selectors"],function(e,t,i,s,a,o,r,l){"use strict";var n=r.Size;var u=r.ValueColor;var h=t.extend("sap.suite.ui.microchart.ColumnMicroChart",{metadata:{library:"sap.suite.ui.microchart",properties:{size:{group:"Misc",type:"sap.m.Size",defaultValue:n.Auto},width:{group:"Misc",type:"sap.ui.core.CSSSize"},height:{group:"Misc",type:"sap.ui.core.CSSSize"},isResponsive:{type:"boolean",group:"Appearance",defaultValue:false},showTopLabels:{type:"boolean",defaultValue:true},showBottomLabels:{type:"boolean",defaultValue:true},allowColumnLabels:{type:"boolean",group:"Appearance",defaultValue:false},hideOnNoData:{type:"boolean",group:"Appearance",defaultValue:false}},events:{press:{}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},defaultAggregation:"columns",aggregations:{columns:{multiple:true,type:"sap.suite.ui.microchart.ColumnMicroChartData",defaultValue:null,bindable:"bindable"},leftTopLabel:{multiple:false,type:"sap.suite.ui.microchart.ColumnMicroChartLabel",defaultValue:null},rightTopLabel:{multiple:false,type:"sap.suite.ui.microchart.ColumnMicroChartLabel",defaultValue:null},leftBottomLabel:{multiple:false,type:"sap.suite.ui.microchart.ColumnMicroChartLabel",defaultValue:null},rightBottomLabel:{multiple:false,type:"sap.suite.ui.microchart.ColumnMicroChartLabel",defaultValue:null}}},renderer:l});h.THRESHOLD_LOOK_XS=1.125;h.THRESHOLD_LOOK_S=3.5;h.THRESHOLD_LOOK_M=4.5;h.THRESHOLD_LOOK_L=5.875;h.THRESHOLD_WIDTH_NO_LABEL=6;h.prototype.init=function(){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this.setAggregation("tooltip","((AltText))",true);this._bThemeApplied=true;if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this))}else{this._handleCoreInitialized()}};h.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();if(!this._bThemeApplied){sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this)}};h.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this.invalidate();sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this)};h.prototype.onBeforeRendering=function(){this.$().off("mouseenter");this.$().off("mouseleave")};h.prototype.onAfterRendering=function(){if(this._sChartResizeHandlerId){i.deregister(this._sChartResizeHandlerId)}e._checkControlIsVisible(this,this._onControlIsVisible);this.$().on("mouseenter",this._addTitleAttribute.bind(this));this.$().on("mouseleave",this._removeTitleAttribute.bind(this))};h.prototype._onControlIsVisible=function(){this._fChartHeight=undefined;this._aBars=[];var e=this.getColumns().length;for(var t=0;t<e;t++){this._aBars.push({})}this._onResize();this._sChartResizeHandlerId=i.register(this,this._onResize.bind(this))};h.prototype.exit=function(){i.deregister(this._sChartResizeHandlerId)};h.prototype._onResize=function(){this._calcColumns();var e=this.$(),t=parseInt(e.width()),i=parseInt(e.height()),a=e.find(".sapSuiteClMCPositionTop").children(),o=e.find(".sapSuiteClMCLabelColumn.sapSuiteClMCLabelColumnTop,.sapSuiteClMCLabelColumn.sapSuiteClMCLabelColumnBottom"),r=e.find(".sapSuiteClMCBars")[0],l=this.getColumns(),n=l.length;e.removeClass("sapSuiteClMCNoLabels sapSuiteClMCNoColumnLabels sapSuiteClMCNoTopLabels sapSuiteClMCLookM sapSuiteClMCLookS sapSuiteClMCLookXS");if(t<=this.convertRemToPixels(h.THRESHOLD_WIDTH_NO_LABEL)){e.addClass("sapSuiteClMCNoLabels")}if(i<this.convertRemToPixels(h.THRESHOLD_LOOK_S)){e.addClass("sapSuiteClMCLookXS")}else if(i<this.convertRemToPixels(h.THRESHOLD_LOOK_M)){if(this.getAllowColumnLabels()){e.addClass("sapSuiteClMCNoColumnLabels")}e.addClass("sapSuiteClMCLookS")}else if(i<this.convertRemToPixels(h.THRESHOLD_LOOK_L)){e.addClass("sapSuiteClMCLookM")}if(this._isAnyLabelTruncated(a)){e.addClass("sapSuiteClMCNoTopLabels")}if(this.getAllowColumnLabels()&&this._isAnyLabelTruncated(o)){e.addClass("sapSuiteClMCNoColumnLabels")}if(n>0&&r){e.find(".sapSuiteClMCBar").show();while(r.scrollWidth>r.offsetWidth){l[--n].$().hide();s.warning(this.toString()+" Chart overflow","Column "+n+" was not rendered")}}};h.prototype._calcColumns=function(){var e=this.getColumns();if(e&&e.length===this._aBars.length){var t=parseFloat(this.$().css("height"));if(t!==this._fChartHeight){this._fChartHeight=t;this._calcColumnsHeight(t,this._aBars)}for(var i=0;i<e.length;i++){e[i].$().css(this._aBars[i])}}};h.prototype._calcColumnsHeight=function(e,t){var i=this.getColumns().length;if(i!==t.length){return}var s,a,o;s=a=0;for(var r=0;r<i;r++){var l=this.getColumns()[r];if(s<l.getValue()){s=l.getValue()}else if(a>l.getValue()){a=l.getValue()}}if(s===0&&a===0){for(var n=0;n<i;n++){t[n].top="calc(100% - 1px)";t[n].height="1px"}return}var u=s-a;var h=u/e;var p,f;p=f=0;for(var C=0;C<i;C++){o=this.getColumns()[C].getValue();if(Math.abs(o)<h){if(o>=0){if(o===s){f=h-o}}else if(o===a){p=h+o}}}if(f){s+=f;a-=f}if(p){s-=p;a+=p}var c=0-h;for(var g=0;g<i;g++){o=this.getColumns()[g].getValue();var d=o;if(o>=0){d=Math.max(d+f-p,h)}else{d=Math.min(d+f-p,c)}t[g].value=d}function b(e){return(e/u*100).toFixed(2)+"%"}var _=b(s);for(var n=0;n<i;n++){o=t[n].value;t[n].top=o<0?_:b(s-o);t[n].height=b(Math.abs(o))}};h.prototype.attachEvent=function(e,i,s,a){t.prototype.attachEvent.call(this,e,i,s,a);if(this.hasListeners("press")){this.$().attr("tabindex",0).addClass("sapSuiteUiMicroChartPointer")}return this};h.prototype.detachEvent=function(e,i,s){t.prototype.detachEvent.call(this,e,i,s);if(!this.hasListeners("press")){this.$().removeAttr("tabindex").removeClass("sapSuiteUiMicroChartPointer")}return this};h.prototype.getLocalizedColorMeaning=function(e){return u[e]?this._oRb.getText(("SEMANTIC_COLOR_"+e).toUpperCase()):""};h.prototype.setSize=function(e){if(this.getSize()!==e){if(e===n.Responsive){this.setProperty("isResponsive",true)}else{this.setProperty("isResponsive",false)}this.setProperty("size",e,false)}return this};h.prototype.setIsResponsive=function(e){var t,i=this.getSize();this.setProperty("isResponsive",e);if(e){t=n.Responsive}else{t=i===n.Responsive?n.Auto:i}this.setProperty("size",t);return this};h.prototype._getAltHeaderText=function(e){var t=this._oRb.getText("COLUMNMICROCHART");if(e){t+=" "+this._oRb.getText("IS_ACTIVE")}if(!this._hasData()){t+="\n"+this._oRb.getText("NO_DATA");return t}var i=this.getLeftTopLabel();var s=this.getRightTopLabel();var a=this.getLeftBottomLabel();var o=this.getRightBottomLabel();var r;if(i&&i.getLabel()||a&&a.getLabel()){if(i){r=i.getColor()}else if(a){r=a.getColor()}else{r=""}t+="\n"+this._oRb.getText("COLUMNMICROCHART_START")+": "+(a?a.getLabel()+" ":"")+(i?i.getLabel()+" ":"")+this.getLocalizedColorMeaning(r)}if(s&&s.getLabel()||o&&o.getLabel()){if(s){r=s.getColor()}else if(o){r=o.getColor()}else{r=""}t+="\n"+this._oRb.getText("COLUMNMICROCHART_END")+": "+(o?o.getLabel()+" ":"")+(s?s.getLabel()+" ":"")+this.getLocalizedColorMeaning(r)}return t};h.prototype._getAltSubText=function(e){var t="";var i=this.getColumns();for(var s=0;s<i.length;s++){var a=i[s],o=a.getTooltip_AsString(),r="";if(!o){continue}r+=(e?"":"\n")+this._getBarAltText(a);r=o.split("((AltText))").join(r);if(r){t+=r;e=false}}return t};h.prototype._getAccessibilityControlType=function(){return this._oRb.getText("ACC_CTR_TYPE_COLUMNMICROCHART")};h.prototype.onclick=function(e){if(!this.fireBarPress(e)){this.firePress()}};h.prototype.onkeydown=function(e){var t,i;switch(e.keyCode){case a.SPACE:e.preventDefault();break;case a.ARROW_LEFT:case a.ARROW_UP:i=this.$().find(":focusable");t=i.index(e.target);if(i.length>1){if(t===-1){i.eq(i.length-2).get(0).focus()}else{i.eq(t-1>=0?t-1:i.length-1).get(0).focus()}e.preventDefault();e.stopPropagation()}break;case a.ARROW_DOWN:case a.ARROW_RIGHT:i=this.$().find(":focusable");t=i.index(e.target);if(i.length>0){i.eq(t+1<i.length?t+1:0).get(0).focus();e.preventDefault();e.stopPropagation()}break;default:}};h.prototype.onkeyup=function(e){if(e.which===a.ENTER||e.which===a.SPACE){if(!this.fireBarPress(e)){this.firePress();e.preventDefault()}}};h.prototype.fireBarPress=function(e){var t=e.srcControl;if(t&&t.isA("sap.suite.ui.microchart.ColumnMicroChartData")){if(t.hasListeners("press")){t.firePress();e.preventDefault();e.stopPropagation();return true}}return false};h.prototype._getBarAltText=function(e){var t=this.getLocalizedColorMeaning(e.getColor());return e.getLabel()+" "+e.getValue()+" "+t};h.prototype.setBarPressable=function(e,t){var i=e.$();if(t){var s=this._getBarAltText(e);i.addClass("sapSuiteUiMicroChartPointer").attr("tabindex",0).attr("title",s).attr("role","presentation").attr("aria-label",s)}else{i.removeAttr("tabindex").removeClass("sapSuiteUiMicroChartPointer").removeAttr("title").removeAttr("role").removeAttr("aria-label")}};h.prototype.onsaptabnext=function(e){var t=this.$().find(":focusable").last();if(t){this._bIgnoreFocusEvt=true;t.get(0).focus()}};h.prototype.onsaptabprevious=function(e){if(e.target.id!==e.currentTarget.id){var t=this.$().find(":focusable").first();if(t){t.get(0).focus()}}};h.prototype.onfocusin=function(e){if(this._bIgnoreFocusEvt){this._bIgnoreFocusEvt=false;return}if(this.getId()+"-hidden"===e.target.id){this.$().trigger("focus");e.preventDefault();e.stopPropagation()}};h.prototype._addTitleAttribute=function(){if(!this.$().attr("title")&&this._hasData()){this.$().attr("title",this.getTooltip_AsString())}};h.prototype._removeTitleAttribute=function(){if(this.$().attr("title")){this.$().removeAttr("title")}};h.prototype._hasData=function(){return this.getColumns().length>0};h.prototype.firePress=function(){if(this._hasData()){t.prototype.fireEvent.call(this,"press",arguments)}};o.extendMicroChart(h);return h});