// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/extend","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/appRuntime/ui5/performance/FesrEnhancer","sap/ushell/EventHub","sap/base/Log","sap/ui/thirdparty/hasher","sap/ui/core/Core","sap/ushell/utils/UrlParsing","sap/ushell/appRuntime/ui5/AppRuntimeContext","sap/base/assert","sap/ushell/resources"],function(e,t,s,a,n,r,i,u,o,p,l,f,c,d,h,g){"use strict";function m(){var m=this,v,y,S=true,C={},I,b={},A={},P={},R={},w,O,N,F,L;this.init=function(s,a,n,r,i,u){v=s;I=a;O=n;if(r!==undefined){S=r}this.addAppInfoToCache(i,u);e.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.create(t)}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.destroy(t)}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.store(t)}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.restore(t)}}}}});o.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&A[e.componentId]){A[e.componentId]=e.disable}});t.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,isIframeValid:true,isIframeBusy:true});if(!g.browserI18n){g.browserI18n=g.getTranslationModel(window.navigator.language).getResourceBundle()}F=g.browserI18n.getText("dataLossExternalMessage");window.onbeforeunload=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()){return F}return undefined}};this.create=function(e){return new Promise(function(s,o){var p,c,g;t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:true});u.startInteraction();p=e.body.sUrl;if(d.getIsScube()){g=a.fromURL(p).get("sap-remote-intent");h(typeof g==="string","AppLifeCycleAgent::create - sAppIntent must be string")}else{c=a.fromURL(p).get("sap-ui-app-id");h(typeof c==="string","AppLifeCycleAgent::create - sAppId must be string")}l.disableCFLPUpdate=true;l.replaceHash(e.body.sHash);l.disableCFLPUpdate=false;if(r.browser.chrome){i.show(0)}if(N){N._resetBackNavigationCallback()}f.getEventBus().publish("launchpad","appOpening",{});m.getAppInfo(c,p,g).then(function(e){m.expandSapIntentParams(new n(p).query(true)).then(function(a){I(c,a,e.oResolvedHashFragment,g,e.oParsedHash).then(function(e){O(e);t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:false});f.getEventBus().publish("sap.ushell","appOpened",{});s()})})})})};this.destroy=function(e){function s(e){var t=e.sId||"<unkown>";try{e.destroy()}catch(e){p.error("exception when trying to close sapui5 application with id '"+t+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}if(w===undefined){t.sendMessageToOuterShell("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}var a=e.body.sCacheId;if(a&&b[a]){if(b[a]===w){w=undefined}delete A[b[a].sId];s(b[a]);delete b[a]}else if(w){delete A[w.sId];s(w);w=undefined}sap.ushell.Container.cleanDirtyStateProviderArray();if(N){N._resetBackNavigationCallback()}u.setAppShortId();f.getEventBus().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.store=function(e){var s=e.body.sCacheId,a=w,n;if(w===undefined){t.sendMessageToOuterShell("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}b[s]=a;if(N){R[s]=N._getBackNavigationCallback()}n=a.getComponentInstance();a.setVisible(false);if(sap.ushell.Container){P[s]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray()}if(n){if(n.isKeepAliveSupported&&n.isKeepAliveSupported()===true){n.deactivate()}else{if(n.suspend){n.suspend()}if(n.getRouter&&n.getRouter()){n.getRouter().stop()}}}f.getEventBus().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.restore=function(e){var t=e.body.sCacheId,s=b[t],a=s.getComponentInstance(),n=A[s.sId];l.disableCFLPUpdate=true;l.replaceHash(e.body.sHash);l.disableCFLPUpdate=false;f.getEventBus().publish("launchpad","appOpening",{});s.setVisible(true);if(P[t]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(P[t])}if(N){N.setBackNavigation(R[t])}if(a){if(a.isKeepAliveSupported&&a.isKeepAliveSupported()===true){a.activate()}else{if(a.restore){a.restore()}if(a.getRouter&&a.getRouter()&&a.getRouter().initialize){if(n===false){a.getRouter().initialize()}else{a.getRouter().initialize(true)}}}w=s}f.getEventBus().publish("sap.ushell","appOpened",{});return Promise.resolve()};this.expandSapIntentParams=function(e){return new Promise(function(a,r){if(e.hasOwnProperty("sap-intent-param")){var i=e["sap-intent-param"];t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:i}).then(function(t){delete e["sap-intent-param"];var r=s({},e,new n("?"+t).query(true),true);a(r)},function(t){a(e)})}else{a(e)}})};this.addAppParamsToIntent=function(e,t){return m.expandSapIntentParams(new n(e).query(true)).then(function(e){return m.getApplicationParameters(e)})};this.getApplicationParameters=function(e){return new Promise(function(s){var a,r,i;function u(e,t){var s="";if(e&&e.length>0){s=(e.startsWith("?")?"":"?")+e}if(t&&t.length>0){s+=(s.length>0?"&":"?")+t}return s}if(e.hasOwnProperty("sap-startup-params")){a=new n("?"+e["sap-startup-params"]).query(true);if(a.hasOwnProperty("sap-intent-param")){r=a["sap-intent-param"];delete a["sap-intent-param"]}i=new n("?").query(a).toString();if(r){t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:r}).then(function(e){s(u(i,e))},function(e){s(u(i))})}else{s(u(i))}}else{s("")}})};this.getAppInfo=function(e,t,s){return new Promise(function(a){if(s){m.addAppParamsToIntent(t,s).then(function(e){if(e.length>0){e=new n(e).removeSearch("sap-remote-system").removeSearch("sap-ushell-defaultedParameterNames").toString()}sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(t){t.resolveHashFragmentLocal("#"+s+e).done(function(t){var n=c.parseShellHash("#"+s+e);a({oResolvedHashFragment:t,oParsedHash:n})}).fail(function(e){})})})}else{var r=function(){y.getAppInfo(e,t).then(function(t){m.addAppInfoToCache(e,t);a({oResolvedHashFragment:t})})};if(S===true&&C[e]){a({oResolvedHashFragment:JSON.parse(JSON.stringify(C[e]))})}else if(y){r()}else{sap.ui.require([v.replace(/\./g,"/")],function(e){y=e;r()})}}})};this.addAppInfoToCache=function(e,t){if(e&&t&&S===true&&C[e]===undefined){C[e]=JSON.parse(JSON.stringify(t))}};this.setComponent=function(e){w=e;if(w){A[w.sId]=true}};this.setShellUIService=function(e){N=e};this.setShellNavigationService=function(e){L=e};this.checkDataLossAndContinue=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag(L.getNavigationContext())){if(window.confirm(F)){sap.ushell.Container.setDirtyFlag(false);return true}else{return false}}return true}}return new m},true);