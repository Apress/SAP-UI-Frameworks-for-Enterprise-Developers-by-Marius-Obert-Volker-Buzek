// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["./UserRecentsBase","sap/base/Log","sap/ushell/utils","sap/ui/thirdparty/jquery"],function(e,t,a,s){"use strict";var i=e.extend("sap.ushell.services.RecentAppsUsage",{constructor:function(){e.call(this,"AppsUsage")}});i.MAX_DAYS=30;i.prototype.init=function(){var e=this.getDayFromDateObj(new Date);var a=false;if(this._oInitDeferred===undefined){this._oInitDeferred=new s.Deferred}if(!a||e!==this.oAppsUsageData.recentDay){a=true;this._load().done(function(t){this.oAppsUsageData=t||{recentDay:null,recentAppsUsageMap:{}};this.calculateInitialUsage(e);this._oInitDeferred.resolve(this.oAppsUsageData)}.bind(this)).fail(function(){t.error("UShell-lib ; RecentAppsUsage ; Load data in Init failed");this._oInitDeferred.reject()}.bind(this))}return this._oInitDeferred.promise()};i.prototype.calculateInitialUsage=function(e){if(e!==this.oAppsUsageData.recentDay){this.addNewDay();this.oAppsUsageData.recentDay=e;setTimeout(function(){this.cleanUnusedHashes()}.bind(this),3e3);this.saveAppsUsage(this.oAppsUsageData)}};i.prototype.addAppUsage=function(e){if(!a.validHash(e)){return(new s.Deferred).reject("Non valid hash").promise()}return this.init().done(function(){var t=this.oAppsUsageData.recentAppsUsageMap[e]||[];if(t.length===0){t[0]=1}else{t[t.length-1]+=1}this.oAppsUsageData.recentAppsUsageMap[e]=t;this.saveAppsUsage(this.oAppsUsageData)}.bind(this)).fail(function(){t.error("Ushell-lib ; addAppUsage ; Initialization falied!")})};i.prototype.getAppsUsage=function(){var e;var t=new s.Deferred;this.init().done(function(){e=this.summarizeUsage();t.resolve(e)}.bind(this)).fail(function(){t.reject("Not initialized yet")});return t.promise()};i.prototype.summarizeUsage=function(){var e={};var t,a;var s=true;for(var i in this.oAppsUsageData.recentAppsUsageMap){e[i]=this.getHashUsageSum(i);if(s){t=a=e[i];s=false}else if(e[i]<a){a=e[i]}else if(e[i]>t){t=e[i]}}return{usageMap:e,maxUsage:t,minUsage:a}};i.prototype.addNewDay=function(){var e;for(var t in this.oAppsUsageData.recentAppsUsageMap){e=this.oAppsUsageData.recentAppsUsageMap[t];e[e.length]=0;if(e.length>i.MAX_DAYS){e=e.shift()}}};i.prototype.cleanUnusedHashes=function(){var e;for(var t in this.oAppsUsageData.recentAppsUsageMap){e=this.getHashUsageSum(t);if(e===0){delete this.oAppsUsageData.recentAppsUsageMap[t]}}};i.prototype.getHashUsageSum=function(e){var t=0;var a;var s=this.oAppsUsageData.recentAppsUsageMap[e];var i=s.length;for(a=0;a<i;a++){t+=s[a]}return t};i.prototype.saveAppsUsage=function(e){return this._save(e).fail(function(){t.error("Ushell-lib ; saveAppsUsage ; Save action failed")})};i.prototype.getDayFromDateObj=function(e){return e.getUTCFullYear()+"/"+(e.getUTCMonth()+1)+"/"+e.getUTCDate()};return i});