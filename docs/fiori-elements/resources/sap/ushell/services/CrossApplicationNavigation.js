// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/services/_CrossApplicationNavigation/utils","sap/ushell/utils/type","sap/ushell/TechnicalParameters","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/merge","sap/ushell/utils","sap/ushell/ApplicationType","sap/ushell/UI5ComponentType","sap/base/Log","sap/ushell/utils/UrlParsing","sap/base/util/deepClone","sap/ui/base/Object"],function(e,t,n,a,r,i,s,o,p,c,l,u,f,h,v,g,m){"use strict";function d(d,A,y){var S;if(y&&y.config){S=y.config}function C(a,r){var i;var o;var p;if(typeof a!=="string"&&!s(a)&&a!==undefined){h.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined}if(a===undefined){return undefined}var c=e.getCurrentApplication();if(r){if(typeof r.getComponentData!=="function"||!s(r.getComponentData())||!r.getComponentData().startupParameters||!s(r.getComponentData().startupParameters)){h.error("Cannot call getComponentData on component","the component should be an application root component","sap.ushell.services.CrossApplicationNavigation")}else{var l=r.getComponentData().startupParameters;if(l.hasOwnProperty("sap-system")){i=l["sap-system"][0]}if(l.hasOwnProperty("sap-ushell-next-navmode")){o=l["sap-ushell-next-navmode"][0]}}}else{if(c&&c["sap-system"]){i=c["sap-system"]}else if(c&&c.url){i=new URL(c.url,window.location.href).searchParams.get("sap-system")}if(c&&c["sap-ushell-next-navmode"]){o=c["sap-ushell-next-navmode"]}else if(c&&c.url){o=new URL(c.url,window.location.href).searchParams.get("sap-ushell-next-navmode")}}if(c){p=c.contentProviderId}var u=t._injectParameters({type:n,inject:{"sap-system":i,"sap-ushell-navmode":o,"sap-app-origin-hint":p},injectEmptyString:{"sap-app-origin-hint":true},args:a});return u}function b(e){if(localStorage&&localStorage["sap-ushell-enc-test"]==="false"){return e}if(!S||!S["sap-ushell-enc-test"]){if(localStorage&&localStorage["sap-ushell-enc-test"]!=="true"){return e}}if(typeof e!=="string"&&!s(e)&&e!==undefined){h.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined}if(e===undefined){return undefined}if(s(e)){var t=i({},e);if(t.target&&t.target.shellHash){if(typeof t.target.shellHash==="string"){if(t.target.shellHash!=="#"&&t.target.shellHash!==""){t.target.shellHash=b(t.target.shellHash)}}return t}t.params=t.params||{};t.params["sap-ushell-enc-test"]=["A B%20C"];return t}var n=e;if(!/[?&]sap-system=/.test(n)){var a=n.indexOf("?")>-1?"&":"?";n+=a+"sap-ushell-enc-test="+encodeURIComponent("A B%20C")}return n}this._extractInnerAppRoute=function(e){var t=this;if(typeof e==="string"){var n=e.split("&/");var a=n.shift();return{intent:a,innerAppRoute:n.length>0?"&/"+n.join("&/"):""}}if(Object.prototype.toString.apply(e)==="[object Object]"){var r=p.get("target.shellHash",e);if(typeof r==="string"){var i=t._extractInnerAppRoute(r);e.target.shellHash=i.intent;return{intent:e,innerAppRoute:i.innerAppRoute}}if(e.hasOwnProperty("appSpecificRoute")){var s=e.appSpecificRoute;delete e.appSpecificRoute;var o=typeof s==="string"&&s.indexOf("&/")!==0&&s.length>0;return{innerAppRoute:o?"&/"+s:s,intent:e}}return{intent:e,innerAppRoute:""}}h.error("Invalid input parameter","expected string or object","sap.ushell.services.CrossApplicationNavigation");return{intent:e}};this._injectInnerAppRoute=function(e,t){var n=this;if(!t){return e}if(typeof e==="string"){return e+t}if(Object.prototype.toString.apply(e)==="[object Object]"){var a=p.get("target.shellHash",e);if(typeof a==="string"){e.target.shellHash=n._injectInnerAppRoute(a,t);return e}e.appSpecificRoute=t}return e};this.hrefForExternal=function(e,i,s){if(typeof i!=="object"&&i!==undefined&&i!==null){s=i;i=undefined}if(s){var p=new o.Deferred;this.hrefForExternalAsync(e,i).then(p.resolve).catch(p.reject);return p.promise()}h.error("Deprecated option 'bAsync=false'. Please use 'bAsync=true' instead",null,"sap.ushell.services.CrossApplicationNavigation");var l=c({},e);var u=this._extractInnerAppRoute(l);var f=u.intent;t.addXAppStateFromParameter(f,"sap-xapp-state-data");l=C(f,i);l=t.injectStickyParameters({args:l,appLifeCycle:r,technicalParameters:a,type:n});l=b(l);l=this._injectInnerAppRoute(l,u.innerAppRoute);var v=sap.ushell.Container.getService("ShellNavigation");if(!v){h.debug("Shell not available, no Cross App Navigation");return""}return v.hrefForExternal(l,undefined,i,s)};this.hrefForExternalAsync=function(e,i){var s=c({},e);var o=this._extractInnerAppRoute(s);var p=o.intent;return Promise.resolve().then(function(){return t.addXAppStateFromParameterAsync(p,"sap-xapp-state-data")}).then(function(){s=C(p,i);return t.injectStickyParametersAsync({args:s,appLifeCycle:r,technicalParameters:a,type:n})}).then(function(e){s=e;s=b(s);s=this._injectInnerAppRoute(s,o.innerAppRoute);return sap.ushell.Container.getServiceAsync("ShellNavigation")}.bind(this)).then(function(e){return new Promise(function(t,n){e.hrefForExternal(s,undefined,i,true).done(t).fail(n)})}).catch(function(){h.debug("Shell not available, no Cross App Navigation");return""})};this.expandCompactHash=function(e){var t=new o.Deferred;sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(n){n.expandCompactHash(e).done(t.resolve).fail(t.reject)});return t.promise()};this.backToPreviousApp=function(){return this.isInitialNavigationAsync().then(function(e){if(e){return this.toExternal({target:{shellHash:"#"},writeHistory:false})}this.historyBack();return undefined}.bind(this))};this.historyBack=function(e){var t=-1;if(e&&typeof e==="number"){if(e<=0){h.warning("historyBack called with an argument <= 0 and will result in a forward navigation or refresh","expected was an argument > 0","sap.ushell.services.CrossApplicationNavigation#historyBack")}t=e*-1}window.history.go(t)};this.isInitialNavigation=function(){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.isInitialNavigation'. Please use 'isInitialNavigationAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");var e=p.get("sap.ushell.Container");var t=e&&typeof e.getService==="function"&&e.getService("ShellNavigation");if(!t){h.debug("ShellNavigation service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true}var n=t.isInitialNavigation();if(typeof n==="undefined"){return true}return n};this.isInitialNavigationAsync=function(){return sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(e){var t=e.isInitialNavigation();if(typeof t==="undefined"){return true}return t}).catch(function(){h.debug("ShellNavigation service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true})};this.toExternal=function(e,i){var s=e.writeHistory;var o=c({},e);var p=c({},o);this._processShellHashWithParams(o);var l=this._extractInnerAppRoute(o);var u=l.intent;var f;var v;return Promise.all([sap.ushell.Container.getServiceAsync("AppLifeCycle"),sap.ushell.Container.getServiceAsync("ShellNavigation")]).then(function(e){var t=e[0];f=e[1];v=t.getCurrentApplication();return v&&v.getIntent()}).then(function(e){this._checkIfAppNeedsToBeReloaded(p,v,e,f.hashChanger);return t.addXAppStateFromParameterAsync(u,"sap-xapp-state-data")}.bind(this)).then(function(){o=C(u,i);return t.injectStickyParametersAsync({args:o,appLifeCycle:r,technicalParameters:a,type:n})}).then(function(e){o=e;o=b(o);delete o.writeHistory;o=this._injectInnerAppRoute(o,l.innerAppRoute);return f.toExternal(o,i,s)}.bind(this)).catch(function(e){h.error("CrossAppNavigation.toExternal failed",e,"sap.ushell.services.CrossApplicationNavigation")})};this._checkIfAppNeedsToBeReloaded=function(e,t,n,a){if(!t||!n||!e||!e.target){return}if(e.target.shellHash){var r=v.parseShellHash(e.target.shellHash)||{};e.target={semanticObject:r.semanticObject,action:r.action,contextRaw:r.contextRaw};e.appSpecificRoute=r.appSpecificRoute;e.params=Object.assign({},e.params,r.params)}if(e.appSpecificRoute){return}if(t.applicationType!=="UI5"){return}if(e.target.semanticObject!==n.semanticObject){return}if(e.target.action!==n.action){return}var i={};if(e.params){Object.keys(e.params).forEach(function(t){var n=e.params[t];var a=Array.isArray(n)?n:[n];i[t]=a.map(function(e){return e.toString()})})}if(!a.haveSameIntentParameters(i,n.params)){return}a.setReloadApplication(true)};this.hrefForAppSpecificHash=function(e){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.hrefForAppSpecificHash'. Please use 'hrefForAppSpecificHashAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");var t=p.get("sap.ushell.Container");if(t&&typeof t.getService==="function"){var n=t.getService("ShellNavigation");if(n){return n.hrefForAppSpecificHash(e)}}h.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(e)};this.hrefForAppSpecificHashAsync=function(e){return sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(t){return t.hrefForAppSpecificHash(e)}).catch(function(){h.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(e)})};this.getPrimaryIntent=function(e,t){var n={};var a;var r=/^#\w+-displayFactSheet(?:$|\?.)/;n.tags=["primaryAction"];n.semanticObject=e;if(t){n.params=t}return this.getLinks(n).then(function(e){if(e.length===0){delete n.tags;n.action="displayFactSheet";a=function(e,t){var n;if(e.intent===t.intent){return 0}n=r.test(e.intent)^r.test(t.intent);if(n){return r.test(e.intent)?-1:1}return e.intent<t.intent?-1:1};return this.getLinks(n)}a=function(e,t){if(e.intent===t.intent){return 0}return e.intent<t.intent?-1:1};return e}.bind(this)).then(function(e){return e.length===0?null:e.sort(a)[0]})};this.getSemanticObjectLinks=function(e,i,s,p,c,u){var f=new o.Deferred;Promise.resolve().then(function(){return t.injectStickyParametersAsync({args:{params:i},appLifeCycle:r,technicalParameters:a,type:n})}).then(function(t){t=C(t,p).params;t=b({params:t}).params;var n;if(Array.isArray(e)){n=[];e.forEach(function(e){n.push([{semanticObject:e[0],params:e[1],ignoreFormFactor:!!e[2],ui5Component:e[3],appStateKey:e[4],compactIntents:!!e[5]}])})}else{n={semanticObject:e,params:t,ignoreFormFactor:s,ui5Component:p,appStateKey:c,compactIntents:!!u}}return Promise.all([sap.ushell.Container.getServiceAsync("NavTargetResolution"),n])}).then(function(e){var t=e[0];var n=e[1];l.invokeUnfoldingArrayArguments(t.getLinks.bind(t),[n]).done(f.resolve).fail(f.reject)});return f.promise()};this.getLinks=function(e){var t;t=l.invokeUnfoldingArrayArguments(this._getLinks.bind(this),[e]);return t};this._getLinks=function(e){var s=new o.Deferred;if(typeof e==="undefined"){e={}}var p=i({},e);p.compactIntents=!!p.compactIntents;p.action=p.action||undefined;p.paramsOptions=t.extractGetLinksParameterOptions(p.params);Promise.resolve().then(function(){return t.injectStickyParametersAsync({args:p,appLifeCycle:r,technicalParameters:a,type:n})}).then(function(e){p=e;var n;if(p.params){n=t.extractGetLinksParameterDefinition(p.params)}else{n=p.params}var a=C({params:n},p.ui5Component).params;a=b({params:a}).params;if(p.appStateKey){a["sap-xapp-state"]=[p.appStateKey];delete p.appStateKey}p.params=a;return sap.ushell.Container.getServiceAsync("NavTargetResolution")}).then(function(e){e.getLinks(p).done(s.resolve).fail(s.reject)});return s.promise()};this.getDistinctSemanticObjects=function(){var e=new o.Deferred;sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(t){t.getDistinctSemanticObjects().done(e.resolve).fail(e.reject)});return e.promise()};this.isIntentSupported=function(e,t){var n=new o.Deferred;var a={};var r=e.map(function(e){var n=C(e,t);a[n]=e;return n});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(e){e.isIntentSupported(r).done(function(e){var t={};Object.keys(e).forEach(function(n){t[a[n]]=e[n]});n.resolve(t)}).fail(n.reject.bind(n))});return n.promise()};this.isNavigationSupported=function(e,t){var n=new o.Deferred;var a=g(e).map(function(e){var n=this._extractInnerAppRoute(e);return C(n.intent,t)}.bind(this));sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(e){e.isNavigationSupported(a).done(n.resolve).fail(n.reject)});return n.promise()};this.isUrlSupported=function(e){var t=new o.Deferred;if(typeof e!=="string"){t.reject();return t.promise()}if(v.isIntentUrl(e)){var n=v.getHash(e);this.isIntentSupported(["#"+n]).done(function(e){if(e["#"+n]&&e["#"+n].supported){t.resolve()}else{t.reject()}}).fail(function(){t.reject()})}else{t.resolve()}return t.promise()};this.createComponentInstance=function(e,t,n){var a=new o.Deferred;var r=sap.ushell.Container;var i;this.createComponentData(e,t).then(function(e){r.getServiceAsync("Ui5ComponentLoader").then(function(t){return t.modifyComponentProperties(e,f.Application).then(function(e){i=e;return t})}).then(function(e){if(n){n.runAsOwner(function(){t(i)})}else{t(i)}function t(t){t.loadDefaultDependencies=false;e.instantiateComponent(t).then(function(e){a.resolve(e.componentHandle.getInstance())},function(e){e=e||"";h.error("Cannot create UI5 component: "+e,e.stack,"sap.ushell.services.CrossApplicationNavigation");a.reject(e)})}})},function(e){a.reject(e)});return a.promise()};this.createComponentData=function(e,t){return new Promise(function(n,a){var r=sap.ushell.Container;if(!t){t={}}else{var s=Object.keys(t).length;if(s>1||s===1&&!t.componentData){a("`oConfig` argument should either be an empty object or contain only the `componentData` property.");return}}if(t.componentData){delete t.componentData.startupParameters;delete t.componentData.config;delete t.componentData["sap-xapp-state"]}var o=v.constructShellHash(v.parseShellHash(e));if(!o){a("Navigation intent invalid!");return}r.getServiceAsync("NavTargetResolution").then(function(s){s.resolveHashFragment("#"+o).then(function(s){function o(e){e=i({},e,t);if(!e.ui5ComponentName){if(e.additionalInformation){e.ui5ComponentName=e.additionalInformation.replace(/^SAPUI5\.Component=/,"")}else if(e.name){e.ui5ComponentName=e.name}}return e}if(s.applicationType===u.URL.type&&s.appCapabilities&&s.appCapabilities.appFrameworkId==="UI5"&&sap.ushell.Container.inAppRuntime()){sap.ui.require(["sap/ushell/appRuntime/ui5/services/AppLifeCycleAgent"],function(t){t.getAppInfo(s.appCapabilities.technicalAppComponentId).then(function(t){if(t.hasOwnProperty("oResolvedHashFragment")){t=t.oResolvedHashFragment}t=o(t);if(t.url&&e.indexOf("?")>0){t.url+="?"+e.split("?")[1]}p({ui5ComponentName:s.appCapabilities.technicalAppComponentId,applicationDependencies:t,url:t.url})})})}else if(s.applicationType!==u.URL.type&&!/^SAPUI5\.Component=/.test(s.additionalInformation)){a("The resolved target mapping is not of type UI5 component.")}else{p(s)}function p(e){r.getServiceAsync("Ui5ComponentLoader").then(function(t){e=o(e);e.loadDefaultDependencies=false;t.createComponentData(e).then(function(e){n(e)},function(e){e=e||"";h.error("Cannot get UI5 component data: "+e,e.stack,"sap.ushell.services.CrossApplicationNavigation");a(e)})})}})})})};this.createEmptyAppState=function(e,t,n,a){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.createEmptyAppState'. Please use 'createEmptyAppStateAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");var r=sap.ushell.Container.getService("AppState");if(!m.isA(e,"sap.ui.core.UIComponent")){throw new Error("The passed oAppComponent must be a UI5 Component.")}return r.createEmptyAppState(e,t,n,a)};this.createEmptyAppStateAsync=function(e,t,n,a){if(!m.isA(e,"sap.ui.core.UIComponent")){return Promise.reject("The passed oAppComponent must be a UI5 Component.")}return sap.ushell.Container.getServiceAsync("AppState").then(function(r){return r.createEmptyAppState(e,t,n,a)})};this.getStartupAppState=function(e){this._checkComponent(e);var t=e.getComponentData()&&e.getComponentData()["sap-xapp-state"]&&e.getComponentData()["sap-xapp-state"][0];return this.getAppState(e,t)};this._checkComponent=function(e){if(!m.isA(e,"sap.ui.core.UIComponent")){throw new Error("oComponent passed must be a UI5 Component")}};this.getAppState=function(e,t){var n;var a=new o.Deferred;this._checkComponent(e);sap.ushell.Container.getServiceAsync("AppState").then(function(r){if(typeof t!=="string"){if(t!==undefined){h.error("Illegal Argument sAppStateKey ")}setTimeout(function(){n=r.createEmptyUnmodifiableAppState(e);a.resolve(n)},0);return}r.getAppState(t).done(a.resolve).fail(a.reject)});return a.promise()};this.getAppStateData=function(e){return l.invokeUnfoldingArrayArguments(this._getAppStateData.bind(this),[e])};this._getAppStateData=function(e){var t=new o.Deferred;sap.ushell.Container.getServiceAsync("AppState").then(function(n){if(typeof e!=="string"){if(e!==undefined){h.error("Illegal Argument sAppStateKey ")}setTimeout(function(){t.resolve(undefined)},0)}else{n.getAppState(e).done(function(e){t.resolve(e.getData())}).fail(t.resolve.bind(t,undefined))}});return t.promise()};this.saveMultipleAppStates=function(e){var t=[];var n=new o.Deferred;e.forEach(function(e){t.push(e.save())});o.when.apply(this,t).done(function(){n.resolve(t)}).fail(function(){n.reject("save failed")});return n.promise()};this._processShellHashWithParams=function(e){if(e&&e.processParams===true&&e.target&&e.target.shellHash&&e.params){var t=v.parseShellHash(e.target.shellHash);e.target={semanticObject:t.semanticObject,action:t.action,contextRaw:t.contextRaw};e.appSpecificRoute=t.appSpecificRoute;e.params=Object.assign({},e.params,t.params)}};this.getSupportedAppStatePersistencyMethods=function(){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.getSupportedAppStatePersistencyMethods'. Please use 'getSupportedAppStatePersistencyMethodsAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");var e=sap.ushell.Container.getService("AppState");return e.getSupportedPersistencyMethods()};this.getSupportedAppStatePersistencyMethodsAsync=function(){return sap.ushell.Container.getServiceAsync("AppState").then(function(e){return e.getSupportedPersistencyMethods()})};this.makeStatePersistent=function(e,t,n){var a=new o.Deferred;sap.ushell.Container.getServiceAsync("AppState").then(function(r){r.makeStatePersistent(e,t,n).done(a.resolve).fail(a.reject)});return a.promise()};this.resolveIntent=function(e){var t=new o.Deferred;sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(n){n.resolveHashFragment(e).then(function(e){t.resolve({url:e.url})}).fail(function(e){t.reject(e)})});return t.promise()}}d.hasNoAdapter=true;return d},true);