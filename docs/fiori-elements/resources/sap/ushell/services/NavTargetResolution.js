// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/utils/UrlShortening","sap/ushell/utils/HttpClient","sap/ushell/navigationMode","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/base/Log"],function(e,t,n,i,r,a,s,o,l,u,c){"use strict";function p(p,f,h,d){var g=d&&d.config,v=function(e){var t=this._isClientSideTargetResolutionEnabled()?this._resolveHashFragmentClientSide(e):p.resolveHashFragment(e);return t}.bind(this),m,S=[{name:"DefaultAdapter",isApplicable:function(){return true},resolveHashFragment:v.bind(this)}],b;var R=new r;this._isClientSideTargetResolutionEnabled=function(){return!!(g&&g.enableClientSideTargetResolution)};this._nextResolveHashFragment=function(e,t){var n=e.pop();if(n.isApplicable(t)){c.info("NavTargetResolution: custom resolver "+n.name+" resolves "+t);var i=this._nextResolveHashFragment.bind(this,e);return n.resolveHashFragment(t,i)}return this._nextResolveHashFragment(e,t)};this._resolveHashFragmentClientSide=function(e){var t=this._validateHashFragment(e),n;if(!t.success){return(new s.Deferred).reject(e+" is not a valid hash fragment").promise()}n=t.hashFragmentWithoutHash;return this._resolveHashFragmentClientSideAndFixApplicationType(n)};this._resolveHashFragmentClientSideAndFixApplicationType=function(e){var t=new s.Deferred;sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(n){n.resolveHashFragment(e).done(function(e){if(e&&e.applicationType==="SAPUI5"){e.applicationType="URL"}t.resolve(e)}).fail(t.reject)}).catch(t.reject);return t.promise()};this._validateHashFragment=function(e){var n="",i={success:false};if(e&&e.charAt(0)!=="#"){throw new t.Error("Hash fragment expected in _validateHashFragment","sap.ushell.services.NavTargetResolution")}n=e.substring(1);if(n){i.success=true}i.hashFragmentWithoutHash=n;return i};this.expandCompactHash=function(e){var t,r=new s.Deferred;t=n.parseShellHash(e);if(t&&t.params&&t.params["sap-intent-param"]){sap.ushell.Container.getServiceAsync("AppState").then(function(n){n.getAppState(t.params["sap-intent-param"][0]).done(function(t){var n=t.getData("sap-intent-param");var a=e;if(n){a=i.expandParamGivenRetrievalFunction(e,"sap-intent-param",function(){return n})}r.resolve(a)}).fail(function(){r.resolve(e)})}).catch(r.reject)}else{r.resolve(e)}return r.promise()};var C=["NWBC","WDA","TR"];this._adjustResolutionResultForUi5Components=function(e){var t,n;if(typeof e!=="object"){return}delete e["sap.platform.runtime"];if(e&&e.applicationType&&e.applicationType==="SAPUI5"){e.applicationType="URL"}if(e.applicationType==="URL"){t=/^SAPUI5\.Component=(.*)/.exec(e.additionalInformation);n=t&&t[1];if(n){e.ui5ComponentName=n}}};this._getSapSystem=function(e,t){var n;if(t&&t["sap-system"]){return t["sap-system"]}if(t&&t.url){n=new URL(t.url,window.location.href).searchParams.get("sap-system");if(n){return n}}if(C.indexOf(t.applicationType)>=0&&e&&e.substring(1)){n=new URL(e.substring(1),window.location.href).searchParams.get("sap-system");if(n){return n}}return undefined};this.resolveTarget=function(e){var i;var r=l({},e);var a=new s.Deferred;o.average("sap.ushell.navigation.resolveTarget");t.storeSapSystemToLocalStorage(r);i=n.constructShellHash(r);sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(e){e.resolveHashFragment("#"+i).done(function(e){o.end("sap.ushell.navigation.resolveTarget");a.resolve({url:e.url,text:e.text,externalNavigationMode:e.targetNavigationMode==="explace"})}).fail(a.reject)}).catch(a.reject);return a.promise()};this.resolveHashFragment=function(t){var n=new s.Deferred;o.average("sap.ushell.navigation.resolveHashFragment");this.expandCompactHash(t).done(function(i){var r=s.when();if(i.indexOf("sap-ushell-enc-test")>=0){var l=/sap-ushell-enc-test=([^&]*)(&.*)?$/.exec(i);if(l){var c=l[1];if(c!=="A%20B%2520C"){r=new s.Deferred;sap.ushell.Container.getServiceAsync("Message").then(function(e){e.error("This navigation is flagged as erroneous because"+" (likely the calling procedure) generated a wrong encoded hash."+" Please track down the encoding error and make sure to use the CrossApplicationNavigation service for navigation.","Navigation encoding wrong");r.resolve()}).catch(r.reject)}i=i.replace(/sap-ushell-enc-test=([^&]*)&/,"");i=i.replace(/[&?]sap-ushell-enc-test=([^&]*)$/,"")}}var f=this._invokeResolveHashChain(i);if(typeof p.processPostResolution==="function"){f=p.processPostResolution(i,f)}s.when(f,r).done(function(i){this._adjustResolutionResultForUi5Components(i);if(u(i)){if(!i.hasOwnProperty("navigationMode")){i.navigationMode=a.getNavigationMode(i,e.getCurrentApplication())}i.targetNavigationMode=a.getExternalNavigationMode(i.navigationMode)}if(u(i)&&!i.hasOwnProperty("sap-system")){var r=this._getSapSystem(t,i);if(r){i["sap-system"]=r}}o.end("sap.ushell.navigation.resolveHashFragment");n.resolve(i)}.bind(this)).fail(n.reject)}.bind(this)).fail(n.reject);return n.promise().done(function(e){return this._recordNavigation("resolveHashFragment",{sHashFragment:t},e)}.bind(this))};this._invokeResolveHashChain=function(e){var t=S.map(function(e){return e});return this._nextResolveHashFragment(t,e).done(function(e){b=e})};this.baseResolveHashFragment=v.bind(this);this._getGetLinksResolver=function(e){var t;if(this._isClientSideTargetResolutionEnabled()){t=this._getLinksClientSide.bind(this);return{resolver:t,warning:undefined,isGetSemanticObjectLinksCall:false}}if(Object.prototype.toString.apply(e.paramsOptions)==="[object Array]"&&e.paramsOptions.length>0){c.warning("Parameter options supplied to #getLinks will be ignored because FLP is not configured to use sap.ushell.services.ClientSideTargetResolution for target resolution","provided parameters options: "+JSON.stringify(e.paramsOptions,null,4),"sap.ushell.services.NavTargetResolution")}t=p&&p.getLinks&&p.getLinks.bind(p);if(t){return{resolver:t,warning:undefined,isGetSemanticObjectLinksCall:false}}t=p&&p.getSemanticObjectLinks&&p.getSemanticObjectLinks.bind(p);if(t){return{resolver:t,warning:e.hasOwnProperty("action")?"the action argument was given, however, NavTargetResolutionAdapter does not implement getLinks method. Action will be ignored.":undefined,isGetSemanticObjectLinksCall:true}}return{resolver:undefined,warning:"Cannot determine resolver for getLinks method",isGetSemanticObjectLinksCall:undefined}};this.getLinks=function(e){var t=e.semanticObject;var n=e.params;var i=e.ignoreFormFactor;var r=e.ui5Component;var a=e.appStateKey;var o=e.compactIntents;var l=new s.Deferred;if(/\?/.test(t)){throw new Error("Parameter must not be part of semantic object")}var u=n===undefined?undefined:JSON.parse(JSON.stringify(n));if(a){u=u||{};u["sap-xapp-state"]=encodeURIComponent(a)}var p=this._getGetLinksResolver(e);if(p.warning){c.warning("A problem occurred while determining the resolver for getLinks",p.warning,"sap.ushell.services.NavTargetResolution")}var f=p.resolver;if(f){var h=function(e){if(o){this._shortenGetSemanticObjectLinksResults(e,r).done(l.resolve)}else{l.resolve(e)}}.bind(this);if(p.isGetSemanticObjectLinksCall){var d={target:{semanticObject:t,action:"dummyAction"},params:u};sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(e){e.hrefForExternal(d,true,r,true).done(function(e){var n=e.params||u;f(t,n,i).done(h).fail(l.reject)}).fail(l.reject)})}else{f(e).done(h).fail(l.reject)}}else{l.resolve([])}return l.promise().done(function(t){return this._recordNavigation("getLinks",{oArgs:e},t)}.bind(this))};this.getDistinctSemanticObjects=function(){var e=new s.Deferred;if(this._isClientSideTargetResolutionEnabled()){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(t){t.getDistinctSemanticObjects().done(e.resolve).fail(e.reject)}).catch(e.reject);return e.promise().done(function(e){return this._recordNavigation("getDistinctSemanticObjects",{},e)}.bind(this))}if(p&&p.getDistinctSemanticObjects){return p.getDistinctSemanticObjects.call(p)}c.error("Cannot execute getDistinctSemanticObjects method","ClientSideTargetResolution must be enabled or NavTargetResolutionAdapter must implement getDistinctSemanticObjects method","sap.ushell.services.NavTargetResolution");return e.reject("Cannot execute getDistinctSemanticObjects").promise()};this._getLinksClientSide=function(e){var t=new s.Deferred;var i=new s.Deferred;if((e.params||{}).hasOwnProperty("sap-intent-param")){var r="#"+e.semanticObject+"-dummyAction?"+n.paramsToString(e.params);this.expandCompactHash(r).done(function(e){var t=n.parseShellHash(e);i.resolve(t.params)}).fail(t.reject)}else{i.resolve(e.params)}i.done(function(){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(n){n.getLinks(e).done(t.resolve).fail(t.reject)}).catch(t.reject)});return t.promise()};this._shortenGetSemanticObjectLinksResults=function(e,t){var i=[];var r=0;var a=e.length;var o=new s.Deferred;sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(s){e.forEach(function(e){var l=n.parseShellHash(e.intent);var u=s.compactParams(l.params,undefined,t);i.push(u);i[r].done(function(t,r){i[t]={text:e.text,intent:"#"+l.semanticObject+"-"+l.action+"?"+n.paramsToString(r)}}.bind(null,r)).fail(function(t,n){c.warning("Cannot shorten GetSemanticObjectLinks result, using expanded form","Failure message: "+n+"; intent had title ''"+e.title+"'' and link ''"+e.intent+"'","sap.ushell.services.NavTargetResolution");i[t]={text:e.text,intent:e.intent}}.bind(null,r)).always(function(){a--;if(a===0){o.resolve(i)}});r++})}).catch(o.reject);return o.promise()};this.isIntentSupported=function(e){var t={};var n=new s.Deferred;if(this._isClientSideTargetResolutionEnabled()){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(t){t.isIntentSupported(e).done(n.resolve).fail(n.reject)}).catch(n.reject);return n.promise()}if(p.isIntentSupported){return p.isIntentSupported(e)}e.forEach(function(e){t[e]={supported:undefined}});return n.resolve(t).promise()};this.isNavigationSupported=function(e){var t=new s.Deferred,i=[];i=e.map(function(e){if(typeof e==="string"){return e}return"#"+n.constructShellHash(e)});this.isIntentSupported(i).done(function(e){var n=i.map(function(t){return e[t]||{supported:false}});t.resolve(n)}).fail(t.reject.bind(t));return t.promise().done(function(t){return this._recordNavigation("isNavigationSupported",{aIntents:e},t)}.bind(this))};this._recordNavigation=function(e,t,n){var i=g&&g.usageRecorder||{};if(i.enabled){var r=i.serviceUrl||"/navigation/api/v2/record";R.post(r,{headers:{"content-type":"application/json; charset=utf-8"},data:{function:e,parameters:JSON.stringify(t),result:JSON.stringify(n)}})}return n};this.registerCustomResolver=function(e){if(typeof e.name!=="string"){c.error("NavTargetResolution: Custom Resolver must have name {string} member");return false}if(typeof e.isApplicable!=="function"){c.error("NavTargetResolution: Custom Resolver must have isApplicable member");return false}if(typeof e.resolveHashFragment!=="function"){c.error('NavTargetResolution: Custom Resolver must have "resolveHashFragment" member');return false}S.push(e);return true};if(g&&Array.isArray(g.resolveLocal)){m=g.resolveLocal.map(function(e){return e.linkId});this.registerCustomResolver({name:"localResolveNavigationResolver",cleanHash:function(e){if(e===""){return"#"}var t=n.parseShellHash(e.substring(1));if(!t){return"#"}e="#"+t.semanticObject+"-"+t.action;return e},_getIndex:function(e){var t=this.cleanHash(e);return m.indexOf(t.substring(1))},isApplicable:function(e){return this._getIndex(e)>=0},resolveHashFragment:function(e){var t,i=this._getIndex(e),r,a,o,l;t=new s.Deferred;r=JSON.parse(JSON.stringify(g.resolveLocal[i].resolveTo));a=n.parseShellHash(e);if(a&&a.params){l=n.paramsToString(a.params);if(l){o=r.url.indexOf("?")>=0;r.url=r.url+(o?"&":"?")+l}}t.resolve(r);return t.promise()}})}this.registerCustomResolver({name:"LocalResolver",aElement:undefined,cleanHash:function(e){if(e===""){return undefined}var t=n.parseShellHash(e.substring(1));if(!t){return undefined}e="#"+t.semanticObject+"-"+t.action;return e},isApplicable:function(e){e=this.cleanHash(e);if(!e){return false}return e==="#Test-url"||e==="#Test-local1"||e==="#Test-local2"||e==="#Test-config"||e==="#Test-clear"},parseUrl:function(e){if(!this.aElement){this.aElement=window.document.createElement("a")}this.aElement.href=e;return this.aElement},resolveHashFragment:function(e){var n=new s.Deferred,i=null,r,a,o,l,u,p=this;e=this.cleanHash(e);if(!e){return false}i={"#Test-config":{applicationType:"URL",url:"/sap/bc/ui5_ui5/ui2/ushell/test-resources/sap/ushell/demoapps/FioriSandboxConfigApp",additionalInformation:"SAPUI5.Component=sap.ushell.demoapps.FioriSandboxConfigApp"},none:{applicationType:"URL",url:"",additionalInformation:""}};function f(e){if(localStorage){return localStorage[e]}return undefined}function h(e){if(t.calculateOrigin(p.parseUrl(e))!==t.calculateOrigin(window.location)){return undefined}return e}function d(e){return new URLSearchParams(window.location.search).get(e)}function v(e,t){if(localStorage){localStorage[e]=t}}if(i[e]){r=i[e]}else if(e==="#Test-clear"){v("sap.ushell.#Test-local1",undefined);v("sap.ushell.#Test-local2",undefined);c.info("NavTargetResolution: Local storage keys for #Test have been cleared");r=i["#Test-config"]}else if(e==="#Test-local1"||e==="#Test-local2"||e==="#Test-url"){r=f("sap.ushell."+e);if(!r||r==="undefined"){a={applicationType:"URL"}}else{a=JSON.parse(r)}if(window.location.hostname==="localhost"||g&&g.allowTestUrlComponentConfig){l="sap-ushell-test-"+e.substring(6);o=d(l+"-additionalInformation");if(o){a.additionalInformation=o}u=d(l+"-url");if(u){a.url=h(u)}}if(!a.url){c.info("NavTargetResolution: No configured app for "+e+" found ( local storage or url params sap-ushell-test-local1-url  sap-ushell-test-local1-additionalInfo  not supplied? ");c.info("NavTargetResolution: Defaulting to config app ...\n");n.reject("URL is not resolvable");return n.promise()}a.url=h(a.url);r=a}if(r.url===undefined){n.reject("URL is not resolvable");return n.promise()}c.info("NavTargetResolution: As URL:  http://localhost:8080/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html?sap-ushell-test-local1-url="+encodeURIComponent(r&&r.url||"")+"&sap-ushell-test-local1-additionalInformation="+encodeURIComponent(r&&r.additionalInfo||"")+"#Test-local1");c.info("NavTargetResolution: Resolving "+e+" to "+JSON.stringify(r));n.resolve(r);return n.promise()}});this.getCurrentResolution=function(){return b}}p.hasNoAdapter=false;return p},true);