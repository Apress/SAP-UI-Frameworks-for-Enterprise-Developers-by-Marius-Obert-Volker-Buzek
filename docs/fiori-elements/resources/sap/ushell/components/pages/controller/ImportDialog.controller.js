// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ushell/components/pages/MyHomeImport","sap/ushell/Config","sap/ushell/library","sap/ushell/resources","sap/ushell/utils/WindowUtils"],function(e,t,i,n,s,r,a,o,u){"use strict";var l=a.DisplayFormat;var c={"X-SAP-UI2-CHIP:SSB_NUMERIC":"ssuite/smartbusiness/tiles/numeric","X-SAP-UI2-CHIP:SSB_CONTRIBUTION":"ssuite/smartbusiness/tiles/contribution","X-SAP-UI2-CHIP:SSB_TREND":"ssuite/smartbusiness/tiles/trend","X-SAP-UI2-CHIP:SSB_DEVIATION":"ssuite/smartbusiness/tiles/deviation","X-SAP-UI2-CHIP:SSB_COMPARISON":"ssuite/smartbusiness/tiles/comparison","X-SAP-UI2-CHIP:SSB_BLANK":"ssuite/smartbusiness/tiles/blank","X-SAP-UI2-CHIP:SSB_DUAL":"ssuite/smartbusiness/tiles/dual"};return t.extend("sap.ushell.components.pages.controller.ImportDialog",{open:function(){if(!this._pFragmentLoad){this._pFragmentLoad=i.load({name:"sap.ushell.components.pages.view.ImportDialog",controller:this}).then(function(e){this._oDialog=e;this._oDialog.setModel(o.i18nModel,"i18n");this._oDialog.setModel(new n({busy:true,groups:[],PersonalizedGroups:[]}));s.getData().then(function(t){e.getModel().setData({busy:false,groups:t,PersonalizedGroups:t.map(function(e){return{title:e.isDefault?o.i18n.getText("my_group"):e.title,description:e.id,selected:true}})})}).catch(function(e){return sap.ushell.Container.getServiceAsync("Message").then(function(t){t.error(e)})});return this._oDialog}.bind(this))}return Promise.all([sap.ushell.Container.getServiceAsync("URLParsing").then(function(e){this._oURLParsingService=e}.bind(this)),this._pFragmentLoad]).then(function(){this._oDialog.open();return this._oDialog}.bind(this))},close:function(){if(this._oDialog){this._oDialog.close()}},doImport:function(){var e=this._oDialog.getModel();var t=[];e.getProperty("/PersonalizedGroups").forEach(function(e){if(e.selected){t.push(e.description)}});var i=this._prepareImport(t);this._saveImport(i)},_moveVisualization:function(e,t,i,n,s){var r=this._getSectionIndex(e,t,i,s);var a=this._getDefaultSectionIndex(e);var o=this._getDefaultSection(e);var u=0;if(o&&o.visualizations&&o.visualizations.length){u=o.visualizations.length-1}return e.moveVisualization(this.iPageIndex,a,u,r,n)},_updateVisualization:function(e,t,i,n,s,r){if(i.bUpdateNeeded){var a=this._getSectionIndex(e,t,n,r);var o=this._filterNonSupportedProperties(i,["title","target","subtitle","icon","info","numberUnit","indicatorDataSource","displayFormatHint"]);return e.updateVisualization(this.iPageIndex,a,s,o)}return Promise.resolve()},_addVisualization:function(e,t,i,n,s,r,a){var o;if(t.isABookmark){if(t.isCustomBookmark){this.aPromiseChain.push(function(){o=this._filterNonSupportedProperties(t,["title","url","subtitle","icon","info","vizConfig","loadManifest","chipConfig"]);return s.bookmark.addCustomBookmark(t.vizType,o,r).then(this._moveVisualization.bind(this,s.pages,e,n,i,a)).then(this._updateVisualization.bind(this,s.pages,e,t,n,i,a))}.bind(this))}else{this.aPromiseChain.push(function(){o=this._filterNonSupportedProperties(t,["title","url","icon","info","subtitle","serviceUrl","serviceRefreshInterval","numberUnit"]);return s.bookmark.addBookmark(o,r).then(this._moveVisualization.bind(this,s.pages,e,n,i,a)).then(this._updateVisualization.bind(this,s.pages,e,t,n,i,a))}.bind(this))}}else{this.aPromiseChain.push(function(){var r=this._getSectionIndex(s.pages,e,n,a);var o=s.pages.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/"+r+"/id");return s.pages.addVisualization(this.sPageId,o,t.vizId).then(this._updateVisualization.bind(this,s.pages,e,t,n,i,a))}.bind(this))}},_addToPresetSection:function(e,t,i,n,s){var r=this._getPresetSection(i.pages);var a=r.visualizations.filter(function(e){return e.displayFormatHint!==l.Compact}).length;var o=r.visualizations.filter(function(e){return e.displayFormatHint===l.Compact}).length;for(var u=0;u<e.tiles.length;++u){this._addVisualization(e,e.tiles[u],u+a,t,i,n,s)}for(var c=0;c<e.links.length;++c){this._addVisualization(e,e.links[c],c+o+a+e.tiles.length,t,i,n,s)}},_addSection:function(e,t,i,n,s){this.aPromiseChain.push(function(){var n=this._getSectionIndex(i.pages,e,t,s);return i.pages.addSection(this.iPageIndex,n,{title:e.title})}.bind(this));for(var r=0,a=e.tiles.length;r<a;++r){this._addVisualization(e,e.tiles[r],r,t,i,n,s)}for(var o=0,u=e.links.length;o<u;++o){this._addVisualization(e,e.links[o],o+e.tiles.length,t,i,n,s)}},_getMyHomeContentNode:function(e){var t=r.last("/core/spaces/myHome/myHomeSpaceId");return e.getContentNodes().then(function(e){var i=e.find(function(e){return e.id===t});if(!i){return null}return i.children.find(function(e){return e.id===this.sPageId}.bind(this))}.bind(this))},_saveImport:function(e){this._oDialog.setBusy(true);var t;this.sPageId=r.last("/core/spaces/myHome/myHomePageId");this.aPromiseChain=[];return Promise.all([sap.ushell.Container.getServiceAsync("Bookmark"),sap.ushell.Container.getServiceAsync("Message"),sap.ushell.Container.getServiceAsync("Pages"),sap.ushell.Container.getServiceAsync("UserInfo")]).then(function(e){t={bookmark:e[0],message:e[1],pages:e[2],userInfo:e[3]};return this._getMyHomeContentNode(t.bookmark)}.bind(this)).then(function(i){this.iPageIndex=t.pages.getPageIndex(this.sPageId);t.pages.enableImplicitSave(false);this._performImportOperations(e,t,i);return this._executeSequentially(this.aPromiseChain)}.bind(this)).then(function(){return this._savePersonalizations(t.pages)}.bind(this)).then(function(){t.message.info(o.i18n.getText("MyHome.InitialPage.Message.ImportSuccessful"));t.userInfo.getUser().setImportBookmarksFlag("done");return t.userInfo.updateUserPreferences()}).then(function(){u.refreshBrowser()}).catch(function(e){t.message.error(e)}).finally(function(){this._oDialog.setBusy(false);this.close()}.bind(this))},_performImportOperations:function(e,t,i){var n;var s=false;for(var r=0,a=e.length;r<a;++r){n=e[r];if(n.isDefault){this._addToPresetSection(n,r,t,i,s);s=true}else{this._addSection(n,r,t,i,s)}}},_executeSequentially:function(t){return t.reduce(function(t,i){return t.then(function(){return i()}).catch(function(t){e.error(t)})},Promise.resolve())},_getSectionIndex:function(e,t,i,n){var s=this._getPresetSectionIndex(e);if(!t.isDefault&&!t.isLocked&&!n){return s+i+1}return s+i},_getPresetSectionIndex:function(e){var t=e.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return t.findIndex(function(e){return e.id===r.last("/core/spaces/myHome/presetSectionId")})},_getDefaultSectionIndex:function(e){var t=e.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return t.findIndex(function(e){return e.default})},_getPresetSection:function(e){var t=e.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return t.find(function(e){return e.id===r.last("/core/spaces/myHome/presetSectionId")})},_getDefaultSection:function(e){var t=e.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return t.find(function(e){return e.default})},_gatherVizDataObjectFromChipInstance:function(t){var i;var n;var s={vizId:t.chipId,isABookmark:!!t.configuration};var a=r.last("/core/stableIDs/enabled");if(a){var o=t.Chip&&t.Chip.referenceChipId;if(o&&o!=="O"){s.vizId=t.Chip.referenceChipId}}if(s.isABookmark){s.isCustomBookmark=["X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER","X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER"].indexOf(t.chipId)===-1;i=JSON.parse(JSON.parse(t.configuration).tileConfiguration);s.title=i.display_title_text;s.url=i.navigation_target_url;s.icon=i.display_icon_url;s.info=i.display_info_text;s.subtitle=i.display_subtitle_text;s.serviceUrl=i.service_url;s.serviceRefreshInterval=i.service_refresh_interval;s.numberUnit=i.display_number_unit}if(s.isCustomBookmark){if(i.TILE_PROPERTIES){try{var u=JSON.parse(i.TILE_PROPERTIES);if(!s.url&&u.semanticObject&&u.semanticAction){var l={};if(u.evaluationId){l.EvaluationId=u.evaluationId}s.url="#"+this._oURLParsingService.constructShellHash({target:{semanticObject:u.semanticObject,action:u.semanticAction},params:l})}if(u.title){s.title=u.title}if(u.subtitle){s.subtitle=u.subtitle}}catch(t){e.error("Could not create URL for custom bookmark with title: "+s.title+", Error Message: "+t.message)}}s.vizConfig={};s.loadManifest=true;s.vizType=c[t.chipId];s.chipConfig={chipId:t.chipId,bags:{},configuration:JSON.parse(t.configuration)}}n=t.ChipInstanceBags.results;if(n.length){s.bUpdateNeeded=!s.isABookmark;if(s.isCustomBookmark){n.forEach(function(e){s.chipConfig.bags[e.id]={properties:{},texts:{}};e.ChipInstanceProperties.results.forEach(function(t){if(t.translatable==="X"){s.chipConfig.bags[e.id].texts[t.name]=t.value}else{s.chipConfig.bags[e.id].properties[t.name]=t.value}})})}n.filter(function e(t){return t.id==="tileProperties"}).forEach(function(e){e.ChipInstanceProperties.results.forEach(function(e){switch(e.name){case"display_title_text":s.title=e.value;break;case"display_subtitle_text":s.subtitle=e.value;break;case"display_info_text":s.info=e.value;break;case"display_search_keywords":s.searchKeyword=e.value;break;default:break}})});n.filter(function e(t){return t.id==="sb_tileProperties"}).forEach(function(e){e.ChipInstanceProperties.results.forEach(function(e){switch(e.name){case"title":s.title=e.value;break;case"description":s.subtitle=e.value;break;default:break}})})}return s},_savePersonalizations:function(e){e.enableImplicitSave(true);return e.savePersonalization(this.sPageId).then(function(){e.enableImplicitSave(false)})},_prepareImport:function(e){var t={};var i=this._oDialog.getModel();var n=i.getProperty("/groups");var s;var r;n.forEach(function(i){if(e.indexOf(i.id)===-1){return}s={};i.chips.forEach(function(e){r=this._gatherVizDataObjectFromChipInstance(e);s[e.instanceId]=r}.bind(this));i.tiles=[];i.tileOrder.forEach(function(e){r=s[e];if(r){delete s[e];i.tiles.push(r)}});i.links=[];i.linkOrder.forEach(function(e){r=s[e];if(r){delete s[e];r.displayFormatHint=l.Compact;r.bUpdateNeeded=true;i.links.push(r)}});Object.keys(s).map(function(e){i.tiles.push(s[e])});t[i.id]=i}.bind(this));var a=[];var o;e.forEach(function(e){o=t[e];if(o){a.push(o)}});return a},_filterNonSupportedProperties:function(e,t){var i={};Object.keys(e).forEach(function(n){if(t.includes(n)){i[n]=e[n]}});return i}})});