// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/extend","sap/ushell/services/AppConfiguration","sap/ushell/components/applicationIntegration/elements/model","sap/ui/Device","sap/ushell/Config","sap/ushell/utils","sap/ushell/resources","sap/ushell/EventHub","sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements","sap/ui/performance/Measurement","sap/ui/util/Mobile","sap/ui/core/Core"],function(e,t,n,i,a,s,o,r,l,c,u,p){"use strict";function h(){var h;var f;var m;var d;this.getIsTitleChanged=function(){return h};this.getIsRelatedAppsChanged=function(){return d};this.getHierarchyDefaultValue=function(){var e=[];var t=a.last("/core/shell/model/currentState/stateName");if(t&&(t==="app"||t==="embedded")){e=[{icon:"sap-icon://home",title:o.i18n.getText("actionHomePage"),intent:m?"#"+m:"#"}];var n=a.last("/core/shell/model/currentSpaceAndPage");if(n!==undefined){e.splice(0,0,{icon:"sap-icon://space-navigation",title:n.pageTitle,subtitle:n.pageTitle!==n.spaceTitle?n.spaceTitle:undefined,intent:"#"+n.hash})}}return e};this.init=function(e){m=e};this.getIsHierarchyChanged=function(){return f};this.onHierarchyChange=function(t){f=true;var i=t.getParameters().data,s=[],o=a.last("/core/shell/model/currentState/stateName");if(!i){i=[]}var r=this.getHierarchyDefaultValue();i.forEach(function(t,n){s[n]=e({},t)});s=s.concat(r);if(o==="home"){n.updateStateProperty("application/hierarchy",s,false,["home"])}n.updateStateProperty("application/hierarchy",s,true)}.bind(this);this.onRelatedAppsChange=function(e){d=true;var t=e.getParameters().data,i=a.last("/core/shell/model/currentState/stateName");if(!t){t=[]}if(i==="home"){n.updateStateProperty("application/relatedApps",t,false,["home"])}n.updateStateProperty("application/relatedApps",t,true)};this.resetShellUIServiceHandlers=function(){d=false;f=false;h=false};this.onTitleChange=function(e){h=true;var t=e.getParameters().data;if(!t&&!(e.getParameters().bAcceptEmptyString===true)){t=this.getAppMeta().getTitleDefaultValue()}var i=a.last("/core/shell/model/currentState/stateName");if(i==="home"){n.updateStateProperty("application/title",t,false,["home"])}n.updateStateProperty("application/title",t,true);l.genericSetItem("application/title",t);window.document.title=t;s.setPerformanceMark("FLP -- title change");r.emit("TitleChanged",t)};this._getDefaultFavIcon=function(e){var t=e.get("sapUiShellFavicon");if(t){var n=/url[\s]*\('?"?([^'")]*)'?"?\)/.exec(t);if(n){t=n[1]}else if(t==="''"||t==="none"){t=null}}var i=a.last("/core/shell/favIcon");if(i&&t===null){return i}if(!t){var s=sap.ui.require.toUrl("sap/ushell");return s+"/themes/base/img/launchpad_favicon.ico"}return t};this.getFavIconHref=function(){var e=document.querySelector('link[rel="shortcut icon"]');return e&&e.getAttribute("href")||""};this.getAppIcon=function(){var e="sap-icon://folder",n=t.getMetadata();if(n&&n.icon){e=n.icon}return e};this.setAppIcons=function(e){c.start("FLP:ShellController.setAppIcons","setValues","FLP");sap.ui.require(["sap/ui/core/theming/Parameters"],function(t){if(p.isThemeApplied()){this.setValues(e,t)}else{p.attachThemeChanged(function(){this.setValues(e,t)}.bind(this))}}.bind(this));c.end("FLP:ShellController.setAppIcons")};this.setValues=function(e,t){var n=sap.ui.require.toUrl("sap/ushell"),a=e&&e.homeScreenIconPhone||n+"/themes/base/img/launchicons/57_iPhone_Desktop_Launch.png",s=e&&e["homeScreenIconPhone@2"]||n+"/themes/base/img/launchicons/114_iPhone-Retina_Web_Clip.png",o=e&&e.homeScreenIconTablet||n+"/themes/base/img/launchicons/72_iPad_Desktop_Launch.png",r=e&&e["homeScreenIconTablet@2"]||n+"/themes/base/img/launchicons/144_iPad_Retina_Web_Clip.png",l=e&&e.favIcon||this._getDefaultFavIcon(t),c=this.getFavIconHref();if(i.os.ios){u.setIcons({phone:a,"phone@2":s,tablet:o,"tablet@2":r,favicon:l,precomposed:false})}else if(c!==l){u.setIcons({phone:"","phone@2":"",tablet:"","tablet@2":"",favicon:l,precomposed:true})}};this._applyContentDensityByPriority=function(e,n){return new Promise(function(a){sap.ushell.Container.getServiceAsync("UserInfo").then(function(s){var o;if(e===undefined){if(i.system.combi){var r=s.getUser(),l="autoDetect";if(r){l=r.getContentDensity()}switch(l){case"cozy":e=false;break;case"compact":e=true;break;default:o=t.getMetadata();if(o.compactContentDensity&&!o.cozyContentDensity){e=true}else{e=false}}}else{o=t.getMetadata();if(o.compactContentDensity&&!o.cozyContentDensity){e=true}else if(!o.compactContentDensity&&o.cozyContentDensity){e=false}else{e=this._isCompactContentDensityByDevice()}}}this._applyContentDensityClass(e,n).then(a)}.bind(this))}.bind(this))};this._applyContentDensityClass=function(e,t){return new Promise(function(n,i){function a(e){document.body.classList.toggle("sapUiSizeCompact",e);document.body.classList.toggle("sapUiSizeCozy",!e);if(t===true){sap.ui.require(["sap/ushell/components/applicationIntegration/AppLifeCycle"],function(t){t.postMessageToIframeApp("sap.ushell.appRuntime","uiDensityChange",{isTouch:e?"0":"1"})})}n()}if(e===undefined){sap.ushell.Container.getServiceAsync("UserInfo").then(function(e){var t=e.getUser?e.getUser():undefined;var n;if(t&&t.getContentDensity()==="compact"){n=true}else if(t&&t.getContentDensity()==="cozy"){n=false}else{n=this._isCompactContentDensityByDevice()}a(n)}.bind(this))}else{a(!!e)}}.bind(this))}.bind(this);this._isCompactContentDensityByDevice=function(){return!i.support.touch||i.system.combi};this.getTitleDefaultValue=function(){var e="",n=t.getMetadata();if(n&&n.title){e=n.title}return e};this.create=function(){};this.restore=function(e){this._applyContentDensityByPriority();this.setAppIcons(e)};this.store=function(e){};this.destroy=function(e){}}return new h},true);