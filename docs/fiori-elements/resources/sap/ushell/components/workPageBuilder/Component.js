//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/UIComponent","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/services/VisualizationInstantiation"],function(t,e,i,o){"use strict";return t.extend("sap.ushell.components.workPageBuilder.Component",{metadata:{manifest:"json",library:"sap.ushell",events:{workPageEdited:{},visualizationFilterApplied:{parameters:{filters:{type:"array"}}},closeEditMode:{parameters:{saveChanges:{type:"boolean"}}}}},init:function(){this.oSiteApplications={};this.oSiteVizTypes={};this._oVizInstantiationPromise=Promise.resolve(new o);t.prototype.init.apply(this,arguments)},getVizInstantiationPromise:function(){return this._oVizInstantiationPromise},getEditMode:function(){return this.getRootControl().getController().getEditMode()},setEditMode:function(t){this.getRootControl().getController().setEditMode(t)},getPageData:function(){return this.getRootControl().getController().getPageData()},setPageData:function(t){return Promise.all([this._transformVizData(e.get("WorkPage.UsedVisualizations.nodes",t)||[])]).then(function(i){var o=i[0];this.getRootControl().getController().setPageData({WorkPage:{Contents:e.get("WorkPage.Contents",t),UsedVisualizations:{nodes:o}}})}.bind(this))},setVisualizationData:function(t){return this._transformVizData(e.get("Visualizations.nodes",t)||[]).then(function(t){this.getRootControl().getController().setVisualizationData({Visualizations:{nodes:t}})}.bind(this))},getNavigationDisabled:function(){return this.getRootControl().getController().getNavigationDisabled()},setNavigationDisabled:function(t){this.getRootControl().getController().setNavigationDisabled(t)},getUshellContainer:function(){return e.get("sap.ushell.Container")||e.get("parent.sap.ushell.Container")},setShowFooter:function(t){this.getRootControl().getController().setShowFooter(t)},_transformVizData:function(t){var e=this.getUshellContainer();var i;if(!e){return Promise.resolve(t)}i=t.find(function(t){return t.Type==="sap.ushell.StaticAppLauncher"||t.Type==="sap.ushell.DynamicAppLauncher"});if(!i){return Promise.resolve(t)}return Promise.all([e.getServiceAsync("ClientSideTargetResolution"),e.getServiceAsync("CommonDataModel")]).then(function(e){var i=e[0];var o=e[1];return this._saveSiteData(o).then(function(){return this._replaceIndicatorDatasource(t,i)}.bind(this))}.bind(this))},_replaceIndicatorDatasource:function(t,o){return Promise.all(t.map(function(t){var n=e.get(["Descriptor","sap.flp","target","appId"],t);var a=this.getSiteApplication(n);var r=e.get(["Descriptor","sap.flp","indicatorDataSource"],t);var s;if(a){s=e.get(["sap.app","contentProviderId"],a);if(s&&r&&r.path){return o.getSystemContext(s).then(function(i){if(i){var o=r.dataSource;var n=e.get(["Descriptor","sap.app","dataSources",o],t);var a;if(n){a=i.getFullyQualifiedXhrUrl(n.uri);e.set(["Descriptor","sap.app","dataSources",o,"uri"],a,t)}else{a=i.getFullyQualifiedXhrUrl(r.path);e.set(["Descriptor","sap.flp","indicatorDataSource","path"],a,t)}}return t}).catch(function(e){i.error(e);return t})}}return Promise.resolve(t)}.bind(this)))},_saveSiteData:function(t){return Promise.all([t.getApplications(),t.getVizTypes()]).then(function(t){this.oSiteApplications=t[0]||{};this.oSiteVizTypes=t[1]||{}}.bind(this))},getSiteApplication:function(t){return this.oSiteApplications[t]},getSiteVizType:function(t){return this.oSiteVizTypes[t]}})});