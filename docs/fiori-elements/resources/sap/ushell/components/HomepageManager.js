// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/base/Object","sap/ui/Device","sap/ui/model/Filter","sap/ushell/ui/launchpad/TileState","sap/ushell/components/_HomepageManager/PagingManager","sap/ushell/components/_HomepageManager/DashboardLoadingManager","sap/ushell/EventHub","sap/ushell/Config","sap/ushell/utils","sap/ushell/resources","sap/ushell/components/DestroyHelper","sap/ushell/components/GroupsHelper","sap/ushell/components/MessagingHelper","sap/m/GenericTile","sap/m/SelectDialog","sap/m/StandardListItem","sap/ushell/components/_HomepageManager/PersistentPageOperationAdapter","sap/ushell/components/_HomepageManager/TransientPageOperationAdapter","sap/ui/model/FilterOperator","sap/m/library","sap/ui/model/Context","sap/m/MessageToast","sap/base/Log","sap/base/util/extend","sap/ui/performance/Measurement","sap/ushell/Config"],function(e,t,i,o,r,s,n,a,l,u,d,p,h,g,c,f,v,b,m,M,P,T,G,_,y,I,k,w){"use strict";var L=T.GenericTileScope;var S={PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"};var A=[];var O;var x=i.extend("sap.ushell.components.HomepageManager",{metadata:{publicMethods:["getModel","getDashboardView","loadPersonalizedGroups","resetGroupsOnFailure","addGroupToModel","addTileToGroup","deleteTilesFromGroup"]},analyticsConstants:S,constructor:function(i,o){if(O){if(!O.view){O.setDashboardView(o.view)}return O}this.oServiceLoadingPromise=sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this.oPageBuilderService=e;this.oPageBuilderService.registerTileActionsProvider(this._addFLPActionsToTile.bind(this));this.oPageOperationAdapter=m.getInstance(e);this.bLinkPersonalizationSupported=this.oPageOperationAdapter.isLinkPersonalizationSupported()}.bind(this));t.attachThemeChanged(d.handleTilesVisibility);O=this;this.oModel=o.model;this.oRouter=o.router;this.oDashboardView=o.view;this.oSortableDeferred=new e.Deferred;this.oSortableDeferred.resolve();this.registerEvents();this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0;this.tileUuid=null;this.bIsGroupsModelLoading=false;this.bIsGroupsRequestPending=false;this.segmentsStore=[];this.bIsFirstSegment=true;this.bIsFirstSegmentViewLoaded=false;this.aGroupsFrame=null;this.iMinNumOfTilesForBlindLoading=this.oModel.getProperty("/optimizeTileLoadingThreshold")||100;this.bIsScrollModeAccordingKPI=false;this.oGroupNotLockedFilter=new r("isGroupLocked",P.EQ,false);this.oDashboardLoadingManager=new a("loadingManager",{oDashboardManager:this});if(this.oRouter){var s=this.oRouter.getTarget("home");s.attachDisplay(function(e){this.oDashboardView=e.getParameter("view")}.bind(this))}var n=u.last("/core/home/enableTransientMode");A.push(u.on("/core/home/enableTransientMode").do(function(e){if(n===e){return}n=e;this._changeMode(e)}.bind(this)));this.oModel.bindProperty("/tileActionModeActive").attachChange(this._changeLinksScope.bind(this));this._aRequestQueue=[];this._bRequestRunning=false;return undefined},_addRequest:function(e){this._aRequestQueue.push(e);if(!this._bRequestRunning){this._bRequestRunning=true;this._aRequestQueue.shift()()}},_checkRequestQueue:function(){if(this._aRequestQueue.length===0){this._bRequestRunning=false}else{this._aRequestQueue.shift()()}},_requestFailed:function(){this._aRequestQueue=[];this._bRequestRunning=false},isBlindLoading:function(){var e=u.last("/core/home/homePageGroupDisplay");if((e===undefined||e==="scroll")&&this.bIsScrollModeAccordingKPI){y.info("isBlindLoading reason IsScrollModeAccordingKPI and IsScrollMode: true");return true}if(this.oModel.getProperty("/tileActionModeActive")){y.info("isBlindLoading reason TileActionModeActive : true");return true}return false},createMoveActionDialog:function(e){var t=new v(e,{title:p.i18n.getText("moveTileDialog_title"),rememberSelections:false,contentWidth:"400px",contentHeight:"auto",confirm:function(t){var i=t.getParameter("selectedContexts");this.publishMoveActionEvents(i,e)}.bind(this),cancel:function(){var e=document.querySelector('.sapUshellTile[tabindex="0"]');if(e){e.focus()}},items:{path:"/groups",template:new b({title:"{title}"})}});return t},publishMoveActionEvents:function(e,i){var r=t.getEventBus();if(e.length){var s=this.tileType==="link"?"links":"tiles";var n=e[0].getObject().groupId;var a={sTileId:this.tileUuid,sToItems:s,sFromItems:s,sTileType:s,toGroupId:e[0].getObject().groupId,toIndex:e[0].getObject()[this.tileType==="link"?"links":"tiles"].length,source:i};if(o.system.desktop){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){a.callBack=e.callbackSetFocus.bind(e);r.publish("launchpad","scrollToGroup",{groupId:n});r.publish("launchpad","movetile",a)})})}else{r.publish("launchpad","scrollToGroup",{groupId:n});r.publish("launchpad","movetile",a)}}},_changeLinksScope:function(e){var t=this;if(this.bLinkPersonalizationSupported){var i=e.getSource().getValue();this.oModel.getProperty("/groups").forEach(function(e,o){if(!e.isGroupLocked){t._changeGroupLinksScope(e,i?"Actions":"Display")}})}},_changeGroupLinksScope:function(e,t){var i=this;e.links.forEach(function(e,o){i._changeLinkScope(e.content[0],t)})},_changeLinkScope:function(e,t){var i;if(e.getScope){i=e}else if(e.getContent){i=e.getContent()[0]}if(this.bLinkPersonalizationSupported&&i&&i.setScope){i.setScope(t)}},registerEvents:function(){var e=t.getEventBus();e.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.subscribe("launchpad","tabSelected",this.getSegmentTabContentViews,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileAdded",this._addBookmarkToModel,this);e.subscribe("sap.ushell.services.Bookmark","catalogTileAdded",this._refreshGroupInModel,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileDeleted",this.loadPersonalizedGroups,this);e.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.subscribe("launchpad","createGroupAt",this._createGroupAt,this);e.subscribe("launchpad","deleteGroup",this._deleteGroup,this);e.subscribe("launchpad","resetGroup",this._resetGroup,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.subscribe("launchpad","moveGroup",this._moveGroup,this);e.subscribe("launchpad","deleteTile",this._deleteTile,this);e.subscribe("launchpad","movetile",this._moveTile,this);e.subscribe("launchpad","sortableStart",this._sortableStart,this);e.subscribe("launchpad","sortableStop",this._sortableStop,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","convertTile",this._convertTile,this)},_changeMode:function(e){var t=this.getModel().getProperty("/groups");if(e){this.oPageOperationAdapter=M.getInstance();var i=this.oPageOperationAdapter.transformGroupModel(t);this.getModel().setProperty("/groups",i)}else{this.oPageOperationAdapter=m.getInstance();h.destroyFLPAggregationModels(t);this.getModel().setProperty("/groups",[]);this.loadPersonalizedGroups()}},_addFLPActionsToTile:function(e){var t=[];if(u.last("/core/shell/enablePersonalization")){var i=this.bLinkPersonalizationSupported&&this.oPageOperationAdapter.isLinkPersonalizationSupported(e);t.push(this._getMoveTileAction(e));if(i){t.push(this._getConvertTileAction(e))}}return t},getPersonalizableGroups:function(){var e=this.getModel().getProperty("/groups");return e.filter(function(e){return!e.isGroupLocked})},_getConvertTileAction:function(e){var i=t.getEventBus();var r=this.oPageOperationAdapter.getTileType(e);var s=r==="tile"?"ConvertToLink":"ConvertToTile";return{id:s,text:p.i18n.getText(s),press:function(e){var t={tile:e};if(o.system.desktop){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){t.callBack=e.callbackSetFocus.bind(e);i.publish("launchpad","convertTile",t)})})}else{i.publish("launchpad","convertTile",t)}}}},_getMoveTileAction:function(e){var t="moveTile_action";return{id:t,text:p.i18n.getText(t),press:function(t){this.tileType=this.oPageOperationAdapter.getTileType(e);var i=this.tileType==="tile";this.tileUuid=this.getModelTileById(this.oPageOperationAdapter.getTileId(e),i?"tiles":"links").uuid;var o=t.getParent().getProperty("groupId");var s=new r("groupId",P.NE,o);var n=function(e){var t=e.getParameter("value");var i=new r("title",P.Contains,t);var o=e.getSource().getBinding("items");o.filter([i,this.oGroupNotLockedFilter,s])}.bind(this);var a=i?this.moveTileDialog:this.moveLinkDialog;if(!a){a=this.createMoveActionDialog("move"+this.tileType+"Dialog");a.setModel(this.oModel);if(i){this.moveTileDialog=a}else{this.moveLinkDialog=a}}else{a.detachSearch(a._searchHandler)}a.getBinding("items").filter([this.oGroupNotLockedFilter,s]);a.attachSearch(n);a._searchHandler=n;a.open()}.bind(this)}},_handleTileAppearanceAnimation:function(e){if(!e){return}var t=["webkit",""];function i(i,o){for(var r=0;r<t.length;r++){o=o.toLowerCase();e.attachBrowserEvent(t[r]+o,function(t){if(t.originalEvent&&t.originalEvent.animationName==="sapUshellTileEntranceAnimation"){e.removeStyleClass("sapUshellTileEntrance")}},false)}}i(e,"AnimationEnd");e.addStyleClass("sapUshellTileEntrance")},destroy:function(){var e=t.getEventBus();e.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.unsubscribe("launchpad","createGroupAt",this._createGroupAt,this);e.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);e.unsubscribe("launchpad","resetGroup",this._resetGroup,this);e.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.unsubscribe("launchpad","moveGroup",this._moveGroup,this);e.unsubscribe("launchpad","deleteTile",this._deleteTile,this);e.unsubscribe("launchpad","movetile",this._moveTile,this);e.unsubscribe("launchpad","sortableStart",this._sortableStart,this);e.unsubscribe("launchpad","sortableStop",this._sortableStop,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);t.detachThemeChanged(d.handleTilesVisibility);A.forEach(function(e){e.off()});m.destroy();M.destroy();O=undefined;i.prototype.destroy.apply(this,arguments)},_sortableStart:function(){this.oSortableDeferred=new e.Deferred},_createBookmark:function(e,t,i){var o=i.group?i.group.object:"";delete i.group;function r(){sap.ushell.Container.getServiceAsync("Bookmark").then(function(e){e.addBookmark(i,o).always(this._checkRequestQueue.bind(this)).done(function(){c.showLocalizedMessage("tile_created_msg")}).fail(function(e){y.error("Failed to add bookmark",e,"sap.ushell.ui.footerbar.AddBookmarkButton");c.showLocalizedError("fail_to_add_tile_msg")})}.bind(this))}this._addRequest(r.bind(this))},_addBookmarkToModel:function(e,t,i){var o=i.tile;var r=i.group;if(!i||!o){this.bIsGroupsModelDirty=true;if(!this.bGroupsModelLoadingInProcess){this._handleBookmarkModelUpdate()}return}if(!r){var s=this.getModel().getProperty("/groups");for(var n=0;n<s.length;n++){if(s[n].isDefaultGroup===true){r=s[n].object;break}}}var a=this._getIndexOfGroupByObject(r);var l=this.oModel.getProperty("/groups/"+a);var u=this.oPageOperationAdapter.getPreparedTileModel(o,l.isGroupLocked);this.getTileView(u);l.tiles.push(u);l.visibilityModes=d.calcVisibilityModes(l,true);var p=l.tiles.length;this._updateModelWithTileView(a,p);this.oModel.setProperty("/groups/"+a,l)},_refreshGroupInModel:function(e,t,i){var o=this;this.oPageOperationAdapter.refreshGroup(i).then(function(e){if(!e){return}var t=o._getIndexOfGroupByObject(e.object);e.visibilityModes=d.calcVisibilityModes(e.object,true);o.oModel.setProperty("/groups/"+t,e);if(e.tiles){e.tiles.forEach(function(e){o.getTileView(e)})}})},_sortableStop:function(){this.oSortableDeferred.resolve()},_handleAfterSortable:function(e){return function(){var t=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){e.apply(null,t)})}.bind(this)},_createGroupAt:function(e,t,i){var o=parseInt(i.location,10);var r=this.oModel.getProperty("/groups");var s=this.oPageOperationAdapter.getPreparedGroupModel(null,false,o===r.length,i);var n=this.oModel;var a;s.index=o;r.splice(o,0,s);for(a=0;a<r.length-1;a++){r[a].isLastGroup=false}for(a=o+1;a<r.length;a++){r[a].index++}n.setProperty("/groups",r)},_getIndexOfGroupByObject:function(e){var t=this.oModel.getProperty("/groups");return this.oPageOperationAdapter.getIndexOfGroup(t,e)},getTileActions:function(e){return this.oPageOperationAdapter.getTileActions(e)},addTileToGroup:function(e,t){var i=e+"/tiles";var o=this.oModel.getProperty(e);var r=this.oModel.getProperty(i).length;var s=this.oModel.getProperty(e+"/isGroupLocked");var n=this.oModel.getProperty("/personalization");o.tiles[r]=this.oPageOperationAdapter.getPreparedTileModel(t,s);this.getTileView(o.tiles[r]);o.visibilityModes=d.calcVisibilityModes(o,n);this._updateModelWithTileView(o.index,r);this.oModel.setProperty(e,o)},addTilesToGroupByCatalogTileId:function(e,t){var i=e.getBindingContext();for(var o=0;o<t.length;o++){this.addTileToGroupByCatalogTileId(i.sPath,t[o])}},addTileToGroupByCatalogTileId:function(e,t){if(!u.last("/core/home/enableTransientMode")){return}var i=this.oPageOperationAdapter.getTileModelByCatalogTileId(t);if(!i){return}this.oDashboardLoadingManager.setTileResolved(i);var o=this.oModel.getProperty(e+"/tiles").length;var r=this.oModel.getProperty(e);r.tiles[o]=i;this.oModel.setProperty(e,r)},_getPathOfTile:function(e){var t=this.oModel.getProperty("/groups");for(var i=0;i<t.length;++i){var o=t[i];var r=o.tiles;var s=o.links;for(var n=0;n<r.length;++n){if(r[n].uuid===e){return"/groups/"+i+"/tiles/"+n}}for(var a=0;a<s.length;++a){if(s[a].uuid===e){return"/groups/"+i+"/links/"+a}}}return null},_moveInArray:function(e,t,i){if(i>=e.length){var o=i-e.length;while(o--+1){e.push(undefined)}}e.splice(i,0,e.splice(t,1)[0])},_updateGroupIndices:function(e){for(var t=0;t<e.length;t++){e[t].index=t}},_deleteGroup:function(e,i,o){var r=this.oModel;var s=o.groupId;var n=r.getProperty("/groups");var a=g.getIndexOfGroup(n,s);var l=n.length-1===a;var u=l?a-1:a;h.destroyFLPAggregationModel(r.getProperty("/groups/"+a));var d=n.splice(a,1)[0];if(l){r.setProperty("/groups/"+u+"/isLastGroup",l)}r.setProperty("/groups",n);this._updateGroupIndices(n);if(u>=0){window.setTimeout(function(){t.getEventBus().publish("launchpad","scrollToGroup",{groupId:r.getProperty("/groups")[u].groupId})},200)}function p(){this.oPageOperationAdapter.deleteGroup(d).then(function(){c.showLocalizedMessage("group_deleted_msg",[d.title]);this._checkRequestQueue()}.bind(this),function(){this._resetGroupsOnFailure("fail_to_delete_group_msg")}.bind(this))}this._addRequest(p.bind(this))},_resetGroup:function(e,i,o){var r=this;var s=o.groupId;var n=this.oModel;var a=n.getProperty("/groups");var u=g.getIndexOfGroup(a,s);var p=r.oModel.getProperty("/groups/indexOfDefaultGroup")===u;var h=n.getProperty("/groups/"+u);n.setProperty("/groups/"+u+"/sortable",false);function f(){r.oPageOperationAdapter.resetGroup(h,p).then(function(e){r._handleAfterSortable(function(e,i,o){var s=r.oModel.getProperty("/groups");var n=g.getIndexOfGroup(s,e);r._loadGroup(n,o||i);c.showLocalizedMessage("group_reset_msg",[i.title]);r.oModel.setProperty("/groups/"+n+"/sortable",true);var a=t.byId("dashboardGroups").getGroupControlByGroupId(e);var u=a.getBindingContext().getObject().links;if(u&&u.length&&!a.getIsGroupLocked()){r._changeGroupLinksScope(a.getBindingContext().getObject(),r.oModel.getProperty("/tileActionModeActive")?L.Actions:L.Display)}if(a){a.rerender();l.emit("updateGroups",Date.now());d.handleTilesVisibility()}})(s,h,e);r._checkRequestQueue()},function(){r._resetGroupsOnFailure("fail_to_reset_group_msg")})}this._addRequest(f)},_moveGroup:function(e,t,i){if(isNaN(i.fromIndex)){return}var o=i.fromIndex;var r=i.toIndex;var s=this.oModel;var n=s.getProperty("/groups");var a=s.getProperty("/tileActionModeActive");var l=this;if(!a){o=this._adjustFromGroupIndex(o,n)}var u=n[o];var d=u.groupId;if(!a){r=this._adjustToGroupIndex(r,n,d)}var p=n[r];this._moveInArray(n,o,r);this._updateGroupIndices(n);for(var h=0;h<n.length-1;h++){n[h].isLastGroup=false}n[n.length-1].isLastGroup=true;s.setProperty("/groups",n);function c(){n=s.getProperty("/groups");var e=s.getProperty(g.getModelPathOfGroup(n,d));if(!e.object){return}l.oPageOperationAdapter.getOriginalGroupIndex(p,n).then(function(t){var i={iFromIndex:o,iToIndex:r};return l.oPageOperationAdapter.moveGroup(e,t,i)}).then(l._checkRequestQueue.bind(l),function(){l._resetGroupsOnFailure("fail_to_move_group_msg")})}this._addRequest(c)},_adjustToGroupIndex:function(e,t,i){var o=0;var r=false;var s=0;for(s=0;s<t.length&&o<e;s++){if(t[s].isGroupVisible){if(t[s].groupId===i){r=true}else{o++}}}if(r){return s-1}return s},_adjustFromGroupIndex:function(e,t){var i=0;for(var o=0;o<t.length;o++){if(t[o].isGroupVisible){i++}if(i===e+1){return o}}return e},_changeGroupTitle:function(e,t,i){var o=this;var r=i.newTitle;var s=this.oModel.getProperty("/groups");var n=i.groupId;var a=g.getIndexOfGroup(s,n);var l=o.oModel.getProperty("/groups/indexOfDefaultGroup")===a;var u=this.oModel.getProperty("/groups/"+a);var d=u.title;this.oModel.setProperty("/groups/"+a+"/title",r);function p(){var e;if(u.isLastGroup){e=o.oPageOperationAdapter.addGroupAt(u,undefined,l)}else{var t=o.oModel.getProperty("/groups")[a+1];e=o.oPageOperationAdapter.getOriginalGroupIndex(t,s).then(function(e){return o.oPageOperationAdapter.addGroupAt(u,e,l)})}e.then(function(e){o._handleAfterSortable(function(e,t){var i=o.oModel.getProperty("/groups");var r=g.getIndexOfGroup(i,e);var s=i[r];Object.keys(t).forEach(function(e){if(e==="tiles"||e==="links"){return}s[e]=t[e]});o.oModel.refresh();o._checkRequestQueue()})(n,e)},function(){o._resetGroupsOnFailure("fail_to_create_group_msg")})}function h(){this.oPageOperationAdapter.renameGroup(u,r,d).then(function(){o._checkRequestQueue()},function(){o._resetGroupsOnFailure("fail_to_rename_group_msg")})}if(!u.object){this._checkRequestQueue();this._addRequest(p.bind(this))}else{this._addRequest(h.bind(this))}},addGroupToModel:function(e){var t=this.oPageOperationAdapter.getPreparedGroupModel(e,false,true,{isRendered:true});var i=this.oModel.getProperty("/groups");var o=i.length;if(o>0){i[o-1].isLastGroup=false}t.index=o;i.push(t);this.oModel.setProperty("/groups/",i);var r=new G(this.oModel,"/groups/"+o);return r},_deleteTile:function(e,i,r){var s=r.tileId;var n=this.oModel.getProperty("/groups");var a=r.items||"tiles";function l(e,t){this.oPageOperationAdapter.removeTile(e,t).then(this._checkRequestQueue.bind(this),this._resetGroupsOnFailure.bind(this,"fail_to_remove_tile_msg"))}function u(e,i,o){var r=t.byId("dashboardGroups");var s=r.getGroupControlByGroupId(i.groupId);var n;if(o==="tiles"){if(e+1===i[o].length){n=s.oPlusTile}}else{var a=s.getLinks();if(e+1===a.length){if(a.length===1){n=s.oPlusTile}else{n=a[e-1]}}else{n=a[e+1]}}if(n){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){e.moveScrollDashboard(n.$())})})}}for(var p=0;p<n.length;++p){var g=n[p];for(var c=0;c<g[a].length;++c){var f=g[a][c];if(f.uuid===s){if(o.system.desktop){u(c,g,a)}h.destroyTileModel(this.oModel.getProperty("/groups/"+p+"/"+a+"/"+c));var v=g[a].splice(c,1)[0];var b=this.oModel.getProperty("/personalization");g.visibilityModes=d.calcVisibilityModes(g,b);this.oModel.setProperty("/groups/"+p,g);this._addRequest(l.bind(this,g,v));d.handleTilesVisibility();return}}}},deleteTilesFromGroup:function(e,t){var i=this.oModel.getProperty("/groups");var o=g.getIndexOfGroup(i,e);var r=this.oModel.getProperty("/groups/"+o);var s=[];["tiles","links"].forEach(function(e){s=r[e].filter(function(e){if(t.indexOf(e.uuid)<0){return true}return false});r[e]=s});r.visibilityModes=d.calcVisibilityModes(r,true);this.oModel.setProperty("/groups/"+o,r)},_getGroupIndex:function(e){var t=this.oModel.getProperty("/groups");var i=this._getNewGroupInfo(t,e);if(i){return i.newGroupIndex}return undefined},_convertTile:function(e,t,i){var o=i.tile?i.tile:i;var r=i.srcGroupId?this._getGroupIndex(i.srcGroupId):undefined;var s=i.srcGroupId?this.oModel.getProperty("/groups/"+r):o.getParent().getBindingContext().getObject();var n=o.getBindingContext().sPath.split("/");var a=o.getBindingContext().getObject();var u=n[n.length-2];var h=a.uuid;var g=parseInt(n[n.length-1],10);var c=i.toIndex!==undefined?i.toIndex:undefined;var f=this.oModel.getProperty("/tileActionModeActive");var v=i.toGroupId?this._getGroupIndex(i.toGroupId):s.index;var b=i.toGroupId?this.oModel.getProperty("/groups/"+v):s;var m=this;var M=this._getIndexForConvert(u,g,c,s,b);var P={tileIndex:g,groupIndex:r,group:s};function T(){a.tileIsBeingMoved=true;var e=this.oPageOperationAdapter.moveTile(a,M,s,b,u==="links"?"tile":"link");e.then(function(e){m._handleAfterSortable(function(e,t){var o=m._getPathOfTile(e);var r=t.content;if(o){if(u==="tiles"){m._attachLinkPressHandlers(r);m._changeLinkScope(r,f?"Actions":"Display")}if(s===b){_.show(p.i18n.getText("PageRuntime.Message.VisualizationConverted"))}else{_.show(p.i18n.getText("PageRuntime.Message.VisualizationMovedAndConverted"))}var n={tileIndex:c,groupIndex:v,group:b};var h={tile:a,view:r,type:u,tileObj:t.object};a.tileIsBeingMoved=true;m.replaceTileViewAfterConvert(P,n,h);l.emit("updateGroups",Date.now());d.handleTilesVisibility();if(i.callBack){i.callBack(r)}}})(h,e);m._checkRequestQueue()},function(){m._handleAfterSortable(m._resetGroupsOnFailure.bind(m))("fail_to_move_tile_msg")})}this._addRequest(T.bind(this))},replaceTileViewAfterConvert:function(e,t,i){var o=i.tile;var r=o.content;o.tileIsBeingMoved=false;o.content=[i.view];o.object=i.tileObj;o.originalTileId=this.oPageOperationAdapter.getTileId(i.tileObj);e.group[i.type].splice(e.tileIndex,1);if(t.tileIndex!==undefined){t.group[i.type==="tiles"?"links":"tiles"].splice(t.tileIndex,0,o)}else{t.group[i.type==="tiles"?"links":"tiles"].push(o)}this.oModel.setProperty("/groups/"+t.groupIndex,t.group);this.oModel.setProperty("/groups/"+e.groupIndex,e.group);if(i.type==="links"){this._handleTileAppearanceAnimation(o.content[0].getParent())}else{this._handleTileAppearanceAnimation(o.content[0])}if(r&&r[0]){r[0].destroy()}},_getIndexForConvert:function(e,t,i,o,r){var s;if(e==="tiles"){if(i!==undefined){s=r[e].length+i}else{s=r[e].length+r.links.length}if(o.groupId===r.groupId){s--}}else{s=i||o.tiles.length;t+=o.tiles.length}return{tileIndex:t,newTileIndex:s}},_getIndexForMove:function(e,t,i,o,r){var s;if(e==="tiles"){s=i!==undefined?i:o[e].length}else{if(i!==undefined){s=o.tiles.length+i}else{s=o.tiles.length+o.links.length}t+=r.tiles.length}return{tileIndex:t,newTileIndex:s}},_getTileInfo:function(e,t,i){for(var o=0;o<e.length;++o){var r=e[o];for(var s=0;s<r[i].length;++s){var n=r[i][s];if(n.uuid===t){return{oTile:n,tileIndex:s,oGroup:r,groupIndex:o}}}}return},_getNewGroupInfo:function(e,t){for(var i=0;i<e.length;++i){var o=e[i];if(o.groupId===t){return{oNewGroup:o,newGroupIndex:i}}}return},_moveTile:function(e,t,i){var o=i.toIndex;var r=i.toGroupId;var s=i.sTileId;var n=i.source;var a=i.sTileType==="tiles"||i.sTileType==="tile"?"tile":"link";var u=i.sToItems;var h=i.sFromItems;var g=this.oModel.getProperty("/tileActionModeActive");var c=this.oModel.getProperty("/groups");var f=this._getTileInfo(c,s,h);var v=this._getNewGroupInfo(c,r);var b=this;var m=f.tileIndex===v.oNewGroup.tiles.length-1&&o>=v.oNewGroup.tiles.length;if((f.tileIndex===o||m)&&f.oGroup.groupId===v.oNewGroup.groupId){return}if(f.oGroup.groupId===v.oNewGroup.groupId&&(n==="movetileDialog"||o===null||n==="movelinkDialog")){if(i.callBack&&f.oTile&&f.oTile.content&&f.oTile.content.length){i.callBack(f.oTile.content[0])}return}if(a==="link"){f.oTile.content[0].addStyleClass("sapUshellZeroOpacity")}if(a==="tile"&&u==="tiles"){if(o&&o>v.oNewGroup[u].length){o=v.oNewGroup[u].length}}if(f.oGroup.groupId===r&&u===h){if(o===null||o===undefined){f.oGroup[u].splice(f.tileIndex,1);o=f.oGroup[u].length;f.oGroup[u].push(f.oTile)}else{o=this._adjustTileIndex(o,f.oTile,f.oGroup,u);this._moveInArray(f.oGroup[u],f.tileIndex,o)}this.oModel.setProperty("/groups/"+f.groupIndex+"/"+u,f.oGroup[u])}else{var M=this.oModel.getProperty("/personalization");f.oGroup[h].splice(f.tileIndex,1);f.oGroup.visibilityModes=d.calcVisibilityModes(f.oGroup,M);this.oModel.setProperty("/groups/"+f.groupIndex+"/"+h,f.oGroup[h]);if(o===null||o===undefined){o=v.oNewGroup[u].length;v.oNewGroup[u].push(f.oTile)}else{o=this._adjustTileIndex(o,f.oTile,v.oNewGroup,u);v.oNewGroup[u].splice(o,0,f.oTile)}v.oNewGroup.visibilityModes=d.calcVisibilityModes(v.oNewGroup,M);this.oModel.setProperty("/groups/"+v.newGroupIndex+"/"+u,v.oNewGroup[u])}l.emit("updateGroups",Date.now());d.handleTilesVisibility();function P(){var e=this.oModel.getProperty("/groups/"+f.groupIndex);var t=this.oModel.getProperty("/groups/"+v.newGroupIndex);var r=this._getIndexForMove(h,f.tileIndex,o,v.oNewGroup,e);f.oTile.tileIsBeingMoved=true;this.oPageOperationAdapter.moveTile(f.oTile,r,e,t,a).then(function(e){var t=b._getPathOfTile(s);if(t){b.oModel.setProperty(t+"/object",e.object);b.oModel.setProperty(t+"/originalTileId",e.originalTileId);var o=b.oModel.getProperty(t+"/content");var r=e.content;if(u==="links"){b._changeLinkScope(r,g?"Actions":"Display");b._attachLinkPressHandlers(r);b._handleTileAppearanceAnimation(r);f.oTile.content=[r];b.oModel.setProperty(t,I({},f.oTile));b.oModel.setProperty("/groups/"+v.newGroupIndex+"/"+u,b.oModel.getProperty("/groups/"+v.newGroupIndex+"/"+u))}else{b.oModel.setProperty(t+"/content",[r])}if(o&&o[0]){var n=r.onAfterRendering;r.onAfterRendering=function(){n.apply(this);o[0].destroy();r.onAfterRendering=n}}b.oModel.setProperty(t+"/tileIsBeingMoved",false);if(i.callBack){i.callBack(r)}_.show(p.i18n.getText("PageRuntime.Message.VisualizationMoved"))}b._checkRequestQueue()},function(){b._resetGroupsOnFailure("fail_to_move_tile_msg")})}this._addRequest(P.bind(this))},_adjustTileIndex:function(e,t,i,o){var r=0;var s=false;var n=0;for(n=0;n<i[o].length&&r<e;n++){if(i[o][n].isTileIntentSupported){if(i[o][n]===t){s=true}else{r++}}}if(s){return n-1}return n},getModel:function(){return this.oModel},getDashboardView:function(){return this.oDashboardView},setDashboardView:function(e){this.oDashboardView=e;return this},setTileVisible:function(e,t){this.oPageOperationAdapter.setTileVisible(e.object,t)},refreshTile:function(e){this.oPageOperationAdapter.refreshTile(e.object)},updateSettings:function(e){this.oModel=e.model||this.oModel;this.oConfig=e.config||this.oConfig;this.oRouter=e.router||this.oRouter;this.oDashboardView=e.view||this.oDashboardView},_resetGroupsOnFailure:function(e,t){this._requestFailed();c.showLocalizedError(e,t);this.bStartLoadRemainSegment=false;this.loadPersonalizedGroups();this.oModel.updateBindings(true)},resetGroupsOnFailure:function(){this._resetGroupsOnFailure.apply(this,arguments)},_bindSegment:function(e,t){for(var i=0;i<t.length;i++){var o=t[i];var r=o.index;var s=e[r];if(s){s.isRendered=true;s.tiles=s.tiles.concat(o.tiles);s.links=s.links.concat(o.links)}}return e},createGroupsModelFrame:function(e,t){var i=[];var o=function(e){var t=I({},e);t.tiles=[];t.pendingLinks=[];t.links=[];return t};for(var r=0;r<e.length;r++){var s=e[r];i[r]=o(s);i[r].isRendered=false;i[r].visibilityModes=d.calcVisibilityModes(s,t)}return i},_splitGroups:function(e,t){var i=[];var o=0;var r=this.oModel.getProperty("/homePageGroupDisplay")==="tabs";var s=this.oModel.getProperty("/personalization");var n=0;var a=500;for(var l=0;l<e.length;l++){var u=e[l];i.push(u);if(!this.segmentsStore.length){o+=this.PagingManager.getGroupHeight(u,t===l,s)}else{n+=u.tiles.length+u.links.length}if(r&&!this.segmentsStore.length&&o>0){i.loadTilesView=true;this.segmentsStore.push(i);i=[];o=0}if(o>=1||n>=a){this.segmentsStore.push(i);i=[];o=0;n=0}}if(i.length){this.segmentsStore.push(i)}},_processSegment:function(e){var t=this.segmentsStore.shift();if(!t){return e}if(this.isBlindLoading()===false){if(this.oModel.getProperty("/homePageGroupDisplay")!=="tabs"||t.loadTilesView){this.getSegmentContentViews(t)}}e=this._bindSegment(e,t);return e},getSegmentContentViews:function(e){var t;var i;for(var o=0;o<e.length;o++){var r=e[o];for(t=0;t<r.tiles.length;t++){i=r.tiles[t];if(i.isTileIntentSupported){this.getTileView(i)}}for(t=0;t<r.links.length;t++){i=r.links[t];if(i.isTileIntentSupported){this.getTileView(i,r.index)}}}this.bIsFirstSegmentViewLoaded=true},getSegmentTabContentViews:function(e,t,i){var o;var r;var s=i.iSelectedGroup;var n=this.oModel.getProperty("/groups/"+s);for(o=0;o<n.tiles.length;o++){r=n.tiles[o];if(r.isTileIntentSupported){this.getTileView(r)}}for(o=0;o<n.links.length;o++){r=n.links[o];if(r.isTileIntentSupported){this.getTileView(r,s)}}},_handleBookmarkModelUpdate:function(){this.bIsGroupsModelDirty=false;this.bGroupsModelLoadingInProcess=true;this.loadPersonalizedGroups()},_modelLoaded:function(){this.bGroupsModelLoadingInProcess=false;if(this.bIsGroupsModelDirty){this._handleBookmarkModelUpdate()}},handleFirstSegmentLoaded:function(){var e=this.oModel.getProperty("/groups");if(this.aGroupsFrame){Array.prototype.push.apply(e,this.aGroupsFrame);this.aGroupsFrame=null}this._initializeAnchorNavigationBar();if(!this.bStartLoadRemainSegment){this._processRemainingSegments()}},_initializeAnchorNavigationBar:function(){var e=O.getDashboardView();var t=e.getAnchorItemTemplate();this.oDashboardView.oAnchorNavigationBar.bindAggregation("groups",{path:"/groups",template:t})},_processRemainingSegments:function(){var e;if(this.segmentsStore.length>0){window.setTimeout(function(){e=this._processSegment(this.oModel.getProperty("/groups"));this.oModel.setProperty("/groups",e);this.bIsFirstSegment=false;this._processRemainingSegments()}.bind(this),0)}else{this.bIsGroupsModelLoading=false;this._updateModelWithTileView(0,0);d.handleTilesVisibility();t.getEventBus().publish("launchpad","dashboardModelContentLoaded");l.emit("updateGroups",Date.now())}},tabsModeVisibilityChanged:function(){if(this.bIsFirstSegmentViewLoaded===false&&this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){this.oDashboardLoadingManager.manageTilesView();this.bIsFirstSegmentViewLoaded=true;l.emit("firstSegmentCompleteLoaded",true)}},_setGroupModel:function(t){if(this.bIsGroupsModelLoading){y.info("Skip set the group model, because the group model is still loading");return}var i=0;var o;var r=0;var s=0;var a=0;var u=null;var p=[];this.bIsGroupsModelLoading=true;try{r=this.oModel.getProperty("/groups").length}catch(e){}for(i=t.length;i<r;++i){h.destroyFLPAggregationModel(this.oModel.getProperty("/groups/"+i))}if(!this.PagingManager){var g=e("#dashboardGroups").width();if(!g){g=window.innerWidth}var c=e("#sapUshellDashboardPage-cont").height();if(c<100){c=window.innerHeight}this.PagingManager=new n("dashboardPaging",{supportedElements:{tile:{className:"sapUshellTile"},link:{className:"sapUshellLinkTile"}},containerHeight:c,containerWidth:g})}t.forEach(function(e){if(e.isGroupVisible){s+=e.tiles.length}});this.bIsScrollModeAccordingKPI=s>this.iMinNumOfTilesForBlindLoading;this.aGroupsFrame=this.createGroupsModelFrame(t,this.oModel.getProperty("/personalization"));for(i=0;i<this.aGroupsFrame.length;i++){if(this.aGroupsFrame[i].isGroupVisible&&this.aGroupsFrame[i].visibilityModes[0]){if(u===null){u=i;this.aGroupsFrame[i].isGroupSelected=true;this.oModel.setProperty("/iSelectedGroup",i)}a++;if(a>1){this.aGroupsFrame[u].showGroupHeader=false;break}}}this._splitGroups(t,u);var f=this.segmentsStore[0]?this.segmentsStore[0].length:0;var v=this.aGroupsFrame.splice(0,f);k.start("FLP:DashboardManager._processSegment","_processSegment","FLP");p=this._processSegment(v);t.every(function(e,t){if(e.isDefaultGroup){o=t;return false}return true});p.indexOfDefaultGroup=o;if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){var b=this.getDashboardView();if(b){var m=b.oDashboardGroupsBox;var M=m.getBinding("groups");if(M){M.filter([b.oFilterSelectedGroup])}}}k.end("FLP:DashboardManager._processSegment");this.oModel.setProperty("/groups",p);this.aGroupModel=p;if(this.oDashboardView){l.once("firstSegmentCompleteLoaded").do(function(){d.setPerformanceMark("FLP-TTI-Homepage",{bUseUniqueMark:true})}).do(this.handleFirstSegmentLoaded.bind(this))}else{setTimeout(function(){Array.prototype.push.apply(this.aGroupModel,this.aGroupsFrame);this.aGroupsFrame=null;this.bStartLoadRemainSegment=true;this._processRemainingSegments()}.bind(this),0)}if(this.bIsFirstSegmentViewLoaded){l.emit("firstSegmentCompleteLoaded",true)}k.end("FLP:DashboardManager.loadGroupsFromArray")},getPreparedGroupModel:function(){return this.aGroupModel},_loadGroup:function(e,t){var i=this;var o="/groups/"+e;var r=i.oModel.getProperty(o);var s=r.isLastGroup;var n=r.groupId;h.destroyFLPAggregationModel(r);if(n){t.groupId=n}t.isLastGroup=s;t.index=e;t.isRendered=true;this.oModel.setProperty(o,t)},_hasPendingLinks:function(e){for(var t=0;t<e.length;t++){if(e[t].content[0]===undefined){return true}}return false},_addModelToTileViewUpdateQueue:function(e,t){this.tileViewUpdateQueue.push({uuid:e,view:t})},_updateModelWithTileView:function(e,t){var i=this;if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID)}this.tileViewUpdateTimeoutID=window.setTimeout(function(){i.tileViewUpdateTimeoutID=undefined;i.oSortableDeferred.done(function(){i._updateModelWithTilesViews(e,t)})},50)},_updateGroupModelWithTilesViews:function(e,t,i,o){var r=t||0;for(var s=r;s<e.length;s=s+1){var n=e[s];for(var a=0;a<this.tileViewUpdateQueue.length;a++){var l=this.tileViewUpdateQueue[a];if(n.uuid===l.uuid){i.push(a);if(l.view){if(o){n.content=[l.view]}else{n.content[0].destroy();n.content=[l.view]}this.oDashboardLoadingManager.setTileResolved(n);var u=this.oPageOperationAdapter.getTileSize(n.object);var d=u!==null&&u==="1x2"||false;if(n.long!==d){n.long=d}}else{n.content[0].setState("Failed")}break}}}},_updateModelWithTilesViews:function(e,t){var i=this.oModel.getProperty("/groups");var o=e||0;var r=[];if(!i||this.tileViewUpdateQueue.length===0){return}for(var s=o;s<i.length;s=s+1){this._updateGroupModelWithTilesViews(i[s].tiles,t,r);if(i[s].links){this._updateGroupModelWithTilesViews(i[s].links,t,r,true);if(i[s].pendingLinks.length>0){if(!i[s].links){i[s].links=[]}i[s].links=i[s].links.concat(i[s].pendingLinks);i[s].pendingLinks=[]}}}var n=[];var a;for(a=0;a<this.tileViewUpdateQueue.length;a++){if(r.indexOf(a)===-1){n.push(this.tileViewUpdateQueue[a])}}this.tileViewUpdateQueue=n;this.oModel.setProperty("/groups",i)},getModelTileById:function(e,t){var i=this.oModel.getProperty("/groups");var o;var r=false;i.every(function(i){i[t].every(function(t){if(t.uuid===e||t.originalTileId===e){o=t;r=true}return!r});return!r});return o},_attachLinkPressHandlers:function(e){var i=t.getEventBus();var o=e.attachPress?e:e.getContent()[0];o.attachPress(function(t){var o=e.getBindingContext().getObject().tileIsBeingMoved;if(!o&&this.getScope&&this.getScope()==="Actions"){switch(t.getParameters().action){case"Press":var r=e.getState?e.getState():"";if(r!=="Failed"){var s=sap.ui.require("sap/ushell/components/homepage/ActionMode");if(s){s._openActionsMenu(t)}else{y.error("Race condition occurred! - sap/ushell/components/homepage/ActionMode was not required in time.")}}break;case"Remove":var n=e.getBindingContext().getObject().uuid;i.publish("launchpad","deleteTile",{tileId:n,items:"links"});break;default:break}}else{i.publish("launchpad","dashboardTileLinkClick")}})},handleDisplayModeChange:function(e){this.oModel.setProperty("/homePageGroupDisplay",e);switch(e){case"scroll":this._handleDisplayModeChangeToScroll();break;case"tabs":this._handleDisplayModeChangeToTabs();break}},_handleDisplayModeChangeToTabs:function(){var e=this.oModel.getProperty("/iSelectedGroup");var t=this.oModel.getProperty("/groups");this.oDashboardLoadingManager.manageTilesView();if(t.length>0){for(var i=0;i<t.length;i++){this.oModel.setProperty("/groups/"+i+"/isGroupSelected",false)}this.oModel.setProperty("/groups/"+e+"/isGroupSelected",true)}},_handleDisplayModeChangeToScroll:function(){if(this.isBlindLoading()){return}var e=this.oModel.getProperty("/groups");var i=[];var o;for(var r=0;r<e.length;r++){var s=e[r];var n=s.tiles||[];for(o=0;o<n.length;o++){var a=n[o];if(a.content.length===0){this.getTileView(a,r)}}i=s.links||[];for(o=0;o<i.length;o++){this.getTileView(i[o],r)}}this.oModel.refresh(false);var l=this.oModel.getProperty("/iSelectedGroup");if(l){setTimeout(function(){t.getEventBus().publish("launchpad","scrollToGroup",{groupId:e[l].groupId})},100)}},getTileViewsFromArray:function(e){var t=this;if(e.length===0){return}e.forEach(function(e){t.getTileView(e.oTile,e.iGroup)});this.oModel.refresh(false);if(this.bIsFirstSegmentViewLoaded===false){this.bIsFirstSegmentViewLoaded=true;l.emit("firstSegmentCompleteLoaded",true)}},getTileView:function(e,t){var i=this.oPageOperationAdapter.getTileType(e.object);if(this.oDashboardLoadingManager.isTileViewRequestIssued(e)){return}this.oDashboardLoadingManager.setTileInProgress(e);this.oPageOperationAdapter.setTileVisible(e.object,false);if(i==="card"){this._loadCardData(e)}else{this._loadTileData(e,t,i)}},_loadCardData:function(e){var i=t.byId(e.controlId);if(i&&i.setManifest&&this.isBlindLoading()){i.setManifest(e.manifest)}e.content=[e.manifest];this.oDashboardLoadingManager.setTileResolved(e)},getCurrentHiddenGroupIds:function(e){return this.oPageOperationAdapter.getCurrentHiddenGroupIds(e)},_loadTileData:function(e,t,i){var o=this;var r=this.oPageOperationAdapter.getTileView(e);var n;var a=this._addModelToTileViewUpdateQueue;var l;var u=false;var d=e.uuid;var p=false;if(r.state()==="resolved"){p=true}r.done(function(i){if(i.oController&&i.oController.navigationTargetUrl&&!e.isCustomTile){e.target=i.oController.navigationTargetUrl}l=i;if(l.getComponentInstance){k.average("FLP:getComponentInstance","get info for navMode","FLP1");var r=l.getComponentInstance().getComponentData();if(r&&r.properties){e.navigationMode=r.properties.navigationMode}k.end("FLP:getComponentInstance")}o.oDashboardLoadingManager.setTileResolved(e);var s=i.getMode?i.getMode():"ContentMode";if(o.bLinkPersonalizationSupported&&s==="LineMode"){o._attachLinkPressHandlers(l);if(t>=0){var h=o.oModel.getProperty("/groups");if(h[t]){e.content=[l];n=o.oModel.getProperty("/groups/"+t+"/links");o.oModel.setProperty("/groups/"+t+"/links",[]);o.oModel.setProperty("/groups/"+t+"/links",n)}}}else if(o.isBlindLoading()){if(e.content&&e.content.length>0){e.content[0].destroy()}e.content=[l];if(t>=0&&!p){o.oModel.refresh(false)}}if(o.isBlindLoading()){var g=o.oPageOperationAdapter.getTileSize(e.object);var c=g==="1x2";if(e.long!==c){e.long=c}}else if(s==="LineMode"){e.content=[l];if(u){n=o.oModel.getProperty("/groups/"+t+"/links");o.oModel.setProperty("/groups/"+t+"/links",[]);o.oModel.setProperty("/groups/"+t+"/links",n)}}else if(e.content.length===0){e.content=[l]}else{a.apply(o,[d,l]);o._updateModelWithTileView(0,0)}});r.fail(function(){if(o.oPageOperationAdapter.getTileType(e.object)==="link"&&o.bLinkPersonalizationSupported){l=o.oPageOperationAdapter.getFailedLinkView(e);o._attachLinkPressHandlers(l)}else{l=new s({state:"Failed"})}e.content=[l]});if(!l){if(o.oPageOperationAdapter.getTileType(e.object)==="link"){u=true;l=new f({mode:"LineMode"})}else{l=new s}e.content=[l]}},loadLibraryForCardModuleIfNeeded:function(){if(w.last("/core/home/featuredGroup/enable")){return t.loadLibrary("sap.ui.integration",{async:true})}return Promise.resolve()},loadPersonalizedGroups:function(){var t=this;var i=new e.Deferred;if(this.bIsGroupsRequestPending){y.info("loadPersonalizedGroups was skipped because there is already a pending request.");i.reject();return i.promise()}this.bIsGroupsRequestPending=true;this.oServiceLoadingPromise.then(t.loadLibraryForCardModuleIfNeeded).then(function(){return t.oPageOperationAdapter.getPage()}).then(function(e){t._setGroupModel(e);t.bIsGroupsRequestPending=false;i.resolve()}).catch(function(e){y.error("Loading of personalized groups failed.",e,"sap.ushell.components.HomepageManager");c.showLocalizedError("fail_to_load_groups_msg");t.bIsGroupsRequestPending=false});k.start("FLP:DashboardManager.loadPersonalizedGroups","loadPersonalizedGroups","FLP");return i.promise()}});x.prototype.getInstance=function(){return O};return x});