// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ushell/Config","sap/ushell/resources","sap/ushell/components/MessagingHelper","sap/m/GenericTile","sap/base/util/uid","sap/base/Log","sap/ui/performance/Measurement","sap/m/library","sap/base/util/deepEqual"],function(e,r,i,t,o,n,u,a,l,s){"use strict";var d=l.GenericTileMode;var g=l.LoadState;var c={PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"};function p(e,r){sap.ushell.Container.getServiceAsync("UsageAnalytics").then(function(i){i.logCustomEvent(c.PERSONALIZATION,e,r)})}var f=e.extend("sap.ushell.components._HomepageManager.PersistentPageOperationAdapter",{constructor:function(r){e.call(this);this.oPageBuilderService=r},_getIsAppBox:function(e){var r=this.oPageBuilderService,i=!!(r.getCatalogTileTargetURL(e)&&(r.getCatalogTilePreviewTitle(e)||r.getCatalogTilePreviewSubtitle(e)));return i},getCurrentHiddenGroupIds:function(e){var r=e.getProperty("/groups"),i=[],t,o,n;for(o=0;o<r.length;o++){n=r[o]?r[o].isGroupVisible:true;if(r[o].object){t=this.oPageBuilderService.getGroupId(r[o].object)}if(!n&&t!==undefined){i.push(t)}}return i},getPreparedTileModel:function(e,i,t){var u=this.oPageBuilderService,a=n(),l,s=u.getTileSize(e),g=[],c;t=t||u.getTileType(e);if(t==="link"){g=[new o({mode:d.LineMode})]}l={isCustomTile:!this._getIsAppBox(e),object:e,originalTileId:u.getTileId(e),uuid:a,tileCatalogId:encodeURIComponent(u.getCatalogTileId(e)),tileCatalogIdStable:u.getStableCatalogTileId(e),content:g,long:s==="1x2",target:u.getTileTarget(e)||"",debugInfo:u.getTileDebugInfo(e),isTileIntentSupported:u.isTileIntentSupported(e),rgba:"",isLocked:i,showActionsIcon:r.last("/core/home/enableTileActionsIcon"),isLinkPersonalizationSupported:u.isLinkPersonalizationSupported(e),navigationMode:undefined};if(t==="card"){c=u.getCardManifest(e);l.isCard=true;if(c){l.manifest=c}}return l},getPreparedGroupModel:function(e,i,o,a){var l=this.oPageBuilderService,s=e&&l.getGroupTiles(e)||[],d=[],g=[],c,p=r.last("/core/shell/model/personalization"),f=r.last("/core/extension/enableHelp");var P=!!(e&&l.isGroupLocked(e)),v=!!(e&&l.isGroupFeatured(e));for(c=0;c<s.length;++c){var h=s[c],T=l.getTileType(h).toLowerCase();if(T==="tile"||T==="card"){d.push(this.getPreparedTileModel(s[c],P,T))}else if(T==="link"){g.push(this.getPreparedTileModel(s[c],P,T))}else{u.error("Unknown tile type: '"+T+"'",undefined,"sap.ushell.components.HomepageManager")}}return{title:i&&t.getLocalizedText("my_group")||e&&l.getGroupTitle(e)||a&&a.title||"",object:e,groupId:n(),helpId:f&&e?l.getGroupId(e):null,links:g,pendingLinks:[],tiles:d,isDefaultGroup:!!i,editMode:!e,isGroupLocked:P,isFeatured:v,visibilityModes:[true,true],removable:!e||l.isGroupRemovable(e),sortable:p,isGroupVisible:!e||l.isGroupVisible(e),isEnabled:!i,isLastGroup:o||false,isRendered:!!(a&&a.isRendered),isGroupSelected:false}},getPage:function(){a.start("FLP:DashboardManager.loadPersonalizedGroups","loadPersonalizedGroups","FLP");return this._getGroupsFromServer().then(this.loadGroupsFromArray.bind(this))},_getGroupsFromServer:function(){var e=this;return new Promise(function(r,i){e.oPageBuilderService.getGroups().done(function(e){a.end("FLP:DashboardManager.loadPersonalizedGroups");r(e)}).fail(i)})},loadGroupsFromArray:function(e){var r=this;a.start("FLP:DashboardManager.loadGroupsFromArray","loadGroupsFromArray","FLP");a.start("FLP:DashboardManager.getDefaultGroup","getDefaultGroup","FLP");return new Promise(function(i,t){r.oPageBuilderService.getDefaultGroup().done(function(t){a.end("FLP:DashboardManager.getDefaultGroup");if(e.length===0&&t===undefined){i([]);return}var o=0,n,u=[],l,d;e=r._sortGroups(t,e);d=e.findIndex(function(e){return s(e,t)});l=e.length;a.start("FLP:DashboardManager._getGroupModel","_getGroupModel","FLP");for(o=0;o<l;++o){n=r.getPreparedGroupModel(e[o],o===d,o===l-1);n.index=o;u.push(n)}a.end("FLP:DashboardManager._getGroupModel");a.end("FLP:DashboardManager.loadGroupsFromArray");i(u)}).fail(t)})},_sortGroups:function(e,i){var t=0,o=this,n=i.findIndex(function(r){return s(r,e)}),u=[],a,l,d;if(n>-1){i.splice(n,1)}while(t<i.length){l=i[t];d=this.oPageBuilderService.isGroupLocked(l);if(d){u.push(l);i.splice(t,1)}else{t++}}if(!r.last("/core/home/disableSortedLockedGroups")){u.sort(function(e,r){var i=o.oPageBuilderService.getGroupTitle(e).toLowerCase(),t=o.oPageBuilderService.getGroupTitle(r).toLowerCase();return i<t?-1:1})}u.sort(function(e,r){var i=o.oPageBuilderService.isGroupFeatured(e),t=o.oPageBuilderService.isGroupFeatured(r);if(i===t){return 0}else if(i>t){return-1}return 1});a=u;a.push(e);a.push.apply(a,i);return a},addGroupAt:function(e,r,i){var t=this;return new Promise(function(o,n){try{if(r===undefined){t.oPageBuilderService.addGroup(e.title).done(function(r){var n=t.oPageBuilderService.getGroupId(r);p(c.RENAME_GROUP,[null,e.title,n]);o(t.getPreparedGroupModel(r,i,e.isLastGroup,undefined))}).fail(n)}else{t.oPageBuilderService.addGroupAt(e.title,r).done(function(r){var n=t.oPageBuilderService.getGroupId(r);p(c.RENAME_GROUP,[null,e.title,n]);o(t.getPreparedGroupModel(r,i,e.isLastGroup,undefined))}).fail(n)}}catch(e){n()}})},renameGroup:function(e,r,i){var t=this;return new Promise(function(o,n){try{t.oPageBuilderService.setGroupTitle(e.object,r).done(function(){var n=t.oPageBuilderService.getGroupId(e.object);p(c.RENAME_GROUP,[i,r,n]);o()}).fail(n)}catch(e){n()}})},deleteGroup:function(e){var r=this,i=e.object,t=this.oPageBuilderService.getGroupId(i),o=this.oPageBuilderService.getGroupTitle(i);return new Promise(function(e,n){try{r.oPageBuilderService.removeGroup(i).done(function(){p(c.DELETE_GROUP,[o,t]);e()}).fail(n)}catch(e){n()}})},moveGroup:function(e,r,i){var t=this;return new Promise(function(o,n){try{t.oPageBuilderService.moveGroup(e.object,r).done(function(){var r=t.oPageBuilderService.getGroupId(e.object);p(c.MOVE_GROUP,[e.title,i.iFromIndex,i.iToIndex,r]);o()}).fail(n)}catch(e){n()}})},resetGroup:function(e,r){var i=this,t=e.object,o=this.oPageBuilderService.getGroupId(t),n=this.oPageBuilderService.getGroupTitle(t);return new Promise(function(u,a){try{i.oPageBuilderService.resetGroup(t).done(function(a){p(c.RESET_GROUP,[n,o]);u(i.getPreparedGroupModel(a||t,r,e.isLastGroup,undefined))}).fail(a)}catch(e){a()}})},refreshGroup:function(e){var r=this,i="Failed to refresh group with id:"+e+" in the model";return new Promise(function(t){r.oPageBuilderService.getGroups().fail(function(){u.error(i,null,"sap.ushell.components.HomepageManager");t(null)}).done(function(i){var o=null;for(var n=0;n<i.length;n++){if(r.oPageBuilderService.getGroupId(i[n])===e){o=i[n];break}}if(o){r.oPageBuilderService.getDefaultGroup().done(function(i){var n=e===i.getId(),u=r.getPreparedGroupModel(o,n,false,{isRendered:true});t(u)})}else{t(null)}})})},getIndexOfGroup:function(e,r){var i=-1,t=this,o=this.oPageBuilderService.getGroupId(r);e.every(function(e,r){var n=t.oPageBuilderService.getGroupId(e.object);if(n===o){i=r;return false}return true});return i},getOriginalGroupIndex:function(e){var r=this.oPageBuilderService,i=e.object,t=this.oPageBuilderService.getGroups();return new Promise(function(e,o){t.done(function(t){var o;for(var n=0;n<t.length;n++){if(r.getGroupId(t[n])===r.getGroupId(i)){o=n;break}}e(o)}).fail(o)})},moveTile:function(e,r,i,t,o){var n=this,u,a=new Promise(function(a,l){try{var s=n.oPageBuilderService.moveTile(e.object,r.tileIndex,r.newTileIndex,i.object,t.object,o);s.done(function(r){var o=[n.oPageBuilderService.getTileTitle(e.object),n.oPageBuilderService.getGroupTitle(i.object),n.oPageBuilderService.getGroupTitle(t.object),e.uuid];p(c.MOVE_TILE,o);u=r;a(r)});s.fail(l)}catch(e){l()}});return a.then(this._getTileViewAsPromise.bind(this)).then(function(e){return Promise.resolve({content:e,originalTileId:n.oPageBuilderService.getTileId(u),object:u})})},removeTile:function(e,r){var i=this,o=r.object,n=i.oPageBuilderService.getTileTitle(o),u=i.oPageBuilderService.getCatalogTileId(o),a=i.oPageBuilderService.getCatalogTileTitle(o),l=i.oPageBuilderService.getTileId(o),s;s=new Promise(function(r,s){try{i.oPageBuilderService.removeTile(e.object,o).done(function(){t.showLocalizedMessage("tile_deleted_msg",[n,e.title]);p(c.DELETE_TILE,[n||l,u,a,e.title]);r()}).fail(s)}catch(e){s()}});return s},_getTileViewAsPromise:function(e){var r=this,i=new Promise(function(i,t){var o=r.oPageBuilderService.getTileView(e);o.done(i);o.fail(t)});return i},refreshTile:function(e){this.oPageBuilderService.refreshTile(e)},setTileVisible:function(e,r){this.oPageBuilderService.setTileVisible(e,r)},getTileType:function(e){return this.oPageBuilderService.getTileType(e)},getTileSize:function(e){return this.oPageBuilderService.getTileSize(e)},getTileTitle:function(e){return this.oPageBuilderService.getTileTitle(e.object)},getTileId:function(e){return this.oPageBuilderService.getTileId(e)},isLinkPersonalizationSupported:function(e){return this.oPageBuilderService.isLinkPersonalizationSupported(e)},getTileTarget:function(e){return this.oPageBuilderService.getTileTarget(e.object)},getTileView:function(e){return this.oPageBuilderService.getTileView(e.object)},getTileActions:function(e){return this.oPageBuilderService.getTileActions(e)},getFailedLinkView:function(e){var r=this.oPageBuilderService.getCatalogTilePreviewSubtitle(e.object);var t=this.oPageBuilderService.getCatalogTilePreviewTitle(e.object);if(!t&&!r){t=i.i18n.getText("cannotLoadLinkInformation")}return new o({mode:d.LineMode,state:g.Failed,header:t,subheader:r})},getTileModelByCatalogTileId:function(e){u.error("Cannot get tile with id "+e+": Method is not supported")},transformGroupModel:function(){return}});var P=null;return{getInstance:function(e){if(!P){P=new f(e)}return P},destroy:function(){P=null}}});