// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/StandardListItem","sap/ushell/Config","sap/ushell/resources","sap/ushell/ui/footerbar/AboutButton","sap/ushell/ui/footerbar/ContactSupportButton","sap/ushell/ui/launchpad/ActionItem","sap/ushell/ui/QuickAccess","sap/ushell/EventHub","sap/m/library","sap/base/Log","sap/ui/performance/Measurement","sap/ui/core/ElementMetadata","sap/ui/core/Fragment"],function(e,t,n,o,i,s,r,a,l,u,c,d,g,p,h){"use strict";var f=c.ListType;var v=c.ButtonType;function A(e){if(!sap.ui.getCore().byId(e)){d.debug("Could not render ActionItem because it was not created: "+e);return false}return true}return e.extend("sap.ushell.components.shell.UserActionsMenu.UserActionsMenu",{_aDanglingControl:[],_aDoables:[],onInit:function(){var e=this.getShellConfig();this._createActionButtons(e);var n=sap.ushell.Container.getUser();var i=o.last("/core/shell/model/currentState/actions").filter(A);this.oModel=new t({actions:i,userName:n.getFullName()||n.getId()});this._aDoables.push(o.on("/core/shell/model/currentState/actions").do(function(e){var t=e.filter(A);this.getModel().setProperty("/actions",t)}.bind(this)));this._aDoables.push(u.on("showUserActionsMenu").do(function(e){var t=sap.ui.getCore().byId("sapUshellUserActionsMenuPopover");if(t&&t.isOpen()||!e){this._toggleUserActionsMenuPopover(false)}else{this._toggleUserActionsMenuPopover(true)}}.bind(this)))},onExit:function(){this._destroyDanglingControls();this._aDoables.forEach(function(e){e.off()});this._aDanglingControl=[];this._aDoables=[];var e=sap.ui.getCore().byId("sapUshellUserActionsMenuPopover");if(e){e.destroy()}},getModel:function(){return this.oModel},_createActionButtons:function(e){var t=o.last("/core/extension/enableHelp");var n=o.last("/core/shell/enableAbout");if(n){this._createAboutButton(t)}if(!e.moveAppFinderActionToShellHeader&&o.last("/core/catalog/enabled")){this._createAppFinderButton(e,t)}if(!e.moveUserSettingsActionToShellHeader){this._createSettingsButton(t)}if(!e.moveContactSupportActionToShellHeader){this._createSupportTicketButton(t)}if(e.enableRecentActivity&&o.last("/core/shell/model/currentState/showRecentActivity")){this._createRecentActivitiesButton();this._createFrequentActivitiesButton()}if(!e.disableSignOut){this._createLogoutButton()}},_createAppFinderButton:function(e,t){if(sap.ui.getCore().byId("openCatalogBtn")){return}var n=new a("openCatalogBtn",{text:i.i18n.getText("open_appFinderBtn"),icon:"sap-icon://sys-find",visible:!e.disableAppFinder,actionType:"action",press:function(){g.start("FLP:AppFinderLoadingStartToEnd","AppFinderLoadingStartToEnd","FLP");sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){e.toExternal({target:{semanticObject:"Shell",action:"appfinder"}})})}});if(t){n.addStyleClass("help-id-openCatalogActionItem")}this._addDanglingControl(n)},_createAboutButton:function(e){var t="aboutBtn";if(!sap.ui.getCore().byId(t)){var n=new s(t);if(e){n.addStyleClass("help-id-"+t)}this._addDanglingControl(n);this.getRenderer().showActionButton(t,false)}},_createSettingsButton:function(e){var t="userSettingsBtn";if(!sap.ui.getCore().byId(t)){var n=new a(t,{tooltip:i.i18n.getText("ControlKey")+" + "+i.i18n.getText("CommaKey"),text:i.i18n.getText("userSettings"),icon:"sap-icon://action-settings",press:function(){u.emit("openUserSettings",Date.now())}});if(e){n.addStyleClass("help-id-loginDetails")}this._addDanglingControl(n)}},_createSupportTicketButton:function(e){o.on("/core/extension/SupportTicket").do(function(t){var n="ContactSupportBtn";var o=sap.ui.getCore().byId(n);if(t&&!o){o=new r(n);this._addDanglingControl(o);if(e){o.addStyleClass("help-id-contactSupportBtn")}}if(t){this.getRenderer().showActionButton(n)}else{this.getRenderer().hideActionButton(n)}}.bind(this))},_createRecentActivitiesButton:function(){var e="recentActivitiesBtn";o.on("/core/shell/model/enableTrackingActivity").do(function(t){if(t){var n=sap.ui.getCore().byId(e);if(!n){n=new a(e,{text:i.i18n.getText("recentActivities"),icon:"sap-icon://customer-history",press:function(){l.openQuickAccessDialog("recentActivityFilter","userActionsMenuHeaderButton")}});this._addDanglingControl(n)}this.getRenderer().showActionButton(e,false)}else{this.getRenderer().hideActionButton(e,false)}}.bind(this))},_createFrequentActivitiesButton:function(){var e="frequentActivitiesBtn";o.on("/core/shell/model/enableTrackingActivity").do(function(t){if(t){var n=sap.ui.getCore().byId(e);if(!n){n=new a(e,{text:i.i18n.getText("frequentActivities"),icon:"sap-icon://activity-individual",tooltip:i.i18n.getText("frequentActivitiesTooltip"),press:function(){l.openQuickAccessDialog("frequentlyUsedFilter","userActionsMenuHeaderButton")}});this._addDanglingControl(n)}this.getRenderer().showActionButton(e,false)}else{this.getRenderer().hideActionButton(e,false)}}.bind(this))},_createLogoutButton:function(){var e="logoutBtn";if(sap.ui.getCore().byId(e)){return}var t=new a(e,{visible:true,type:v.Transparent,icon:"sap-icon://log",text:i.i18n.getText("signoutBtn_title"),press:this.logout});this._addDanglingControl(t);this.getRenderer().showActionButton(e,false)},logout:function(){sap.ui.require(["sap/m/MessageBox","sap/ushell/ui/launchpad/LoadingDialog"],function(e,t){var n=new t({text:""}),o=true,s=false,r={};sap.ushell.Container.getGlobalDirty().done(function(a){o=false;if(s===true){n.exit();n=new t({text:""})}var l=function(){var t=i.i18n;if(a===sap.ushell.Container.DirtyState.DIRTY){r.message=t.getText("unsaved_data_warning_popup_message");r.icon=e.Icon.WARNING;r.messageTitle=t.getText("unsaved_data_warning_popup_title")}else{r.message=t.getText("signoutConfirmationMsg");r.icon=e.Icon.QUESTION;r.messageTitle=t.getText("signoutMsgTitle")}return r};r=l(a);e.show(r.message,r.icon,r.messageTitle,[e.Action.OK,e.Action.CANCEL],function(t){if(t===e.Action.OK){n.openLoadingScreen();n.showAppInfo(i.i18n.getText("beforeLogoutMsg"),null);sap.ushell.Container.logout()}},p.uid("confirm"))});if(o===true){n.openLoadingScreen();s=true}})},_addDanglingControl:function(e){this._aDanglingControl.push(e)},_destroyDanglingControls:function(){if(this._aDanglingControl){this._aDanglingControl.forEach(function(e){if(e.destroyContent){e.destroyContent()}e.destroy()})}},_toggleUserActionsMenuPopover:function(e){if(!this.oPopover){h.load({name:"sap.ushell.components.shell.UserActionsMenu.UserActionsMenuPopover",type:"XML",controller:this}).then(function(t){this.oPopover=t;this.oPopover.setModel(this.getModel());this._toggleUserActionsMenuPopover(e)}.bind(this))}else if(e){this.oPopover.getModel().refresh(true);this.oPopover.openBy(sap.ui.getCore().byId("userActionsMenuHeaderButton"))}else{this.oPopover.close();if(window.document.activeElement&&window.document.activeElement.id!=="userActionsMenuHeaderButton"){window.document.getElementById("userActionsMenuHeaderButton").focus()}}},userActionsMenuPopoverItemFactory:function(e,t){var o=sap.ui.getCore().byId(t.getObject());return new n({id:e+"-"+o.getId(),icon:o.getIcon(),tooltip:o.getTooltip(),iconInset:true,title:o.getText(),visible:o.getVisible(),type:f.Active,customData:[{key:"actionItemId",value:o.getId()}],press:function(){if(o){o.firePress();u.emit("showUserActionsMenu",false)}}}).addStyleClass("sapUshellUserActionsMenuActionItem")},getRenderer:function(){if(!this._oRenderer){this._oRenderer=sap.ushell.Container.getRenderer("fiori2")}return this._oRenderer},getShellConfig:function(){return this.getRenderer().getShellConfig()}})});