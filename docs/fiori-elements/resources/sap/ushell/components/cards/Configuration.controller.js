// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/cards/ManifestPropertyHelper","sap/ushell/resources","sap/ui/core/mvc/Controller","sap/base/strings/formatMessage","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/core/Core","sap/ui/core/Configuration"],function(e,t,a,i,r,n,o,s,g){"use strict";return a.extend("sap.ushell.components.cards.Configuration",{formatter:i,onInit:function(){var e=this.getView(),a=e.getViewData(),i=a.chipInstance,n,o=i.configuration.getParameterValueAsString("cardManifest"),s;if(o){s=this._prepareManifest(o,i)}n=new r({data:{editorValue:JSON.stringify(s,null,4)||""},config:{originalLanguage:"",sapLogonLanguage:"",displayOriginalLanguageWarning:false,manifestEditorEditable:true}});e.setModel(n);e.setModel(t.i18nModel,"i18n");e.setViewName("sap.ushell.components.cards.Configuration");i.configurationUi.attachSave(this.onSaveConfiguration.bind(this));this._checkOriginalLanguage()},onSaveConfiguration:function(){var a=new n.Deferred,i=this.getView().getModel(),r=i.getProperty("/data/editorValue"),o,s;try{o=JSON.parse(r)}catch(e){this._logErrorAndReject({error:t.i18n.getText("configuration.invalidJSONProvided")},a);return a}s=e.extractCardData(o);this._saveManifestAndTileConfig(s.manifest,s.tileConfiguration).then(this._saveTilePropertiesBag.bind(this,s)).then(this._saveTitle.bind(this,s.bagProperties.display_title_text)).then(this._updateTileModel.bind(this,s)).then(a.resolve).catch(function(e){this._logErrorAndReject(e,a)}.bind(this));return a.promise()},_saveManifestAndTileConfig:function(e,t){var a=this.getView().getViewData().chipInstance;var i=new Promise(function(i,r){a.writeConfiguration.setParameterValues({cardManifest:JSON.stringify(e),tileConfiguration:t},i,function(e,t){r({error:e,errorInfo:t})})});return i},_saveTilePropertiesBag:function(e){var t=this.getView().getViewData().chipInstance;var a=t.bag.getBag("tileProperties");this._fillCardBag(e,a);var i=new Promise(function(e,t){a.save(e,function(e,a){t({error:e,errorInfo:a})})});return i},_saveTitle:function(e){var t=this.getView().getViewData().chipInstance;var a=new Promise(function(a,i){if(t.title){t.title.setTitle(e,a,function(e,t){i({error:e,errorInfo:t})})}else{a()}});return a},_updateTileModel:function(e){var t=this.getView().getModel("tileModel");t.setProperty("/data/display_title_text",e.bagProperties.display_title_text);t.setProperty("/data/display_subtitle_text",e.bagProperties.display_subtitle_text)},_logErrorAndReject:function(e,t){o.error(e.error,null,"card.Configuration.controller");t.reject(e.error,e.errorInfo)},_fillCardBag:function(e,t){Object.keys(e.bagProperties).forEach(function(a){if(e.bagProperties[a]){t.setText(a,e.bagProperties[a])}else{t.resetProperty(a)}})},_prepareManifest:function(t,a){var i=JSON.parse(t),r=e.getCardData(a);return e.mergeCardData(i,r)},_checkOriginalLanguage:function(){var e,t;if(!this._isOriginalLanguage()){e=this.getView().getModel();t=this._getLanguages();e.setProperty("/config/originalLanguage",t.originalLanguage.toUpperCase());e.setProperty("/config/sapLogonLanguage",t.logonLanguage.toUpperCase());e.setProperty("/config/displayOriginalLanguageWarning",true);e.setProperty("/config/manifestEditorEditable",false)}},_isOriginalLanguage:function(){var e=this._getLanguages(),t=e.originalLanguage.toLowerCase(),a=e.logonLanguage.toLowerCase(),i=e.ui5CoreLanguage.toLowerCase();return t===""||t===a||t===i},_getLanguages:function(){var e=this.oView.getViewData().chipInstance;return{originalLanguage:e.bag.getOriginalLanguage(),logonLanguage:s.getConfiguration().getLocale().getSAPLogonLanguage(),ui5CoreLanguage:g.getLanguage()}}})});