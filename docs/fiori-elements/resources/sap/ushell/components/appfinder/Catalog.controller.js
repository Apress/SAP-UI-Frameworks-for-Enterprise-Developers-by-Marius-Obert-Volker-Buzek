// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/extend","sap/ushell/library","sap/ui/core/Core","sap/ui/core/mvc/View","sap/ui/core/mvc/Controller","sap/ushell/components/_HomepageManager/PagingManager","sap/ushell/components/CatalogsManager","sap/ui/core/UIComponent","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/library","sap/ui/Device","sap/ui/core/library","sap/ui/model/Context","sap/m/MessageToast","sap/ushell/Config","sap/ushell/components/appfinder/VisualizationOrganizerHelper","sap/ushell/utils/WindowUtils"],function(e,t,i,r,a,o,s,n,l,g,h,d,p,c,u,f,v,y,C,m){"use strict";var F=p.SplitAppMode;var P=t.AppType;return a.extend("sap.ushell.components.appfinder.Catalog",{oPopover:null,onInit:function(){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this.oLaunchPageService=e}.bind(this));this.categoryFilter="";this.preCategoryFilter="";var e=this.getView();this.oMainModel=e.getModel();this.oSubHeaderModel=e.getModel("subHeaderModel");this.resetPage=false;this.bIsInProcess=false;this.oVisualizationOrganizerHelper=e.oVisualizationOrganizerHelper;this.oCatalogsContainer=e.oCatalogsContainer;this.timeoutId=0;document.subHeaderModel=this.oSubHeaderModel;document.mainModel=this.oMainModel;var t=this.oSubHeaderModel.bindProperty("/openCloseSplitAppButtonToggled");t.attachChange(this.handleToggleButtonModelChanged,this);e.oCatalogsContainer.setHandleSearchCallback(this.handleSearchModelChanged.bind(this))},customRouteMatched:function(e){this.onShow(e)},onBeforeRendering:function(){i.getEventBus().publish("renderCatalog")},onAfterRendering:function(){this.wasRendered=true;if(!this.PagingManager){this._setPagingManager()}if(this.PagingManager.currentPageIndex===0){this.allocateNextPage()}l(window).resize(function(){var e=l(window).width();var t=l(window).height();this.PagingManager.setContainerSize(e,t)}.bind(this));this._handleAppFinderWithDocking();i.getEventBus().subscribe("launchpad","appFinderWithDocking",this._handleAppFinderWithDocking,this);i.getEventBus().subscribe("sap.ushell","appFinderAfterNavigate",this._handleAppFinderAfterNavigate,this)},_setPagingManager:function(){this.lastCatalogId=0;this.PagingManager=new o("catalogPaging",{supportedElements:{tile:{className:"sapUshellTile"}},containerHeight:window.innerHeight,containerWidth:window.innerWidth});this.oCatalogsContainer.setPagingManager(this.PagingManager)},_decodeUrlFilteringParameters:function(e){var t;try{t=JSON.parse(e)}catch(i){t=e}var i=t&&t.tagFilter&&t.tagFilter||[];if(i){try{this.tagFilter=JSON.parse(i)}catch(e){this.tagFilter=[]}}else{this.tagFilter=[]}this.categoryFilter=t&&t.catalogSelector&&t.catalogSelector||this.categoryFilter;if(this.categoryFilter){this.categoryFilter=window.decodeURIComponent(this.categoryFilter)}this.searchFilter=t&&t.tileFilter&&t.tileFilter||null;if(this.searchFilter){this.searchFilter=window.decodeURIComponent(this.searchFilter)}},_applyFilters:function(e){var t=false;if(this.categoryFilter){this.categoryFilter=g.i18n.getText("all")===this.categoryFilter?"":this.categoryFilter;if(this.categoryFilter!==this.preCategoryFilter){t=true}this.oView.setCategoryFilterSelection(this.categoryFilter,t)}else{t=true;this.oView.setCategoryFilterSelection("",t)}this.preCategoryFilter=this.categoryFilter;if(this.searchFilter&&this.searchFilter.length){this.searchFilter=this.searchFilter.replace(/\*/g,"");this.searchFilter=this.searchFilter.trim();this.oSubHeaderModel.setProperty("/search",{searchMode:true,searchTerm:this.searchFilter})}else if(e){this.oSubHeaderModel.setProperty("/search",{searchMode:false,searchTerm:""});this.resetPage=true}if(this.tagFilter&&this.tagFilter.length){this.oSubHeaderModel.setProperty("/tag",{tagMode:true,selectedTags:this.tagFilter})}else if(e){this.oSubHeaderModel.setProperty("/tag",{tagMode:false,selectedTags:[]});this.resetPage=true}this.handleSearchModelChanged()},_handleAppFinderAfterNavigate:function(){this.clearFilters()},clearFilters:function(){var e=false;if(this.categoryFilter!==this.preCategoryFilter){e=true}var t=this.oSubHeaderModel.getProperty("/search/searchMode");var i=this.oSubHeaderModel.getProperty("/tag/tagMode");if(t){this.oSubHeaderModel.setProperty("/search",{searchMode:true,searchTerm:""})}if(i){this.oSubHeaderModel.setProperty("/tag",{tagMode:true,selectedTags:[]})}if(this.categoryFilter&&this.categoryFilter!==""){this.selectedCategoryId=undefined;this.categoryFilter=undefined;this.getView().getModel().setProperty("/categoryFilter","");this.oView.setCategoryFilterSelection("",e)}this.preCategoryFilter=this.categoryFilter;this.handleSearchModelChanged()},onShow:function(t){var i=t.getParameter("arguments").filters;e(this.getView().getViewData(),t);this._decodeUrlFilteringParameters(i);if(this.wasRendered&&!i){this.clearFilters()}else{this._applyFilters(this.wasRendered)}},allocateNextPage:function(){if(!this.oCatalogsContainer.nAllocatedUnits||this.oCatalogsContainer.nAllocatedUnits===0){this.PagingManager.moveToNextPage();this.allocateTiles=this.PagingManager._calcElementsPerPage();this.oCatalogsContainer.applyPagingCategoryFilters(this.allocateTiles,this.categoryFilter)}},setTagsFilter:function(e){var t={catalogSelector:this.categoryFilter?this.categoryFilter:"All",tileFilter:this.searchFilter&&this.searchFilter.length?encodeURIComponent(this.searchFilter):"",tagFilter:e.length?JSON.stringify(e):[]};this._addNavigationContextToFilter(t);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(t)})},setCategoryFilter:function(e){var t={catalogSelector:e,tileFilter:this.searchFilter?encodeURIComponent(this.searchFilter):"",tagFilter:this.tagFilter.length?JSON.stringify(this.tagFilter):[]};this._addNavigationContextToFilter(t);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(t)})},setSearchFilter:function(e){var t={catalogSelector:this.categoryFilter?this.categoryFilter:"All",tileFilter:e?encodeURIComponent(e):"",tagFilter:this.tagFilter.length?JSON.stringify(this.tagFilter):[]};this._addNavigationContextToFilter(t);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(t)})},_addNavigationContextToFilter:function(e){var t=this.oVisualizationOrganizerHelper.getNavigationContext.apply(this);if(t){Object.keys(t).forEach(function(i){e[i]=t[i]})}return e},onSearch:function(e){var t=this.oSubHeaderModel.getProperty("/activeMenu");if(this.oView.getId().indexOf(t)!==-1){var i=e.searchTerm?e.searchTerm:"";this.setSearchFilter(i)}else{this._restoreSelectedMasterItem()}},onTag:function(e){var t=this.oSubHeaderModel.getProperty("/activeMenu");if(this.oView.getId().indexOf(t)!==-1){var i=e.selectedTags?e.selectedTags:[];this.setTagsFilter(i)}else{this._restoreSelectedMasterItem()}},getGroupContext:function(){var e=this.getView().getModel();var t=e.getProperty("/groupContext/path");return{targetGroup:encodeURIComponent(t||"")}},_isTagFilteringChanged:function(e){var t=e.length===this.tagFilter.length;var i=t;if(!i){return true}e.some(function(e){i=this.tagFilter&&Array.prototype.indexOf.call(this.tagFilter,e)!==-1;return!i}.bind(this));return i},_setUrlWithTagsAndSearchTerm:function(e,t){var i={tileFilter:e&&e.length?encodeURIComponent(e):"",tagFilter:t.length?JSON.stringify(t):[]};this._addNavigationContextToFilter(i);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(i)})},handleSearchModelChanged:function(){var e=this.oSubHeaderModel.getProperty("/search/searchMode");var t=this.oSubHeaderModel.getProperty("/tag/tagMode");var r=this.oSubHeaderModel.getProperty("/search/searchTerm");var a=this.oSubHeaderModel.getProperty("/tag/selectedTags");var o=[];var s;var n;var g;if(!this.PagingManager){this._setPagingManager()}this.PagingManager.resetCurrentPageIndex();this.nAllocatedTiles=0;this.PagingManager.moveToNextPage();this.allocateTiles=this.PagingManager._calcElementsPerPage();this.oView.oCatalogsContainer.updateAllocatedUnits(this.allocateTiles);this.oView.oCatalogsContainer.resetCatalogPagination();var p=i.byId("catalogTilesDetailedPage");if(p){p.scrollTo(0,0)}if(e||t||this.resetPage){if(a&&a.length>0){var c=new h("tags","EQ","v");c.fnTest=function(e){if(a.length===0){return true}for(var t=0;t<a.length;t++){var i=a[t];if(e.indexOf(i)===-1){return false}}return true};s=new h([c],true)}r=r?r.replace(/\*/g,""):r;if(r){var u=r.split(/[\s,]+/);var f=new h(l.map(u,function(e){return e&&new h("keywords",d.Contains,e)}),true);var v=new h(l.map(u,function(e){return e&&new h("title",d.Contains,e)}),true);var y=new h(l.map(u,function(e){return e&&new h("subtitle",d.Contains,e)}),true);o.push(f);o.push(v);o.push(y);n=new h(o,false)}var C=this.oView.oCatalogsContainer.getCatalogs();this.oSearchResultsTotal=[];var m=this;if(s&&s.aFilters.length>0&&n){g=new h([n].concat([s]),true)}else if(s&&s.aFilters.length>0){g=new h([s],true)}else if(n&&n.aFilters.length>0){g=new h([n],true)}C.forEach(function(e){e.getBinding("customTilesContainer").filter(g);e.getBinding("appBoxesContainer").filter(g)});this.oView.oCatalogsContainer.bSearchResults=false;this.oView.oCatalogsContainer.applyPagingCategoryFilters(this.oView.oCatalogsContainer.nAllocatedUnits,this.categoryFilter);this.bSearchResults=this.oView.oCatalogsContainer.bSearchResults;this.oView.splitApp.toDetail(m.getView()._calculateDetailPageId());this.resetPage=false}else{this.oView.oCatalogsContainer.applyPagingCategoryFilters(this.oView.oCatalogsContainer.nAllocatedUnits,this.categoryFilter)}var F=this.getView()._calculateDetailPageId();this.oView.splitApp.toDetail(F)},_handleAppFinderWithDocking:function(){if(l(".sapUshellContainerDocked").length>0){if(l("#mainShell").width()<710){if(window.innerWidth<1024){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",false);this.oView.splitApp.setMode(F.ShowHideMode)}else{this.oView.splitApp.setMode(F.HideMode);this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",true)}}else{this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",false);this.oView.splitApp.setMode(F.ShowHideMode)}}},_restoreSelectedMasterItem:function(){var e=this.oView.splitApp.getMasterPage("catalogSelect");var t=i.byId(this.selectedCategoryId);if(t){this.categoryFilter=t.getTitle()}e.setSelectedItem(t)},handleToggleButtonModelChanged:function(){var e=this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonVisible");var t=this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonToggled");if(t!==this.bCurrentButtonToggled&&e){if(!c.system.phone){if(t&&!this.oView.splitApp.isMasterShown()){this.oView.splitApp.showMaster()}else if(this.oView.splitApp.isMasterShown()){this.oView.splitApp.hideMaster()}}else if(this.oView.splitApp.isMasterShown()){var r=i.byId(this.getView()._calculateDetailPageId());this.oView.splitApp.toDetail(r)}else if(t){var a=i.byId("catalogSelect");this.oView.splitApp.toMaster(a,"show")}}this.bCurrentButtonToggled=t},_handleCatalogListItemPress:function(e){this.onCategoryFilter(e);if(this.oSubHeaderModel.getProperty("/search/searchTerm")!==""){this.oSubHeaderModel.setProperty("/search/searchMode",true)}if(c.system.phone||c.system.tablet){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",!this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled"))}},onCategoryFilter:function(e){var t=e.getSource();var i=t.getSelectedItem();var r=i.getBindingContext();var a=r.getModel();if(a.getProperty("static",r)){a.setProperty("/showCatalogHeaders",true);this.setCategoryFilter();this.selectedCategoryId=undefined;this.categoryFilter=undefined}else{a.setProperty("/showCatalogHeaders",false);this.setCategoryFilter(window.encodeURIComponent(i.getBindingContext().getObject().title));this.categoryFilter=i.getTitle();this.selectedCategoryId=i.getId()}},onTileAfterRendering:function(e){var t=e.oSource.getDomRef();if(t){var i=t.getElementsByClassName("sapMGT");for(var r=0;r<i.length;r++){i[r].setAttribute("tabindex","-1")}}},catalogTilePress:function(){i.getEventBus().publish("launchpad","catalogTileClick")},onAppBoxPressed:function(e){var t=e.getSource();var i=t.getBindingContext().getObject();var r;if(e.mParameters.srcControl.$().closest(".sapUshellPinButton").length){return}r=this.oLaunchPageService.getAppBoxPressHandler(i);if(r){r(i)}else{var a=t.getProperty("url");if(a&&a.indexOf("#")===0){hasher.setHash(a)}else{var o=y.last("/core/shell/enableRecentActivity")&&y.last("/core/shell/enableRecentActivityLogging");if(o){var s={title:t.getProperty("title"),appType:P.URL,url:a,appId:a};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(s)}m.openURL(a,"_blank")}}},onTilePinButtonClick:function(e){var t=this.oLaunchPageService;var i=t.getDefaultGroup();i.done(function(i){var a=e.getSource();var o=a.getBindingContext();var s=this.getView().getModel();var n=s.getProperty("/groupContext/path");if(n){this._handleTileFooterClickInGroupContext(o,n)}else{var l=s.getProperty("/groups");var g=this.getCatalogTileDataFromModel(o);var h=g.tileData.associatedGroups;var d=[];var p=l.map(function(e){var r=t.getGroupId(e.object);var a=!(h&&Array.prototype.indexOf.call(h,r)===-1);d.push({id:r,title:this._getGroupTitle(i,e.object),selected:a});return{selected:a,initiallySelected:a,oGroup:e}}.bind(this));var c;c=t.getCatalogTilePreviewTitle(s.getProperty(o.sPath).src);if(!c){c=t.getCatalogTileTitle(s.getProperty(o.sPath).src)}this.pPopoverView=r.create({id:"sapUshellGroupsPopover",viewName:"module:sap/ushell/components/appfinder/GroupListPopoverView",viewData:{title:c,enableHideGroups:s.getProperty("/enableHideGroups"),enableHelp:s.getProperty("/enableHelp"),sourceContext:o,catalogModel:this.getView().getModel(),catalogController:this}}).then(function(e){e.getController().initializeData({groupData:p});e.open(a).then(this._handlePopoverResponse.bind(this,o,g));this.getView().addDependent(e);return e}.bind(this))}}.bind(this))},_getGroupTitle:function(e,t){var i=this.oLaunchPageService;var r;if(e&&i.getGroupId(e)===i.getGroupId(t)){r=g.i18n.getText("my_group")}else{r=i.getGroupTitle(t)}return r},_handlePopoverResponse:function(e,t,i){if(!i.addToGroups.length&&!i.newGroups.length&&!i.removeFromGroups.length){return}var r=this.getView().getModel();var a=r.getProperty("/groups");var o=[];i.addToGroups.forEach(function(t){var i=a.indexOf(t);var s=new f(r,"/groups/"+i);o.push(this._addTile(e,s))}.bind(this));i.removeFromGroups.forEach(function(t){var i=e.getModel().getProperty(e.getPath()).id;var r=a.indexOf(t);o.push(this._removeTile(i,r))}.bind(this));i.newGroups.forEach(function(t){var i=t.length>0?t:g.i18n.getText("new_group_name");o.push(this._createGroupAndSaveTile(e,i))}.bind(this));l.when.apply(l,o).then(function(){var e=Array.prototype.slice.call(arguments);this._handlePopoverGroupsActionPromises(t,i,e)}.bind(this))},_handlePopoverGroupsActionPromises:function(e,t,i){var r=i.filter(function(e){return!e.status});if(r.length){var a=this.prepareErrorMessage(r,e.tileData.title);var o=s.prototype.getInstance();o.resetAssociationOnFailure(a.messageId,a.parameters);return}var n=[];var l=this.oLaunchPageService;t.allGroups.forEach(function(e){if(e.selected){var t=l.getGroupId(e.oGroup.object);n.push(t)}});var g=this.getView().getModel();if(t.newGroups.length){var h=g.getProperty("/groups");var d=h.slice(h.length-t.newGroups.length);d.forEach(function(e){var t=l.getGroupId(e.object);n.push(t)})}g.setProperty(e.bindingContextPath+"/associatedGroups",n);var p=t.addToGroups[0]?t.addToGroups[0].title:"";if(p.length===0&&t.newGroups.length){p=t.newGroups[0]}var c=t.removeFromGroups[0]?t.removeFromGroups[0].title:"";var u=t.addToGroups.length+t.newGroups.length;var f=t.removeFromGroups.length;var y=this.prepareDetailedMessage(e.tileData.title,u,f,p,c);v.show(y,{duration:3e3,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"})},_getCatalogTileIndexInModel:function(e){var t=e.sPath;var i=t.split("/");var r=i[i.length-1];return r},_handleTileFooterClickInGroupContext:function(e,t){var i=this.oLaunchPageService;var r=this.getView().getModel();var a=this.getCatalogTileDataFromModel(e);var o=a.tileData.associatedGroups;var s=r.getProperty(t);var n=i.getGroupId(s.object);var l=o?Array.prototype.indexOf.call(o,n):-1;var g=a.bindingContextPath;if(a.isBeingProcessed){return}r.setProperty(g+"/isBeingProcessed",true);var h;var d;if(l===-1){var p=new f(e.getModel(),t);h=this._addTile(e,p);d=true}else{var c=e.getModel().getProperty(e.getPath("id"));var u=parseInt(t.split("/")[2],10);h=this._removeTile(c,u);d=false}h.done(function(t){if(t.status){this._groupContextOperationSucceeded(e,a,s,d)}else{this._groupContextOperationFailed(a,s,d)}}.bind(this));h.always(function(){r.setProperty(g+"/isBeingProcessed",false)})},_groupContextOperationSucceeded:function(e,t,i,r){var a=this.oLaunchPageService;var o=a.getGroupId(i.object);var s=t.tileData.associatedGroups;var n;if(r){s.push(o);e.getModel().setProperty(t.bindingContextPath+"/associatedGroups",s);n=this.prepareDetailedMessage(t.tileData.title,1,0,i.title,"")}else{for(var l=0;l<s.length;l++){if(s[l]===o){s.splice(l,1);break}}e.getModel().setProperty(t.bindingContextPath+"/associatedGroups",s);n=this.prepareDetailedMessage(t.tileData.title,0,1,"",i.title)}v.show(n,{duration:3e3,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"})},_groupContextOperationFailed:function(e,t,i){var r=s.prototype.getInstance();var a;if(i){a=g.i18n.getText({messageId:"fail_tile_operation_add_to_group",parameters:[e.tileData.title,t.title]})}else{a=g.i18n.getText({messageId:"fail_tile_operation_remove_from_group",parameters:[e.tileData.title,t.title]})}r.notifyOnActionFailure(a.messageId,a.parameters)},prepareErrorMessage:function(e,t){var i;var r;var a;var o=0;var s=0;var n=false;for(var l in e){var h=e[l].group;var d=e[l].action;if(d==="add"){o++;if(o===1){i=h.title}}else if(d==="remove"){s++;if(s===1){r=h.title}}else if(d==="addTileToNewGroup"){o++;if(o===1){i=h.title}}else{n=true}}if(n){if(e.length===1){a=g.i18n.getText({messageId:"fail_tile_operation_create_new_group"})}else{a=g.i18n.getText({messageId:"fail_tile_operation_some_actions"})}}else if(e.length===1){if(o){a=g.i18n.getText({messageId:"fail_tile_operation_add_to_group",parameters:[t,i]})}else{a=g.i18n.getText({messageId:"fail_tile_operation_remove_from_group",parameters:[t,r]})}}else if(s===0){a=g.i18n.getText({messageId:"fail_tile_operation_add_to_several_groups",parameters:[t]})}else if(o===0){a=g.i18n.getText({messageId:"fail_tile_operation_remove_from_several_groups",parameters:[t]})}else{a=g.i18n.getText({messageId:"fail_tile_operation_some_actions"})}return a},prepareDetailedMessage:function(e,t,i,r,a){var o;if(t===0){if(i===1){o=g.i18n.getText("tileRemovedFromSingleGroup",[e,a])}else if(i>1){o=g.i18n.getText("tileRemovedFromSeveralGroups",[e,i])}}else if(t===1){if(i===0){o=g.i18n.getText("tileAddedToSingleGroup",[e,r])}else if(i===1){o=g.i18n.getText("tileAddedToSingleGroupAndRemovedFromSingleGroup",[e,r,a])}else if(i>1){o=g.i18n.getText("tileAddedToSingleGroupAndRemovedFromSeveralGroups",[e,r,i])}}else if(t>1){if(i===0){o=g.i18n.getText("tileAddedToSeveralGroups",[e,t])}else if(i===1){o=g.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSingleGroup",[e,t,a])}else if(i>1){o=g.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSeveralGroups",[e,t,i])}}return o},getCatalogTileDataFromModel:function(e){var t=e.getPath();var i=e.getModel();var r=i.getProperty(t);return{tileData:r,bindingContextPath:t,isBeingProcessed:r.isBeingProcessed}},_addTile:function(e,t){var i=s.prototype.getInstance();var r=l.Deferred();var a=i.createTile({catalogTileContext:e,groupContext:t});a.done(function(e){r.resolve(e)});return r},_removeTile:function(e,t){var i=s.prototype.getInstance();var r=l.Deferred();var a=i.deleteCatalogTileFromGroup({tileId:e,groupIndex:t});a.done(function(e){r.resolve(e)});return r},_createGroupAndSaveTile:function(e,t){var i=s.prototype.getInstance();var r=l.Deferred();var a=i.createGroupAndSaveTile({catalogTileContext:e,newGroupName:t});a.done(function(e){r.resolve(e)});return r},onExit:function(){C.destroy();i.getEventBus().unsubscribe("launchpad","appFinderWithDocking",this._handleAppFinderWithDocking,this);i.getEventBus().unsubscribe("launchpad","appFinderAfterNavigate",this._handleAppFinderAfterNavigate,this)}})});