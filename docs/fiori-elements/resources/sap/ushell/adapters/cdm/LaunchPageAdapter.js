// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/_LaunchPage/readHome","sap/ushell/adapters/cdm/_LaunchPage/modifyHome","sap/ushell/adapters/cdm/_LaunchPage/readCatalogs","sap/m/GenericTile","sap/m/library","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/utils/utilsCdm","sap/ushell/utils/WindowUtils","sap/ushell/utils/UrlParsing","sap/ushell/components/tiles/utils","sap/base/util/Version","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/UI5ComponentType"],function(e,t,i,r,n,o,s,a,l,u,f,c,d,p,h,g,m,v,T,R,_,b,C,S,y){"use strict";var I=n.GenericTileMode;var D=S.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter"),j=S.Level;function w(n,w,G){var k,L="sap.ushell.components.tiles.cdm.applauncher",F="sap.ushell.components.tiles.cdm.applauncherdynamic";this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};Promise.all([sap.ushell.Container.getServiceAsync("URLParsing"),sap.ushell.Container.getServiceAsync("CommonDataModel")]).then(function(e){this.oURLParsingService=e[0];this.oCDMService=e[1]}.bind(this));this.getCdmVersionsSupported=function(){return{min:m("0"),max:m("2.0.0")}};this.isSiteSupported=function(e){if(!!e._version&&m(e._version).compareTo(this.getCdmVersionsSupported().max)>0){S.fatal("Invalid CDM site version: Only sites up to version 2.0.0 are supported");return false}return true};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var e=new T.Deferred;this._assureLoaded().done(function(t){c.setPerformanceMark("FLP - homepage groups processed");e.resolve(t)}).fail(function(){e.resolve([])});return e.promise()};this._getTileFromHashInContextOfSite=function(e,t,i){var r=new T.Deferred,n=t[i];if(!n){n=e(i);t[i]=n}n.done(function(e){var t={tileIntent:i,tileResolutionResult:e};r.resolve(t)}).fail(function(e){r.reject("Hash '"+i+"' could not be resolved to a tile. "+e)});return r.promise()};this._getTileFromHash=function(e){var t=new T.Deferred;sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(i){var r=i.resolveTileIntent.bind(i);this._getTileFromHashInContextOfSite(r,this._mCatalogTilePromises,e).done(t.resolve).fail(t.reject)}.bind(this));return t.promise()};this._getTileForUrl=function(e){var t=e.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:t,isCustomTile:false}}};this._assureGroupItemsResolved=function(e,t){var i=[],r,n;if(e.payload&&e.payload.tiles){r=this._assureGroupTilesResolved(e.payload.tiles,t);Array.prototype.push.apply(i,r)}if(e.payload&&e.payload.links){n=this._assureGroupLinksResolved(e.payload.links,t);Array.prototype.push.apply(i,n)}return i};this._assureGroupTilesResolved=function(e,t){return(e||[]).map(function(e,i){return this._resolveGroupTile(e,t).then(function(e){e.isLink=false;return e})},this)};this._assureGroupLinksResolved=function(e,t){return(e||[]).map(function(e){return this._resolveGroupTile(e,t).then(function(e){e.isLink=true;return e})},this)};this._resolveGroupTile=function(e,t){var i=this._mResolvedTiles;var r=this._mFailedResolvedTiles;var n;function o(t){i[e.id]=t;if(r[e.id]){delete r[e.id]}return t}function s(e){var t=e.target;return t&&t.semanticObject==="Shell"&&t.action==="launchURL"}if(i[e.id]){return(new T.Deferred).resolve(i[e.id]).promise()}if(e.target&&e.target.url){n=T.when(this._getTileForUrl(e))}else if(e.isBookmark){n=this._resolveTileByIntent(e,t)}else if(s(e)){n=this._resolveTileByIntent(e,t)}else{n=this._resolveTileByAppId(e,t)}n.done(function(e){o(e)}).fail(function(t){r[e.id]=t});return n};this._resolveTileByAppId=function(e,t){var i,r,n,o,s;function l(e,t){return(new T.Deferred).reject({logLevel:e,message:t}).promise()}if(!_(e)){return l(j.ERROR,"Cannot resolve tile: oTile must be an object")}if(!_(t)){return l(j.ERROR,"Cannot resolve tile: oSite must be an object")}i=e.appId||e.appIDHint;if(!i){return l(j.ERROR,["Cannot resolve tile '",e.id,"': either appId or appIDHint must be specified"].join(""))}r=t.applications&&t.applications[i];if(!r){return l(j.INFO,["Tile '",e.id,"' filtered from result: no app found for appId '",i,"' (dangling app reference)"].join(""))}n=this._getFirstInbound(r);if(!n){return l(j.ERROR,["Cannot resolve tile '",e.id,"': app '",i,"' has no navigation inbound"].join(""))}var f=d.mapOne(n.key,n.inbound,r),c=f.resolutionResult.applicationType,p=f.resolutionResult.additionalInformation,h=a.last("/core/navigation/enableInPlaceForClassicUIs"),g=h?h[c]:false;o=f.tileResolutionResult;o.navigationMode=u.computeNavigationModeForHomepageTiles(c,p,g);o.isLink=false;if(!this._isFormFactorSupported(o)){return l(j.INFO,["Tile '",e.id,"' filtered from result: form factor not supported"].join(""))}s=this._toHashFromInbound(n.inbound);return T.when({tileResolutionResult:o,tileIntent:s})};this._isFormFactorSupported=function(t){var i=c.getFormFactor();return e.supportsFormFactor(t,i)};this._getFirstInbound=function(e){var t=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),i=e["sap.app"].crossNavigation.inbounds[t];return{key:t,inbound:i}};this._resolveTileByIntent=function(e,t){var i=this._prepareTileHash(e);return this._getTileFromHash(i)};this._prepareTileHash=function(e){var t={},i,r;if(this._isCatalogTile(e)){return e.tileIntent}if(this._isGroupTile(e)&&e.target){r=e.target.parameters||[];r.forEach(function(e){if(e.name&&e.value){t[e.name]=[e.value]}});i={target:{semanticObject:e.target.semanticObject,action:e.target.action},params:t,appSpecificRoute:e.target.appSpecificRoute};return"#"+h.constructShellHash(i)}return undefined};this._allPromisesDone=function(e){var t=new T.Deferred,i;if(e.length===0){t.resolve([])}else{var r=e.map(function(e){i=new T.Deferred;e.always(i.resolve.bind(i));return i.promise()});T.when.apply(this,r).done(function(){var e=Array.prototype.slice.call(arguments);t.resolve(e)})}return t.promise()};this._assureLoaded=function(){var i=this,r;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise()}r=new T.Deferred;this._assureLoadedDeferred=r;sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(r){r.getSite().done(function(r){if(!i.isSiteSupported(r)){throw new Error("Invalid CDM site version: Check configuration of launchpage adapter and version of FLP site")}var n=[];var o=e.getGroupsArrayFromSite(r);var s=e.getDefaultGroup(o);if(!s){s=t.createDefaultGroup(c.generateUniqueId(e.getGroupIdsFromSite(r)));r=t.addGroupToSite(r,s,0);o=e.getGroupsArrayFromSite(r)}k=s;o.forEach(function(e){n=i._assureGroupItemsResolved(e,r).concat(n)});i._allPromisesDone(n).done(function(){i._assureLoadedDeferred.resolve(o);delete i._assureLoadedDeferred;i._logTileResolutionFailures(i._mFailedResolvedTiles)})}).fail(function(e){S.error("Delivering homepage groups failed - "+e);i._assureLoadedDeferred.resolve([]);delete i._assureLoadedDeferred})});return r.promise()};this._logTileResolutionFailures=function(e){var t={};if(!e){return}Object.keys(j).filter(function(e){var t=j[e];return t>=j.FATAL&&t<=j.ALL}).forEach(function(e){t[j[e]]=""});Object.keys(e).forEach(function(i){var r=e[i];if(r.logLevel){t[r.logLevel]=t[r.logLevel].concat(r.message).concat("\n")}});if(t[j.FATAL]){D.fatal(t[j.FATAL])}if(t[j.ERROR]){D.error(t[j.ERROR])}if(t[j.WARNING]){D.warning(t[j.WARNING])}if(t[j.INFO]){D.info(t[j.INFO])}if(t[j.DEBUG]){D.debug(t[j.DEBUG])}if(t[j.TRACE]){D.trace(t[j.TRACE])}};this.getDefaultGroup=function(){var e=new T.Deferred,t;if(!k){t=this._assureLoaded()}if(t){t.done(function(){e.resolve(k)}).fail(function(t){e.reject("Failed to access default group. "+t)})}else{e.resolve(k)}return e.promise()};this._isValidTitle=function(e){if(typeof e!=="string"||!e){return false}return true};this._isGroupPreset=function(t){return e.isGroupPreset(t)};this._isGroupLocked=function(t){return e.isGroupLocked(t)};this.addGroup=function(i){var r=new T.Deferred,n=this.oCDMService,o,s,a=this;if(!this._isValidTitle(i)){return r.reject("No valid group title").promise()}s="Failed to add the group with title '"+i+"' to the homepage. ";n.getSite().done(function(s){o=c.generateUniqueId(e.getGroupIdsFromSite(s));t.addGroupToSite(s,t.createEmptyGroup(o,i));n.save().done(function(){delete a._assureLoadedDeferred;r.resolve(s.groups[o],o)}).fail(function(e){r.reject(e)})}).fail(function(e){r.reject(s+e)});return r.promise()};this.getGroupTitle=function(t){return e.getGroupTitle(t)};this.setGroupTitle=function(i,r){var n=this,o=new T.Deferred,s=this.oCDMService,a,l;if(typeof i!=="object"||!e.getGroupId(i)){return o.reject("Unexpected group value").promise()}if(!n._isValidTitle(r)){return o.reject("Unexpected oGroup title value").promise()}l="Failed to set new title for group with id '"+e.getGroupId(i)+"'. ";a=e.getGroupTitle(i);s.getSite().done(function(e){if(i){t.setGroupTitle(i,r)}s.save().done(function(){o.resolve()}).fail(function(e){S.error(e);o.reject(a)})}).fail(function(e){o.reject(a,l+e)});return o.promise()};this.getGroupId=function(t){return e.getGroupId(t)};this.hideGroups=function(i){var r=new T.Deferred,n=this.oCDMService,o;if(i&&Array.isArray(i)){o="Failed to hide group. ";n.getSite().done(function(o){e.getGroupsArrayFromSite(o).forEach(function(r){t.setGroupVisibility(r,i&&Array.prototype.indexOf.call(i,e.getGroupId(r))===-1)});n.save().done(function(){r.resolve()}).fail(function(e){r.reject("Hiding of groups did not work as expected - "+e)})}).fail(function(e){r.reject(o+e)})}else{r.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.")}return r.promise()};this.isGroupVisible=function(t){return e.isGroupVisible(t)};this.moveGroup=function(i,r){var n=new T.Deferred,o=this.oCDMService,s,a;if(!i||!e.getGroupId(i)||r<0){return n.reject("Unable to move groups - invalid parameters").promise()}a="Failed to move group with id '"+i.identification.id+"'. ";o.getSite().done(function(a){var l=e.getGroupIdsFromSite(a),u=e.getGroupId(i);if(!l){return n.reject("groupsOrder not found - abort operation of adding a group.")}else if(l.indexOf(u)===r){return n.resolve()}s=c.moveElementInsideOfArray(l,l.indexOf(u),r);if(!s){return n.reject("invalid move group operation - abort.")}t.setGroupsOrder(a,s);o.save().done(function(){n.resolve()}).fail(function(e){n.reject(e)});return undefined}).fail(function(e){n.reject(a+e)});return n.promise()};this.removeGroup=function(i){var r=new T.Deferred,n=this.oCDMService,o,s;if(typeof i!=="object"){return r.reject("invalid group parameter").promise()}s=e.getGroupId(i);if(!s){return r.reject("group without id given").promise()}o="Failed to remove group with id '"+s+"'. ";n.getSite().done(function(e){t.removeGroupFromSite(e,i);n.save().done(function(){r.resolve()}).fail(function(e){r.reject(e)})}).fail(function(e){r.reject(o+e)});return r.promise()};this.resetGroup=function(i){var r=new T.Deferred,n=this.oCDMService,o=[],s=this,a,l;if(typeof i==="object"&&e.getGroupId(i)){l=e.getGroupId(i);a="Failed to reset group with id '"+l+"'. ";n.getSite().done(function(a){R(o,e.getGroupsArrayFromSite(a));if(s.isGroupRemovable(i)===false){n.getGroupFromOriginalSite(l).done(function(i){if(typeof a==="object"&&e.getGroupFromSite(a,l)){t.overwriteGroup(a,i,l)}n.save().done(function(){r.resolve(i)}).fail(function(e){r.reject("Group could not be reset - "+e,o)})}).fail(function(e){r.reject("Group could not be reset - "+e,o)})}else{r.reject("Group could not be reset as it was created by the user",o)}}).fail(function(e){r.reject(a+e,[])})}return r.promise()};this.getTileTitle=function(t){return e.getTileTitle(this._mResolvedTiles,t)};this.getTileSubtitle=function(t){return e.getTileSubtitle(this._mResolvedTiles,t)};this.getTileIcon=function(t){return e.getTileIcon(this._mResolvedTiles,t)};this.getTileInfo=function(t){return e.getTileInfo(this._mResolvedTiles,t)};this.getTileIndicatorDataSource=function(e){var t=this._mResolvedTiles[e.id],i={},r;if(e.indicatorDataSource){i.indicatorDataSource=R({},e.indicatorDataSource);if(e.dataSource){i.dataSource=R({},e.dataSource)}return i}if(!t){return i}r=t.tileResolutionResult;if(r.indicatorDataSource){i.indicatorDataSource=R({},r.indicatorDataSource);if(r.indicatorDataSource.hasOwnProperty("dataSource")){var n=r.indicatorDataSource.dataSource,o=r.dataSources;if(o&&o.hasOwnProperty(n)){i.dataSource=R({},o[n])}else{S.warning("datasource referenced but not found for tile: "+t.tileIntent)}}if(c.getMember(r,"runtimeInformation.componentProperties.url")){var a=c.getMember(i,"indicatorDataSource.path");var l=c.getMember(i,"dataSource.uri");var u=c.getMember(r,"runtimeInformation.componentProperties.url");var f=s(a,l,u,this.getWindowLocationHref());if(!f.error){if(a){i.indicatorDataSource.path=f.uri}if(l){i.dataSource.uri=f.uriParent}}}}return i};this.getWindowLocationHref=function(){return window.location.href};this.isGroupRemovable=function(e){return!this._isGroupPreset(e)};this.isGroupLocked=function(e){return this._isGroupLocked(e)};this.getGroupTiles=function(t){return e.getGroupTiles(t).concat(e.getGroupLinks(t))};this.getLinkTiles=function(t){return e.getGroupLinks(t)};this.getTileType=function(t){if(e.isLink(this._mResolvedTiles,t)){return this.TileType.Link}return this.TileType.Tile};this.getTileId=function(t){return e.getTileId(t)};this.getTileSize=function(t){return e.getTileSize(this._mResolvedTiles,t)||"1x1"};this.getTileTarget=function(t){var i,r=e.getTileId(t),n=this._mResolvedTiles[r],o;if(t.target&&t.target.url){return t.target.url}if(n&&n.tileResolutionResult){i=n.tileResolutionResult;if(i.isCustomTile!==true){return n.tileIntent}if(i&&typeof i.targetOutbound==="object"){o=this._toHashFromOutbound(i.targetOutbound);if(o){return o}}}S.warning("Could not find a target for Tile with id '"+r+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return""};this.isLinkPersonalizationSupported=function(e){return true};this.isTileIntentSupported=function(e){return this._mFailedResolvedTiles[e.id]===undefined};this._notifyTileAboutRefresh=function(e){if(typeof e.tileRefresh==="function"){e.tileRefresh()}};this.refreshTile=function(e){var t=this._mResolvedTiles[e.id];if(t){if(t.tileComponent){this._notifyTileAboutRefresh(t.tileComponent)}}};this._notifyTileAboutVisibility=function(e,t,i){if(typeof e.tileSetVisible==="function"&&i!==t){e.tileSetVisible(t)}};this.setTileVisible=function(e,t){var i=this._mResolvedTiles[e.id];if(i){if(i.tileComponent){this._notifyTileAboutVisibility(i.tileComponent,t,i.visibility)}i.visibility=t}};this.getTileView=function(e){var t=this;return new T.Deferred(function(i){return t._getTileView(e,false).then(function(e){i.resolve(e)},function(t){var r="Tile with ID '"+e.id+"' could not be initialized"+(t?":\n"+t:".");S.error(r,null,e.tileType);i.reject(r)})}).promise()};this._getTileUiComponentContainerSync=function(e,t,i){var n=this,s,a,l,u,c={};if(i===true){a=n._createTileComponentData(e,true,t)}else{a=n._createTileComponentData(e,false,t)}s=t.tileResolutionResult;if(t.isLink){l=s.navigationMode;return n._createLinkInstance(e,i,l,r,f)}if(typeof s.tileComponentLoadInfo==="string"){if(a.properties.indicatorDataSource&&a.properties.indicatorDataSource.path){c.name="sap.ushell.components.tiles.cdm.applauncherdynamic"}else{c.name="sap.ushell.components.tiles.cdm.applauncher"}}else if(typeof s.tileComponentLoadInfo==="object"&&s.tileComponentLoadInfo!==null){c=s.tileComponentLoadInfo.componentProperties||{};c.name=s.tileComponentLoadInfo.componentName}c.componentData=a;if(c.manifest){c.componentData.properties=c.componentData.properties||{};c.componentData.properties.manifest=c.manifest}if(c.name){c.async=false;var d;try{u=sap.ui.component(c)}catch(e){S.error(e.message+"\n-- An error occurred while instantiating "+"the tile component for "+c.name,e.stack?e.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null}d=new o({component:u,height:"100%"});if(!i){n._mResolvedTiles[e.id].tileComponent=u}return d}return null};this._getTileUiComponentContainer=function(e,t,i){var n=this,s,a,u,c,d,p,h=new T.Deferred;if(i===true){a=n._createTileComponentData(e,true,t)}else{a=n._createTileComponentData(e,false,t)}s=t.tileResolutionResult;if(t.isLink){u=s.navigationMode;h.resolve(n._createLinkInstance(e,i,u,r,f));return h.promise()}var g=this._createTileComponentProperties(a,s.tileComponentLoadInfo);if(!g.name){return h.reject("Cannot find name of tile component for tile with id: '"+e.id+"'").promise()}if(g.manifest){a.properties=a.properties||{};a.properties.manifest=g.manifest}p=this.isCustomTile(g.name);var m=function(t){var r;c=t.componentHandle.getInstance();d=new o({component:c,height:"100%"});if(!i){r=n._mResolvedTiles[e.id];r.tileComponent=c;if(typeof r.visibility==="boolean"){n._notifyTileAboutVisibility(c,r.visibility)}}return d};var v=function(e){return e.createComponent({loadCoreExt:p,loadDefaultDependencies:false,componentData:a,url:g.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:g,ui5ComponentName:g.name},{},[],y.Visualization).then(m)};var R=function(){var e={componentData:a,url:g.url,name:g.name,async:false};c=sap.ui.component(e);var t={componentHandle:{getInstance:function(){return c}}};return m(t)};if(p){l.once("CoreResourcesComplementLoaded").do(function(){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(e){v(e).then(function(e){h.resolve(e)}).fail(function(e){h.reject(e)})})})}else{var _=R();h.resolve(_)}return h.promise()};this._createTileComponentProperties=function(e,t){var i={};if(typeof t==="string"){if(e.properties.indicatorDataSource&&e.properties.indicatorDataSource.path){i.name=F}else{i.name=L}return i}if(typeof t==="object"&&t!==null){i=t.componentProperties||{};i.name=t.componentName}return i};this._getTileView=function(e){var t,i,r=new T.Deferred;if(typeof e!=="object"||!e.id){i="Invalid input parameter passed to _getTileView: "+e;S.error(i);return r.reject(i).promise()}t=this._mResolvedTiles[e.id];if(t){return this._getTileUiComponentContainer(e,t,false)}i="No resolved tile found for tile ID: "+e.id;S.error(i);return r.reject(i).promise()};this._getCatalogTileView=function(e){if(typeof e!=="object"){throw new Error(e)}return this._getTileUiComponentContainerSync(e,e,true)};this._getCatalogTileViewControl=function(e){var t=new T.Deferred;if(typeof e!=="object"){var i="Invalid input parameter passed to _getCatalogTileView: "+e;S.error(i);return t.reject(i).promise()}return this._getTileUiComponentContainer(e,e,true)};this._createTileComponentData=function(e,t,i){var r=t?this.getCatalogTileTitle(e):this.getTileTitle(e),n=t?this.getCatalogTilePreviewSubtitle(e):this.getTileSubtitle(e),o=t?this.getCatalogTilePreviewIcon(e):this.getTileIcon(e),s=t?this.getCatalogTilePreviewInfo(e):this.getTileInfo(e),a=t?this.getCatalogTileTargetURL(e):this.getTileTarget(e),l=this.getTileIndicatorDataSource(e),u={properties:{},startupParameters:{}};if(i.tileResolutionResult.isCustomTile===true&&i.tileResolutionResult.startupParameters){u.startupParameters=i.tileResolutionResult.startupParameters}if(r){u.properties.title=r}if(s){u.properties.info=s}if(n){u.properties.subtitle=n}if(o){u.properties.icon=o}if(a){u.properties.targetURL=a}if(l.indicatorDataSource){u.properties.indicatorDataSource=l.indicatorDataSource;if(l.dataSource){u.properties.dataSource=l.dataSource}}if(i.tileResolutionResult){u.properties.navigationMode=i.tileResolutionResult.navigationMode}return u};this._createLinkInstance=function(e,t,i,r,n){var o,s,a,l=this.getTileSubtitle(e);var u=r;if(t===true){o=this.getCatalogTileTitle(e)}else{o=this.getTileTitle(e)}s=new u({mode:I.LineMode,subheader:l,header:o,url:p.getLeanURL(this.getTileTarget(e)),press:function(t){this._genericTilePressHandler(e,t)}.bind(this)});if(i){a=n.i18n.getText(i+"NavigationMode");s.setAriaLabel(a+" "+o+" "+l)}this._mResolvedTiles[e.id].linkTileControl=s;return s};this._genericTilePressHandler=function(e,t){var i;if(t.getSource().getScope&&t.getSource().getScope()==="Display"){i=this.getTileTarget(e);if(i){if(i[0]==="#"){hasher.setHash(i)}else{p.openURL(i,"_blank")}}}};this._addTileToSite=function(e,t,i,r){var n=this,o=new T.Deferred,s=h.parseShellHash(i.properties.targetURL),a={id:n.getTileId(i),target:{semanticObject:s.semanticObject,action:s.action,parameters:N(s.params)}};e.groups[t.identification.id].payload.tiles.push(a);r.save().done(function(){o.resolve(a)}).fail(function(e){o.reject(e)});return o.promise()};this.addTile=function(e,t){var i=new T.Deferred,r,n=this.oCDMService,o;if(!t){t=k}o=A();o.appId=e.tileResolutionResult.appId;this._mResolvedTiles[o.id]={tileIntent:e.tileIntent,tileResolutionResult:e.tileResolutionResult,isLink:false};n.getSite().done(function(e){e.groups[t.identification.id].payload.tiles.push(o);n.save().done(function(){i.resolve(o)}).fail(function(e){i.reject(e)})}).fail(function(e){r="Failed to add tile with id '"+o.id+"' to group with id '"+t.identification.id+"'. ";i.reject(r+e)});return i.promise()};this.removeTile=function(e,t,i){var r=this.oCDMService,n,o=new T.Deferred,s=this;if(!e||typeof e!=="object"||!e.identification||!e.identification.id||!t||typeof t!=="object"||!t.id){return o.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise()}n="Failed to remove tile with id '"+t.id+"' from group with id '"+e.identification.id+"'. ";r.getSite().done(function(a){var l,u;i=+i;try{l=a.groups[e.identification.id].payload}catch(t){o.reject(a.groups[e.identification.id],n)}u=s.getTileType(t)===s.TileType.Link?"links":"tiles";if(s.getTileType(t)===s.TileType.Link){i-=l.tiles.length}if(i>=0){l[u].splice(i,1)}else{l[u]=l[u].filter(function(e){return e.id!==t.id})}r.save().done(function(){o.resolve()}).fail(function(t){S.error(t);o.reject(a.groups[e.identification.id],t)})}).fail(function(e){o.reject({},n+e)});return o.promise()};this.moveTile=function(e,t,i,r,n,o){var s=new T.Deferred,a=this.oCDMService,l=this,u;if(!e||b(e)||t===undefined||t<0||i===undefined||i<0||!r||!r.identification||!r.identification.id||!n||!n.identification||!n.identification.id){return s.reject("Invalid input parameters").promise()}u="Failed to move tile with id '"+e.id+"'. ";a.getSite().done(function(f){var c,d,p=l.getTileType(e)===l.TileType.Link?"links":"tiles";if(!o){o=l._mResolvedTiles[e.id].isLink?"link":"tile"}c=o==="link"?"links":"tiles";if(p!==c&&l._mResolvedTiles[e.id]){l._mResolvedTiles[e.id].isLink=o==="link"}if(c==="links"){i-=f.groups[n.identification.id].payload.tiles.length}if(p==="links"){t-=f.groups[r.identification.id].payload.tiles.length}if(r.identification.id===n.identification.id){if(t!==i||p!==c){d=f.groups[n.identification.id].payload;d[p].splice(t,1);d[c].splice(i,0,e)}else{return s.resolve(e).promise()}}else{f.groups[r.identification.id].payload[p].splice(t,1);f.groups[n.identification.id].payload[c].splice(i,0,e)}a.save().done(function(){s.resolve(e)}).fail(function(e){S.error(u+e);s.reject(u+e)});return undefined}).fail(function(e){S.error(u+e);s.reject(u+e)});return s.promise()};this._compareCatalogs=function(e,t){if(e.identification.id>t.identification.id){return 1}return-1};this.getCatalogs=function(){var e=this,t=new T.Deferred,i=[];function r(e,t,i,r){var n=e.catalogs[t];i.push(n);r.notify(n)}sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(n){n.getSite().done(function(n){Object.keys(n.catalogs).forEach(function(e){r(n,e,i,t)});t.resolve(i.sort(e._compareCatalogs))})},0);return t.promise()};this._isStartableInbound=function(e){var t=["Shell-plugin","Shell-bootConfig"],i;if(!e.semanticObject||!e.action){return false}if(t.indexOf(e.semanticObject+"-"+e.action)>-1){return false}if(!C.get("signature.parameters",e)){return true}i=Object.keys(e.signature.parameters).every(function(t){return!e.signature.parameters[t].filter||(!!e.signature.parameters[t].launcherValue||t==="sap-external-url")});return i};this._isHiddenInbound=function(e){return!!e.hideLauncher};this._toHashFromInbound=function(e){var t=d.toHashFromInbound(e);if(!t){return undefined}return"#"+t};this._getExternalUrlFromInbound=function(e){return C.get("signature.parameters.sap-external-url.launcherValue.value",e)||null};this._toHashFromOutbound=function(e){var t=d.toHashFromOutbound(e);if(!t){return undefined}return"#"+t};this._isCustomTile=function(e){if(c.getMember(e,"sap|flp.type")==="tile"){return true}return false};this.getCatalogTiles=function(e){var t=this,i=new T.Deferred;if(typeof e!=="object"||e===null){return i.reject("Invalid input parameter '"+e+"' passed to getCatalogTiles.").promise()}t.oCDMService.getSite().done(function(r){O.call(t,e,r).done(i.resolve).fail(i.reject)}).fail(function(e){i.reject("Failed to get site: "+e)});return i.promise()};this.isCustomTile=function(e){return!(e===L||e===F)};function O(e,t){var i=this,r=new T.Deferred;setTimeout(function(){var n=(e.payload&&e.payload.appDescriptors||[]).reduce(function(e,r){var n=t.applications[r.id],o,s,l,f,c,p,h,g,m,v,T;if(!n){return e}o=i._getMember(n,"sap|app.crossNavigation.inbounds");if(!o||Object.keys(o).length===0){return e}l=Object.keys(o)[0];f=o[l];if(i._isStartableInbound(f)&&!i._isHiddenInbound(f)){c=d.mapOne(l,f,n);if(!c||!c.tileResolutionResult){return e}g=c.resolutionResult.applicationType;T=a.last("/core/navigation/enableInPlaceForClassicUIs");v=T?T[g]:false;m=c.resolutionResult.additionalInformation;c.tileResolutionResult.navigationMode=u.computeNavigationModeForHomepageTiles(g,m,v);p=c.tileResolutionResult;s=i._toHashFromInbound(f);h={id:s,tileIntent:s,tileResolutionResult:p,isCatalogTile:true};e.push(h)}return e},[]);r.resolve(n)},0);return r.promise()}this.getCatalogError=function(e){if(e.error){return e.error}return undefined};this.getCatalogId=function(e){return i.getCatalogId(e)};this.getCatalogTitle=function(e){return i.getCatalogTitle(e)};this._isGroupTile=function(t){return e.isGroupTile(t)};this._isCatalogTile=function(e){return!!(e&&e.isCatalogTile)};this._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[e.getTileId(t)])};this._isFailedCatalogTile=function(t){return!!(t&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[e.getTileId(t)])};this.getCatalogTileId=function(t){if(this._isGroupTile(t)){if(this._isFailedGroupTile(t)){return undefined}if(t.isBookmark&&C.get("target.url",t)){return t.target.url}return(this._mResolvedTiles[e.getTileId(t)]||{}).tileIntent}if(this._isCatalogTile(t)){return t.id}return undefined};this.getCatalogTileTitle=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return""}return this._mResolvedTiles[e.id].tileResolutionResult.title}if(this._isCatalogTile(e)){if(this._isFailedCatalogTile(e)){return undefined}return e.tileResolutionResult.title}return undefined};this.getCatalogTileSize=function(e){return e.tileResolutionResult.size||"1x1"};this.getCatalogTileView=function(e){return this._getCatalogTileView(e)};this.getCatalogTileViewControl=function(e){return this._getCatalogTileViewControl(e)};this.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy")}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return""}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound)}return e.tileIntent||""}return this.getTileTarget(e)};this.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e)}return e.tileResolutionResult&&e.tileResolutionResult.title||""};this.getCatalogTilePreviewSubtitle=function(e){if(this._isGroupTile(e)){return this.getTileSubtitle(e)}return e.tileResolutionResult&&e.tileResolutionResult.subTitle||""};this.getCatalogTilePreviewIcon=function(e){if(this._isGroupTile(e)){return this.getTileIcon(e)}return e.tileResolutionResult&&e.tileResolutionResult.icon||""};this.getCatalogTilePreviewInfo=function(e){if(this._isGroupTile(e)){return this.getTileInfo(e)}return e.tileResolutionResult&&e.tileResolutionResult.info||""};this.getCatalogTileKeywords=function(e){var t=[],i=e;if(!i){S.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return t}if(this._mResolvedTiles&&this._mResolvedTiles[e.id]){i=this._mResolvedTiles[e.id]}if(i&&i.tileResolutionResult&&i.tileResolutionResult.title){t.push(i.tileResolutionResult.title)}if(i&&i.tileResolutionResult&&i.tileResolutionResult.subTitle){t.push(i.tileResolutionResult.subTitle)}return t};this._visitBookmarks=function(e,t){var i=this.oCDMService;var r;var n=h.parseShellHash(e);if(n){r=x(n)}else{r=E(e)}return i.getSite().then(function(e){var i=e.groups;var n=Object.keys(i).filter(function(e){return!i[e].payload.locked}).map(function(e){return i[e].payload.tiles.filter(function(e){return e.isBookmark&&H(r,e.target)})}).reduce(function(e,t){Array.prototype.push.apply(e,t);return e},[]);if(!t){return n.length}return T.when(n.map(t)).then(function(){return n.length})})};this.addBookmark=function(e,t){var i=this;return new T.Deferred(function(r){var n=i.oCDMService;T.when(t||i.getDefaultGroup(),n.getSite()).done(function(t,o){var s,a,l=h.parseShellHash(e.url),u,f=false;if(!l){a=E(e.url);f=true}else{a=x(l)}s=P(e,a);if(f){u=new T.Deferred;u.resolve(i._getTileForUrl(s))}else{u=i._getTileFromHash(e.url)}u.done(function(e){e.isLink=false;i._mResolvedTiles[s.id]=e;o.groups[t.identification.id].payload.tiles.push(s);n.save().done(function(){r.resolve(s)}).fail(function(e){r.reject(e)})}).fail(function(e){r.reject("Bookmark creation failed because: "+e)})}).fail(function(e){r.reject(e)})}).promise()};this.countBookmarks=function(e){return this._visitBookmarks(e)};this.updateBookmarks=function(e,t){var i=this.oCDMService;var r=this._mResolvedTiles;function n(i){return new T.Deferred(function(n){var o,s;var a;var l=false;var u={};if(t.url||t.url===""){o=h.parseShellHash(t.url);if(!o){s=E(t.url)}else{s=x(o)}}if(i.icon!==t.icon){u.icon=t.icon;l=true}if(i.title!==t.title){u.title=t.title;l=true}if(i.subTitle!==t.subtitle){u.subtitle=t.subtitle;l=true}if(t.url&&e!==t.url){u.targetURL=t.url;l=true}if(i.info!==t.info){u.info=t.info;l=true}M(i,t,s);if(l&&r[i.id]){a=r[i.id].tileComponent;if(a){a.tileSetVisualProperties(u)}}n.resolve(i)}).promise()}return this._visitBookmarks(e,n).then(function(e){return i.save().then(function(){return e})})};this.deleteBookmarks=function(e){var t=this.oCDMService;var i=h.parseShellHash(e);var r;if(i){r=x(i)}else{r=E(e)}return t.getSite().then(function(e){var i=e.groups;var n=Object.keys(i).map(function(e){var t=i[e].payload;var n=0;t.tiles=t.tiles.filter(function(e){if(e.isBookmark&&H(r,e.target)){++n;return false}return true});return n}).reduce(function(e,t){e+=t;return e},0);return t.save().then(function(){return n})})};this.onCatalogTileAdded=function(e){};this._onTileSettingsSave=function(e,t){var i=new T.Deferred,r,n,o,s,a,l,u;if(!e||!e.id||!t){return i.reject().promise()}n=t.oTitleInput.getValue();s=t.oSubTitleInput.getValue();o=t.oInfoInput.getValue();a=this.getTileTitle(e);l=this.getTileInfo(e);u=this.getTileSubtitle(e);if(a===n&&u===s&&l===o){return i.resolve().promise()}r={};if(a!==n){r.title=n;e.title=n}if(u!==s){r.subtitle=s;e.subTitle=s}if(l!==o){r.info=o;e.info=o}if(this._mResolvedTiles[e.id].tileComponent){this._mResolvedTiles[e.id].tileComponent.tileSetVisualProperties(r)}else if(this._mResolvedTiles[e.id].linkTileControl){if(r.title){this._mResolvedTiles[e.id].linkTileControl.setHeader(r.title)}if(r.subtitle){this._mResolvedTiles[e.id].linkTileControl.setSubheader(r.subtitle)}if(r.title||r.subtitle){this._mResolvedTiles[e.id].linkTileControl.rerender()}}sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(e){e.save().fail(function(e){S.error(e);i.reject("Could not save personalization changes: "+e)}).done(function(){i.resolve()})});return i.promise()};this.getTileActions=function(e){var t=[],i,r;if(this._isGroupTile(e)&&!this._isFailedGroupTile(e)){r=new v({config:{display_title_text:this.getTileTitle(e),display_subtitle_text:this.getTileSubtitle(e),display_info_text:this.getTileInfo(e)}});i=g.getTileSettingsAction(r,this._onTileSettingsSave.bind(this,e),this.getTileType(e));t.push(i)}return t};function P(e,t){var i=A(e,t);i.isBookmark=true;return i}function A(e,t){var i={id:c.generateUniqueId([])};M(i,e,t);return i}function M(e,t,i){t=R({},t);if(i){e.target=i}if(t.title||t.title===""){e.title=t.title}if(t.icon||t.icon===""){e.icon=t.icon}if(t.subtitle||t.subtitle===""){e.subTitle=t.subtitle}if(t.info||t.info===""){e.info=t.info}if(t.dataSource){e.dataSource={};R(e.dataSource,t.dataSource)}if(t.serviceUrl||t.serviceUrl===""){e.indicatorDataSource={path:t.serviceUrl}}if(e.indicatorDataSource&&(t.serviceRefreshInterval||t.serviceRefreshInterval===0)){e.indicatorDataSource.refresh=t.serviceRefreshInterval}}function H(e,t){if(e&&t){if(e.url){return e.url===t.url}return e.semanticObject===t.semanticObject&&e.action===t.action&&U(e.parameters,t.parameters)&&e.appSpecificRoute===t.appSpecificRoute}return e===t}function U(e,t){var i,r;e=e||[];t=t||[];if(e.length===t.length){i=V(e);r=V(t);return i===r}return false}function V(e){return e.map(function(e){return e.name+e.value}).sort().join()}function E(e){return{url:e}}function x(e){var t={semanticObject:e.semanticObject,action:e.action,parameters:N(e.params)};if(e.appSpecificRoute){t.appSpecificRoute=e.appSpecificRoute}return t}function N(e){return Object.keys(e).map(function(t){var i=e[t]&&e[t][0];return{name:t,value:i||""}})}}w.prototype._getMember=function(e,t){return c.getMember(e,t)};return w},false);