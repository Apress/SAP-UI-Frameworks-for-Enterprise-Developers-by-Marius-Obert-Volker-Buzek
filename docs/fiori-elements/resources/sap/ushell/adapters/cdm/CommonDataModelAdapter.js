// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/UriParameters","sap/base/util/Version","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery"],function(e,t,i,n,o,r){"use strict";var a=function(e,t,i){this.oAdapterConfiguration=i;if(i&&i.config&&i.config.siteData){this.oCdmSiteDataRequestPromise=(new r.Deferred).resolve(i.config.siteData)}else if(i&&i.config&&i.config.siteDataPromise){this.oCdmSiteDataRequestPromise=i.config.siteDataPromise}else{var n=this._identifySiteUrlFromConfig(i);var o=this._normalizeUrl(n,location.href);this.oCdmSiteDataRequestPromise=this._requestSiteData(o)}};a.prototype._requestSiteData=function(t){var i=new r.Deferred;if(!t){return i.reject("Cannot load site: configuration property 'siteDataUrl' is missing for CommonDataModelAdapter.")}r.ajax({type:"GET",dataType:"json",url:t}).done(function(e){i.resolve(e)}).fail(function(t){e.error(t.responseText);i.reject("CDM Site was requested but could not be loaded.")});return i.promise()};a.prototype._normalizeUrl=function(e,t){if(typeof e!=="string"){return e}if(e.indexOf("http")===0){return e}var i=document.getElementsByTagName("base")[0];return new o(e,i).absoluteTo(t).toString()};a.prototype.getSite=function(){var e=new r.Deferred;this.oCdmSiteDataRequestPromise.done(function(i){var n=t({},i);delete n.personalization;e.resolve(n)}).fail(function(t){e.reject(t)});return e.promise()};a.prototype.getPersonalization=function(){var i=new r.Deferred,n=this;this.oCdmSiteDataRequestPromise.done(function(o){var r=t({},o),a=r._version,s;if(n.oAdapterConfiguration&&n.oAdapterConfiguration.config&&n.oAdapterConfiguration.config.ignoreSiteDataPersonalization){delete r.personalization}if(r.personalization){s=r.personalization._version;if(Object.keys(r.personalization).length>0&&!n._isPersonalizationVersionValid(a,s)){e.error("Personalization version is not compatible to the site version and will not be loaded."+" Please proceed to personalize the homepage again if needed. Personalization version: "+s+"; Site version: "+a);i.resolve();return}i.resolve(r.personalization)}else{n._readPersonalizationDataFromStorage(a).done(function(t){s=t._version;if(Object.keys(t).length>0&&!n._isPersonalizationVersionValid(a,s)){e.error("Personalization version is not compatible to the site version and will not be loaded."+" Please proceed to personalize the homepage again if needed. Personalization version: "+s+"; Site version: "+a);i.resolve();return}i.resolve(t)}).fail(function(e){i.reject(e)})}}).fail(function(e){i.reject(e)});return i.promise()};a.prototype._isPersonalizationVersionValid=function(e,t){if(!e){return false}var i=new n(e).getMajor(),o=new n(t);if(i>=3){return o.getMajor()===i}return o.getMajor()<3};a.prototype.setPersonalization=function(t){var i=new r.Deferred;sap.ushell.Container.getServiceAsync("Personalization").then(function(o){var r,a={keyCategory:o.constants.keyCategory.FIXED_KEY,writeFrequency:o.constants.writeFrequency.LOW,clientStorageAllowed:true},s={container:"sap.ushell.cdm.personalization",item:"data"},l=new n(t.version);if(l.inRange("3.1.0","4.0.0")){s={container:"sap.ushell.cdm3-1.personalization",item:"data"}}var u=o.getPersonalizer(s,a,r);u.setPersData(t).done(function(){e.info("Personalization data has been stored successfully.");i.resolve()}).fail(function(){i.reject("Writing personalization data failed.")})});return i.promise()};a.prototype._readPersonalizationDataFromStorage=function(e){var t=new r.Deferred;sap.ushell.Container.getServiceAsync("Personalization").then(function(i){var o={keyCategory:i.constants.keyCategory.FIXED_KEY,writeFrequency:i.constants.writeFrequency.LOW,clientStorageAllowed:true};var r={container:"sap.ushell.cdm.personalization",item:"data"};if(e){var a=new n(e);if(a&&a.inRange("3.1.0","4.0.0")){r={container:"sap.ushell.cdm3-1.personalization",item:"data"}}}i.getPersonalizer(r,o).getPersData().done(function(e){t.resolve(e||{})}).fail(function(){t.reject("Fetching personalization data failed.")})});return t.promise()};a.prototype._identifySiteUrlFromConfig=function(e){var t=i.fromQuery(window.location.search);var n=t.get("sap-ushell-cdm-site-url");var o=e&&e.config;if(o&&!o.allowSiteSourceFromURLParameter&&n){n=null}if(o&&!n){n=o.siteDataUrl||o.cdmSiteUrl}this.sCdmSiteUrl=n;return n};return a},false);