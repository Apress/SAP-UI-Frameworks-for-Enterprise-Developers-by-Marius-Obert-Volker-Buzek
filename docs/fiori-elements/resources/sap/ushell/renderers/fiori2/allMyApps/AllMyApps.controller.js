// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ui/core/mvc/Controller","sap/ushell/renderers/fiori2/allMyApps/AllMyAppsManager","sap/ushell/Config","sap/ui/Device","sap/ui/performance/Measurement","sap/ui/model/json/JSONModel","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/m/library","sap/m/StandardListItem","sap/ushell/renderers/fiori2/allMyApps/AllMyAppsKeyboardHandler"],function(e,t,s,l,a,i,n,r,o,p,d,u,h){"use strict";var g=d.ListType;var A=false;var M=e.AllMyAppsState;var c=e.AllMyAppsProviderType;var y=e.AppTitleState;return t.extend("sap.ushell.renderers.fiori2.allMyApps.AllMyApps",{iNumberOfProviders:0,onInit:function(){this.bFirstLoadOfAllMyApps=true;var e=new n,t=this.getView(),s=sap.ui.getCore().getEventBus();e.setSizeLimit(1e4);e.setProperty("/AppsData",[]);e.setProperty("/catalogEnabled",l.last("/core/catalog/enabled"));t.setModel(r.getTranslationModel(),"i18n");t.setModel(e,"allMyAppsModel");s.subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext,this);s.subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);s.subscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);s.subscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this)},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext);e.unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);e.unsubscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);e.unsubscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this)},onAfterRendering:function(){return new Promise(function(e,t){var s=this,l=this.getView(),i=l.getModel("allMyAppsModel"),n=this._getSplitApp(),r=l.byId("sapUshellAllMyAppsMasterPage"),o=l.byId("sapUshellAllMyAppsDetailsPage");if(!this.bAfterInitialLoading){if(r){r.setBusy(true)}if(o){o.setBusy(true)}n.toMaster(this.createId("sapUshellAllMyAppsMasterPage"),"show");if(!a.system.phone){n.toDetail("sapUshellAllMyAppsDetailsPage","show")}}if(this.bFirstLoadOfAllMyApps){i.setProperty("/AppsData",[])}else{var p=i.getProperty("/AppsData");i.setProperty("/AppsData",p)}setTimeout(function(){s._getAllMyAppsManager().loadAppsData(i,s._getPopoverObject(),s.bFirstLoadOfAllMyApps);s._isSingleDataSource().then(function(t){A=t;s.switchToInitialState();s.bFirstLoadOfAllMyApps=false;e()})},0)}.bind(this))},switchToInitialState:function(){var e=this._getDataSourceList();return this._isSingleDataSource().then(function(t){if(t){l.emit("/core/shell/model/allMyAppsMasterLevel",M.FirstLevelSpread);e.bindItems("allMyAppsModel>/AppsData/0/groups",this._getMasterListItemTemplate)}else{l.emit("/core/shell/model/allMyAppsMasterLevel",M.FirstLevel);e.bindItems("allMyAppsModel>/AppsData",this._getMasterListItemTemplate())}if(a.system.phone){this._getSplitApp().toMaster(this.createId("sapUshellAllMyAppsMasterPage"),"show")}e.rerender();this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:true});this._getPopoverHeaderLabel().setText(r.i18n.getText("allMyApps_headerTitle"));this.updateHeaderButtonsState()}.bind(this))},handleSwitchToMasterAreaOnPhone:function(){var e=this._getDataSourcesSelectedPath(),t=e.split("/");this._getSplitApp().toMaster(this.createId("sapUshellAllMyAppsMasterPage"),"show");return this._isSingleDataSource().then(function(e){if(e){l.emit("/core/shell/model/allMyAppsMasterLevel",M.FirstLevelSpread)}else if(t.length===3){l.emit("/core/shell/model/allMyAppsMasterLevel",M.FirstLevel)}else{l.emit("/core/shell/model/allMyAppsMasterLevel",M.SecondLevel)}this.updateHeaderButtonsState()}.bind(this))},handleMasterListItemPress:function(e){this.lastPressedMasterItem=e.getParameter("listItem");var t=this._getClickedDataSourceItemPath(this.lastPressedMasterItem);var s=this.getView();var a=s.getModel("allMyAppsModel");var i=a.getProperty(t+"/type");var n=l.last("/core/shell/model/allMyAppsMasterLevel");var r=this._getCustomPanel();var o=this._getCustomPanelLabel();var p=this._getCustomPanelLink();var d=i===c.CATALOG;var u;if(d||n===M.FirstLevelSpread||n===M.SecondLevel){u=this.handleMasterListItemPressToDetails(t)}else{u=this.handleMasterListItemPressToSecondLevel(t)}r.setBindingContext(u,"allMyAppsModel");o.setBindingContext(u,"allMyAppsModel");if(p&&p.getVisible&&p.getVisible()){p.setBindingContext(u,"allMyAppsModel")}},handleMasterListItemPressToSecondLevel:function(e){var t=this.getView();var s=t.getModel("allMyAppsModel");var i=s.getProperty(e+"/type");var n=s.getProperty(e+"/title");var o=this._getSplitApp();var p=this._getDataSourceList();var d;var u;if(!a.system.phone){o.toDetail(this.createId("sapUshellAllMyAppsDetailsPage"))}p.bindItems("allMyAppsModel>"+e+"/groups",this._getMasterListItemTemplate());l.emit("/core/shell/model/allMyAppsMasterLevel",M.SecondLevel);d=this._setBindingContext(e+"/groups/0",t.byId("oItemsContainerlist"));p.rerender();p.setSelectedItem(p.getItems()[0]);u=p.getSelectedItem();if(u){u.focus()}if(i===c.HOME){this._getPopoverHeaderLabel().setText(r.i18n.getText("allMyApps_homeEntryTitle"))}else if(i===c.EXTERNAL){this._getPopoverHeaderLabel().setText(n)}this._getDetailsHeaderLabel().setText(s.getProperty(e+"/groups/0/title"));this.updateHeaderButtonsState();return d},handleMasterListItemPressToDetails:function(e){var t=this.getView(),s=t.getModel("allMyAppsModel"),i=this._setBindingContext(e,t.byId("oItemsContainerlist"));this._getDetailsHeaderLabel().setText(s.getProperty(e+"/title"));if(a.system.phone){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsDetailsPage"));l.emit("/core/shell/model/allMyAppsMasterLevel",M.Details)}this.updateHeaderButtonsState();return i},onMasterLoad:function(){var e=this.getView(),t=this._getPopoverHeaderBackButton();this.bAfterInitialLoading=true;e.byId("sapUshellAllMyAppsMasterPage").setBusy(false);t.focus();this._isSingleDataSource().then(function(e){A=e;this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:false})}.bind(this))},onDetailLoad:function(){var e=this.getView(),t=e.byId("sapUshellAllMyAppsDetailsPage");t.setBusy(false);this.bAfterInitialLoading=true;if(!a.system.phone){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsDetailsPage"),"show")}},onNoCatalogsLoaded:function(){var e=this.getView(),t=e.byId("sapUshellAllMyAppsDetailsPage");t.setBusy(false);this.bAfterInitialLoading=true;if(!a.system.phone&&!A){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsEmptyDetailsPage"),"show")}else if(!a.system.phone&&A){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsDetailsPage"))}},updateMasterFocusAndDetailsContext:function(e,t,s){var l=this.getView(),a=l.getModel("allMyAppsModel"),n=this._getInitialFirstLevelSelectionIndex(),r=this._getDataSourceList(),o=this._getCustomPanelLabel(),p=this._getCustomPanelLink(),d,u,h;if(A===true){d=a.createBindingContext("/AppsData/0/groups/0");u=a.getProperty(d.getPath())}else{d=a.createBindingContext("/AppsData/"+n);u=a.getProperty(d.getPath())}l.byId("oItemsContainerlist").setBindingContext(d,"allMyAppsModel");o.setBindingContext(d,"allMyAppsModel");l.byId("sapUshellAllMyAppsCustomPanel").setBindingContext(d,"allMyAppsModel");if(p.getVisible()){p.setBindingContext(d,"allMyAppsModel")}if(u!==undefined){this._getDetailsHeaderLabel().setText(u.title)}if(s.bFirstCatalogLoadedEvent===true){r.rerender()}if(s.bFirstCatalogLoadedEvent===false&&n===0){this.onNoCatalogsLoaded()}r.setSelectedItem(r.getItems()[n]);h=r.getSelectedItem();if(h){setTimeout(function(){h.focus()},0)}if(s.bFirstCatalogLoadedEvent){i.end("FLP:ShellAppTitle.onClick");i.end("FLP:ShellNavMenu.footerClick")}},handleCustomPanelLinkPress:function(e){var t=this.getView(),s=t.byId("sapUshellAllMyAppsCustomPanelLink"),l=s.getVisible()?s.getBindingContext("allMyAppsModel").getObject():{};if(l.handlePress){l.handlePress(e.getSource(),l)}},updateHeaderButtonsState:function(){this._getShellAppTitleToggleListButton().setVisible(this.getToggleListButtonVisible());this._getPopoverHeaderBackButton().setVisible(this.getBackButtonVisible())},getToggleListButtonVisible:function(){var e=this.getCurrentState(),t=a.media.getCurrentRange(a.media.RANGESETS.SAP_STANDARD).name==="Phone",s=(t||a.system.phone)&&e===M.Details;return s},getBackButtonVisible:function(){var e=l.last("/core/shellHeader/ShellAppTitleState");if(e!==y.AllMyAppsOnly){return true}var t=this.getCurrentState();return t===M.SecondLevel||t===M.Details},onAppItemClick:function(e){var t=this.getView().getModel("allMyAppsModel"),s=e.getSource().getBindingContext("allMyAppsModel").getPath(),l=t.getProperty(s+"/url");if(l){if(l[0]==="#"){hasher.setHash(l);setTimeout(function(){this.getView().getParent().close()}.bind(this),50)}else{o.openURL(l,"_blank")}}},getCurrentState:function(){return l.last("/core/shell/model/allMyAppsMasterLevel")},_isSingleDataSource:function(){return sap.ushell.Container.getServiceAsync("AllMyApps").then(function(e){if(e.isCatalogAppsEnabled()){return false}if(!e.isExternalProviderAppsEnabled()&&e.isHomePageAppsEnabled()){return true}return e.isExternalProviderAppsEnabled()&&Object.keys(e.getDataProviders()).length===1&&!e.isHomePageAppsEnabled()})},_getInitialFirstLevelSelectionIndex:function(){var e=this.getView(),t=e.getModel("allMyAppsModel"),s=t.getProperty("/AppsData"),l,a;for(l=0;l<s.length;l++){a=s[l];if(a.type===c.CATALOG){return l}}return 0},_getPopoverHeaderBackButton:function(){if(!this._oPopoverHeaderBackButton){this._oPopoverHeaderBackButton=this._getPopoverHeaderContent(0)}return this._oPopoverHeaderBackButton},_getShellAppTitleToggleListButton:function(){if(!this._oShellAppTitleToggleListButton){this._oShellAppTitleToggleListButton=this._getPopoverHeaderContent(1)}return this._oShellAppTitleToggleListButton},_getPopoverHeaderContent:function(e){var t,s,l;t=this._getPopoverObject().getCustomHeader();s=t.getContentLeft();l=s[e];return l},_getPopoverHeaderLabel:function(){var e,t;e=this._getPopoverObject().getCustomHeader();t=e.getContentMiddle();return t[0]},_getPopoverObject:function(){return this.getView().getParent()},_getDetailsHeaderLabel:function(){return this.getView().byId("sapUshellAllMyAppsDetailsHeaderLabel")},_setBindingContext:function(e,t){var s=this.getView().getModel("allMyAppsModel"),l=s.createBindingContext(e);t.setBindingContext(l,"allMyAppsModel");return l},_getClickedDataSourceItemPath:function(e){return e.getBindingContext("allMyAppsModel").getPath()},_getAllMyAppsManager:function(){return s},_getDataSourcesSelectedPath:function(){return this.lastPressedMasterItem.getBindingContextPath()},getControllerName:function(){return"sap.ushell.renderers.fiori2.allMyApps.AllMyApps"},formatListItemType:function(e,t){var s=a.system.phone||t===M.FirstLevel&&e!==c.CATALOG;return s?g.Navigation:g.Active},_afterOpen:function(){if(!this.bAfterOpenHandlerCalled){this.bAfterOpenHandlerCalled=true;if(a.system.desktop){h.init(this.getView())}}},_getMasterListItemTemplate:function(){if(!this.oTemplate){this.oTemplate=new u({type:{parts:["allMyAppsModel>type","/allMyAppsMasterLevel"],formatter:this.formatListItemType},title:"{allMyAppsModel>title}",wrapping:true})}return this.oTemplate},_getSplitApp:function(){return this.getView().byId("sapUshellAllMyAppsMasterDetail")},_getDataSourceList:function(){return this.getView().byId("sapUshellAllMyAppsDataSourcesList")},_getCustomPanel:function(){return this.getView().byId("sapUshellAllMyAppsCustomPanel")},_getCustomPanelLabel:function(){return this.getView().byId("sapUshellAllMyAppsCustomPanelLabel")},_getCustomPanelLink:function(){return this.getView().byId("sapUshellAllMyAppsCustomPanelLink")}})});