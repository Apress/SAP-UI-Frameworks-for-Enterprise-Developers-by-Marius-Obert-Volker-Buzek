// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/UriParameters","sap/m/MessageBox","sap/m/MessageToast","sap/ui/core/Component","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/preprocessors/EventHistory","sap/ushell/plugins/BaseRTAPlugin","sap/ushell/appRuntime/ui5/plugins/baseRta/CheckConditions","sap/ushell/appRuntime/ui5/plugins/baseRta/Renderer"],function(t,i,e,n,o,s,a,r,l){"use strict";var u="PERSONALIZE_Plugin_ActionButton";var h=a.extend("sap.ushell.plugins.rta-personalize.Component",{sType:"rta-personalize",metadata:{manifest:"json",library:"sap.ushell"},init:function(){var t={sComponentName:"sap.ushell.plugins.rta-personalize",layer:"USER",developerMode:false,id:u,text:"PERSONALIZE_BUTTON_TEXT",icon:"sap-icon://edit",visible:false,checkRestartRTA:false};a.prototype.init.call(this,t);r.checkUI5App().then(function(t){var i=this.mConfig.visible&&t;return l.createActionButton(this,this._onAdapt.bind(this),i)}.bind(this)).then(this._checkForEnabledControls.bind(this))},removePersonalizableControl:function(t){var i=this._aPersonalizableControls.indexOf(t);this._aPersonalizableControls.splice(i,1);this._aOriginalFooterVisibility.splice(i,1);if(this._aPersonalizableControls.length===0){this._oObserver.disconnect();delete this._oObserver;this._adaptButtonVisibility(u,false)}},_checkForEnabledControls:function(){this._aPersonalizableControls=[];this._aOriginalFooterVisibility=[];function t(t){if(this._aPersonalizableControls.indexOf(t)===-1){this._aPersonalizableControls.push(t);r.checkUI5App().then(function(t){this._adaptButtonVisibility(u,t)}.bind(this))}}function i(i,e,n){if(o.checkControlId(n)){var s=this._getControlInstance(n);t.call(this,s);if(!this._oObserver){this._oObserver=new MutationObserver(function(t){this._aPersonalizableControls.forEach(function(t){if(!t.getDomRef()){this.removePersonalizableControl(t)}}.bind(this))}.bind(this));var a={attributes:true,childList:true,characterData:false,subtree:true,attributeFilter:["style","class"]};this._oObserver.observe(window.document,a)}}}sap.ui.getCore().getEventBus().subscribe("sap.ui","ControlForPersonalizationRendered",i,this);var e=s.getHistoryAndStop("ControlForPersonalizationRendered");e.forEach(function(t){i.call(this,t.channelId,t.eventId,t.parameters)}.bind(this))},_getControlInstance:function(t){if(typeof t==="string"){var i=sap.ui.getCore().byId(t);return i||n.get(t)}return t},_onAppLoaded:function(){var t=this._aPersonalizableControls.length;for(var i=t;i>0;i--){this.removePersonalizableControl(this._aPersonalizableControls[i-1])}},_onStartHandler:function(t){var e=t.getParameter("editablePluginsCount");if(e!==undefined&&e<=0){i.information(this.mConfig.i18n.getText("MSG_STARTUP_NO_OVERLAYS"),{onClose:function(){this.oTrigger.triggerStopRta(true,true)}.bind(this)})}},_loadPlugins:function(t){var i=new Promise(function(i){sap.ui.require(["sap/ui/rta/plugin/EasyAdd","sap/ui/rta/plugin/EasyRemove"],function(e,n){var o=t.getDefaultPlugins(),s=o.remove;o.remove=new n({commandFactory:s.getCommandFactory()});var a=o.additionalElements;o.additionalElements=new e({commandFactory:a.getCommandFactory()});o.contextMenu.setOpenOnClick(false);t.setPlugins(o);i()})});return i},_onAdapt:function(e){var n=e.getSource();if(n.getText()===this.mConfig.i18n.getText("PERSONALIZE_BUTTON_TEXT")){var o=t.fromURL(window.location.href),s=o.mParams["sap-ui-layer"]&&o.mParams["sap-ui-layer"][0];if(!s||s==="USER"){n.setText(this.mConfig.i18n.getText("END_PERSONALIZE_BUTTON_TEXT"));this._adaptButtonVisibility("RTA_Plugin_ActionButton",false);this._aPersonalizableControls.forEach(function(t){if(t.setShowFooter){this._aOriginalFooterVisibility.push(t.getShowFooter())}else{this._aOriginalFooterVisibility.push(undefined)}}.bind(this));this._adaptFooterVisibility(false);var r=this._getFlpSearchButton();this._bOriginalSearchButtonVisibility=r&&r.getVisible();if(this._bOriginalSearchButtonVisibility){this._adaptButtonVisibility(r,false)}a.prototype._onAdapt.call(this)}else{i.information(this.mConfig.i18n.getText("MSG_STARTUP_WRONG_LAYER"))}}else{this.oTrigger.triggerStopRta(false,true)}return Promise.resolve()},_switchToDefaultMode:function(){sap.ui.getCore().byId(u).setText(this.mConfig.i18n.getText("PERSONALIZE_BUTTON_TEXT"));this._adaptButtonVisibility("RTA_Plugin_ActionButton",true);this._adaptFooterVisibility(true);if(this._bOriginalSearchButtonVisibility!==undefined){this._adaptButtonVisibility(this._getFlpSearchButton(),this._bOriginalSearchButtonVisibility);delete this._bOriginalSearchButtonVisibility}e.show(this.mConfig.i18n.getText("SAVE_SUCCESSFUL"),{duration:4e3,offset:"0 -50"})},_adaptFooterVisibility:function(t){this._aPersonalizableControls.forEach(function(i,e){if(this._aOriginalFooterVisibility[e]){i.setShowFooter(t)}}.bind(this))},_getFlpSearchButton:function(){return this.oRenderer.getRootControl().getOUnifiedShell().getHeader().getHeadEndItems()[0]},_getFLPViewPort:function(){return sap.ui.getCore().byId("viewPortContainer")}});return h});