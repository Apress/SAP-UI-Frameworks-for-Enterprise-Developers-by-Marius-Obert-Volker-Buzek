/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/IconPool","./sapvbi"],function(t){"use strict";VBI.VisualObjects=function(){VBI.EMHandle=0;VBI.EMBox=1;VBI.HTHANDLE=0;VBI.HTBOX=1;VBI.HTBOXHANDLE=2;var e={};e.vbiclass="VisualObjects";e.Factory={"{00100000-2012-0004-B001-64592B8DB964}":function(){return new VBI.VisualObjects.Spot},"{00100000-2012-0004-B001-C46BD7336A1A}":function(){return new VBI.VisualObjects.Route},"{00100000-2013-0004-B001-7EB3CCC039C4}":function(){return new VBI.VisualObjects.Circle},"{00100000-2013-0004-B001-686F01B57873}":function(){return new VBI.VisualObjects.CircleDist},"{00100000-2012-0004-B001-383477EA1DEB}":function(){return new VBI.VisualObjects.Pie},"{00100000-2012-0004-B001-BFED458C3076}":function(){return new VBI.VisualObjects.Box},"{00100000-2012-0004-B001-F311DE491C77}":function(){return new VBI.VisualObjects.Area},"{00100000-2012-0004-B001-E180770E8A12}":function(){return new VBI.VisualObjects.HeatMap},"{00100000-2012-0070-1000-35762CF28B6B}":function(){return new VBI.VisualObjects.Dummy},"{388951f5-a66b-4423-a5ad-e0ee13c2246f}":function(){return new VBI.VisualObjects.Dummy},"{00100000-2014-0004-B001-9F1B43BE944A}":function(){return new VBI.VisualObjects.Route},"{00100000-2014-0004-BDA8-87B904609063}":function(){return new VBI.VisualObjects.Area},"{00100000-2012-0004-B001-2297943F0CE6}":function(){return new VBI.VisualObjects.Container},"{00100000-2013-1000-1100-50059A6A47FA}":function(){return new VBI.VisualObjects.Caption},"{00100000-2013-1000-3700-AD84DDBBB31B}":function(){return new VBI.VisualObjects.Label},"{00100000-2013-1000-2400-D305F7942B98}":function(){return new VBI.VisualObjects.Link},"{00100000-2013-1000-2200-6B060A330B2C}":function(){return new VBI.VisualObjects.Image},"{00100000-2013-1000-1200-855B919BB0E9}":function(){return new VBI.VisualObjects.Button}};e.Factory3D={"{00100000-2012-0004-B001-BFED458C3076}":function(){return new VBI.VisualObjects.Box3D},"{00100000-2012-0070-1000-35762CF28B6B}":function(){return new VBI.VisualObjects.Dummy}};e.Factory.CreateInstance=function(t){return e.Factory[t]()};e.Factory3D.CreateInstance=function(t){return e.Factory3D[t]()};VBI.VisualObjects.Base={m_Scene:null,m_BB:[],m_IO:[],m_colorHot:"rgba( 240, 171, 0, 0.5 )",m_defaultColor:"rgba( 255, 0, 0, 1.0 )",m_defaultTooltip:"",m_defaultLabeltext:"",m_defaultLabelBgCol:"rgba(200,200,200,1.0)",m_DH:[],m_szHandle:6,m_Track:null,m_tt:"",m_pos:"",m_clientX:0,m_clientY:0,m_nActiveSelections:0,SetRichTooltip:function(t){var e=this.m_Scene;var i=this.m_Scene.m_Ctx;var r=this.m_Pos!=null?this.m_Pos.GetValueVector(i):this.m_PosM.GetValueVector(i);if(this.m_tt instanceof sap.ui.core.TooltipBase){if(t){if(this.m_tt!=""&&this.m_pos==""){e.SetToolTip(this.m_tt,true,this.m_clientX,this.m_clientY);this.m_pos=r}}else if(JSON.stringify(this.m_pos)==JSON.stringify(r)){e.SetToolTip(this.m_tt,false);this.m_pos=""}}},SetClusteredRichTooltip:function(t){var e=this.m_Scene;var i=[t[0],t[1]];if(this.m_tt instanceof sap.ui.core.TooltipBase){if(t.h){if(this.m_tt!=""&&t.m_pos==undefined){e.SetToolTip(this.m_tt,true,this.m_clientX,this.m_clientY);t.m_pos=i}}else if(JSON.stringify(t.m_pos)==JSON.stringify(i)){e.SetToolTip(this.m_tt,false);t.m_pos=undefined}}},LoadDragDropInfo:function(t,e,i){if(t.DragSource&&t.DragSource.DragItem){i.m_DragSourceInfo=new VBI.DnDInfo;i.m_DragSourceInfo.load(t.DragSource.DragItem,e,i)}if(t.DropTarget&&t.DropTarget.DropItem){i.m_DropTargetInfo=new VBI.DnDInfo;i.m_DropTargetInfo.load(t.DropTarget.DropItem,e,i)}},BaseLoad:function(t,e,i){if(VBI.m_bTrace){VBI.Trace("BaseLoad")}i.m_Props.push(i.m_HotScale=new VBI.AttributeProperty(t,"hotScale",i.m_DataSource,e,[1,1,1]));i.m_Props.push(i.m_HotDeltaColor=new VBI.AttributeProperty(t,"hotDeltaColor",i.m_DataSource,e,null));i.m_Props.push(i.m_SelectColor=new VBI.AttributeProperty(t,"selectColor",i.m_DataSource,e,null));i.m_Props.push(i.m_NonSelectColor=new VBI.AttributeProperty(t,"nonSelectColor",i.m_DataSource,e,null));i.m_Props.push(i.m_FxSize=new VBI.AttributeProperty(t,"fxsize",i.m_DataSource,e,true));i.m_Props.push(i.m_FxDir=new VBI.AttributeProperty(t,"fxdir",i.m_DataSource,e));i.m_Props.push(i.m_Entity=new VBI.AttributeProperty(t,"entity",i.m_DataSource,e,null));i.m_Props.push(i.m_Labeltext=new VBI.AttributeProperty(t,"labelText",i.m_DataSource,e,i.m_defaultLabeltext));i.m_Props.push(i.m_LabelBgCol=new VBI.AttributeProperty(t,"labelBgColor",i.m_DataSource,e,i.m_defaultLabelBgCol));i.m_Props.push(i.m_LabelBrdrCol=new VBI.AttributeProperty(t,"labelBorderColor",i.m_DataSource,e,null));i.m_Props.push(i.m_LabelArrow=new VBI.AttributeProperty(t,"labelArrow",i.m_DataSource,e,false));i.m_Props.push(i.m_LabelRounded=new VBI.AttributeProperty(t,"labelRounded",i.m_DataSource,e,false));i.m_Props.push(i.m_LabelPos=new VBI.AttributeProperty(t,"labelPos",i.m_DataSource,e));i.m_Props.push(i.m_LabelOffset=new VBI.AttributeProperty(t,"labelOffset",i.m_DataSource,e,[0,0]));i.m_Props.push(i.m_LabelIcon=new VBI.AttributeProperty(t,"labelIcon",i.m_DataSource,e));i.m_Props.push(i.m_LabelIcBgrdCol=new VBI.AttributeProperty(t,"labelIconBgrdCol",i.m_DataSource,e));i.m_Props.push(i.m_LabelIcTextCol=new VBI.AttributeProperty(t,"labelIconTextCol",i.m_DataSource,e));i.m_Props.push(i.m_DragData=new VBI.AttributeProperty(t,"dragdata",i.m_DataSource,e,null));if(!VBI.m_bIsMobile){this.LoadDragDropInfo(t,e,i)}},BaseMousemove:function(t){if(VBI.m_bTrace){VBI.Trace("BaseMousemove")}if(this.m_Track){return false}if(!this.GetHitArray){return false}if(this.m_Scene.vbiclass=="3DScene"){return false}var e=this.GetHitArray(t.offsetX,t.offsetY);var i=this.m_Scene;if(e.length>0){i.SetCursor("pointer");if(i.InternalSetHotItem(this,e[0])){if(!e[0].m_Design&&this.m_Tooltip){this.m_tt=this.getTooltip(i.m_Ctx,e[0]);if(VBI.m_bIsRtl){var r=i.GetEventVPCoords(t);this.m_clientX=r[0]}else{this.m_clientX=t.clientX}this.m_clientY=t.clientY;var a=this.m_tt.split("#");if(a[0]=="rtt"){var s=a[1];this.m_tt=sap.ui.vbm.VBI.RttMap[s]}else{i.SetToolTip(this.m_tt)}}var n;if(n=this.DetailCursor(t,e[0])){i.SetCursor(n)}}if(this.m_DragSourceInfo){i.m_Canvas[i.m_nLabelIndex].draggable=true}}else if(i.m_Canvas[i.m_nLabelIndex].draggable==true){i.m_Canvas[i.m_nLabelIndex].draggable=false}return e.length>0?true:false},BaseContextmenu:function(t){if(VBI.m_bTrace){VBI.Trace("BaseContextmenu")}if(!this.GetHitArray){return false}var e=this.m_Scene;if(e.vbiclass=="3DScene"){return false}if(t.hitTests){t.hitTests=t.hitTests.concat(this.GetHitArray(t.offsetX,t.offsetY,true));return t.hitTests.length>0}var i=t.hitCached?t.hitCached:this.GetHitArray(t.offsetX,t.offsetY,false)[0];if(!i){return false}var r=this.GetDataIndex(i.m_Index);var a,s=e.m_Ctx.m_Actions;var n;var o=this.m_DataSource.GetIndexedElement(e.m_Ctx,r);if(o){if(s&&i.m_Design&&i.m_Hit==VBI.HTHANDLE){if(a=s.findAction("HandleContextMenu",e,this)){var l=e.GetEventVPCoordsObj(t);l.handle=i.m_Handle.toString();e.m_Ctx.FireAction(a,e,this,o,l);t.preventDefault();return true}}if(this.DetailContextmenu(t,o,i)){t.preventDefault();return true}}else{var h=this.m_BBRefs[i.m_Index];n=e.m_Ctx.m_Clustering.getClusterIdent(e.m_PreassembledData,h.cI,h.i);o=this.GetPreassembledElement(i.m_Index)}if(s){if(a=s.findAction("ContextMenu",e,this)){e.m_Ctx.FireAction(a,e,this,o,e.GetEventVPCoordsObjWithScene(t),n,null,i);t.preventDefault();return true}}t.preventDefault();return false},BaseFindAction:function(t){var e=this.m_Scene,i=e.m_Ctx.m_Actions;return i?i.findAction(t,e,this):null},BaseClick:function(t){if(VBI.m_bTrace){VBI.Trace("BaseClick")}if(!this.GetHitArray){return false}var e=this.m_Scene;if(e.vbiclass=="3DScene"){return false}if(t.hitTests){t.hitTests=t.hitTests.concat(this.GetHitArray(t.offsetX,t.offsetY,true));return t.hitTests.length>0}var i=t.hitCached?t.hitCached:this.GetHitArray(t.offsetX,t.offsetY,false)[0];if(!i){return false}var r=this.GetDataIndex(i.m_Index);e.RenderAsync(false);var a;var s;if(r>=0&&(a=this.m_DataSource.GetIndexedElement(e.m_Ctx,r))){this.m_DataSource.Select(r);if(t.type.indexOf("touch")>=0||(t.type.indexOf("pointer")>=0||(t.ctrlKey||t.metaKey)&&!t.shiftKey)){this.Select(a,e.m_Ctx,this.IsSelected(e.m_Ctx)?false:true)}else if(t.shiftKey){if(!this.IsSelected(e.m_Ctx)){this.Select(a,e.m_Ctx,true)}}else{this.m_nActiveSelections=a.GlobalSingleSelect()}if(e.m_PreassembledData){e.UpdatePreData4Selected(this.m_nPreDataIndex,this.GetInternalIndex(i.m_Index))}if(i.m_Handle>=0){t.preventDefault();return true}else if(this.IsPosChangeable(e.m_Ctx)){var n=this.m_DataSource.GetEditMode(e.m_Ctx)==VBI.EMHandle?VBI.EMBox:VBI.EMHandle;if(VBI.m_bTrace){VBI.Trace("SetEditMode: "+n)}this.m_DataSource.SetEditMode(e.m_Ctx,n);t.preventDefault();return true}if(this.DetailClick(t,a,i)){t.preventDefault();return true}}else{var o=this.m_BBRefs[i.m_Index];s=e.m_Ctx.m_Clustering.getClusterIdent(e.m_PreassembledData,o.cI,o.i);a=this.GetPreassembledElement(i.m_Index)}var l;if(l=e.m_Ctx.m_Actions){var h;if(h=l.findAction("Click",e,this)){this.m_Scene.m_Ctx.FireAction(h,e,this,a,e.GetEventVPCoordsObj(t),s,null,i);t.preventDefault();return true}}return false},GetPreassembledElement:function(t){return undefined},BaseHitTest:function(t,e,i){var r=[];var a={};if(this.BaseDesignHitTest(t,e,a)){r.push(a);return r}var s=new Map;var n=this.getLabelData(false);if(n){for(var o=n.length-1;o>=0;--o){var l=n[o];var h=VBI.Types.string2rgba(l.m_BgColor);if(h[3]<.1&&h[4]==1){continue}for(var m=0;m<l.m_Pos.length;++m){for(var u=0;u<l.m_Pos[m].length;++u){var _=[t,e];var c=l.m_Pos[m][u][0];var f=l.m_Pos[m][u][1];var d=l.m_Pos[m][u].tri;var v=l.m_Pos[m][u].rc;var p=[c,f,c+l.m_Width,f+l.m_Height];if(VBI.Utilities.PtInRect(_,p)||d&&VBI.Utilities.pointInTriangle(d,_)||v&&VBI.Utilities.PtInRect(_,v)){var I={m_Vo:this,m_Index:l.mIndex,m_Entity:this.GetEntity(l.mIndex,this.m_Scene.m_Ctx)};if(i.m_All){s.set(I.m_Index,I)}else{r.push(I)}if(!i.m_All){return r}}}}}}for(var o=this.m_BB.length-1;o>=0;--o){var B=this.m_BB[o];if(B){for(var m=this.m_IO[o].length-1;m>=0;--m){var g=this.m_IO[o][m];if(!VBI.Utilities.PtInRect([t-g,e],B)){continue}if(i){var S=i.m_cb(i,o,t-g,e);if(S&&S.m_hit>0){var I={m_Vo:this,m_Index:o,m_Entity:this.GetEntity(o,this.m_Scene.m_Ctx),m_Detail:S,m_IO:g};if(i.m_All){s.set(I.m_Index,I)}else{r.push(I)}if(!i.m_All&&S.m_hit==1){return r}}}}}}if(i.m_All){s.forEach(function(t){r.push(t)})}return r},clear:function(){var t;if(this.m_Props){for(t=0;t<this.m_Props.length;++t){this.m_Props[t].clear()}this.m_Props=null}if(this.m_DragSourceInfo){this.m_DragSourceInfo.clear();this.m_DragSourceInfo=null}if(this.m_DropTargetInfo){this.m_DropTargetInfo.clear();this.m_DropTargetInfo=null}this.m_Scene=null;this.m_Track=null;this.m_BB=null;this.m_IO=null;this.m_DH=null;if(this.m_Label){for(t=0;t<this.m_Label.length;++t){this.m_Label[t].clear()}this.m_Label=[]}},load:function(t,e){if(t.id){this.m_ID=t.id}this.m_Props=[];this.m_DragSourceInfo=null;this.m_DropTargetInfo=null},NotifyDataChange:function(t){if(this.m_Props){for(var e=0,i=this.m_Props.length;e<i;++e){this.m_Props[e].NotifyDataChange(t)}}this.m_bChanged=true;this.m_nActiveSelections=undefined},IsPosChangeable:function(t){if(VBI.m_bMouseSupported&&this.m_Pos){return this.m_Pos.IsChangeable(t)}return false},IsSelected:function(t){if(this.m_DataSource){return this.m_DataSource.IsElementSelected(t)}return false},GetNumActiveSelections:function(t){if(this.m_nActiveSelections===undefined){this.m_nActiveSelections=0;var e=this.m_DataSource.m_nCurElement;var i=this.m_DataSource.GetCurrentNode(t);if(i){for(var r=0,a=i.m_dataelements.length;r<a;++r){this.m_DataSource.Select(r);if(this.IsSelected(t)){this.m_nActiveSelections++}}}this.m_DataSource.Select(e)}return this.m_nActiveSelections},Select:function(t,e,i){this.m_nActiveSelections=t.Select(i,this.GetNumActiveSelections(e))},IsHandleMode:function(){return this.m_DataSource.GetEditMode(this.m_Scene.m_Ctx)==VBI.EMHandle?true:false},IsBoxMode:function(){return this.m_DataSource.GetEditMode(this.m_Scene.m_Ctx)==VBI.EMBox?true:false},IsDataAccepted:function(t){var e=this.m_Scene;if(this.m_Track){if(VBI.m_bTrace){VBI.Trace("Error: Track object should be already gone")}return false}if(!this.GetHitArray){return false}var i,r=this.GetHitArray(t.offsetX,t.offsetY);if(r.length&&(i=r[0]).m_Design){return false}if(r.length&&e.m_DragInfo){this.m_DataSource.Select(i.m_Index);if(this.m_DropTargetInfo){var a=e.m_Ctx;var s=this.m_DropTargetInfo.getItemArray(a);var n=e.m_DragInfo.aItems;for(var o=0;o<s.length;++o){if(n.indexOf(s[o])!=-1){try{t.dataTransfer.dropEffect="copy";t.stopPropagation();t.preventDefault()}catch(t){if(VBI.m_bTrace){VBI.Trace("Warning: sapvobase.IsDataAccepted exception occured: "+t.message)}}return i}}}}return false},GetEntity:function(t,e){this.m_DataSource.Select(t);return this.m_Entity.GetValueString(e)},IsHot:function(t){var e=this.m_Scene,i=e.m_HotItem;if(i.m_Entity&&i.m_Entity==this.m_Entity.GetValueString(e.m_Ctx)){return true}if(!i.m_HitObj||i.m_Index!=t){return false}if(i.m_Design){return false}if(i.m_VO!=this){return false}return true},InternalChangeHotItem:function(t,e){},IsClusterable:function(){return false},GetDataIndex:function(t){return t},GetInternalIndex:function(t){return t},getTooltip:function(t,e){this.m_DataSource.Select(e.m_Index);return this.m_Tooltip.GetValueString(t)},getLabelText:function(t,e){this.m_DataSource.Select(e.m_Index);return this.m_Labeltext.GetValueString(t)},getLabelData:function(t){if(!this.m_Label){return null}if(t){for(var e=0;e<this.m_Label.length;e++){var i=this.m_Label[e];if(i.CalculateLabelPos&&i.m_PosArray.pa.length>0){i.m_Pos=[];for(var r=0;r<i.m_aIO.length;r++){var a=this.CalculateLabelPos(this.m_Scene,i.m_PosArray,i.m_aIO[r]);if(a&&a.length>0){i.m_Pos.push(a)}}i.m_bAligned=false}}}return this.m_Label},SwitchPreDataRendering:function(t){if(this.bUsePreData!=t){this.bUsePreData=t;if(t){this.IsHot=this.PreDataIsHot;this.GetEntity=this.PreDataGetEntity}else{this.IsHot=this.BaseIsHot;this.GetEntity=this.BaseGetEntity}}},GetAnimClusterDistance:function(t,e){var i=this.m_Scene;var r=t-e;if(r&&i.m_bNonIntPosStable){var a=1e3*r;var s=Date.now()-i.m_bNonIntPosStable;r*=s<a?(a-s)/a:0}i.m_bLineAnimationRunning=r>0;return r},RenderTree:function(t,e,i,r,a,s,n,o,l,h,m,u,_){var c=[h*t.bo[0]-m,h*t.bo[1]-u,h*t.bo[2]-m,h*t.bo[3]-u];var f=this.m_Scene.GetInstanceOffsets(c);if(f.length){if(t.lod<s){for(var d=0;d<t.bw.length;++d){a=this.RenderTree(t.bw[d],e,i,r,a,s,n,o,l,h,m,u,_)}}else if(t.isCl){if(this.RenderThisInstance(t,e,i,r,a,t.nJ,o,l,s,n,h,m,u,false)){a++}}else if(!_){var v=this.m_Scene.m_VOS[t.vo];v.RenderThisInstance(t,e,i,r,v.m_BB.length,t.nJ,o,l,s,n,h,m,u,true);v.SetClusteredRichTooltip(t)}}return a},Init4Render:function(){},StandardInit:function(){this.m_BB=[];this.m_IO=[];this.m_DH=[]},StandardInitWithLPs:function(){this.m_BB=[];this.m_IO=[];this.m_DH=[];this.m_LP=[]},BaseRender:function(t,e){var i=this.m_DH.length;if(!i){return}var r,a,s;var n=this.m_szHandle,o=n/2,l=1.5*n*n;var h=e.fillStyle;var m="rgba(232,205,30,0.7)";var u="rgba(188,54,24,0.7)";var _="rgba(229, 66, 30, 1.0 )";var c=this.m_Scene.m_HotItem;var f,d,v=false;for(var p=0;p<i;++p){if(!(f=this.m_DH[p])){continue}for(var I=0,B=this.m_IO[p].length;I<B;++I){e.setTransform(1,0,0,1,this.m_IO[p][I],0);if(f.m_EditMode==VBI.EMBox){if(f.length==1){d=f[0];VBI.Utilities.DrawDesignRect(e,this.DesignGetActiveBoxHandles(p),d)}}else{e.fillStyle=u;e.lineWidth=1;r=null;if(v){e.fillStyle=u;v=false}for(var g=0,S=f.length;g<S;++g){d=f[g];var b=c.m_VO==this&&c.m_Index==p&&c.m_Design&&c.m_HitObj&&c.m_HitObj.m_Handle==g;if(r&&(a=r[0]-d[0])*a+(s=r[1]-d[1])*s<l){if(!v){v=true;e.fillStyle=b?_:m;e.fill()}continue}if(v){e.fillStyle=u;v=false}if(b){e.fillStyle=_}e.beginPath();e.rect(d[0]-o,d[1]-o,n,n);e.closePath();e.fill();if(b){e.fillStyle=u}r=d}}}}e.fillStyle=h;e.setTransform(1,0,0,1,0,0)},BaseDesignHitTest:function(t,e,i){if(VBI.m_bTrace){VBI.Trace("BaseDesignHitTest nsx:"+t+" nsy:"+e+" instance:"+this.m_ID)}var r=this.m_DH.length;if(!r){return false}var a=this.m_szHandle+2,s=a/2;var n=VBI.Utilities.PtInRect;if(i.m_Handle){delete i.m_Handle}var o,l;for(var h=r;h>=0;--h){if(!(o=this.m_DH[h])){continue}for(var m=0;m<this.m_IO[h].length;++m){var u=this.m_IO[h][m];if(o.m_EditMode==VBI.EMHandle){if(VBI.m_bTrace){VBI.Trace("BaseDesignHitTest Handle")}for(var _=0,c=o.length;_<c;++_){l=o[_];if(n([t-u,e],[l[0]-s,l[1]-s,l[0]+s,l[1]+s])){if(VBI.m_bTrace){VBI.Trace("BaseDesignHitTest Handle Hit! Index:"+h+" Handle: "+_)}i.m_Index=h;i.m_Design=true;i.m_Hit=VBI.HTHANDLE;i.m_Handle=_;i.m_NsX=t;i.m_NsY=e;i.m_IO=u;return true}}}else if(o.m_EditMode==VBI.EMBox){if(VBI.m_bTrace&&(o.length>1||o.length==0)){VBI.Trace("Error: Box edit mode must fill one rectangle only")}l=o[0];if(VBI.m_bTrace){VBI.Trace("BaseDesignHitTest Box")}var f=9;var d=l[2]-l[0];var v=l[3]-l[1];var p=d/2;var I=v/2;var B=this.DesignGetActiveBoxHandles(h);for(var g=0;g<3;++g){for(var S=0;S<3;++S){if(g==1&&S==1){continue}if(!B[S*3+g]){continue}var b=l[0]+g*p-(t-u);var V=l[1]+S*I-e;if(b*b+V*V<f){i.m_Index=h;i.m_Handle=S*3+g;i.m_Design=true;i.m_Hit=VBI.HTBOXHANDLE;i.m_NsX=t;i.m_NsY=e;i.m_IO=u;return true}}}if(n([t-u,e],l)){if(VBI.m_bTrace){VBI.Trace("BaseDesignHitTest Box Hit! Index:"+h)}i.m_Index=h;i.m_Handle=-1;i.m_Design=true;i.m_Hit=VBI.HTBOX;i.m_NsX=t;i.m_NsY=e;i.m_IO=u;return true}}}}return false},DesignHandleDrag:function(t,e){var i=this.m_Scene;if(VBI.m_bTrace){VBI.Trace("DesignHandleDrag")}if(VBI.m_bTrace&&i.m_nInputMode!=VBI.InputModeTrackObject){VBI.Trace("Error: DesignHandleDrag wrong input mode: "+i.m_nInputMode)}if(t.m_ClientX!=t.m_ClientStartX||t.m_ClientY!=t.m_ClientStartY){t.m_bDragStart=true}if(t.m_bDragStart){this.m_DataSource.Select(t.m_Index);var r=i.GetPosFromPoint([t.m_ClientX-t.m_IO,t.m_ClientY,0]);var a=i.GetPosFromPoint([t.m_ClientStartX-t.m_IO,t.m_ClientStartY,0]);if(this.IsPosChangeable(i.m_Ctx)){var s=this.m_Pos.GetValueVector(i.m_Ctx).slice(0);var n=t.m_PosOrig;var o;if(t.hasOwnProperty("m_Handle")){if(VBI.m_bTrace){VBI.Trace("DesignHandleDrag Handle")}if(t.m_Hit==VBI.HTHANDLE){o=t.m_Handle*3;s[o]=r[0];s[o+1]=r[1];this.m_Pos.SetValueVector(i.m_Ctx,s)}else if(t.m_Hit==VBI.HTBOXHANDLE){if(this.DesignBoxSize){this.DesignBoxSize(t)}}else if(t.m_Hit==VBI.HTBOX){if(VBI.m_bTrace){VBI.Trace("DesignHandleDrag Box")}var l=r[0]-a[0];var h=r[1]-a[1];for(var m=0,u=s.length/3;m<u;++m){o=m*3;s[o]=n[o]+l;s[o+1]=n[o+1]+h}this.m_Pos.SetValueVector(i.m_Ctx,s)}}}}i.RenderAsync(true)},DesignHandleDrop:function(t,e){var i=this.m_Scene;if(VBI.m_bTrace&&i.m_nInputMode!=VBI.InputModeTrackObject){VBI.Trace("Error: DesignHandleDrop wrong input mode: "+i.m_nInputMode)}var r,a=i.m_Ctx.m_Actions;if(a&&t.m_Design&&(t.m_Handle>-1||t.m_Hit===VBI.HTBOX)){var s=t.m_bDragStart?"HandleMoved":"HandleClick";if(r=a.findAction(s,i,this)){var n;if(n=this.m_DataSource.GetIndexedElement(i.m_Ctx,t.m_Index)){var o=i.GetEventVPCoordsObj(e);o.handle=t.m_Handle.toString();o.mode=t.m_Hit.toString();i.m_Ctx.FireAction(r,i,this,n,o)}}}i.SetInputMode(VBI.InputModeDefault);i.RenderAsync(true);return true},DesignHandleEnd:function(t,e){this.m_Track.UnHook();this.m_Track=null},DesignGetActiveBoxHandles:function(t){return[1,1,1,1,0,1,1,1,1]},onsapsecclick:function(t){return this.BaseContextmenu(t)},onsapclick:function(t){return this.BaseClick(t)},onsapmove:function(t){return this.BaseMousemove(t)},onsapup:function(t){if(!this.m_Track){return false}this.m_Track.UnHook();this.m_Track=null},onsapdrop:function(t){if(VBI.m_bTrace){VBI.Trace("onsapdrop in base "+t.type)}var e;if(e=this.IsDataAccepted(t)){var i=this.m_Scene;var r=this.GetDataIndex(e.m_Index);var a=this.m_DataSource.GetIndexedElement(i.m_Ctx,r);var s,n=i.m_Ctx.m_Actions;if(n){if(s=n.findAction("Drop",i,this)){this.m_Scene.m_Ctx.FireAction(s,i,this,a,i.GetEventDropObjWithScene(t));t.preventDefault();return true}}return false}return false},onsapdrag:function(t){if(VBI.m_bTrace){VBI.Trace("onsapdrag in base "+t.type)}if(this.IsDataAccepted(t)){return true}return false},onsapdown:function(t){if(VBI.m_bTrace){VBI.Trace("onsapdown in base "+t.type)}var e=this.m_Scene;if(this.m_Track){if(VBI.m_bTrace){VBI.Trace("Error: Track object should be already gone")}return true}if(e.vbiclass=="3DScene"){return false}if(!this.GetHitArray){return false}var i,r=this.GetHitArray(t.offsetX,t.offsetY);if(r.length&&(i=r[0]).m_Design){if(VBI.m_bTrace){VBI.Trace("Start Tracking on "+this.m_ID+" caused by "+t.type)}this.m_DataSource.Select(i.m_Index);i.m_CBDrag=this.DesignHandleDrag.bind(this);i.m_CBDrop=this.DesignHandleDrop.bind(this);i.m_CBEnd=this.DesignHandleEnd.bind(this);i.m_ClientStartX=t.offsetX;i.m_ClientStartY=t.offsetY;i.m_bDragStart=false;i.m_PosOrig=e.GetNearestPosArray(this.m_Pos.GetValueVector(e.m_Ctx).slice(0));e.SetInputMode(VBI.InputModeTrackObject);e.SetCursor(this.DetailCursor(t,i));if(this.DesignBeginDrag){this.DesignBeginDrag(i)}this.m_Track=new e.DesignTrack(i);t.stopPropagation();t.preventDefault();return true}if(r.length){this.m_DataSource.Select(i.m_Index);if(this.m_DragSourceInfo&&!this.m_Pos.IsChangeable(e.m_Ctx)){var a=e.m_Ctx;var s=this.m_DragSourceInfo.getItemArray(a);if(s.length){e.m_DragInfo={};e.m_DragInfo.aItems=s;e.m_DragInfo.strInstance=this.m_DataSource.m_Path+"."+this.m_DataSource.GetCurrentElement().GetKeyValue();e.m_DragInfo.strScene=this.m_Scene.m_ID;e.m_DragInfo.strID=this.m_ID;e.m_DragInfo.strExtData=this.m_DragData.GetValueString(e.m_Ctx);e.m_DragInfo.bDragStart=false;return true}}}return false},DetailClick:function(t,e,i){return false},DetailContextmenu:function(t,e,i){return false},DetailCursor:function(t,e){if(e.m_Design){if(e.m_Hit==VBI.HTBOXHANDLE){var i=["nw-resize","n-resize","ne-resize","w-resize","","e-resize","sw-resize","s-resize","se-resize"];return i[e.m_Handle]}else if(e.m_Hit==VBI.HTBOX){return"move"}}return"pointer"},GetSelectColor:function(t,e){var i;if(i=this.m_SelectColor.GetValueString(t)){return this.ApplyDeltaColor(t,e,i)}else{return e}},GetNonSelectColor:function(t,e){var i;if(i=this.m_NonSelectColor.GetValueString(t)){return this.ApplyDeltaColor(t,e,i)}else{return e}},GetHotColor:function(t,e){var i;if(i=this.m_HotDeltaColor.GetValueString(t)){return this.ApplyDeltaColor(t,e,i)}else{return this.m_colorHot}},GetAltBorderColor:function(t,e){var i;if(i=this.m_AltColorBorder.GetValueString(t)){return this.ApplyDeltaColor(t,e,i)}else{return this.GetHotColor(t,e)}},ApplyDeltaColor:function(t,e,i){var r;var a=e+i;if(t.m_deltacolTable[a]==undefined){if(r=VBI.Types.string2rhls(i)){var s;if(s=VBI.Types.color2array(e)){var n=VBI.Utilities.RGB2HLS(s[0],s[1],s[2]);var o=VBI.Utilities.HLS2RGB(n[0]+r[0],n[1]*r[1],n[2]*r[2]);t.m_deltacolTable[a]="rgba("+Math.min(Math.round(o[0]),255)+","+Math.min(Math.round(o[1]),255)+","+Math.min(Math.round(o[2]),255)+","+Math.min((r[3]*s[3]).toString(),1)+")"}}else{t.m_deltacolTable[a]=VBI.Types.string2color(i)}}return t.m_deltacolTable[a]},GetHotScale:function(t){var e;if(e=this.m_HotScale.GetValueVector(t)){return e}return[1,1,1]},RectSelect:function(t,e,i){var r,a,s=false;for(var n=this.m_BB.length-1;n>=0;--n){if(r=this.m_BB[n]){for(var o=this.m_IO[n].length-1;o>=0;--o){var l=this.m_IO[n][o];a=[t[0]-l,t[1],t[2]-l,t[3]];if(r[0]>=a[0]&&r[1]>=a[1]&&r[2]<=a[2]&&r[3]<=a[3]){i.push(n);e.push(this.GetDataIndex(n));s=true}}}}return s},LassoSelectCircle:function(t,e,i){var r=[];var a,s;var n=false;for(var o=this.m_BB.length-1;o>=0;--o){var l=[];var h=this.m_BB[o].m_Pos;var m=this.m_BB[o].m_Radius;var u=20;for(var _=0;_<u;++_){s=_*2*Math.PI/u;r=[h[0]+m*Math.sin(s),h[1]+m*Math.cos(s)];l.push(r)}a=this.m_IO[o];if(VBI.Utilities.polyInPolygon(t,l,a)){e.push(o);i.push(o);n=true}}return n},LassoSelect:function(t,e,i){var r;var a=false,s=false;var n,o;for(var l=this.m_BB.length-1;l>=0;--l){if(r=this.m_BB[l]){a=false;for(var h=this.m_IO[l].length-1;h>=0&&!a;--h){var m=this.m_IO[l][h];var u=[[r[0]+m,r[1]],[r[2]+m,r[1]],[r[2]+m,r[3]],[r[0]+m,r[3]]];if(VBI.Utilities.pointInPolygon(t,u[0][0],u[0][1])){a=true;for(n=0;n<u.length&&a;n+=2){var _=u[n];var c=u[n+1];for(o=0;o<t.length&&a;++o){var f=t[o];var d=o+1==t.length?t[0]:t[o+1];VBI.Utilities.LineLineIntersection(_,c,f,d,true);if(VBI.Utilities.LineLineIntersection(_,c,f,d,true)){a=false}}}}}if(a){i.push(l);e.push(this.GetDataIndex(l));s=true}}}return s},GetLabel:function(t){var e={};var i=this.m_Labeltext.GetValueString(t);var r=this.m_LabelIcon.GetValueString(t);if(i||r){e.text=i;e.icon=r;e.icColor=this.m_LabelIcBgrdCol.GetValueColor(t);e.icTextColor=this.m_LabelIcTextCol.GetValueColor(t);e.bgColor=this.m_LabelBgCol.GetValueColor(t);e.brdrCol=this.m_LabelBrdrCol.GetValueColor(t);e.arrow=this.m_LabelArrow.GetValueBool(t);e.rounded=this.m_LabelRounded.GetValueBool(t);e.offset=this.m_LabelOffset.GetValueVector(t);e.Align=this.m_LabelPos.GetValueLong(t);return e}else{return null}},RenderShadowDot:function(t,e,i,r,a,s,n){if(e.isCl){for(var o=e.bw.length;o--;){this.RenderShadowDot(t,e.bw[o],i,r,a,s,n)}}else{t.beginPath();t.moveTo(n[0]*(i*e[0]-r-s),n[1]*(i*e[1]-a-s));t.lineTo(n[0]*(i*e[0]-r+s),n[1]*(i*e[1]-a-s));t.lineTo(n[0]*(i*e[0]-r+s),n[1]*(i*e[1]-a+s));t.lineTo(n[0]*(i*e[0]-r-s),n[1]*(i*e[1]-a+s));t.closePath();t.stroke()}},GetRefBorders:function(t,e,i,r){var a=this.m_Scene.m_Canvas[0].m_nExactLOD;var s=a==Math.floor(a)?1:.5;var n,o,l=e;var h=i;if(t.isCl==1){var m=t.e[0][0],u=t.e[2][0];n=(m[0]+u[0])/2;o=(m[1]+u[1])/2;l=1.2*r*Math.max(u[0]-m[0],u[1]-m[1])}else{n=(t.bo[0]+t.bo[2])/2;o=(t.bo[1]+t.bo[3])/2}var _=s*l/r;var c=[n-_,n+_,o-_,o+_];var f=t;while(f.c!=undefined){l*=1<<h-f.c.lod;h=f.c.lod;f=f.c;n=(f.bo[0]+f.bo[2])/2;o=(f.bo[1]+f.bo[3])/2;_=l/r;c=[Math.max(c[0],n-_),Math.min(c[1],n+_),Math.max(c[2],o-_),Math.min(c[3],o+_)]}return c},GetNextPoint:function(t,e,i,r,a){var s,n;if(r!=0){var o=r<0?0:1;s=(t[0]-i[o])/(t[0]-e[0]);var l=t[1]+s*(e[1]-t[1]);if(a==0||l>=i[2]&&l<=i[3]){return[i[o],l,true]}n=a<0?2:3;s=(t[1]-i[n])/(t[1]-e[1]);return[t[0]+s*(e[0]-t[0]),i[n],false]}if(a!=0){n=a<0?2:3;s=(t[1]-i[n])/(t[1]-e[1]);return[t[0]+s*(e[0]-t[0]),i[n],false]}},CheckNextLinePoint:function(t,e,i,r){var a=r<2;var s=a?0:1;var n=1-s;var o=(t[s]-i[r])/(t[s]-e[s]);if(o<=0||o>1){return undefined}var l=t[n]+o*(e[n]-t[n]);if(l<i[2*n]||l>i[2*n+1]){return undefined}return a?[i[r],l]:[l,i[r]]},paintLineList:function(t,e,i,r,a,s){var n;for(var o=0;o<4;++o){var l=e[o];for(var h=0;h<l.length;++h){if(n==undefined){t.moveTo(s[0]*(i*l[h][0]-r),s[1]*(i*l[h][1]-a));n=true}else{t.lineTo(s[0]*(i*l[h][0]-r),s[1]*(i*l[h][1]-a))}}}},GetNextLinePoint:function(t,e,i,r,a){var s;var n=a?0:1;var o=1-n;var l=2*n+(r<0?0:1);var h=(t[n]-i[l])/(t[n]-e[n]);var m=t[o]+h*(e[o]-t[o]);if(a){s=m<i[2]||m>=i[3];return[i[l],Math.max(Math.min(m,i[3]),i[2]),!s]}s=m<i[0]||m>=i[1];return[Math.max(Math.min(m,i[1]),i[0]),i[l],s]},doCornerConnection:function(t,e,i,r,a,s,n,o,l,h,m,u,_){var c=this.GetNextLinePoint(a,s,n,o,u);t.lineTo(_[0]*(r*c[0]-e),_[1]*(r*c[1]-i));if(m&&c[2]==u){c=this.GetNextLinePoint(a,s,n,m,!u);t.lineTo(_[0]*(r*c[0]-e),_[1]*(r*c[1]-i))}if(h&&(m==0||m==-l)){c=this.GetNextLinePoint(a,s,n,h,u);c[2]=!c[2];t.lineTo(_[0]*(r*c[0]-e),_[1]*(r*c[1]-i))}return c},RenderAreaFromBox:function(t,e,i,r,a,s,n,o){var l=this.m_Scene.m_Ctx.m_Clustering;var h;var m=[[[r[1],r[2]]],[[r[1],r[3]]],[[r[0],r[3]]],[[r[0],r[2]]]];var u=r[1]-r[0],_=r[3]-r[2];var c=[3,1,0,2];var f=[1,1,0,0];var d=[2,3,3,2];var v,p;var I=e;for(var B=0;B<e.e.length;++B){var g=l.getEdge(e.e[B],i);var S=[],b=[];for(var V=0;V<4;++V){if((h=this.CheckNextLinePoint(g[0],g[1],r,V))!=undefined){b.push(c[V]);S.push(h)}}if(S.length==2){while(I.bw!=undefined){I=I.bw[0]}var P=(4+b[1]-b[0])%4;if(P%2==1){var D=P==1?0:1;var C=1-D;var G=m[b[D]];if(b[D]%2){v=S[C][0];p=S[D][1]}else{v=S[D][0];p=S[C][1]}var x=[r[f[b[D]]],r[d[b[D]]]];var y=Math.abs(x[0]-v);var T=Math.abs(x[1]-p);var A=Math.abs(x[0]-I[0]);var O=Math.abs(x[1]-I[1]);if(!y||!T||A/y+O/T>1){G.splice(G.length-1,1,S[D],S[C])}else{var w=m[(b[D]+1)%4];w.splice(w.length-1,1,S[C]);w=m[(b[D]+2)%4];w.splice(0,1,S[C]);w=m[(b[D]-1)%4];w.splice(0,1,S[D])}}if(P==2){while(I.bw!=undefined){I=I.bw[0]}var L;if(b[0]%2){var M=b[0]==1?0:1,H=1-M;L=(I[0]-r[0])/u;var R=(1-L)*S[M][1]+L*S[H][1];if(R>I[1]){m[1].splice(m[1].length-1,1,S[M]);m[2]=[S[H]]}else{m[3].splice(m[3].length-1,1,S[H]);m[0]=[S[M]]}}else{var E=b[0]==0?0:1,F=1-E;L=(I[1]-r[2])/_;var k=(1-L)*S[F][0]+L*S[E][0];if(k>I[0]){m[0].splice(m[0].length-1,1,S[E]);m[1]=[S[F]]}else{m[2].splice(m[2].length-1,1,S[F]);m[3]=[S[E]]}}}}}this.paintLineList(t,m,a,s,n,o)},RenderAreaFromEdges:function(t,e,i,r,a,s,n,o,l){var h,m,u,_,c,f=i;var d=0,v=0;t.moveTo(l[0]*(s*i[0]-n),l[1]*(s*i[1]-o));var p=false;var I,B;var g=e.e.length-1;for(var S=g;S--;){h=i.ot;B=(h[0]>a[1])-(h[0]<a[0]);I=(h[1]>a[3])-(h[1]<a[2]);if(p){if(B==0&&I==0){if(d&&v){if(c=this.GetNextLinePoint(i,f,a,_[2]?d:v,_[2])){t.lineTo(l[0]*(s*c[0]-n),l[1]*(s*c[1]-o))}}c=this.GetNextPoint(h,i,a,d,v);t.lineTo(l[0]*(s*c[0]-n),l[1]*(s*c[1]-o));t.lineTo(l[0]*(s*h[0]-n),l[1]*(s*h[1]-o));p=false}else{if(_[2]){if(d!=B){_=this.doCornerConnection(t,n,o,s,i,h,a,d,v,B,I,true,l)}}else if(v!=I){_=this.doCornerConnection(t,n,o,s,i,h,a,v,d,I,B,false,l)}d=B;v=I}}else if(B==0&&I==0){t.lineTo(l[0]*(s*h[0]-n),l[1]*(s*h[1]-o))}else{_=this.GetNextPoint(i,h,a,B,I);t.lineTo(l[0]*(s*_[0]-n),l[1]*(s*_[1]-o));p=true}u=h.li;m=r[u.ot];i=m.p;d=B;v=I}if(p){if(d&&v){if(c=this.GetNextLinePoint(i,f,a,_[2]?B:I,_[2])){t.lineTo(l[0]*(s*c[0]-n),l[1]*(s*c[1]-o))}}c=this.GetNextPoint(f,i,a,d,v);t.lineTo(l[0]*(s*c[0]-n),l[1]*(s*c[1]-o))}},FindEndPointInBorders:function(t,e,i,r){var a=t.e.length;var s,n,o;while(a){if(i[0]>=r[0]&&i[0]<=r[1]&&i[1]>=r[2]&&i[1]<=r[3]){return i}s=i.ot;n=s.li;o=e[n.ot];i=o.p;a--}return undefined},RenderShadowArea:function(t,e,i,r,a,s,n,o,l,h,m,u,_){var c=this.m_Scene.m_Ctx.m_Clustering;var f;if(e.ei!=undefined&&!_){this.RenderShadowArea(t,e,i,r,a,s,n,o,l,h,m,u,true);f=c.createEdgeIndex(i,e.ei);t.strokeStyle="rgba(0,0,0,0)"}else{f=c.createEdgeIndex(i,e.e);t.strokeStyle=n}var d=this.GetRefBorders(e,r,a,l);t.lineWidth=s;t.beginPath();var v=this.FindEndPointInBorders(e,f,f[0].p,d);if(v==undefined){this.RenderAreaFromBox(t,e,i,d,l,h,m,u)}else{this.RenderAreaFromEdges(t,e,v,f,d,l,h,m,u)}t.closePath();if(!_&&o!=undefined){t.fillStyle=o;t.fill()}t.stroke()},RenderShadow:function(t,e,i,r,a,s,n,o){var l=this.m_Scene.GetZoomFactor4Mode();if(r.sCol){t.strokeStyle=r.sCol;t.lineWidth=2;t.lineCap="round";var h=r.sSize;if(h==-1){if(e.cnt>100){h=1}else if(e.cnt>30){h=2}else{h=3}}if(h){this.RenderShadowDot(t,e,s,n,o,h,l)}}if(r.permArea&&e.grI>1||e.e==undefined||a<e.lod-4&&e.c==undefined){return}if(r.bCol){var m=r.baseConf.m_ref;var u=r.baseConf.m_lod;if(r.bCol3){if(e.c&&e.c.lod==u-1){this.RenderShadowArea(t,e.c,i,m*2,u-1,1,r.bCol3,r.fCol3,s,n,o,l)}else{this.RenderShadowArea(t,e,i,m*2,u-1,1,r.bCol3,r.fCol3,s,n,o,l)}}this.RenderShadowArea(t,e,i,m,u,r.bSize,r.bCol,r.fCol,s,n,o,l);if(r.bCol2&&e.bw){if(a==e.lod){for(var _=0;_<e.bw.length;_++){var c=e.bw[_];if(c.e.length>0){this.RenderShadowArea(t,c,i,m/2,u+1,1,r.bCol2,r.fCol2,s,n,o,l)}}}else{this.RenderShadowArea(t,e,i,m/2,u+1,1,r.bCol2,r.fCol2,s,n,o,l)}}}}};VBI.VisualObjects.Spot=function(){this.m_fHotScale=1.2;this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"pos",this.m_DataSource,e));this.m_Props.push(this.m_Image=new VBI.AttributeProperty(t,"image",this.m_DataSource,e));this.m_Props.push(this.m_ImageSelected=new VBI.AttributeProperty(t,"imageSelected",this.m_DataSource,e,null));this.m_Props.push(this.m_Icon=new VBI.AttributeProperty(t,"icon",this.m_DataSource,e));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(t,"text",this.m_DataSource,e));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(t,"scale",this.m_DataSource,e,[1,1,1]));this.m_Props.push(this.m_Alignment=new VBI.AttributeProperty(t,"alignment",this.m_DataSource,e,"5"));this.m_Props.push(this.m_ContentColor=new VBI.AttributeProperty(t,"contentColor",this.m_DataSource,e,"rgb(0,0,0)"));this.m_Props.push(this.m_ContentOffset=new VBI.AttributeProperty(t,"contentOffset",this.m_DataSource,e,[0,0,0]));this.m_Props.push(this.m_ContentFont=new VBI.AttributeProperty(t,"contentFont",this.m_DataSource,e,"arial"));this.m_Props.push(this.m_ContentSize=new VBI.AttributeProperty(t,"contentSize",this.m_DataSource,e,null));this.BaseLoad(t,e,this)};this.DetailHitTest=function(t,e,i,r){var a,s,n;var o=t.m_Ctx;var l=e;var h=null;var m=null;s=this.IsHot(l,o);if(this.bUsePreData){var u=this.m_Scene.m_PreassembledData.base[this.m_nPreDataIndex];var _=this.m_BBRefs[e];if(_.cI!=undefined){u=this.m_Scene.m_PreassembledData.clust[_.cI]}var c=u[_.i];a=c.im;if(s){h=c.hcol}n=c.s}else{this.m_DataSource.Select(l);a=this.m_Image.GetValueString(o);if(s){h=this.m_HotDeltaColor.GetValueString(o)}n=this.IsSelected(o);if(n){m=this.m_HotDeltaColor.GetValueString(o)}}var f,d=0;if(f=o.GetResources().GetImageBits(a,h,m)){var v=f[0];var p=this.m_BB[e];var I=p[2]-p[0];var B=p[3]-p[1];var g=Math.floor((i-p[0])/I*f[1]);var S=Math.floor((r-p[1])/B*f[2]);d=v[(S*f[1]+g)*4+3]}return d>0?{m_hit:d==255?1:2}:null};this.MatchIcon=function(e){var i={};if(e){switch(e){case"A8":i.i="";i.f="SAP-icons";break;case"7T":i.i="";i.f="SAP-icons";break;case"7R":i.i="";i.f="SAP-icons";break;case"7Q":i.i="";i.f="SAP-icons";break;case"13":i.i="";i.f="SAP-icons";break;case"89":i.i="";i.f="SAP-icons";break;case"5X":i.i="";i.f="VBI-Icons";break;case"7S":i.i="";i.f="VBI-Icons";break;default:i.f="SAP-icons";if(e.charCodeAt(0)>255){i.i=e}else{var r=t.getIconInfo(e);if(r){i.i=r.content;i.f=r.fontFamily}}break}}return i};this.GetHitArray=function(t,e,i){var r=this.m_Scene.GetStretchFactor4Mode();var a=t/r[0];var s=e/r[0];var n={m_cb:this.DetailHitTest.bind(this),m_Ctx:this.m_Scene.m_Ctx,m_All:i};return this.BaseHitTest(a,s,n)};this.GetLabelPos=function(t,e,i,r){var a=parseInt(r!=undefined?r:"5",10);switch(a){case 0:return{left:t[0]-e/2,top:t[1]-i/2};case 8:return{left:t[0],top:t[1]};case 1:return{left:t[0]-e/2,top:t[1]};case 2:return{left:t[0]-e,top:t[1]};case 3:return{left:t[0]-e,top:t[1]-i/2};case 4:return{left:t[0]-e,top:t[1]-i};case 6:return{left:t[0],top:t[1]-i};case 7:return{left:t[0],top:t[1]-i/2};case 5:default:return{left:t[0]-e/2,top:t[1]-i}}};this.RenderThisInstance=function(t,e,i,r,a,s,n,o,l,h,m,u,_,c){if(VBI.m_bTrace){VBI.Trace("Spot: RenderThisInstance")}var f;var d=this.m_Scene;var v=d.GetZoomFactor4Mode();if(t.c!=undefined&&i.anim&&l>i.animLow&&h&&t.c!=undefined&&t.c.lod==l-1){var p=t.c;var I=h*h;f=[v[0]*(m*(t[0]*(1-I)+p[0]*I)-u),v[1]*(m*(t[1]*(1-I)+p[1]*I)-_)];if(i.anim==2){var B=[v[0]*(m*p[0]-u),v[1]*(m*p[1]-_)];var g=2*Math.abs(.5-h);var S=""+(1-g);n.strokeStyle="rgba(110,110,110,"+S+")";n.lineWidth=2;n.lineCap="round";n.beginPath();n.moveTo(f[0],f[1]);n.lineTo(B[0],B[1]);n.stroke()}}else{f=[v[0]*(m*t[0]-u),v[1]*(m*t[1]-_)]}var b=d.m_Ctx.GetResources().GetImage(t.s&&t.simag?t.simag:t.im,t.s?t.scol:null,t.h?t.hcol:null,d.RenderAsync.bind(d));var V=t.sc;var P=t.tx;var D=t.ic;var C=t.ctfont;if(!b){return false}var G=t.fs&&t.fz&&(t.cnt!=undefined?""+t.cnt:undefined);var x=d.GetStretchFactor4Mode();var y=b.naturalWidth*V[0]/x[0];var T=b.naturalHeight*V[1]/x[1],A=T;if(t.h){if(t.hscale!=undefined){y=y*t.hscale[0];T=T*t.hscale[1]}}var O=this.GetLabelPos(f,y,T,t.al);var w=this.m_IO[a]=d.GetCorrectedInstanceOffsets(this.m_BB[a]=[O.left,O.top,O.left+y,O.top+T],v);if(!w.length){return false}this.m_BBRefs.push({cI:r,i:s});if(t.h){d.VerifyHotItem(this,this.m_BBRefs.length-1)}this.m_BB[a].nI=s;if(this.IsPosChangeable(d.m_Ctx)){var L=this.m_DH[a]=[];if(this.IsHandleMode()){L.m_EditMode=VBI.EMHandle;L.push(f)}else if(this.IsBoxMode()){L.m_EditMode=VBI.EMBox;L.push(this.m_BB[a])}}var M,H;if(P){H=Math.floor((t.ctsz?t.ctsz:12)*T/b.naturalHeight);VBI.Utilities.SetTextAttributes(n,H.toString()+"px "+C,t.ctcol,t.ctcol,"center","middle");M=P}else if(D){var R=this.MatchIcon(D);if(R&&R.i&&R.f){H=Math.floor((t.ctsz?t.ctsz:16)*T/b.naturalHeight);VBI.Utilities.SetTextAttributes(n,(H?H:16).toString()+"px "+R.f,t.ctcol,t.ctcol,"center","middle");M=R.i}}var E,F;for(F=0;F<w.length;++F){E=w[F];if(i&&(t.h||i.permArea)){this.RenderShadow(o,t,e,i,l,m,u-E,_)}n.drawImage(b,O.left+E,O.top,y,T);if(M){var k=[0,0,0];if(t.ctoffs&&t.ctoffs.length){k=t.ctoffs}var j=k[0]*V[0]/x[0];var N=k[1]*V[1]/x[1];if(t.h&&t.hscale!=undefined){j*=t.hscale[0];N*=t.hscale[1]}n.fillText(M,O.left+E+j+y/2,O.top+N+T/2)}}if(G){var U=t.fz?t.fz*T/b.naturalHeight:Math.floor(A/t.fs);VBI.Utilities.SetTextAttributes(n,U.toString()+"px "+t.f,t.fc,t.fc,"left","alphabetic");for(F=0;F<w.length;++F){E=w[F];n.fillText(G,y+O.left+E+t.fo/x[0],O.top+t.foy/x[1]+(T+U/1.5)/2)}}if(c==true){if(t.label&&w.length){var W={pa:[f[0],f[1],f[2]],bb:null};this.m_Label.push(new VBI.Label(t.label,a,this.CalculateLabelPos,W,this.m_BB[a],w))}}return true};this.RenderInstance=function(t,e,i,r,a,s,n,o,l){if(VBI.m_bTrace){VBI.Trace("Spot: RenderInstance")}if(!r){return}var h=this.m_Scene;var m=h.GetZoomFactor4Mode();var u=h.GetStretchFactor4Mode();var _=h.GetPointFromPos(i,true);var c=r.naturalWidth*s[0]/u[0];var f=r.naturalHeight*s[1]/u[1];var d=this.GetHotScale(h.m_Ctx);if(n){c=Math.round(c*d[0]);f=Math.round(f*d[1])}var v=this.GetLabelPos(_,c,f,this.m_Alignment.GetValueString(h.m_Ctx));var p=this.m_IO[t]=h.GetCorrectedInstanceOffsets(this.m_BB[t]=[v.left,v.top,v.left+c,v.top+f],m);if(this.IsPosChangeable(h.m_Ctx)){var I=this.m_DH[t]=[];if(this.IsHandleMode()){I.m_EditMode=VBI.EMHandle;I.push(_)}else if(this.IsBoxMode()){I.m_EditMode=VBI.EMBox;I.push(this.m_BB[t])}}var B=this.m_ContentColor.GetValueString(h.m_Ctx);var g=this.m_ContentOffset.GetValueVector(h.m_Ctx);var S=this.m_ContentFont.GetValueString(h.m_Ctx);var b=this.m_ContentSize.GetValueLong(h.m_Ctx);var V;if(a){if(!b){b=12}b=b*f/r.naturalHeight;VBI.Utilities.SetTextAttributes(e,Math.floor(b).toString()+"px "+S,B,B,"center","middle");V=a}else if(l){if(!b){b=16}b=b*f/r.naturalHeight;var P=this.MatchIcon(l);if(P&&P.i&&P.f){VBI.Utilities.SetTextAttributes(e,Math.floor(b).toString()+"px "+P.f,B,B,"center","middle");V=P.i}}for(var D=0;D<p.length;++D){var C=p[D];e.drawImage(r,v.left+C,v.top,c,f);if(V){var G=g[0]*s[0]/u[0];var x=g[1]*s[1]/u[1];if(n){G*=d[0];x*=d[1]}e.fillText(V,v.left+C+c/2+G,v.top+f/2+x)}}if(o&&p.length){var y={pa:[_[0],_[1],_[2]],bb:null};this.m_Label.push(new VBI.Label(o,t,this.CalculateLabelPos,y,this.m_BB[t],p))}};this.CalculateLabelPos=function(t,e,i){var r=Math.floor(e.pa.length/3)*3,a=[],s=t.GetViewport();for(var n=0;n<r;n+=3){var o=[e.pa[n]+i,e.pa[n+1]];if(o[0]>s[0]&&o[0]<s[2]&&o[1]>s[1]&&o[1]<s[3]){a.push(o)}}return a.length?a:null};this.Init4Render=function(){this.m_BB=[];this.m_IO=[];this.m_DH=[];this.m_BBRefs=[]};this.Render=function(t,e,i,r,a,s){var n=this.m_Scene;this.SwitchPreDataRendering(i!=undefined);var o;if(this.bUsePreData){if(i.m_nNumIgnore!=undefined&&i.m_nNumIgnore==i.length){return 0}var l=s?false:true;o=this.m_BB.length;var h=n.m_Canvas[0].m_nExactLOD;var m=n.m_Canvas[0].m_nCurrentX*n.m_MapManager.m_tileWidth;var u=n.m_Canvas[0].m_nCurrentY*n.m_MapManager.m_tileHeight;var _=i.config;var c=i.cI;var f=i.m_TreeFatherNode;var d;if(f){d=Math.ceil(h);var v=this.GetAnimClusterDistance(d,h);o=this.RenderTree(f,i.m_edges,_,c,o,d,v,e,a,i.m_lodOffset,m,u,false)}else{d=n.m_Canvas[0].m_nCurrentLOD;var p=i.length;var I=i.m_lodOffset;for(var B=0;B<p;++B){var g=i[B];if(!g.b2Ignore){if(this.RenderThisInstance(g,i.m_edges,_,c,o,B,e,a,d,0,I,m,u,l)){this.SetClusteredRichTooltip(g);o++}}}}}else{var S=n.m_Ctx;var b,V;if(b=this.m_DataSource.GetCurrentNode(S)){var P=b.m_dataelements.length;for(var D=0;D<P;++D){this.m_DataSource.Select(D);var C=this.IsHot(D);var G=this.IsSelected(S);var x=this.m_Pos.GetValueVector(S);var y=this.m_Image.GetValueString(S);if(G&&(V=this.m_ImageSelected.GetValueString(S))){y=V}var T=this.m_Text.GetValueString(S);var A=this.m_Icon.GetValueString(S);var O=this.m_Scale.GetValueVector(S);var w=S.GetResources().GetImage(y,G?this.m_SelectColor.GetValueString(S):null,C?this.m_HotDeltaColor.GetValueString(S):null,n.RenderAsync.bind(n));this.RenderInstance(D,e,x,w,T,O,C,this.GetLabel(S),A);this.SetRichTooltip(C)}}}this.BaseRender(t,e);return o};this.DesignBeginDrag=function(t){t.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);t.m_DhOrig=this.m_DH[t.m_Index].slice(0);if(t.m_IO){t.m_DhOrig[0][0]+=t.m_IO;t.m_DhOrig[0][2]+=t.m_IO}};this.DesignGetActiveBoxHandles=function(t){return[1,1,1,1,0,1,0,0,0]};this.InternalChangeHotItem=function(t,e,i){if(this.bUsePreData){var r=this.m_BBRefs[t];if(r!=undefined){var a=r.cI!=undefined?this.m_Scene.m_PreassembledData.clust[r.cI]:this.m_Scene.m_PreassembledData.base[this.m_nPreDataIndex];if(a[r.i]!=undefined){a[r.i].h=e;this.m_HotClusterVO=e&&a[r.i].isCl?a[r.i]:undefined}if(i){i.cI=e?r.cI:undefined;i.nI=e?r.i:undefined}}}};this.BaseIsHot=this.IsHot;this.PreDataIsHot=function(t,e){var i=this.m_BBRefs[t];var r=i.cI!=undefined?this.m_Scene.m_PreassembledData.clust[i.cI]:this.m_Scene.m_PreassembledData.base[this.m_nPreDataIndex];return r[i.i].h};this.BaseGetEntity=this.GetEntity;this.PreDataGetEntity=function(t,e){this.m_DataSource.Select(t);return this.m_Entity.GetValueString(e)};this.SwitchHotItemToStandard=function(){var t=this.m_Scene;var e=this.m_BBRefs[t.m_HotItem.m_Index];var i=e.cI!=undefined?this.m_Scene.m_PreassembledData.clust[e.cI]:this.m_Scene.m_PreassembledData.base[this.m_nPreDataIndex];var r=i[e.i];if(r){if(r.isCl==true){t.InternalSetHotItem(null,null);return r}else{t.m_HotItem.m_Index=r.nI;if(t.m_HotItem.m_HitObj){t.m_HotItem.m_HitObj.m_Index=r.nI}return undefined}}};this.IsClusterable=function(){return true};this.GetDataIndex=function(t){if(this.bUsePreData){var e=this.m_BBRefs[t];if(e!=undefined){var i=e.cI==undefined?this.m_Scene.m_PreassembledData.base[this.m_nPreDataIndex]:this.m_Scene.m_PreassembledData.clust[e.cI];var r=i[e.i];if(r!=undefined){return r.nI}}}return t};this.GetPreassembledElement=function(t){var e=this.m_BBRefs[t];if(e==undefined){return undefined}var i=e.cI==undefined?this.m_Scene.m_PreassembledData.base[this.m_nPreDataIndex]:this.m_Scene.m_PreassembledData.clust[e.cI];return i[e.i]};this.GetInternalIndex=function(t){if(this.bUsePreData){return this.m_BBRefs[t]}return t};this.getTooltip=function(t,e){this.m_DataSource.Select(this.GetDataIndex(e.m_Index));return this.m_Tooltip.GetValueString(t)};this.DesignBoxSize=VBI.Utilities.SceneBindDesignSpotBoxSize.bind(this)};VBI.VisualObjects.Spot.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Route=function(){this.m_LP=[];this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"posarray",this.m_DataSource,e));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(t,"scale",this.m_DataSource,e));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(t,"color",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_Start=new VBI.AttributeProperty(t,"start",this.m_DataSource,e,0));this.m_Props.push(this.m_End=new VBI.AttributeProperty(t,"end",this.m_DataSource,e,0));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_LineWidth=new VBI.AttributeProperty(t,"linewidth",this.m_DataSource,e,6));this.m_Props.push(this.m_DotColor=new VBI.AttributeProperty(t,"dotcolor",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_DotBorderColor=new VBI.AttributeProperty(t,"dotbordercolor",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(t,"colorBorder",this.m_DataSource,e,null));this.m_Props.push(this.m_LineDash=new VBI.AttributeProperty(t,"lineDash",this.m_DataSource,e,null));this.m_Props.push(this.m_DotWidth=new VBI.AttributeProperty(t,"dotwidth",this.m_DataSource,e,0));this.m_Props.push(this.m_Tri=new VBI.AttributeProperty(t,"directionIndicator",this.m_DataSource,e,0));this.BaseLoad(t,e,this)};this.DrawArrow=function(t,e,i,r,a,s,n){if(e.length<3||Math.max(e[0][0],e[1][0],e[2][0])<a||Math.max(e[0][1],e[1][1],e[2][1])<0||Math.min(e[0][0],e[1][0],e[2][0])>s||Math.min(e[0][1],e[1][1],e[2][1])>n){return}t.beginPath();t.moveTo(e[0][0],e[0][1]);t.lineTo(e[1][0],e[1][1]);t.lineTo(e[2][0],e[2][1]);t.lineTo(e[0][0],e[0][1]);t.closePath();if(r){t.strokeStyle=r;t.lineWidth=2;t.stroke()}t.fillStyle=i;t.fill()};this.CalcTriangle=function(t,e,i,r,a,s,n,o){var l=e[0]-t[0];var h=e[1]-t[1];while(Math.abs(l)>1e3&&Math.abs(h)>1e3){l/=1e3;h/=1e3}var m=Math.sqrt(l*l+h*h);var u=l*i/m;var _=h*i/m;var c=l*r/2/m;var f=h*r/2/m;var d,v;if(n){d=l*o/2/m;v=h*o/2/m}var p=t[0]+u;var I=t[1]+_;if(!s){a.ta=[[t[0],t[1]],[p+f,I-c],[p-f,I+c]];a.pt=[p,I,0];if(n){a.int=[[p+v,I-d],[p-v,I+d]]}}else{a.ta=[[p,I,0],[t[0]+f,t[1]-c],[t[0]-f,t[1]+c]];a.pt=[t[0],t[1]];if(n){a.int=[[t[0]+v,t[1]-d],[t[0]-v,t[1]+d]]}}};this.getArrowLength=function(t){return Math.min(15,t*5)};this.getArrowWidth=function(t){return Math.min(Math.max(8,t*3),t+8)};this.CalcArrowIntermediate=function(t,e,i,r,a,s,n){var o=e;var l=false;var h=i;var m=this.getArrowWidth(r);var u=this.getArrowLength(r);var _=u*u;var c=0;var f,d,v;var p=[0,0,0];var I;var B;v=0;if(a){I={};c=0;for(B=h;B<t.length;++B){p=t[B];f=o[0]-p[0];d=o[1]-p[1];v=f*f+d*d;if(v>_){this.CalcTriangle(o,p,u,m,I,false,n,r);t.m_aArrows.push(I);l=true;break}else{c++}}if(I.pt){t.splice(h,c,o,I.pt);h=h+2;o=I.pt}}if(s){var g=true;var S=o;var b=t[h];var V=this.getArrowWidth(r);var P=0;var D;o=[];while(g&&h<t.length){f=b[0]-S[0];d=b[1]-S[1];D=Math.sqrt(f*f+d*d);if(P+D>V){g=false;var C=f/(P+D)*V;var G=d/(P+D)*V;o=[S[0]+C,S[1]+G,0]}else{P+=D;h++;S=b;b=t[h]}}if(o.length){I={};c=0;for(B=h;B<t.length;++B){p=t[B];f=o[0]-p[0];d=o[1]-p[1];v=f*f+d*d;if(v>_){this.CalcTriangle(o,p,u,m,I,true,n,r);t.m_aArrows.push(I);l=true;break}else{c++}}if(I.pt){t.splice(h,c,o,[I.ta[0][0],I.ta[0][1],0]);h=h+2}}}if(l){return h-1}return-1};this.CalcArrow=function(t,e,i,r,a,s){var n=this.getArrowWidth(r);var o=this.getArrowLength(r);var l=t.length/3;var h,m,u=o*o;if((h=e[0]-i[0])*h+(m=e[1]-i[1])*m<u){return false}var _,c;var f,d=[0,0,0];var v=false;c=a?3*(l-1):0;f=[t[c],t[c+1],0];var p=3*l;for(_=3;_<p;_+=3){c=a?p-3-_:_;d=[t[c],t[c+1],0];if((h=f[0]-d[0])*h+(m=f[1]-d[1])*m>u){v=true;break}}if(!v){return false}this.CalcTriangle(f,d,o,n,s,false,false,0);s.idx=c;return true};this.CalculateLabelPos=function(t,e,i){var r=VBI.Utilities.GetMidpointsForLine(e.pa,i,t.GetViewport());return r.aPos};this.LassoSelect=function(t,e,i){var r,a,s;var n=false;for(var o=this.m_LP.length-1;o>=0;--o){r=this.m_LP[o];s=this.m_IO[o];var l=false;for(var h=0;h<s.length;++h){if(l){break}for(var m=0;m<r.length;++m){a=r[m];if(!(l=VBI.Utilities.pointInPolygon(t,a[0]+s[h],a[1]))){break}}}if(l){e.push(o);i.push(o);n=true}}return n};this.RenderInstance=function(t,e,i,r){var a=this.m_Scene.GetZoomFactor4Mode();this.m_LP[t]=[];var s;if(this.IsPosChangeable(r)){this.m_DH[t]=[];if(this.IsHandleMode()){s=VBI.EMHandle}else if(this.IsBoxMode()){s=VBI.EMBox}}var n=this.IsSelected(r);var o=this.m_Pos.GetValueVector(r);var l=this.m_Scene;if(o.cache==undefined){l.FillPositionCache(o)}var h=this.m_Color.GetValueColor(r);if(n){h=this.GetSelectColor(r,h)}if(i){h=this.GetHotColor(r,h)}var m=this.m_Start.GetValueLong(r);var u=this.m_End.GetValueLong(r);var _=this.m_Tri.GetValueLong(r);var c=this.m_LineWidth.GetValueFloat(r);if(i){c*=this.GetHotScale(r)[0]}var f=this.m_DotColor.GetValueColor(r);if(n){f=this.GetSelectColor(r,f)}if(i){f=this.GetHotColor(r,f)}var d=this.m_DotBorderColor.GetValueColor(r);var v=this.m_ColorBorder.GetValueColor(r);if(n){d=this.GetSelectColor(r,d);v=this.GetSelectColor(r,v)}if(i){d=this.GetHotColor(r,d);v=this.GetHotColor(r,v)}var p=this.m_LineDash.GetValueString(r);var I=this.m_DotWidth.GetValueFloat(r);var B=this.GetLabel(r);var g=l.GetNearestPosArray(o);var S=l.GetPointFromPos([g.m_MinX,g.m_MaxY,0],false);var b=l.GetPointFromPos([g.m_MaxX,g.m_MinY,0],false);var V=Math.max(c,I/2);var P=this.m_IO[t]=l.GetCorrectedInstanceOffsets(this.m_BB[t]=[S[0]-V,S[1]-V,b[0]+V,b[1]+V],a);if(P.length){var D=l.GetPointArrayFromUCSArray(o.cache.data);if(s!=undefined){this.m_DH[t]=this.FillDesignHandles(D,s,t)}for(var C=0,G=P.length;C<G;++C){e.setTransform(1,0,0,1,P[C],0);this.RenderRoute(t,e,D,S,b,h,m,u,_,c,f,d,v,p,I,P[C]);if(VBI.m_bTrace){VBI.Utilities.DrawFrameRect(e,"red",this.m_BB[t])}}e.setTransform(1,0,0,1,0,0);if(B){var x={pa:D,bb:[S,b]};this.m_Label.push(new VBI.Label(B,t,this.CalculateLabelPos,x,null,P))}}};this.FillDesignHandles=function(t,e,i){var r=[];if(e==VBI.EMHandle){var a=t.length;for(var s=0;s<a;s+=3){r.push([t[s],t[s+1]])}}else if(e==VBI.EMBox){r.push(this.m_BB[i])}r.m_EditMode=e;return r};this.RenderRoute=function(t,e,i,r,a,s,n,o,l,h,m,u,_,c,f,d){if(i.length<6){return}var v=-d,p=e.canvas.m_pixelWidth-d,I=e.canvas.m_pixelHeight;var B=r[0]>v&&r[1]>0&&a[0]<p&&a[1]<I;var g=this.m_LP[t];var S=3,b=i.length-3;var V=g.length?false:true;var P={},D={};if(h&&n&&this.CalcArrow(i,r,a,h,false,P)){this.DrawArrow(e,P.ta,s,_,v,p,I);S=P.idx;if(V){g.m_RS=P}}if(h&&o&&this.CalcArrow(i,r,a,h,true,D)){this.DrawArrow(e,D.ta,s,_,v,p,I);b=D.idx;if(V){g.m_RE=D}}if(V){this.CollectLinePoints(i,g,S,b,n,o,l,P,D,h,d,_?true:false)}var C=this.CheckLineDashing(c,e);if(h){this.DrawActualRoute(e,g,s,_,h,B,v,p,I)}if(f){this.DrawRouteDots(e,g,n,o,m,u,f/2,B,v,p,I)}if(C){e.setLineDash([])}if(g.m_aArrows&&g.m_aArrows.length){for(var G=0;G<g.m_aArrows.length;++G){this.DrawArrow(e,g.m_aArrows[G].ta,s,_,v,p,I);if(g.m_aArrows[G].int){var x=g.m_aArrows[G].int;e.beginPath();e.moveTo(x[0][0],x[0][1]);e.lineTo(x[1][0],x[1][1]);e.strokeStyle=s;e.lineWidth=2;e.stroke()}}}};this.CollectLinePoints=function(t,e,i,r,a,s,n,o,l,h,m,u){var _=Math.min(h*h/2,4);var c=this.m_Scene.GetViewport();e.m_aArrows=[];var f=o.pt?[o.pt[0],o.pt[1],0]:[t[0],t[1],0];var d=l.pt?[l.pt[0],l.pt[1],0]:[t[r],t[r+1],0];var v,p,I,B=f;e.push(B);for(var g=i;g<=r;g+=3){I=[t[g],t[g+1],0];if((v=B[0]-I[0])*v+(p=B[1]-I[1])*p>_){e.push(I);B=I}}if(l.pt){e.push(l.pt)}if((a||s)&&n&&h&&this.CheckTriangleRendering()){if(!(f[0]>=c[0]&&f[0]<=c[2]&&f[1]>=c[1]&&f[1]<=c[3]&&d[0]>=c[0]&&d[0]<=c[2]&&d[1]>=c[1]&&d[1]<=c[3])){this.CalculateRouteArrows(e,a,s,h,m,u)}}};this.CheckTriangleRendering=function(){var t=this.m_Scene;var e=t.m_Canvas[0].m_nExactLOD;return t.m_bNonIntPosStable||e==Math.floor(e)||e<=t.m_CacheVars.minLOD+.01};this.CheckLineDashing=function(t,e){var i=this.m_Scene;var r=i.m_Canvas[0].m_nExactLOD;if(t&&e.setLineDash&&(i.m_bNonIntPosStable||r==Math.floor(r)||r<=i.m_CacheVars.minLOD+.01)){var a=t.split(";");e.setLineDash(a);return true}return false};this.DrawActualRoute=function(t,e,i,r,a,s,n,o,l){if(r){t.strokeStyle=r;t.lineWidth=a+2;t.lineJoin="round";t.lineCap="butt"}else{t.strokeStyle=i;t.lineWidth=a;t.lineJoin=t.lineCap="round"}var h=true;if(s){t.beginPath();h=false;t.moveTo(e[0][0],e[0][1]);for(var m=1;m<e.length;++m){t.lineTo(e[m][0],e[m][1])}}else{var u,_;var c=this.m_Scene.m_TransitionTable;var f;var d=true;var v,p=e[0];if(p[1]<0){u=3}else{u=p[1]>l?6:0}if(p[0]<n){u++}else{u+=p[0]>o?2:0}for(var I=1;I<e.length;++I){v=e[I];if(v[1]<0){_=3}else{_=v[1]>l?6:0}if(v[0]<n){_++}else{_+=v[0]>o?2:0}f=c[u+9*_];if(f==1||f>1&&this.Check4Intersect(p,v,f,n,o,0,l)){if(h){t.beginPath();h=false}if(d){t.moveTo(p[0],p[1])}t.lineTo(v[0],v[1]);d=false}else{d=true;p=v}u=_}}if(!h){t.stroke();if(r){t.strokeStyle=i;t.lineWidth=a;t.stroke()}}};this.Check4Intersect=function(t,e,i,r,a,s,n){var o,l,h;var m=e[0]-t[0];var u=e[1]-t[1];if(i&20){h=i&4?n:s;l=(e[1]-h)/u;o=e[0]-m*l;if(o>=r&&o<=a){return true}}if(i&10){h=i&2?r:a;o=(e[0]-h)/m;l=e[1]-u*o;if(l>=s&&l<=n){return true}}return false};this.DrawRouteDots=function(t,e,i,r,a,s,n,o,l,h,m){t.fillStyle=a;t.strokeStyle=s;t.lineWidth=1;var u=i?1:0;var _=e.length-(r?2:1);var c=2*Math.PI;for(var f=u;f<=_;++f){var d=e[f];if(o||d[0]-n>l&&d[0]+n<h&&d[1]-n>0&&d[1]+n<m){t.beginPath();t.arc(d[0],d[1],n,0,c);t.closePath();t.fill();t.stroke()}}};this.CalculateRouteArrows=function(t,e,i,r,a,s){var n=250;var o=0;var l=0;var h,m,u,_;var c=this.m_Scene.m_Canvas[this.m_Scene.m_nOverlayIndex].width;var f=this.m_Scene.m_Canvas[this.m_Scene.m_nOverlayIndex].height;var d=[-a,0,-a+c,f];var v=false;var p=false;var I=true;var B=t[0];var g=t[1];u=1;while(I){if(B==undefined||g==undefined){if(VBI.m_bTrace){VBI.Trace("Wrong offset in CalculateRouteArrows")}break}v=VBI.Utilities.LineIntersectRect(B[0],B[1],g[0],g[1],d);if(v.bReturn==false){p=false;o=0;u++;if(u<t.length){B=g;g=t[u]}else{I=false}}else{if(v.x0!=B[0]||v.y0!=B[1]){B=[v.x0,v.y0,0];t.splice(u,0,B);u++;p=false}if(v.x1!=g[0]||v.y1!=g[1]){if(v.x1==B[0]&&v.y1==B[1]&&p){u+=2;if(u<t.length){B=t[u-1];g=t[u];p=false}else{I=false}}else{g=[v.x1,v.y1,0];t.splice(u,0,g);p=true}}h=g[0]-B[0];m=g[1]-B[1];_=Math.sqrt(h*h+m*m);l+=_;if(o+_>n){var S=h/_*(n-o);var b=m/_*(n-o);var V=[B[0]+S,B[1]+b,0];var P=this.CalcArrowIntermediate(t,V,u,r,e,i,s);if(P>=0){u=P+1;B=t[P];g=t[u];o=0}else{I=false}}else{o+=_;u++;if(u<t.length){B=g;g=t[u]}else{I=false}}}}};this.Init4Render=this.StandardInitWithLPs;this.Render=function(t,e,i){var r=this.m_Scene;var a=r.m_Ctx;var s;var n;if(s=this.m_DataSource.GetCurrentNode(a)){for(var o=0,l=s.m_dataelements.length;o<l;++o){this.m_DataSource.Select(o);if(this.IsHot(o)){n=o}else{this.RenderInstance(o,e,false,a)}this.SetRichTooltip(this.IsHot(o))}}if(n!=undefined){this.m_DataSource.Select(n);this.RenderInstance(n,e,true,a)}this.BaseRender(t,e)};this.DetailHitDot=function(t,e,i,r,a){var s,n;return(s=i-t)*s+(n=r-e)*n<a?true:false};this.DetailHitTest=function(t,e,i,r){var a,s,n,o;this.m_DataSource.Select(e);var l=this.m_LineWidth.GetValueLong(this.m_Scene.m_Ctx)/2;var h=this.m_DotWidth.GetValueLong(this.m_Scene.m_Ctx)/2;var m=l*l;var u=h*h;var _=this.m_LP[e];a=_[0][0];s=_[0][1];if(u&&this.DetailHitDot(i,r,a,s,u)){return{m_hit:1,m_dot:0}}var c=_.length;var f;for(f=1;f<c;++f){n=_[f][0];o=_[f][1];if(l&&!(i<Math.min(a,n)-l||i>Math.max(a,n)+l||r<Math.min(s,o)-l||r>Math.max(s,o)+l)&&m>VBI.Utilities.sqDistance(a,s,n,o,i,r)){if(VBI.m_bTrace){VBI.Trace("VBI.VisualObjects.Route hit line "+e)}return{m_hit:1}}if(u&&this.DetailHitDot(i,r,n,o,u)){if(VBI.m_bTrace){VBI.Trace("VBI.VisualObjects.Route hit dot "+e)}return{m_hit:1,m_dot:f}}a=n;s=o}if(_.m_aArrows){c=_.m_aArrows.length;for(f=0;f<c;++f){if(VBI.Utilities.pointInTriangle(_.m_aArrows[f].ta,[i,r])){return{m_hit:1}}}}if(_.m_RS&&VBI.Utilities.pointInTriangle(_.m_RS.ta,[i,r])){return{m_hit:1,m_arrow:0}}if(_.m_RE&&VBI.Utilities.pointInTriangle(_.m_RE.ta,[i,r])){return{m_hit:1,m_arrow:1}}return null};this.GetHitArray=function(t,e,i){var r={m_cb:this.DetailHitTest.bind(this),m_All:i};var a=this.m_Scene.GetStretchFactor4Mode();var s=t/a[0];var n=e/a[1];return this.BaseHitTest(s,n,r)};this.DesignBoxSize=VBI.Utilities.SceneBindPosArrayDesignBoxSize.bind(this)};VBI.VisualObjects.Route.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Circle=function(){this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"pos",this.m_DataSource,e));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(t,"colorBorder",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_Radius=new VBI.AttributeProperty(t,"radius",this.m_DataSource,e,5));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(t,"color",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_Slices=new VBI.AttributeProperty(t,"slices",this.m_DataSource,e,10));this.m_Props.push(this.m_AltColorBorder=new VBI.AttributeProperty(t,"altBorderDeltaColor",this.m_DataSource,e,null));this.BaseLoad(t,e,this)};this.CalculateLabelPos=function(t,e,i){var r=VBI.Utilities.GetMidpointForPolygon(e.pa,e.bb,i,t.GetViewport());if(r&&r.aPos){return r.aPos}return null};this.LassoSelect=this.LassoSelectCircle;this.RenderInstance=function(t,e,i,r,a,s,n,o){var l=this.m_Scene;var h;var m=l.GetStretchFactor4Mode();var u=l.GetZoomFactor4Mode();var _=s/m[0];var c=l.GetPointFromPos(i,false);var f;var d=this.m_IO[t]=l.GetCorrectedInstanceOffsets(f=this.m_BB[t]=[c[0]-_,c[1]-_,c[0]+_,c[1]+_],u);f.m_Radius=_;f.m_Pos=c;if(this.IsPosChangeable(l.m_Ctx)){var v=this.m_DH[t]=[];if(this.IsHandleMode()){v.m_EditMode=VBI.EMHandle;v.push(c)}else if(this.IsBoxMode()){v.m_EditMode=VBI.EMBox;v.push(f)}}e.lineWidth=1;e.fillStyle=r;for(h=0;h<d.length;++h){e.setTransform(1,0,0,1,d[h],0);e.beginPath();e.arc(c[0],c[1],_,0,2*Math.PI);e.closePath();e.fill();e.strokeStyle=a;e.stroke();if(VBI.m_bTrace){VBI.Utilities.DrawFrameRect(e,"red",this.m_BB[t])}}e.setTransform(1,0,0,1,0,0);if(o&&d.length){var p=[];var I=20;for(h=0;h<I;++h){var B=h*2*Math.PI/I;var g=c[0]+_*Math.sin(B);var S=c[1]+_*Math.cos(B);p.push(g,S)}var b={pa:p,bb:[[f[0],f[1]],[f[2],f[3]]]};this.m_Label.push(new VBI.Label(o,t,this.CalculateLabelPos,b,null,d))}};this.Init4Render=this.StandardInit;this.Render=function(t,e,i){var r=this.m_Scene.m_Ctx;var a=0;var s;if(s=this.m_DataSource.GetCurrentNode(r)){a=s.m_dataelements.length;for(var n=0;n<a;++n){this.m_DataSource.Select(n);var o=this.IsHot(n);var l=this.IsSelected(r);var h=this.m_Pos.GetValueVector(r);var m=this.m_Color.GetValueColor(r);if(l){m=this.GetSelectColor(r,m)}if(o){m=this.GetHotColor(r,m)}var u=this.m_ColorBorder.GetValueColor(r);if(l){u=this.GetSelectColor(r,u)}if(o){u=this.GetAltBorderColor(r,u)}var _=this.m_Radius.GetValueFloat(r);if(o){_=this.GetHotScale(r)[0]*_}var c=this.m_Slices.GetValueLong(r);this.RenderInstance(n,e,h,m,u,_,c,this.GetLabel(r));this.SetRichTooltip(o)}}this.BaseRender(t,e);return a};this.DetailHitTest=function(t,e,i,r){var a=this.m_BB[e];var s=a.m_Radius;var n=a.m_Pos;var o,l;if((o=n[0]-i)*o+(l=n[1]-r)*l<s*s){return{m_hit:1}}return null};this.GetHitArray=function(t,e,i){var r=this.m_Scene.GetStretchFactor4Mode();var a={m_cb:this.DetailHitTest.bind(this),m_zf:r,m_All:i};var s=t/r[0];var n=e/r[1];return this.BaseHitTest(s,n,a)};this.DesignGetActiveBoxHandles=function(t){var e=this.m_Scene;this.m_DataSource.Select(t);return this.m_Radius.IsChangeable(e.m_Ctx)?[0,1,0,1,0,1,0,1,0]:[0,0,0,0,0,0,0,0,0]};this.DesignBoxSize=VBI.Utilities.SceneBindRadiusDesignBoxSize.bind(this)};VBI.VisualObjects.Circle.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.CircleDist=function(){this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"midpoint",this.m_DataSource,e));this.m_Props.push(this.m_ColBorder=new VBI.AttributeProperty(t,"colorBorder",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_Radius=new VBI.AttributeProperty(t,"radius",this.m_DataSource,e,10));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_ColFill=new VBI.AttributeProperty(t,"color",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_Slices=new VBI.AttributeProperty(t,"slices",this.m_DataSource,e,10));this.m_Props.push(this.m_AltColorBorder=new VBI.AttributeProperty(t,"altBorderDeltaColor",this.m_DataSource,e,null));this.BaseLoad(t,e,this)};this.CalculateLabelPos=function(t,e,i){var r=VBI.Utilities.GetMidpointForPolygon(e.pa,e.bb,i,t.GetViewport());if(r&&r.aPos){return r.aPos}return null};this.LassoSelect=function(t,e,i){var r=[];var a,s;var n=false;for(var o=this.m_LP.length-1;o>=0;--o){var l=[];if(this.m_BB[o].m_bArcCircle){var h=this.m_BB[o].m_Pos;var m=this.m_BB[o].m_Radius;var u=20;for(var _=0;_<u;++_){s=_*2*Math.PI/u;r=[h[0]+m*Math.sin(s),h[1]+m*Math.cos(s)];l.push(r)}}else{l=this.m_LP[o]}a=this.m_IO[o];if(VBI.Utilities.polyInPolygon(t,l,a)){i.push(o);e.push(o);n=true}}return n};this.RenderCircleDist=function(t,e,i,r,a){var s=this.m_Scene;var n=this.m_LP[t];if(n.length){n=null}var o,l,h,m=s.GetPointFromGeo(i[0],false);var u=false;var _,c;var f=this.m_Scene.m_Ctx;var d=this.m_Pos.GetValueVector(f);var v=this.m_Radius.GetValueFloat(f);u=Math.abs(d[1]-45)<=10&&v<=1e4?true:false;if(u){var p=0;_=s.GetPointFromGeo(VBI.MathLib.DegToRad(d),false);for(var I=0;I<i.length;++I){h=s.GetPointFromGeo(i[I],false);p+=Math.sqrt((h[0]-_[0])*(h[0]-_[0])+(h[1]-_[1])*(h[1]-_[1]))}c=p/i.length;var B=this.m_BB[t];B[1]=_[1]-c;B[3]=_[1]+c;B.m_Radius=c;B.m_Pos=_;B.m_bArcCircle=true}e.strokeStyle=a;e.fillStyle=r;e.lineWidth=1;e.beginPath();if(!u){e.moveTo(m[0],m[1]);if(n){n.push(m)}for(var g=1;g<i.length;++g){h=s.GetPointFromGeo(i[g],false);if((o=m[0]-h[0])*o+(l=m[1]-h[1])*l<9){continue}if(n){n.push(h)}e.lineTo(h[0],h[1]);m=h}e.closePath()}else{e.arc(_[0],_[1],c,0,2*Math.PI)}e.stroke();e.fill()};this.RenderInstance=function(t,e,i,r,a,s,n,o){var l,h=this.m_Scene;var m=h.GetZoomFactor4Mode();var u=this.m_Scene.m_Canvas[0].m_nExactLOD;var _=Math.sqrt(u);var c=Math.log(s);var f=1/c;var d=2*Math.PI/f;n=d>n?d:n;var v=n*_;v=v<7?7:v;v=v>500?500:v;var p=VBI.MathLib.EquidistantLonLat(VBI.MathLib.DegToRad(i),s,v);if(this.m_Pos.IsChangeable(h.m_Ctx)){this.m_DH[t]=[h.GetPointFromPos(i,false)]}var I=h.GetPointFromGeo([p.m_MinX,p.m_MaxY,0],false);var B=h.GetPointFromGeo([p.m_MaxX,p.m_MinY,0],false);var g=this.m_IO[t]=h.GetCorrectedInstanceOffsets(l=this.m_BB[t]=[I[0],I[1],B[0],B[1]],m);if(this.IsPosChangeable(h.m_Ctx)){var S=this.m_DH[t]=[];if(this.IsHandleMode()){S.m_EditMode=VBI.EMHandle;S.push(h.GetPointFromPos(i,false))}else if(this.IsBoxMode()){S.m_EditMode=VBI.EMBox;S.push(l)}}for(var b=0;b<g.length;++b){e.setTransform(1,0,0,1,g[b],0);this.RenderCircleDist(t,e,p,r,a);if(VBI.m_bTrace){VBI.Utilities.DrawFrameRect(e,"red",this.m_BB[t])}}e.setTransform(1,0,0,1,0,0);if(o&&g.length){var V=[];for(var P=0;P<this.m_LP[t].length;++P){V.push(this.m_LP[t][P][0],this.m_LP[t][P][1])}var D={pa:V,bb:[I,B]};this.m_Label.push(new VBI.Label(o,t,this.CalculateLabelPos,D,null,g))}};this.Init4Render=this.StandardInitWithLPs;this.Render=function(t,e,i){var r=this.m_Scene.m_Ctx;var a;if(a=this.m_DataSource.GetCurrentNode(r)){for(var s=0,n=a.m_dataelements.length;s<n;++s){this.m_DataSource.Select(s);var o=this.IsHot(s);var l=this.IsSelected(r);var h=this.m_Pos.GetValueVector(r);var m=this.m_ColBorder.GetValueColor(r);if(l){m=this.GetSelectColor(r,m)}if(o){m=this.GetAltBorderColor(r,m)}var u=this.m_Radius.GetValueFloat(r);if(o){u=this.GetHotScale(r)[0]*u}var _=this.m_Slices.GetValueLong(r);var c=this.m_ColFill.GetValueColor(r);if(l){c=this.GetSelectColor(r,c)}if(o){c=this.GetHotColor(r,c)}this.m_LP[s]=[];this.RenderInstance(s,e,h,c,m,u,_,this.GetLabel(r));this.SetRichTooltip(o)}}this.BaseRender(t,e)};this.DetailHitTest=function(t,e,i,r){var a=this.m_BB[e];if(a.m_bArcCircle){var s=a.m_Radius;var n=a.m_Pos;var o,l;if((o=n[0]-i)*o+(l=n[1]-r)*l<s*s){return{m_hit:1}}return null}else{return VBI.Utilities.pointInPolygon(this.m_LP[e],i,r)?{m_hit:1}:null}};this.GetHitArray=function(t,e,i){var r=this.m_Scene.GetStretchFactor4Mode();var a=t/r[0];var s=e/r[1];var n={m_cb:this.DetailHitTest.bind(this),m_zf:r,m_All:i};return this.BaseHitTest(a,s,n)};this.DesignGetActiveBoxHandles=function(t){var e=this.m_Scene;this.m_DataSource.Select(t);return this.m_Radius.IsChangeable(e.m_Ctx)?[0,1,0,1,0,1,0,1,0]:[0,0,0,0,0,0,0,0,0]};this.DesignBoxSize=VBI.Utilities.SceneBindMeterRadiusDesignBoxSize.bind(this)};VBI.VisualObjects.CircleDist.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.m_AC=["rgba(0,143,211,1.0)","rgba(153,209,1,1.0)","rgba(243,155,2,1.0)","rgba(159,207,236,1.0)","rgba(75,167,7,1.0)","rgba(246,209,51,1.0)","rgba(203,77,44,1.0)","rgba(202,199,186,1.0)","rgba(13,134,156,1.0)","rgba(205,215,46,1.0)","rgba(36,114,48,1.0)","rgba(108,222,220,1.0)","rgba(235,115,0,1.0)","rgba(185,187,209,1.0)","rgba(0,109,211,1.0)","rgba(61,185,127,1.0)","rgba(165,84,148,1.0)","rgba(1,88,43,1.0)","rgba(77,182,239,1.0)","rgba(175,43,23,1.0)","rgba(212,153,18,1.0)","rgba(187,204,210,1.0)","rgba(48,146,13,1.0)","rgba(29,169,193,1.0)","rgba(42,71,201,1.0)","rgba(209,153,194,1.0)","rgba(204,88,38,1.0)","rgba(114,191,68,1.0)","rgba(10,72,157,1.0)","rgba(151,156,163,1.0)","rgba(14,145,144,1.0)","rgba(97,32,154,1.0)"];VBI.VisualObjects.Pie=function(){this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Series=new VBI.NodeProperty(t,"series",this.m_DataSource,e));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(t,"scale",this.m_DataSource,e,[1,1,1]));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"pos",this.m_DataSource,e));this.m_Props.push(this.m_Values=new VBI.AttributeProperty(t,"value",this.m_Series,e));this.m_Props.push(this.m_Texts=new VBI.AttributeProperty(t,"text",this.m_Series,e));this.m_Props.push(this.m_SliceColor=new VBI.AttributeProperty(t,"slicecolor",this.m_Series,e));this.m_Props.push(this.m_Tooltips=new VBI.AttributeProperty(t,"extooltip",this.m_Series,e,this.m_defaultTooltip));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_StartColor=new VBI.AttributeProperty(t,"startcolor",this.m_DataSource,e,0));this.BaseLoad(t,e,this)};this.LassoSelect=this.LassoSelectCircle;this.RenderInstance=function(t,e,i,r,a,s,n,o,l){var h=this.m_Scene;var m=h.GetZoomFactor4Mode();var u=h.m_Ctx;var _=0;var c;for(c=0;c<a.length;++c){_+=a[c]}this.m_SUM[t]=_;var f=h.GetPointFromPos(i,false);var d;var v=this.m_IO[t]=h.GetCorrectedInstanceOffsets(d=this.m_BB[t]=[f[0]-r,f[1]-r,f[0]+r,f[1]+r],m);d.m_Radius=r;d.m_Pos=f;if(this.IsPosChangeable(u)){var p=this.m_DH[t]=[];if(this.IsHandleMode()){p.m_EditMode=VBI.EMHandle;p.push(f)}else if(this.IsBoxMode()){p.m_EditMode=VBI.EMBox;p.push(d)}}this.m_ARC[t]=[3*Math.PI/2];var I=this.m_StartColor.GetValueLong(u);var B=VBI.VisualObjects.m_AC.length;for(var g=0;g<v.length;++g){e.setTransform(1,0,0,1,v[g],0);var S=3*Math.PI/2;for(c=0;c<a.length;++c){var b=e.createRadialGradient(f[0],f[1],0,f[0],f[1],r);var V=n[c];if(!V){V=VBI.VisualObjects.m_AC[(c+I)%B]}if(l){V=this.GetSelectColor(u,V)}if(c==o){V=this.GetHotColor(u,V)}b.addColorStop(0,V);b.addColorStop(.95,V);b.addColorStop(1,"rgba(255,255,255,0.0 )");e.fillStyle=b;e.beginPath();e.moveTo(f[0],f[1]);var P=Math.PI*2*(a[c]/_);e.arc(f[0],f[1],r,S,S+P,false);e.lineTo(f[0],f[1]);e.closePath();e.fill();S+=P;if(!g){this.m_ARC[t].push(S)}}}e.setTransform(1,0,0,1,0,0)};this.Init4Render=function(){this.m_BB=[];this.m_IO=[];this.m_DH=[];this.m_ARC=[];this.m_SUM=[]};this.Render=function(t,e,i){var r=this.m_Scene;var a=r.m_Ctx;var s=0;var n,o;if(n=this.m_DataSource.GetCurrentNode(a)){s=n.m_dataelements.length;for(var l=0;l<s;++l){this.m_DataSource.Select(l);var h=this.m_Pos.GetValueVector(a);var m=this.m_Scale.GetValueVector(a);var u=16*m[0];var _=this.IsHot(l);var c=this.IsSelected(a);if(_){u=this.GetHotScale(a)[0]*u}var f=[],d=[],v=[];if(o=this.m_Series.GetCurrentNode(a)){for(var p=0;p<o.m_dataelements.length;++p){this.m_Series.Select(p);f.push(this.m_Values.GetValueFloat(a));d.push(this.m_Texts.GetValueString(a));var I=this.m_SliceColor.GetValueString(a);v.push(I?this.m_SliceColor.GetValueColor(a):I)}}var B,g=_&&(B=r.m_HotItem.m_HitObj)&&(B=B.m_Detail)?B.m_slice:-1;this.RenderInstance(l,e,h,u,f,d,v,g,c);this.SetRichTooltip(_)}}this.BaseRender(t,e);return s};this.DetailHitTest=function(t,e,i,r){var a=this.m_BB[e];var s=a.m_Radius;var n=a.m_Pos;var o,l;if((o=n[0]-i)*o+(l=n[1]-r)*l<s*s){var h=Math.acos(l/Math.sqrt(o*o+l*l));var m=o<=0?3*Math.PI/2+h:7*Math.PI/2-h;var u=this.m_ARC[e];var _=0,c=u.length-1,f;while(c>_+1){f=Math.round((_+c)/2);if(u[f]>m){c=f}else{_=f}}return{m_hit:1,m_slice:_}}return null};this.GetHitArray=function(t,e,i){var r=this.m_Scene.GetStretchFactor4Mode();var a=t/r[0];var s=e/r[1];var n={m_cb:this.DetailHitTest.bind(this),m_All:i};return this.BaseHitTest(a,s,n)};this.doFormatedReplaces=function(t,e,i,r){var a=e.length;var s;while((s=t.indexOf(e))>=0){var n=s+t.substring(s+a).indexOf(i)+a+1;var o=t.substring(s+a,n-1);var l=false,h;if((h=o.indexOf(","))>=0){l=true}else{h=o.indexOf(".")}var m=Math.min(10,h>=0?parseInt(o.substring(h+1),10):0);var u=t.substring(s,n);var _=""+r.toFixed(m);if(l){_=_.replace(".",",")}t=t.replace(u,_)}return t};this.getTooltip=function(t,e){var i=e.m_Index;var r=e.m_Detail.m_slice;this.m_DataSource.Select(i);this.m_Series.Select(r);var a=this.m_Tooltips.GetValueString(t);if(a==""){a=this.m_Tooltip.GetValueString(t)}if(a===null||a===""){return""}a=a.replace(/%MAIN%/,this.m_Tooltip.GetValueString(t));a=a.replace(/%NUM%/g,r+1);a=a.replace(/%ONUM%/g,r+1);a=a.replace(/%NAME%/g,this.m_Texts.GetValueString(t));var s=parseFloat(this.m_Values.GetValueString(t));a=this.doFormatedReplaces(a,"%VALUE","%",s);a=this.doFormatedReplaces(a,"%PERCENTAGE","%",100*s/this.m_SUM[i]);return a};this.DesignBeginDrag=function(t){t.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);t.m_DhOrig=this.m_DH[t.m_Index].slice(0);if(t.m_IO){t.m_DhOrig[0][0]+=t.m_IO;t.m_DhOrig[0][2]+=t.m_IO}};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,true)};VBI.VisualObjects.Pie.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Box=function(){this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"pos",this.m_DataSource,e,[0,0,0]));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(t,"scale",this.m_DataSource,e,[1,1,1]));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(t,"color",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(t,"colorBorder",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_AltColorBorder=new VBI.AttributeProperty(t,"altBorderDeltaColor",this.m_DataSource,e,null));this.BaseLoad(t,e,this)};this.RenderInstance=function(t,e,i,r,a,s,n){var o,l=this.m_Scene;var h=l.GetZoomFactor4Mode();var m=l.GetStretchFactor4Mode();if(!r){r=[1,1,1]}if(!a){a="#6f6f7a"}var u=l.GetPointFromPos(i,false);var _=1;var c=1;if(this.IsHot(t)){var f=this.GetHotScale(l.m_Ctx);_=f[0];c=f[1]}var d=370;var v=d*r[0]*_/m[0];var p=d*r[1]*c/m[1];if(!n){var I=Math.pow(2,l.GetCurrentZoomlevel())/14.6;v*=I;p*=I}var B=u[0]-v/2;var g=u[1]-p/2;var S=u[0]+v/2;var b=u[1]+p/2;var V=this.m_IO[t]=l.GetCorrectedInstanceOffsets(o=this.m_BB[t]=[B,g,S,b],h);if(this.IsPosChangeable(l.m_Ctx)){var P=this.m_DH[t]=[];if(this.IsHandleMode()){P.m_EditMode=VBI.EMHandle;P.push(u)}else if(this.IsBoxMode()){P.m_EditMode=VBI.EMBox;P.push(o)}}for(var D=0;D<V.length;++D){e.setTransform(1,0,0,1,V[D],0);e.fillStyle=a;e.fillRect(B,g,v,p);e.lineWidth=1;e.strokeStyle=s;e.strokeRect(B,g,v,p);if(VBI.m_bTrace){VBI.Utilities.DrawFrameRect(e,"red",this.m_BB[t])}}e.setTransform(1,0,0,1,0,0)};this.Init4Render=this.StandardInit;this.Render=function(t,e,i){var r=this.m_Scene,a=r.m_Ctx;var s=0;var n;if(n=this.m_DataSource.GetCurrentNode(a)){s=n.m_dataelements.length;for(var o=0;o<s;++o){this.m_DataSource.Select(o);var l=this.IsHot(o);var h=this.IsSelected(a);var m=this.m_Pos.GetValueVector(a);var u=this.m_Scale.GetValueVector(a);var _=this.m_Color.GetValueColor(a);if(h){_=this.GetSelectColor(a,_)}if(l){_=this.GetHotColor(a,_)}var c=this.m_ColorBorder.GetValueColor(a);if(h){c=this.GetSelectColor(a,c)}if(l){c=this.GetAltBorderColor(a,c)}var f=this.m_FxSize.GetValueBool(a);this.RenderInstance(o,e,m,u,_,c,f);this.SetRichTooltip(l)}}this.BaseRender(t,e);return s};this.DetailHitTest=function(t,e,i,r){return{m_hit:1}};this.GetHitArray=function(t,e,i){var r=this.m_Scene.GetStretchFactor4Mode();var a=t/r[0];var s=e/r[1];var n={m_cb:this.DetailHitTest.bind(this),m_All:i};return this.BaseHitTest(a,s,n)};this.DesignBeginDrag=function(t){t.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);t.m_DhOrig=this.m_DH[t.m_Index].slice(0);if(t.m_IO){t.m_DhOrig[0][0]+=t.m_IO;t.m_DhOrig[0][2]+=t.m_IO}};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,false)};VBI.VisualObjects.Box.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Area=function(){this.m_LineWidth=1;this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));if(typeof t["posarraymulti.bind"]==="string"||typeof t["posarraymulti"]==="string"){this.m_Props.push(this.m_PosM=new VBI.AttributeProperty(t,"posarraymulti",this.m_DataSource,e));this.m_Pos=null}else{this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"posarray",this.m_DataSource,e));this.m_PosM=null}this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(t,"scale",this.m_DataSource,e));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(t,"color",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(t,"colorBorder",this.m_DataSource,e,null));this.m_Props.push(this.m_BorderDash=new VBI.AttributeProperty(t,"borderDash",this.m_DataSource,e,null));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_AltColorBorder=new VBI.AttributeProperty(t,"altBorderDeltaColor",this.m_DataSource,e,null));this.BaseLoad(t,e,this)};this.LassoSelect=function(t,e,i){var r=false;var a,s;var n=false;for(var o=this.m_LP.length-1;o>=0;--o){a=this.m_LP[o];r=false;for(var l=0;l<a.length;++l){s=a[l];if(jQuery.type(s[0])=="array"&&jQuery.type(s[0][0])=="array"){s=s[0]}if(!(r=VBI.Utilities.polyInPolygon(t,s,this.m_IO[o]))){break}}if(r){e.push(o);i.push(o);n=true}}return n};this.RenderArea=function(t,e,i,r,a,s,n,o){var l=n*n/2;var h,m,u,_;var c=this.m_Scene;var f=c.m_CacheVars;if(i[0].length<6){return}var d=this.m_LP[t];if(d.length){d=null}var v=e.setLineDash?true:false;var p=false;var I=this.m_Scene.m_Canvas[0].m_nExactLOD;if(v&&s&&(VBI.m_bIsIDevice||VBI.m_bIsAndroid||I==Math.floor(I)||I<=this.m_Scene.m_CacheVars.minLOD+.01)){var B=s.split(";");e.setLineDash(B);p=true}e.strokeStyle=a?a:r;e.fillStyle=r;e.lineWidth=o>-1?2:n;e.lineCap="round";var g=f.factX;var S=f.factY;var b=f.addX;var V=f.addY;e.beginPath();for(var P=0,D=i.length;P<D;++P){var C=[i[P][0]*g+b,i[P][1]*S+V];if(d){d.push([]);d[P].push(C)}e.moveTo(C[0],C[1]);var G=i[P].length;for(h=3;h<G;h+=3){m=[i[P][h]*g+b,i[P][h+1]*S+V,0];if((u=C[0]-m[0])*u+(_=C[1]-m[1])*_<l){continue}e.lineTo(m[0],m[1]);if(d){d[P].push(m)}C=m}}e.closePath();e.fill();e.stroke();if(p){e.setLineDash([])}};this.CalculateLabelPos=function(t,e,i){var r=t.GetStretchFactor4Mode();var a=t.GetInternalDivClientRect();var s=a.width/r[0];var n=a.height/r[1];var o=t.m_Canvas[0].getPixelLeft()/r[0];var l=t.m_Canvas[0].getPixelTop()/r[1];var h=[-o,-l,-o+s,-l+n];var m=VBI.Utilities.GetMidpointsForPolygon(e.pa,e.bb,i,h);if(m&&m.aPos){return m.aPos}return null};this.ExtendBB=function(t,e){if(t[0]>e[0]){t[0]=e[0]}if(t[1]>e[1]){t[1]=e[1]}if(t[2]<e[2]){t[2]=e[2]}if(t[3]<e[3]){t[3]=e[3]}};this.IsPosChangeable=function(t){if(!VBI.m_bMouseSupported){return false}if(this.m_PosM){return this.m_PosM.IsChangeable(t)}else{return Object.getPrototypeOf(this).IsPosChangeable.call(this,t)}};this.CalcExcludeAreaMinLod=function(t,e,i,r){var a=t.GetNearestPosArray(e);var s=t.GetPointFromPos([a.m_MinX,a.m_MaxY,0],false);var n=t.GetPointFromPos([a.m_MaxX,a.m_MinY,0],false);return this.CalcAreaMinLod(s,n,i,r)};this.RenderShape=function(t,e,i,r,a,s,n,o,l,h){var m=this.m_Scene;var u=false,_;if(typeof i[0]==="number"){_=i}else{_=i[0];u=true}var c=m.GetZoomFactor4Mode();var f=m.m_CacheVars;if(_.cache==undefined){m.FillPositionCache(_)}var d=2.1;if(_.cache.minLod>h-d){return}var v=[(_.cache.lt[0]*f.completeX-f.ox)*f.fx,(_.cache.lt[1]*f.completeY-f.oy)*f.fy];var p=[(_.cache.rb[0]*f.completeX-f.ox)*f.fx,(_.cache.rb[1]*f.completeY-f.oy)*f.fy];var I,B=m.GetCorrectedInstanceOffsets(I=[v[0]-n,v[1]-n,p[0]+n,p[1]+n],c);if(this.m_BB[t]){this.ExtendBB(this.m_BB[t],I);this.m_IO[t]=m.GetCorrectedInstanceOffsets(this.m_BB[t],c)}else{this.m_IO[t]=B;this.m_BB[t]=I}var g;var S=null;if(B.length){S=[];S.push(_.cache.data);if(u){for(var b=1,V=i.length;b<V;++b){var P=i[b];if(P.cache==undefined){m.FillPositionCache(P)}if(P.cache.minLod<=h+d){S.push(P.cache.data)}}}if(this.IsPosChangeable(m.m_Ctx)){var D=this.m_DH[t]=[];if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;var C=S[0].length/3;for(g=0;g<C;++g){D.push([(S[0][g*3]*f.completeX-f.ox)*f.fx,(S[0][g*3+1]*f.completeY-f.oy)*f.fy])}}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(this.m_BB[t])}}for(g=0;g<B.length;++g){e.setTransform(1,0,0,1,B[g],0);this.RenderArea(t,e,S,r,a,s,n,o);if(VBI.m_bTrace){VBI.Utilities.DrawFrameRect(e,"red",this.m_BB[t])}}e.setTransform(1,0,0,1,0,0);if(l){var G=m.GetShortPointArrayFromUCSArray(_.cache.data);var x={pa:G,bb:[v,p]};this.m_Label.push(new VBI.Label(l,t,this.CalculateLabelPos,x,null,B))}}};this.RenderInstance=function(t,e,i,r,a,s){this.m_LP[t]=[];var n=this.m_Scene;var o=-1;var l=this.m_Color.GetValueColor(r);var h=this.m_ColorBorder.GetValueColor(r);var m=this.m_BorderDash.GetValueString(r);if(a){l=this.GetSelectColor(r,l);h=this.GetAltBorderColor(r,h)}else if(this.GetNumActiveSelections(r)){l=this.GetNonSelectColor(r,l)}if(i){var u=n.m_HotItem.m_HitObj.m_Detail;if(u&&u.m_edge>=0&&(this.BaseFindAction("EdgeClick")||this.BaseFindAction("EdgeContextMenu"))){o=u.m_edge}else{l=this.GetHotColor(r,l)}h=this.GetAltBorderColor(r,h)}var _;if(this.m_Pos){_=this.m_Pos.GetValueVector(r);this.RenderShape(t,e,_,l,h,m,this.m_LineWidth,o,this.GetLabel(r),s)}else if(this.m_PosM){var c=this.m_PosM.GetValueVector(r);var f=[];for(var d=0,v=c.length;d<v;++d){this.RenderShape(t,e,c[d],l,h,m,this.m_LineWidth,o,this.GetLabel(r),s);if(this.m_LP[t].length){f.push(this.m_LP[t]);this.m_LP[t]=[]}}this.m_LP[t]=f}};this.Init4Render=this.StandardInitWithLPs;this.Render=function(t,e,i){var r=this.m_Scene.m_Ctx;var a=[];var s,n;var o;var l=this.m_Scene.m_Canvas[0].m_nExactLOD;if(s=this.m_DataSource.GetCurrentNode(r)){n=s.m_dataelements.length;for(var h=0;h<n;++h){this.m_DataSource.Select(h);var m=this.IsHot(h);if(m){o=h}else if(this.IsSelected(r)){a.push(h)}else{this.RenderInstance(h,e,false,r,false,l)}this.SetRichTooltip(m)}}n=a.length;for(var u=0;u<n;u++){this.m_DataSource.Select(a[u]);this.RenderInstance(a[u],e,false,r,true,l)}if(o!=undefined){this.m_DataSource.Select(o);this.RenderInstance(o,e,true,r,this.IsSelected(r),l)}this.BaseRender(t,e)};this.DetailHitTest=function(t,e,i,r){var a=false;var s;var n=this.m_LP[e];if(jQuery.type(n[0])=="array"&&jQuery.type(n[0][0])=="array"&&jQuery.type(n[0][0][0])=="array"){s=n.length;for(var o=0;!a&&o<s;++o){n=this.m_LP[e][o];a=VBI.Utilities.pointInPolygon(n,i,r)}}else{a=VBI.Utilities.pointInPolygon(n,i,r)}if(a){var l={m_hit:1};var h;if((h=VBI.Utilities.pointOnLine(n[0],i,r,5,true))&&h.m_edge>=0){l.m_edge=h.m_edge;l.m_node=h.m_node}return l}return null};this.GetHitArray=function(t,e,i){var r=this.m_Scene.GetStretchFactor4Mode();var a=t/r[0];var s=e/r[1];var n={m_cb:this.DetailHitTest.bind(this),m_All:i};return this.BaseHitTest(a,s,n)};this.ProcessDetailNodeEdgeEvent=function(t,e,i,r){var a=this.m_Scene,s=a.m_Ctx.m_Actions;if(s){var n;if(n=s.findAction(r,a,this)){var o=a.GetEventVPCoordsObj(t);o.edge=i.m_Detail.m_edge.toString();o.node=i.m_Detail.m_node.toString();this.m_Scene.m_Ctx.FireAction(n,a,this,e,o);return true}}return false};this.DetailClick=function(t,e,i){if(i.m_Detail&&i.m_Detail.m_edge>=0){return this.ProcessDetailNodeEdgeEvent(t,e,i,"EdgeClick")}return false};this.DetailContextmenu=function(t,e,i){if(i.m_Detail&&i.m_Detail.m_edge>=0){return this.ProcessDetailNodeEdgeEvent(t,e,i,"EdgeContextMenu")}return false};this.DesignBoxSize=VBI.Utilities.SceneBindPosArrayDesignBoxSize.bind(this)};VBI.VisualObjects.Area.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.HeatMap=function(){this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"pos",this.m_DataSource,e));this.m_Props.push(this.m_Value=new VBI.AttributeProperty(t,"value",this.m_DataSource,e,1));this.m_Props.push(this.m_Opacity=new VBI.AttributeProperty(t,"opacity",this.m_DataSource,e,.5));this.m_Props.push(this.m_Gradient=new VBI.AttributeProperty(t,"gradient",this.m_DataSource,e,""));this.m_Props.push(this.m_Radius=new VBI.AttributeProperty(t,"radius",this.m_DataSource,e,5));this.m_Props.push(this.m_Behavior=new VBI.AttributeProperty(t,"behavior",this.m_DataSource,e,2));this.m_Props.push(this.m_RScale=new VBI.AttributeProperty(t,"radiusScale",this.m_DataSource,e,1));this.m_Props.push(this.m_VScale=new VBI.AttributeProperty(t,"valueScale",this.m_DataSource,e,1));this.m_Props.push(this.m_AExp=new VBI.AttributeProperty(t,"alphaExponent",this.m_DataSource,e,1));this.m_Props.push(this.m_CExp=new VBI.AttributeProperty(t,"colorExponent",this.m_DataSource,e,1));var i=jQuery.type(this.m_Gradient.m_Value)=="array";this.GradientImage=new Image;this.GradientImage.onload=function(){this.GradientImage.IsLoaded=true}.bind(this);if(i){this.m_GeneratedGradient=this.GenerateGradient(this.m_Gradient.m_Value);this.GradientImage.src=this.m_GeneratedGradient}else{this.GradientImage.src=e.GetResources().GetData(this.m_Gradient.GetValueString(e))}this.cache=undefined;this.BaseLoad(t,e,this)};this.SetColor=function(t,e,i,r,a,s){var n=4*e;t[n]=r[0]*i+s[0]*a;t[n+1]=r[1]*i+s[1]*a;t[n+2]=r[2]*i+s[2]*a;t[n+3]=r[3]*i+s[3]*a};this.SetColor1=function(t,e,i){var r=4*e;t[r]=i[0];t[r+1]=i[1];t[r+2]=i[2];t[r+3]=255};this.GenerateGradient=function(t){var e=t.length/2;var i=t[2*(e-1)];var r=this.m_Scene.m_TargetName+"-"+this.m_Scene.m_ID+"-";var a=VBI.Utilities.CreateGeoSceneCanvas(r+"temporary",i,1,0,false);var s=a.getContext("2d");var n=[];s.lineWidth=1;var o;for(o=0;o<e;++o){s.fillStyle=t[2*o+1];s.fillRect(t[2*o],0,1,1);var l=s.getImageData(t[2*o],0,1,1);n.push(l.data)}var h=s.getImageData(0,0,i,1);for(o=1;o<e;++o){var m=n[o-1];var u=VBI.Utilities.RGB2HLS(m[0],m[1],m[2]);var _=u[0];var c=u[1];var f=u[2];var d=t[2*(o-1)],v=t[2*o],p=v-d;var I=n[o];var B=VBI.Utilities.RGB2HLS(I[0],I[1],I[2]);var g=B[0];var S=(g-_)/p;for(var b=d;b<=v;++b){var V=VBI.Utilities.HLS2RGB(_+(b-d)*S,c,f);this.SetColor1(h.data,b,V)}}s.putImageData(h,0,0);return a.toDataURL("png")};this.CollectData=function(t){var e=this.m_Scene;var i,r=[],a=[],s=[];var n=[];var o=0;if(i=this.m_DataSource.GetCurrentNode(t)){for(var l=0,h=i.m_dataelements.length;l<h;++l){this.m_DataSource.Select(l);var m=this.m_Pos.GetValueVector(t);n.push({x:m[0],y:m[1],r:this.m_Radius.GetValueFloat(t),v:this.m_Value.GetValueFloat(t)})}n.sort(function(t,e){return t.x-e.x});for(var u=0;u<n.length;++u){var _=n[u];r.push(_.v);a.push(_.r);s.push(_.x,_.y,0);if(_.r>o){o=_.r}}}e.FillPositionCache(s,true);this.cache=s.cache;this.cache.val=r;this.cache.rad=a;this.cache.maxRad=o};this.Init4Render=function(){this.m_IO=[]};this.AddPoints2Heatmap=function(t,e,i,r,a){var s=t.m_V;var n=this.m_Scene;t.Clear();var o,l;var h=t.m_W;var m=t.m_H;var u=i*e.maxRad/r/2;var _=n.GetPointArrayFromUCSArray(e.data);for(var c=0;c<this.m_IO.length;++c){var f=e.data.length;var d=this.m_IO[c];var v=_[0]+d,p=_[f-3]+d;var I=0,B=f/3,g=0,S=0,b;if(v<=-u&&p>-u){I=f/3;while(I>g+1){b=Math.floor((g+I)/2);if(_[3*b]+d<=-u){g=b}else{I=b}}}if(v>m+u&&p<=m+u){while(B>S+1){b=Math.floor((S+B)/2);if(_[3*b]+d<=m+u){S=b}else{B=b}}}for(var V=3*I,P=I;P<B;V+=3,P++){var D=_[V]+d;var C=_[V+1];l=i*e.rad[P]/r/2;if(C>-l&&D<h+l){o=a*e.val[P]/50;s.AddPoint(D,C,o,l)}}}s.m_PointsSet=true};this.Render=function(t,e){var i=this.m_Scene;var r=i.m_Ctx;var a=t.clientWidth;var s=t.clientHeight;var n=i.m_nWidthCanvas;var o=i.m_nHeightCanvas;var l=this.m_GeneratedGradient?this.m_GeneratedGradient:r.GetResources().GetData(this.m_Gradient.GetValueString(r));if(this.HeatmapWidth!=n||this.HeatmapHeight!=o){var h=document.createElement("canvas");h.width=2*n;h.height=2*o;this.Heatmap=VBI.CreateHM({canvas:h,colorTexture:l,colorTex:this.GradientImage,alpha:true,width:2*n,height:2*o,scene:this.m_Scene,aFunc:this.m_AExp.GetValueFloat(r),cFunc:this.m_CExp.GetValueFloat(r)});this.HeatmapWidth=n;this.HeatmapHeight=o}var m=this.Heatmap;if(!this.cache){this.CollectData(r)}var u=i.GetPointFromUCSPoint([this.cache.lt[0],this.cache.lt[1]]);var _=i.GetPointFromUCSPoint([this.cache.rb[0],this.cache.rb[1]]);var c=i.GetZoomFactor4Mode();this.m_IO=i.GetCorrectedInstanceOffsets([u[0],u[1],_[0],_[1]],c);var f=this.m_RScale.GetValueFloat(r);var d=this.m_VScale.GetValueFloat(r);var v=this.m_Behavior.GetValueFloat(r);var p=i.m_Canvas[0].m_nExactLOD;var I=Math.floor(p);var B=(i.m_bObjCanvasMode==0?Math.pow(2,p-I):1)/f;var g=1;if(v>0){g=1+i.m_Canvas[0].m_nExactLOD;if(v==2){g=Math.pow(2,g)}}this.AddPoints2Heatmap(m,this.cache,g,B,d);m.Render();var S=e.globalAlpha;e.globalAlpha=this.m_Opacity.GetValueFloat(r);e.drawImage(m.m_Canv,0,0,a,s,0,0,a,s);e.globalAlpha=S};this.DetailHitTest=function(t,e,i,r){return null};this.GetHitArray=function(t,e){var i=this.m_Scene.GetStretchFactor4Mode();var r=t/i[0];var a=e/i[1];var s={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(r,a,s)};this.DesignBeginDrag=function(t){t.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);t.m_DhOrig=this.m_DH[t.m_Index].slice(0);if(t.m_IO){t.m_DhOrig[0][0]+=t.m_IO;t.m_DhOrig[0][2]+=t.m_IO}};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,true)};VBI.VisualObjects.HeatMap.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Container=function(){this.m_Sub=[];this.m_bContainer=true;this.m_openWin=[];this.m_Marker=1;this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"pos",this.m_DataSource,e));this.m_Props.push(this.m_Key=new VBI.AttributeProperty(t,"key",this.m_DataSource,e,""));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,""));this.m_Props.push(this.m_Alignment=new VBI.AttributeProperty(t,"alignment",this.m_DataSource,e,"0"));this.m_Sub.push(this.m_Scene.m_EvtCont.subscribe("onMove",this.onLayout.bind(this)));this.m_bChanged=true};this.clear=function(){for(var t=0,e=this.m_Sub.length;t<e;++t){this.m_Sub[t].unsubscribe()}this.m_Sub=[];this.m_Marker++;this.sweepContainers(this.m_Scene.m_Ctx);Object.getPrototypeOf(this).clear.call(this)};this.getParentDiv=function(){return this.m_Scene.m_MapsLayerDiv};this.sweepContainers=function(t){for(var e in this.m_openWin){if(this.m_openWin[e].Marker!=this.m_Marker){var i=this.m_openWin[e];t.onCloseContainer(i.id,i);var r=this.getParentDiv();r.removeChild(i);delete this.m_openWin[e]}}};this.updateContainers=function(t,e,i){var r=this.getParentDiv();var a=t.getPixelLeft();var s=t.getPixelTop();var n,o;var l;if(l=this.m_DataSource.GetCurrentNode(i)){n=l.m_dataelements.length;for(o=0;o<n;++o){this.m_DataSource.Select(o);var h=this.m_Pos.GetValueVector(i);var m=this.m_Key.GetValueString(i);var u=this.m_Tooltip.GetValueString(i);var _=e.GetPointFromPos(h,false);var c=this.m_openWin[m];if(c){if(!c.children.length){i.onOpenContainer(m,c)}}else{c=VBI.Utilities.CreateContainer("vbi_"+m,m,a+(_[0]|0),s+(_[1]|0),"50px","30px",u);c.addEventListener("mouseover",this.onMouseOverDiv.bind(c));c.addEventListener("mouseout",this.onMouseOutDiv.bind(c));c.m_ID=this.m_ID;this.m_openWin[m]=c;this.m_openWin[m].index=o;r.appendChild(c);i.onOpenContainer(m,c)}this.m_openWin[m].Marker=this.m_Marker}}this.sweepContainers(i)};this.onMouseOverDiv=function(){this.bIsHot=true};this.onMouseOutDiv=function(){this.bIsHot=false};this.onLayout=function(t){var e=this.m_Scene;var i=e.m_Canvas[e.m_nOverlayIndex];this.clusterParams=this.GetClusterPosParameters();var r=e.m_Canvas[0].m_nExactLOD;if(!this.m_LastCanvasPos||this.m_LastCanvasPos[2]!=r){return}var a=[i.getPixelLeft()-this.m_LastCanvasPos[0],i.getPixelTop()-this.m_LastCanvasPos[1]];for(var s in this.m_openWin){var n=this.m_openWin[s];if(a[0]){var o=parseFloat(n.style.left)+a[0];o+=this.findRoundWorldOffset(o);n.style.left=o+"px"}if(a[1]){n.style.top=parseInt(n.style.top,10)+a[1]+"px"}}this.m_LastCanvasPos=[i.getPixelLeft(),i.getPixelTop(),e.m_Canvas[0].m_nExactLOD]};this.ContainerAlign=function(t,e){var i=this.m_Alignment.GetValueString(e);var r=t.style;switch(i){case"0":r.msTransform=r.transform=r.webkitTransform="translate( -50%, -50%)";break;case"1":r.msTransform=r.transform=r.webkitTransform="translate( -50%,   0%)";break;case"2":r.msTransform=r.transform=r.webkitTransform="translate(-100%,   0%)";break;case"3":r.msTransform=r.transform=r.webkitTransform="translate(-100%, -50%)";break;case"4":r.msTransform=r.transform=r.webkitTransform="translate(-100%,-100%)";break;case"5":r.msTransform=r.transform=r.webkitTransform="translate( -50%,-100%)";break;case"6":r.msTransform=r.transform=r.webkitTransform="translate(   0%,-100%)";break;case"7":r.msTransform=r.transform=r.webkitTransform="translate(   0%, -50%)";break;default:case"8":r.msTransform=r.transform=r.webkitTransform="translate(0%, 0%)";break}};this.RenderInstances=function(t,e){var i=this.m_Scene;var r=i.m_Ctx;if(this.m_bChanged){this.updateContainers(t,i,r);this.m_bChanged=false}var a=t.getPixelLeft();var s=t.getPixelTop();if(this.m_DataSource.GetCurrentNode(r)){for(var n in this.m_openWin){var o=this.m_openWin[n];if(o.index==undefined){continue}this.m_DataSource.Select(o.index);var l=this.m_Pos.GetValueVector(r);var h=i.GetPointFromPos(l,true);var m=Math.round(a+(h[0]|0)*e[0]);m=m+this.findRoundWorldOffset(m);o.style.left=m+"px";o.style.top=Math.round(s+(h[1]|0)*e[1])+"px";this.ContainerAlign(o,r)}}};this.GetClusterPosParameters=function(){var t={};var e=this.m_Scene;var i=e.m_Canvas[0].m_nExactLOD;t.worldPxOnLOD=Math.pow(2,i)*e.m_nWidthCanvas/e.m_nTilesX*e.m_Proj.m_nXYRatio;t.nLeftBorder=e.m_nDivWidth-t.worldPxOnLOD;t.nRightBorder=e.m_nDivWidth-t.nLeftBorder;return t};this.findRoundWorldOffset=function(t){var e=0;var i=this.clusterParams;while(t+e<i.nLeftBorder){e+=i.worldPxOnLOD}while(t+e>i.nRightBorder){e-=i.worldPxOnLOD}return e};this.GetClusterPosition=function(t,e,i,r,a,s,n,o){var l;var h=this.m_Scene;var m=t.canvas.getPixelLeft();var u=t.canvas.getPixelTop();var _=h.GetCurrentZoomFactors();l=[m+_[0]*(s*e[0]-n),u+_[1]*(s*e[1]-o)];var c=this.findRoundWorldOffset(l[0]);var f=this.m_Scene.GetZoomFactor4Mode();l[0]+=c;l[2]=c/f[0];if(e.c!=undefined&&i.anim&&r>i.animLow&&a&&e.c!=undefined&&e.c.lod==r-1){var d=this.m_Scene.GetStretchFactor4Mode();var v=e.c;var p=a*a;l=[m+c+_[0]*(s*(e[0]*(1-p)+v[0]*p)-n),u+_[1]*(s*(e[1]*(1-p)+v[1]*p)-o),c/f[0]];if(i.anim==2){var I=[c+f[0]*(s*v[0]-n),f[1]*(s*v[1]-o)];var B=2*Math.abs(.5-a);var g=""+(1-B);t.strokeStyle="rgba(110,110,110,"+g+")";t.lineWidth=2;t.lineCap="round";t.beginPath();t.moveTo((l[0]-m)/d[0],(l[1]-u)/d[0]);t.lineTo(I[0],I[1]);t.stroke()}}return l};this.RenderThisInstance=function(t,e,i,r,a,s,n,o,l,h,m,u,_,c){var f=this.m_Scene;var d=this.m_Scene.m_Ctx;var v=this.getParentDiv();var p=this.GetClusterPosition(n,t,i,l,h,m,u,_);var I=f.m_Ctx.m_Clustering.getClusterIdent(f.m_PreassembledData,r,s);var B=this.m_openWin[I];if(B==undefined){B=VBI.Utilities.CreateContainer("vbi_"+I,I,p[0],p[1],"50px","30px","",true);B.addEventListener("mouseover",this.onMouseOverDiv.bind(B));B.addEventListener("mouseout",this.onMouseOutDiv.bind(B));B.m_ID=this.m_ID;B.index=t.nJ;v.appendChild(B);this.m_openWin[I]=B;d.onOpenContainer(I,B);this.ContainerAlign(B,d)}else{if(B.bIsHot){this.RenderShadow(o,t,e,i,l,m,u-p[2],_)}B.style.left=Math.round(p[0])+"px";B.style.top=Math.round(p[1])+"px"}this.m_openWin[I].Marker=this.m_Marker};this.Render=function(t,e,i,r,a,s){var n=this.m_Scene;var o=this.m_Scene.m_Ctx;var l=n.m_Canvas[0].m_nExactLOD;this.m_Marker++;this.clusterParams=this.GetClusterPosParameters();if(s){var h=0;var m=n.m_Canvas[0].m_nCurrentX*n.m_MapManager.m_tileWidth;var u=n.m_Canvas[0].m_nCurrentY*n.m_MapManager.m_tileHeight;var _=i.config;var c=i.cI;var f=i.m_TreeFatherNode;var d=Math.ceil(l);if(f){var v=this.GetAnimClusterDistance(d,l);h=this.RenderTree(f,i.m_edges,_,c,h,d,v,e,a,i.m_lodOffset,m,u,false)}else{var p=i.m_lodOffset;var I=i.length;for(var B=0;B<I;++B){var g=i[B];if(!g.b2Ignore){if(this.RenderThisInstance(g,i.m_edges,_,c,h,B,e,a,d,0,p,m,u,false)){h++}}}}this.sweepContainers(o)}else if(this.m_DataSource.GetCurrentNode(o)){var S=this.m_Scene.GetStretchFactor4Mode();this.RenderInstances(t,[S[0],S[1]])}var b=n.m_Canvas[n.m_nOverlayIndex];this.m_LastCanvasPos=[b.getPixelLeft(),b.getPixelTop(),l]};this.GetHitArray=function(t,e){var i=[];for(var r in this.m_openWin){var a=this.m_openWin[r];if(a&&a.bIsHot){i.push({m_Index:a.index,m_Entity:null,m_Detail:{m_hit:2},m_IO:0})}}return i};this.onclick=function(t){return this.BaseClick(t)}};VBI.VisualObjects.Container.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Base2D=function(){this.m_DOMElement=null;this.m_paddingLeft=5;this.m_paddingTop=5;this.m_paddingRight=5;this.m_paddingBottom=5;this.IsValid=function(){if(this.m_DOMElement&&this.m_Scene.m_Div){if(this.m_DOMElement.parentNode==this.m_Scene.m_Div){return true}}return false};this.load=function(t,e,i){Object.getPrototypeOf(this).load.call(t,e,i);t.m_Props.push(t.m_Left=new VBI.AttributeProperty(e,"left",null,i));t.m_Props.push(t.m_Top=new VBI.AttributeProperty(e,"top",null,i));t.m_Props.push(t.m_Right=new VBI.AttributeProperty(e,"right",null,i));t.m_Props.push(t.m_Bottom=new VBI.AttributeProperty(e,"bottom",null,i));t.m_Props.push(t.m_Align=new VBI.AttributeProperty(e,"align",null,i,1))};this.clear=function(){Object.getPrototypeOf(Object.getPrototypeOf(this)).clear.call(this);this.m_DOMElement=null};this.BaseClick=function(t){var e=this.m_Scene;var i;if(i=e.m_Ctx.m_Actions){var r;if(r=i.findAction("Click",e,this)){e.m_Ctx.FireAction(r,e,this,null,e.GetEventVPCoordsObj(t));t.preventDefault();return true}}return false}};VBI.VisualObjects.Base2D.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Caption=function(){this.m_LineWidth=1;this.load=function(t,e){Object.getPrototypeOf(this).load(this,t,e);this.m_Props.push(this.m_Text=new VBI.AttributeProperty(t,"text",null,e,""));this.m_Props.push(this.m_Design=new VBI.AttributeProperty(t,"design",null,e,"0"));this.m_Props.push(this.m_Level=new VBI.AttributeProperty(t,"level",null,e,0));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",null,e,""))};this.Render=function(t,e,i){if(this.IsValid()){return}var r=this.m_Scene.m_Ctx;var a=this.m_Left.GetValueLong(r);var s=this.m_Top.GetValueLong(r);var n=this.m_Right.GetValueLong(r);var o=this.m_Bottom.GetValueLong(r);var l=this.m_Align.GetValueLong(r);var h=this.m_Text.GetValueString(r);var m=this.m_Design.GetValueLong(r);var u=this.m_Level.GetValueLong(r);var _=this.m_Tooltip.GetValueString(r);this.m_DOMElement=VBI.Utilities.CreateCaption(this.m_ID,h,a+this.m_paddingLeft,s+this.m_paddingTop,n+this.m_paddingLeft,o+this.m_paddingTop,_,m,u,l);this.m_Scene.m_Div.appendChild(this.m_DOMElement)}};VBI.VisualObjects.Caption.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Label=function(){this.m_LineWidth=1;this.load=function(t,e){Object.getPrototypeOf(this).load(this,t,e);this.m_Props.push(this.m_Text=new VBI.AttributeProperty(t,"text",null,e,""));this.m_Props.push(this.m_Design=new VBI.AttributeProperty(t,"design",null,e,"0"))};this.Render=function(t,e,i){if(this.IsValid()){return}var r=this.m_Scene.m_Ctx;var a=this.m_Left.GetValueLong(r);var s=this.m_Top.GetValueLong(r);var n=this.m_Right.GetValueLong(r);var o=this.m_Align.GetValueLong(r);var l=this.m_Bottom.GetValueLong(r);var h=this.m_Text.GetValueString(r);this.m_DOMElement=VBI.Utilities.CreateLabel(this.m_ID,h,a+this.m_paddingLeft,s+this.m_paddingTop,n+this.m_paddingLeft,l+this.m_paddingTop,0,o);this.m_Scene.m_Div.appendChild(this.m_DOMElement)}};VBI.VisualObjects.Label.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Link=function(){this.m_LineWidth=1;this.load=function(t,e){Object.getPrototypeOf(this).load(this,t,e);this.m_Props.push(this.m_Reference=new VBI.AttributeProperty(t,"reference",null,""));this.m_Props.push(this.m_Autoexecute=new VBI.AttributeProperty(t,"autoexecute",null,e,false));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",null,e,""));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(t,"text",null,e,""))};this.clear=function(){if(this.m_DOMElement){this.m_DOMElement.onclick=null}Object.getPrototypeOf(this).clear.call(this)};this.Render=function(t,e,i){if(this.IsValid()){return}var r=this.m_Scene.m_Ctx;var a=this.m_Left.GetValueLong(r);var s=this.m_Top.GetValueLong(r);var n=this.m_Right.GetValueLong(r);var o=this.m_Bottom.GetValueLong(r);var l=this.m_Align.GetValueLong(r);var h=this.m_Text.GetValueString(r);var m=this.m_Reference.GetValueString(r);var u=this.m_Autoexecute.GetValueBool(r);var _=this.m_Tooltip.GetValueString(r);this.m_DOMElement=VBI.Utilities.CreateLink(this.m_ID,h,a+this.m_paddingLeft,s+this.m_paddingTop,n+this.m_paddingLeft,o+this.m_paddingTop,u?m:null,_,l);this.m_Scene.m_Div.appendChild(this.m_DOMElement);this.m_DOMElement.onclick=this.onclick.bind(this)};this.onclick=function(t){return this.BaseClick(t)}};VBI.VisualObjects.Link.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Image=function(){this.load=function(t,e){Object.getPrototypeOf(this).load(this,t,e);this.m_Props.push(this.m_Image=new VBI.AttributeProperty(t,"image",null,e));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",null,e,""))};this.Render=function(t,e,i){if(this.IsValid()){return}var r=this.m_Scene.m_Ctx;var a=this.m_Left.GetValueLong(r);var s=this.m_Top.GetValueLong(r);var n=this.m_Right.GetValueLong(r);var o=this.m_Bottom.GetValueLong(r);var l=this.m_Align.GetValueLong(r);var h=this.m_Image.GetValueString(r);var m=this.m_Tooltip.GetValueString(r);var u;if(u=r.GetResources().GetImage(h)){this.m_DOMElement=VBI.Utilities.CreateImage(this.m_ID,u,a+this.m_paddingLeft,s+this.m_paddingTop,n+this.m_paddingLeft,o+this.m_paddingTop,m,l);this.m_Scene.m_Div.appendChild(this.m_DOMElement)}}};VBI.VisualObjects.Image.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Button=function(){this.load=function(t,e){Object.getPrototypeOf(this).load(this,t,e);this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",null,e,""));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(t,"text",null,e,""))};this.clear=function(){if(this.m_DOMElement){this.m_DOMElement.onclick=null}Object.getPrototypeOf(this).clear.call(this)};this.Render=function(t,e,i){if(this.IsValid()){return}var r=this.m_Scene.m_Ctx;var a=this.m_Left.GetValueLong(r);var s=this.m_Top.GetValueLong(r);var n=this.m_Right.GetValueLong(r);var o=this.m_Bottom.GetValueLong(r);var l=this.m_Text.GetValueString(r);var h=this.m_Tooltip.GetValueString(r);this.m_DOMElement=VBI.Utilities.CreateButton(this.m_ID,l,a+this.m_paddingLeft,s+this.m_paddingTop,n+this.m_paddingLeft,o+this.m_paddingTop,h);this.m_Scene.m_Div.appendChild(this.m_DOMElement);this.m_DOMElement.onclick=this.onclick.bind(this)};this.onclick=function(t){return this.BaseClick(t)}};VBI.VisualObjects.Button.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Dummy=function(){this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e)};this.RenderInstance=function(t,e,i,r,a){};this.Render=function(t,e,i){this.BaseRender(t,e)};this.RenderShadow=function(t,e,i,r,a,s){}};VBI.VisualObjects.Dummy.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Box3D=function(){this.load=function(t,e){Object.getPrototypeOf(this).load.call(this,t,e);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(t,"datasource",null,e));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(t,"pos",this.m_DataSource,e,[0,0,0]));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(t,"scale",this.m_DataSource,e,[1,1,1]));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(t,"tooltip",this.m_DataSource,e,this.m_defaultTooltip));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(t,"color",this.m_DataSource,e,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(t,"colorBorder",this.m_DataSource,e,this.m_defaultColor));this.BaseLoad(t,e,this)};this.RenderInstance=function(t,e,i,r,a,s){if(!i){i=[1,1,1]}if(!r){r="#6f6f7a"}};this.Render=function(t){var e=this.m_Scene;if(!e.m_bMainSceneInitialized){return 0}var i=e.m_Ctx;var r=0;var a;if(a=this.m_DataSource.GetCurrentNode(i)){r=a.m_dataelements.length;for(var s=0;s<r;++s){this.m_DataSource.Select(s);var n=this.IsHot(s);var o=this.IsSelected(i);var l=this.m_Pos.GetValueVector(i);var h=this.m_Scale.GetValueVector(i);var m=this.m_Color.GetValueColor(i);if(o){m=this.GetSelectColor(i,m)}if(n){m=this.GetHotColor(i,m)}var u=this.m_ColorBorder.GetValueColor(i);if(o){u=this.GetSelectColor(i,u)}if(n){u=this.GetHotColor(i,u)}var _=this.m_FxSize.GetValueBool(i);this.RenderInstance(s,l,h,m,u,_)}}return r};this.DetailHitTest=function(t,e,i,r){};this.GetHitArray=function(t,e){}};VBI.VisualObjects.Box3D.prototype=VBI.VisualObjects.Base;return e}});