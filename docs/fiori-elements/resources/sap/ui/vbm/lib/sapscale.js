/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./sapvbi"],function(){"use strict";VBI.SupportedUnitsOfLength=[{RequestedUnit:"km",DisplayUnitDefault:"m",DisplayUnit2:"km",ConvFactor:1e3,ConvFactorMeter:1},{RequestedUnit:"mi",DisplayUnitDefault:"ft",DisplayUnit2:"mi",ConvFactor:5280,ConvFactorMeter:.3048},{RequestedUnit:"nm",DisplayUnitDefault:"ft",DisplayUnit2:"nm",ConvFactor:6076.12,ConvFactorMeter:.3048}];VBI.Scale=function(){var t={};t.scene=null;t.m_ID=null;t.m_Image=null;t.m_CurrentUnit=null;t.m_DisplayUnit=null;t.m_nDivider=0;t.m_nScalerLength=0;t.m_nDistance=0;t.m_bRtl=false;t.clear=function(){var e=document.getElementById(t.m_canvas.id);if(e){e.parentNode.removeChild(e)}t.m_Image=null;t.scene=null};t.Awake=function(e,n){t.scene=e;var a=jQuery.sap.byId(n);t.m_ID=jQuery(a).attr("id");t.AppendCanvas()};t.getId=function(t,e){return e+"-"+t};t.AppendCanvas=function(){t.m_bRtl=document.dir=="rtl"?true:false;t.m_canvas=document.createElementNS("http://www.w3.org/2000/svg","svg");t.m_canvas.setAttribute("role",sap.ui.core.AccessibleRole.Note);t.m_canvas.setAttribute("class","vbi-scale");t.m_canvas.setAttribute("id",t.getId("vbi-scale-canvas",t.m_ID));t.m_canvas.m_VBIType="S";t.scene.m_MapDecoDiv.appendChild(t.m_canvas)};t.getConfig=function(){if(t.m_CurrentUnit){return t.m_CurrentUnit}else{var e=t.scene.m_Ctx;var n,a;if(e){n=e.GetConfig()}if(n){a=n.GetData("UnitOfLength")}if(a){for(var i=0;i<VBI.SupportedUnitsOfLength.length;++i){if(VBI.SupportedUnitsOfLength[i].RequestedUnit==a){t.m_CurrentUnit=VBI.SupportedUnitsOfLength[i];break}}}}if(!t.m_CurrentUnit){t.m_CurrentUnit=VBI.SupportedUnitsOfLength[0]}return t.m_CurrentUnit};t.getImage=function(e){if(t.m_Image){return t.m_Image}var n=new Image;if(e){n.onload=function(){if(typeof e==="function"){e(n)}this.onload=null}}n.src=sap.ui.resource("sap.ui.vbm","themes/base/img/sapvisualbusiness.png");t.m_Image=n;return n};t.CalcScaleDimensions=function(){if(t.scene.m_Canvas[0].m_nCurrentLOD<1){return false}var e=t.scene.GetInternalDivClientRect();var n=t.getConfig();var a=[parseInt(e.width/2-75,10),parseInt(e.height/2,10)];var i=[a[0]+180,a[1]];var r=t.scene.GetDistance(a,i);var s;r=r*(1/n.ConvFactorMeter);if(r>=n.ConvFactor){s=parseInt(r/n.ConvFactor,10);t.m_DisplayUnit=n.DisplayUnit2}else{s=r;t.m_DisplayUnit=n.DisplayUnitDefault}var l=parseInt(Math.log(s)/Math.LN10,10);s=parseInt(s/Math.pow(10,l),10);if(s<2){s=1}else if(s<5){s=2}else if(s<10){s=5}s=parseInt(s*Math.pow(10,l),10);var o;if(r>=n.ConvFactor){o=s*n.ConvFactor;o=o*n.ConvFactorMeter}else{o=s*n.ConvFactorMeter}var u=t.scene.GetTargetPointForDistance(o,a);var c=[u[0]+t.scene.m_Canvas[0].getPixelLeft(),u[1]+t.scene.m_Canvas[0].getPixelTop()];var m=s;var v=0;while(v==0&&m>0){v=m%5;m/=10}if(v!=2){v=5}var p=Math.round(c[0]-a[0]);if(p>60&&p<e.right-e.left){t.m_nScalerLength=p;t.m_nDistance=s;t.m_nDivider=v;return true}return false};t.Update=function(){t.CalcScaleDimensions();var e=(t.m_nScalerLength+t.m_nDivider)/2,n=t.m_nDistance/2;var a=document.getElementById(t.m_canvas.id);if(a){a.setAttribute("height",15);a.setAttribute("width",e+1);jQuery(a).empty();var i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d","M 1 4 V 10 H "+e+" V 4");i.setAttribute("stroke","black");i.setAttribute("stroke-width",2);i.setAttribute("fill","none");a.appendChild(i);var r=document.createElementNS("http://www.w3.org/2000/svg","text");var s;if(document.dir==="rtl"){s=(n.toString().length+t.m_DisplayUnit.length+1)*6+2}else{s=e-2-(n.toString().length+t.m_DisplayUnit.length+1)*6}r.setAttribute("x",s);r.setAttribute("y",8);r.setAttribute("font-size",10);r.textContent=n+" "+t.m_DisplayUnit;a.appendChild(r)}};return t}});