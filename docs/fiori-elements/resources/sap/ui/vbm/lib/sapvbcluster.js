/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./sapvbi"],function(){"use strict";VBI.Clustering=function(e){var t={};var r={};var a=1/1048576;t.m_Clusters=[];t.m_Clustergroups=[];t.m_loadCount=0;t.m_Parser=VBI.Parser();t.m_nClustertypes=5;t.clear=function(){t.m_Clusters=[]};t.load=function(e,r){if(e.Set){t.clear();t.m_Parser.clear();t.m_loadCount++;var a,n=e.Set.Cluster;if(jQuery.type(n)=="object"){a=new VBI.Clustering.Cluster;a.load(n,r,t.m_Clusters.length);t.m_Clusters.push(a);t.UpdateAutomaticClusterGroup(a.m_groupID)}else if(jQuery.type(n)=="array"){var i=t.m_Clusters.length;for(var s=0,l=n.length;s<l;++s){a=new VBI.Clustering.Cluster;a.load(n[s],r,i++);t.m_Clusters.push(a);t.UpdateAutomaticClusterGroup(a.m_groupID)}}for(var o=0;o<t.m_Clustergroups.length;++o){t.m_Clusters.push(t.m_Clustergroups.shift())}}};t.UpdateAutomaticClusterGroup=function(e){if(e==""){return}var r=t.m_Clusters[t.m_Clusters.length-1];var a,n,i,s;for(var l=0;l<t.m_Clustergroups.length;++l){i=t.m_Clustergroups[l];if(i.m_id==e){a=l}}if(a!=undefined){s=t.m_Clustergroups[a];s.m_limit=Math.min(r.m_limitOnSum,s.m_limit);r.m_bPartOfGrp=true}else{for(var o=0,u=t.m_Clusters.length-1;o<u;++o){i=t.m_Clusters[o];if(i.m_type=="grid"&&i.m_groupID==e){n=o}}if(n!=undefined){var f=t.m_Clusters[n];s=new VBI.Clustering.Cluster;s.m_type="clustergroup";s.m_nType=2;s.m_id=e;s.m_dividerX=f.m_dividerX;s.m_dividerY=f.m_dividerY;s.m_limit=Math.min(r.m_limitOnSum,f.m_limitOnSum);s.initializeFunctions();t.m_Clustergroups.push(s);r.m_bPartOfGrp=f.m_bPartOfGrp=true}}};t.PreassembleDataForVO=function(e,r,a,n,i){var s;var l=r.config.m_BaseLod;var o=t.tw*(l>=0?1<<l:1/(1<<-l));if(s=n.m_DataSource.GetCurrentNode(i)){var u=n.m_ID;var f=r.base[a];if(s.m_dataelements.length){n.m_DataSource.Select(0);var m=n.m_DataSource.GetIndexedElement(i,0);var d=m.GetPath();var c=m.GetKeyValue().length;f.strDataPath=d.substring(0,d.length-c);for(var _=0;_<s.m_dataelements.length;++_){var g=[o,o];n.m_DataSource.Select(_);m=n.m_DataSource.GetIndexedElement(i,_);var v=n.m_Pos.GetValueVector(i);e.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad(v),g);var h=t.m_Parser.evaluate(n,a,i);if(h>=0){g.t=t.m_Clusters[h].m_nType;f.targets[h]++}else{g.t=-1}g.h=n.BaseIsHot(_,i);g.hscale=n.GetHotScale(i);g.hcol=n.m_HotDeltaColor.GetValueString(i);if(g.s=n.IsSelected(i)){g.scol=n.m_SelectColor.GetValueString(i);g.simag=n.m_ImageSelected.GetValueString(i);r.m_SelectedVOs.unshift({m_vo:a,m_index:f.length,m_dataIndex:_})}if(g.im==undefined){g.im=n.m_Image.GetValueString(i)}g.ic=n.m_Icon.GetValueString(i);g.tx=n.m_Text.GetValueString(i);g.ctcol=n.m_ContentColor.GetValueString(i);g.ctoffs=n.m_ContentOffset.GetValueVector(i);g.ctfont=n.m_ContentFont.GetValueString(i);g.ctsz=n.m_ContentSize.GetValueLong(i);g.sc=n.m_Scale.GetValueVector(i);g.al=n.m_Alignment.GetValueString(i);g.m_ID=u;g.nI=_;g.b2Ignore=false;g.cI=h;g.vI=a;g.key=m.GetKeyValue();g.label=n.GetLabel(i);f.push(g)}}for(var C=f.targets.length;C--;){var p=t.m_Clusters[C].m_nType;f.targTypes[p]+=f.targets[C];r.base.targTypes[p]+=f.targets[C]}}};t.InitializeResultVector=function(e,r,a,n,i,s,l,o){t.tw=e.m_tileWidth;t.th=e.m_tileHeight;var u={};var f=t.m_Clusters.length;u.base=[];u.hotItem={};var m,d,c;for(m=0;m<r;++m){c=[];c.clusterings=[];c.m_lodOffset=1;c.m_BaseX=n;c.m_BaseY=i;u.base.push(c);c.targets=[];c.targTypes=[];c.hotItem=u.hotItem;for(d=f;d--;){c.targets.push(0)}for(d=t.m_nClustertypes;d--;){c.targTypes.push(0)}c.m_nNumIgnore=0}u.base.targTypes=[];for(d=t.m_nClustertypes;d--;){u.base.targTypes.push(0)}u.clust=[];for(var _=0;_<f;++_){c=[];c.cI=_;c.m_lodOffset=1;c.m_BaseX=n;c.m_BaseY=i;c.hotItem=u.hotItem;c.m_nRecalcs=0;u.clust.push(c)}u.config={};var g=u.config;g.m_version=t.m_loadCount;g.bNeedsShadowLayer=false;g.m_lod=a;g.m_lodOffset=1;g.m_x=n;g.m_y=i;g.m_nx=s;g.m_ny=l;g.m_nData=o;g.m_calcMode=2;g.m_BaseX=n*t.tw;g.m_BaseY=i*t.tw;g.m_BaseLod=a;u.hotItem={};u.m_SelectedVOs=[];return u};t.CheckNonClusteredVOs=function(e,t){if(!e.base.targTypes[1]){return}for(var r=0;r<e.base.length;++r){var a=e.base[r];if(!a.targTypes[1]){continue}var n,i,s=0;for(n=0,i=a.length;n<i;++n){var l=a[n];if(!l.isCl){if(l.cI!=undefined&&l.sq!=undefined&&t[l.cI][l.sq].b2Cluster){a.m_nNumIgnore++;l.b2Ignore=true}if(!l.b2Ignore){l.bbInd=s;s++}}}a.m_NumVisVOs=s}};t.FetchClusterVOData=function(e,r,a){var n=t.m_Clusters;var i=n.length;var s=[];for(var l=0;l<i;++l){s.push({})}var o=r.length;for(var u=0;u<o;++u){for(var f=0;f<i;++f){if(r[u].m_ID==n[f].m_VO){s[f].m_index=u;s[f].m_image=r[u].m_Image!=undefined?r[u].m_Image.GetValueString(a):"";s[f].m_scale=r[u].m_Scale!=undefined?r[u].m_Scale.GetValueVector(a):[1,1,1];s[f].m_hotscale=r[u].m_HotScale!=undefined?r[u].m_HotScale.GetValueVector(a):[1,1,1];s[f].m_hotcol=r[u].m_HotDeltaColor!=undefined?r[u].m_HotDeltaColor.GetValueString(a):"";s[f].m_alignment=r[u].m_Alignment!=undefined?r[u].m_Alignment.GetValueString(a):0}}}return s};t.FetchClusterGroupData=function(){var e=t.m_Clusters;var r=e.length;var a=[];for(var n=0;n<r;++n){var i=[];if(e[n].m_type=="clustergroup"){for(var s=0;s<r;++s){if(n!=s&&e[n].m_id==e[s].m_groupID){i.push({index:s,limit:e[s].m_limit})}}}a.push(i)}return a};t.AdaptOffsets=function(e,t,r,a,n,i,s){e.config.m_calcMode=1;var l=r-e.config.m_BaseLod;var o=l>=0?1<<l:1/(1<<-l);var u;for(var f=e.base.length-1;f>=0;--f){u=e.base[f];u.m_lodOffset=o;u.m_BaseX=a;u.m_BaseY=n}for(var m=e.clust.length-1;m>=0;--m){u=e.clust[m];u.m_lodOffset=o;u.m_BaseX=a;u.m_BaseY=n}e.config.m_lod=r;e.config.m_x=a;e.config.m_y=n;e.config.m_nx=i;e.config.m_ny=s;e.config.m_lodOffset=o};t.DetermineChanges=function(e,r,a,n,i,s,l){var o={};o.bPosChanged=true;o.bDataChanged=true;o.bClusteringChanged=true;o.lodDiff=0;o.lodFactor=1;o.posDiff=[0,0];if(e!=undefined){var u=e.config;o.lodDiff=r-u.m_lod;if(o.lodDiff==0){o.lodFactor=1<<o.lodDiff;o.posDiff=[t.tw*(a-o.lodFactor*u.m_x),t.th*(n-o.lodFactor*u.m_y)]}else if(o.lodDiff>0){o.lodFactor=1<<o.lodDiff;o.posDiff=[t.tw*(a-o.lodFactor*u.m_x),t.th*(n-o.lodFactor*u.m_y)]}else{o.lodFactor=1/(1<<-o.lodDiff);o.posDiff=[t.tw*(a-o.lodFactor*u.m_x),t.th*(n-o.lodFactor*u.m_y)]}if(u.m_nData==l){o.bDataChanged=false}if(u.m_version==t.m_loadCount){o.bClusteringChanged=false}if(!o.lodDiff&&u.m_x==a&&u.m_y==n&&u.m_nx==i&&u.m_ny==s){o.bPosChanged=false}}o.bNothingChanged=!o.bDataChanged&&!o.bPosChanged&&!o.bClusteringChanged;return o};t.InvalidateOutdatedClustering=function(e,t){var r=t.bDataChanges||t.bClusteringChanged;var a=r;for(var n=0;n<e.base.length;++n){var i=e.base[n];for(var s=i.clusterings.length-1;s>=0;--s){var l=i.clusterings[s];var o=true;switch(l.t){case 0:o=true;break;case 1:o=r||t.lodDiff!=0;break;case 2:o=r;break;default:break}if(o){i.clusterings.splice(s,1);var u=e.clust[l.i];u.m_nRecalcs++;u.splice(0,u.length);a=true}}}return a};t.ClearTreeClusterNode=function(e){if(e.bw){for(var r=e.bw.length;r--;){t.ClearTreeClusterNode(e.bw[r])}for(var a=e.bw.length;a--;){e.bw[a]=undefined}e.bw=undefined}e.e=undefined;e.c=undefined};t.ClearClusterFromPreData=function(e,r){if(e[r].m_TreeFatherNode!=undefined){t.ClearTreeClusterNode(e[r].m_TreeFatherNode)}e[r]=undefined};t.ClearPreassembledData=function(e){var r=e.m_PreassembledData;var a;if(r==undefined){return}for(a=r.clust.length;a--;){t.ClearClusterFromPreData(r.clust,a)}r.clust=undefined;for(a=r.base.length;a--;){r.base[a]=undefined}e.m_PreassembledData=undefined};t.getEdge=function(e,t){if(e[1]!=undefined){return e}var r=t[e];var a=t[e+1];return[[r.c[0],r.c[1]],[a.c[0],a.c[1]]]};t.createEdgeIndex=function(e,r){var a,n=[];var i;for(a=r.length;a--;){i=t.getEdge(r[a],e);i[0].ot=i[1];i[0].i=a;i[1].ot=i[0];i[1].i=-a;var s={};s.i=a;s.c=0;s.p=i[0];i[0].li=s;n.push(s);var l={};l.p=i[1];l.i=-a;l.c=1;i[1].li=l;n.push(l)}n.sort(function(e,t){var r=e.p[0]-t.p[0];return r?r:e.p[1]-t.p[1]});for(a=0;a<n.length;a+=2){n[a].ot=a+1;n[a+1].ot=a}return n};t.getTreeClusterIndex=function(e){var t=e;while(t.c!=undefined){t=t.c}return t.cI};t.getNodeIdent=function(e,r,a){if(r.bw!=undefined){return t.getClusterIdent(e,a,r.nJ)}else{return e.base[r.vI].strDataPath+r.key}};t.getClusterIdent=function(e,t,r){if(!e){return""}var a=e.config;var n=e.clust[t];if(!n){return""}return"["+a.m_version+","+a.m_nData+","+n.m_nRecalcs+","+t+","+r+"]"};t.getClusterArea=function(e,t){if(!t.bo){return undefined}var r=e.m_PreassembledData;var a=e.m_Canvas[0].m_nCurrentX*e.m_MapManager.m_tileWidth;var n=e.m_Canvas[0].m_nCurrentY*e.m_MapManager.m_tileHeight;var i=r.config.m_lodOffset;var s=[i*t.bo[0]-a,i*t.bo[1]-n];var l=[i*t.bo[2]-a,i*t.bo[3]-n];var o=VBI.MathLib.RadToDeg(e.GetGeoFromPoint(s));var u=VBI.MathLib.RadToDeg(e.GetGeoFromPoint(l));return o[0].toString()+";"+o[1].toString()+";"+u[0].toString()+";"+u[1].toString()};t.getClusterPosition=function(e,t){var r=e.m_PreassembledData;var a=e.m_Canvas[0].m_nCurrentX*e.m_MapManager.m_tileWidth;var n=e.m_Canvas[0].m_nCurrentY*e.m_MapManager.m_tileHeight;var i=r.config.m_lodOffset;var s=[i*t[0]-a,i*t[1]-n];return VBI.MathLib.RadToDeg(e.GetGeoFromPoint(s))};t.getInfoForCluster=function(e,r,a){var n=a.m_PreassembledData;var i=n.config;var s;var l=n.clust[e[3]];var o=[];if(i.m_version==e[0]&&i.m_nData==e[1]&&l.m_nRecalcs==e[2]){var u=l[e[4]];if(r==10){var f=u.bw?u.bw.length:0;return{pos:t.getClusterPosition(a,u),bb:t.getClusterArea(a,u),image:u.im,lod:u.lod,ulod:u.c?u.c.lod:undefined,cnt:u.cnt,subs:f,type:u.isCl}}if(u.bw){switch(r){case 0:t.collectNodes(o,u,n);break;case 1:s=t.getTreeClusterIndex(u);for(var m=0;m<u.bw.length;++m){o.push(t.getNodeIdent(n,u.bw[m],s))}break;case 2:s=t.getTreeClusterIndex(u);if(u.c){o.push(t.getNodeIdent(n,u.c,s))}break;case 11:s=t.getTreeClusterIndex(u);return t.collectEdges(a,u,n.clust[s].m_edges);default:break}}}o.sort();return o};t.collectEdges=function(e,r,a){var n=[];if(!r.e||!r.e.length){return[]}var i=t.createEdgeIndex(a,r.e);var s=e.m_PreassembledData;var l=e.m_Canvas[0].m_nCurrentX*e.m_MapManager.m_tileWidth;var o=e.m_Canvas[0].m_nCurrentY*e.m_MapManager.m_tileHeight;var u=s.config.m_lodOffset;var f=i[0].p,m,d,c,_=r.e.length-1;n.push(VBI.MathLib.RadToDeg(e.GetGeoFromPoint([u*f[0]-l,u*f[1]-o])));for(var g=_;g--;){m=f.ot;n.push(VBI.MathLib.RadToDeg(e.GetGeoFromPoint([u*m[0]-l,u*m[1]-o])));c=m.li;d=i[c.ot];f=d.p}return n};t.collectNodes=function(e,r,a){if(r.bw!=undefined){for(var n=0;n<r.bw.length;++n){t.collectNodes(e,r.bw[n],a)}}else{var i=a.base[r.vI];e.push(i.strDataPath+r.key)}};t.DoClustering=function(e,r,a,n,i,s,l,o,u,f,m,d){var c=1<<r;var _=a;while(_<0){_+=c}while(_>c){_-=c}var g=t.DetermineChanges(e.m_PreassembledData,r,_,n,i,s,d);var v;if(g.bNothingChanged){e.m_PreassembledData.config.m_calcMode=0;return e.m_PreassembledData}var h;var C=t.FetchClusterVOData(e,l,o);var p=t.FetchClusterGroupData();t.m_Parser.verifyAttributes(l,o);var b=t.InitializeClusterData(e,r,_,n,i,s);if(g.bDataChanged||g.bClusteringChanged){t.ClearPreassembledData(e);v=t.InitializeResultVector(e.m_MapManager,l.length,r,_,n,i,s,d);for(h=0;h<l.length;++h){var I=l[h];if(I.IsClusterable()){t.PreassembleDataForVO(e,v,h,I,o)}}}else{v=e.m_PreassembledData;t.AdaptOffsets(v,g.posDiff,r,_,n,i,s);if(!t.InvalidateOutdatedClustering(v,g)){return v}}for(h=0;h<t.m_Clusters.length;++h){t.m_Clusters[h].ClusterPass1(h,v,b,g)}for(h=0;h<t.m_Clusters.length;++h){t.m_Clusters[h].ClusterPass2(h,v,b,p)}for(h=0;h<t.m_Clusters.length;++h){t.m_Clusters[h].DecisionPass(e,h,v,b,C,p,g)}t.CheckNonClusteredVOs(v,b);return v};t.InitializeClusterData=function(e,r,a,n,i,s){var l=[];var o=1<<r;l.numTiles=o;l.completeX=o*e.m_nWidthCanvas/e.m_nTilesX;l.completeY=o*e.m_nHeightCanvas/e.m_nTilesY;l.minLOD=e.GetMinLOD();for(var u=0;u<t.m_Clusters.length;++u){var f=t.m_Clusters[u];var m=(i+2)*f.m_dividerX;var d=(s+2)*f.m_dividerY;l.push(f.InitializeClusterData(e,u,a-1,n-1,m,d))}return l};t.VerifyCurrentSelection=function(e,t,r){for(var a=t.m_SelectedVOs.length-1;a>=0;--a){var n=t.m_SelectedVOs[a];var i=e[n.m_vo];i.m_DataSource.Select(n.m_dataIndex);if(!i.IsSelected(r)){var s=n.cI!=undefined?t.clust[n.cI]:t.base[n.m_vo];s[n.m_index].s=false;t.m_SelectedVOs.splice(a,1)}}};t.AddSingle2Selected=function(e,t,r,a,n){var i=t[e];if(i.IsClusterable()){var s=r.cI!=undefined?a.clust[r.cI]:a.base[e];var l=s[r.i];i.m_DataSource.Select(l.nI);if(i.IsSelected(n)){a.m_SelectedVOs.unshift({m_vo:e,m_index:r.i,m_dataIndex:l.nI,cI:r.cI});l.scol=i.m_SelectColor.GetValueString(n);l.simag=i.m_ImageSelected.GetValueString(n);l.s=true}}};t.AddMultiple2Selected=function(e,r,a,n){for(var i=0;i<e.length;++i){var s=e[i];var l=r[i];if(l.IsClusterable()){for(var o=0;o<s.length;++o){t.AddSingle2Selected(i,r,l.GetInternalIndex(s[o]),a,n)}}}};VBI.Clustering.Cluster=function(){var e={};e.m_additionalProperties=[];e.clear=function(){e.m_addProperties=null};e.load=function(r,a,n){e.m_id=r.id;e.m_type=r.type;e.m_type2=r.type2;e.m_switch=parseInt(r.typeswitch,10);e.m_bPartOfGrp=false;e.m_VO=r.VO;e.m_order=parseInt(r.order,10);e.m_dispOffsetX=parseInt(r.offsetX,10);if(isNaN(e.m_dispOffsetX)){e.m_dispOffsetX=0}e.m_dispOffsetY=parseInt(r.offsetY,10);if(isNaN(e.m_dispOffsetY)){e.m_dispOffsetY=0}t.m_Parser.addFormula(n,r.rule==undefined?"":r.rule);e.m_textcolor=r.textcolor;if(e.m_textcolor==undefined){e.m_textcolor="rgba(0,0,0,0.7)"}e.m_textfont=r.textfont;e.m_textfontscale=r.textfontscale;e.m_textfontsize=r.textfontsize;if(isNaN(e.m_textfontscale)){e.m_textfontscale=2}e.m_textoffset=parseInt(r.textoffset,10);e.m_textoffsetY=parseInt(r.textoffsetY,10);if(isNaN(e.m_textoffset)){e.m_textoffset=0}if(isNaN(e.m_textoffsetY)){e.m_textoffsetY=0}e.m_spotcol=r.spotcol;e.m_spotsize=parseInt(r.spotsize,10);e.m_bordersize=r.areabordersize?parseInt(r.areabordersize,10):2;e.m_bordercol=r.areabordercol;if(e.m_type=="grid"){e.m_nType=1;e.m_distanceX=r.distanceX==undefined||r.distanceX<=0?256:r.distanceX;e.m_dividerX=Math.max(1,Math.round(256/e.m_distanceX));e.m_distanceY=r.distanceY==undefined||r.distanceY<=0?256:r.distanceY;e.m_dividerY=Math.max(1,Math.round(256/e.m_distanceY));e.m_groupID=(r.groupID==undefined?"&":r.groupID)+e.m_dividerX+"_"+e.m_dividerY;e.m_omitEmpties=r.showEmpties!="true";e.m_fillcol=r.areafillcol;e.m_permanentArea=r.areapermanent=="true"}if(e.m_type=="distance"){e.m_nType=3;e.m_distance=r.distance;if(e.m_distance==undefined||e.m_distance<=0){e.m_distance=128}}if(e.m_type=="tree"){e.m_nType=4;e.m_distance=r.distance;if(e.m_distance==undefined||e.m_distance<=0){e.m_distance=16}e.m_bordercol2=r.areabordercol2;e.m_bordercol3=r.areabordercol3;e.m_fillcol=r.areafillcol;e.m_fillcol2=r.areafillcol2;e.m_fillcol3=r.areafillcol3;e.m_animated=r.animation=="true"?"2":r.animation;e.m_permanentArea=r.areapermanent=="true"}e.m_limit=parseInt(r.limit,10);e.m_limitOnSum=r.limitOnSum==undefined?999999:parseInt(r.limitOnSum,10);e.initializeFunctions()};e.initializeFunctions=function(){switch(e.m_type){case"grid":e.InitializeClusterData=e.InitializeGridClusterData;e.ClusterPass1=e.gridClusteringCounting;e.ClusterPass2=e.NothingToDo;e.DecisionPass=e.gridBasedDecision;e.CheckClusterData=e.CheckSingleClusterData;break;case"clustergroup":e.InitializeClusterData=e.InitializeGridClusterData;e.ClusterPass1=e.NothingToDo;e.ClusterPass2=e.gridClustergroupCounting;e.DecisionPass=e.gridBasedDecision;e.CheckClusterData=e.CheckGroupClusterData;break;case"distance":e.InitializeClusterData=e.InitializeDistClusterData;e.ClusterPass1=e.NothingToDo;e.ClusterPass2=e.NothingToDo;e.DecisionPass=e.distanceBasedDecision;e.CheckClusterData=e.NothingToDo;break;case"tree":e.InitializeClusterData=e.InitializeTreeClusterData;e.ClusterPass1=e.NothingToDo;e.ClusterPass2=e.NothingToDo;e.DecisionPass=e.treeBasedDecision;e.CheckClusterData=e.NothingToDo;break;default:break}};e.gridClusteringCounting=function(r,a,n,i){var s=n[r];var l=a.clust[r];var o=s.nX;var u=s.nY;var f=e.m_dividerX*n.numTiles/n.completeX;var m=e.m_dividerY*n.numTiles/n.completeX;var d=n.completeX/256;var c,_,g;var v,h;var C=t.th*s.m_BaseX;var p=t.th*s.m_BaseY;var b=l.m_lodOffset;for(var I=0;I<a.base.length;++I){v=a.base[I];for(var D=0;D<v.length;++D){h=v[D];if(h.cI==r){if(h.b2Ignore){v.m_nNumIgnore--;h.b2Ignore=false}c=Math.floor((b*h[0]-C)*f);if(c<0){c+=d}_=Math.floor((b*h[1]-p)*m);if(c>=0&&c<o&&_>=0&&_<u){g=c+o*_;h.sq=g;s[g].numInst++;s[g].bw.push(h)}}}}};e.gridClustergroupCounting=function(e,t,r,a){var n=a[e];var i=n.length;var s=r[e];for(var l=0;l<s.length;++l){var o=0;var u=s[l];u.bLimitExceeded=false;for(var f=0;f<i;++f){var m=n[f].index;var d=r[m];var c=d[l].numInst;o+=c;if(c>=n[f].limit){u.bLimitExceeded=true}}u.numInst=o}};e.distanceBasedDecision=function(r,a,n,i,s,l,o){if(o.lodDiff||o.bDataChanged||o.bClusteringChanged){var u=t.m_Clusters[a];var f=e.doDistClustering(a,n,u.m_distance,i.completeX);e.distFillClusterData(r,f,n,s[a],a)}};e.treeBasedDecision=function(r,a,n,i,s,l,o){if(o.bDataChanged||o.bClusteringChanged){var u=t.m_Clusters[a];var f=e.doTreeClustering(a,n,s[a],u.m_distance,i.completeX);e.treeFillClusterData(r,f,n,s[a],a,r.GetMinLOD())}};e.gridBasedDecision=function(r,a,n,i,s,l,o){n.config.bNeedsShadowLayer=e.fillClusterConfig(n.clust[a],n.config,0,false)||n.config.bNeedsShadowLayer;var u=t.m_Clusters[a];if(!u.m_bPartOfGrp){var f=i[a];var m=l[a];if(m.length){for(var d=m.length;d--;){var c=m[d].index;n.base[s[c].m_index].clusterings.push({i:c,t:0})}}else{n.base[s[a].m_index].clusterings.push({i:a,t:0})}for(var _=0;_<f.nX;++_){for(var g=0;g<f.nY;++g){var v=_+f.nX*g;u.CheckClusterData(n,i,f[v],a,v,_,g,s,m)}}}};e.NothingToDo=function(){};e.ReturnFalse=function(){return false};e.CheckSingleClusterData=function(r,a,n,i,s,l,o,u,f){if(n.numInst>=e.m_limit){var m=a[i];t.m_Clusters[i].FillClusterData(r,m[s],l,o,m,u[i],i,1);return}n.b2Cluster=false;return};e.CheckGroupClusterData=function(r,a,n,i,s,l,o,u,f){var m,d,c=1;if(n.bLimitExceeded||n.numInst>=e.m_limit){for(m=0;m<f.length;++m){var _=f[m].index;d=a[_];c=t.m_Clusters[_].FillClusterData(r,d[s],l,o,d,u[_],_,c)}}else{n.b2Cluster=false;for(m=0;m<f.length;++m){d=a[f[m].index];d[s].b2Cluster=false}}return};e.InitializeGridClusterData=function(t,r,a,n,i,s){var l=[];l.cI=r;l.nX=i;l.nY=s;l.XPerTile=t.m_nWidthCanvas/(t.m_nTilesX*e.m_dividerX);l.YPerTile=t.m_nHeightCanvas/(t.m_nTilesY*e.m_dividerY);var o=0;for(var u=0;u<i;++u){for(var f=0;f<s;++f){var m={};m.numInst=0;m.bw=[];m.sq=o++;l.push(m)}}l.m_BaseX=a;l.m_BaseY=n;return l};e.InitializeDistClusterData=function(t,r,a,n,i,s){var l={};l.numInst=0;l.type=e.m_type;l.cI=r;return l};e.InitializeTreeClusterData=function(t,r,a,n,i,s){var l={};l.numInst=0;l.type=e.m_type;return l};e.FillSquareEdges=function(e,t,r,a,n,i,s){var l=[];l.push([[a,n],[i,n]]);l.push([[i,n],[i,s]]);l.push([[i,s],[a,s]]);l.push([[a,s],[a,n]]);e.e=l;if(t){var o=[];var u=(i-a)/256*Math.abs(r)/2;var f=(s-n)/256*Math.abs(r)/2;o.push([[a+u,n+f],[i-u,n+f]]);o.push([[i-u,n+f],[i-u,s-f]]);o.push([[i-u,s-f],[a+u,s-f]]);o.push([[a+u,s-f],[a+u,n+f]]);e.ei=o}};e.FillClusterData=function(r,a,n,i,s,l,o,u){var f=r.clust[o];var m=s.XPerTile;var d=s.YPerTile;var c=t.th*s.m_BaseX;var _=t.th*s.m_BaseY;if(e.m_omitEmpties&&!a.numInst){a.b2Cluster=false;return u}a.b2Cluster=true;var g=i*d;var v=g+d;var h=n*m;var C=h+m;var p=m/2;var b=d/2;var I=[(c+h+p+e.m_dispOffsetX)/f.m_lodOffset,(_+g+b+e.m_dispOffsetY)/f.m_lodOffset,0,0];e.FillSquareEdges(I,f.config.b2Times,f.config.bSize,(c+h)/f.m_lodOffset,(_+g)/f.m_lodOffset,(c+C)/f.m_lodOffset,(_+v)/f.m_lodOffset);I.sq=a.sq;I.cI=s.cI;I.h=I.s=false;I.im=l.m_image;I.sc=l.m_scale;I.hscale=l.m_hotscale;I.hcol=l.m_hotcol;I.al=l.m_alignment;I.cnt=a.numInst;if(e.m_textfont!=undefined){I.f=e.m_textfont;I.fc=e.m_textcolor;I.fs=e.m_textfontscale;I.fz=e.m_textfontsize;I.fo=e.m_textoffset;I.foy=e.m_textoffsetY}I.isCl=1;I.nJ=f.length;I.grI=u;I.bw=a.bw;f.push(I);return u+1};e.doDistClustering=function(e,t,r,a){var n,i,s,l,o;var u=[];var f={};var m=t.clust[e].m_lodOffset;var d=r/m;for(n=0;n<t.base.length;++n){f=t.base[n];for(i=0;i<f.length;++i){if(f[i].cI==e){u.push(f[i]);if(f[i].b2Ignore){f.m_nNumIgnore--;f[i].b2Ignore=false}f[i].isGrouped=false}}}if(!u.length){return[]}u.sort(function(e,t){return e[0]-t[0]});var c=u.length-1;var _=0;var g=u[0],v=u[c];var h=g[0]-v[0]+a;if(h<=d){for(n=0;n<c;++n){s=u[n];l=u[n+1];o=l[0]-s[0];if(o>d){_=n+1;break}}}var C=[];var p,b,I,D,x,G;var S=u.length+_;var M=u.length;for(n=_;n<S;++n){x=n%M;s=u[x];if(s.isGrouped){continue}I=s[0];if(n>M-1){I+=a}for(i=n+1;i<S;++i){G=i%M;l=u[G];if(l.isGrouped){continue}D=l[0];if(i>M-1){D+=a}if(D-I<=d){if(s.isGrouped&&C.length>0){p=C[s.nGrp].minY;b=C[s.nGrp].maxY}else{p=s[1];b=s[1]}if(Math.abs(l[1]-p)<=d&&Math.abs(l[1]-b)<=d){if(s.isGrouped){C[s.nGrp].push(l);l.isGrouped=true;l.nGrp=s.nGrp;l.b2Ignore=true;t.base[l.vI].m_nNumIgnore++;if(l[1]<C[s.nGrp].minY){C[s.nGrp].minY=l[1]}if(l[1]>C[s.nGrp].maxY){C[s.nGrp].maxY=l[1]}if(D<C[s.nGrp].minX){C[s.nGrp].minX=D}if(D>C[s.nGrp].maxX){C[s.nGrp].maxX=D}if(C[s.nGrp].sumX==undefined){C[s.nGrp].sumX=D}else{C[s.nGrp].sumX+=D}if(C[s.nGrp].sumY==undefined){C[s.nGrp].sumY=l[1]}else{C[s.nGrp].sumY+=l[1]}}else{var V=[];V.push(s);V.push(l);C.push(V);var N=C.length-1;s.isGrouped=true;s.nGrp=N;s.b2Ignore=true;t.base[s.vI].m_nNumIgnore++;l.isGrouped=true;l.nGrp=N;l.b2Ignore=true;t.base[l.vI].m_nNumIgnore++;if(s[1]<l[1]){C[N].minY=s[1];C[N].maxY=l[1]}else{C[N].minY=l[1];C[N].maxY=s[1]}if(I<D){C[N].minX=I;C[N].maxX=D}else{C[N].minX=D;C[N].maxX=I}if(C[N].sumX==undefined){C[N].sumX=I+D}else{C[N].sumX+=I+D}if(C[N].sumY==undefined){C[N].sumY=s[1]+l[1]}else{C[N].sumY+=s[1]+l[1]}}}}else{break}}}return C};e.distFillClusterData=function(t,r,a,n,i){for(var s=0;s<r.length;++s){var l=r[s];var o=l.length;var u=l.sumX/o;var f=l.sumY/o;var m=[u,f,0,0];m.bo=[l.minX,l.minY,l.maxX,l.maxY];m.h=false;m.hscale=n.m_hotscale;m.hcol=n.m_hotcol;m.al=n.m_alignment;m.s=false;m.im=n.m_image;m.sc=n.m_scale;m.cnt=o;if(e.m_textfont!=undefined){m.f=e.m_textfont;m.fc=e.m_textcolor;m.fs=e.m_textfontscale;m.fz=e.m_textfontsize;m.fo=e.m_textoffset;m.foy=e.m_textoffsetY}m.bw=l;m.isCl=3;m.nJ=a.clust[i].length;a.clust[i].push(m);m.grI=1;m.cI=i}a.config.bNeedsShadowLayer=e.fillDistConfig(a.clust[i],a.config,a)||a.config.bNeedsShadowLayer;a.base[n.m_index].clusterings.push({i:i,t:1});return true};e.AddEdgeChain=function(e){var t=[];var r=e[0],a,n;var i=e.length;for(var s=1;s<i;++s){a=e[s];n=Math.max(Math.abs(r[0]-a[0]),Math.abs(r[1]-a[1]));t.push({s:r[2],d:a[2],l:n,c:undefined});r=a}return t};e.doTreeClustering=function(a,n,i,s,l){var o=[];var u={};var f,m;for(f=0;f<n.base.length;++f){u=n.base[f];for(m=0;m<u.length;++m){if(u[m].cI==a){var d=u[m];while(d[0]<0){d[0]+=l}while(d[0]>l){d[0]-=l}d.lod=30;d.cnt=1;d.e=[];o.push(d);d.b2Ignore=true;u.m_nNumIgnore++;d.vo=f}}}var c,_,g;o.sort(function(e,t){return e[0]!=t[0]?e[0]-t[0]:e[1]-t[1]});if(n.m_SelectedVOs.length){for(var v=0;v<o.length;++v){if(o[v].s){for(var h=0;h<n.m_SelectedVOs.length;h++){if(o[v].nI==n.m_SelectedVOs[h].m_dataIndex){n.m_SelectedVOs[h].m_index=v;n.m_SelectedVOs[h].cI=a}}}}}var C=o.length-1;if(C<0){return[]}var p=0;var b=[];var I=o[0],D=o[C];var x=I[0]-D[0]+l;var G=s*l/t.tw;if(x<G){for(f=0;f<C;++f){c=o[f];g=o[f+1];_=g[0]-c[0];if(_>x){p=f+1;x=_;if(x>G){break}}}}VBI.Trace("iGap is "+p);var S=o.length;var M=p+S;var V=-1,N;var T=[];var y,P;for(f=p;f<M;++f){if(f>=S){m=f-S;o[m][0]+=l}else{m=f}c=o[m];c.bo=[c[0],c[1],c[0],c[1]];y=c[0];P=c[1];if(V!=-1&&y===N[0]&&P===N[1]){T.push({s:V,d:m,l:0,z:1,zero:true})}else{b.push([y,P,m]);V=m;N=c}}var O=r.triangulate(b);var w=O[0];var Y=O[1];if(w.length==0){w=e.AddEdgeChain(b)}w.sort(function(e,t){var r=e.l-t.l;if(r){return r}r=e.s-t.s;if(r){return r}r=e.d-t.d;return r?r:t.v-e.v});var X=T.concat(w);var z=1<<n.config.m_BaseLod;for(m=0;m<o.length;m++){o[m].nJ=m}e.clcnt=o.length;n.config.m_0ref=e.buildTree(o,a,X,i,s,l);n.config.m_ref=n.config.m_0ref/z;e.determineClusterPositions(o.m_TreeFatherNode);e.assembleAreaInfo(o,X,Y);o.m_edges=X;return o};e.determineClusterPositions=function(t){if(t.isCl){var r=0,a=0,n=t.bw,i;for(var s=n.length;s--;){i=e.determineClusterPositions(n[s]);r+=i[0]*i[2];a+=i[1]*i[2]}t[0]=r/t.cnt;t[1]=a/t.cnt}return[t[0],t[1],t.cnt]};e.AddVirtuals=function(e,t,r){var a=r[t];if(a.executed==undefined){var n=a.v0,i;if(n){for(var s=0;s<a.length;++s){i=a[s];e.e.push([[n.c[0],n.c[1]],[i.c[0],i.c[1]]])}}else{n=a[0];i=a[1];e.e.push([[n.c[0],n.c[1]],[i.c[0],i.c[1]]])}}};e.AddEdge=function(t,r,a,n,i,s,l){if(!i||!s){t.e.push(l)}if(r.v){if(i){e.AddVirtuals(t,r.s,n)}if(s){e.AddVirtuals(t,r.d,n)}}return t.c};e.MarkVirtuals=function(e,t,r){r[e].executed=true;r[t].executed=true};e.assembleAreaInfo=function(t,r,a){var n,i,s,l;var o=r.length-1;for(var u=0;u<=o;++u){var f=false;n=r[u];i=u<o?r[u+1]:undefined;if(n.l&&n.s>=0&&n.d>=0){s=t[n.s];l=t[n.d];if(u<o&&n.s===i.s&&n.d===i.d){while(s!=undefined&&f==false){if(s.lod<l.lod){l=e.AddEdge(l,n,i,a,false,true,u)}else if(s.lod>l.lod){s=e.AddEdge(s,n,i,a,true,false,u)}else if(s.nJ===l.nJ){if(n.v){s=e.AddEdge(s,n,i,a,true,true,u);l=l.c}else{f=true}}else{s=e.AddEdge(s,n,i,a,true,false,u);l=e.AddEdge(l,n,i,a,false,true,u)}}u++}}if(n.v){a[n.s].executed=true;a[n.d].executed=true}}};e.recCheck=function(t,r,a,n,i,s,l,o,u,f,m,d,c){var _=[];var g=[0,0];var v=i[s];var h,C,p,b;var I=e.analyzePath(_,r,a,v,o,m,d);if(I.nLod==o){return g}var D=r[I.i];if(I.nLod==I.oLod){if(e.NodeMerge(I.nLod,i,s,r,I.i)&&s){g=e.recCheck(t,r,I.i-1,I.i-1,i,s-1,s-1,I.nLod,u,f,m,d,c+1)}}else if(v.lod>I.nLod){e.Merge2NewNode(t,I.nLod,r[I.i],v,r,I.i+1,u);g[1]=1}else{g=e.recCheck(t,i,s,l,r,I.i,n,v.lod-1,u,f,m,d,c+1);if(_.length>1){var x=I.i+1+g[0];var G=r[x];var S=a+g[0];e.NodeMerge(G.lod,i,s+g[1],r,x);for(p=x;p<=n+g[0];p++){b=r[p];if(p<S){b.bo=_[a+g[0]-p]}else{h=b.bo;C=v.bo;b.bo=[Math.min(h[0],C[0]),Math.min(h[1],C[1]),Math.max(h[2],C[2]),Math.max(h[3],C[3])]}b.cnt+=v.cnt-D.cnt}}return[g[1],g[0]]}for(p=I.i;p<=n;p++){b=r[p+g[1]];b.cnt+=v.cnt;if(p<=a){b.bo=_[a-p]}else{h=b.bo;C=v.bo;b.bo=[Math.min(h[0],C[0]),Math.min(h[1],C[1]),Math.max(h[2],C[2]),Math.max(h[3],C[3])]}}return g};e.buildTree=function(r,a,n,i,s,l){var o=1/Math.log(2);e.dLog2=o;var u=o*Math.log(l/t.tw)+4;var f,m,d,c;var _,g,v,h,C;for(v=0;v<n.length;++v){var p=n[v];if(f&&p.s==f.s&&p.d==f.d){continue}f=p;d=p.l;var b=Math.floor(Math.min(24,o*Math.log(s/d)+u));var I=[r[p.s]];for(c=0;I[c].c!=undefined;++c){I[c+1]=I[c].c}_=I[c];var D=[r[p.d]];for(c=0;D[c].c!=undefined;++c){D[c+1]=D[c].c}g=D[c];m=false;if(I.length==1&&D.length>1){m=true}else if(D.length>1){if(g.lod<_.lod||g.lod==_.lod&&g.cnt>_.cnt){m=true}}h=I.length-1;C=D.length-1;var x=-1e3;if(_.nJ==g.nJ){do{x=_.lod;_=I[--h];g=D[--C]}while(_.nJ==g.nJ)}if(m){e.recCheck(r,D,C,C,I,h,h,x,i,b,u,s,0)}else{e.recCheck(r,I,h,h,D,C,C,x,i,b,u,s,0)}}if(r.length){var G=r[0];while(G.c!=undefined){G=G.c}G.cI=a;r.m_TreeFatherNode=G}return s/(2*Math.exp(-u/o))};e.Merge2NewNode=function(t,r,a,n,i,s,l){var o=a.c;var u=n.c;var f={lod:r,nJ:e.clcnt++,isCl:4,cnt:a.cnt,e:[],h:false,hscale:l.m_hotscale,hcol:l.m_hotcol,s:false,im:l.m_image,sc:l.m_scale,f:e.m_textfont,fc:e.m_textcolor,fs:e.m_textfontscale,fz:e.m_textfontsize,fo:e.m_textoffset,foy:e.m_textoffsetY,al:l.m_alignment,grI:1};f.bw=[a,n];a.c=f;n.c=f;i.splice(s,0,f);if(o!=undefined){f.c=o;e.ReplaceBWE(o.bw,a.nJ,f)}if(u!=undefined){e.RemoveBWE(u.bw,n.nJ)}t.push(f);return f};e.NodeMerge=function(t,r,a,n,i){var s=false;var l=n[i];var o=r[a];var u=o.c;if(t<o.lod){l.bw.push(o);o.c=l}else{var f;for(var m=o.bw.length;m--;){f=o.bw[m];f.c=l;l.bw.push(f);o.bw[m]=undefined}o.bInvalid=true;s=true}if(u!=undefined){e.RemoveBWE(u.bw,o.nJ)}return s};e.ReplaceBWE=function(e,t,r){for(var a=e.length;a--;){if(e[a].nJ==t){if(r==-1){e.splice(a,1)}else{e[a]=r}}}};e.RemoveBWE=function(e,t){for(var r=e.length;r--;){if(e[r].nJ==t){e.splice(r,1)}}};e.analyzePath=function(t,r,a,n,i,s,l){var o=r[a];var u=o.bo,f=n.bo;var m=[Math.min(u[0],f[0]),Math.min(u[1],f[1]),Math.max(u[2],f[2]),Math.max(u[3],f[3])];var d=Math.max(m[2]-m[0],m[3]-m[1]);var c=Math.floor(Math.min(24,e.dLog2*Math.log(l/d)+s));if(c<=i){return{i:a+1,nLod:i,oLod:i}}t.push(m);if(a==0||c<o.lod){return{i:a,nLod:c,oLod:o.lod}}return e.analyzePath(t,r,a-1,n,c,s,l)};e.fillClusterConfig=function(t,r,a,n){var i={};i.bCol=e.m_bordercol;i.bSize=Math.abs(e.m_bordersize);if(e.m_bordersize<0){i.b2Times=true}i.fCol=e.m_fillcol;i.permArea=e.m_permanentArea;if(e.m_bordercol2){i.bCol2=e.m_bordercol2}if(e.m_bordercol3){i.bCol3=e.m_bordercol3}if(e.m_fillcol2){i.fCol2=e.m_fillcol2}if(e.m_fillcol3){i.fCol3=e.m_fillcol3}i.sCol=e.m_spotcol;i.sSize=e.m_spotsize;i.anim=!n?undefined:e.m_animated;i.animLow=Math.ceil(a);i.baseConf=r;t.config=i;return i.bCol!=undefined||i.sCol&&i.sSize};e.fillDistConfig=function(t,r,a){var n={};n.baseConf=r;t.config=n;if(e.m_spotsize!=undefined&&e.m_spotsize!=0&&e.m_spotcol!=undefined){n.sCol=e.m_spotcol;n.sSize=e.m_spotsize;n.base=a.base;return true}return false};e.treeFillClusterData=function(t,r,a,n,i,s){a.clust[i]=r;a.clust[i].hotItem=a.hotItem;a.clust[i].cI=i;a.clust[i].m_lodOffset=1;a.clust[i].m_nRecalcs=0;a.base[n.m_index].clusterings.push({i:i,t:2});a.config.bNeedsShadowLayer=e.fillClusterConfig(a.clust[i],a.config,s,true)||a.config.bNeedsShadowLayer;return true};return e};r={supertriangle:function(e){var t=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY,i,s,l,o,u,f;for(i=e.length;i--;){if(e[i][0]<t){t=e[i][0]}if(e[i][0]>a){a=e[i][0]}if(e[i][1]<r){r=e[i][1]}if(e[i][1]>n){n=e[i][1]}}s=a-t;l=n-r;o=Math.max(s,l);u=t+s*.5;f=r+l*.5;return[[u-40*o,f-o,-1],[u,f+40*o,-2],[u+40*o,f-o,-3]]},circumcircle:function(e,t,r,n){var i=e[t][0],s=e[t][1],l=e[r][0],o=e[r][1],u=e[n][0],f=e[n][1],m=Math.abs(s-o),d=Math.abs(o-f),c,_,g,v,h,C,p,b,I,D;if(m<a){v=-((u-l)/(f-o));C=(l+u)/2;b=(o+f)/2;c=(l+i)/2;_=v*(c-C)+b}else if(d<a){g=-((l-i)/(o-s));h=(i+l)/2;p=(s+o)/2;c=(u+l)/2;_=g*(c-h)+p}else{g=-((l-i)/(o-s));v=-((u-l)/(f-o));h=(i+l)/2;C=(l+u)/2;p=(s+o)/2;b=(o+f)/2;c=(g*h-v*C+b-p)/(g-v);_=m>d?g*(c-h)+p:v*(c-C)+b}I=l-c;D=o-_;return{i:t,j:r,k:n,x:c,y:_,r:I*I+D*D}},dedup:function(e){var t,r,a,n,i,s;for(r=e.length;r;){n=e[--r];a=e[--r];for(t=r;t;){s=e[--t];i=e[--t];if(a===i&&n===s||a===s&&n===i){e.splice(r,2);e.splice(t,2);break}}}},assemble:function(e,t,r,a,n){e.length=0;var i;for(i=t.length;i--;){var s=(t[i].i>=n)+(t[i].j>=n)+(t[i].k>=n);var l=[t[i].i,t[i].j,t[i].k];l.sort();var o=a[l[0]],u=a[l[1]],f=a[l[2]];var m=Math.max(Math.abs(o[0]-u[0]),Math.abs(o[1]-u[1]));var d=Math.max(Math.abs(o[0]-f[0]),Math.abs(o[1]-f[1]));var c=Math.max(Math.abs(f[0]-u[0]),Math.abs(f[1]-u[1]));var _=[t[i].x,t[i].y];var g=a[l[0]][2],v=a[l[1]][2],h=a[l[2]][2];if(g>=0&&v>=0){e.push({s:g,d:v,l:m,c:_,v:s})}if(g>=0&&h>=0){e.push({s:g,d:h,l:d,c:_,v:s})}if(v>=0&&h>=0){e.push({s:v,d:h,l:c,c:_,v:s})}if(s){if(g>=0){this.addToVirtual(r,g,v,h,_,s)}if(v>=0){this.addToVirtual(r,v,g,h,_,s)}if(h>=0){this.addToVirtual(r,h,g,v,_,s)}}}return e},triangulate:function(e,t){var r=e.length,n,i,s,l,o,u,f,m,d,c,_,g,v;if(r<1){return[]}e=e.slice(0);if(t){for(n=r;n--;){e[n]=e[n][t]}}s=new Array(r);for(n=r;n--;){s[n]=n}s.sort(function(t,r){return e[r][0]-e[t][0]});l=this.supertriangle(e);e.push(l[0],l[1],l[2]);o=[this.circumcircle(e,r+0,r+1,r+2)];u=[];f=[];m=[];for(n=s.length;n--;f.length=0){v=s[n];for(i=o.length;i--;){d=e[v][0]-o[i].x;if(d>0&&d*d>o[i].r){u.push(o[i]);o.splice(i,1);continue}c=e[v][1]-o[i].y;if(d*d+c*c-o[i].r>a){continue}f.push(o[i].i,o[i].j,o[i].j,o[i].k,o[i].k,o[i].i);o.splice(i,1)}this.dedup(f);for(i=f.length;i;){g=f[--i];_=f[--i];o.push(this.circumcircle(e,_,g,v))}}for(n=o.length;n--;){u.push(o[n])}o=this.assemble(o,u,m,e,r);return[o,m]},addToVirtual:function(e,t,r,a,n,i){var s={n1:r,n2:a,c:n,v:i};if(e[t]==undefined){e[t]=[]}if(r<0&&a<0){e[t].v0=s}else{e[t].push(s)}},contains:function(e,t){if(t[0]<e[0][0]&&t[0]<e[1][0]&&t[0]<e[2][0]||t[0]>e[0][0]&&t[0]>e[1][0]&&t[0]>e[2][0]||t[1]<e[0][1]&&t[1]<e[1][1]&&t[1]<e[2][1]||t[1]>e[0][1]&&t[1]>e[1][1]&&t[1]>e[2][1]){return null}var r=e[1][0]-e[0][0],a=e[2][0]-e[0][0],n=e[1][1]-e[0][1],i=e[2][1]-e[0][1],s=r*i-a*n;if(s===0){return null}var l=(i*(t[0]-e[0][0])-a*(t[1]-e[0][1]))/s,o=(r*(t[1]-e[0][1])-n*(t[0]-e[0][0]))/s;if(l<0||o<0||l+o>1){return null}return[l,o]}};return t}});