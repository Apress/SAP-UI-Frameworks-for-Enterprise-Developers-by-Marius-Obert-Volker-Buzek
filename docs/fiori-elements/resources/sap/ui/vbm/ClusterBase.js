/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/theming/Parameters","./ClusterContainer","sap/ui/unified/Menu","jquery.sap.global","sap/base/Log","./library"],function(e,t,r,n,i,a,o){"use strict";var s="sap.ui.vbm.ClusterBase";var u=e.extend("sap.ui.vbm.ClusterBase",{metadata:{library:"sap.ui.vbm",properties:{areaAlwaysVisible:{type:"boolean",group:"Appearance",defaultValue:false},areaColor:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(200,0,0,0.2)"},areaColorBorder:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(220,220,220,0.5)"},textProperty:{type:"string",group:"Misc",defaultValue:"text"},textSettings:{type:"object",group:"Appearance"},rule:{type:"string",group:"Misc",defaultValue:null}},defaultAggregation:"vizTemplate",aggregations:{vizTemplate:{type:"sap.ui.core.Control",multiple:false},vizVo:{type:"sap.ui.vbm.Spot",multiple:false},clusterVos:{type:"sap.ui.core.Control",multiple:true,visibility:"hidden",singularName:"clusterVo"},clusterContainers:{type:"sap.ui.vbm.ClusterContainer",multiple:true,visibility:"hidden",singularName:"clusterContainer"}},events:{click:{parameters:{clusterID:{type:"string"}}},contextMenu:{parameters:{clusterID:{type:"string"},menu:{type:"sap.ui.unified.Menu"}}}}}});u.prototype.openDetailWindow=function(e,t){var r=this.getParent();r.mDTWindowCxt.bUseClickPos=true;r.mDTWindowCxt.open=true;r.mDTWindowCxt.src=e;r.mDTWindowCxt.key=e.getKey();r.mDTWindowCxt.params=t;r.m_bWindowsDirty=true;r.invalidate()};u.prototype.openContextMenu=function(e,t,r){this.oParent.openContextMenu(e,t,r)};u.prototype.init=function(){this.mVizObjMap={};this.mContObjMap={};var e=t.get("sapUiFontFamily");this.setProperty("textSettings",{textcolor:"#000000",textfont:e?e:"Arial, Helvetica, sans-serif",textfontsize:"10"},true)};u.prototype.exit=function(){this.mVizObjMap=null;this.mContObjMap=null;if(this.oSpotAggr){this.oSpotAggr.destroy();this.oSpotAggr=null}};u.prototype.setTextSettings=function(e){var t=this.getTextSettings();i.extend(t,e);return this.setProperty("textSettings",t)};u.prototype.getTemplateObject=function(){var e={};var t=this.getId();if(this.getVizTemplate()){e={id:t,type:"{00100000-2012-0004-B001-2297943F0CE6}",datasource:t}}else if(this.getVizVo()){this.oSpotAggr=new sap.ui.vbm.Spots({items:{path:"/",template:this.getVizVo()}});e=this.oSpotAggr.getTemplateObject();e.id=t}else{a.error("No visualization object given for cluster","",s)}return e};u.prototype.getActionArray=function(){if(this.oSpotAggr){var e=this.oSpotAggr.getActionArray(true);for(var t=0;t<e.length;++t){e[t].refVO=this.getId()}return e}else{return[]}};u.prototype.getClusterDefinition=function(){return i.extend(this.getTextSettings(),{id:this.getId(),VO:this.getId(),rule:this.getRule(),areapermanent:this.getAreaAlwaysVisible().toString(),areabordersize:"2",areafillcol:this.getAreaColor(),areabordercol:this.getAreaColorBorder()})};u.prototype.handleContainerCreated=function(e){var t=e.mParameters.id;var r=this._getVizObjInst(t);if(r){var n=this.getParent().getInfoForCluster(t,sap.ui.vbm.ClusterInfoType.NodeInfo);if(!r.getBindingInfo("text")){r.setProperty(this.getTextProperty(),n.cnt.toString(),true)}if(!this.oDOMHandler){this.oDOMHander=new u._DOMHandler(this)}var i=e.getParameter("contentarea");i.addEventListener("click",this.oDOMHander);i.addEventListener("contextmenu",this.oDOMHander);i.addEventListener("touchstart",this.oDOMHander);i.addEventListener("touchend",this.oDOMHander);i.addEventListener("touchcancel",this.oDOMHander);var a;if(a=this.getParent()){var o=i.id;a.addRenderItem(r,o)}}};u.prototype.handleContainerDestroyed=function(e){var t=e.getParameter("contentarea");t.removeEventListener("click",this.oDOMHander);t.removeEventListener("contextmenu",this.oDOMHander);t.removeEventListener("touchstart",this.oDOMHander);t.removeEventListener("touchend",this.oDOMHander);t.removeEventListener("touchcancel",this.oDOMHander);this._removeVizObjInst(e.mParameters.id)};u.prototype.handleEvent=function(e){var t=e.Action.name;var r="fire"+t[0].toUpperCase()+t.slice(1);var i;if(i=this.getVizVo()){var o={data:e};var u=this.getParent().getInfoForCluster(e.Action.instance,sap.ui.vbm.ClusterInfoType.NodeInfo);i.setProperty("key",e.Action.instance,true);i.setProperty("position",u.pos[0]+";"+u.pos[1]+";0",true);switch(t){case"click":i.mClickGeoPos=e.Action.AddActionProperties.AddActionProperty[0]["#"];break;case"contextMenu":i.mClickPos=[e.Action.Params.Param[0]["#"],e.Action.Params.Param[1]["#"]];if(this.oParent.mVBIContext.m_Menus){this.oParent.mVBIContext.m_Menus.deleteMenu("DynContextMenu")}var p=new n;p.vbi_data={};p.vbi_data.menuRef="CTM";p.vbi_data.VBIName="DynContextMenu";o.menu=p;break;case"drop":var l=e.Action.Params.Param[0]["#"].split("|");var c=l[1];var g=l[2].split(".")[1];var h=this.getParent().getAggregatorContainer(c).findInstanceByKey(g);o.oDragSource=h;break;default:break}i[r](o);o.instance=i;this[r](o)}else{a.error("Instance for event not found","",s)}};u.prototype.findInstance=function(e){if(this.oSpotAggr){return this.getVizVo()}else{return this._getContainer(e)}};u.prototype._getVizObjInst=function(e){var t=this.mVizObjMap[e];if(!t){var r=this.getVizTemplate();if(r){t=this.mVizObjMap[e]=r.clone();t.mClusterId=e;this.addAggregation("clusterVos",t,true)}}return t};u.prototype._removeVizObjInst=function(e){var t=this.mVizObjMap[e];if(t){this.removeAggregation("clusterVos",t,true);this.mVizObjMap[e]=null}};u.prototype._getContainer=function(e){var t=this.mContObjMap[e];if(!t){t=this.mContObjMap[e]=new r({key:e});if(!this.oSpotAggr){t.setItem(this._getVizObjInst(e))}this.addAggregation("clusterContainers",t,true)}return t};u.prototype._removeContainer=function(e){var t=this.mContObjMap[e];if(t){this.removeAggregation("clusterContainers",t,true);this.mContObjMap[e]=null}};u.prototype._handleDOMEvent=function(e){var t=e.currentTarget.m_Key;var r=this.parent._getContainer(t);switch(e.type){case"click":this.parent.fireClick({instance:r,event:e});break;case"contextmenu":this.parent._onContextMenu(e,r);break;case"touchstart":r.touch=true;r.touchTime=Date.now();break;case"touchend":if(r.touch){r.touch=false;var n=(Date.now()-r.touchTime)/1e3;if(n<1){this.parent.fireClick({instance:r,event:e})}else{this.parent._onContextMenu(e,r)}}break;case"touch cancel":r.touch=false;break;default:break}};u.prototype._onContextMenu=function(e,t){var r={};var i=this.oParent.getDomRef();t.mClickPos=[e.clientX-i.offsetLeft,e.clientY-i.offsetTop];try{if(this.oParent.mVBIContext.m_Menus){this.oParent.mVBIContext.m_Menus.deleteMenu("DynContextMenu")}var a=new n;a.vbi_data={};a.vbi_data.menuRef="CTM";a.vbi_data.VBIName="DynContextMenu";r.menu=a;e.preventDefault();r.instance=t;r.event=e;this.fireContextMenu(r)}catch(e){}};u._DOMHandler=function(e){this.parent=e;this.handleEvent=e._handleDOMEvent;return this};return u});