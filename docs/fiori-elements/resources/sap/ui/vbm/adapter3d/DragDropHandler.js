/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./thirdparty/three","sap/base/Log"],function(t,e,i,s){"use strict";var a=i.Color;var n=i.Vector2;var o=i.Vector3;var r=i.Matrix4;var h=e.toColor;var p=e.toBoolean;var l=e.vbToThreeJs;var _=e.threeJsToVb;var c="sap.ui.vbm.DragDropHandler";var d=new a(1,0,0);var u=new a(0,1,0);var f=new a(0,0,1);var v=new a(0,0,0);var y=new a(0,1,1);var g=new o(1,0,0);var m=new o(0,1,0);var x=new o(0,0,1);var b="SNAP_X_COLOR";var P="SNAP_Y_COLOR";var w="SNAP_Z_COLOR";var D="SNAP_COLOR";var L="SNAP_HIGHLIGHT_COLOR";var B=1e4;var C=.01;var S=.04;var M=8;var A=new o;var j=new o;var H=new o;var z=new o;var O=new o;var T=new r;var E=new n;var R=new i.Box3;var I=new i.Ray;var G=new i.Line3;var V=new i.Raycaster;var k=new i.Quaternion;var K={PICK:0,DRAG:1};var U={onBeforeRendering:function(t){this._unsubscribe()},onAfterRendering:function(t){this._subscribe()}};var W=t.extend("sap.ui.vbm.adapter3d.DragDropHandler",{constructor:function(e){t.call(this);this._adapter=e;this._context=e._context;this._viewport=e._viewport;this._root=this._viewport._root;this._scene=this._viewport._scene;this._camera=this._viewport._camera;this._cameraControls=this._viewport._cameraController;this._state=K.PICK;this._snapping=false;this._snapAlways=false;this._lockToAxis=false;this._snapAxis=null;this._changeables=new Set;this._changeables3d=[];this._instances=[];this._origin=null;this._hovered=null;this._touch=null;this._offset=new o;this._plane=new i.Plane;this._inverseMatrix=new r;this._xAxisColor=d;this._yAxisColor=f;this._zAxisColor=u;this._lineMaterialSolid=new i.LineBasicMaterial({depthTest:false,depthWrite:false,color:0,linewidth:1,transparent:true,opacity:.99});this._lineMaterialDashed=new i.LineDashedMaterial({depthTest:false,depthWrite:false,color:0,linewidth:1,scale:1,dashSize:.1,gapSize:.06,transparent:true,opacity:.99});this._snapLine=new i.Line((new i.BufferGeometry).setFromPoints([new o,new o]),this._lineMaterialDashed);this._addToScene(this._snapLine,this._root,false,1,1e3);this._snapPointsData=[];for(var s=0;s<M;++s){this._snapPointsData.push({pos:new o,scale:new o})}this._snapPoints=new i.InstancedMesh(new i.SphereGeometry(1,16,16),new i.MeshBasicMaterial({depthTest:false,depthWrite:false,color:65535,transparent:true,opacity:.99}),M);this._addToScene(this._snapPoints,this._scene,false,1,1010);this._snapHighlightPoint=new i.Mesh(new i.SphereGeometry(1,16,16),new i.MeshBasicMaterial({depthTest:false,depthWrite:true,color:16711680,transparent:true,opacity:.99}));this._addToScene(this._snapHighlightPoint,this._scene,false,1,1020);this._snapBox=new i.BoxHelper(undefined,65535);this._addToScene(this._snapBox,this._scene,false,1);this._viewport.addEventDelegate(U,this)}});W.prototype.destroy=function(){this._unsubscribe();this._viewport.removeEventDelegate(U);this._snapBox.geometry.dispose();this._snapBox.material.dispose();this._snapPoints.geometry.dispose();this._snapPoints.material.dispose();this._snapHighlightPoint.geometry.dispose();this._snapHighlightPoint.material.dispose();this._snapLine.geometry.dispose();this._lineMaterialSolid.dispose();this._lineMaterialDashed.dispose();this._root.remove(this._snapLine);this._scene.remove(this._snapBox,this._snapPoints,this._snapHighlightPoint);this._adapter=null;this._context=null;this._viewport=null;this._root=null;this._scene=null;this._camera=null;this._cameraControls=null;this._lineMaterialSolid=null;this._lineMaterialDashed=null;this._snapBox=null;this._snapLine=null;this._snapPoints=null;this._snapHighlightPoint=null;t.prototype.destroy.call(this)};W.prototype.update=function(){this._cancel();var t=this._context.scene;var i=this._context.voQueues;(i.toAdd.get(t)||[]).forEach(function(t){if(t["VB:c"]&&(t.isBox||t.isCylinder)&&p(t["VB:c"])){this._changeables.add(t)}},this);(i.toRemove.get(t)||[]).forEach(function(t){this._changeables.delete(t)},this);(i.toUpdate.get(t)||[]).forEach(function(t){if(t["VB:c"]&&(t.isBox||t.isCylinder)&&e.propertyChanged(t,"VB:c")){if(p(t["VB:c"])){this._changeables.add(t)}else{this._changeables.delete(t)}e.updateProperty(t,"VB:c")}},this);this._changeables3d=Array.from(this._changeables,function(t){return t.object3D});var s=this._context.config;this._xAxisColor=s.has(b)?h(s.get(b)).rgb:d;this._yAxisColor=s.has(P)?h(s.get(P)).rgb:f;this._zAxisColor=s.has(w)?h(s.get(w)).rgb:u;var a=s.has(D)?h(s.get(D)).rgb:y;var n=s.has(L)?h(s.get(L)).rgb:d;this._snapBox.material.color.copy(a);this._snapBox.material.needsUpdate=true;this._snapPoints.material.color.copy(a);this._snapPoints.material.needsUpdate=true;this._snapHighlightPoint.material.color.copy(n);this._snapHighlightPoint.material.needsUpdate=true};W.prototype._onKeyUp=function(t){if(!t.repeat){this._handleKeyPress(t,false)}};W.prototype._onKeyDown=function(t){if(!t.repeat){this._handleKeyPress(t,true)}};W.prototype._onPointerDown=function(t){this._mouseDown=true;if(this._hovered){var e;if(this._snapHighlightPoint.visible){this._snapping=true;e=this._snapHighlightPoint.position}else{V.layers.set(0);V.setFromCamera(this._updatePointer(t,E),this._camera);var i=V.intersectObject(this._hovered,false);if(i.length>0){e=i[0].point}}if(e){this._dom.style.cursor="move";this._dragStart(e)}}};W.prototype._onPointerMove=function(t){if(this._mouseDown&&this._cameraControls.enabled){this._snapBox.visible=false;this._snapLine.visible=false;this._snapPoints.visible=false;this._snapHighlightPoint.visible=false;return}this._updatePointer(t,E);if(this._state===K.DRAG){V.layers.set(0);V.setFromCamera(E,this._camera);if(V.ray.intersectPlane(this._plane,A)){this._drag(A.sub(this._offset).applyMatrix4(this._inverseMatrix),E,t.ctrlKey,t.shiftKey)}}if(this._state===K.PICK||this._snapping){this._handleHover(E)}if(this._state===K.PICK&&this._snapPoints.visible){V.layers.set(1);var e=V.intersectObject(this._snapPoints,false);if(e.length>0){var i=e[0].instanceId;this._snapHighlightPoint.scale.copy(this._snapPointsData[i].scale);this._snapHighlightPoint.position.copy(this._snapPointsData[i].pos);this._snapHighlightPoint.updateMatrix();this._snapHighlightPoint.visible=true}else{this._snapHighlightPoint.visible=false}}};W.prototype._onPointerCancel=function(t){this._mouseDown=false;this._dom.style.cursor=this._hovered?"pointer":"auto";this._dragEnd()};W.prototype._handleHover=function(t){var e=[],i=false;V.layers.set(0);V.setFromCamera(t,this._camera);V.intersectObjects(this._changeables3d,false,e);if(this._hovered!==null){if(!this._hovered.geometry.boundingBox){this._hovered.geometry.computeBoundingBox()}R.copy(this._hovered.geometry.boundingBox);R.applyMatrix4(this._hovered.matrixWorld);if(V.ray.intersectBox(R,A)){i=true}}if(!i){if(e.length>0){var s=e[0].object;if(this._hovered!==s&&this._hovered!==null){this._hovered=null;this._dom.style.cursor="auto";this._hoverOff()}if(this._hovered!==s){this._hovered=s;this._dom.style.cursor="pointer";this._hoverOn(this._hovered)}}else if(this._hovered!==null){this._hovered=null;this._dom.style.cursor="auto";this._hoverOff()}}};W.prototype._handleKeyPress=function(t,e){if(t.keyCode===16){this._lockToAxis=e;this._updateSnapLine()}else if(t.keyCode===20){this._snapAlways=t.getModifierState("CapsLock");this._updateSnapLine()}else if(t.keyCode===27&&e){this._cancel()}};W.prototype._dragStart=function(t){this._plane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._plane.normal),t);this._inverseMatrix.copy(this._hovered.parent.matrixWorld).invert();this._offset.copy(t).sub(A.setFromMatrixPosition(this._hovered.matrixWorld));this._touch=e.threeJsToVb(t);this._instances.length=0;var i=p(this._hovered._sapInstance["VB:s"]);this._changeables.forEach(function(t){if(t===this._hovered._sapInstance||i&&p(t["VB:s"])){this._instances.push(t);t._last.dragStart=t.object3D.position.clone();var e=this._adapter._sceneBuilder._instanceDecals.get(t);if(e){e.forEach(function(t){t._last.dragStart=t.object3D.position.clone()})}this._changeables3d.splice(this._changeables3d.indexOf(t.object3D),1)}},this);this._origin=this._hovered;this._hovered=null;this._state=K.DRAG;this._snapBox.visible=false;this._snapPoints.visible=false;this._snapHighlightPoint.visible=false;this._cameraControls.setEnabled(false)};W.prototype._drag=function(t,e,s,a){var n,o=true,h=false,p,c=Number.MAX_VALUE;var d=t.clone().sub(this._origin._sapInstance._last.dragStart);A.set(e.x,e.y,0);if(this._snapping&&this._snapPoints.visible){for(n=0;n<M;++n){j.copy(this._snapPointsData[n].pos);H.copy(j);j.project(this._camera);j.z=0;p=A.distanceTo(j);if(p<S&&p<c){h=true;c=p;_(H,H);_(this._offset,z);O.copy(H.sub(this._origin._sapInstance._last.dragStart));O.sub(z)}}}if(h){d.copy(O)}else{var u=[{dir:g,color:this._xAxisColor},{dir:m,color:this._yAxisColor},{dir:x,color:this._zAxisColor}];if(!this._lockToAxis){u.forEach(function(t){t.distance=this._getAxisSnapDistance(this._touch,d,t.dir)},this);u.sort(function(t,e){return t.distance<e.distance?-1:1});if(u[0].distance<S||this._snapAlways){this._snapAxis=u[0]}else{this._snapAxis=null}}this._updateSnapLine();if(this._snapAxis){this._getAxisSnapPosition(this._touch,d,this._snapAxis.dir,d)}}if(s){for(n=0;n<this._instances.length;++n){var f=this._instances[n];var v=f._last.dragStart.clone().add(d);var y=(new r).compose(v,f.object3D.quaternion,f.object3D.scale);y.multiplyMatrices(f.object3D.parent.matrixWorld,y);if(!f.object3D.geometry.boundingBox){f.object3D.geometry.computeBoundingBox()}var b=(new i.Box3).copy(f.object3D.geometry.boundingBox);b.applyMatrix4(y);if(this._isCollide(this._scene,b)){o=false;break}}}if(o){this._updateSnapLineGeometry(this._touch,d);for(n=0;n<this._instances.length;++n){this._instances[n].object3D.position.copy(this._instances[n]._last.dragStart).add(d);this._instances[n].object3D.updateMatrix();var P=this._adapter._sceneBuilder._instanceDecals.get(this._instances[n]);if(P){l(d,A);P.forEach(function(t){t.object3D.position.copy(t._last.dragStart).add(A);t.object3D.updateMatrix()})}}this._viewport._resetBBox();this._viewport._updateCamera()}this._snapLine.visible=true};W.prototype._dragEnd=function(){if(this._state!==K.DRAG){return}var t=new Map;var e={version:"2.0","xmlns:VB":"VB",Data:{Merge:{N:[]}}};this._instances.forEach(function(e){if(e.id){if(e.voGroup.isDataBound){var i=e.voGroup.datasource;var a=t.get(i);if(!a){a={name:i,E:[]};t.set(i,a)}var n=e.voGroup.template.pos;var o=n.path[n.path.length-1];var r=this._adapter._parser.getAttributeAlias(i,o);var h=this._adapter._parser.getAttributeAlias(i,e.voGroup.keyAttributeName);var p=e.object3D.position;var l=p.x.toFixed(5)+";"+p.y.toFixed(5)+";"+p.z.toFixed(5);e.dataInstance[o]=e._last.pos=e.pos=l;var _={};_[h]=e.id;_[r]=l;a.E.push(_)}else{s.error("Only data bound instance can be included in Data.Merge section",e.id,c)}}else{s.error("Cannot process instance without id",e,c)}},this);if(t.size>0){t.forEach(function(t){e.Data.Merge.N.push(t)});this._adapter.fireSubmit({data:JSON.stringify(e)})}this._state=K.PICK;this._hovered=null;this._origin=null;this._touch=null;this._snapping=false;this._snapLine.visible=false;this._instances.length=0;this._changeables3d=Array.from(this._changeables,function(t){return t.object3D});this._cameraControls.setEnabled(true)};W.prototype._hoverOn=function(t){var e=this;if(!t.geometry.boundingBox){t.geometry.computeBoundingBox()}R.copy(t.geometry.boundingBox);R.applyMatrix4(t.matrixWorld);function i(t,i,s,a){e._snapPointsData[t].pos.set(i,s,a)}i(0,R.min.x,R.min.y,R.min.z);i(1,R.min.x,R.min.y,R.max.z);i(2,R.min.x,R.max.y,R.min.z);i(3,R.min.x,R.max.y,R.max.z);i(4,R.max.x,R.min.y,R.min.z);i(5,R.max.x,R.min.y,R.max.z);i(6,R.max.x,R.max.y,R.min.z);i(7,R.max.x,R.max.y,R.max.z);this._snapPoints.visible=true;this._updateSnapPoints();this._snapBox.visible=true;this._snapBox.setFromObject(t)};W.prototype._hoverOff=function(){this._snapBox.visible=false;this._snapPoints.visible=false;this._snapHighlightPoint.visible=false};W.prototype._isCollide=function(t,i){var s;if(t.visible&&t.geometry&&e.layersEnabled(t.layers,0)&&this._instances.indexOf(t._sapInstance)<0){t.updateWorldMatrix(false,false);if(!t.geometry.boundingBox){t.geometry.computeBoundingBox()}if(t.isInstancedMesh){for(s=0;s<t.count;++s){t.getMatrixAt(s,T);R.copy(t.geometry.boundingBox);R.applyMatrix4(T);if(R.intersectsBox(i)){return true}}}else{R.copy(t.geometry.boundingBox);R.applyMatrix4(t.matrixWorld);if(R.intersectsBox(i)){return true}}}var a=t.children;for(s=0;s<a.length;++s){if(this._isCollide(a[s],i)){return true}}return false};W.prototype._updateSnapLineGeometry=function(t,e){var i=this._snapLine.geometry.attributes.position;i.needsUpdate=true;i.array[0]=t.x;i.array[1]=t.y;i.array[2]=t.z;i.array[3]=t.x+e.x;i.array[4]=t.y+e.y;i.array[5]=t.z+e.z;this._snapLine.geometry.computeBoundingBox();this._snapLine.geometry.computeBoundingSphere();if(this._snapLine.material===this._lineMaterialDashed){this._snapLine.computeLineDistances()}};W.prototype._updateSnapLine=function(){this._updateSnapLineColor(this._snapAxis?this._snapAxis.color:v);this._updateSnapLineType(this._snapAxis&&this._lockToAxis||this._snapAlways)};W.prototype._updateSnapLineColor=function(t){if(!this._snapLine.material.color.equals(t)){this._snapLine.material.color.copy(t);this._snapLine.material.needsUpdate=true}};W.prototype._updateSnapLineType=function(t){var e=this._snapLine.material;this._snapLine.material=t?this._lineMaterialSolid:this._lineMaterialDashed;if(e!==this._snapLine.material){this._snapLine.material.color.copy(e.color);this._snapLine.material.needsUpdate=true;if(this._snapLine.material===this._lineMaterialDashed){this._snapLine.computeLineDistances()}}};W.prototype._getAxisSnapDistance=function(t,e,i){l(t,A);l(j.copy(t).add(e),j);H.copy(A).add(i);var s=this._viewport._camera;A.project(s);j.project(s);H.project(s);A.z=j.z=H.z=0;G.start.copy(A);G.end.copy(H);G.closestPointToPoint(j,false,A);return j.distanceTo(A)};W.prototype._getAxisSnapPosition=function(t,e,i,a){l(t,A);l(j.copy(t).add(e),j);H.copy(i).multiplyScalar(B);z.copy(A).sub(H);O.copy(A).add(H);var n=this._viewport._camera;j.project(n);A.copy(z).project(n);H.copy(O).project(n);A.z=j.z=H.z=0;G.start.copy(A);G.end.copy(H);G.closestPointToPoint(j,false,A);I.origin.setFromMatrixPosition(n.matrixWorld);I.direction.set(A.x,A.y,.5).unproject(n).sub(I.origin).normalize();if(I.distanceSqToSegment(z,O,A,j)<C){_(j,j);a.copy(j.sub(t))}else{s.error("failed to calculate snapping point","",c)}};W.prototype._cancel=function(){if(this._touch){for(var t=0;t<this._instances.length;++t){this._instances[t].object3D.position.copy(this._instances[t]._last.dragStart);this._instances[t].object3D.updateMatrix();var e=this._adapter._sceneBuilder._instanceDecals.get(this._instances[t]);if(e){e.forEach(function(t){t.object3D.position.copy(t._last.dragStart);t.object3D.updateMatrix()})}}this._touch=null;this._hovered=null;this._snapLine.visible=false;this._instances.length=0;this._cameraControls.setEnabled(true);this._dom.style.cursor="auto";this._viewport._resetBBox();this._viewport._updateCamera()}};W.prototype._addToScene=function(t,e,i,s,a){if(i!==undefined){t.visible=i}if(s!==undefined){t.layers.set(s)}if(a!==undefined){t.renderOrder=a}e.add(t);t.matrixAutoUpdate=false};W.prototype._addListener=function(t,e,i){var s=i.bind(this);this[e+"Proxy"]=s;t.addEventListener(e,s)};W.prototype._removeListener=function(t,e){t.removeEventListener(e,this[e+"Proxy"]);delete this[e+"Proxy"]};W.prototype._subscribe=function(){var t=this._viewport.getDomRef();if(t){this._dom=t;this._addListener(t,"keyup",this._onKeyUp);this._addListener(t,"keydown",this._onKeyDown);this._addListener(t,"wheel",this._onPointerMove);this._addListener(t,"pointerup",this._onPointerCancel);this._addListener(t,"pointerdown",this._onPointerDown);this._addListener(t,"pointermove",this._onPointerMove);this._addListener(t,"pointerleave",this._onPointerCancel)}this._addListener(this._cameraControls,"change",this._onCameraChange)};W.prototype._unsubscribe=function(){var t=this._viewport.getDomRef();if(t){this._dom=null;this._removeListener(t,"wheel");this._removeListener(t,"keyup");this._removeListener(t,"keydown");this._removeListener(t,"pointerup");this._removeListener(t,"pointerdown");this._removeListener(t,"pointermove");this._removeListener(t,"pointerleave")}this._removeListener(this._cameraControls,"change")};W.prototype._updatePointer=function(t,e){var i=this._viewport.getDomRef().getBoundingClientRect();e.x=(t.cursor?t.cursor.x:t.pageX-window.pageXOffset-i.left)/i.width*2-1;e.y=-(t.cursor?t.cursor.y:t.pageY-window.pageYOffset-i.top)/i.height*2+1;return e};W.prototype._updateSnapPoints=function(){A.copy(this._snapPointsData[0].pos).add(this._snapPointsData[M-1].pos).multiplyScalar(.5);var t=A.distanceTo(this._camera.position)*Math.min(1.9*Math.tan(Math.PI*this._camera.fov/360)/this._camera.zoom,10);for(var e=0;e<M;++e){this._snapPointsData[e].scale.set(1,1,1).multiplyScalar(t/170);T.compose(this._snapPointsData[e].pos,k,this._snapPointsData[e].scale);this._snapPoints.setMatrixAt(e,T)}this._snapPoints.instanceMatrix.needsUpdate=true;this._snapHighlightPoint.scale.copy(this._snapPointsData[0].scale);this._snapHighlightPoint.updateMatrix()};W.prototype._onCameraChange=function(t){if(this._snapPoints.visible){this._updateSnapPoints()}};return W});