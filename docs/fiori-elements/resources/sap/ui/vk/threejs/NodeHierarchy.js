/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../NodeHierarchy","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","../Messages","../getResourceBundle","../NodeContentType","sap/base/util/uid","sap/base/assert","sap/base/Log","../thirdparty/three"],function(e,t,n,r,o,i,a,s,d,c,u){"use strict";var f={equals:function(e,t){return e===t},contains:function(e,t){return e.indexOf(t)!==-1},startsWith:function(e,t){return e.indexOf(t)===0}};var h=e.extend("sap.ui.vk.threejs.NodeHierarchy",{metadata:{library:"sap.ui.vk"},_baseNodeProxyPool:new t(n),constructor:function(t){e.call(this);this._scene=t;this._nodeProxies=[]}});h.prototype.destroy=function(){this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._scene=null;e.prototype.destroy.call(this)};h.prototype.getScene=function(){return this._scene};h.prototype.getSceneRef=function(){return this._scene.getSceneRef()};h.prototype.enumerateChildren=function(e,t,n,r){if(typeof e==="function"){r=n;n=t;t=e;e=undefined}var o=this.getChildren(e,n);if(r){o.forEach(t)}else{var i=this._baseNodeProxyPool.borrowObject();try{o.forEach(function(e){i.init(this,e);t(i);i.reset()}.bind(this))}finally{this._baseNodeProxyPool.returnObject(i)}}return this};h.prototype.enumerateAncestors=function(e,t,n){var r=this.getAncestors(e);if(n){r.forEach(t)}else{var o=this._baseNodeProxyPool.borrowObject();try{r.forEach(function(e){o.init(this,e);t(o);o.reset()}.bind(this))}finally{this._baseNodeProxyPool.returnObject(o)}}return this};h.prototype.createNodeProxy=function(e){var t=new r(this,e);this._nodeProxies.push(t);return t};h.prototype.destroyNodeProxy=function(e){var t=this._nodeProxies.indexOf(e);if(t>=0){this._nodeProxies.splice(t,1)[0].destroy()}return this};h.prototype.getChildren=function(e,t){if(typeof e==="boolean"){t=e;e=undefined}if(!e){e=this._scene.getSceneRef()}var n=[];if(t||!e.userData.closed){e.children.forEach(function(e){if(!e.private&&(e.geometry===undefined||!e.userData.skipIt)){n.push(e)}})}return n};h.prototype.getAncestors=function(e){var t=[];e.traverseAncestors(function(e){t.unshift(e)});if(t.length>0&&t[0]===this._scene.getSceneRef()){t.shift()}return t};h.prototype.findNodesByName=function(e){var t=[];if(e===undefined||e===null||e===""||jQuery.isEmptyObject(e)){this._scene.getSceneRef().children.forEach(function(e){e.traverse(function(e){if(!e.private&&!e.userData.skipIt){t.push(e)}})})}else{var n=f[e.predicate||"equals"];if(n===undefined){c.error(i().getText(o.VIT8.summary),o.VIT8.code,"sap.ui.vk.threejs.NodeHierarchy")}else if(!Array.isArray(e.value)&&typeof e.value!=="string"){c.error(i().getText(o.VIT6.summary),o.VIT6.code,"sap.ui.vk.threejs.NodeHierarchy")}else{var r=Array.isArray(e.value)?e.value:[e.value];if(!e.caseSensitive){for(var a in r){r[a]=r[a].toLowerCase()}}this._scene.getSceneRef().children.forEach(function(o){o.traverse(function(o){if(!o.private&&!o.userData.skipIt){var i=o.name||"";if(!e.caseSensitive){i=i.toLowerCase()}for(var a in r){if(n(i,r[a])){t.push(o);break}}}})})}}return t};h.prototype.findNodesByUsageIdPath=function(e,t,n){var r=[];function o(i,a,s){if(!i.userData.skipIt){if(a>=0){var d=t[a];if(d==="**"){d=t[++a];s=true}var c=d==="*";if(!c&&Array.isArray(i.userData.usageIds)){var u=i.userData.usageIds.find(function(t){return t.name===e});var f=u&&u.keys;var h=Array.isArray(d)?d:[d];if(Array.isArray(f)&&f.length===h.length){c=f.every(function(e){return h.some(function(t){return t.name===e.name&&t.value===e.value})})}}if(c){a++;if(a>=t.length){r.push(i);return}s=false}else if(!s){return}}else{a=0}}if(!i.userData.closed||n&&n.stepIntoClosedNodes){i.children.forEach(function(e){o(e,a,s)})}}o(n&&n.searchUnder||this._scene.getSceneRef(),-1,false);return r};h.prototype.createLayerProxy=function(e){return null};h.prototype.destroyLayerProxy=function(e){return this};h.prototype.getLayers=function(){return[]};h.prototype.getHotspotNodeIds=function(){return null};h.prototype.attachChanged=function(e,t,n){return this.attachEvent("changed",e,t,n)};h.prototype.detachChanged=function(e,t,n){return this.detachEvent("changed",e,t,n)};h.prototype.fireChanged=function(e,t,n){return this.fireEvent("changed",e,t,n)};h.prototype.attachNodeCreated=function(e,t,n){return this.attachEvent("nodeCreated",e,t,n)};h.prototype.detachNodeCreated=function(e,t,n){return this.detachEvent("nodeCreated",e,t,n)};h.prototype.fireNodeCreated=function(e,t,n){return this.fireEvent("nodeCreated",e,t,n)};h.prototype.attachNodeRemoving=function(e,t,n){return this.attachEvent("nodeRemoving",e,t,n)};h.prototype.detachNodeRemoving=function(e,t,n){return this.detachEvent("nodeRemoving",e,t,n)};h.prototype.fireNodeRemoving=function(e,t,n){return this.fireEvent("nodeRemoving",e,t,n)};h.prototype.attachNodeReplaced=function(e,t,n){return this.attachEvent("nodeReplaced",e,t,n)};h.prototype.detachNodeReplaced=function(e,t,n){return this.detachEvent("nodeReplaced",e,t,n)};h.prototype.fireNodeReplaced=function(e,t,n){return this.fireEvent("nodeReplaced",e,t,n)};h.prototype.attachNodeUpdated=function(e,t,n){return this.attachEvent("nodeUpdated",e,t,n)};h.prototype.detachNodeUpdated=function(e,t,n){return this.detachEvent("nodeUpdated",e,t,n)};h.prototype.fireNodeUpdated=function(e,t,n){return this.fireEvent("nodeUpdated",e,t,n)};h.prototype.createNode=function(e,t,n,r,o){var c=this.getScene().getSceneBuilder();var f=null;var h;if(c){if(r===a.Annotation){h={contentType:"ANNOTATION",name:t,sid:o.sid||s(),annotationId:s()}}else{h=o||{};h.name=h.name||t;h.sid=h.sid||s()}f=c.createNode(h);if(!e){e=f.parent}}else{if(!e){e=this._scene.getSceneRef()}f=new u.Group;f.name=t;e.add(f)}var p=e.children.indexOf(n);d(e.children[e.children.length-1]===f,i().getText("NODEHIERARCHY_MSG_CREATENODEFAILED"));if(p>=0){e.children.splice(p,0,e.children.pop())}if(r){f._vkSetNodeContentType(r)}else{f._vkSetNodeContentType(a.Regular)}if(o&&c){switch(f._vkGetNodeContentType()){case a.Annotation:o.nodeId=f._vkPersistentId();o.id=h.annotationId;c.createAnnotation(o);break;case a.Background:c.setParametricContent(o.sid,o.parametricContent);break;default:}}this.fireNodeCreated({nodeRef:f,nodeId:f});this.fireChanged();return f};h.prototype.getNodeContentType=function(e){if(e==null){return a.Regular}var t=e._vkGetNodeContentType();if(!t){t=a.Regular}return t};h.prototype.createNodeCopy=function(e,t,n,r){if(!t){t=this._scene.getSceneRef()}var o=t.children.indexOf(r);var a=e.clone(true);a.name=n;t.add(a);d(t.children[t.children.length-1]===a,i().getText("NODEHIERARCHY_MSG_CREATENODEFAILED"));if(o>=0){t.children.splice(o,0,t.children.pop())}this.fireNodeCreated({nodeRef:a,nodeId:a});this.fireChanged();return a};h.prototype.removeNode=function(e){var t=[].concat(e);t.forEach(function(e){if(e&&e.parent){this.fireNodeRemoving({nodeRef:e,nodeId:e});e.parent.remove(e)}}.bind(this));var n=this.getScene().getSceneBuilder();if(n){t.forEach(n.removeNode,n)}this.fireChanged();return this};return h});