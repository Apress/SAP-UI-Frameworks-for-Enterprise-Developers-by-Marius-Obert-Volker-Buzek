/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/ui/base/ManagedObject","./Billboard","../thirdparty/html2canvas","./PolylineGeometry","./PolylineMaterial","./PolylineMesh","../BillboardStyle","../LeaderLineMarkStyle","./ThreeUtils"],function(t,e,a,r,i,l,s,o,n,h){"use strict";var p=a.extend("sap.ui.vk.threejs.Callout",{metadata:{library:"sap.ui.vk",properties:{anchorNode:{type:"any",defaultValue:null},depthTest:{type:"boolean",defaultValue:true}}}});p.prototype.init=function(){if(a.prototype.init){a.prototype.init.call(this)}this._lines=[];this._heads=[]};p.prototype.exit=function(){if(a.prototype.exit){a.prototype.exit.call(this)}this._lines.forEach(function(t){h.disposeObject(t)});this._lines=null;this._heads.forEach(function(t){h.disposeObject(t)});this._heads=null};p.prototype._traverse=function(t){a.prototype._traverse.call(this,t);this._lines.forEach(t);this._heads.forEach(t)};p.prototype.setDepthTest=function(t){this.setProperty("depthTest",t,true);this._traverse(function(e){e.material.depthTest=t});return this};var d=new t.Vector4,u=new t.Vector4,y=new t.Vector4,c=new t.Vector2,x=new t.Vector2,m=new t.Vector2,f=new t.Quaternion,v=new t.Matrix4,M=new t.Vector2,g=new t.Vector3,w=new t.Vector3,b=new t.Vector3(0,0,1),_=new t.Matrix4,S=new t.Matrix4;p.prototype._update=function(e,a,r){var i=this.getNode();if(!i||!i.visible){return}if(this._needUpdateTexture){this._needUpdateTexture=false;this._updateTexture()}i.matrix.copy(i.parent.matrixWorld).invert();i.matrix.decompose(i.position,i.quaternion,i.scale);i.matrixWorld.identity();var l=this.getPosition(),s=this._billboard.position;if(l){s.copy(l)}else{s.setScalar(0)}var n=this.getAnchorNode();if(n){s.applyMatrix4(n.matrixWorld)}this._billboard.quaternion.copy(a.quaternion);_.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);d.copy(s).applyMatrix4(_);c.copy(d).multiplyScalar(1/d.w).multiply(r);var h=d.w*2/(r.x*a.projectionMatrix.elements[0]);this._billboard.scale.set(h*this._width,h*this._height,1);g.setFromMatrixColumn(a.matrixWorld,0).multiplyScalar(h*(Math.round(c.x*.5)-c.x*.5));w.setFromMatrixColumn(a.matrixWorld,1).multiplyScalar(h*(Math.round(c.y*.5)-c.y*.5));s.add(g).add(w);this._billboard.updateMatrix();this._billboard.updateMatrixWorld();var p=this.getStyle()===o.CircularShape;var D=a.near;function P(t,e,a){if(t<e){return t-e}else if(t>a){return t-a}return 0}this._lines.forEach(function(e){if(e.userData.targetNode){e.matrix.copy(e.userData.targetNode.matrixWorld)}else{e.matrix.identity()}e.matrixWorld.copy(e.matrix);if(e.isPolylineMesh){e.material.resolution.copy(r)}if(e.isHaloMesh){return}var i=e.geometry.vertices;var l=i[0];var s=i[i.length-2];var o=i[i.length-1];var n=e.userData.startPointMesh;var h=false;var g=[0,i.length-1];if(n!==undefined){l.copy(n.userData.targetVertex)}S.multiplyMatrices(_,e.matrixWorld);if(e.userData.extensionLength>0&&i.length>2){g.push(i.length-2);d.copy(i[i.length-3]).applyMatrix4(S);x.copy(d).multiplyScalar(1/d.w).multiply(r);s.set(Math.sign(x.x-c.x)*.5*(1+e.userData.extensionLength/this._width),0,0);s.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(v.copy(e.matrixWorld).invert())}d.copy(s).applyMatrix4(S);x.copy(d).multiplyScalar(1/d.w).multiply(r);if(p){var w=M.copy(x).sub(c).length();h=w<this._width;M.multiplyScalar(.5/w);o.set(M.x,M.y,0)}else{var T=P(x.x,c.x-this._width,c.x+this._width),W=P(x.y,c.y-this._height,c.y+this._height);h=T===0&&W===0;if(Math.abs(T)>Math.abs(W)){o.set(Math.sign(T)*.5,0,0)}else{o.set(0,Math.sign(W)*.5,0)}}if(h){o.copy(s)}else{o.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(v.copy(e.matrixWorld).invert())}e.geometry.verticesNeedUpdate=true;if(n!==undefined){n.position.copy(n.userData.targetVertex).applyMatrix4(e.matrixWorld);d.copy(n.position).applyMatrix4(_);var C=d.w/(r.x*a.projectionMatrix.elements[0]);n.scale.setScalar(C);n.visible=false;var V=false;if(d.w>=D){u.copy(d);y.copy(i[1]).applyMatrix4(S);if(y.w<D){var O=(u.w-D)/(u.w-y.w);y.sub(u).multiplyScalar(O).add(u)}m.copy(u).multiplyScalar(1/u.w);x.copy(y).multiplyScalar(1/y.w);M.copy(x).sub(m).multiply(r);V=M.length()<n.userData.lineOffset;f.setFromAxisAngle(b,Math.atan2(M.y,M.x));n.quaternion.copy(a.quaternion).multiply(f);n.updateMatrix();n.matrixWorld.copy(n.matrix);n.matrixWorldNeedsUpdate=false;m.multiply(r).sub(c);n.visible=p?m.length()>this._width:Math.abs(m.x)>this._width||Math.abs(m.y)>this._height;if(V||!n.visible){l.copy(i[1])}else{l.set(n.userData.lineOffset,0,0).applyMatrix4(n.matrixWorld).applyMatrix4(v.copy(e.matrixWorld).invert())}}}e.geometry._updateVertices(g);e.computeLineDistances(S,r,a instanceof t.PerspectiveCamera?D:undefined);if(e.userData.haloMesh){e.userData.haloMesh.material.lineLength=e.material.lineLength}}.bind(this))};p.prototype._createMarkMesh=function(e,a,r,i){var l=r===n.Arrow;var s=window.devicePixelRatio;var o=a.width;var h=o*a.haloWidth;i=(Array.isArray(i)||i instanceof Float32Array)&&i.length===2?i:[1,1];var p,d;if(l){p=Math.max(35*i[0],o*5);d=Math.max(15*i[1],o*2)}else{p=d=Math.max(2*i[0],o*2)}p=Math.ceil(p+h*2);d=Math.ceil(d+h*2);var u=document.createElement("canvas");u.width=t.MathUtils.ceilPowerOfTwo(p*s);u.height=t.MathUtils.ceilPowerOfTwo(d*s);var y=u.getContext("2d");var c=p/2,x=d/2;y.fillStyle="#FFF";y.scale(s,s);if(l){y.beginPath();y.moveTo(0,x);y.lineTo(p,0);y.lineTo(p,d);y.closePath();y.fill();var m=p*x/Math.sqrt(p*p+x*x),f=(m-h)/m;var v=p-p*f,M=x*(p*f-h)/p;y.fillStyle=e.getStyle();y.beginPath();y.moveTo(v,x);y.lineTo(p-h,x-M);y.lineTo(p-h,x+M);y.closePath();y.fill()}else{var g=p*.5,w=g-h;y.beginPath();y.ellipse(c,x,g,g,0,0,Math.PI*2);y.fill();y.fillStyle=e.getStyle();y.beginPath();y.ellipse(c,x,w,w,0,0,Math.PI*2);y.fill()}y.fillRect(p-h,x-o*.5,h,o);var b=new t.MeshBasicMaterial({map:new t.CanvasTexture(u),transparent:true,alphaTest:.05,premultipliedAlpha:true,side:t.DoubleSide,depthTest:this.getDepthTest()});var _=new t.PlaneGeometry(p*2,d*2);if(l){_.translate(p,0,0)}var S=new t.Mesh(_,b);S.userData.skipIt=true;S.userData.lineOffset=l?p*2-1:p-h*2;var D=new t.Vector2(p*s/u.width,d*s/u.height);var P=S.geometry.attributes.uv.array;for(var T=0,W=P.length;T<W;T+=2){P[T]*=D.x;P[T+1]=1-(1-P[T+1])*D.y}return S};p.prototype.addLeaderLine=function(t,e,a,r,o,h,p){var d=this.getNode();if(p>0&&t.length<3){t.push(t[t.length-1].clone())}var u=a.userData.lineStyle||{};u.width=u.width||1;u.haloWidth=u.haloWidth||0;u.endCapStyle=u.endCapStyle||0;var y=u.endCapStyle||t.length>2?1:0;var c=(y&&(r!==n.None||u.endCapStyle===0)?1:0)|(y&&(o!==n.None||u.endCapStyle===0)?2:0);var x=new i;x.setVertices(t);var m;if(u.haloWidth>0){var f=new l({color:16777215,lineColor:16777215,linewidth:u.width*(u.haloWidth*2+1),dashCapStyle:u.endCapStyle,segmentCapStyle:y,trimStyle:c,transparent:true,depthTest:this.getDepthTest()});m=new s(x,f);m.userData.skipIt=true;m.userData.targetNode=e;m.matrixAutoUpdate=false;m.renderOrder=this.getRenderOrder();m.isHaloMesh=true;d.add(m);this._lines.push(m)}var v=new l({color:16777215,lineColor:a.color,linewidth:u.width,dashCapStyle:u.endCapStyle,segmentCapStyle:y,trimStyle:c,dashPattern:u.dashPattern||[],dashScale:u.dashPatternScale||1,transparent:true,depthTest:this.getDepthTest()});var M=new s(x,v);M.userData.skipIt=true;M.userData.targetNode=e;M.userData.extensionLength=p;M.userData.haloMesh=m;M.matrixAutoUpdate=false;M.renderOrder=this.getRenderOrder();d.add(M);this._lines.push(M);if(r!==n.None){var g=this._createMarkMesh(a.color,u,r,h);g.userData.targetVertex=x.vertices[0].clone();g.matrixAutoUpdate=false;g.renderOrder=this.getRenderOrder();M.userData.startPointMesh=g;d.add(g);this._heads.push(g)}return M};return p});