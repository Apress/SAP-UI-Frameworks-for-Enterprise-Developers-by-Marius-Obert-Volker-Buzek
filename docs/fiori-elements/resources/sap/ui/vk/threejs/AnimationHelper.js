/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","../View","../AnimationPlayback","../AnimationTrackType","../AnimationTrackValueType","../AnimationTrackValueTypeSize","../AnimationRotateType","../AnimationMath"],function(e,t,a,r,n,i,o,s){"use strict";var u=function(){};u.prototype._getChildNodesWithMaterial=function(e,t){for(var a=0;e.children&&a<e.children.length;a++){var r=e.children[a];if(r&&r.material&&r.material.color){t.push(r)}this._getChildNodesWithMaterial(r,t)}};u.prototype._getVkTrackType=function(e){switch(e.type){case"TRANSLATE":return r.Translate;case"ROTATE":return r.Rotate;case"SCALE":return r.Scale;case"OPACITY":return r.Opacity;case"COLOR":return r.Color;default:}};u.prototype._getVkTrackValueType=function(e,t){switch(e.type){case"TRANSLATE":return n.Vector3;case"ROTATE":if(t===o.Quaternion){return n.Quaternion}else if(t===o.AngleAxis){return n.AngleAxis}else{return n.Euler}break;case"SCALE":return n.Vector3;case"OPACITY":return n.Scalar;case"COLOR":return n.Vector3;default:}};u.prototype.insertEmptyTrack=function(e,t,a,r){var n=this._getVkTrackValueType(e);var i=r.createTrack(null,{trackValueType:n,isAbsoluteValue:e.isAbsoluteValue});if(t&&a){t.setNodeAnimation(a,this._getVkTrackType(e),i,true)}};u.prototype.insertTracks=function(e,t,a,r){e.forEach(function(e){var o=t.get(e.id);var s=r.findTrack(e.id.toString());if(Array.isArray(o)&&o.length){if(!s){var u=this._getVkTrackValueType(o[0],e.rotateType);var f=i.get(u);s=r.createTrack(e.id.toString(),{trackValueType:u,cycleForward:e.cyclicInfo.cyclicEnd,cycleBackward:e.cyclicInfo.cyclicStart,infinite:e.infinite,isAbsoluteValue:o[0].isAbsoluteValue});if(e.times){e.times.forEach(function(t,a){var r;if(u===n.Scalar){r=e.values[a]}else{r=[];for(var i=0;i<f;i++){r.push(e.values[a*f+i])}}s.insertKey(t,r,true)})}}o.forEach(function(e){var t=r.findSequence(e.sequenceId);var n=a.get(e.targetId);if(t&&n){t.setNodeAnimation(n,this._getVkTrackType(e),s,true)}},this)}},this);return this};u.prototype.setInitialNodePositionsFromSubsequentViews=function(e,t,a){if(!e||!e.length){return}var r;var n;var i;var o=new Map;for(var s=e.length-1;s>0;s--){var u=e[s];var f;if(u){f=u.getPlaybacks()}if(f){for(var l=f.length-1;l>=0;l--){var c=f[l];if(c){r=t.findSequence(c.getSequence().getId());if(r){if(a&&!r.hasHighlight()){continue}if(!c.getReversed()){n=r.getNodesBoundaryValues(true).entries()}else{n=r.getNodesBoundaryValues(false).entries()}i=n.next();while(!i.done){o.set(i.value[0],i.value[1]);i=n.next()}}}}}var v=e[s-1];if(v){if(!v.userData){v.userData={}}if(!v.userData.nodeStartDataByAnimation){v.userData.nodeStartDataByAnimation=new Map}n=o.entries();i=n.next();while(!i.done){v.userData.nodeStartDataByAnimation.set(i.value[0],i.value[1]);i=n.next()}}}};u.prototype.setInitialNodePositionsFromPreviousViews=function(e,t,a){if(!e||!e.length){return}var r;var n;var i;var o=new Map;for(var s=0;s<e.length-1;s++){var u=e[s];var f;if(u){f=u.getPlaybacks()}if(f){for(var l=0;l<f.length;l++){var c=f[l];if(c){r=t.findSequence(c.getSequence().getId());if(r){if(a&&!r.hasHighlight()){continue}if(!c.getReversed()){n=r.getNodesBoundaryValues(false).entries()}else{n=r.getNodesBoundaryValues(true).entries()}i=n.next();while(!i.done){o.set(i.value[0],i.value[1]);i=n.next()}}}}}var v=e[s+1];if(v){if(!v.userData){v.userData={}}if(!v.userData.nodeStartDataByAnimation){v.userData.nodeStartDataByAnimation=new Map}n=o.entries();i=n.next();while(!i.done){v.userData.nodeStartDataByAnimation.set(i.value[0],i.value[1]);i=n.next()}}}};u.prototype.setInitialNodePositionsOnView=function(e,t,a){if(!e){return}var r;var n;var i=0;var o=null;o=e.getPlaybacks();if(!o||!o.length){return}if(!e.userData){e.userData={}}if(!e.userData.nodeStartDataByAnimation){e.userData.nodeStartDataByAnimation=new Map}for(var s=o.length-1;s>=i;s--){var u=o[s];var f=t.findSequence(u.getSequence().getId());if(f){if(a&&!f.hasHighlight()){continue}if(u.getReversed()){r=f.getNodesBoundaryValues(false).entries()}else{r=f.getNodesBoundaryValues(true).entries()}n=r.next();while(!n.done){e.userData.nodeStartDataByAnimation.set(n.value[0],n.value[1]);n=r.next()}}}};u.prototype.setInitialNodePositionsFromCurrenetViews=function(e,t,a){if(!e||!e.length){return}for(var r=0;r<e.length;r++){var n=e[r];if(!n){continue}this.setInitialNodePositionsOnView(n,t,a)}};u.prototype.setPlaybackStartTimes=function(e,t){if(!e||!e.length){return}for(var a=0;a<e.length;a++){var r=e[a];if(!r){continue}var n=null;if(r){n=r.getPlaybacks()}if(!n||!n.length){continue}var i=0;for(var o=0;o<n.length;o++){var s=n[o];var u=s.getSequence();if(u){u.resetDuration(true)}s.setStartTime(i);i+=s.getDuration()}}};u.prototype.prepareViewForAnimation=function(t){var a=t.getNodeInfos();if(!a){return}if(!t.userData){t.userData={}}if(!t.userData.nodesDataByView){t.userData.nodesDataByView=new Map}else{return}function r(t){return(new e.Matrix4).set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],0,0,0,1)}for(var n=0;n<a.length;n++){var i=a[n];if(!i||!i.target){continue}var o={};if(i.transform){o.position=new e.Vector3;o.scale=new e.Vector3;o.quaternion=new e.Quaternion;var s=r(i.transform);s.decompose(o.position,o.quaternion,o.scale);t.userData.nodesDataByView.set(i.target,o)}}};u.prototype.getNodePositionByView=function(e,t){var a;if(!e){return a}if(!e.userData||!e.userData.nodesDataByView){this.prepareViewForAnimation(e)}if(e.userData&&e.userData.nodesDataByView){a=e.userData.nodesDataByView.get(t)}return a};u.prototype.getNodePositionFromNearestPlayback=function(e,t,a,r){var n;if(!t||!e){return n}var i=t.getPlaybacks();if(!i){return n}var o;var s;var u=0;for(o=0;o<i.length;o++){s=i[o];if(a==s.getSequenceId()){u=s.getStartTime();break}}var f=0;for(o=0;o<i.length;o++){s=i[o];var l=s.getStartTime();if(u<=l){continue}if(a==s.getSequenceId()){continue}var c=e.findSequence(s.getSequenceId());if(c){var v;if(s.getReversed()){v=c.getNodesStartValues()}else{v=c.getNodesEndValues()}var g=v.get(r);if(g&&l>=f){n=g;f=l}}}return n};u.prototype._buildViewInitialState=function(e,t,a){var i=t.indexOf(e);if(i<0){return undefined}var o;var u;var f;var l=new Map;var c=function(e,t,a){var r=l.get(e);if(!r){r={target:e};l.set(e,r)}r[t]=a};var v=function(e,t){if(!e){return}var a=e.getNodeAnimation();if(a){a.forEach(function(e){var a=e.nodeRef;for(var i in r){var o=r[i];var u=e[o];if(u&&u.getKeysCount()){var f=t?0:u.getKeysCount()-1;var l=u.getKey(f);var v=u.getKeysType();var g=0;if(v===n.AngleAxis){g=1}var d=s.interpolate(v,l,l,g,u);c(a,o,d.value)}}})}};for(o=t.length-1;o>=i;o--){f=t[o].getPlaybacks();if(Array.isArray(f)){for(u=f.length-1;u>=0;u--){v(f[u].getSequence(),true)}}}for(o=0;o<i;o++){f=t[o].getPlaybacks();if(Array.isArray(f)){for(u=0;u<f.length;u++){v(f[u].getSequence(),false)}}}return l};u.prototype.buildViewsInitialState=function(e,t){if(!Array.isArray(e)){return}var a=function(e){var t=[];e.forEach(function(e,a){t.push(e)});return t};e.forEach(function(r){var n=this._buildViewInitialState(r,e,t);if(n){r.updateNodeInfos(a(n))}},this)};return u});