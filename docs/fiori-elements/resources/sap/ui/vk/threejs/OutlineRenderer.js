/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./ThreeUtils"],function(e,t,a){"use strict";var r=function(t){this._outlineWidth=t;this._copyMaterial=new e.MeshBasicMaterial({transparent:true,fog:false});this._maskMaterial=new e.MeshBasicMaterial({side:e.DoubleSide,fog:false});this._outlineMaterial=new e.ShaderMaterial({uniforms:{mask:{value:null},offset:{value:new e.Vector2(1,0,0,1)}},vertexShader:["varying vec2 vTC;","void main() {","\tvTC = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vTC;","uniform sampler2D mask;","uniform vec4 offset;","float delta(vec3 c1,  vec3 c2) {","\tvec3 dc = c1 - c2;","\treturn dot(dc, dc);","}","void main() {","\tvec3 c = texture2D(mask, vTC).rgb;","\tvec3 c1 = texture2D(mask, vTC + offset.xy).rgb;","\tvec3 c2 = texture2D(mask, vTC - offset.xy).rgb;","\tvec3 c3 = texture2D(mask, vTC + offset.zw).rgb;","\tvec3 c4 = texture2D(mask, vTC - offset.yw).rgb;","\tvec4 a = vec4(delta(c, c1), delta(c, c2), delta(c, c3), delta(c, c4));","\tgl_FragColor = vec4(1.0, 1.0, 1.0, sign(dot(a, a)));","}"].join("\n")});this._expandMaterial=new e.ShaderMaterial({uniforms:{mask:{value:null},offset:{value:new e.Vector2(1,0,0,1)}},vertexShader:["varying vec2 vTC;","void main() {","\tvTC = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vTC;","uniform sampler2D mask;","uniform vec4 offset;","void main() {","\tfloat a = texture2D(mask, vTC).a;","\ta += texture2D(mask, vTC + offset.xy).a;","\ta += texture2D(mask, vTC - offset.xy).a;","\ta += texture2D(mask, vTC + offset.zw).a;","\ta += texture2D(mask, vTC - offset.yw).a;","\tgl_FragColor = vec4(1.0, 1.0, 1.0, a * 0.5);","}"].join("\n")});this._screenCamera=new e.OrthographicCamera(-1,1,1,-1,0,1);this._screenMesh=new e.Mesh(new e.PlaneGeometry(2,2))};r.prototype.setOutlineWidth=function(e){this._outlineWidth=e};r.prototype.render=function(t,a,r,i,s,n){if(!i||!i.length){return}var o=t.getSize(new e.Vector2);var l=2;var h=o.width*l;var v=o.height*l;if(!this._renderTarget1||this._renderTarget1.width!==h||this._renderTarget1.height!==v){var c={minFilter:e.NearestFilter,magFilter:e.NearestFilter};this._renderTarget1=new e.WebGLRenderTarget(h,v,c);this._renderTarget1.texture.generateMipmaps=false;this._renderTarget2=new e.WebGLRenderTarget(h,v,c);this._renderTarget2.texture.generateMipmaps=false}var u;var f;if(n){u=new Map;f=new Map;n.forEach(function(e){if(!e.node||!e.parent){return}u.set(e.node,e);if(e.parent){var t=f.get(e.parent)||[];t.push(e);f.set(e.parent,t)}})}var d;var m=new Set;var _=function(e){if(e.isMesh){m.add({mesh:e,color:d})}};var M;for(M=0;M<i.length;M++){var g=i[M];d=new e.Color((M+1&255)/255,(M+1>>8&255)/255,(M+1>>16&255)/255);g._vkTraverseNodes(_,u,f)}if(m.size===0){return}var p=new e.Color;t.getClearColor(p);var C=t.getClearAlpha();var T=t.autoClear;t.autoClear=false;t.setClearColor(0,0);var x;var w=this._renderTarget1;var k=this._renderTarget2;t.setRenderTarget(w);t.clear(true,true,false);var y=m.values();var D=y.next();while(!D.done){var b=D.value.mesh;this._maskMaterial.color=D.value.color;D=y.next();x=b.material;b.material=this._maskMaterial;t.render(b,r);b.material=x}var S=new e.Vector4(1/h,0,0,1/v);x=this._outlineMaterial;x.uniforms.mask.value=w.texture;x.uniforms.offset.value=S;this._screenMesh.material=x;t.setRenderTarget(k);t.render(this._screenMesh,this._screenCamera);if(this._outlineWidth>1){x=this._expandMaterial;x.uniforms.offset.value=S;this._screenMesh.material=x;for(M=1;M<this._outlineWidth;M++){var j=w;w=k;k=j;x.uniforms.mask.value=w.texture;t.setRenderTarget(k);t.render(this._screenMesh,this._screenCamera)}}x=this._copyMaterial;x.map=k.texture;x.color=s;this._screenMesh.material=x;t.setRenderTarget(null);t.render(this._screenMesh,this._screenCamera);t.setClearColor(p,C);t.autoClear=T};r.prototype.dispose=function(){if(this._copyMaterial){a.disposeMaterial(this._copyMaterial);this._copyMaterial=null}if(this._maskMaterial){a.disposeMaterial(this._maskMaterial);this._maskMaterial=null}if(this._outlineMaterial){a.disposeMaterial(this._outlineMaterial);this._outlineMaterial=null}if(this._expandMaterial){a.disposeMaterial(this._expandMaterial);this._expandMaterial=null}if(this._screenMesh){a.disposeObject(this._screenMesh);this._screenMesh=null}};return r});