/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/ui/core/Element","../TransformationMatrix"],function(t,e,i){"use strict";var a=e.extend("sap.ui.vk.threejs.NodesTransitionHelper",{metadata:{library:"sap.ui.vk",properties:{},publicMethods:["setViewStateManager","setNodeForDisplay","setDisappearingNode","setAppearingNode","clear","startDisplay","displayNodesMoving"],events:{displaying:{},displayed:{}}}});a.prototype.init=function(){this._viewStateManager=null;this._nodeLocalmMatrixMap=new Map;this._nodeLocalMatrixMapForVisibility=new Map;this._timeIntervalForDisplay=500;this._startTimeForDisplay=0};a.prototype.destroy=function(){this._viewStateManager=null;this._nodeLocalmMatrixMap=null;this._nodeLocalMatrixMapForVisibility=new Map;if(e.prototype.destroy){e.prototype.destroy.apply(this,arguments)}};a.prototype.setViewStateManager=function(t){this._viewStateManager=t};a.prototype.setNodeForDisplay=function(t,e){this._nodeLocalmMatrixMap.set(t,{oldMatrix:t.getLocalMatrix(),newMatrix:e?i.convertTo4x3(e.elements):null})};a.prototype.setDisappearingNode=function(t){var e=t.getLocalMatrix();var i=[e[0]*1e-4,e[1],e[2],e[3],e[4]*1e-4,e[5],e[6],e[7],e[8]*1e-4,e[9],e[10],e[11]];this._nodeLocalMatrixMapForVisibility.set(t,{oldMatrix:e,newMatrix:i,visible:false});this._viewport.getViewStateManager().setVisibilityState(t.getNodeRef(),true,false)};a.prototype.setAppearingNode=function(t){var e=t.getLocalMatrix();var i=[e[0]*1e-4,e[1],e[2],e[3],e[4]*1e-4,e[5],e[6],e[7],e[8]*1e-4,e[9],e[10],e[11]];this._nodeLocalMatrixMapForVisibility.set(t,{oldMatrix:i,newMatrix:e,visible:true})};a.prototype._interpolateNodePositionForVisibility=function(t,e,i){var a=t.getNodeRef();return i>=1?e.visible:a.visible};a.prototype._interpolateNodePosition=function(e,a,o,r){var s=(new t.Matrix4).fromArray(i.convertTo4x4(a));var n=new t.Vector3;var p=new t.Quaternion;var l=new t.Vector3;s.decompose(n,p,l);var M=(new t.Matrix4).fromArray(i.convertTo4x4(o));var d=new t.Vector3;var c=new t.Quaternion;var y=new t.Vector3;M.decompose(d,c,y);var h=(new t.Vector3).lerpVectors(n,d,r);var f=(new t.Quaternion).copy(p).slerp(c,r);var v=(new t.Vector3).lerpVectors(l,y,r);return{translation:h.toArray(),quaternion:f.toArray(),scale:v.toArray()}};a.prototype.startDisplay=function(t){if(this._nodeLocalmMatrixMap.size===0){return}this._timeIntervalForDisplay=t!==undefined?t:500;this._startTimeForDisplay=Date.now();this._nodeLocalmMatrixMap.forEach(function(t,e){if(!t.newMatrix){t.newMatrix=e.getLocalMatrix()}});this.fireDisplaying()};a.prototype.displayNodesMoving=function(){if(this._startTimeForDisplay===0||this._nodeLocalmMatrixMap===null||this._nodeLocalmMatrixMap.size===0){return}var t=Math.min((Date.now()-this._startTimeForDisplay)/this._timeIntervalForDisplay,1);t=1-Math.pow(1-t,3);var e={nodeRefs:[],positions:[]};this._nodeLocalmMatrixMap.forEach(function(i,a){if(a&&i.oldMatrix&&i.newMatrix){var o=this._interpolateNodePosition(a,i.oldMatrix,i.newMatrix,t);e.nodeRefs.push(a.getNodeRef());e.positions.push(o)}}.bind(this));if(e.nodeRefs.length){this._viewStateManager.setTransformation(e.nodeRefs,e.positions)}var i={nodeRefs:[],values:[]};this._nodeLocalMatrixMapForVisibility.forEach(function(e,a){if(a&&e){var o=this._interpolateNodePositionForVisibility(a,e,t);i.nodeRefs.push(a.getNodeRef());i.values.push(o)}}.bind(this));this._viewStateManager.setVisibilityState(i.nodeRefs,i.values);if(t===1){this.clear();this.fireDisplayed()}};a.prototype.clear=function(){this._nodeLocalmMatrixMap.clear();this._nodeLocalMatrixMapForVisibility.clear();this._startTimeForDisplay=0};return a});