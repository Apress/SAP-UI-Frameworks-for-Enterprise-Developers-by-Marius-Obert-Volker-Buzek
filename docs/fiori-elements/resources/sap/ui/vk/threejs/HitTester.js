/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../thirdparty/three"],function(e,r){"use strict";var t=function(){this._maskMaterial=new r.MeshBasicMaterial({side:r.DoubleSide,fog:false});this._depthMaterial=new r.ShaderMaterial({vertexShader:["#include <clipping_planes_pars_vertex>","void main() {","\t#include <begin_vertex>","\t#include <project_vertex>","\t#include <clipping_planes_vertex>","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","void main() {","\t#include <clipping_planes_fragment>","\thighp vec4 value = vec4(fract(vec4(1.0, 255.0, 65025.0, 16581375.0) * gl_FragCoord.z));","\tvalue.xyz -= value.yzw * (1.0 / 255.0);","\tgl_FragColor  = value;","}"].join("\n"),side:r.DoubleSide,clipping:true});this._renderTarget=new r.WebGLRenderTarget(1,1,{minFilter:r.NearestFilter,magFilter:r.NearestFilter});this._renderTarget.texture.generateMipmaps=false;this._renderTarget.depthBuffer=true};var a;var i=new r.Matrix4;var n=new r.Frustum;var l=new r.Matrix4;var o=new r.Vector2;var s=new r.Raycaster;var u=new r.Ray;var c=new r.Sphere;var v=[];var p=new Uint8Array(4);var f=new r.Vector3;function d(e){var r=e.parent;while(r){if(r.userData.closed){e=r}r=r.parent}while(e.parent&&e.userData.skipIt){e=e.parent}return e}t.prototype.hitTest=function(e,t,h,g,m,x,y,M,_){if(!a||a.constructor!==y.constructor){a=new y.constructor}a.copy(y);var w=y.view;if(w){var b=w.width/h;var C=w.height/g;a.setViewOffset(w.fullWidth,w.fullHeight,w.offsetX+(e-.5)*b,w.offsetY+(t-.5)*C,b,C)}else{a.setViewOffset(h,g,e-.5,t-.5,1,1)}a.updateMatrixWorld();a.updateProjectionMatrix();i.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);n.setFromProjectionMatrix(i);s.setFromCamera(o.set(0,0),a);var T=m.getContextRedBits();var B=m.getContextGreenBits();var j=m.getContextBlueBits();var F=T+B;var S=(1<<T)-1;var P=(1<<B)-1;var D=(1<<j)-1;var R=1/S;var O=1/P;var W=1/D;var k=this._maskMaterial;var I=new r.Color;m.getClearColor(I);var V=m.getClearAlpha();var A=m.autoClear;m.setRenderTarget(this._renderTarget);m.clippingPlanes=M||[];m.autoClear=false;m.setClearColor(0,0);m.clear(true,true,false);var G=k.color;var z=0;v.length=0;var E=_&&_.ignoreUnderlay?null:[];var L=[];var N=_&&_.ignoreOverlay?null:[];function U(e,t){if(!e.visible||e.userData.selectable===false){return}t=t||e.userData.renderStage;var a=e.geometry;if(a&&e.material&&n.intersectsObject(e)){var i=e.matrixWorld;var o=e.userData.renderGroup;if(o&&o.boundingSphere){c.setFromPackedArray(o.boundingSphere)}else{if(a.boundingSphere==null){a.computeBoundingSphere()}c.copy(a.boundingSphere)}c.applyMatrix4(i);if(s.ray.intersectsSphere(c)){l.copy(i).invert();u.copy(s.ray).applyMatrix4(l);var v=o&&o.boundingBox?r.Box3.newFromPackedArray(o.boundingBox):a.boundingBox;if(v==null||u.intersectsBox(v)){if(!t){L.push(e)}else if(t<0){if(E){E.push(e)}}else if(N){N.push(e)}}}}var p=e.children;for(var f=0,d=p.length;f<d;f++){U(p[f],t)}}U(x);function H(e){z+=1;v.push(e);G.setRGB((z&S)*R,(z>>T&P)*O,(z>>F&D)*W);var r=e.material;e.material=k;m.render(e,a);e.material=r}if(E!=null&&E.length>0){E.forEach(H);m.clearDepth()}L.forEach(H);if(N!=null&&N.length>0){m.clearDepth();N.forEach(H)}m.readRenderTargetPixels(this._renderTarget,0,0,1,1,p);z=(p[0]>>8-T)+(p[1]>>8-B<<T)+(p[2]>>8-j<<F);var X=z>0?v[z-1]:null;var Y;if(X){var q=X.material;X.material=this._depthMaterial;m.clear(true,true,false);m.render(X,a);X.material=q;m.readRenderTargetPixels(this._renderTarget,0,0,1,1,p);Y=(p[0]+(p[1]+(p[2]+p[3]/255)/255)/255)/255*2-1;f.set(0,0,Y).applyMatrix4(a.projectionMatrixInverse).applyMatrix4(a.matrixWorld)}m.setRenderTarget(null);m.clippingPlanes=[];m.setClearColor(I,V);m.autoClear=A;return X?{distance:s.ray.origin.distanceTo(f),point:f,object:d(X)}:null};t.prototype.hitTestPrecise=function(e,r,t,a,i,n,l){s.setFromCamera(o.set(e/t*2-1,r/a*-2+1),n);if(l&&l.length>0){for(var u in l){var c=l[u];var v=c.distanceToPoint(s.ray.origin),p=-v/c.normal.dot(s.ray.direction);if(p>0){if(v<0){s.near=Math.max(s.near,p)}else{s.far=Math.min(s.far,p)}}else if(v<0){return null}}}var f=s.intersectObjects(i.children,true);if(l&&l.length>0){s.near=0;s.far=Infinity}if(f){for(var h in f){var g=f[h];var m=d(g.object);if(m.visible&&!m.isBillboard&&!m.isDetailView){g.object=m;return g}}}return null};t.prototype.hitTestPoint=function(e,r,t,a,i,n,l){s.setFromCamera(o.set(e/t*2-1,r/a*-2+1),n);if(l&&l.length>0){for(var u in l){var c=l[u];var v=c.distanceToPoint(s.ray.origin),p=-v/c.normal.dot(s.ray.direction);if(p>0){if(v<0){s.near=Math.max(s.near,p)}else{s.far=Math.min(s.far,p)}}else if(v<0){return null}}}var f=s.intersectObjects(i.children,true);if(l&&l.length>0){s.near=0;s.far=Infinity}return f.length===1?f[0].point:null};return t});