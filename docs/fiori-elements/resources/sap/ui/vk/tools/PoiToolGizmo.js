/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","./Gizmo","./PoiToolGizmoRenderer","./GizmoPlacementMode","../NodeContentType","sap/base/assert"],function(t,e,o,i,n,r){"use strict";var s=e.extend("sap.ui.vk.tools.PoiToolGizmo",{metadata:{library:"sap.ui.vk"}});s.prototype.init=function(){if(e.prototype.init){e.prototype.init.apply(this)}this._viewport=null;this._tool=null;this._placementMode=i.ObjectCenter;this._nodes=[];this._poiIndex=-1;this._moveDelta=new t.Vector3;this._ignoreNonPoiNode=false};s.prototype.hasDomElement=function(){return true};s.prototype.setIgnoreNonPoiNode=function(t){this._ignoreNonPoiNode=t};s.prototype.getIgnoreNonPoiNode=function(){return this._ignoreNonPoiNode};s.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._nodes.length=0;this._updateSelection(t._viewStateManager);var o=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:o},true)};s.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._poiIndex=-1};s.prototype.getPOICount=function(){return this._nodes.length};s.prototype.getPOI=function(t){return t<this._nodes.length?this._nodes[t].node:null};s.prototype.selectPOI=function(t){this._poiIndex=t;this._viewport.setShouldRenderFrame()};s.prototype.beginGesture=function(){this._moveDelta.setScalar(0);this._nodes.forEach(function(e){var o=e.node;if(this._ignoreNonPoiNode&&o._vkGetNodeContentType()!==n.Symbol){return}e.origin=(new t.Vector3).setFromMatrixPosition(o.matrixWorld);e.matParentInv=new t.Matrix4;if(o.parent){e.matParentInv.copy(o.parent.matrixWorld).invert()}},this)};s.prototype._getNodesProperties=function(){var t=[];this._nodes.forEach(function(e){t.push({node:e.node})});return t};s.prototype.endGesture=function(){this._tool.fireMoved({x:this._moveDelta.x,y:this._moveDelta.y,z:this._moveDelta.z,nodesProperties:this._getNodesProperties()})};s.prototype._setOffset=function(t){if(this._tool.fireEvent("moving",{x:t.x,y:t.y,z:t.z,nodesProperties:this._getNodesProperties()},true)){this._move(t)}};s.prototype._move=function(e){this._moveDelta.copy(e);var o=this._viewport._isPanoramicActivated();var i=(new t.Vector3).setFromMatrixPosition(this._viewport.getCamera().getCameraRef().matrixWorld);this._nodes.forEach(function(r){var s=r.node;if(this._ignoreNonPoiNode&&s._vkGetNodeContentType()!==n.Symbol){return}if(!r.origin){r.origin=(new t.Vector3).setFromMatrixPosition(s.matrixWorld)}var a=r.origin.clone();if(o){var p=a.distanceTo(i);a.add(e).sub(i).setLength(p).add(i)}else{a.add(e)}s.matrixWorld.setPosition(a);s.matrix.multiplyMatrices(r.matParentInv,s.matrixWorld);s.position.setFromMatrixPosition(s.matrix);s.matrixWorldNeedsUpdate=true},this);this._viewport.setShouldRenderFrame()};s.prototype.move=function(e,o,i){this.beginGesture();this._move(new t.Vector3(e,o,i||0))};s.prototype.handleSelectionChanged=function(t){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var e=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:e},true);this._poiIndex=-1}};s.prototype._getSelectionCenter=function(o){e.prototype._getSelectionCenter.apply(this,arguments);var i=new t.Vector3;if(this._nodes[0].node.userData.boundingBox){this._nodes[0].node.userData.boundingBox.getCenter(i)}else{var n=new t.Box3;n.expandByObject(this._nodes[0].node);n.getCenter(i)}o.copy(i.applyMatrix4(this._nodes[0].node.matrixWorld))};s.prototype._updatePoiButtons=function(){this._tool.updateButtons()};s.prototype.render=function(){r(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");this._updatePoiButtons()};return s});