/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../measurements/Distance","../measurements/Utils","./MeasurementToolState","./MeasurementToolGizmo"],function(e,t,r,s){"use strict";var i=s.extend("sap.ui.vk.tools.DistanceMeasurementToolGizmo",{metadata:{library:"sap.ui.vk"}});var u=i.getMetadata().getParent().getClass().prototype;i.prototype.init=function(){if(u.init){u.init.call(this)}};i.prototype._updateCurrentFeature=function(e,t,r,s,i,u){var a=e==null?null:this._getMeshAnalyzer(e);var n=this._computeSphereRadius(t,r);var h=false;if(a!=null&&(s||i||u)){var l=a.intersectSphere(t,n,s,i,u,false,false);if(this._is2D){if(l.vertex!=null){if(this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],l.vertexId,a)){this._currentFeature.setValue(l.vertex);return true}}else if(l.edge!=null){if(this._replaceCurrentFeature(this._edgeFeatures[this._currentFeatureIndex],l.edgeId,a)){this._currentFeature.setValue(l.edge);return true}}else{this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],null,a);this._currentFeature.setValue(t);return true}}else{if(l.vertexId!=null){if(this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],l.vertexId,a)){this._currentFeature.setValue(a.getVertex(l.vertexId));return true}}else if(l.edgeId!=null){if(this._replaceCurrentFeature(this._edgeFeatures[this._currentFeatureIndex],l.edgeId,a)){this._currentFeature.setValue(a.buildEdgePath(l.edgeId,true));return true}}else if(l.faceId!=null){if(this._replaceCurrentFeature(this._faceFeatures[this._currentFeatureIndex],l.faceId,a)){this._currentFeature.setValue(a.buildFace(l.faceId));return true}}else{h=true}}}else{this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],null,a);this._currentFeature.setValue(t);return true}if(h&&this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null;return true}return false};i.prototype._updateMeasurement=function(e){var r=this._firstFeature;var s=this._currentFeature;var i=r&&(r.isEdge||r.isFace);var u=s&&(s.isEdge||s.isFace);var a=this._hoverPoint.worldPoint;var n=null;if(s&&s.isVertex){a=s.getValue()}if(i&&u){var h;if(r.isEdge){if(s.isEdge){h=t.findClosestPointEdgeToEdge(s.getValue(),r.getValue())}else{h=t.findClosestPointFaceToEdge(s.getValue(),r.getValue())}n=[h[3],h[4],h[5]];a[0]=h[0];a[1]=h[1];a[2]=h[2]}else{if(s.isEdge){h=t.findClosestPointFaceToEdge(r.getValue(),s.getValue())}else{h=t.findClosestPointFaceToFace(r.getValue(),s.getValue())}n=[h[0],h[1],h[2]];a[0]=h[3];a[1]=h[4];a[2]=h[5]}}else if(i){if(r.isEdge){n=t.findClosestPointEdgeToPoint(r.getValue(),a)}else{n=t.findClosestPointFaceToPoint(r.getValue(),a)}}else if(u){var l=e.getPoint1();if(s.isEdge){a=t.findClosestPointEdgeToPoint(s.getValue(),l)}else{a=t.findClosestPointFaceToPoint(s.getValue(),l)}}if(n){e.setPoint1(n)}e.setPoint2(a)};i.prototype.setHoverPoint=function(e){var t=this._hoverPoint&&this._hoverPoint.nodeRef;var s=e&&e.nodeRef;if(s!=t){var i=this._vsm;if(i!=null){var u=s!=null?[s]:[];var a=t!=null?[t]:[];i.setOutliningStates(u,a,false,true)}}this._hoverPoint=e;var n=this._state===r.SearchingSecondFeature?this._currentMeasurement:null;if(!e||e.worldPoint==null){if(n){n.setVisible(false);this._surface.update(this._viewport,this._viewport.getCamera())}if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}}else{var h=this._settings;var l=!e.shiftKey&&h.featureFace&&!this._is2D;var o=!e.shiftKey&&h.featureEdge;var c=!e.shiftKey&&h.featureVertex;var _=true;if(s||this._is2D){_=this._updateCurrentFeature(s,this._hoverPoint.worldPoint,this._viewport,l,o,c)}else if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}if(n&&_){this._updateMeasurement(n);n.setVisible(true)}this._surface.update(this._viewport,this._viewport.getCamera())}return this};i.prototype.fixPoint=function(t){var s=this._state;switch(s){case r.SearchingFirstFeature:if(!t.worldPoint){break}this._firstFeature=this._currentFeature;this._currentFeature=null;this.setCurrentFeatureIndex(1);this._state=r.SearchingSecondFeature;var i=t.worldPoint.slice();if(this._firstFeature&&this._firstFeature.isVertex){var u=this._firstFeature.getValue();i[0]=u[0];i[1]=u[1];i[2]=u[2]}var a=new e({point1:i,point2:i});this._surface.beginMeasurementConstruction(a);this._currentMeasurement=a;break;case r.SearchingSecondFeature:if(this._currentMeasurement.getDistance()<1e-5){break}this._currentMeasurement.setShowArrows(true);this._currentMeasurement.setFeatures([this._firstFeature,this._currentFeature]);this._surface.update(this._viewport,this._viewport.getCamera());this._state=r.SearchingFirstFeature;this._surface.removeFeature(this._currentFeature);this._surface.removeFeature(this._firstFeature);this._currentFeature=null;this._firstFeature=null;this.setCurrentFeatureIndex(0);var n=this._currentMeasurement;this._currentMeasurement=null;this._surface.endMeasurementConstruction(n);break;default:break}return this};i.prototype.escapePressed=function(){switch(this._state){case r.SearchingSecondFeature:this._state=r.SearchingFirstFeature;this._surface.removeFeature(this._firstFeature);if(this._currentFeature){this._surface.removeFeature(this._currentFeature)}this._firstFeature=this._currentFeature=null;this.setCurrentFeatureIndex(0);this._surface.cancelMeasurementConstruction(this._currentMeasurement);this._currentMeasurement=null;break;case r.SearchingFirstFeature:if(this._currentFeature!=null){this._surface.removeFeature(this._currentFeature)}this._firstFeature=this._currentFeature=null;this.setCurrentFeatureIndex(0);this._state=r.Off;this._tool.setActive(false,this._viewport);break;default:break}};i.prototype.is2D=function(){return this._is2D};return i});