/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./CreateParametricGizmo","../svg/Element","../svg/Path","sap/ui/events/KeyCodes"],function(t,e,i,s){"use strict";var o=t.extend("sap.ui.vk.tools.CreatePathToolGizmo",{metadata:{library:"sap.ui.vk"}});o.prototype.hasDomElement=function(){return false};o.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._activeElement=null;this.updateParentNode();this._onKeyPressListener=this._onKeyPress.bind(this);document.addEventListener("keydown",this._onKeyPressListener)};o.prototype.hide=function(){document.removeEventListener("keydown",this._onKeyPressListener);if(this._gizmo){this._gizmo.parent.remove(this._gizmo);this._gizmo=null}if(this._activeElement){this._finishPath(false)}this._viewport=null;this._tool=null;this._root=null};var n=4;var l=16;o.prototype._getDistance=function(t,e){return Math.sqrt(t*t+e*e)*this._viewport._camera.zoom};o.prototype._getGizmoSegments=function(t){var e=5/this._viewport._camera.zoom;return[{type:"move",points:[t.x-e,t.y]},{type:"line",points:[t.x+e,t.y]},{type:"move",points:[t.x,t.y-e]},{type:"line",points:[t.x,t.y+e]}]};o.prototype._addPoint=function(t,s,o){var h=this._activeElement;if(!h){this._activeElement=h=new i({subelement:true,material:this._tool._material,lineStyle:this._tool._lineStyle,fillStyle:null,segments:[{type:"move",points:[t.x,t.y]}]});if(h.stroke[3]===0){h.stroke.set([1,0,0,.5]);h.strokeDashArray=[5,5]}if(this._tool.getClosePath()){h.segments.push({type:"close"});h.setFillStyle(this._tool._fillStyle)}this._pointCount=2;this._canClosePath=false;this._gizmo=new i({subelement:true,lineStyle:{colour:"#000",width:2},segments:this._getGizmoSegments(t)});var a=new e({name:"Path"});a.add(h);a.add(this._gizmo);this._root.add(a)}else{var r=h.segments[0].points;if(this._pointCount>=r.length){r.push(t.x,t.y)}else{r[r.length-2]=t.x;r[r.length-1]=t.y}h.invalidate();if(s){if(o&&this._checkClosure(t)){return}if(this._getDistance(t.x-r[this._pointCount-2],t.y-r[this._pointCount-1])>=n){this._canClosePath=this._canClosePath||this._getDistance(t.x-r[0],t.y-r[1])>=l;this._pointCount=r.length;if(this._gizmo){this._gizmo.segments=this._getGizmoSegments(t);this._gizmo.invalidate()}}}}};o.prototype._checkClosure=function(t){var e=this._activeElement;if(e){var i=e.segments[0].points;if(this._getDistance(t.x-i[0],t.y-i[1])<l){if(this._canClosePath&&this._pointCount>=6){this._finishPath(true);return true}}}return false};o.prototype._finishPath=function(t){if(this._gizmo){this._gizmo.parent.remove(this._gizmo);this._gizmo=null}var e=this._activeElement;if(e){if(this._pointCount<4){e.parent.remove(e);this._activeElement=null;this._tool.fireCompleted({})}else{var i=e.segments[0].points;i.length=this._pointCount;e.setLineStyle(this._tool._lineStyle);if(t&&e.segments.length===1){e.segments.push({type:"close"});e.setFillStyle(this._tool._fillStyle)}e.invalidate();this._tool.fireCompleted({node:e.parent,request:this._createRequest(e.parent),closed:t})}this._activeElement=null}};o.prototype._onKeyPress=function(t){switch(t.keyCode){case s.ESCAPE:case s.ENTER:if(this._activeElement){this._finishPath(false)}break;default:break}};return o});