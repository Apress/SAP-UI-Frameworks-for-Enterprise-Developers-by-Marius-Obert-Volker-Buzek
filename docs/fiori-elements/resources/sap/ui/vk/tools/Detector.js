/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three"],function(e){"use strict";var t=function(){this._verticesMap=new Map;this._objArr=[];this._collidedUuids=new Set;this._sourceObjects=null;this._targetObjects=[];this._srcBoxHelper=null;this._sourceBox=new e.Box3;this._originPos=new e.Vector3;this._targetBoxHelper=[];this._targetBoxes=[];this._detectDistance=20;this._direction=new e.Vector3;this._isReady=false;this._finalDistance=null;this._finalSnaps=[];this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;this._detectType={move:this.detectMove.bind(this),scale:this.detectScale.bind(this),rotate:this.detectRotate.bind(this)}};t.prototype.isReady=function(){if(this._isReady&&this._sourceObjects){return true}else{return false}};t.prototype.setMoved=function(e){this._isMoved=e;this._intersectDistance=Number.NEGATIVE_INFINITY};t.prototype.getObjArray=function(){return this._objArr};t.prototype.addObjFromScene=function(e){var t=e._scene.getSceneRef();var i=e._viewStateManager;this._objArr.length=0;this._verticesMap.clear();t.traverse(function(e){if(e.isMesh){if(!this._objArr.find(function(t){return t.uuid===e.uuid})){this._objArr.push(e);var t=this.getVertices(e.geometry,e.userData.renderGroup);this._verticesMap.set(e.uuid,t)}}}.bind(this));this.setSource(i,e);this._isReady=true};t.prototype.setSource=function(t,i){var s=[];t.enumerateSelection(function(e){s.push(e)});if(s.length>0){var o=s.pop();if(this._isReady){t.setSelectionStates(o,s,false,true)}if(o.children.length===0){this._isGroup=false;this._sourceObjects=o}else{this._isGroup=true;var r=[];o.traverse(function(e){if(e.type==="Mesh"){r.push(e)}});this._sourceObjects=r[0]}this._srcBoxHelper=new e.BoxHelper(this._sourceObjects);this._srcBoxHelper.update();this._sourceBox.setFromObject(this._srcBoxHelper);this._sourceSize=this._sourceBox.getSize(new e.Vector3);this._calculateInitialDetectDistance(i)}else{this._isReady=false;this._sourceObjects=null;this._sourceBox=new e.Box3}this.setTarget()};t.prototype._calculateInitialDetectDistance=function(t){if(t){var i=new e.Vector3;var s=new e.Vector3;var o=t.getRenderer().getSize(new e.Vector2);i.set(0/o.x*2-1,-(0/o.y)*2+1,.5);var r=t.getCamera().getCameraRef();i.unproject(r);i.sub(r.position).normalize();var n=-r.position.z/i.z;s.copy(r.position).add(i.multiplyScalar(n));var a=new e.Vector3;i.set(o.x/o.x*2-1,-(0/o.y)*2+1,.5);i.unproject(r);i.sub(r.position).normalize();n=-r.position.z/i.z;a.copy(r.position).add(i.multiplyScalar(n));var c=s.distanceTo(a);this._detectDistance=Math.abs(c)*.05}};t.prototype.setTarget=function(){this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._collidedUuids.clear();this._isMoved=false;if(this._sourceObjects){this._sourceObjects.geometry.computeBoundingSphere();this._originPos=new e.Vector3;this._targetObjects=this._objArr.filter(function(e){return e.uuid!==this._sourceObjects.uuid}.bind(this));this._targetBoxes.length=0;this._targetBoxHelper.length=0;this._targetObjects.forEach(function(t){var i=new e.BoxHelper(t);this._targetBoxHelper.push(i);i.update();var s=new e.Box3;s.setFromObject(t);this._targetBoxes.push(s)}.bind(this))}else{this._targetObjects.length=0;this._targetBoxes.length=0;this._targetBoxHelper.length=0}};t.prototype.updateTargetBox=function(){this._targetBoxHelper.forEach(function(e,t){e.update();this._targetBoxes[t].setFromObject(e)}.bind(this))};t.prototype.getVertices=function(t,i){var s,o,r=[];if(t.isGeometry){r=t.vertices}else if(t.isBufferGeometry){var n=t.attributes.position;if(n!==undefined){var a=new e.Vector3;r=[];var c={};var l="";for(s=i?i.firstVertex:0,o=i?i.lastVertex:n.count;s<o;s++){a.fromBufferAttribute(n,s);l=JSON.stringify(a);if(!c[l]){r.push(a.clone());c[l]=true}}}}return r};t.prototype.findClosestVertex=function(e,t,i){var s=this._verticesMap.get(i.uuid);if(s.length===0){return null}var o,r=null,n=i.worldToLocal(e.clone());for(var a=0,c=s.length;a<c;a++){o=s[a].distanceTo(n);if(o>t){continue}t=o;r=s[a]}if(r===null){return null}return i.localToWorld(r.clone())};t.prototype.findClosestSnap=function(e,t,i){var s=2;var o;while(!o){o=this.findClosestVertex(e,t,i);t*=s}return o};t.prototype.intersectDetect=function(e){var t=new Map;var i=this._sourceBox.clone().expandByScalar(this._detectDistance);e.forEach(function(e){var s=this._targetObjects.findIndex(function(t){return t.uuid===e.object.uuid});if(!this._collidedUuids.has(e.object.uuid)&&s!==-1&&this._targetBoxes&&this._targetBoxes[s].intersectsBox(i)){var o=this.findClosestSnap(this._originPos,this._detectDistance,this._targetObjects[s]);t.set(o,this._targetObjects[s]);if(this._targetBoxes[s].intersectsBox(this._sourceBox)&&this._intersectDistance<this._finalDistance){if(this.detectCollisionGJK(this._sourceObjects,this._targetObjects[s])){this._collidedUuid=e.object.uuid;this._intersectDistance=this._finalDistance}}}}.bind(this));return t};t.prototype.getFinalSnaps=function(e){var t=[];if(e.length>0){var i=this.intersectDetect(e);if(i.size!==0){var s=Array.from(i.keys());var o=s[0];var r=o.distanceTo(this._originPos);for(var n=1;n<s.length;++n){var a=s[n];var c=a.distanceTo(this._originPos);if(c<r){o=a;r=c}}var l=i.get(o);var h=this._originPos.distanceTo(o);var u,_;u=this.findClosestSnap(o,h,this._sourceObjects);var d=u.distanceTo(o);_=this.findClosestSnap(u,d,l);t=[u,_]}}return t};t.prototype.snapMove=function(){var e=this._op;if(this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){e.gizmo._tool._handler._gesture=false;e.gizmo._moveDelta.add(this._direction.clone().multiplyScalar(.1));e.gizmo._move(e.gizmo._moveDelta)}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;e.viewport.setShouldRenderFrame()}this.detect()}};t.prototype.snapScale=function(){var t=this._op;if(!t.gizmo._scaleDelta.equals(new e.Vector3(1,1,1))&&this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){t.gizmo._tool._handler._gesture=false;var i=t.gizmo._scaleDelta.toArray();i.forEach(function(e,i){if(e>1){t.gizmo._scaleDelta.setComponent(i,e*1.01)}});t.gizmo._scale(t.gizmo._scaleDelta)}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;t.viewport.setShouldRenderFrame()}this.detect()}else if(Math.abs(this._finalDistance-this._intersectDistance)<=.1){this._collidedUuids.add(this._collidedUuid)}};t.prototype.snapRotate=function(){var e=this._op;if(this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){e.gizmo._tool._handler._gesture=false;e.angle2+=.02*(e.angle2-e.angle1)/Math.abs(e.angle2-e.angle1);e.gizmo._setRotationAxisAngle(e.handleIndex,e.angle1,e.angle2)}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;e.viewport.setShouldRenderFrame()}this.detect()}};t.prototype._calculateDetectDistance=function(){var e=this._sourceSize;var t="";var i=0;if(Math.abs(this._direction.x)===1){t="x"}else if(Math.abs(this._direction.y)===1){t="y"}else if(Math.abs(this._direction.z)===1){t="z"}var s=e[t]/2;if(s){i=this._detectDistance+s}return i};t.prototype.detectMove=function(){this._direction.copy(this._op.gizmo._moveDelta).normalize();var t=this._calculateDetectDistance();var s=new e.Raycaster(this._originPos,this._direction,0,t);this._snapAction=i(this.snapMove,1e3/60).bind(this);return s.intersectObjects(this._targetObjects,false)};t.prototype.detectScale=function(){if(this._op.gizmo._scaleDelta.toArray().find(function(e){return e<=1})){this._op.gizmo._tool._handler._gesture=true;this._collidedUuids.forEach(function(e){var t=this._targetObjects.find(function(t){return t.uuid===e});if(t&&!this.detectCollisionGJK(this._sourceObjects,t)){this._collidedUuids.delete(e)}}.bind(this))}this._gizmoPos=new e.Vector3;this._op.gizmo._gizmo.getWorldPosition(this._gizmoPos);var t=new e.Vector3;this._sourceObjects.getWorldPosition(t);var s=this._sourceObjects.userData.renderGroup;var o=s&&s.boundingSphere?e.Sphere.newFromPackedArray(s.boundingSphere):this._sourceObjects.geometry.boundingSphere.clone();var r=o.applyMatrix4(this._sourceObjects.matrixWorld).radius;var n=new e.Sphere(t,r+this._detectDistance);var a=[];this._targetBoxes.forEach(function(e,t){if(e.intersectsSphere(n)){a.push({object:this._targetObjects[t]})}}.bind(this));this._snapAction=i(this.snapScale,1e3/60).bind(this);return a};t.prototype.detectRotate=function(){this._gizmoPos=new e.Vector3;this._op.gizmo._gizmo.getWorldPosition(this._gizmoPos);var t=new e.Vector3;var s=new e.Vector3;var o=new e.Raycaster(this._originPos,this._direction,0,this._detectDistance);this._sourceObjects.getWorldPosition(s);this._radius=this._gizmoPos.distanceTo(s);var r=this._op.handleIndex;this._axis=(new e.Vector3).setFromMatrixColumn(this._op.gizmo._matOrigin,r).normalize();this._axis.transformDirection(this._op.gizmo._gizmo.matrixWorld);if(this._radius>.01){t.subVectors(s,this._gizmoPos).normalize();this._detectDistance=this._radius;this._direction.crossVectors(t,this._axis).normalize()}else if(this._finalSnaps.length===2){t.subVectors(this._finalSnaps[0],this._gizmoPos).normalize();this._direction.crossVectors(t,this._axis).normalize()}if(this._op.gizmo._rotationDelta.getComponent(r)>0){this._direction.negate()}var n=new e.Plane(this._axis);var a=[],c=[];var l,h=0;if(this._radius<.01){var u=this._sourceObjects.userData.renderGroup;var _=u&&u.boundingSphere?e.Sphere.newFromPackedArray(u.boundingSphere):this._sourceObjects.geometry.boundingSphere.clone();h=_.applyMatrix4(this._sourceObjects.matrixWorld).radius;l=new e.Sphere(this._gizmoPos,h);this._targetBoxes.forEach(function(e,t){if(e.intersectsSphere(l)&&e.intersectsPlane(n)){a.push({object:this._targetObjects[t]})}}.bind(this))}else{l=new e.Sphere(this._gizmoPos,this._radius);this._targetBoxes.forEach(function(e,t){if(e.intersectsSphere(l)&&e.intersectsPlane(n)){c.push(this._targetObjects[t])}}.bind(this));a=o.intersectObjects(c,false)}this._snapAction=i(this.snapRotate,1e3/60).bind(this);return a};t.prototype.detect=function(t){var i=this._op=t||this._op;if(!this.isReady()||!this._verticesMap.has(this._sourceObjects.uuid)){this.addObjFromScene(i.viewport)}else{this._srcBoxHelper.update();this._sourceBox.setFromObject(this._sourceObjects);this._sourceBox.getCenter(this._originPos);this.updateTargetBox();var s=this._detectType[i.detectType]();this._finalSnaps=this.getFinalSnaps(s);if(this._finalSnaps.length===2){var o=new e.Vector3;o.subVectors(this._finalSnaps[1],this._finalSnaps[0]);this._finalDistance=o.length();if(this._finalDistance){this._snapAction()}}}};function i(e,t){var i;return function(){var s=this,o=arguments;clearTimeout(i);i=setTimeout(function(){i=null;e.apply(s,o)},t)}}t.prototype.detectCollisionGJK=function(t,i){var s=64;var o=this;function r(t,i){var r=[new e.Vector3,new e.Vector3,new e.Vector3];var n=2;var a=o._direction;r[1]=d(t,i,a);if(r[1].dot(a)<0){return false}a=r[1].clone().negate();r[0]=d(t,i,a);if(r[0].dot(a)<0){return false}var c=r[1].clone().sub(r[0]);var l=r[0].clone().negate();a=c.clone().cross(l).cross(c);var h=function(e,t,i,s,o,c,l){if(i.clone().cross(c).dot(t)>0){r[1]=r[0];r[0]=e.clone();a=i.clone().cross(t).cross(i);n=2}else{r[2]=r[1];r[1]=r[0];r[0]=e.clone();a=c.clone()}};var u=function(e,t,i,s,o,c,l){if(c.clone().cross(s).dot(t)>0){r[0]=e.clone();a=s.clone().cross(t).cross(s);n=2}else{h(e,t,i,s,o,c,l)}};var _=function(e,t,i,s,o,n,a){if(n.clone().cross(s).dot(t)>0){r[0]=r[1];r[1]=r[2].clone();i=s;s=o.clone();n=a.clone();u(e,t,i,s,o,n,a)}else{h(e,t,i,s,o,n,a)}};function d(e,t,i){var s=i.clone().normalize();var o=f(e,s);var r=f(t,s.negate());return o.clone().sub(r)}function f(e,t){var i=o._verticesMap.get(e.uuid);var s=e.localToWorld(i[0].clone());var r=s.dot(t);for(var n=1;n<i.length;++n){var a=e.localToWorld(i[n].clone());var c=a.dot(t);if(c>r){s=a;r=c}}return s}for(var p=0;p<s;++p){var g=d(t,i,a);if(g.dot(a)<0){return false}var v,b,m,y,x;if(n===2){v=g.clone().negate();b=r[0].clone().sub(g);m=r[1].clone().sub(g);x=b.clone().cross(m);var j=b.clone().cross(x);if(j.dot(v)>0){r[1]=r[0];r[0]=g.clone();a=b.clone().cross(v).cross(b);continue}var D=x.clone().cross(m);if(D.dot(v)>0){r[0]=g.clone();a=m.clone().cross(v).cross(m);continue}if(x.dot(v)>0){r[2]=r[1];r[1]=r[0];r[0]=g.clone();a=x.clone()}else{r[2]=r[0];r[0]=g.clone();a=x.clone().negate()}n=3;continue}v=g.clone().negate();b=r[0].clone().sub(g);m=r[1].clone().sub(g);y=r[2].clone().sub(g);x=b.clone().cross(m);var S=m.clone().cross(y);var z=y.clone().cross(b);var O=1;var w=2;var B=4;var V=(x.dot(v)>0?O:0)|(S.dot(v)>0?w:0)|(z.dot(v)>0?B:0);if(V===0){return true}if(V===O){u(g,v,b,m,y,x,S)}else if(V===w){r[0]=r[1];r[1]=r[2].clone();b=m;m=y.clone();x=S.clone();u(g,v,b,m,y,x,S)}else if(V===B){r[1]=r[0];r[0]=r[2].clone();m=b;b=y.clone();x=z.clone();u(g,v,b,m,y,x,S)}else if(V===O||w){_(g,v,b,m,y,x,S)}else if(V===w||B){c=r[0];r[0]=r[1];r[1]=r[2];r[2]=c;c=b;b=m;m=y;y=c;x=S;S=z.clone();_(g,v,b,m,y,x,S)}else if(V===B||O){c=r[1];r[1]=r[0];r[0]=r[2];r[2]=c;c=m;m=b;b=y;y=c;S=x;x=z.clone();_(g,v,b,m,y,x,S)}else{return true}}return true}var n=performance.now();var a=r(t,i);if(a){console.log("Collide (ms): ",performance.now()-n);return true}else{console.log("Not Collide (ms): ",performance.now()-n);return false}};return t});