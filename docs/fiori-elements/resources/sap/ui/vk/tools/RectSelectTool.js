/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./RectSelectToolHandler","../SelectionDisplayMode","../Loco","../thirdparty/three"],function(e,t,i,r,a){"use strict";var s=e.extend("sap.ui.vk.tools.RectSelectTool",{metadata:{library:"sap.ui.vk",properties:{subtractMode:{type:"boolean",defaultValue:false}}},constructor:function(i,r){if(s._instance){return s._instance}e.apply(this,arguments);this._viewport=null;this._handler=new t(this);this._loco=null;s._instance=this}});s.prototype.init=function(){if(e.prototype.init){e.prototype.init.call(this)}this.setFootprint(["sap.ui.vk.dvl.Viewport","sap.ui.vk.threejs.Viewport","sap.ui.vk.svg.Viewport"])};s.prototype.setActive=function(t,i,r){e.prototype.setActive.call(this,t,i,r);if(this._viewport){if(t){if(this._prepare()){this._handler.activate(this._viewport)}}else{this._handler.deactivate()}}return this};s.prototype._prepare=function(){if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){return true}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")&&this._viewport._scene&&this._viewport._scene.getSceneRef()){return true}else if(this.isViewportType("sap.ui.vk.svg.Viewport")&&this._viewport._scene){return true}else{return false}};s.prototype.queueCommand=function(e){if(this._prepare()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")||this.isViewportType("sap.ui.vk.svg.Viewport")){e()}}return this};function n(e,t,i){var r=e.elements;var s=r[15]===1;var n=2/r[0];var o=2/r[5];var l,p;if(s){l=-r[12]*n;p=-r[13]*o}else{l=r[8]*n;p=r[9]*o}var u=(n+l)*.5;var c=l-u;var v=(o+p)*.5;var f=p-v;var h=a.MathUtils.lerp(c,u,Math.min(t.x1,t.x2)/i.width);var d=a.MathUtils.lerp(c,u,Math.max(t.x1,t.x2)/i.width);var g=a.MathUtils.lerp(v,f,Math.min(t.y1,t.y2)/i.height);var S=a.MathUtils.lerp(v,f,Math.max(t.y1,t.y2)/i.height);r[0]=2/(d-h);r[5]=2/(g-S);if(s){r[12]=-(d+h)/(d-h);r[13]=-(g+S)/(g-S)}else{r[8]=(d+h)/(d-h);r[9]=(g+S)/(g-S)}}s.prototype.select=function(e,t,i,r,a,s){if(!this._prepare()){return[]}return this._select(e,t,i,r,this._viewport,a,s)};s.prototype._select=function(e,t,r,s,o,l,p){var u=[];var c=o.getMetadata().getName();if(c==="sap.ui.vk.svg.Viewport"){if(e===r||t===s){return u}u=o._select({x1:e,y1:t,x2:r,y2:s});if(u.length>0){o.fireNodesPicked({picked:u});if(o.getSelectionDisplayMode()===i.Outline){if(this.getSubtractMode()){o._viewStateManager.setOutliningStates([],u)}else{o._viewStateManager.setOutliningStates(u,[])}}else if(this.getSubtractMode()){o._viewStateManager.setSelectionStates([],u)}else{o._viewStateManager.setSelectionStates(u,[])}}return u}if(c==="sap.ui.vk.dvl.Viewport"){u=o.rectSelect(e,t,r,s);if(u.length>0){var v={picked:u};o.fireNodesPicked(v);if(o.getSelectionDisplayMode()===i.Outline){if(this.getSubtractMode()){o._viewStateManager.setOutliningStates([],u)}else{o._viewStateManager.setOutliningStates(u,[])}}else if(this.getSubtractMode()){o._viewStateManager.setSelectionStates([],u)}else{o._viewStateManager.setSelectionStates(u,[])}}return u}if(c!=="sap.ui.vk.threejs.Viewport"){return u}var f=l?l.getSceneRef():undefined;var h=p?p.getCameraRef():undefined;var d=o._getViewStateManagerThreeJS();if(!h||!f||!d||e===r||t===s){return u}var g={x1:e,y1:t,x2:r,y2:s};var S=h.projectionMatrix.clone();n(S,g,o._renderer.getSize(new a.Vector2));var w=(new a.Matrix4).multiplyMatrices(S,h.matrixWorldInverse);var y=(new a.Frustum).setFromProjectionMatrix(w);var _=new a.Vector3;function M(e){var t=e.geometry;if(t!==undefined&&y.intersectsObject(e)){var i,r=0;if(t.isGeometry){var a=t.vertices;for(i=0,r=a.length;i<r;i++){_.copy(a[i]).applyMatrix4(e.matrixWorld);if(!y.containsPoint(_)){break}}}else if(t.isBufferGeometry){var s=t.attributes.position;if(s!==undefined){var n=e.userData.renderGroup;for(i=n?n.firstVertex:0,r=n?n.lastVertex:s.count;i<r;i++){_.fromBufferAttribute(s,i).applyMatrix4(e.matrixWorld);if(!y.containsPoint(_)){break}}}}return r>0&&i===r}return false}function k(e,t,i){if(!e.visible||e.userData.selectable===false){return}var r=i||e.userData.skipIt?t:{totalCount:0,passedCount:0};if(r&&e.geometry!==undefined){r.totalCount++;if(M(e)){r.passedCount++}}var a=e.children;for(var s=0,n=a.length;s<n;s++){k(a[s],r,i||e.userData.closed)}if(r!==t&&r.passedCount>0&&r.totalCount===r.passedCount){u.push(e)}}k(f);if(u.length>0){var V={picked:u};o.fireNodesPicked(V);if(o.getSelectionDisplayMode()===i.Outline){if(this.getSubtractMode()){d.setOutliningStates([],u)}else{d.setOutliningStates(u,[])}}else if(this.getSubtractMode()){d.setSelectionStates([],u)}else{d.setSelectionStates(u,[])}}return u};return s});