/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","../thirdparty/BufferGeometryUtils","./Gizmo","./AxisColours","./ExplodeAxis","./ExplodeDirection","./ExplodeType","../AnimationTrackType","sap/base/assert","sap/base/Log","sap/ui/core/Core"],function(t,e,i,o,r,a,s,n,h,u,d,l){"use strict";var c=o.extend("sap.ui.vk.tools.ExplodeToolGizmo",{metadata:{library:"sap.ui.vk"}});var p=96;var _=48;var m={PositiveX:0,PositiveY:1,PositiveZ:2,NegativeX:3,NegativeY:4,NegativeZ:5,ResetAdjustment:6,AdjustUp:7,AdjustDown:8,MoveUp:9,MoveDown:10};c.prototype.init=function(){if(o.prototype.init){o.prototype.init.apply(this)}this._createEditingForm(t().getText("TOOL_UNITS_MM"),84);this._moveDelta=new e.Vector3;this._anchorPosition=new e.Vector3;this._axisDirection=new e.Vector3;this._axisColor=0;this._magnitude=0;this._viewport=null;this._tool=null;this._groups=[];this._nodes=[];this._groupsMap=new Map;this._sceneGizmo=new e.Scene;var a=new e.AmbientLight(16777215,.5);a.layers.enableAll();this._sceneGizmo.add(a);var s=new e.DirectionalLight(16777215,.5);s.position.set(1,3,2);s.layers.enableAll();this._sceneGizmo.add(s);this._gizmo=new e.Group;this._touchAreas=new e.Group;this._touchAreas2=new e.Group;this._sceneGizmo.add(this._gizmo);this._matViewProj=new e.Matrix4;var n=new e.MeshLambertMaterial({color:33023,transparent:true,opacity:.2});function h(t,o,r,a){var s=1,n=4,h=24;var u=new e.MeshLambertMaterial({color:r});var d=new e.CylinderGeometry(s,s,t-h,4);var l=new e.Vector3(o.y,o.z,o.x);var c=new e.Vector3(o.z,o.x,o.y);var p=o.x<0||o.y<0||o.z<0?(new e.Matrix4).makeBasis(c,o,l):(new e.Matrix4).makeBasis(l,o,c);p.setPosition(o.clone().multiplyScalar((t-h)*.5));d.applyMatrix4(p);var m=new e.Mesh(d,u);m.matrixAutoUpdate=false;m.userData.color=r;var g=new e.CylinderGeometry(0,n,h,12,1);p.setPosition(o.clone().multiplyScalar(t-h*.5));g.applyMatrix4(p);var f=new e.Mesh(g,u);f.matrixAutoUpdate=false;m.add(f);if(a){var v=new e.CylinderGeometry(_*.5,_*.5,t-_+h*.5,12,1);p.setPosition(o.clone().multiplyScalar(_+v.parameters.height*.5));v.applyMatrix4(p);var x=new e.CylinderGeometry(_*.5,0,_,12,1);p.setPosition(o.clone().multiplyScalar(_*.5));x.applyMatrix4(p);var y=i.mergeBufferGeometries([v,x]);a.add(new e.Mesh(y,u))}return m}this._gizmo.add(h(p,new e.Vector3(1,0,0),r.x,this._touchAreas));this._gizmo.add(h(p,new e.Vector3(0,1,0),r.y,this._touchAreas));this._gizmo.add(h(p,new e.Vector3(0,0,1),r.z,this._touchAreas));this._gizmo.add(h(p,new e.Vector3(-1,0,0),r.x,this._touchAreas));this._gizmo.add(h(p,new e.Vector3(0,-1,0),r.y,this._touchAreas));this._gizmo.add(h(p,new e.Vector3(0,0,-1),r.z,this._touchAreas));this._axisTitles=this._createAxisTitles(undefined,undefined,false,true);this._sceneGizmo.add(this._axisTitles);var u=32;var d=u*1.75;this._groupGizmo=new e.Group;this._sceneGizmo.add(this._groupGizmo);var l=new e.Mesh(new e.IcosahedronGeometry(8,1),new e.MeshLambertMaterial);this._groupGizmo.add(l);this._groupGizmo.add(h(u*1.5,new e.Vector3(0,1,0),16777215));this._groupGizmo.add(h(u*1.5,new e.Vector3(0,-1,0),16777215));var c=16;var m=i.mergeBufferGeometries([new e.CylinderGeometry(0,6,c,16).applyMatrix4((new e.Matrix4).setPosition(0,d+c*.5,0)),new e.CylinderGeometry(0,6,c,16).applyMatrix4((new e.Matrix4).setPosition(0,d+c*1.5,0))]);this._groupGizmo.add(new e.Mesh(m,new e.MeshLambertMaterial));this._groupGizmo.add(new e.Mesh(m.clone().rotateX(Math.PI),new e.MeshLambertMaterial));this._groupGizmo.add(new e.Mesh(new e.CylinderGeometry(16,16,u*6,12,1),new e.MeshBasicMaterial({color:16777215,transparent:true,opacity:.5,side:e.BackSide})));function g(t,i,o){var r=new e.IcosahedronGeometry(_*.5,1);r.applyMatrix4((new e.Matrix4).setPosition(0,(t+i)*.5,0));o.add(new e.Mesh(r,n))}g(u*-.5,u*.5,this._touchAreas2);g(u*.5,u*1.5,this._touchAreas2);g(u*-1.5,u*-.5,this._touchAreas2);g(d,d+u,this._touchAreas2);g(-d-u,-d,this._touchAreas2);function f(t){t.traverse(function(t){t.layers.enableAll()})}function v(t){t.children.forEach(function(t,e){t.traverse(function(t){t.layers.enable(Math.min(e,6)+1)})})}v(this._gizmo);v(this._axisTitles);v(this._touchAreas);f(this._groupGizmo);f(this._touchAreas2)};c.prototype.hasDomElement=function(){return false};c.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._nodes.length=0;this._handleGroupsChanged()};c.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._updateEditingForm(false)};c.prototype.getGizmoCount=function(){if(!this._groups.length){return 0}return this._getActiveAxisIndex()>=0&&this._magnitude>0&&this._getSelectedItem()?2:1};c.prototype.getTouchObject=function(t){if(t===0){this._updateGizmoObjectTransformation(this._touchAreas);return this._touchAreas}else{this._updateGroupGizmoTransformation(this._touchAreas2);return this._touchAreas2}};c.prototype._handleGroupsChanged=function(t){this._setMagnitude(0);var i=this._groupsMap;i.clear();this._groups=this._tool.getItems().slice();var o=this._nodes=[];this._groups.forEach(function(t){var r=t.getItems();for(var a=0;a<r.length;a++){var s=r[a].getNodeRef();i.set(s,t);var n=new e.Box3;s._expandBoundingBox(n,false,true,true);o.push({node:s,center:n.getCenter(new e.Vector3),group:t,local:(new e.Vector3).setFromMatrixPosition(s.matrix),origin:(new e.Vector3).setFromMatrixPosition(s.matrixWorld),matParentInv:s.parent?(new e.Matrix4).copy(s.parent.matrixWorld).invert():new e.Matrix4})}});this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude())};c.prototype._getSelectedItem=function(){return l.byId(this._tool.getSelectedItem())};c.prototype._handleSelectedItemChanged=function(){var t=this._viewport._viewStateManager;var e=new Set;var i=this._getSelectedItem();if(i){i.getItems().forEach(function(t){e.add(t.getNodeRef())})}var o=[];t.enumerateOutlinedNodes(function(t){if(!e.has(t)){o.push(t)}});t.setOutliningStates(Array.from(e),o,false)};c.prototype.highlightHandle=function(t,e){this._handleIndex=t;this._gizmo.children.forEach(function(e,i){var o=t===i;var r=o?16776960:e.userData.color;e.material.color.setHex(r);this._axisTitles.children[i].material.color.setHex(r)}.bind(this));for(var i=0;i<5;i++){this._groupGizmo.children[i].material.color.setHex(i+6===t?16776960:this._axisColor)}};c.prototype._calculateGroupOffsets=function(){var t=this._axisDirection;if(this._tool.getType()===n.Linear){var i=new e.Vector3(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z));var o=new e.Vector3;var r=0,a=0;this._groups.forEach(function(t,e){var s=t.getBoundingBox();s.getCenter(t._center);s.getSize(o);r=i.dot(o);if(e>0){a+=r*.5}t._offset=a;t._deltaOffset=r*.5;a+=r*.5});a+=r*.5;var s=a>0?1/a:1;this._groups.forEach(function(t){t._offset=1-t._offset*s;t._deltaOffset*=s})}else{var h=1/this._groups.length;this._groups.forEach(function(t,i){var o=t.getBoundingBox();o.getCenter(t._center);t._offset=1-i*h;t._deltaOffset=h*.5;var r=-1;var a=new e.Vector3;var s=t.getItems();for(var n=0;n<s.length;n++){var u=s[n].getNodeRef();var d=new e.Box3;u._expandBoundingBox(d,false,true,true);var l=d.getSize(new e.Vector3).manhattanLength();if(r<l){r=l;d.getCenter(a)}}})}};c.prototype._getActiveAxisIndex=function(){var t=this._tool.getAxis();var e=this._tool.getDirection();var i=t&&e?[a.X,a.Y,a.Z].indexOf(t):-1;if(i>=0&&e===s.Negative){i+=3}return i};c.prototype._recalculateOffsets=function(){this._setMagnitude(0);this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude());this._viewport.setShouldRenderFrame()};c.prototype._updateAxis=function(){var t=this._getActiveAxisIndex();if(t>=0){this._updateGizmoObjectTransformation(this._gizmo);this._axisDirection.setFromMatrixColumn(this._gizmo.matrixWorld,t%3).normalize().multiplyScalar(t<3?1:-1);this._anchorPosition.setFromMatrixPosition(this._gizmo.matrixWorld);this._axisColor=this._gizmo.children[t].userData.color;for(var e=0;e<5;e++){this._groupGizmo.children[e].material.color.setHex(this._axisColor)}this._recalculateOffsets()}else{this._setMagnitude(0);this._viewport.setShouldRenderFrame()}};c.prototype._moveSelectedGroup=function(t){var e=this._tool;var i=this._getSelectedItem();var o=e.getItems();var r=o.indexOf(i);if(r>=0&&r+t>=0&&r+t<o.length){e.removeItem(i);e.insertItem(i,r+t);e.fireItemSequenceChangePressed({item:i,moveUp:t<0})}};c.prototype._setMagnitudeAdjustmentMultiplier=function(t,e){var i=this._getSelectedItem();if(i){i.setMagnitudeAdjustmentMultiplier(t);this._updatePositions();this._tool[e?"fireItemPositionAdjusted":"fireItemPositionAdjusting"]({item:i,magnitudeAdjustmentMultiplier:i.getMagnitudeAdjustmentMultiplier()})}};c.prototype._beginGesture=function(){this._moveDelta.setScalar(0);this._beginMagnitude=this._magnitude;var t=this._tool;switch(this._handleIndex){case m.ResetAdjustment:this._setMagnitudeAdjustmentMultiplier(0,true);break;case m.AdjustUp:case m.AdjustDown:var e=this._getSelectedItem();this._magnitudeAdjustmentMultiplier=e?e.getMagnitudeAdjustmentMultiplier():0;break;case m.MoveUp:this._moveSelectedGroup(-1);break;case m.MoveDown:this._moveSelectedGroup(+1);break;default:if(this._handleIndex<6&&(!t.getAxis()||!t.getDirection())){t.setAxis([a.X,a.Y,a.Z][this._handleIndex%3]);t.setDirection(this._handleIndex<3?s.Positive:s.Negative);t.fireAxisSelected({axis:t.getAxis(),direction:t.getDirection()})}break}};c.prototype._setMagnitude=function(t){this._magnitude=t;this._groups.forEach(function(e){e._magnitude=t});this._updatePositions()};c.prototype._setOffset=function(t){var e=this._tool;if(this._handleIndex<6){e.setMagnitude(this._beginMagnitude+t);e.fireMagnitudeChanging({type:e.getType(),axis:e.getAxis(),direction:e.getDirection(),magnitude:e.getMagnitude()})}else if(this._handleIndex===m.AdjustUp||this._handleIndex===m.AdjustDown){var i=this._magnitude>0?this._getSelectedItem():null;if(i){this._setMagnitudeAdjustmentMultiplier(this._magnitudeAdjustmentMultiplier+t/(this._magnitude*i._deltaOffset))}}};c.prototype._updatePositions=function(){var t=this._tool.getType()===n.Linear;var i=new e.Vector3;var o=new e.Vector3;var r=new e.Vector3;this._nodes.forEach(function(e){var a=e.node;if(t){o.copy(this._axisDirection)}else{o.copy(e.center).sub(this._anchorPosition);r.copy(this._axisDirection).multiplyScalar(o.dot(r));o.sub(r).normalize()}o.multiplyScalar(e.group.getMagnitude());i.copy(e.origin).add(o);a.matrixWorld.setPosition(i);a.matrix.multiplyMatrices(e.matParentInv,a.matrixWorld);a.position.setFromMatrixPosition(a.matrix);a.updateMatrixWorld(true);if(a.parent!==this._getEffectiveParent(a)){this._viewport._viewStateManager._setJointNodeOffsets(a,h.Translate)}}.bind(this));this._viewport.setShouldRenderFrame()};c.prototype._endGesture=function(){var t=this._tool;if(this._handleIndex<6){t.fireMagnitudeChanged({type:t.getType(),axis:t.getAxis(),direction:t.getDirection(),magnitude:t.getMagnitude()})}else if(this._handleIndex===m.AdjustUp||this._handleIndex===m.AdjustDown){var e=this._magnitude>0?this._getSelectedItem():null;if(e){t.fireItemPositionAdjusted({item:e,magnitudeAdjustmentMultiplier:e.getMagnitudeAdjustmentMultiplier()})}}};c.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};c.prototype._updateGizmoObjectTransformation=function(t){t.matrix.fromArray(this._tool.getAnchor());t.matrix.decompose(t.position,t.quaternion,t.scale);var e=this._getGizmoScale(t.position);t.scale.setScalar(e);t.matrixAutoUpdate=true;t.updateMatrixWorld(true);return e};c.prototype._updateGroupGizmoTransformation=function(t){var i=this._getActiveAxisIndex();var o=i>=0&&this._magnitude>0?this._getSelectedItem():null;t.visible=!!o;if(o){if(this._tool.getType()===n.Linear){t.position.copy(this._axisDirection).multiplyScalar(o.getMagnitude()).add(o._center)}else{t.position.copy(o._center)}t.quaternion.setFromUnitVectors(new e.Vector3(0,1,0),this._axisDirection);t.scale.setScalar(this._getGizmoScale(t.position));t.updateMatrix();t.updateMatrixWorld()}};c.prototype._updateGizmoTransformation=function(t,e){this._updateGizmoObjectTransformation(this._gizmo)};c.prototype._getCameraLayersMask=function(){var t=0|0;var e=this._getActiveAxisIndex();t=1<<e+1;if(e>=0&&this._magnitude>0&&this._getSelectedItem()){t|=1<<7}return t};c.prototype.render=function(){u(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._tool&&this._groups.length>0){var t=this._viewport.getRenderer(),e=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);t.clearDepth();var i=this._updateGizmoObjectTransformation(this._gizmo);this._updateAxisTitles(this._axisTitles,this._gizmo,e,p+18,i);this._updateGroupGizmoTransformation(this._groupGizmo);var o=e.layers.mask;e.layers.mask=this._getCameraLayersMask();t.render(this._sceneGizmo,e);e.layers.mask=o}};return c});