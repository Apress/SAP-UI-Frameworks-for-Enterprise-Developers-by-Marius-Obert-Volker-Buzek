/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","../thirdparty/three","./PoiToolHandler","./PoiToolGizmo","../threejs/PoiHelper","./ToolNodeSet","../NodeContentType"],function(t,e,i,o,s,n,a){"use strict";var r=t.extend("sap.ui.vk.tools.PoiManipulationTool",{metadata:{library:"sap.ui.vk",properties:{nodeSet:{type:"sap.ui.vk.tools.ToolNodeSet",defaultValue:n.Highlight}},aggregations:{buttons:{type:"sap.m.Button",multiple:true}},events:{editing:{parameters:{nodeRef:"any"}},removing:{parameters:{nodeRef:"any"}},moving:{parameters:{x:"float",y:"float",z:"float",nodesProperties:"any[]"}},moved:{parameters:{x:"float",y:"float",z:"float",nodesProperties:"any[]"}}}},constructor:function(n,a){t.apply(this,arguments);this._viewport=null;this._poiHelper=new s;this.setAggregation("gizmo",new o);this._handler=new i(this);this._buttonPosition=new e.Vector2;this._selectedPoi=new Set}});r.prototype.init=function(){if(t.prototype.init){t.prototype.init.call(this)}this._editButton=new sap.m.Button({icon:"sap-icon://edit",type:sap.m.ButtonType.Neutral,press:function(t){this.fireEditing({nodeRef:this._selectedPoi.values().next().value})}.bind(this)}).addStyleClass("sapUiVizKitPoiButtonEdit");this._deleteButton=new sap.m.Button({icon:"sap-icon://delete",type:sap.m.ButtonType.Neutral,press:function(t){this.fireRemoving({nodeRef:this._selectedPoi.values().next().value})}.bind(this)}).addStyleClass("sapUiVizKitPoiButtonDelete");this.addAggregation("buttons",this._editButton);this.addAggregation("buttons",this._deleteButton);this.setButtonsVisibility(false);this.attachMoved(function(t){var e=t.getParameter("nodesProperties");for(var i=0;i<e.length;++i){var o=e[i].node;if(this._gizmo&&this._gizmo.getIgnoreNonPoiNode()&&o._vkGetNodeContentType()!==a.Symbol){continue}this._poiHelper.adjustPoi(this._viewport,o)}});this.setFootprint(["sap.ui.vk.threejs.Viewport"])};r.prototype.getSelectedPois=function(){var t=[];if(this._viewport){var e=this._viewport._viewStateManager;e.getSymbolNodes().forEach(function(i){if(e.getSelectionState(i)){t.push(i)}})}return t};r.prototype._updateSelectedPoi=function(){if(this._viewport&&this._viewport._viewStateManager){var t=this._viewport._viewStateManager;var e=t.getSymbolNodes();this._selectedPoi.forEach(function(t){if(!e.includes(t)){this._selectedPoi.delete(t)}}.bind(this));e.forEach(function(e){if(t.getSelectionState(e)){this._selectedPoi.add(e)}else{this._selectedPoi.delete(e)}}.bind(this))}return this};r.prototype._updateButtonPosition=function(t){var i=this._poiHelper.getPoiRect(this._viewport,t);if(i){var o=new e.Box3;o.expandByObject(t);var s=new e.Vector3;o.getCenter(s);var n=this._viewport.projectToScreen(s.x,s.y,s.z,this._viewport.getCamera());var a=n.x+i.width/2;var r=n.y-i.height/2;this._buttonPosition.set(a,r);return true}return false};r.prototype.handlePoiSelectionChange=function(){this._updateSelectedPoi()};r.prototype.setActive=function(e,i){t.prototype.setActive.call(this,e,i);if(this._viewport){this.updateButtons();if(e){this._gizmo=this.getGizmo();this._gizmo.show(this._viewport,this);this._gizmo.rerender();this._addLocoHandler();this._viewport._viewStateManager.attachSelectionChanged(this.handlePoiSelectionChange,this)}else{this._removeLocoHandler();if(this._viewport._viewStateManager){this._viewport._viewStateManager.detachSelectionChanged(this.handlePoiSelectionChange,this)}if(this._gizmo){this._gizmo.hide();this._gizmo=null}}}return this};r.prototype.updateButtons=function(){this._updateSelectedPoi();var t=this.getButtons();var e;t.forEach(function(t){if(t.getVisible()){t.rerender();if(t.getDomRef()){e=t.getDomRef().parentElement}}});if(e){if(this._selectedPoi.size&&this._updateButtonPosition(this._selectedPoi.values().next().value)){e.style.display="block";e.style.left=this._buttonPosition.x+"px";e.style.top=this._buttonPosition.y+"px"}else{e.style.display="none"}}};r.prototype.setButtonsVisibility=function(t){this.getButtons().forEach(function(e){if(e.getVisible()!==t){e.setVisible(t)}})};r.prototype.addButtons=function(t){if(!Array.isArray(t)){t=[t]}t.forEach(function(t){this.addAggregation("buttons",t)},this)};return r});