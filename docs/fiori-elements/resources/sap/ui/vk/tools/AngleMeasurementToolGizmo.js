/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../measurements/Angle","../measurements/Utils","./MeasurementToolState","./MeasurementToolGizmo"],function(e,t,r,i){"use strict";var s=i.extend("sap.ui.vk.tools.AngleMeasurementToolGizmo",{metadata:{library:"sap.ui.vk"}});var a=s.getMetadata().getParent().getClass().prototype;s.prototype.init=function(){if(a.init){a.init.call(this)}this._thirdFeature=null};s.prototype._updateCurrentFeature=function(e,i,s,a,u,n){var h=e==null?null:this._getMeshAnalyzer(e);var c=this._computeSphereRadius(i,s);var _=false;var o=false;var l=this._firstFeature&&this._firstFeature.isEdge;if(h!=null&&(a||u||n)){var f=h.intersectSphere(i,c,a,u,n,false,false);if(this._is2D){if(!l&&f.vertex!=null){if(this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],f.vertexId,h)){this._currentFeature.setValue(f.vertex);return true}}else if(f.edge!=null){if(this._state===r.SearchingSecondFeature&&this._firstFeature.getFeatureId()===f.edgeId&&this._firstFeature.getContext()===h){_=true}else if(this._replaceCurrentFeature(this._edgeFeatures[this._currentFeatureIndex],f.edgeId,h)){this._currentFeature.setValue(f.edge);return true}}else if(l){_=true}else{this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],null,h);this._currentFeature.setValue(i);return true}}else{if(f.vertexId!=null){if(this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],f.vertexId,h)){this._currentFeature.setValue(h.getVertex(f.vertexId));return true}}else if(f.edgeId!=null){if(this._replaceCurrentFeature(this._edgeFeatures[this._currentFeatureIndex],f.edgeId,h)){this._currentFeature.setValue(h.buildEdgePath(f.edgeId,true));return true}}else if(f.faceId!=null){if(this._state===r.SearchingSecondFeature&&this._firstFeature.getFeatureId()===f.faceId&&this._firstFeature.getContext()===h){_=true}else if(this._replaceCurrentFeature(this._faceFeatures[this._currentFeatureIndex],f.faceId,h)){var F=h.buildFace(f.faceId);if(this._state===r.SearchingSecondFeature&&!t.intersectPlanes(this._firstFeature.getValue().planeEquation,F.planeEquation)){_=true}else{this._currentFeature.setValue(F);return true}}o=true}else{_=true}}}else if(l){_=true}else{this._replaceCurrentFeature(this._vertexFeatures[this._currentFeatureIndex],null,h);this._currentFeature.setValue(i);return true}if(_&&this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null;return true}return o};s.prototype._trimByContour=function(e,r,i,s){var a=[r[0],r[1],r[2],i[0],i[1],i[2]];var u,n=null;var h,c,_;var o=e.edges;var l=e.vertices;for(var f=0,F=o.length;f<F;f+=2){h=3*o[f];c=3*o[f+1];_=t.intersectLines(a,[l[h],l[h+1],l[h+2],l[c],l[c+1],l[c+2]]);u=_&&_[1]>=0&&_[1]<=1?_[0]:null;if(u){if(n){if(u<n[0]){n[0]=u}if(u>n[1]){n[1]=u}}else{n=[u,u]}}}var v=null;if(n&&s){if(s>n[0]&&s<n[1]){v=s}else if(n[1]>0&&n[1]<1){v=n[1]}}else if(n&&n[1]>0&&n[1]<1){v=n[1]}else if(s&&s>0&&s<1){v=s}return v?t.pointOnLine(a,v):i};s.prototype._updateFace2FaceMeasurement=function(e){var r=this._firstFeature.getValue();var i=this._currentFeature.getValue();var s=t.intersectPlanes(r.planeEquation,i.planeEquation);var a,u,n,h,c,_;var o,l,f;var F=r.vertices;for(var v=0,d=F.length;v<d;v+=3){a=[F[v],F[v+1],F[v+2]];u=t.projectPointToLine(s,a);o=t.computePointToPointDistance2(a,t.pointOnLine(s,u));if(v===0){n=u;h=u;c=a;_=a;l=a;f=o}if(u<n){n=u;c=a}if(u>h){h=u;_=a}if(o>f){f=o;l=a}}var g=t.projectPointToLine(s,e);var p=t.pointOnLine(s,g);if(g<=n){this._currentMeasurement.setPoint1(c);this._currentMeasurement.setPoint2(t.pointOnLine(s,n))}else if(g>=h){this._currentMeasurement.setPoint1(_);this._currentMeasurement.setPoint2(t.pointOnLine(s,h))}else{var m=t.pointOnLine(s,t.projectPointToLine(s,l));var P=t.pointMinusPoint(m,p);a=t.pointMinusPoint(l,P);var S=t.computePointToPointDistance(p,a);var M=t.computePointToPointDistance(p,e);this._currentMeasurement.setPoint1(this._trimByContour(r,p,a,S>0?M/S:1));this._currentMeasurement.setPoint2(p)}this._currentMeasurement.setPoint3(p);this._currentMeasurement.setPoint4(e);this._currentMeasurement.computeAngle();var x=Math.acos(t.dotProduct(r.planeEquation,i.planeEquation));var C=Math.PI-x;var I=this._currentMeasurement.getAngle();this._currentMeasurement.setAngle(Math.abs(x-I)<Math.abs(C-I)?x:C)};s.prototype._updateMeasurement=function(e){if(this._state===r.DefiningAngle){var t=this._viewport;var i=t.getCamera();var s=e.getPoints();var a=t.projectToScreen(s[0],s[1],s[2],i);var u=t.projectToScreen(s[3],s[4],s[5],i);var n=t.projectToScreen(s[6],s[7],s[8],i);var h=t.projectToScreen(s[9],s[10],s[11],i);var c=t.projectToScreen(s[12],s[13],s[14],i);var _=t.projectToScreen(s[15],s[16],s[17],i);var o=n.x-h.x;var l=n.y-h.y;var f=this._hoverPoint.screenPoint;e.setAngleRadius([a.x-o,a.y-l,0],[u.x-o,u.y-l,0],[h.x,h.y,0],[c.x,c.y,0],[_.x,_.y,0],[f[0],f[1],0]);return}var F=this._hoverPoint.worldPoint.slice();if(this._currentFeature&&this._currentFeature.isVertex){var v=this._currentFeature.getValue();F[0]=v[0];F[1]=v[1];F[2]=v[2]}if(this._state===r.SearchingSecondFeature){if(this._currentFeature&&this._currentFeature.isEdge){var d=this._currentFeature.getValue();e.setPoint3(d);e.setPoint4([d[3],d[4],d[5]]);e.computeAngle()}else if(this._firstFeature.isVertex){e.setPoint2(F);e.setPoint3(F);e.setPoint4(F);e.computeAngle()}else if(this._currentFeature&&this._currentFeature.isFace){this._updateFace2FaceMeasurement(F);e.setState(1)}}else if(this._state===r.SearchingThirdFeature){e.setPoint4(F);e.setState(1);e.computeAngle()}};s.prototype.setHoverPoint=function(e){var t=this._hoverPoint&&this._hoverPoint.nodeRef;var i=e&&e.nodeRef;if(i!=t){var s=this._vsm;if(s!=null){var a=i!=null?[i]:[];var u=t!=null?[t]:[];s.setOutliningStates(a,u,false,true)}}this._hoverPoint=e;var n=this._state===r.DefiningAngle;var h=this._state===r.SearchingSecondFeature||this._state===r.SearchingThirdFeature||this._state===r.DefiningAngle?this._currentMeasurement:null;if(!n&&(!e||e.worldPoint==null)){if(h){h.setVisible(n);this._surface.update(this._viewport,this._viewport.getCamera())}if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}}else{var c=this._settings;var _=!e.shiftKey&&c.featureFace&&!this._is2D;var o=!e.shiftKey&&c.featureEdge;var l=!e.shiftKey&&c.featureVertex;if(this._firstFeature){_=this._firstFeature.isFace;o=this._firstFeature.isEdge;l=this._firstFeature.isVertex}if(n){_=false;o=false;l=false}var f=true;if((i||this._is2D)&&!n){f=this._updateCurrentFeature(i,this._hoverPoint.worldPoint,this._viewport,_,o,l)}else if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}if(h&&f){this._updateMeasurement(h);h.setVisible(n||this._currentFeature!=null)}this._surface.update(this._viewport,this._viewport.getCamera())}return this};s.prototype.fixPoint=function(t){this.setHoverPoint(t);var i=this._vsm;var s=this._hoverPoint&&this._hoverPoint.nodeRef;var a=this._state;switch(a){case r.SearchingFirstFeature:if(!t.worldPoint){break}this._firstFeature=this._currentFeature;this._currentFeature=null;this.setCurrentFeatureIndex(1);this._state=r.SearchingSecondFeature;var u=t.worldPoint.slice();var n=t.worldPoint.slice();if(this._firstFeature&&this._firstFeature.isVertex){var h=this._firstFeature.getValue();u[0]=h[0];u[1]=h[1];u[2]=h[2]}var c=0;if(this._firstFeature&&this._firstFeature.isEdge){var _=this._firstFeature.getValue();u[0]=_[0];u[1]=_[1];u[2]=_[2];n[0]=_[3];n[1]=_[4];n[2]=_[5];c=1}var o=new e({point1:u,point2:n,point3:n,point4:n,state:c});this._surface.beginMeasurementConstruction(o);this._currentMeasurement=o;break;case r.SearchingSecondFeature:if(!this._currentMeasurement.getVisible()||!this._currentMeasurement.isEdge1Defined()){break}this._surface.update(this._viewport,this._viewport.getCamera());if(s!=null&&i!=null){i.setOutliningStates([],[s],false,true)}this._secondFeature=this._currentFeature;this._currentFeature=null;this.setCurrentFeatureIndex(2);this._state=this._currentMeasurement.getState()===1?r.DefiningAngle:r.SearchingThirdFeature;break;case r.SearchingThirdFeature:if(!this._currentMeasurement.isEdge2Defined()){break}this._surface.update(this._viewport,this._viewport.getCamera());if(s!=null&&i!=null){i.setOutliningStates([],[s],false,true)}this._thirdFeature=this._currentFeature;this._currentFeature=null;this.setCurrentFeatureIndex(3);this._state=r.DefiningAngle;break;case r.DefiningAngle:if(!this._currentMeasurement.isEdge2Defined()){break}this._currentMeasurement.setState(2);this._currentMeasurement.setFeatures(this._thirdFeature!=null?[this._firstFeature,this._secondFeature,this._thirdFeature]:[this._firstFeature,this._secondFeature]);this._surface.update(this._viewport,this._viewport.getCamera());if(s!=null&&i!=null){i.setOutliningStates([],[s],false,true)}this._state=r.SearchingFirstFeature;if(this._currentFeature){this._surface.removeFeature(this._currentFeature)}this._surface.removeFeature(this._thirdFeature);this._surface.removeFeature(this._secondFeature);this._surface.removeFeature(this._firstFeature);this._currentFeature=null;this._firstFeature=null;this._secondFeature=null;this._thirdFeature=null;this.setCurrentFeatureIndex(0);var l=this._currentMeasurement;this._currentMeasurement=null;this._surface.endMeasurementConstruction(l);break;default:break}return this};s.prototype.escapePressed=function(){switch(this._state){case r.DefiningAngle:this._state=r.SearchingThirdFeature;this._currentMeasurement.setRadiusScale(1);if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}if(this._thirdFeature){this._surface.removeFeature(this._thirdFeature);this._thirdFeature=null;this.setCurrentFeatureIndex(2)}if(!this._firstFeature.isVertex){this._state=r.SearchingSecondFeature;this._surface.removeFeature(this._secondFeature);this._secondFeature=null;this.setCurrentFeatureIndex(1);this._currentMeasurement.setVisible(false)}break;case r.SearchingThirdFeature:this._state=r.SearchingSecondFeature;this._currentMeasurement.setState(0);this._surface.removeFeature(this._secondFeature);this._secondFeature=null;this.setCurrentFeatureIndex(1);if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}break;case r.SearchingSecondFeature:this._state=r.SearchingFirstFeature;this._surface.removeFeature(this._firstFeature);this._firstFeature=null;if(this._currentFeature){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}this.setCurrentFeatureIndex(0);this._surface.cancelMeasurementConstruction(this._currentMeasurement);this._currentMeasurement=null;break;case r.SearchingFirstFeature:var e=this._vsm;var t=this._hoverPoint&&this._hoverPoint.nodeRef;if(t!=null&&e!=null){e.setOutliningStates([],[t],false,true)}if(this._currentFeature!=null){this._surface.removeFeature(this._currentFeature);this._currentFeature=null}this._state=r.Off;this._tool.setActive(false,this._viewport);break;default:break}if(this._currentMeasurement){this._updateMeasurement(this._currentMeasurement)}if(this._state!==r.Off){this._surface.update(this._viewport,this._viewport.getCamera())}};s.prototype.is2D=function(){return this._is2D};return s});