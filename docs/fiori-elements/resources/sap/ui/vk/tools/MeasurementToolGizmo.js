/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Core","sap/base/Log","../measurements/Edge","../measurements/Face","../measurements/Vertex","../measurements/MeshAnalyzer","../measurements/MeshAnalyzer2D","../measurements/Settings","./MeasurementToolState","./Gizmo","../thirdparty/three"],function(e,t,r,a,s,i,n,u,o,h,l){"use strict";var _=h.extend("sap.ui.vk.tools.MeasurementToolGizmo",{metadata:{library:"sap.ui.vk"}});var c=_.getMetadata().getParent().getClass().prototype;_.prototype.hasDomElement=function(){return false};_.prototype.init=function(){if(c.init){c.init.call(this)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=o.Off;this._hoverPoint=null;this._currentFeature=null;this._currentFeatureIndex=0;this._firstFeature=null;this._secondFeature=null;this._vertexFeatures=[new s];this._edgeFeatures=[new r];this._faceFeatures=[new a];this._currentMeasurement=null;this._meshAnalyzerMap=new Map;this._is2D=false};_.prototype.setCurrentFeatureIndex=function(e){if(e<1&&this._firstFeature){t.error("setCurrentFeatureIndex: first feature not null with index="+e)}if(e<2&&this._secondFeature){t.error("setCurrentFeatureIndex: second feature not null with index="+e)}var i=e-this._currentFeatureIndex;if(i===1){this._currentFeatureIndex++;this._vertexFeatures.push(new s);this._edgeFeatures.push(new r);this._faceFeatures.push(new a)}else if(i===-1){this._currentFeatureIndex--;this._vertexFeatures.pop();this._edgeFeatures.pop();this._faceFeatures.pop()}else if(e===0){this._currentFeatureIndex=0;this._vertexFeatures.splice(1);this._edgeFeatures.splice(1);this._faceFeatures.splice(1)}else if(i!==0){t.error("setCurrentFeatureIndex: "+this._currentFeatureIndex+" => "+e)}};_.prototype._createMeshAnalyzer=function(e){var t=null;var r=0;var a=0;var s=function(e){if(e.geometry&&e.geometry.isBufferGeometry){var a=e.geometry.getAttribute("position");var i=e.geometry.getIndex();if(a&&i){var n=e.userData.renderGroup;if(t){for(var u=n?n.start:0,o=n?n.start+n.count:i.count;u<o;u+=3){var h=(new l.Vector3).fromArray(a.array,i.array[u]*3);var _=(new l.Vector3).fromArray(a.array,i.array[u+1]*3);var c=(new l.Vector3).fromArray(a.array,i.array[u+2]*3);h.applyMatrix4(e.matrixWorld);_.applyMatrix4(e.matrixWorld);c.applyMatrix4(e.matrixWorld);t.addTriangle([h.x,h.y,h.z],[_.x,_.y,_.z],[c.x,c.y,c.z])}}else{r+=n?n.count:i.count}}}e.children.forEach(s)};for(var n=0;n<2;++n){s(e);if(n===0){t=new i(r/3,a)}}t.finishMeshBuilding();return t};_.prototype._createMeshAnalyzer2D=function(e){return new n(e,this._viewport.getCamera()._getViewBox())};_.prototype._getMeshAnalyzer=function(e){var t=this._meshAnalyzerMap.get(e);if(t!=null){return t}var r=this._is2D?this._createMeshAnalyzer2D(e):this._createMeshAnalyzer(e);this._meshAnalyzerMap.set(e,r);return r};_.prototype.show=function(t,r){this._viewport=t;this._surface=t.getMeasurementSurface();this._tool=r;this._vsm=e.byId(t.getViewStateManager());this._is2D=t.getScene().getMetadata().getName()==="sap.ui.vk.svg.Scene";this._settings=u.load();this._state=o.SearchingFirstFeature;this.setCurrentFeatureIndex(0)};_.prototype.hide=function(){if(this._surface!=null){var e=this._surface;for(var t=0,r=this._faceFeatures.length;t<r;++t){e.removeFeature(this._faceFeatures[t])}for(var a=0,s=this._edgeFeatures.length;a<s;++a){e.removeFeature(this._edgeFeatures[a])}for(var i=0,n=this._vertexFeatures.length;i<n;++i){e.removeFeature(this._vertexFeatures[i])}if(this._currentMeasurement!=null){e.removeMeasurement(this._currentMeasurement);this._currentMeasurement=null}}var u=this._vsm;var h=this._hoverPoint&&this._hoverPoint.nodeRef;if(h!=null&&u!=null){u.setOutliningStates([],[h],false,true)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=o.Off;this._currentFeature=null;this._firstFeature=null;this._secondFeature=null;this.setCurrentFeatureIndex(0);this._hoverPoint=null};_.prototype._computeSphereRadius=function(e,t){var r=this._is2D?5:3;if(this._is2D){var a=t._camera._worldToScreen(e[0],e[1]);var s=t._camera._screenToWorld(a.x+r,a.y);r=Math.abs(e[0]-s.x)}else{var i=t.getDomRef().getBoundingClientRect();var n=i.width*.5;var u=i.height*.5;var o=t.getCamera().getCameraRef();var h=(new l.Vector3).fromArray(e);var _=h.clone();_.project(o);var c=r/n;var f=r/u;r=0;for(var v=0;v<4;++v){var p=v%2?-1:1;var m=new l.Vector3(_.x+p*(v<2?c:0),_.y+p*(v>=2?f:0),_.z);m.unproject(o);var d=m.distanceTo(h);if(d>r){r=d}}}return r};_.prototype._replaceCurrentFeature=function(e,t,r){var a=false;if(e!==this._currentFeature){this._surface.removeFeature(this._currentFeature);this._surface.addFeature(e);this._currentFeature=e;a=true}else if(r!==e.getContext()||t!==e.getFeatureId()){a=true}if(a){e.setContext(r);e.setFeatureId(t)}return a};return _});