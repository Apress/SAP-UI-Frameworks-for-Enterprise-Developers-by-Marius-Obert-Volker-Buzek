/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider","./Messages","./getResourceBundle","sap/base/Log"],function(e,t,s,r){"use strict";var i=e.extend("sap.ui.vk.DownloadManager",{metadata:{library:"sap.ui.vk",events:{itemSucceeded:{parameters:{source:{type:"any"},response:{type:"object"}}},itemProgress:{parameters:{source:{type:"any"},loaded:{type:"int"},total:{type:"int"}}},itemFailed:{parameters:{source:{type:"any"},status:{type:"any"},statusText:{type:"string"}}},allItemsCompleted:{}}},constructor:function(t,s,r,i){e.apply(this);this._maxParallelTasks=s||5;this._sourcesToProcess=t.slice();this._sourcesBeingProcessed=[];this._authorizationHandler=r;this._retryCount=i!==undefined?Math.max(i,0):1}});i.prototype.start=function(){while(this._pickAndDispatchTask()){}return this};i.prototype.queue=function(e){this._sourcesToProcess.push(e);this._pickAndDispatchTask();return this};i.prototype._pickAndDispatchTask=function(){if(this._sourcesToProcess.length>0&&this._sourcesBeingProcessed.length<this._maxParallelTasks){var e=this._sourcesToProcess.shift();this._sourcesBeingProcessed.push(e);var t=this;if(this._authorizationHandler){this._authorizationHandler(e).then(function(s){var r=null;if(s!=null){r=s.token_type+" "+s.access_token}var i=s?s.tenant_uuid:null;t._runTask(e,r,i)}).catch(function(s){t.fireItemFailed({source:e,status:0,statusText:s});t._taskFinished(e);if(t._queueIsEmpty()){t.fireAllItemsCompleted()}})}else{this._runTask(e)}return true}return false};i.prototype._taskFinished=function(e){var t=this._sourcesBeingProcessed.indexOf(e);if(t>=0){this._sourcesBeingProcessed.splice(t,1)}return this};i.prototype._queueIsEmpty=function(){return this._sourcesToProcess.length===0&&this._sourcesBeingProcessed.length===0};i.prototype._runTask=function(e,i,o){var a=this;if(typeof e==="string"){var n=this._retryCount;(function t(){var s=new XMLHttpRequest;s.onerror=function(i){if(s.status===0){if(n-- >0){r.info("Could not retrieve '"+e+"' due to network error.","Retrying ("+(a._retryCount-n)+" of "+a._retryCount+" attempts)...","sap.ui.vk.DownloadManager");t();return}}a._taskFinished(e);a._pickAndDispatchTask();a.fireItemFailed({source:e,status:s.status,statusText:s.statusText});if(a._queueIsEmpty()){a.fireAllItemsCompleted()}};s.onload=function(i){switch(s.status){case 408:case 425:case 429:case 500:case 502:case 503:case 504:if(n-- >0){r.info("Could not retrieve '"+e+"' as request failed with HTTP status "+s.status+": "+s.statusText,"Retrying ("+(a._retryCount-n)+" of "+a._retryCount+" attempts)...","sap.ui.vk.DownloadManager");t();return}break;default:break}a._taskFinished(e);a._pickAndDispatchTask();if(s.status===200||s.status===0){a.fireItemSucceeded({source:e,response:s.response})}else{a.fireItemFailed({source:e,status:s.status,statusText:s.statusText})}if(a._queueIsEmpty()){a.fireAllItemsCompleted()}};s.onprogress=function(t){a.fireItemProgress({source:e,loaded:t.loaded,total:t.total})};s.open("GET",e,true);s.responseType="arraybuffer";if(i){s.setRequestHeader("Authorization",i)}if(o){s.setRequestHeader("X-TenantUuid",o)}s.send(null)})()}else if(e instanceof File){var u=new FileReader;u.onload=function(t){a._taskFinished(e);a._pickAndDispatchTask();a.fireItemSucceeded({source:e,response:u.result});if(a._queueIsEmpty()){a.fireAllItemsCompleted()}};u.onerror=function(t){a._taskFinished(e);a._pickAndDispatchTask();a.fireItemFailed({source:e,status:u.error.name,statusText:u.error.message});if(a._queueIsEmpty()){a.fireAllItemsCompleted()}};u.onprogress=function(t){a.fireItemProgress({source:e.name,loaded:t.loaded,total:t.total})};u.readAsArrayBuffer(e)}else{r.error(s().getText(t.VIT5.summary),t.VIT5.code,"sap.ui.vk.DownloadManager")}return this};i.prototype.attachItemSucceeded=function(e,t,s){return this.attachEvent("itemSucceeded",e,t,s)};i.prototype.detachItemSucceeded=function(e,t){return this.detachEvent("itemSucceeded",e,t)};i.prototype.fireItemSucceeded=function(e,t,s){return this.fireEvent("itemSucceeded",e,t,s)};i.prototype.attachItemFailed=function(e,t,s){return this.attachEvent("itemFailed",e,t,s)};i.prototype.detachItemFailed=function(e,t){return this.detachEvent("itemFailed",e,t)};i.prototype.fireItemFailed=function(e,t,s){return this.fireEvent("itemFailed",e,t,s)};i.prototype.attachAllItemsCompleted=function(e,t,s){return this.attachEvent("allItemsCompleted",e,t,s)};i.prototype.detachAllItemsCompleted=function(e,t){return this.detachEvent("allItemsCompleted",e,t)};i.prototype.fireAllItemsCompleted=function(e,t,s){return this.fireEvent("allItemsCompleted",e,t,s)};i.prototype.attachItemProgress=function(e,t,s){return this.attachEvent("itemProgress",e,t,s)};i.prototype.detachItemProgress=function(e,t){return this.detachEvent("itemProgress",e,t)};i.prototype.fireItemProgress=function(e,t,s){return this.fireEvent("itemProgress",e,t,s)};return i});