/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","../ViewStateManagerBase","./GraphicsCoreApi","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","sap/base/util/array/uniqueSort"],function(e,t,i,s,r,n,a,o,l){"use strict";var h;var d=t.extend("sap.ui.vk.dvl.ViewStateManager",{metadata:{library:"sap.ui.vk"}});var c=d.getMetadata().getParent().getClass().prototype;d.prototype.init=function(){if(c.init){c.init.call(this)}this._nodeHierarchy=null;this._dvl=null;this._nodeStates=new Map;this._selectedNodes=new Set;this._visibilityTracker=new h;this._closedNodeProcessed=false};d.prototype._setContent=function(e){var t=null;if(e&&e instanceof o){t=e}this._setScene(t);return this};d.prototype._setScene=function(e){if(e){this._setNodeHierarchy(e.getDefaultNodeHierarchy())}else{this._setNodeHierarchy(null)}return this};d.prototype._setNodeHierarchy=function(e){var t=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy.detachNodeCreated(this._handleNodeCreated,this);this._nodeHierarchy.detachNodeRemoving(this._handleNodeRemoving,this);this._dvl.Client.detachStepEvent(this._handleStepEvent,this);this._nodeHierarchy=null;this._dvl=null;this._nodeStates.clear();this._selectedNodes.clear();this._visibilityTracker.clear()}if(e){var s=e.getScene(),r=s.getSceneRef();this._nodeHierarchy=e;this._dvl=s.getGraphicsCore().getApi(i.LegacyDvl);this._dvl.Client.attachStepEvent(this._handleStepEvent,this);this._nodeHierarchy.attachNodeCreated(this._handleNodeCreated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._populateNodeStates(this._dvl.Scene.RetrieveSceneInfo(r,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN|sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes)}if(e!==t){this.fireNodeHierarchyReplaced({oldNodeHierarchy:t,newNodeHierarchy:e})}return this};d.prototype._populateNodeStates=function(e){var t=this,i=[],s=[],r=[],n=[],a=this._nodeHierarchy.getScene(),o=a.getSceneRef();e.forEach(function e(a){var l=t._dvl.Scene.RetrieveNodeInfo(o,a,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS|sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN);t._nodeStates.set(a,{flags:l.Flags,visible:l.Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE});if(l.Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED){t._selectedNodes.add(a)}(l.Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE?i:s).push(a);(l.Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED?r:n).push(a);l.ChildNodes.forEach(e)});this.fireSelectionChanged({selected:r,unselected:n});this.fireVisibilityChanged({visible:i,hidden:s});return this};d.prototype._handleNodeCreated=function(e){this._populateNodeStates([e.getParameter("nodeRef")])};d.prototype._handleNodeRemoving=function(e){var t=e.getParameter("nodeRef"),i=this;var s=function(e){i._nodeHierarchy.enumerateChildren(e,s,true,true);i._nodeStates.delete(e)};s(t)};d.prototype.getNodeHierarchy=function(){return this._nodeHierarchy};d.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null};d.prototype.getVisibilityComplete=function(){var e=this.getNodeHierarchy(),t=e.findNodesByName(),i=[],s=[];t.forEach(function(t){var r=e.createNodeProxy(t),n=jQuery.grep(r.getVeIds(),function(e){return e.type==="VE_LOCATOR"});n=Array.isArray(n)&&n.length>0?n[0].fields[0].value:null;e.destroyNodeProxy(r);if(n){if(this.getVisibilityState(t)){i.push(n)}else{s.push(n)}}},this);return{visible:i,hidden:s}};d.prototype.resetVisibility=function(){this._dvl.Renderer.ResetView(sap.ve.dvl.DVLRESETVIEWFLAG.VISIBILITY,this._scene);return this};var f=function(e,t,i){return e.has(i)&&(e.get(i).flags&t)!==0};d.prototype._getVisibilityFlagState=function(e){return f(this._nodeStates,sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE,e)};d.prototype._getSelectionFlagState=function(e){return f(this._nodeStates,sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED,e)};var u=function(e,t,i,s){if(e.has(s)){var r=e.get(s);r.flags=r.flags&~i|t&i}else{e.set(s,{flags:t&i})}};d.prototype._setFlags=function(e,t,i){if(i&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE){this.setVisibilityState(e,(t&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE)!==0,false)}if(i&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED){this.setSelectionState(e,(t&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED)!==0,false)}u(this._nodeStates,t,i&~(sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE|sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED),e);return this};d.prototype._getFlags=function(e,t){var i=this._nodeStates.get(e),s=i&&i.flags;return s!==undefined?s&t:null};d.prototype.getVisibilityState=function(e){return Array.isArray(e)?e.map(this._getVisibilityFlagState,this):this._getVisibilityFlagState(e)};d.prototype.setVisibilityState=function(e,t,i,s){if(!Array.isArray(e)){e=[e]}var r=l(i?this._collectNodesRecursively(e,true):e).filter(function(e){return e&&this._getVisibilityFlagState(e)!==t},this);var n=function(e,t){var i=[];this._nodeHierarchy.enumerateChildren(e,function(e){i.push(e)},true,true);i.forEach(function(e){var i=this._nodeStates.get(e);if(t){if(i.visible){i.flags|=sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE;n(e,t)}}else{i.flags&=~sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE;n(e,t)}},this)}.bind(this);if(r.length>0){r.forEach(function(e){var i=this._nodeStates.get(e);if(i){if(i.flags===undefined){i.flags=0}if(t){i.flags|=sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE}else{i.flags&=~sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE}}else{i={flags:t?sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE:0};this._nodeStates.set(e,i)}i.visible=t;n(e,t)},this);if(this.getShouldTrackVisibilityChanges()){r.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker)}this.fireVisibilityChanged({visible:t?r:[],hidden:t?[]:r})}return this};d.prototype.enumerateSelection=function(e){this._selectedNodes.forEach(e);return this};d.prototype.getSelectionState=function(e){return Array.isArray(e)?e.map(this._getSelectionFlagState,this):this._getSelectionFlagState(e)};d.prototype.setSelectionState=function(e,t,i,s){if(!Array.isArray(e)){e=[e]}var r=l(i||this.getRecursiveSelection()?this._collectNodesRecursively(e):e);if(this.getRecursiveSelection()&&!t){r=this._nodeHierarchy._appendAncestors(r)}r=r.filter(function(e){return e&&this._getSelectionFlagState(e)!==t},this);if(r.length>0){r.forEach(function(e){var i=this._nodeStates.get(e);if(i){if(i.flags===undefined){i.flags=this._dvl.Scene.RetrieveNodeInfo(this._nodeHierarchy.getScene().getSceneRef(),e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags}if(t){i.flags|=sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED}else{i.flags&=~sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED}}else{var s=this._dvl.Scene.RetrieveNodeInfo(this._nodeHierarchy.getScene().getSceneRef(),e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags;this._nodeStates.set(e,{flags:s|(t?sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED:0)})}this._selectedNodes[t?"add":"delete"](e)},this);if(!s){this.fireSelectionChanged({selected:t?r:[],unselected:t?[]:r})}}return this};d.prototype.setSelectionStates=function(e,t,i,s){if(!Array.isArray(e)){e=[e]}if(!Array.isArray(t)){t=[t]}var r=l(i||this.getRecursiveSelection()?this._collectNodesRecursively(e):e);var n=l(i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t);if(this.getRecursiveSelection()){n=this._nodeHierarchy._appendAncestors(n,r)}r=r.filter(function(e){return e&&this._getSelectionFlagState(e)===false},this);n=n.filter(function(e){return e&&this._getSelectionFlagState(e)===true},this);if(r.length>0){r.forEach(function(e){var t=this._nodeStates.get(e);if(t){if(t.flags===undefined){t.flags=this._dvl.Scene.RetrieveNodeInfo(this._nodeHierarchy.getScene().getSceneRef(),e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags}t.flags|=sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED}else{var i=this._dvl.Scene.RetrieveNodeInfo(this._nodeHierarchy.getScene().getSceneRef(),e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags;this._nodeStates.set(e,{flags:i|sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED})}this._selectedNodes["add"](e)},this)}if(n.length>0){n.forEach(function(e){var t=this._nodeStates.get(e);if(t){if(t.flags===undefined){t.flags=this._dvl.Scene.RetrieveNodeInfo(this._nodeHierarchy.getScene().getSceneRef(),e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags}t.flags&=~sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED}else{var i=this._dvl.Scene.RetrieveNodeInfo(this._nodeHierarchy.getScene().getSceneRef(),e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags;this._nodeStates.set(e,{flags:i})}this._selectedNodes["delete"](e)},this)}if(!s){if(r.length>0||n.length>0){this.fireSelectionChanged({selected:r,unselected:n})}}return this};d.prototype._handleStepEvent=function(e){if(e.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._visibilityTracker.clear()}};d.prototype._collectNodesRecursively=function(e,t){var i=[],s=this;if(t===undefined){t=false}e.forEach(function e(r){i.push(r);s._nodeHierarchy.enumerateChildren(r,e,t,true)});return i};d.prototype._getOpacity=function(e){if(this._nodeStates.has(e)){var t=this._nodeStates.get(e).opacity;return t===undefined?null:t}else{return null}};d.prototype.getOpacity=function(e){if(Array.isArray(e)){return e.map(this._getOpacity,this)}else{return this._getOpacity(e)}};d.prototype.setOpacity=function(e,t,i){if(!Array.isArray(e)){e=[e]}var s=l(i?this._collectNodesRecursively(e,true):e).filter(function(e){return e&&this._getOpacity(e)!==t},this);if(s.length>0){s.forEach(function(e){var i=this._nodeStates.get(e);if(i){if(t===null){delete i.opacity}else{i.opacity=t}}else if(t!==null){this._nodeStates.set(e,{opacity:t})}},this);this.fireOpacityChanged({changed:s,opacity:t})}return this};d.prototype._getTintColorABGR=function(e){if(this._nodeStates.has(e)){var t=this._nodeStates.get(e).tintColorABGR;return t===undefined?null:t}else{return null}};d.prototype._getTintColor=function(e){if(this._nodeStates.has(e)){var t=this._nodeStates.get(e).tintColorABGR;return t===undefined?null:r(n(t))}else{return null}};d.prototype.getTintColor=function(e,t){var i=t?"_getTintColorABGR":"_getTintColor";if(Array.isArray(e)){return e.map(this[i],this)}else{return this[i](e)}};d.prototype.setTintColor=function(e,t,i){if(!Array.isArray(e)){e=[e]}var r=null;switch(typeof t){case"number":r=t;break;case"string":if(sap.ui.core.CSSColor.isValid(t)){r=a(s(t))}break;default:t=null;break}var n=l(i?this._collectNodesRecursively(e,true):e).filter(function(e){return e&&this._getTintColorABGR(e)!==r},this);if(n.length>0){n.forEach(function(e){var t=this._nodeStates.get(e);if(t){if(r===null){delete t.tintColorABGR}else{t.tintColorABGR=r}}else if(r!==null){this._nodeStates.set(e,{tintColorABGR:r})}},this);this.fireTintColorChanged({changed:n,tintColor:t,tintColorABGR:r})}return this};h=function(){this._visibilityChanges=new Set};h.prototype.getInfo=function(e){var t=function(e){return e.type==="VE_LOCATOR"};var i=[];this._visibilityChanges.forEach(function(s){var r=e.createNodeProxy(s),n=jQuery.grep(r.getVeIds(),t);n=Array.isArray(n)&&n.length>0?n[0].fields[0].value:null;e.destroyNodeProxy(r);if(n){i.push(n)}});return i};h.prototype.clear=function(){this._visibilityChanges.clear()};h.prototype.trackNodeRef=function(e){if(this._visibilityChanges.has(e)){this._visibilityChanges.delete(e)}else{this._visibilityChanges.add(e)}};return d});