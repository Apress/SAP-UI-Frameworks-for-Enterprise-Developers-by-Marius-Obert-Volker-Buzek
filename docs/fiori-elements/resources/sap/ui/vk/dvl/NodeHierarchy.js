/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../NodeHierarchy","../NodeContentType","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","./LayerProxy","../Messages","../DvlException","./checkResult","./getJSONObject","../getResourceBundle","sap/base/util/array/uniqueSort","sap/base/Log"],function(e,t,r,o,i,s,n,d,a,c,N,l,h){"use strict";var v={modeDictionary:{equals:function(e){return e?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL_CASE_INSENSITIVE},contains:function(e){return e?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING_CASE_INSENSITIVE},startsWith:function(e){return e?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH_CASE_INSENSITIVE}}};var D=e.extend("sap.ui.vk.dvl.NodeHierarchy",{metadata:{library:"sap.ui.vk"},_baseNodeProxyPool:new r(o),constructor:function(t){e.call(this);this._graphicsCore=t.getGraphicsCore();this._scene=t;this._dvlSceneRef=this._scene.getSceneRef();this._dvl=this._graphicsCore._getDvl();this._nodeProxies=[];this._layerProxies=[]}});D.prototype.destroy=function(){this._layerProxies.slice().forEach(this.destroyLayerProxy,this);this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._dvl=null;this._dvlSceneRef=null;this._scene=null;this._graphicsCore=null;e.prototype.destroy.call(this)};D.prototype.getGraphicsCore=function(){return this._graphicsCore};D.prototype.getScene=function(){return this._scene};D.prototype.getSceneRef=function(){return this._dvlSceneRef};D.prototype.enumerateChildren=function(e,t,r,o){if(typeof e==="function"){o=r;r=t;t=e;e=undefined}var i;if(e){if(r||(c(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){i=c(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes}else{i=[]}}else{i=c(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes}if(o){i.forEach(t)}else{var s=this._baseNodeProxyPool.borrowObject();try{i.forEach(function(e){s.init(this,e);t(s);s.reset()}.bind(this))}finally{this._baseNodeProxyPool.returnObject(s)}}return this};D.prototype.enumerateAncestors=function(e,t,r){var o=c(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;if(r){o.forEach(t)}else{var i=this._baseNodeProxyPool.borrowObject();try{o.forEach(function(e){i.init(this,e);t(i);i.reset()}.bind(this))}finally{this._baseNodeProxyPool.returnObject(i)}}return this};D.prototype.createNodeProxy=function(e){var t=new i(this,e);this._nodeProxies.push(t);return t};D.prototype.destroyNodeProxy=function(e){var t=this._nodeProxies.indexOf(e);if(t>=0){this._nodeProxies.splice(t,1)[0].destroy()}return this};D.prototype.getChildren=function(e,t){if(typeof e==="boolean"){t=e;e=undefined}if(e){if(t||(c(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){return c(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes}else{return[]}}else{return c(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes}};D.prototype.getAncestors=function(e){return c(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes};D.prototype.findNodesByName=function(e){var t=sap.ve.dvl.DVLFINDNODETYPE.DVLFINDNODETYPE_NODE_NAME,r=[],o,i;if(e===undefined||e===null||jQuery.isEmptyObject(e)){o=v.modeDictionary.contains(false);i=[""]}else{if(e.value===undefined||e.value===null||e.value===""){h.error(N().getText(n.VIT6.summary),n.VIT6.code,"sap.ui.vk.dvl.NodeHierarchy");return[]}var s=e.hasOwnProperty("predicate")?e.predicate:"equals";if(s===undefined||s===null||s===""){h.error(N().getText(n.VIT7.summary),n.VIT7.code,"sap.ui.vk.dvl.NodeHierarchy");return[]}else if(["equals","contains","startsWith"].indexOf(s)===-1){h.error(N().getText(n.VIT8.summary),n.VIT8.code,"sap.ui.vk.dvl.NodeHierarchy");return[]}o=v.modeDictionary[s](e.caseSensitive);i=typeof e.value==="string"?[e.value]:e.value}for(var d=0;d<i.length;d++){r=r.concat(c(this._dvl.Scene.FindNodes(this._dvlSceneRef,t,o,i[d])).nodes)}return l(r)};D.prototype.createLayerProxy=function(e){var t=new s(this,e);this._layerProxies.push(t);return t};D.prototype.destroyLayerProxy=function(e){var t=this._layerProxies.indexOf(e);if(t>=0){this._layerProxies.splice(t,1)[0].destroy()}return this};D.prototype.getLayers=function(){return c(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_LAYERS)).Layers};D.prototype.getHotspotNodeIds=function(){var e=c(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return e.length>0?e:this._getLegacyHotspotNodeIds()};D.prototype._getLegacyHotspotNodeIds=function(){var e=this.getLayers(),t=[];for(var r=0;r<e.length;r++){var o=this.createLayerProxy(e[r]),i=o.getName();if(i.toLowerCase()==="hotspots"){t=o.getNodes();this.destroyLayerProxy(o);break}this.destroyLayerProxy(o)}return t};D.prototype.createNode=function(e,t,r){var o=this._dvl.Scene.CreateNode(this._dvlSceneRef,e,t,r);this.fireNodeCreated({nodeRef:o,nodeId:o});this.fireChanged();return o};D.prototype.createNodeCopy=function(e,t,r,o){var i=this._dvl.Scene.CreateNodeCopy(this._dvlSceneRef,e,t,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN,r,o);this.fireNodeCreated({nodeRef:i,nodeId:i});this.fireChanged();return i};D.prototype.getNodeContentType=function(e){return t.Regular};D.prototype.removeNode=function(e){var t=[].concat(e);t.forEach(function(e){this.fireNodeRemoving({nodeRef:e,nodeId:e});try{a(this._dvl.Scene.DeleteNode(this._dvlSceneRef,e))}catch(r){var t="Failed to delete node with ID = "+e+".";if(r instanceof d){t+=" Error code: "+r.code+". Message: "+r.message+"."}h.error(t)}}.bind(this));this.fireChanged();return this};return D});