/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../ContentManager","./Scene","./SceneBuilder","./Element","../Messages","../getResourceBundle","./Viewport","./ViewStateManager"],function(e,t,r,a,o,n,i){"use strict";var s=t.extend("sap.ui.vk.svg.ContentManager",{metadata:{library:"sap.ui.vk",events:{errorReported:{parameters:{error:{type:"any"}}}}}});var d=s.getMetadata().getParent().getClass().prototype;s.prototype.init=function(){if(d.init){d.init.call(this)}};s.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null}if(d.exit){d.exit.call(this)}};s.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};s.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};s.prototype.loadContent=function(t,a){var o=this;var s=function(){o.fireContentChangesStarted();var t=new r;o._loadContentResources(t,a).then(function(r){e.info("Content loading resolved",r);if(r&&r.length>0&&r[0].initialView){t.setInitialView(r[0].initialView)}var a;for(a=0;a<r.length;a++){if(r[a].camera){t.camera=r[a].camera;break}}if(r.length>0){var n=r[0];t.backgroundTopColor=n.backgroundTopColor;t.backgroundBottomColor=n.backgroundBottomColor}for(a=0;a<r.length;a++){if(r[a].loader){t.loaders=t.loaders||[];t.loaders.push(r[a].loader)}if(r[a].builder){t.builders=t.builders||[];t.builders.push(r[a].builder)}}if(o._totaraLoader){t.setSceneBuilder(o._totaraLoader.getSceneBuilder())}o.fireContentChangesFinished({content:t})},function(t){e.info("Content loading rejected:",t);var r;if(typeof t==="string"){r=t}else if(t.errorText){r=t.errorText}else if(t.message){r=t.message}r=r||i().getText(n.VIT37.summary);e.error(i().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),r);o.fireContentChangesFinished({content:null,failureReason:[{error:t,errorMessage:r}]})})};s();return this};s.prototype._getTotaraLoader=function(){if(this._totaraLoader==null){return new Promise(function(e){var t="sap/ui/vk/totara/TotaraLoader";sap.ui.require([t],function(t){var r=new t;r.setSceneBuilder(new a);e(r)})})}return Promise.resolve(this._totaraLoader)};s.prototype._getMataiLoader=function(){if(this._mataiLoader==null){var e=this;return new Promise(function(t){var r="sap/ui/vk/matai/MataiLoader";sap.ui.require([r],function(r){t(e._mataiLoader=new r)})})}return Promise.resolve(this._mataiLoader)};s.prototype._createLoadParam=function(t,r,a,o){var n=this;var i;var s=false;var d={root:a,vkScene:this._currentScene,enableLogger:o.getEnableLogger(),includeAnimation:false,includeBackground:o.getIncludeBackground(),includeHidden:o.getIncludeHidden(),includeParametric:true,includeUsageId:o.getIncludeUsageId(),metadataFilter:o.getMetadataFilter(),pushPMI:true,pushViewGroups:o.getPushViewGroups(),useSecureConnection:o.getUseSecureConnection(),onActiveCamera:function(e){i=e},onInitialSceneFinished:function(e){s=true;t({node:a,contentResource:o,initialView:e,camera:i,loader:n._totaraLoader})},onLoadingFinished:function(){n.fireContentLoadingFinished({source:o,node:a})},onContentChangesProgress:function(e){n.fireContentChangesProgress({source:e.source,phase:e.phase,percentage:e.percentage})}};var u=function(t){e.warning("Content loading error reported:",JSON.stringify(t.getParameters()));var a;if(t.getParameter("errorText")){a=t.getParameter("errorText")}else if(t.getParameter("error")){a=t.getParameter("error")}else if(t.getParameter("reason")){a=t.getParameter("reason")}else{a="failed to load: unknown reason"}if(s){var o=t.getParameter("error");if(o&&o===4){n.initUrl(this._loader.getUrl(),true)}}else{n.detachErrorReported(u);if(t.getParameter("events")){a=a+"\n"+JSON.stringify(t.getParameter("events"))}r(a)}};n.attachErrorReported(u);return d};s.prototype._reportError=function(e){this.fireErrorReported(e)};s.prototype._loadStream=function(e,t){var r=this;return new Promise(function(a,o){r._getTotaraLoader().then(function(n){r._totaraLoader=n;var i=r._createLoadParam(a,o,e,t);n.onErrorCallbacks.attach(r._reportError.bind(r));n.setUrl(t.getSource());n.run();n.request(t.getVeid(),i,r._authorizationHandler)})})};s.prototype._loadVDS4=function(e,t){var r=this;return this._getMataiLoader().then(function(a){if(a){r._mataiLoader=a;a.attachContentChangesProgress(r._handleContentChangesProgress,r);a.attachContentLoadingFinished(r._handleContentLoadingFinished,r);return a.load(e,t)}else{return Promise.resolve({node:e,contentResource:t})}})};s.prototype._loadContentResources=function(e,t){this._currentScene=e;this._currentNodeHierarchy=e.getDefaultNodeHierarchy();var r=[];var a=this;t.forEach(function e(t,n){var i=new o;i.name=n.getName();i.sourceId=n.getSourceId();t.add(i);n._shadowContentResource={nodeProxy:this._currentNodeHierarchy.createNodeProxy(i)};var s=n._contentManagerResolver;var d=s&&s.settings?s.settings.loader:null;if(d){if(typeof d==="function"){r.push(d(i,n,a._authorizationHandler))}else if(d&&d.load){i.matrix=new Float32Array([1,0,0,-1,0,0]);r.push(d.load(i,n,a._authorizationHandler));this._totaraLoader=d._loader;this._totaraLoader.onLoadingFinishedCallbacks.attach(function(){a.fireContentLoadingFinished({source:n,node:i})})}else{r.push(Promise.resolve({node:i,contentResource:n}))}}else{var u=n.getSourceType();switch(u?u.toLowerCase():null){case"stream2d":{i.matrix=new Float32Array([1,0,0,-1,0,0]);r.push(this._loadStream(i,n));break}case"vds4-2d":{i.matrix=new Float32Array([1,0,0,-1,0,0]);r.push(this._loadVDS4(i,n));break}default:break}}}.bind(this,e.getRootElement()));return Promise.all(r)};s.prototype.destroyContent=function(e){if(e){e.destroy()}if(this._totaraLoader){this._totaraLoader.dispose();this._totaraLoader=null}else if(this._mataiLoader&&e.builders&&Array.isArray(e.builders)){e.builders.forEach(function(e){if(e){e.cleanup()}});this._mataiLoader.destroy();this._mataiLoader=null}};return s});