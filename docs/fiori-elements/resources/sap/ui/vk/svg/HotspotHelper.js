/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../NodeContentType","./Element","./Rectangle","./Path","sap/base/assert","sap/base/util/uid","../TransformationMatrix","../thirdparty/imagetracer","../uuidv4"],function(t,e,r,a,i,o,n,s,l){"use strict";var u=function(){};u.prototype.createHotspot=function(e,r,a,i,o){var n=e.getDefaultNodeHierarchy().createNode(r,i,null,t.Hotspot,o);this.updateHotspot(n,a);return n};u.prototype.removeHotspot=function(t,e){t.getDefaultNodeHierarchy().removeNode(e)};u.prototype.duplicateHotspot=function(t,r,a,i){t=Array.isArray(t)?t:[t];var o;if(a){o=e._multiplyMatrices(e._invertMatrix(t[0]._matrixWorld()),a)}else if(i){var n=i._camera._transformRect({x1:0,y1:0,x2:30,y2:30});o=[1,0,0,1,n.x2-n.x1,n.y2-n.y1]}var s=e._invertMatrix(r._matrixWorld());var l=[];t.forEach(function(t){var a=t.clone();a.userData.duplicatedFrom=t.sid;var i=e._multiplyMatrices(o,t._matrixWorld());var n=e._multiplyMatrices(s,i);a.matrix.set(n);r.add(a);l.push(a)});return l.length===1?l[0]:l};u.prototype.updateHotspot=function(a,i){var o=a.children.length;while(o-- >0){var n=a.children[o];if(n.userData.sourceJointNode!==undefined){a.remove(n)}}if(i){a.userData.jointNodes=Array.from(i)}var s=e._invertMatrix(a._matrixWorld());function l(i){i.traverse(function(i){if(i.nodeContentType===t.Hotspot||i.parent===a){return}var o;if(i.type==="Image"){o=new r({x:i.x,y:i.y,width:i.width,height:i.height})}else if(i.type!=="Group"){o=(new i.constructor).copy(i,false)}if(o){o.matrix=e._multiplyMatrices(s,i._matrixWorld());o.userData.sourceJointNode=i;a.add(o)}})}i=a.userData.jointNodes;if(i){i.forEach(function(e){if(e.nodeContentType!==t.Hotspot&&e.parent!==a){l(e)}})}a._initAsHotspot()};u.prototype.getHotspotRelatedNodes=function(t){if(t&&t.userData&&t.userData.jointNodes){return t.userData.jointNodes}return[]};u.prototype.mergeHotspots=function(r,a){var i=r.getDefaultNodeHierarchy();var s=a[0];var l=i.createNode(null,s.name,null,t.Hotspot,{sid:o()});var u=[],d=[];var h=e._invertMatrix(l._matrixWorld());var c=function(t,e){return e._vkGetNodeContentType()===t};a.forEach(function(r){if(r.children.every(c.bind(null,t.Hotspot))){var a=r.children.length;while(a--){var i=r.children[0];var o=e._multiplyMatrices(h,i._matrixWorld());r.remove(i);l.add(i);i.matrix=o;u.push(i)}d.push(r)}else if(r.children.every(c.bind(null,t.Regular))){r.parent.remove(r);l.add(r);r.matrix=e._multiplyMatrices(h,r._matrixWorld());u.push(r)}});if(u){l.userData.jointNodes=Array.from(u)}if(s.hotspotColor!=null){l.setHotspotColor(s.vMask,s.hotspotColor)}if(s.customHotspotColor!=null){l.setCustomHotspotColor(s.vMask,s.customHotspotColor)}i.removeNode(d);var p=[],f=[],m=[],v=[],g=[];var y={name:l.name,contentType:t.Hotspot,joints:[],children:[]};l.userData.jointNodes.forEach(function(e,r){var a=e.getParametricContent(m,v,g);f.push(a);p.push({name:e.name,transform:n.convert3x2To4x3(e.matrix),parametric:r,contentType:t.Hotspot});y.joints.push({child:r,type:"LINK",action:"bubble"});y.children.push(r)});p.push(y);a.forEach(function(t){p.push({suppressed:true,sid:t.sid})});var x=r.getViewStateManager().getCurrentView();return{nodeRef:l,request:{views:[{id:x.getViewId(),name:x.getName(),nodes:p}],parametrics:f,fillstyles:m,linestyles:v,textStyles:g}}};u.prototype.mergeElements=function(r,a){i(a.length&&"HotspotHelper.mergeElements: at least one node must be provided");var n=r.createNode(null,a[0].name,null,t.Regular,{sid:o()});var s=e._invertMatrix(n._matrixWorld());var l={name:n.name,contentType:"geometry",parametric:0};var u=[l],d=[],h=[],c=[],p=[];var f=new Set;a.forEach(function(t){t.traverse(function(t){if(t._isGeometryNode()){f.add(t)}})});a.forEach(function(t){u.push({suppressed:true,sid:t.sid})});f.forEach(function(t){var r=t._matrixWorld();t.parent.remove(t);n.add(t);t.setMatrix(e._multiplyMatrices(s,r));t.userData.skipIt=true;var a=t._getParametricShape(h,c,p);if(a.type!==undefined){d.push(a)}});a.forEach(function(t){if(!f.has(t)){t.parent.remove(t)}});var m={nodes:u,parametrics:[{shapes:d}]};if(h.length>0){m.fillStyles=h}if(c.length>0){m.lineStyles=c}if(p.length>0){m.textStyles=p}return{nodeRef:n,request:m}};u.prototype.createHotspotFromGeometry=function(r,i,o){return new Promise(function(n,l){r=Array.isArray(r)?r:[r];var u=[];r.forEach(function(t){t.traverseVisible(function(t){if(t._isGeometryNode()){u.push(t)}},-1>>>0)});if(u.length===1){switch(u[0].type){case"Rectangle":case"Ellipse":case"Line":var d=i.createNode(o,r[0].name,null,t.Hotspot);d.setMatrix(e._multiplyMatrices(e._invertMatrix(d.parent._matrixWorld()),u[0]._matrixWorld()));var h=u[0].clone();h.setMatrix([1,0,0,1,0,0]);d.add(h);n(d);return;default:break}}var c;var p=document.createElementNS("http://www.w3.org/2000/svg","svg");u.forEach(function(t){var e=t._getBBox(t._matrixWorld());if(!c){c=e}else{c.width=Math.max(c.x+c.width,e.x+e.width);c.height=Math.max(c.y+c.height,e.y+e.height);c.x=Math.min(c.x,e.x);c.y=Math.min(c.y,e.y);c.width-=c.x;c.height-=c.y}var r=t.domRef.cloneNode(true);if(r.getAttribute("fill")){r.setAttribute("fill","#000")}if(r.getAttribute("stroke")){r.setAttribute("stroke","#000")}r.setAttribute("transform","matrix("+t._matrixWorld().join(",")+")");p.appendChild(r)});var f=c.width*.05;var m=c.height*.05;c.x-=f;c.y-=m;c.width+=f*2;c.height+=m*2;p.setAttribute("width",Math.ceil(1e3*c.width/Math.max(c.width,c.height)));p.setAttribute("height",Math.ceil(1e3*c.height/Math.max(c.width,c.height)));p.setAttribute("viewBox",[c.x,c.y,c.width,c.height].join(" "));p.setAttribute("font-family",'"72","72full",Arial,Helvetica,sans-serif');var v=new Image;v.onload=function(){var u=document.createElement("canvas");var d=u.width=this.width;var h=u.height=this.height;var p=u.getContext("2d");var f=i.createNode(o,r[0].name,null,t.Hotspot);var m=f.parent._matrixWorld();var v=m[3]<0;if(v){f.setMatrix(e._multiplyMatrices(e._invertMatrix(m),[c.width/d,0,0,-c.height/h,c.x,c.y+c.height]));p.transform(1,0,0,-1,0,h)}else{f.setMatrix(e._multiplyMatrices(e._invertMatrix(m),[c.width/d,0,0,c.height/h,c.x,c.y]))}p.drawImage(this,0,0,d,h);var g=p.getImageData(0,0,d,h);function y(t,e){return t+e*d<<2}var x=p.createImageData(d,h);var w,_;var M,H;function N(t,e){return t>=0&&t<d&&e>=0&&e<h?M[y(t,e)+3]:0}for(var b=0;b<2;b++){M=g.data;H=x.data;for(_=1;_<h;_++){for(w=1;w<d;w++){if(N(w,_)>127||N(w-1,_)>127||N(w+1,_)>127||N(w,_-1)>127||N(w,_+1)>127){H[y(w,_)+3]=255}}}var C=g;g=x;x=C}var D=g.data;function A(t,e){var r=y(t,e);return D[r+3]<128&&D[r]!==1}var E=[0,0];while(E.length>0){_=E.pop();w=E.pop();D[y(w,_)]=1;if(w+1<d&&A(w+1,_)){E.push(w+1,_)}if(w>0&&A(w-1,_)){E.push(w-1,_)}if(_+1<h&&A(w,_+1)){E.push(w,_+1)}if(_>0&&A(w,_-1)){E.push(w,_-1)}}for(_=0;_<h;_++){for(w=0;w<d;w++){if(A(w,_)){D[y(w,_)+3]=255}}}var S=s.imagedataToSVG(g,{ltres:2,qtres:2,pathomit:8,rightangleenhance:false,colorsampling:0,numberofcolors:2,mincolorratio:0,colorquantcycles:1,blurradius:0,blurdelta:20,strokewidth:0,linefilter:true,roundcoords:0,pal:[{r:0,g:0,b:0,a:0},{r:0,g:0,b:0,a:255}],desc:false});var T=[];var W=(new DOMParser).parseFromString(S,"image/svg+xml");if(W&&W.firstChild&&W.firstChild.tagName==="svg"){for(var I=W.firstChild.firstChild;I!==null;I=I.nextSibling){if(I.tagName==="path"&&I.getAttribute("opacity")>.5){T=T.concat(a._extractSegmentsFromDomRef(I))}}}if(T.length>0){f.add(new a({segments:T}));n(f)}else{f.parent.remove(f);l()}};v.src="data:image/svg+xml;base64,"+btoa((new XMLSerializer).serializeToString(p))})};u.prototype.createRequest=function(e,r){if(!e||!r){return null}var a=[];var i=[];var o=[];var s=[];var u=[];var d=r&&r._currentView;function h(e,r){r.setNodePersistentId(e,l());var d={name:e.name,transform:n.convert3x2To4x3(e.matrix),veId:e.sid};if(e.nodeContentType===t.Hotspot){d.contentType="HOTSPOT"}if(e.userData.duplicatedFrom){d.duplicatedFrom=e.userData.duplicatedFrom;delete e.userData.duplicatedFrom}var c=e.getParametricContent(o,s,u);if(c){d.parametric=i.length;i.push(c)}var p=a.length;a.push(d);var f=e.children;if(f.length>0){var m=[];for(var v=0;v<f.length;v++){if(f[v].type==="Group"){m.push(h(f[v],r))}}if(m.length>0){d.children=m}}return p}var c=r.getScene();(Array.isArray(e)?e:[e]).forEach(function(t){h(t,c)});var p={views:[{id:d&&d.getViewId(),nodes:a}],parametrics:i};if(o.length>0){p.fillstyles=o}if(s.length>0){p.linestyles=s}if(u.length>0){p.textStyles=u}return p};return u});