/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","./Core","./Loco","./ViewportBase","./ViewportHandler","./Messages","./NativeViewportRenderer","./getResourceBundle","sap/base/util/uid","sap/base/Log"],function(t,e,i,s,r,n,o,h,a,l,d,u){"use strict";var _=n.extend("sap.ui.vk.NativeViewport",{metadata:{library:"sap.ui.vk",properties:{limitZoomOut:{type:"boolean",group:"Behavior",defaultValue:false}},events:{resize:{parameters:{oldSize:"object",size:"object"}},move:{parameters:{pan:"object",zoom:"float"}}}},constructor:function(t,i){e.apply(this,arguments);this._canvas=null;this._canvas=document.createElement("div");this._canvas.style.textAlign="left";this._canvas.id=d();this._resizeListenerId=null;this._viewportHandler=new o(this);this._loco=new r(this);this._loco.addHandler(this._viewportHandler,-1);this._reset();this._svgid=this.getId()+"-svg";s.observeAssociations(this)}});_.prototype.init=function(){this.setBackgroundColorTop("transparent");this.setBackgroundColorBottom("transparent")};_.prototype.destroy=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){i.deregister(this._resizeListenerId);this._resizeListenerId=null}e.prototype.destroy.call(this)};_.prototype.onBeforeRendering=function(){if(this._resizeListenerId){i.deregister(this._resizeListenerId);this._resizeListenerId=null}};_.prototype.onAfterRendering=function(){if(this._canvas){var t=this.getDomRef();if(t.childNodes.length>0){t.insertBefore(this._canvas,t.childNodes[0])}else{t.appendChild(this._canvas)}this._resizeListenerId=i.register(this,this._handleResize.bind(this));this._handleResize({size:{width:t.clientWidth,height:t.clientHeight}})}};_.prototype.setShouldRenderFrame=function(){this.invalidate()};_.prototype._handleResize=function(t){this.fireResize({oldSize:t.oldSize,size:t.size});if(this._s===0||this._svgError){this.zoomTo()}else{this._update()}};_.prototype._reset=function(){this._img=null;this._svg=null;this._svgError=null;this._imageW=0;this._imageH=0;this._bestFitScale=0;this._s=0;this._x=0;this._y=0;this._gx=0;this._gy=0;this._canvas.style.visibility="hidden";while(this._canvas.lastChild){this._canvas.removeChild(this._canvas.lastChild)}};_.prototype._update=function(){var t=this._svgError||this._img||this._svg;if(t){var e=this._x-(this._imageW-this._canvas.clientWidth)/2;var i=this._y-(this._imageH-this._canvas.clientHeight)/2;var s="matrix("+this._s+",0,0,"+this._s+","+e+","+i+")";t.style.transform=s;t.style.webkitTransform=s;t.style.msTransform=s;t.style.MozTransform=s;t.style.OTransform=s}};_.prototype.zoomTo=function(){if(this._isRedlineActivated&&!this._redlineHandler){u.info("zoomTo() method is disabled when Redlining is activated");return this}if(this._svgError){this._imageW=550;this._imageH=512}else if(this._svg){this._svg.width=1024;this._imageW=this._svg.clientWidth;this._imageH=this._svg.clientHeight}else if(this._img){this._imageW=this._img.width;this._imageH=this._img.height}else{return this}if(!this._imageW||!this._imageH||!this._canvas.clientWidth||!this._canvas.clientHeight){return this}var t=Math.min(this._canvas.clientWidth/this._imageW,this._canvas.clientHeight/this._imageH);if(this._redlineHandler){this._redlineHandler.pan(-this._x,-this._y);this._redlineHandler.zoom(t/this._s,this._canvas.clientWidth*.5,this._canvas.clientHeight*.5)}this._bestFitScale=t;this._s=t;this._x=0;this._y=0;this._update();this._canvas.style.visibility="visible";return this};_.prototype.loadUrl=function(t,e,i,s,r){if(/^(svg)$/.test(r.toLowerCase())){this._reset();this._svg=document.createElement("object");this._svg.setAttribute("type","image/svg+xml");this._svg.setAttribute("data",t);this._svg.setAttribute("id",this._svgid);this._svg.setAttribute("class","SVGImage");this._svg.setAttribute("width",1024);this._canvas.appendChild(this._svg);var n=document.createElement("div");n.style.position="absolute";n.style.top=0;n.style.left=0;n.style.height="100%";n.style.width="100%";this._canvas.appendChild(n);this._svg.onload=function(){this._svg.onload=null;setTimeout(function(){this.zoomTo();if(e){e()}}.bind(this),0)}.bind(this);this._svg.onerror=function(){u.error(l().getText(h.VIT1.summary),h.VIT1.code,"sap.ui.vk.NativeViewport");this._reset();if(i){i()}}.bind(this);this._svg.src=t;return this}else if(/^(jpg|jpeg|png|gif|bmp|tif|tiff)$/.test(r.toLowerCase())){this._reset();this._img=new Image;this._img.draggable=false;this._img.onload=function(){setTimeout(function(){this.zoomTo();this._canvas.appendChild(this._img);if(e){e()}}.bind(this),0)}.bind(this);this._img.onerror=function(){u.error(l().getText(h.VIT2.summary),h.VIT2.code,"sap.ui.vk.NativeViewport");if(i){i()}};this._img.src=t;return this}else{u.error(l().getText(h.VIT3.summary),h.VIT3.code,"sap.ui.vk.NativeViewport");if(i){i()}}};_.prototype.loadFailed=function(t){this._reset();this._svgError=document.createElement("div");this._svgError.className="svgErrorContainer";var e="http://www.w3.org/2000/svg";this._svgErrorElement=document.createElementNS(e,"svg");this._svgErrorElement.setAttribute("width","550px");this._svgErrorElement.setAttribute("height","512px");this._svgErrorElement.setAttribute("viewBox","-244 -244 512 512");this._svgErrorElement.setAttribute("enable-background","new -244 -244 512 512");this._svgErrorElement.setAttribute("id","SVGError");var i=document.createElementNS(e,"rect");i.setAttribute("fill","#FFFFFF");i.setAttribute("x","-244");i.setAttribute("y","-244");i.setAttribute("width","512");i.setAttribute("height","512");i.setAttribute("opacity","0.1");this._svgErrorElement.appendChild(i);var s=document.createElementNS(e,"path");s.setAttribute("fill","#474747");s.setAttribute("d","M12.833,89.742c-70.781,0-128.366-57.584-128.366-128.366c0-70.781,57.584-128.365,128.366-128.365 s128.365,57.584,128.365,128.365C141.198,32.158,83.614,89.742,12.833,89.742z M12.833-146.989 c-59.753,0-108.366,48.612-108.366,108.365c0,59.752,48.613,108.366,108.366,108.366S121.198,21.129 121.198-38.624 C121.198-98.376,72.586-146.989,12.833-146.989z");s.setAttribute("opacity","0.3");this._svgErrorElement.appendChild(s);var r=document.createElementNS(e,"rect");r.setAttribute("fill","#474747");r.setAttribute("x","-2.167");r.setAttribute("y","-120.847");r.setAttribute("width","30");r.setAttribute("height","119.447");r.setAttribute("fill","#474747");r.setAttribute("opacity","0.3");this._svgErrorElement.appendChild(r);var n=document.createElementNS(e,"rect");n.setAttribute("fill","#474747");n.setAttribute("x","-2.167");n.setAttribute("y","13.6");n.setAttribute("width","30");n.setAttribute("height","30");n.setAttribute("opacity","0.3");this._svgErrorElement.appendChild(n);var o=document.createElementNS(e,"path");o.setAttribute("fill","#474747");o.setAttribute("d","M10.833,87.33c-70.781,0-128.366-57.584-128.366-128.365c0-70.781,57.584-128.365,128.366-128.365 s128.365,57.584,128.365,128.365C139.198,29.746,81.614,87.33,10.833,87.33z M10.833-149.4 c-59.753,0-108.366,48.612-108.366,108.365S-48.92,67.33,10.833,67.33S119.198,18.718,119.198-41.035S70.586-149.4,10.833-149.4z");this._svgErrorElement.appendChild(o);var h=document.createElementNS(e,"rect");h.setAttribute("fill","#474747");h.setAttribute("x","-4.167");h.setAttribute("y","-123.259");h.setAttribute("width","30");h.setAttribute("height","119.447");h.setAttribute("fill","#474747");this._svgErrorElement.appendChild(h);var a=document.createElementNS(e,"rect");a.setAttribute("fill","#474747");a.setAttribute("x","-4.167");a.setAttribute("y","11.188");a.setAttribute("width","30");a.setAttribute("height","30");a.setAttribute("fill","#474747");this._svgErrorElement.appendChild(a);var d=document.createElementNS(e,"text");d.setAttribute("id","textError");d.setAttribute("left","auto");d.setAttribute("right","auto");d.setAttribute("y","150");d.setAttribute("x","10");d.setAttribute("display","block");d.setAttribute("text-anchor","middle");d.setAttribute("fill","#474747");d.style.fontFamily="Arial";d.setAttribute("font-size","32");d.textContent=t?t:l().getText("VIEWPORT_MESSAGEUNSUPPORTEDFILEFORMAT");this._svgErrorElement.appendChild(d);this._svgError.appendChild(this._svgErrorElement);this.zoomTo();this._canvas.appendChild(this._svgError);return this};_.prototype.beginGesture=function(t,e){this._gx=(t-this._canvas.clientWidth/2-this._x)/this._s;this._gy=(e-this._canvas.clientHeight/2-this._y)/this._s;return this};_.prototype.endGesture=function(){this._gx=0;this._gy=0;return this};_.prototype.pan=function(t,e){if(this._svgError){return this}if(this._redlineHandler){this._redlineHandler.pan(t,e)}this._x+=t;this._y+=e;this._update();this.fireMove({pan:{x:t,y:e},zoom:1});return this};_.prototype.rotate=function(t,e){return this.pan(t,e)};_.prototype._getZoomInLimit=function(){return 500};_.prototype._getZoomOutLimit=function(){return this.getLimitZoomOut()?this._bestFitScale*.25:1e-4};_.prototype._getZoomFactor=function(){return this._s};_.prototype.zoom=function(t){if(this._svgError){return this}var e=this._gx*this._s;var i=this._gy*this._s;var s=this._s;this._s=Math.min(Math.max(this._s*t,this._getZoomOutLimit()),this._getZoomInLimit());t=this._s/s;if(this._redlineHandler){this._redlineHandler.zoom(t)}var r=this._gx*this._s;var n=this._gy*this._s;var o=e-r;var h=i-n;this._x+=o;this._y+=h;this._update();this.fireMove({pan:{x:o,y:h},zoom:t});return this};_.prototype.tap=function(t,e,i){if(i){this.zoomTo()}return this};_.prototype.queueCommand=function(t){t();return this};_.prototype.getViewInfo=function(){var t={};t.camera=[this._s,0,0,this._s,this._x,this._y];return t};_.prototype.setViewInfo=function(t){if(this._svgError){return this}var e=t.camera;this._s=e[0];this._x=e[4];this._y=e[5];this._update();return this};_.prototype.getOutputSize=function(){var t=this.getDomRef().getBoundingClientRect();return{left:t.width/2,top:t.height/2,sideLength:1024}};_.prototype.onSetContentConnector=function(t){t.attachContentReplaced(this._onContentReplaced,this);this._setImage(t.getContent())};_.prototype.onUnsetContentConnector=function(t){this._setImage(null);t.detachContentReplaced(this._onContentReplaced,this)};_.prototype._onContentReplaced=function(t){this._setImage(t.getParameter("newContent"))};_.prototype._setImage=function(t){this._reset();if(t instanceof HTMLObjectElement){this._svg=t;t.setAttribute("id",this._svgid);t.onload=function(){t.onload=null;setTimeout(function(){this.zoomTo()}.bind(this),0)}.bind(this);if(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge){setTimeout(function(){this.zoomTo()}.bind(this),0)}this._canvas.appendChild(t);var e=document.createElement("div");e.style.position="absolute";e.style.top=0;e.style.left=0;e.style.height="100%";e.style.width="100%";this._canvas.appendChild(e)}else if(t instanceof HTMLImageElement){this._img=t;t.draggable=false;setTimeout(function(){this.zoomTo();this._canvas.appendChild(t)}.bind(this),0)}return this};var c=2;var p=2;[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(t){_.prototype["onsap"+t.key]=function(e){this.beginGesture(this.$().width()/2,this.$().height()/2);this.pan(t.dx,t.dy);this.endGesture();e.preventDefault();e.stopPropagation()}});[{key:"left",dx:-c,dy:0},{key:"right",dx:+c,dy:0},{key:"up",dx:0,dy:-c},{key:"down",dx:0,dy:+c}].forEach(function(t){_.prototype["onsap"+t.key+"modifiers"]=function(e){if(e.shiftKey&&!(e.ctrlKey||e.altKey||e.metaKey)){this.beginGesture(this.$().width()/2,this.$().height()/2);this.rotate(t.dx,t.dy);this.endGesture();e.preventDefault();e.stopPropagation()}}});[{key:"minus",d:.98},{key:"plus",d:1.02}].forEach(function(t){_.prototype["onsap"+t.key]=function(e){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(t.d);this.endGesture();e.preventDefault();e.stopPropagation()}});_.prototype._activateRedline=function(){this._isRedlineActivated=true};_.prototype._deactivateRedline=function(){this._isRedlineActivated=false};return _});