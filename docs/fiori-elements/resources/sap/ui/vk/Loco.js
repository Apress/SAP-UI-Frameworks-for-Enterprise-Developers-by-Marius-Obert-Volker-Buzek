/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider"],function(t){"use strict";var e=250;var i=t.extend("sap.ui.vk.Loco",{metadata:{library:"sap.ui.vk",publicMethods:["addHandler","removeHandler"]},constructor:function(e){if(i._instance&&this.viewport===e){return i._instance}t.apply(this);this._handlers=[];this._gesture=false;this._n=0;this._touchStart=0;this._touchOrigin={x:0,y:0};this._touchMoved=false;this._clickTimer=0;this._clickFunc=null;if(e){this.attachViewportEventHandlers(e)}i._instance=this}});i.prototype.destroy=function(){if(this._clickTimer>0){clearTimeout(this._clickTimer);this._clickTimer=0;this._clickFunc=null}this._handlers.splice()};function n(t){var e=[];var i={points:e,buttons:t.buttons||0,handled:false,passEvent:false,event:t,timeStamp:t.timeStamp,scroll:t.wheelDelta};if(t.touches&&t.touches.length>0){for(var n=0;n<t.touches.length;n++){var s=t.touches[n];e.push({x:s.pageX,y:s.pageY})}}else if(t.pageX!==undefined){e.push({x:t.pageX,y:t.pageY})}else{e.push({x:t.originalEvent.pageX,y:t.originalEvent.pageY})}if(t.buttons&2&&e.length===1){e.push(e[0])}i.n=e.length;if(i.n===2){var h=e[0].x-e[1].x,r=e[0].y-e[1].y;i.x=(e[0].x+e[1].x)*.5;i.y=(e[0].y+e[1].y)*.5;i.d=Math.sqrt(h*h+r*r)}else{i.x=e[0].x;i.y=e[0].y;i.d=0}return i}i.prototype.attachViewportEventHandlers=function(t){this.viewport=t;t.ontouchstart=function(t){if(!t.isMarked()){var e=n(t);if(this._gesture){this._endGesture(e);e.handled=false}this._beginGesture(e)}}.bind(this);t.ontouchend=function(t){var e=n(t);if(e.buttons>0){var i=function(t){this._move(n(t))}.bind(this);var s=function(t){this._endGesture(n(t));document.removeEventListener("mousemove",i);document.removeEventListener("mouseup",s)}.bind(this);document.addEventListener("mousemove",i);document.addEventListener("mouseup",s);return}this._endGesture(e);if(t.touches.length>0){e.handled=false;this._beginGesture(e)}}.bind(this);if(sap.ui.Device.support.touch){t.attachBrowserEvent("touchmove",function(t){this._move(n(t))}.bind(this))}t.attachBrowserEvent("mousemove",function(t){this._move(n(t))}.bind(this));t.ontap=function(t){if(!t.isMarked()&&!this._touchMoved){var i=n(t);if(this._clickTimer>0){this._click(i,true)}else{this._clickFunc=this._click.bind(this,i,false);this._clickTimer=setTimeout(this._clickFunc,e)}}}.bind(this);t.attachBrowserEvent(sap.ui.Device.browser.firefox?"DOMMouseScroll":"mousewheel",function(t){if(!t.isMarked()){var e=t.originalEvent;var i={x:e.pageX,y:e.pageY,d:0,buttons:t.buttons,scroll:e.detail?e.detail*-40:e.wheelDelta,n:2,points:[{x:e.pageX,y:e.pageY},{x:e.pageX,y:e.pageY}],handled:false};this._beginGesture(i);i.points[0].y-=i.scroll*.2;i.points[1].y+=i.scroll*.2;i.d=Math.abs(i.scroll)*.4;i.handled=false;this._move(i);i.handled=false;this._endGesture(i);if(i.handled){t.setMarked();if(!i.passEvent){t.preventDefault()}}}},this);t.oncontextmenu=function(t){var e=n(t);this._contextMenu(e)}.bind(this);t.attachBrowserEvent("keyup",function(t){this._keyEventHandler(t)},this)};i.prototype.addHandler=function(t,e){if(!this.viewport){this.attachViewportEventHandlers(t.getViewport())}t.priority=e|0;if(this._handlers.indexOf(t)===-1){this._handlers.push(t)}this._handlers.sort(function(t,e){return t.priority-e.priority})};i.prototype.removeHandler=function(t){var e=this._handlers.indexOf(t);if(e>=0){this._handlers.splice(e,1)}};i.prototype._handleInput=function(t,e){for(var i=this._handlers.length-1;i>=0&&!e.handled;i--){if(this._handlers[i][t]){this._handlers[i][t](e)}}if(e.handled&&e.event){if(!e.passEvent){e.event.preventDefault()}}};i.prototype._beginGesture=function(t){this._handleInput("beginGesture",t);this._touchStart=t.timeStamp;this._touchMoved=false;this._gesture=true;this._touchOrigin.x=t.x;this._touchOrigin.y=t.y;this._n=t.n};i.prototype._move=function(t){if(this._clickFunc!=null){this._clickFunc()}if(this._gesture&&this._n===t.n){if(!this._touchMoved){this._touchMoved=t.timeStamp-this._touchStart>200&&(Math.abs(this._touchOrigin.x-t.x)>3||Math.abs(this._touchOrigin.y-t.y)>3)}this._handleInput("move",t)}else{this._handleInput("hover",t)}};i.prototype._endGesture=function(t){if(!this._gesture){return}this._handleInput("endGesture",t);this._gesture=false};i.prototype._click=function(t,e){if(this._clickTimer>0){clearTimeout(this._clickTimer);this._clickTimer=0;this._clickFunc=null}this._handleInput(e?"doubleClick":"click",t)};i.prototype._contextMenu=function(t){this._handleInput("contextMenu",t)};i.prototype._keyEventHandler=function(t){this._handleInput("keyEventHandler",t)};return i});