/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/api/Version","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/write/_internal/FlexInfoSession"],function(e,r,a,t,i,n,l,s,o,u){"use strict";var f={flp:{set:function(e,r,a){e[r]=[a];return e},get:function(e,r){return e[r]&&e[r][0]},remove:function(e,r){delete e[r];return e}},standalone:{set:function(e,r,t){return a.handleUrlParameters(e,r,t)},get:function(e,r){return a.getParameter(r)},remove:function(e,r,t){return a.handleUrlParameters(e,r,t)}}};function c(e){var r=!!a.getParameter(i.UrlParameter,e.URLParsingService);if(r){return Promise.resolve(false)}return l.isVersioningEnabled(e.layer).then(function(r){return r&&n.isDraftAvailable({control:e.selector,layer:e.layer})})}function v(e){var a=this.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);var t=e.layer===r.USER;if(t||a){return Promise.resolve(false)}return s.hasHigherLayerChanges({selector:e.selector,ignoreMaxLayerParameter:e.ignoreMaxLayerParameter,upToLayer:e.layer,includeCtrlVariants:e.includeCtrlVariants,includeDirtyChanges:true}).then(function(r){return r||m(e)})}function m(a){if(e.isOverLayer(r.USER,a.layer)){return o.checkSVMControlsForDirty(t.getFlexReferenceForControl(a.selector))}return false}function h(e){var r=u.get(e.selector);if(r&&r.initialAllContexts){return false}if(r===null||r.allContextsProvided===undefined){var a={selector:e.selector,layer:e.layer};return s.getResetAndPublishInfo(a).then(function(a){if(r===null||!r.initialAllContexts){a.initialAllContexts=true}u.set(a,e.selector);return!a.allContextsProvided})}r.initialAllContexts=true;u.set(r,e.selector);return!r.allContextsProvided}function P(e){var r=u.get(e);return r&&!r.allContextsProvided}var A={getReloadReasonsForStart:function(e){return Promise.all([v.call(this,e),c(e),h(e)]).then(function(r){e.hasHigherLayerChanges=r[0];e.isDraftAvailable=r[1];e.allContexts=r[2];return e})},hasVersionParameterWithValue:function(e,r){return a.hasParameterAndValue(i.UrlParameter,e.value,r)},removeInfoSessionStorage:function(e){u.remove(e)},hasMaxLayerParameterWithValue:function(r,t){var i=e.FL_MAX_LAYER_PARAM;return a.hasParameterAndValue(i,r.value,t)},handleUrlParameters:function(r,a){var t=false;if(!r.ignoreMaxLayerParameter&&r.hasHigherLayerChanges){r.parameters=f[a].remove(r.parameters,e.FL_MAX_LAYER_PARAM,r.layer);t=true}var n=f[a].get(r.parameters,i.UrlParameter);if(r.versionSwitch&&n!==r.version){r.parameters=f[a].remove(r.parameters,i.UrlParameter,n);r.parameters=f[a].set(r.parameters,i.UrlParameter,r.version);t=true}if(n&&r.removeVersionParameter||n===i.Number.Draft&&r.removeDraft){r.parameters=f[a].remove(r.parameters,i.UrlParameter,n);t=true}return t},handleParametersOnStart:function(r,a){var t=false;if(r.hasHigherLayerChanges){r.parameters=f[a].set(r.parameters,e.FL_MAX_LAYER_PARAM,r.layer);t=true}if(r.isDraftAvailable){r.parameters=f[a].set(r.parameters,i.UrlParameter,i.Number.Draft);t=true}return t},initialDraftGotActivated:function(e){if(e.versioningEnabled){var r=this.hasVersionParameterWithValue({value:i.Number.Draft},e.URLParsingService);return!n.isDraftAvailable({control:e.selector,layer:e.layer})&&r}return false},getReloadMethod:function(e){var r={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};e.reloadMethod=r.NOT_NEEDED;e.isDraftAvailable=e.isDraftAvailable||A.hasVersionParameterWithValue({value:i.Number.Draft},e.URLParsingService);e.hasVersionUrlParameter=!!a.getParameter(i.UrlParameter,e.URLParsingService);if(e.activeVersion&&e.activeVersion!==i.Number.Original&&e.hasVersionUrlParameter){e.activeVersionNotSelected=!A.hasVersionParameterWithValue({value:e.activeVersion},e.URLParsingService)}e.hasHigherLayerChanges=A.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);e.initialDraftGotActivated=A.initialDraftGotActivated(e);if(e.initialDraftGotActivated){e.isDraftAvailable=false}e.allContexts=P(e.selector);if(e.changesNeedReload||e.isDraftAvailable||e.hasHigherLayerChanges||e.initialDraftGotActivated||e.activeVersionNotSelected||e.allContexts){e.reloadMethod=r.RELOAD_PAGE;if(!e.changesNeedReload&&a.getUshellContainer()){e.reloadMethod=r.VIA_HASH}}u.remove(e.selector);return e}};return A});