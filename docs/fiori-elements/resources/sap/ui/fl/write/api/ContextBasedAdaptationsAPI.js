/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/Settings","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/Utils","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/model/json/JSONModel"],function(e,r,t,n,a,o){"use strict";var i={};var s={};function d(e){var n=r.getFlexReferenceForControl(e);if(!n){throw Error("The application ID could not be determined")}return t.normalizeReference(n)}function l(e,r,t){if(e.status===r){a.onAllChangesSaved({reference:t.reference,layer:t.layer,contextBasedAdaptation:true})}return e}s.initialize=function(r){if(!r.layer){return Promise.reject("No layer was provided")}if(!r.control){return Promise.reject("No control was provided")}var t=d(r.control);r.reference=t;var n=r.layer;return e.getInstance().then(function(e){var t=e.isContextBasedAdaptationEnabled();var n=t?s.load(r):Promise.resolve({adaptations:[]});return n}).then(function(e){return s.createModel(e.adaptations)}).then(function(e){i[t]=i[t]||{};i[t][n]=i[t][n]||{};i[t][n]=e;return i[t][n]})};s.createModel=function(e){if(!Array.isArray(e)){throw Error("Adaptations model can only be initialized with an array of adaptations")}var r=new o({adaptations:e,count:e.length,displayedAdaptation:e.length>0?e[0]:{}});r.updateAdaptations=function(e){r.setProperty("/adaptations",e);r.setProperty("/count",e.length);if(e.length>0){var t=r.getProperty("/adaptations/0/");r.setProperty("/displayedAdaptation",t)}r.updateBindings(true)};r.insertAdaptation=function(t){e=r.getProperty("/adaptations");e.splice(t.priority,0,t);delete t.priority;r.updateAdaptations(e)};return r};s.getAdaptationsModel=function(e){if(!e.layer){throw Error("No layer was provided")}if(!e.control){throw Error("No control was provided")}e.reference=d(e.control);var r=e.reference;var t=e.layer;if(!s.hasAdaptationsModel(e)){throw Error("Adaptations model for reference '"+r+"' and layer '"+t+"' were not initialized.")}return i[r][t]};s.hasAdaptationsModel=function(e){var r=e.reference;var t=e.layer;return i[r]&&i[r][t]};s.clearInstances=function(){i={}};s.create=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.contextBasedAdaptation){return Promise.reject("No contextBasedAdaptation was provided")}e.contextBasedAdaptation.id=t.createDefaultFileName();e.reference=d(e.control);return n.contextBasedAdaptation.create({layer:e.layer,flexObject:e.contextBasedAdaptation,reference:e.reference,parentVersion:a.getVersionsModel({layer:e.layer,reference:e.reference}).getProperty("/displayedVersion")}).then(function(r){var t=this.getAdaptationsModel(e);t.insertAdaptation(e.contextBasedAdaptation);return l(r,201,e)}.bind(this))};s.reorder=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.parameters||!e.parameters.priorities){return Promise.reject("No valid priority list was provided")}e.reference=d(e.control);return n.contextBasedAdaptation.reorder({layer:e.layer,flexObjects:e.parameters,reference:e.reference,parentVersion:a.getVersionsModel({layer:e.layer,reference:e.reference}).getProperty("/displayedVersion")}).then(function(r){return l(r,204,e)})};s.load=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}e.reference=d(e.control);return n.contextBasedAdaptation.load({layer:e.layer,flexObject:e.parameters,reference:e.reference,version:a.getVersionsModel({layer:e.layer,reference:e.reference}).getProperty("/displayedVersion")}).then(function(e){if(!e){e={adaptations:[]}}return e})};return s});