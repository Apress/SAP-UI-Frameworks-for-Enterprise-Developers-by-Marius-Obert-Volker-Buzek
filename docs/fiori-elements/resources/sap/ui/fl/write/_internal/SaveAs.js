/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/Utils","sap/base/Log","sap/ui/fl/Layer","sap/base/util/merge","sap/base/util/restricted/_omit","sap/ui/fl/registry/Settings"],function(e,t,n,r,a,i,o,s,c,u){"use strict";function p(e){return u.getInstance().then(function(t){if(!e.package&&(e.layer===o.VENDOR||e.layer===o.CUSTOMER_BASE&&!t.isAtoEnabled())){return Promise.reject("Package must be provided or is valid")}if(e.isForSmartBusiness&&(e.package!=="$TMP"&&e.package!=="")&&!e.transport&&!t.isAtoEnabled()){return Promise.reject("Transport must be provided")}if(e.isForSmartBusiness&&e.transport||e.package==="$TMP"){return Promise.resolve({packageName:e.package,transport:e.transport})}return Promise.resolve({packageName:"",transport:""})})}function l(e,t){var n=t.transport?e.setTransportRequest(t.transport):Promise.resolve();return n.then(function(){if(t.packageName){return e.setPackage(t.packageName)}return Promise.resolve()})}function f(e){var t=[];e.forEach(function(e){var r={changeType:e.getChangeType(),content:e.getContent()};if(e.getTexts()){r.texts=e.getTexts()}t.push(n.createNew(r))});return Promise.all(t)}function g(e,t){var n={reference:t.getId()};var r=a.createNamespace(n,"changes");var i=e.getFlexObjectMetadata();i.namespace=r;i.reference=t.getId();e.setFlexObjectMetadata(i)}function h(e,t){var n=[];e.forEach(function(e){e.replaceHostingIdForTextKey(t.getId(),t.getReference(),e.getContent(),e.getTexts());n.push(t.addDescriptorInlineChange(e))});return Promise.all(n)}function d(e){var n=r.getFlexControllerInstance(e)._oChangePersistence;if(!n){return[]}return n.getDirtyChanges().filter(function(e){return t.getChangeTypes().includes(e.getChangeType())})}function A(e){var t=r.getFlexControllerInstance(e)._oChangePersistence;if(!t){return[]}var n=t.getDirtyChanges();n=n.slice();return n}function m(e){d(e).forEach(function(n){if(t.getChangeTypes().includes(n.getChangeType())){r.getFlexControllerInstance(e)._oChangePersistence.deleteChange(n)}})}function v(e,t){if(!e){throw new Error("App variant with ID: "+t.id+"does not exist")}t.package=e.getPackage();t.layer=e.getDefinition().layer;return p(t).then(function(t){return l(e,t)}).then(function(){return e})}var P={saveAs:function(n){var a;var o;return e.prepareCreate(n).then(function(e){a=s({},e);return p(n)}).then(function(e){return l(a,e)}).then(function(){var e=[];A(n.selector).forEach(function(n){if(t.getChangeTypes().includes(n.getChangeType())){e.push(n)}else{g(n,a)}});return f(e)}).then(function(e){return h(e,a)}).then(function(){return a.submit().catch(function(e){e.messageKey="MSG_SAVE_APP_VARIANT_FAILED";throw e})}).then(function(e){o=s({},e);m(n.selector);var t=r.getFlexControllerInstance(n.selector);var a=A(n.selector);if(a.length){return t.saveAll(r.getAppComponentForSelector(n.selector),true).catch(function(e){return this.deleteAppVariant({id:n.id}).then(function(){e.messageKey="MSG_COPY_UNSAVED_CHANGES_FAILED";throw e})}.bind(this))}return Promise.resolve()}.bind(this)).then(function(){return o}).catch(function(e){if(d(n.selector).length){m(n.selector)}i.error("the app variant could not be created.",e.message||e);throw e})},updateAppVariant:function(n){var r;var a;return e.prepareUpdate(c(n,"selector")).catch(function(e){e.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw e}).then(function(e){if(!e){throw new Error("App variant with ID: "+n.id+"does not exist")}r=s({},e);n.package=r.getPackage();n.layer=r.getDefinition().layer;return p(n)}).then(function(e){return l(r,e)}).then(function(){var e=[];d(n.selector).forEach(function(n){if(t.getChangeTypes().includes(n.getChangeType())){e.push(n)}});return f(e)}).then(function(e){return h(e,r)}).then(function(){return r.submit().catch(function(e){if(n.isForSmartBusiness){m(n.selector);throw e}e.messageKey="MSG_UPDATE_APP_VARIANT_FAILED";throw e})}).then(function(e){a=s({},e);m(n.selector);return a}).catch(function(e){if(d(n.selector).length){m(n.selector)}i.error("the app variant could not be updated.",e.message||e);throw e})},deleteAppVariant:function(t){return e.prepareDelete(c(t,"selector")).catch(function(e){e.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw e}).then(function(e){return t.isForSmartBusiness?Promise.resolve(e):v(e,t)}).then(function(e){return e.submit().catch(function(e){if(e==="cancel"){return Promise.reject("cancel")}e.messageKey="MSG_DELETE_APP_VARIANT_FAILED";throw e})}).catch(function(e){if(e==="cancel"){return Promise.reject("cancel")}i.error("the app variant could not be deleted.",e.message||e);throw e})}};return P});