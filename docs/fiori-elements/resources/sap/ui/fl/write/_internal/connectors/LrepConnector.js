/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/ui/fl/write/connectors/BaseConnector","sap/ui/fl/initial/_internal/connectors/LrepConnector","sap/ui/fl/initial/_internal/connectors/Utils","sap/ui/fl/write/_internal/connectors/Utils","sap/ui/fl/write/_internal/transport/TransportSelection","sap/ui/fl/registry/Settings","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/core/Component","sap/ui/core/BusyIndicator","sap/base/Log","sap/m/MessageBox","sap/base/util/restricted/_pick"],function(e,t,n,r,a,i,s,o,u,l,c,f,p,d){"use strict";var T={FLEX_INFO:"/flex/info/",PUBLISH:"/actions/make_changes_transportable/",CHANGES:"/changes/",CONDENSE:"/actions/condense/",VARIANTS:"/variants/",SETTINGS:"/flex/settings",TOKEN:"/actions/getcsrftoken/",APPVARIANTS:"/appdescr_variants/",APPVARIANTS_OVERVIEW:"/app_variant_overview/",UI2PERSONALIZATION:"/ui2personalization/",CONTEXTS:"/flex/contexts/",VERSIONS:{GET:"/flex/versions/",ACTIVATE:"/flex/versions/activate/",DISCARD:"/flex/versions/draft/",PUBLISH:"/flex/versions/publish/"},CONTEXT_BASED_ADAPTATION:"/flex/apps/",MANI_FIRST_SUPPORTED:"/sap/bc/ui2/app_index/ui5_app_mani_first_supported"};var g=function(e){var t;if(e.isLegacyVariant){t=T.VARIANTS}else if(e.isAppVariant){t=T.APPVARIANTS}else if(e.isContextSharing){t=T.CONTEXTS}else if(e.isCondensingEnabled){t=T.CONDENSE}else if(e.isContextBasedAdaptationEnabled){t=T.CONTEXT_BASED_ADAPTATION+e.reference+"/adaptations/";delete e.reference}else{t=T.CHANGES}var i=e.transport?{changelist:e.transport}:{};if(e.skipIam){i.skipIam=e.skipIam}if(e.parentVersion){i.parentVersion=e.parentVersion}r.addSAPLogonLanguageInfo(i);n._addClientInfo(i);if(e.flexObject&&!e.isAppVariant){e.fileName=e.flexObject.fileName}var s=r.getUrl(t,e,i);delete e.reference;delete e.fileName;var o=r.getUrl(T.TOKEN,e);var u=a.getRequestOptions(n,o,e.flexObjects||e.flexObject,"application/json; charset=utf-8","json");return a.sendRequest(s,e.method,u)};var v=function(e){var t=e.getDefinition().layer===o.VENDOR?e.getPackage():"";return{package:t,namespace:e.getNamespace(),name:e.getDefinition().fileName,type:e.getDefinition().fileType}};var E=function(e){var t;if(e.transport){t=Promise.resolve({transport:e.transport})}else if(e.isForSmartBusiness){return Promise.resolve()}else{var n=v(e.appVariant);t=(new i).openTransportSelection(n)}return t.then(function(e){if(e==="cancel"){return Promise.reject("cancel")}if(e&&e.transport!==undefined){return e.transport}return Promise.reject(new Error("Transport information could not be determined"))})};function O(e){e.version=e.versionId;delete e.versionId;return e}return e({},t,{initialConnector:n,layers:n.layers,reset:function(e){c.show(0);var t=[];var u=Promise.resolve();if(e.layer!==o.USER){t=e.changes;u=s.getInstance().then(function(n){if(!n.isProductiveSystem()){return(new i).setTransports(t,l.get(e.reference)).then(function(){t.some(function(t){if(t.getRequest()){e.changelist=t.getRequest();return true}return false})})}})}return u.then(function(){c.show(0);var t=["reference","layer","changelist","generator"];var i=d(e,t);n._addClientInfo(i);if(e.selectorIds){i.selector=e.selectorIds}if(e.changeTypes){i.changeType=e.changeTypes}delete e.reference;var s=r.getUrl(T.CHANGES,e,i);var o=r.getUrl(T.TOKEN,e);var u=a.getRequestOptions(n,o);return a.sendRequest(s,"DELETE",u).then(function(e){if(e&&e.response){e.response.forEach(function(e){e.fileName=e.name;delete e.name})}c.hide();return e}).catch(function(e){c.hide();return Promise.reject(e)})})},publish:function(e){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");var n=function(n){c.hide();var r=t.getText("MSG_TRANSPORT_ERROR",n?[n.message||n]:undefined);var a=t.getText("HEADER_TRANSPORT_ERROR");f.error("transport error: "+n);p.show(r,{icon:p.Icon.ERROR,title:a,styleClass:e.transportDialogSettings.styleClass});return"Error"};var r=new i;return r.openTransportSelection(null,e.transportDialogSettings.rootControl,e.transportDialogSettings.styleClass).then(function(n){if(r.checkTransportInfo(n)){c.show(0);var a={reference:e.reference,layer:e.layer};return r._prepareChangesForTransport(n,e.localChanges,e.appVariantDescriptors,a).then(function(){c.hide();if(n.transport==="ATO_NOTIFICATION"){return t.getText("MSG_ATO_NOTIFICATION")}return t.getText("MSG_TRANSPORT_SUCCESS")})}return"Cancel"})["catch"](n)},getFlexInfo:function(e){var t=["layer"];var a=d(e,t);n._addClientInfo(a);var i=r.getUrl(T.FLEX_INFO,e,a);return r.sendRequest(i,"GET",{initialConnector:n}).then(function(e){return e.response})},getContexts:function(e){var t=["type","$skip","$filter"];var a=d(e,t);n._addClientInfo(a);var i=r.getUrl(T.CONTEXTS,e,a);return r.sendRequest(i,"GET",{initialConnector:n}).then(function(e){return e.response})},loadContextDescriptions:function(e){e.method="POST";e.isContextSharing=true;return g(e).then(function(e){return e.response})},isContextSharingEnabled:function(){return Promise.resolve(true)},loadFeatures:function(e){if(n.settings){return Promise.resolve(n.settings)}var t={};n._addClientInfo(t);var a=r.getUrl(T.SETTINGS,e,t);return r.sendRequest(a,"GET",{initialConnector:n}).then(function(e){e.response.isVariantAdaptationEnabled=!!e.response.isPublicLayerAvailable;e.response.isContextSharingEnabled=true;e.response.isLocalResetEnabled=true;return e.response})},write:function(e){e.method="POST";return g(e)},condense:function(e){e.method="POST";e.isCondensingEnabled=true;return g(e)},update:function(e){if(e.flexObject.fileType==="variant"){e.isLegacyVariant=true}e.method="PUT";return g(e)},remove:function(e){var t={namespace:e.flexObject.namespace,layer:e.flexObject.layer};if(e.transport){t.changelist=e.transport}if(e.parentVersion){t.parentVersion=e.parentVersion}n._addClientInfo(t);e.fileName=e.flexObject.fileName;var i=e.flexObject.fileType==="variant"?T.VARIANTS:T.CHANGES;var s=r.getUrl(i,e,t);s=decodeURIComponent(s);delete e.fileName;var o=r.getUrl(T.TOKEN,e);var u=a.getRequestOptions(n,o,undefined,"application/json; charset=utf-8","json");return a.sendRequest(s,"DELETE",u)},appVariant:{getManifirstSupport:function(e){var t=T.MANI_FIRST_SUPPORTED+"/?id="+e.appId;return r.sendRequest(t,"GET",{initialConnector:n}).then(function(e){return e.response})},getManifest:function(e){var t=e.appVarUrl;var r=a.getRequestOptions(n,u.getLrepUrl()+T.TOKEN,undefined,"application/json; charset=utf-8","json");return a.sendRequest(t,"GET",r)},load:function(e){var t=r.getUrl(T.APPVARIANTS,e);var i=a.getRequestOptions(n,u.getLrepUrl()+T.TOKEN,undefined,"application/json; charset=utf-8","json");return a.sendRequest(t,"GET",i)},create:function(e){e.method="POST";e.isAppVariant=true;return g(e)},assignCatalogs:function(e){var t={};t.action=e.action;delete e.action;t.assignFromAppId=e.assignFromAppId;delete e.assignFromAppId;var i=r.getUrl(T.APPVARIANTS,e,t);delete e.reference;var s=r.getUrl(T.TOKEN,e);var o=a.getRequestOptions(n,s,undefined,"application/json; charset=utf-8","json");return a.sendRequest(i,"POST",o)},unassignCatalogs:function(e){var t={};t.action=e.action;delete e.action;var i=r.getUrl(T.APPVARIANTS,e,t);delete e.reference;var s=r.getUrl(T.TOKEN,e);var o=a.getRequestOptions(n,s,undefined,"application/json; charset=utf-8","json");return a.sendRequest(i,"POST",o)},update:function(e){return E(e).then(function(t){if(t){e.transport=t}delete e.isForSmartBusiness;e.method="PUT";e.isAppVariant=true;return g(e)})},remove:function(e){return E(e).then(function(t){var i={};if(t){i.changelist=t}delete e.isForSmartBusiness;var s=r.getUrl(T.APPVARIANTS,e,i);delete e.reference;var o=r.getUrl(T.TOKEN,e);var u=a.getRequestOptions(n,o,undefined,"application/json; charset=utf-8","json");return a.sendRequest(s,"DELETE",u)})},list:function(e){var t={};t.layer=e.layer;t["sap.app/id"]=e.reference;delete e.layer;delete e.reference;var i=r.getUrl(T.APPVARIANTS_OVERVIEW,e,t);var s=a.getRequestOptions(n,undefined,undefined,"application/json; charset=utf-8","json");return a.sendRequest(i,"GET",s)}},contextBasedAdaptation:{create:function(e){e.isContextBasedAdaptationEnabled=true;e.method="POST";return g(e)},reorder:function(e){e.isContextBasedAdaptationEnabled=true;e.method="PUT";return g(e)},load:function(e){var t=["version"];var a=d(e,t);n._addClientInfo(a);e.reference=e.reference+"/adaptations/";var i=r.getUrl(T.CONTEXT_BASED_ADAPTATION,e,a);return r.sendRequest(i,"GET",{initialConnector:n}).then(function(e){return e.response})}},ui2Personalization:{create:function(e){e.initialConnector=this.initialConnector;var t=u.getLrepUrl();var r=a.getRequestOptions(n,t+T.TOKEN,e.flexObjects||e.flexObject,"application/json; charset=utf-8","json");var i=t+T.UI2PERSONALIZATION;return a.sendRequest(i,"PUT",r)},remove:function(e){e.initialConnector=this.initialConnector;var t=r.getUrl(T.UI2PERSONALIZATION,{url:u.getLrepUrl()},{reference:e.reference,containerkey:e.containerKey,itemname:e.itemName});return a.sendRequest(t,"DELETE")}},versions:{load:function(e){var t=a.getRequestOptions(n,r.getUrl(T.TOKEN,e));var i={};r.addSAPLogonLanguageInfo(i);i.limit=e.limit;var s=r.getUrl(T.VERSIONS.GET,e,i);return a.sendRequest(s,"GET",t).then(function(e){return e.response.versions.map(function(e){return O(e)})})},activate:function(e){var t=a.getRequestOptions(n,r.getUrl(T.TOKEN,e),{title:e.title},"application/json; charset=utf-8","json");var i={version:e.version};r.addSAPLogonLanguageInfo(i);var s=r.getUrl(T.VERSIONS.ACTIVATE,e,i);return a.sendRequest(s,"POST",t).then(function(e){var t=e.response;return O(t)})},discardDraft:function(e){var t=a.getRequestOptions(n,r.getUrl(T.TOKEN,e));var i=r.getUrl(T.VERSIONS.DISCARD,e);return a.sendRequest(i,"DELETE",t)},publish:function(e){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");var s=function(n){c.hide();var r=t.getText("MSG_TRANSPORT_ERROR",n?[n.message||n]:undefined);var a=t.getText("HEADER_TRANSPORT_ERROR");f.error("transport error"+n);p.show(r,{icon:p.Icon.ERROR,title:a,styleClass:e.styleClass});return"Error"};var o=new i;return o.openTransportSelection(null,e.rootControl,e.styleClass,false).then(function(i){if(o.checkTransportInfo(i)){c.show(0);if(!i.transport){return Promise.reject(new Error("no transport provided as attribute of mParameters"))}if(!e.reference){return Promise.reject(new Error("no reference provided as attribute of mParameters"))}if(!e.version){return Promise.reject(new Error("no version provided as attribute of mParameters"))}var s={transport:i.transport,version:e.version};var l=r.getUrl(T.VERSIONS.PUBLISH,{url:u.getLrepUrl(),reference:e.reference},s);var f=r.getUrl(T.TOKEN,{url:u.getLrepUrl()});var p=a.getRequestOptions(n,f,undefined,"application/json; charset=utf-8","json");return a.sendRequest(l,"POST",p).then(function(){c.hide();if(i.transport==="ATO_NOTIFICATION"){return t.getText("MSG_ATO_NOTIFICATION")}return t.getText("MSG_TRANSPORT_SUCCESS")})}return"Cancel"})["catch"](s)}}})});