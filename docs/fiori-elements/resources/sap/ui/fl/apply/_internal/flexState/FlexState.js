/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/includes","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/controlVariants/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/write/_internal/FlexInfoSession","sap/ui/fl/LayerUtils","sap/ui/fl/requireAsync","sap/ui/fl/Utils"],function(e,n,t,r,a,i,o,s,c,l,f,p,u,g,d,h,m,v,S,F,R){"use strict";var x={};var y={};var C={};var P={};var b;var D;var I;var V={appDescriptorChanges:{prepareFunction:c,pathInResponse:[]},changes:{initialPreparation:g.uiChanges,prepareFunction:l,pathInResponse:["changes"]},variants:{initialPreparation:g.variants,prepareFunction:p,pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:f,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var O={compVariants:{},variants:{}};function U(e){var n=o.get(e.componentId);e.componentData=e.componentData||n.getComponentData()||{};e.manifest=e.manifest||e.rawManifest||n.getManifestObject();e.reference=e.reference||h.getFlexReference(e)}function j(e){var t=[];n(e.changes,function(e,r){if(Array.isArray(r)){r.forEach(function(e){t.push(s.createFromFileContent(e,null,true))})}else if(e==="comp"){n(r,function(e,n){n.forEach(function(e){t.push(s.createFromFileContent(e,null,true))})})}});return t}function M(e,n,t){var r=V[e].initialPreparation;if(r){var a=r(n);if(a){L(t,a)}}}var z=new u({id:"flexObjects",parameterKey:"reference",executeFunction:function(e,n){if(!y[n]){return[]}var t=y[n].runtimePersistence;return t.flexObjects.concat(t.runtimeOnlyData.flexObjects)}});function _(e,n){if(!y[e]){throw new Error("State is not yet initialized")}if(!y[e].preparedMaps[n]){var t={unfilteredStorageResponse:y[e].unfilteredStorageResponse,storageResponse:y[e].storageResponse,componentId:y[e].componentId,componentData:y[e].componentData,reference:e,runtimePersistence:y[e].runtimePersistence};y[e].preparedMaps[n]=x.callPrepareFunction(n,t);M(n,t,e);z.checkUpdate({reference:e})}return y[e].preparedMaps[n]}function L(e,n){y[e]=r(y[e],n);z.checkUpdate({reference:e})}function k(e){return _(e,"appDescriptorChanges")}function N(e){return _(e,"changes")}function E(e){return _(e,"variants")}function w(e){return _(e,"compVariants")}function A(e){var n=j(e);return{flexObjects:n,runtimeOnlyData:{flexObjects:[]}}}function B(e){var n=e.reference;var t=false;if(!y[n].componentData){var r=o.get(e.componentId);y[n].componentData=r?r.getComponentData():e.componentData;t=true}if(!y[n].storageResponse){y[n].storageResponse=q(y[n].unfilteredStorageResponse);delete y[n].runtimePersistence;t=true}if(!y[n].runtimePersistence){y[n].runtimePersistence=A(y[n].storageResponse);t=true}if(t){z.checkUpdate({reference:n})}}function q(e){var t=r({},e);var i=t.changes;var o=Y("URLParsing");if(S.isLayerFilteringRequired(o)){n(V,function(e,n){n.pathInResponse.forEach(function(e){a.set(e,S.filterChangeDefinitionsByMaxLayer(a.get(e,i),o),i)})})}return t}function T(e){P[e.reference]=d.loadFlexData(e).then(function(n){y[e.reference]=r({},{unfilteredStorageResponse:n,preparedMaps:{},componentId:e.componentId,componentData:e.componentData,partialFlexState:e.partialFlexState});G(e.reference);K(e.reference,n);Object.freeze(y[e.reference].storageResponse);Object.freeze(y[e.reference].unfilteredStorageResponse);return n});return P[e.reference]}function K(e,n){var t=n&&n.changes||{};if(t.info!==undefined){var r=v.getByReference(e);if(r===null){r={}}r.allContextsProvided=t.info.allContextsProvided;v.setByReference(r,e)}}function G(e){var n=Y("ShellNavigation");if(n&&!C[e]){C[e]=J.bind(null,e);n.registerNavigationFilter(C[e])}}function H(e){var n=Y("ShellNavigation");if(n){if(C[e]){n.unregisterNavigationFilter(C[e]);delete C[e]}}}function J(e,n,t){var r=Y("ShellNavigation");if(r){try{var a=S.getMaxLayerTechnicalParameter(n,Y("URLParsing"));var o=S.getMaxLayerTechnicalParameter(t,Y("URLParsing"));if(a!==o){x.rebuildFilteredResponse(e)}}catch(e){i.error(e.message)}return r.NavigationFilterStatus.Continue}return undefined}function Q(e){var n=y[e.reference];if(n.partialFlexState===true&&e.partialFlexState!==true){n.partialFlexState=false;e.partialFlexData=r({},n.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function W(e){var n=y[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}function X(){return Promise.all([R.getUShellService("ShellNavigation"),R.getUShellService("URLParsing")]).then(function(e){b=e[0];D=e[1]}).catch(function(e){i.error("Error getting service from Unified Shell: "+e.message)})}function Y(e){if(R.getUshellContainer()){if(e==="ShellNavigation"){return b}else if(e==="URLParsing"){return D}}return undefined}function Z(){return F("sap/ui/fl/ChangePersistenceFactory").then(function(e){I=e}).catch(function(e){i.error("Error loading modules: "+e.message)})}x.initialize=function(e){return Promise.all([X(),Z()]).then(function(){U(e);var n=e.reference;if(P[n]){return P[n].then(Q.bind(null,e)).then(W).then(function(e){return e.reInitialize?T(e):y[n].unfilteredStorageResponse})}return T(e)}).then(function(e){B(e)}.bind(null,e))};x.isInitialized=function(e){var n=e.reference?e.reference:h.getFlexReferenceForControl(e.control);return!!y[n]};x.clearAndInitialize=function(e){U(e);x.clearState(e.reference);x.clearState(R.normalizeReference(e.reference));return x.initialize(e)};x.clearState=function(e){if(e){H(e);delete y[e];delete P[e];z.clearCachedResult({reference:e});if(I&&(I._instanceCache||{}).hasOwnProperty(e)){I._instanceCache[e].removeDirtyChanges()}}else{Object.keys(y).forEach(function(e){H(e)});y={};P={};z.clearCachedResult()}};x.setInitialNonFlCompVariantData=function(e,n,t,r,a){O.compVariants[e]=O.compVariants[e]||{};O.compVariants[e][n]={};O.compVariants[e][n].standardVariant=t;O.compVariants[e][n].variants=r;O.compVariants[e][n].controlId=a};x.getInitialNonFlCompVariantData=function(e){return O.compVariants[e]};x.setFakeStandardVariant=function(e,n,t){var a=x.getVariantsState(e);if(!a[Object.keys(t)[0]]){r(a,t);O.variants[e]=O.variants[e]||{};O.variants[e][n]=O.variants[e][n]||{};r(O.variants[e][n],t)}};x.resetFakedStandardVariants=function(e,n){if(O.variants[e]){delete O.variants[e][n]}};x.rebuildFilteredResponse=function(e){if(y[e]){y[e].preparedMaps={};y[e].storageResponse=q(y[e].unfilteredStorageResponse);y[e].runtimePersistence=A(y[e].storageResponse);z.checkUpdate({reference:e})}};x.addDirtyFlexObject=function(e,n){if(y[e]){y[e].runtimePersistence.flexObjects.push(n);z.checkUpdate({reference:e})}};x.removeDirtyFlexObject=function(e,n){if(y[e]){var t=y[e].runtimePersistence.flexObjects;var r=t.indexOf(n);t.splice(r,1);z.checkUpdate({reference:e})}};x.getFlexObjectsSelector=function(){return z};x.getUIChanges=function(e){return N(e).changes};x.getAppDescriptorChanges=function(e){return k(e).appDescriptorChanges};x.getVariantsState=function(e){var t=E(e);if(O.variants[e]){n(O.variants[e],function(r,a){if(y[e].componentId===r){n(a,function(e,n){if(!t[e]){t[e]=n}})}})}return t};x.getUI2Personalization=function(e){return y[e].unfilteredStorageResponse.changes.ui2personalization};x.getCompVariantsMap=function(e){return w(e)};x.callPrepareFunction=function(e,n){return V[e].prepareFunction(n)};x.getStorageResponse=function(e){if(P[e]){return P[e].then(function(){return y[e].unfilteredStorageResponse})}return Promise.resolve()};x.getFlexObjectsFromStorageResponse=function(e){return y[e]&&y[e].unfilteredStorageResponse.changes};return x});