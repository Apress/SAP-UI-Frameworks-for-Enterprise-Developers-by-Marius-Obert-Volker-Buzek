/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/ChangePersistenceFactory"],function(e,n,t,i,o,a){"use strict";var r={};function s(e,n){if(n.getSelector().name!==e.extensionPointName){return false}return i.filterChangeByView(e,n)}function g(e,n){if(n.fragmentId){var t=e.getExtensionPointInfo&&e.getExtensionPointInfo();if(t){return n.fragmentId!==t.fragmentId}return true}return false}function l(e,t,i){var o=e.getSelector();if(t.closestAggregationBindingCarrier&&t.closestAggregationBinding){o=n(o,{id:t.closestAggregationBindingCarrier,idIsLocal:false});var a={id:t.targetControl.getId(),idIsLocal:false};if(i){e.originalSelectorToBeAdjusted=a}else{e.setDependentSelectors({originalSelector:a})}e.setContent({boundAggregation:t.closestAggregationBinding})}else{o=n(o,{id:t.targetControl.getId(),idIsLocal:false})}e.setSelector(o)}r.getChangesForExtensionPoint=function(e,n){if(!n.extensionPointName){t.error("Missing name from extension point info!");return Promise.resolve([])}return e.getChangesForComponent().then(function(e){return e.filter(s.bind(undefined,n))})};r.enhanceExtensionPointChanges=function(n,t){n.extensionPointName=t.name;var i=a.getChangePersistenceForControl(t.targetControl);return r.getChangesForExtensionPoint(i,n).then(function(a){var r=[];a.forEach(function(a){if(a.isInInitialState()&&!(a.getExtensionPointInfo&&a.getExtensionPointInfo())){a.setExtensionPointInfo(t);l(a,t,false);if(i.isChangeMapCreated()){i.addChangeAndUpdateDependencies(n.appComponent,a)}}else if(g(a,t)){var s=a.convertToFileContent();var c=a.getContent();var f=e(s,["dependentSelector","fileName","selector","content"]);Object.keys(c).forEach(function(e){f[e]=c[e]});f.support.sourceChangeFileName=a.getId()||"";r.push(o.create({changeSpecificData:f,selector:{view:t.view,name:t.name}}).then(function(e){l(e,t,true);e.setExtensionPointInfo(t);var o=e.getFlexObjectMetadata();o.moduleName=a.getFlexObjectMetadata().moduleName;e.setFlexObjectMetadata(o);e.setCreation(a.getCreation());i.addChangeAndUpdateDependencies(n.appComponent,e,a)}))}});return Promise.all(r).then(function(){return a})})};return r});