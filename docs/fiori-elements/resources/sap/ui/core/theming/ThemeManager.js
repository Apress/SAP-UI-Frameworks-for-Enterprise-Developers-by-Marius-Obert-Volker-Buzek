/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Global","sap/ui/core/Element","sap/ui/core/Configuration","sap/ui/Device","sap/ui/base/EventProvider","sap/base/Log","sap/base/assert","sap/base/util/each","sap/base/util/LoaderExtensions","sap/ui/util/ActivityDetection","sap/ui/dom/includeStylesheet","./ThemeHelper"],function(e,t,s,i,r,a,n,o,h,m,u,d){"use strict";var c;var l=150;var f={};var p=/\.sapUiThemeDesignerCustomCss/i;var g=r.extend("sap.ui.core.theming.ThemeManager",{constructor:function(){r.apply(this,arguments);this._iCount=0;this._CUSTOMID="sap-ui-core-customcss";this._customCSSAdded=false;this._themeCheckedForCustom=null;this._sFallbackTheme=null;this._mThemeFallback={};S(this);this.themeLoaded=true},metadata:{events:{ThemeChanged:{}}},checkThemeChanged:function(){this.reset();y(true);if(!this._sThemeCheckId){this.fireThemeChanged()}}});g.prototype.themeLoaded=false;g.prototype.reset=function(){this.themeLoaded=false;if(this._sThemeCheckId){clearTimeout(this._sThemeCheckId);this._sThemeCheckId=null;this._iCount=0;this._sFallbackTheme=null;this._mThemeFallback={}}};function T(){var e=s.getTheme();var t=c._getThemePath("sap.ui.core",e)+"custom.css";var i=e.indexOf("sap_")===0||e==="base";var r=true;var n=[];if(c._customCSSAdded&&c._themeCheckedForCustom===e){f[c._CUSTOMID]={}}function h(s){var o="sap-ui-theme-"+s;var h=d.checkAndRemoveStyle({prefix:"sap-ui-theme-",id:s});if(h&&document.getElementById("sap-ui-themeskeleton-"+s)){h=d.checkAndRemoveStyle({prefix:"sap-ui-themeskeleton-",id:s})}r=r&&h;if(r){if(!c._customCSSAdded||c._themeCheckedForCustom!=e){if(!i&&v(s)){var m=t;var l=k(f["sap.ui.core"]);if(l){m+=l}u(m,c._CUSTOMID);c._customCSSAdded=true;a.debug("ThemeManager: delivered custom CSS needs to be loaded, Theme not yet applied");c._themeCheckedForCustom=e;r=false;return false}else if(c._customCSSAdded){var p=document.querySelector("LINK[id='"+c._CUSTOMID+"']");if(p){p.remove();a.debug("ThemeManager: Custom CSS removed")}c._customCSSAdded=false}}}if(!i&&h&&!c._mThemeFallback[s]){var g=document.getElementById(o);if(g&&g.getAttribute("data-sap-ui-ready")==="false"&&!(g.sheet&&d.hasSheetCssRules(g.sheet))){n.push(s)}}}o(f,h);if(n.length>0){if(!c._sFallbackTheme){for(var m in f){var l=d.getMetadata(m);if(l&&l.Extends&&l.Extends[0]){c._sFallbackTheme=l.Extends[0];break}}}if(c._sFallbackTheme){n.forEach(function(t){var s="sap-ui-theme-"+t;var i=document.getElementById(s);a.warning("ThemeManager: Custom theme '"+e+"' could not be loaded for library '"+t+"'. "+"Falling back to its base theme '"+c._sFallbackTheme+"'.");_(i,c._sFallbackTheme);c._mThemeFallback[t]=true});r=false}}if(!r){a.debug("ThemeManager: Theme not yet applied.")}else{c._themeCheckedForCustom=e}return r}function v(e){var t=window.document.getElementById("sap-ui-theme-"+e);if(!t){return false}var s=window.getComputedStyle(t,":after");var r=s?s.getPropertyValue("content"):null;if(!r&&i.browser.safari){var n=document.documentElement;n.classList.add("sapUiThemeDesignerCustomCss");r=window.getComputedStyle(n,":after").getPropertyValue("content");n.classList.remove("sapUiThemeDesignerCustomCss")}if(r&&r!=="none"){try{if(r[0]==="'"||r[0]==='"'){r=r.substring(1,r.length-1)}return r==="true"}catch(e){a.error("Custom check: Error parsing JSON string for custom.css indication.",e)}}var o=t.sheet?d.safeAccessSheetCssRules(t.sheet):null;if(!o||o.length===0){a.warning("Custom check: Failed retrieving a CSS rule from stylesheet "+e);return false}for(var h=0;h<2&&h<o.length;h++){if(p.test(o[h].selectorText)){return true}}return false}function y(e){c._iCount++;var t=c._iCount>l;if(!T()&&!t){var s;if(c._iCount<=100){s=2}else if(c._iCount<=110){s=500}else{s=1e3}c._sThemeCheckId=setTimeout(y,s)}else if(!e){c.reset();c.themeLoaded=true;c.fireThemeChanged();if(t){a.error("ThemeManager: max. check cycles reached.")}}else{c.themeLoaded=true}}function C(e){var t=document.getElementById(e);if(t){t.dataset.sapUiFoucmarker=e}}g.prototype._includeLibraryThemeAndEnsureThemeRoot=function(e){var t=e.name;b(t,s.getTheme());b(t,"base");f[t]=e;if(s.getValue("preloadLibCss").indexOf(t)<0){this.includeLibraryTheme(t,e.variant,e)}};g.prototype.includeLibraryTheme=function(e,t,i){n(typeof e==="string","sLibName must be a string");n(t===undefined||typeof t==="string","sVariant must be a string or undefined");var r=i;if(typeof r==="object"){r=k(i)}if(e!="sap.ui.legacy"&&e!="sap.ui.classic"){if(!t){t=""}var o=/^(true|x)$/i.test(s.getValue("xx-cssVariables"))?"_skeleton":"";var h=s.getRTL()?"-RTL":"";var m,d=e+(t.length>0?"-["+t+"]":t);if(e&&e.indexOf(":")==-1){m="library"+t+o+h}else{m=e.substring(e.indexOf(":")+1)+t;e=e.substring(0,e.indexOf(":"))}var c="sap-ui-theme-"+d;var l=document.getElementById(c)&&document.getElementById(c).href;var f=new URL(this._getThemePath(e,this.sTheme),document.baseURI).toString();var p=document.createElement("link");p.href=f+m+".css"+(r?r:"");var g=p.href;p.href=f+"css_variables.css"+(r?r:"");var T=p.href;if(!(g===l||T===l)){C(c);if(/^(true|x|additional)$/i.test(s.getValue("xx-cssVariables"))){a.info("Including "+T+" -  sap.ui.core.theming.ThemeManager.includeLibraryTheme()");u(T,c);c="sap-ui-themeskeleton-"+d;C(c)}a.info("Including "+g+" -  sap.ui.core.theming.ThemeManager.includeLibraryTheme()");u(g,c);var v=sap.ui.require("sap/ui/core/theming/Parameters");if(v){v._addLibraryTheme(d)}this.checkThemeChanged()}}};g.prototype._getThemePath=function(e,t){b(e,t);return sap.ui.require.toUrl((e+".themes."+t).replace(/\./g,"/")+"/")};function b(e,t){if(c._mThemeRoots){var s=c._mThemeRoots[t+" "+e]||c._mThemeRoots[t];if(s){s=s+e.replace(/\./g,"/")+"/themes/"+t+"/";h.registerResourcePath((e+".themes."+t).replace(/\./g,"/"),s)}}}g.prototype.setThemeRoot=function(e,t,s,i){n(typeof e==="string","sThemeName must be a string");n(Array.isArray(t)&&typeof s==="string"||typeof t==="string"&&s===undefined,"either the second parameter must be a string (and the third is undefined), or it must be an array and the third parameter is a string");if(!this._mThemeRoots){this._mThemeRoots={}}if(typeof t==="string"){i=s;s=t;t=undefined}s=s+(s.slice(-1)=="/"?"":"/");if(t){for(var r=0;r<t.length;r++){var a=t[r];this._mThemeRoots[e+" "+a]=s}}else{this._mThemeRoots[e]=s}if(i&&e===this.sTheme){this._updateThemeUrls(this.sTheme)}};g.prototype._updateThemeUrls=function(e,t){var s=document.querySelectorAll("link[id^=sap-ui-theme-],link[id^=sap-ui-themeskeleton-]");Array.prototype.forEach.call(s,function(s){_(s,e,t)})};function _(e,t,i){var r,a=e.href.search(/[?#]/),n,o,h="library",m=s.getRTL()?"-RTL":"",d,l;var p=/^sap-ui-theme(?:skeleton)?-(.*)$/i.exec(e.id);if(Array.isArray(p)){r=p[1]}else{r=e.id.slice(13)}f[r]=f[r]||{};if(a>-1){n=e.href.substring(0,a);o=e.href.substring(a)}else{n=e.href;o=""}n=n.substring(n.lastIndexOf("/")+1);if((l=r.indexOf("-["))>0){h+=r.slice(l+2,-1);r=r.slice(0,l)}if(n===h+".css"||n===h+"-RTL.css"){n=h+m+".css"}d=c._getThemePath(r,t)+n+o;if(d!=e.href){if(i){e.dataset.sapUiFoucmarker=e.id}u(d,e.id)}}g.prototype.applyTheme=function(e,t,i){n(typeof e==="string","sThemeName must be a string");n(typeof t==="string"||typeof t==="undefined","sThemeBaseUrl must be a string or undefined");e=s.normalizeTheme(e,t);if(t){this.setThemeRoot(e,t)}if(e&&this.sTheme!=e||i){var r=this.sTheme;var a=document.documentElement;this._updateThemeUrls(e,true);this.sTheme=e;s.setTheme(e);a.classList.remove("sapUiTheme-"+r);a.classList.add("sapUiTheme-"+e);this.checkThemeChanged()}};function k(t){var i;if(s.getValue("versionedLibCss")&&t){i="?version="+t.version;if(e.versioninfo){i+="&sap-ui-dist-version="+e.versioninfo.version}}return i}function S(e){var t=s.getValue("themeRoots");if(t){for(var i in t){var r=t[i];if(typeof r==="string"){e.setThemeRoot(i,r)}else{for(var n in r){if(n.length>0){e.setThemeRoot(i,[n],r[n])}else{e.setThemeRoot(i,r[n])}}}}}e.sTheme=s.getTheme();document.documentElement.classList.add("sapUiTheme-"+e.sTheme);a.info("Declared theme "+e.sTheme,null)}g.prototype.notifyContentDensityChanged=function(){this.fireThemeChanged()};g.prototype.fireThemeChanged=function(e){var i=sap.ui.require("sap/ui/core/theming/Parameters");if(i){i._reset(true)}e=e||{};if(!e.theme){e.theme=s.getTheme()}var r="ThemeChanged";var a=jQuery.Event(r);a.theme=e.theme;t.registry.forEach(function(e){e._handleEvent(a)});m.refresh();this.fireEvent(r,e)};c=new g;return c});