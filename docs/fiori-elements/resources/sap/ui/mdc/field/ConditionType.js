/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/SimpleType","sap/ui/model/FormatException","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/ui/model/type/String","sap/ui/mdc/enum/FieldDisplay","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/condition/Operator","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/ConditionValidateException","sap/ui/mdc/enum/BaseType","sap/ui/mdc/enum/ConditionValidated","sap/base/util/merge","sap/base/strings/whitespaceReplacer","sap/ui/base/SyncPromise"],function(e,t,a,i,r,n,o,s,l,u,f,d,c,h,p){"use strict";var v="sap.ui.mdc.raw";var m="sap.ui.mdc.raw:";var g=e.extend("sap.ui.mdc.field.ConditionType",{constructor:function(t,a){e.apply(this,arguments);this.sName="Condition";this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oCalls={active:0,last:0,condition:undefined,exception:undefined}}});g.prototype.destroy=function(){e.prototype.destroy.apply(this,arguments);if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType}this._bDestroyed=true};g.prototype.formatValue=function(e,a){if(e==undefined||e==null||this._bDestroyed){return null}if(typeof e!=="object"||!e.operator||!e.values||!Array.isArray(e.values)){throw new t("No valid condition provided")}if(!a){a="string"}var i=T.call(this);var r=S(i);var s=this.oFormatOptions.preventGetDescription;A.call(this,e,i);switch(this.getPrimitiveType(a)){case"string":case"any":var l=F.call(this);var u=D.call(this);var f=o.getEQOperator(u);if(!this.oFormatOptions.maxConditions||this.oFormatOptions.maxConditions===1){this._oCalls.active++;this._oCalls.last++}var h=this._oCalls.last;if(!s&&l!==n.Value&&e.validated===d.Validated&&(r||e.operator===f.name&&!e.values[1])){var m=this.oFormatOptions.bindingContext;var g=r?e.values[0][1]:e.values[0];return p.resolve().then(function(){return L.call(this,g,e,i,m)}.bind(this)).then(function(t){if(t){e=c({},e);if(r){i=P.call(this);e.operator=f.name;if(typeof t!=="object"){t={key:g,description:t}}}if(typeof t==="object"){e=Q.call(this,e,t)}else if(e.values.length===1){e.values.push(t)}else{e.values[1]=t}}return C.call(this,e,undefined,h,true,i)}.bind(this)).catch(function(a){var r;if(!(a instanceof t)||!j.call(this)){r=a}return C.call(this,e,r,h,true,i)}.bind(this)).unwrap()}return C.call(this,e,undefined,h,true,i);default:var y=z(a);if(y>=0){if(N.call(this,i)){return e.values.length>=1?e.values[0][y]:null}}else if(a===v){return e.values.length>=1?e.values[0]:null}else if(i&&e.values.length>=1){return i.formatValue(e.values[0],a)}throw new t("Don't know how to format Condition to "+a)}};function y(e,a){var i=F.call(this);var r=S(a);if(r&&e.values.length>1&&e.values[0][1]===e.values[1][1]){e=c({},e);e.operator="EQ";e.values.splice(1)}var s=this.oFormatOptions.hideOperator&&e.values.length===1||r;var l=o.getOperator(e.operator);var u=I.call(this);if(!l){throw new t("No valid condition provided, Operator wrong.")}var d=l.format(e,a,i,s,u);var p=this.oFormatOptions.convertWhitespaces;if(p&&(U.call(this,a)===f.String||i!==n.Value)){d=h(d)}return d}function C(e,t,a,i,r){if(this._oCalls.active>0){this._oCalls.active--}if(a<this._oCalls.last&&(this._oCalls.condition!==undefined||this._oCalls.exception!==undefined)){e=this._oCalls.condition;t=this._oCalls.exception}if(a===this._oCalls.last&&this._oCalls.active>0){this._oCalls.condition=c({},e);this._oCalls.exception=t}else if(this._oCalls.active===0&&this._oCalls.last>0){this._oCalls={active:0,last:0,condition:undefined,exception:undefined}}if(t){throw t}var n;if(i){n=y.call(this,e,r)}else{n=O.call(this,e,r)}return n}g.prototype.parseValue=function(e,t){if(this._bDestroyed){return null}if(!t){t="string"}else if(t==="any"&&typeof e==="string"){t="string"}var i=this.oFormatOptions.navigateCondition;if(i){var r=this.formatValue(i,t);if(r===e){return c({},i)}}var n=F.call(this);var s=R.call(this);var u=T.call(this);var f=b.call(this);var h=D.call(this);var p=S(u);var m;if(e===null||e===undefined||e===""&&!s){if(!N.call(this,u)){return null}}k.call(this,u);switch(this.getPrimitiveType(t)){case"string":var g;var y=false;var O=false;if(h.length===1){g=o.getOperator(h[0]);O=true}else{var w=o.getMatchingOperators(h,e);if(w.length===0){g=q.call(this,h,u);if(s&&!N.call(this,u)){var _=o.getEQOperator(h);if(h.indexOf(_.name)>=0){y=!!g&&g.name!==_.name;g=_}}O=true}else{var P=w.filter(function(e){return e.valueTypes.length===0});if(P.length>=1){g=P[0]}else{g=w[0]}}}if(g){if(p&&g!==o.getEQOperator(h)){throw new a("unsupported operator")}var x;var E=N.call(this,u);var A=I.call(this);this._oCalls.active++;this._oCalls.last++;var Q=this._oCalls.last;if((!E||p)&&g.validateInput&&s){x=V.call(this,g,e,u,O,y,h,n,true);if(x instanceof Promise){return B.call(this,x)}else{return x}}else{try{if(e===""&&E&&O){x=l.createCondition(g.name,[u.parseValue(e,"string",u._aCurrentValue)],undefined,undefined,d.NotValidated)}else{x=g.getCondition(e,u,n,O,A)}}catch(t){var U=t;if(U instanceof a&&f&&!E){try{f.parseValue(e,"string",f._aCurrentValue)}catch(e){U=e}}return C.call(this,undefined,U,Q,false,u)}}if(x){return C.call(this,x,undefined,Q,false,u)}}throw new a("Cannot parse value "+e);default:if(u){if(h.length===1){m=h[0]}else{m=q.call(this,h,u).name;if(h.indexOf(m)<0){m=undefined}}if(m){var j=z(t);if(j>=0){if(N.call(this,u)){var M=c([],u._aCurrentValue);M[j]=e;return l.createCondition(m,[M],undefined,undefined,d.NotValidated)}}else if(t===v){return l.createCondition(m,[e],undefined,undefined,d.NotValidated)}else{return l.createCondition(m,[u.parseValue(e,t)],undefined,undefined,d.NotValidated)}}}throw new a("Don't know how to parse Condition from "+t)}};function O(e,t){var a=S(t);var i=N.call(this,t);if(e&&!a&&i){var r=b.call(this)||t;var n=r.getMetadata().getName();var o=r.getFormatOptions();var s=r.getConstraints();var l=this.oFormatOptions.delegate;var u=this.oFormatOptions.payload;var d=l&&l.getTypeUtil(u).getBaseType(n,o,s);if((d===f.Unit||d===f.DateTime)&&!e.values[0][1]&&t._aCurrentValue){var c=t._aCurrentValue[1]?t._aCurrentValue[1]:null;e.values[0][1]=c;if(e.operator==="BT"){e.values[1][1]=c}}}A.call(this,e,t);return e}function V(e,r,o,u,f,c,h,v){var m;var g;var y=true;var O=false;var F;var T;var P=this.oFormatOptions.bindingContext;var b;if(r===""){b=[];m=r;F=r}else{b=e.getValues(r,h,u);m=v?b[0]:b[1];g=v?b[1]:b[0];O=h!==n.Value;F=m||g}var x=function(i){if(i&&!(i instanceof a)&&!(i instanceof t)){throw i}if(!i._bNotUnique){if(r===""){return null}if(v&&b[0]&&b[1]){return V.call(this,e,r,o,u,f,c,h,false)}if(f){return w.call(this,o,c,r,h)}}if(j.call(this)){return _.call(this,o,c,r,h)}throw new a(i.message)};var D=function(t){if(t){var i=[t.key];if(e.valueTypes.length>1&&e.valueTypes[1]!==s.ValueType.Static){i.push(t.description)}return l.createCondition(e.name,i,t.inParameters,t.outParameters,d.Validated,t.payload)}else if(r===""){return null}else{return x.call(this,new a(this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[r])))}};var E=this._oCalls.last;var N=function(t,i){var n;var s;try{n=i.call(this,t);if(S(o)){if(n){if(n.operator!=="EQ"){throw new a("unsupported operator")}var u=o._aCurrentValue&&o._aCurrentValue[0]!==undefined?o._aCurrentValue[0]:null;var f=n.values[0];n.values=[[u,f]]}else if(r===""){n=l.createCondition(e.name,[o.parseValue(r,"string",o._aCurrentValue)],undefined,undefined,d.NotValidated)}}}catch(e){s=e}return C.call(this,n,s,E,false,o)};try{if(S(o)){T=o.parseValue(F,"string",o._aCurrentValue);o.validateValue(T);T=T[1]}else{T=o.parseValue(F,"string");o.validateValue(T)}}catch(e){if(e&&!(O&&(e instanceof a||e instanceof i))){throw e}y=false;T=undefined}return p.resolve().then(function(){return M.call(this,F,T,o,P,y,O)}.bind(this)).then(function(e){return N.call(this,e,D)}.bind(this)).catch(function(e){return N.call(this,e,x)}.bind(this)).unwrap()}function w(e,t,a,i){var r=q.call(this,t,e);var o;if(r&&t.indexOf(r.name)>=0){o=r.getCondition(a,e,n.Value,true);o.validated=d.NotValidated}return o}function _(e,t,i,r){var s;if(S(e)){s=o.getEQOperator("EQ")}else if(t.length===1){s=o.getOperator(t[0])}else{s=o.getEQOperator(t);if(t.indexOf(s.name)<0){s=undefined}}if(!s){throw new a("Cannot parse value "+i)}var l=s.getCondition(i,e,n.Value,true);if(l){l.validated=d.NotValidated;if(S(e)&&Array.isArray(l.values[0])){l.values[0]=l.values[0][1]}}return l}g.prototype.validateValue=function(e){var t=T.call(this);var a=b.call(this);var r=D.call(this);var n=S(t);var s=N.call(this,t);var l=I.call(this);var f=0;if(e===undefined||this._bDestroyed){return null}else if(e===null){if(o.onlyEQ(r)){try{if(t.hasOwnProperty("_sParsedEmptyString")&&t._sParsedEmptyString!==null){t.validateValue(t._sParsedEmptyString)}else{t.validateValue(null)}}catch(e){if(e instanceof i){throw new u(e.message,e.violatedConstraints,null)}else{return null}}}return null}if(typeof e!=="object"||!e.operator||!e.values||!Array.isArray(e.values)){throw new u(this._oResourceBundle.getText("field.VALUE_NOT_VALID"),undefined,typeof e==="object"?c({},e):e)}var d=o.getOperator(e.operator);if(n){d=o.getEQOperator();f=1}if(!d||r.indexOf(d.name)===-1){throw new u("No valid condition provided, Operator wrong.",undefined,c({},e))}try{d.validate(e.values,t,l,f)}catch(t){try{if(t instanceof i&&a&&!s){d.validate(e.values,a,l,f)}throw t}catch(t){if(t instanceof i){throw new u(t.message,t.violatedConstraints,c({},e))}throw t}}};function F(){var e=this.oFormatOptions.display;if(!e){e=n.Value}return e}function T(){var e=this.oFormatOptions.valueType;if(!e){e=P.call(this)}return e}function P(){if(!this._oDefaultType){this._oDefaultType=new r}return this._oDefaultType}function b(){return this.oFormatOptions.originalDateType}function x(){return this.oFormatOptions.additionalType}function D(){var e=this.oFormatOptions.operators;if(!e||e.length===0){e=o.getOperatorsForType(f.String)}return e}function E(){var e=this.oFormatOptions.fieldHelpID;if(e){var t=sap.ui.getCore().byId(e);if(t&&t.isValidationSupported()){return t}}return null}function N(e){return e&&e.isA("sap.ui.model.CompositeType")}function I(){return this.oFormatOptions.compositeTypes}function S(e){if(N(e)){var t=e.getFormatOptions();var a=!t||!t.hasOwnProperty("showMeasure")||t.showMeasure;var i=!t||!t.hasOwnProperty("showNumber")||t.showNumber;var r=!t||!t.hasOwnProperty("showTimezone")||t.showTimezone;var n=!t||!t.hasOwnProperty("showDate")||t.showDate;var o=!t||!t.hasOwnProperty("showTime")||t.showTime;if(a&&!i||r&&!n&&!o){return true}}return false}function A(e,t){if(N.call(this,t)&&e&&e.values[0]){t._aCurrentValue=c([],e.values[0]);var a=x.call(this);if(N.call(this,a)){a._aCurrentValue=c([],e.values[0])}var i=b.call(this);if(N.call(this,i)){i._aCurrentValue=c([],e.values[0])}}}function k(e){if(N.call(this,e)){var t=x.call(this);if(N.call(this,t)){if(!t._aCurrentValue){t._aCurrentValue=[]}e._aCurrentValue=t._aCurrentValue}}}function Q(e,t){e.values=[t.key,t.description];if(t.inParameters){e.inParameters=t.inParameters}if(t.outParameters){e.outParameters=t.outParameters}if(t.payload){e.payload=t.payload}return e}function B(e){if(this.oFormatOptions.asyncParsing){this.oFormatOptions.asyncParsing(e)}return e}function U(e){var t=e.getMetadata().getName();var a=e.getFormatOptions();var i=e.getConstraints();var r=this.oFormatOptions.delegate;var n=this.oFormatOptions.payload;var o=r?r.getTypeUtil(n).getBaseType(t,a,i):f.String;if(o===f.Unit){o=f.Numeric}return o}function R(){var e=E.call(this);var t=this.oFormatOptions.delegate;var a=this.oFormatOptions.payload;if(t){return t.isInputValidationEnabled(a,e)}else{return!!e}}function j(){var e=E.call(this);var t=this.oFormatOptions.delegate;var a=this.oFormatOptions.payload;if(t){return t.isInvalidInputAllowed(a,e)}else if(e){return!e.getValidateInput()}else{return true}}function M(e,t,i,r,n,o){var s=E.call(this);var l=this.oFormatOptions.delegate;var u=this.oFormatOptions.payload;var f=this.oFormatOptions.control;var d={value:e,parsedValue:t,dataType:i,inParameters:undefined,outParameters:undefined,bindingContext:r,checkKey:n,checkDescription:o,exception:a,control:f};if(l){return l.getItemForValue(u,s,d)}else if(s){return s.getItemForValue(d)}}function L(e,a,i,r){var n=E.call(this);var o=this.oFormatOptions.delegate;var s=this.oFormatOptions.payload;var l=this.oFormatOptions.control;if(o){return o.getDescription(s,n,e,a.inParameters,a.outParameters,r,undefined,undefined,a.payload,l,i)}else if(n){var u={value:e,parsedValue:e,dataType:i,context:{inParameters:a.inParameters,outParameters:a.outParameters,payload:a.payload},bindingContext:r,checkKey:true,checkDescription:false,caseSensitive:true,exception:t,control:l};return n.getItemForValue(u)}}function q(e,t){var a=this.oFormatOptions.defaultOperatorName;var i;if(a){i=o.getOperator(a)}else{i=o.getDefaultOperator(U.call(this,t))}if(i&&e.indexOf(i.name)<0){for(var r=0;r<e.length;r++){i=o.getOperator(e[r]);if(i.exclude||!i.hasRequiredValues()){i=undefined}else{break}}}return i}function z(e){var t=-1;if(e.startsWith(m)){t=parseInt(e[m.length])}return t}return g});