/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/util/loadModules","sap/ui/mdc/valuehelp/base/ListContent","sap/ui/mdc/condition/Condition","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/util/Common","sap/ui/mdc/enum/PersistenceMode","sap/m/p13n/Engine","sap/base/util/merge","sap/ui/mdc/p13n/StateUtil"],function(e,t,i,r,a,l,n,o,s){"use strict";var h=t.extend("sap.ui.mdc.valuehelp.base.FilterableListContent",{metadata:{library:"sap.ui.mdc",properties:{filterFields:{type:"string",defaultValue:""},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},group:{type:"string",defaultValue:""}},aggregations:{filterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false},_defaultFilterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false,visibility:"hidden"}},associations:{filters:{type:"sap.ui.mdc.IFilter",multiple:true}},events:{}}});h.prototype.init=function(){t.prototype.init.apply(this,arguments);this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oObserver.observe(this,{properties:["filterFields"],aggregations:["_defaultFilterBar","filterBar"]});n.getInstance().defaultProviderRegistry.attach(this,l.Transient)};h.prototype._handleFilterValueUpdate=function(e){if(this.isContainerOpening()||this.isContainerOpen()){Promise.resolve(this.applyFilters()).finally(function(){t.prototype._handleFilterValueUpdate.apply(this,arguments)}.bind(this))}};h.prototype._reduceIFilterConditions=function(e){var t=this._getValueHelpDelegate();var i=this._getValueHelpDelegatePayload();return t?t.reduceIFilterConditions(i,this,e):e};h.prototype.applyFilters=function(){};h.prototype._prettyPrintFilters=function(e){var t;if(!e){return""}if(Array.isArray(e)){t="";e.forEach(function(e,i,r){t+=this._prettyPrintFilters(e);if(r.length-1!=i){t+=" or "}},this);return"("+t+")"}else if(e._bMultiFilter){t="";var i=e.bAnd;e.aFilters.forEach(function(e,r,a){t+=this._prettyPrintFilters(e);if(a.length-1!=r){t+=i?" and ":" or "}},this);return"("+t+")"}else{t=e.sPath+" "+e.sOperator+" '"+e.oValue1+"'";if(e.sOperator==="BT"){t+="...'"+e.oValue2+"'"}return t}};h.prototype._getItemFromContext=function(e,t){var i=t&&t.keyPath||this.getKeyPath();var r=t&&t.descriptionPath||this.getDescriptionPath();var a;var l;if(!i){throw new Error("KeyPath missing")}if(e){a=i?e.getProperty(i):undefined;l=r?e.getProperty(r):undefined}if(a===null||a===undefined){return false}var n=this._createConditionPayload([a,l],e);return{key:a,description:l,payload:n}};h.prototype._createConditionPayload=function(e,t){var i;var r=this._getValueHelpDelegate();if(r){var a=this._getValueHelpDelegatePayload();i={};i=r.createConditionPayload(a,this,e,t)}return i};h.prototype._isItemSelected=function(e,t){var i=this._isValueHelpDelegateInitialized()&&this._getValueHelpDelegate();return i?i.isFilterableListItemSelected(this._getValueHelpDelegatePayload(),this,e,t):false};h.prototype._createDefaultFilterBar=function(){return e(["sap/ui/mdc/filterbar/vh/FilterBar"]).then(function(e){var t=e[0];var i=new t(this.getId()+"-FB",{liveMode:false,showGoButton:true});u.call(this,i);this.setAggregation("_defaultFilterBar",i,true);return i}.bind(this))};h.prototype._handleSearch=function(e){var t=e.getSource();this._setLocalFilterValue(t.getSearch());this.applyFilters()};function u(t){var i=t.getBasicSearchField();var r=this.getFilterFields();if(!i&&r){if(!this._oSearchField){return e(["sap/ui/mdc/FilterField"]).then(function(e){if(!t.bIsDestroyed){var i=e[0];this._oSearchField=new i(this.getId()+"-search",{conditions:"{$filters>/conditions/"+r+"}",placeholder:"{$i18n>filterbar.SEARCH}",label:"{$i18n>filterbar.SEARCH}",maxConditions:1,width:"50%"});this._oSearchField._bCreatedByValueHelp=true;u.call(this,t)}}.bind(this))}t.setBasicSearchField(this._oSearchField)}else if(i){if(r){i.setConditions([])}else if(i._bCreatedByValueHelp){t.setBasicSearchField()}}}h.prototype.onContainerClose=function(){this._setLocalFilterValue(undefined)};h.prototype._getPriorityFilterBar=function(){return this.getFilterBar()||this.getAggregation("_defaultFilterBar")};h.prototype._observeChanges=function(e){if(e.object==this){var i;if(["_defaultFilterBar","filterBar"].indexOf(e.name)!==-1){i=e.child;var r;if(e.mutation==="insert"){u.call(this,i);this._assignCollectiveSearchSelect();if(e.name!=="_defaultFilterBar"||!this.getFilterBar()){i.attachSearch(this._handleSearch,this)}if(e.name==="filterBar"){r=this.getAggregation("_defaultFilterBar");if(r){r.detachSearch(this._handleSearch,this)}}}else{var a=i.getBasicSearchField();if(a&&a._bCreatedByValueHelp){i.setBasicSearchField()}i.detachSearch(this._handleSearch,this);if(e.name==="filterBar"){r=this.getAggregation("_defaultFilterBar");if(r){r.attachSearch(this._handleSearch,this)}else{this._createDefaultFilterBar()}}}}else if(e.name==="filterFields"){i=this._getPriorityFilterBar();if(i){u.call(this,i)}}}t.prototype._observeChanges.apply(this,arguments)};h.prototype.getCollectiveSearchKey=function(){return this._oCollectiveSearchSelect&&this._oCollectiveSearchSelect.getSelectedItemKey()};h.prototype._getListBindingInfo=function(){throw new Error("FilterableListContent: Every filterable listcontent must implement this method.")};h.prototype._getListItemBindingContext=function(e){var t=this._getListBindingInfo().model;return e&&e.getBindingContext(t)};h.prototype.getInitialFocusedControl=function(){return this._getPriorityFilterBar().getInitialFocusedControl()};h.prototype._getTypesForConditions=function(e){var t=this._getValueHelpDelegate();var i=this._getValueHelpDelegatePayload();return t?t.getTypesForConditions(i,this,e):{}};h.prototype.getFormattedTitle=function(e){var i=t.prototype.getFormattedTitle.apply(this,arguments);if(!i){i=this._oResourceBundle.getText(e?"valuehelp.SELECTFROMLIST":"valuehelp.SELECTFROMLISTNONUMBER",e)}return i};h.prototype.getFormattedShortTitle=function(){var e=this.getShortTitle();if(!e){e=this._oResourceBundle.getText("valuehelp.SELECTFROMLIST.Shorttitle")}return e};h.prototype.getFormattedTokenizerTitle=function(e){var t=this.getTokenizerTitle();if(!t){t=this._oResourceBundle.getText("valuehelp.SELECTFROMLIST.TokenizerTitle"+(e===0?"NoCount":""),e)}return t};h.prototype.isSearchSupported=function(){var e=this.getFilterFields();var t=!!e;if(e==="$search"){var i=this.getListBinding();var r=this._getValueHelpDelegate();var a=this._getValueHelpDelegatePayload();t=r&&r.isSearchSupported(a,this,i)}return t};h.prototype.setCollectiveSearchSelect=function(e){this._oCollectiveSearchSelect=e;this._assignCollectiveSearchSelect()};h.prototype._assignCollectiveSearchSelect=function(){var e=this._getPriorityFilterBar();if(e.setCollectiveSearch){e.setCollectiveSearch(this._oCollectiveSearchSelect)}};h.prototype._applyFiltersIfNecessary=function(){var e=this.getListBinding();var t=this._getListBindingInfo();var i=e&&e.isSuspended();var r=!e&&t&&t.suspended;if((i||r)&&!this.isTypeahead()){return undefined}return this.applyFilters()};h.prototype.onBeforeShow=function(e){if(e){var t=this._getValueHelpDelegate();return Promise.resolve(t&&t.getFilterConditions(this._getValueHelpDelegatePayload(),this)).then(function(t){this._oInitialFilterConditions=t;var i=this._getPriorityFilterBar();if(i){var r=this.getFilterFields();var a=o({},this._oInitialFilterConditions);return Promise.resolve(!a[r]&&s.retrieveExternalState(i).then(function(t){if(e){p(a,r,this._getPriorityFilterValue());return s.diffState(i,t,{filter:a})}}.bind(this))).then(function(e){return s.applyExternalState(i,e)}).then(this._applyFiltersIfNecessary.bind(this))}else{return this._applyFiltersIfNecessary()}}.bind(this))}return undefined};h.prototype._fireSelect=function(e){var t=this._getValueHelpDelegate();var i=this._getValueHelpDelegatePayload();var r=t&&t.modifySelectionBehaviour?t.modifySelectionBehaviour(i,this,e):e;if(r){this.fireSelect(r)}};h.prototype.exit=function(){n.getInstance().defaultProviderRegistry.detach(this);a.cleanup(this,["_oCollectiveSearchSelect","_oInitialFilterConditions"]);if(this._oSearchField&&!this._oSearchField.getParent()){this._oSearchField.destroy();delete this._oSearchField}t.prototype.exit.apply(this,arguments)};h.prototype.getCount=function(e,i){var r=this._isValueHelpDelegateInitialized()&&this._getValueHelpDelegate();var a=r&&this._getValueHelpDelegatePayload();return r&&r.getCount?r.getCount(a,this,e,i):t.prototype.getCount.apply(this,arguments)};h.prototype._getLocalFilterValue=function(){var e=this.getParent();return e&&e.getLocalFilterValue()};h.prototype._setLocalFilterValue=function(e){var t=this.getParent();return t&&t.setLocalFilterValue(e)};h.prototype._getPriorityFilterValue=function(){var e=this.getParent();var t=e&&e.getLocalFilterValue();if(typeof t!=="undefined"){return t}return this.getFilterValue()};function p(e,t,a){e[t]=a?[i.createCondition("Contains",[a],undefined,undefined,r.NotValidated)]:[];return}return h});