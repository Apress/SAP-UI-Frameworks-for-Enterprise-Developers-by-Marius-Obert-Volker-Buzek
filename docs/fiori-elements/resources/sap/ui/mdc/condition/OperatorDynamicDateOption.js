/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/DynamicDateOption","sap/m/DynamicDateValueHelpUIType","sap/m/Input","sap/ui/mdc/condition/Operator","sap/ui/mdc/enum/BaseType","sap/ui/mdc/enum/FieldDisplay","sap/ui/mdc/util/DateUtil","sap/ui/mdc/util/loadModules","sap/ui/model/json/JSONModel","sap/ui/model/FormatException","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/ui/core/library"],function(e,t,a,r,o,s,i,p,l,n,u,y,v){"use strict";var h=v.ValueState;var f;var d;var g=e.extend("sap.ui.mdc.condition.OperatorDynamicDateOption",{metadata:{library:"sap.ui.mdc",properties:{operator:{type:"object"},type:{type:"object"},baseType:{type:"sap.ui.mdc.enum.BaseType"}}}});g.prototype.exit=function(){e.prototype.exit.apply(this,arguments);if(this._oModel){this._oModel.destroy();this._oModel=undefined;this._mChangeHandler=undefined}if(this._aUITypes){for(var t=0;t<this._aUITypes.length;t++){this._aUITypes[t].destroy()}this._aUITypes=undefined}};g.prototype.applySettings=function(){e.prototype.applySettings.apply(this,arguments);var t=[];var a=this.getBaseType();if(a===o.DateTime){if(!d){t.push("sap/m/DateTimePicker")}}else if(!f){t.push("sap/m/DatePicker")}if(t.length>0){return p(t).then(function(e){if(a===o.DateTime){d=e[0]}else{f=e[0]}})}};g.prototype.validateProperty=function(t,a){if(t==="operator"&&a&&(typeof a!=="object"||!a.isA||!a.isA("sap.ui.mdc.condition.Operator"))){throw new Error('"'+a+'" is of type '+typeof a+", expected "+'sap.ui.mdc.condition.Operator for property "'+t+'" of '+this)}else if(t==="type"&&a&&(typeof a!=="object"||!a.isA||!a.isA("sap.ui.model.Type"))){throw new Error('"'+a+'" is of type '+typeof a+", expected "+'sap.ui.model.Type for property "'+t+'" of '+this)}return e.prototype.validateProperty.apply(this,arguments)};g.prototype.isRange=function(){var e=this.getOperator();return e.isA("sap.ui.mdc.condition.RangeOperator")};g.prototype.getText=function(e){var t=this.getOperator();var a=this.getBaseType();return t.getLongText(a)};g.prototype.getValueHelpUITypes=function(e){if(!this._aUITypes){var a=this.getOperator();var s=this.getType();var i=this.getBaseType();this._aUITypes=[];for(var p=0;p<a.valueTypes.length;p++){var l=a.valueTypes[p];if(l===r.ValueType.Self){var n;if(i===o.DateTime){n="datetime"}else{n="date"}this._aUITypes.push(new t({type:n}))}else if(!l||l===r.ValueType.Static){continue}else{s=a._createLocalType(l,s);if(s.isA("sap.ui.model.type.Integer")||s.isA("sap.ui.model.odata.type.Int")){this._aUITypes.push(new t({type:"int"}))}else{this._aUITypes.push(new t({type:"custom"}))}}}}return this._aUITypes};g.prototype.createValueHelpUI=function(e,t){var s=e.getValue();var p=this.getOperator();var n=this.getType();var u=this.getKey();var y=e.getId();if(!s||s.operator!==u){s={operator:u,values:[]};if(p.valueDefaults){s.values=p.valueDefaults}}c.call(this,e);if(!e.aControlsByParameters){e.aControlsByParameters={}}e.aControlsByParameters[u]=[];var v=function(e){t(this)}.bind(this);for(var h=0;h<p.valueTypes.length;h++){var g=p.valueTypes[h];var m=this.getBaseType();var T;if(!g){continue}if(!e.aControlsByParameters[u][h]){if(p.createControl){if(!this._oModel){v=function(e){var t=e.getParameter("path");var a=t.split("/");var r=a[0]||a[1];if(this._mChangeHandler&&this._mChangeHandler[r]){this._mChangeHandler[r](this)}}.bind(this);this._oModel=new l;this._oModel.attachPropertyChange({},v,this);this._mChangeHandler={}}var _=this._oModel.getData();_[y]={value0:s&&s.values[0],value1:s&&s.values[1]};this._mChangeHandler[y]=t;if(g!==r.ValueType.Self){n=p._createLocalType(g,n)}var V=p.createControl(n,"internal>/"+y+"/value"+h,h,y+"-"+h);V.setModel(this._oModel,"internal");e.aControlsByParameters[u].push(V)}else if(g===r.ValueType.Self){if(s&&s.values[h]){T=i.typeToDate(s.values[h],n,m)}var C=n.getFormatOptions();var O;if(m===o.DateTime){O=d}else{O=f}var B=new O(y+"-"+h,{dateValue:T,displayFormat:C.style||C.pattern,displayFormatType:C.calendarType,change:v});e.aControlsByParameters[u].push(B)}else if(typeof g==="object"){n=p._createLocalType(p.valueTypes[h],n);var P=n.formatValue(s&&s.values[h],"string");var D=new a(y+"-"+h,{value:P,change:v});e.aControlsByParameters[u].push(D)}}}return e.aControlsByParameters[u]};g.prototype.validateValueHelpUI=function(e){var t=this.getKey();var a=this.getOperator();var r=this.getType();var o;var s=true;var i=h.None;var p;var l=0;try{o=this.getValueHelpOutput(e);for(l=0;l<o.values.length;l++){var n=o.values[l];if(n===undefined||n===null){s=false}}a.validate(o.values,r)}catch(e){s=false;i=h.Error;p=e.message;if(e&&!(e instanceof u)&&!(e instanceof y)){throw e}}if(!a.createControl){for(l=0;l<e.aControlsByParameters[t].length;l++){var v=e.aControlsByParameters[t][l];if(v.setValueState){v.setValueState(i);v.setValueStateText(p)}}}return s};g.prototype.getValueHelpOutput=function(e){var t=this.getKey();var a={operator:t,values:[]};var o=this.getOperator();var s=this.getType();var p=this.getBaseType();var l=e.getId();for(var n=0;n<o.valueTypes.length;n++){if(!o.valueTypes[n]){continue}var y=e.aControlsByParameters[t][n];if(y){var v;if(o.createControl){v=this._oModel?this._oModel.getProperty("/"+l+"/value"+n):null}else if(o.valueTypes[n]===r.ValueType.Self){if(!y.isValidValue()){throw new u}v=y.getDateValue();if(v){v=i.dateToType(v,s,p)}}else{v=y.getValue();s=o._createLocalType(o.valueTypes[n],s);v=s.parseValue(v,"string")}a.values.push(v)}}return a};g.prototype.getGroupHeader=function(){var t=this.getOperator();if(t.group&&t.group.text){return t.group.text}return e.prototype.getGroupHeader.apply(this,arguments)};g.prototype.getGroup=function(){var t=this.getOperator();if(t.group){return t.group.id}return e.prototype.getGroup.apply(this,arguments)};g.prototype.toDates=function(e){var t=this.getOperator();var a=this.getType();var o=this.getBaseType();var s;var p=0;if(t.isA("sap.ui.mdc.condition.RangeOperator")){s=t._getRange(e&&e.values,a,o);for(p=0;p<s.length;p++){s[p]=i.typeToDate(s[p],a,o)}}else if(t.valueTypes.length===0){s=[]}else if(t.valueTypes[0]===r.ValueType.Self){s=[];for(p=0;p<e.values.length;p++){s.push(e.values[p]?i.typeToDate(e.values[p],a,o):e.values[p])}if(s.length===1){s.push(s[0])}}else if([r.ValueType.Self,r.ValueType.Static].indexOf(t.valueTypes[0])===-1){throw new Error("Cannot convert to date, use RangeOperator")}return s};g.prototype.format=function(e){var t=this.getOperator();var a=this.getType();return t.format(e,a,s.Value)};g.prototype.parse=function(e){var t=this.getOperator();var a=this.getType();if(e&&t.parse(e)){var r={};r.operator=this.getKey();r.values=t.parse(e,a,s.Value);return r}};g.prototype.enhanceFormattedValue=function(e,t){return false};function c(e){var t=this.getKey();if(e&&e.aControlsByParameters&&e.aControlsByParameters[t]){for(var a=0;a<e.aControlsByParameters[t].length;a++){var r=e.aControlsByParameters[t][a];if(!r.bIsDestroyed){r.destroy()}}delete e.aControlsByParameters[t]}}return g});