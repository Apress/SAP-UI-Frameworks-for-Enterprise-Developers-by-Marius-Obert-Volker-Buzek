/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/base/DataType","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/Log"],function(e,t,r,o,i){"use strict";var n={name:{type:"string",mandatory:true,forComplexProperty:{allowed:true}},label:{type:"string",mandatory:true,forComplexProperty:{allowed:true}},tooltip:{type:"string",forComplexProperty:{allowed:true}},visible:{type:"boolean",default:{value:true},forComplexProperty:{allowed:true}},path:{type:"string"},dataType:{type:"string",mandatory:true},formatOptions:{type:"object"},constraints:{type:"object"},maxConditions:{type:"int",default:{value:-1}},caseSensitive:{type:"boolean",default:{value:true}},group:{type:"string",forComplexProperty:{allowed:true}},groupLabel:{type:"string",forComplexProperty:{allowed:true}},filterable:{type:"boolean",default:{value:true},forComplexProperty:{valueIfNotAllowed:false}},sortable:{type:"boolean",default:{value:true},forComplexProperty:{valueIfNotAllowed:false}},propertyInfos:{type:"PropertyReference[]",forComplexProperty:{allowed:true}}};var a={isComplex:function(){return A.isPropertyComplex(this)},getSimpleProperties:function(){return this.propertyInfosProperties||[this]},getSortableProperties:function(){return this.getSimpleProperties().filter(function(e){return e.sortable})},getFilterableProperties:function(){return this.getSimpleProperties().filter(function(e){return e.filterable})},getVisibleProperties:function(){return this.getSimpleProperties().filter(function(e){return e.visible})}};var p=["name","label","tooltip","visible","path","dataType","formatOptions","constraints","maxConditions","group","groupLabel","caseSensitive"];var l=new WeakMap;function u(e){return JSON.stringify(e,function(e,t){return t===undefined?null:t})||""}function f(e,t){if(i.getLevel()<i.WARNING){return}var r=u(t);i.warning("Invalid property definition: "+e+(r?"\n"+r:""))}function s(e,t){var r=t?u(t):null;throw new Error("Invalid property definition: "+e+(r?"\n"+r:""))}function y(e,t){t.map(function(e){Object.keys(a).forEach(function(t){Object.defineProperty(e,t,{value:function(){return a[t].call(this)},writable:true})})})}function c(e){var t=Object.getOwnPropertyNames(e);Object.freeze(e);for(var r=0;r<t.length;r++){var i=e[t[r]];if(typeof i==="function"){Object.freeze(i)}else if(o(i)&&!Object.isFrozen(i)){c(i)}else if(Array.isArray(i)){c(i)}}}function v(e,t){if(!t){return e}return t.split(".").reduce(function(e,t){return e&&e[t]?e[t]:null},e)}function d(e){var r;if(typeof e==="object"){r="object"}else{r=e.replace("PropertyReference","string")}return t.getType(r)}function P(e){var t=d(e);if(t.isArrayType()){return t.getBaseType().getDefaultValue()}else{return t.getDefaultValue()}}function b(e,t){t.forEach(function(t){e.prepareProperty(t)});c(t)}function g(e,t,r,o,i,n){var a=o==null;var p=[];var u=A.isPropertyComplex(t);if(a){n=l.get(e).mAttributeMetadata;i=t}if(!i){return[]}for(var f in n){var s=n[f];var y=a?f:o+"."+f;var c=i[f];if(u&&!s.forComplexProperty.allowed){if("valueIfNotAllowed"in s.forComplexProperty){i[f]=s.forComplexProperty.valueIfNotAllowed}continue}if(c!=null&&typeof s.type==="string"&&s.type.startsWith("PropertyReference")||y==="propertyInfos"){if(u||y!=="propertyInfos"){m(i,f,r)}continue}if(c==null){h(i,s,o,f,p,c)}if(typeof s.type==="object"){p=p.concat(g(e,t,r,y,i[f],s.type))}}return p}function m(e,t,r){var o=e[t];var i;var n=t;if(Array.isArray(o)){i=o.map(function(e){return r[e]});n+="Properties"}else{i=r[o];n+="Property"}Object.defineProperty(e,n,{value:i})}function h(e,t,o,i,n,a){if("default"in t){var p=t.default;if(a===null&&p.ignoreIfNull&&"value"in p){return}if(p.value===undefined){e[i]=P(t.type)}else if(typeof p.value==="string"&&p.value.startsWith("attribute:")){n.push({source:p.value.substring(p.value.indexOf(":")+1),targetPath:o,targetAttribute:i,targetType:t.type})}else if(typeof p.value==="object"){e[i]=r({},p.value)}else{e[i]=p.value}}else{e[i]=P(t.type)}}function x(e){return Object.freeze(e.reduce(function(e,t){e[t.name]=t;return e},{}))}function w(e,t,r){for(var o in e){var i=e[o];var n=t==null?o:t+"."+o;var a=r?r.forComplexProperty:{};i.forComplexProperty=Object.assign({allowed:a.allowed&&a.propagateAllowance,propagateAllowance:true},i.forComplexProperty);if(typeof i.type==="object"){w(i.type,n,i)}}}function C(e,t){if(!Array.isArray(t)){s("Property infos must be an array.")}var o=l.get(e);var i=r([],t);e.validateProperties(i,o.aPreviousRawProperties);o.aProperties=i;o.mProperties=x(i);o.aPreviousRawProperties=r([],t);y(e,i);b(e,i)}var A=e.extend("sap.ui.mdc.util.PropertyHelper",{constructor:function(t,r,o){e.call(this);if(r&&!e.isA(r,"sap.ui.base.ManagedObject")){throw new Error("The type of the parent is invalid.")}Object.keys(o||{}).forEach(function(e){if(e in n&&o[e]!==true){throw new Error("The attribute '"+e+"' is reserved and cannot be overridden by additional attributes.")}});var i={};var a=Object.keys(o||{});i.mAttributeMetadata=p.concat(a).reduce(function(e,t){e[t]=t in n?n[t]:o[t];return e},{});w(i.mAttributeMetadata);i.aMandatoryAttributes=Object.keys(i.mAttributeMetadata).filter(function(e){return i.mAttributeMetadata[e].mandatory});i.oParent=r||null;l.set(this,i);C(this,t)}});A.prototype.validateProperties=function(e,t){var r=new Set;for(var o=0;o<e.length;o++){this.validateProperty(e[o],e,t);r.add(e[o].name)}if(r.size!==e.length){s("Properties do not have unique names.")}};A.prototype.validateProperty=function(e,t,r){if(!o(e)){s("Property info must be a plain object.",e)}j(this,e,t);if(A.isPropertyComplex(e)){if(e.propertyInfos.length===0){s("Complex property does not reference existing properties.",e)}}var i=l.get(this);i.aMandatoryAttributes.forEach(function(t){var r=i.mAttributeMetadata[t].forComplexProperty.allowed;if(e[t]==null&&A.isPropertyComplex(e)&&!r){return}if(!(t in e)){f("Property does not contain mandatory attribute '"+t+"'.",e)}else if(e[t]==null){s("Property does not contain mandatory attribute '"+t+"'.",e)}})};function j(e,t,r,o,i,n){var a=o==null;if(a){n=l.get(e).mAttributeMetadata;i=t}for(var p in i){var u=n[p];var y=a?p:o+"."+p;var c=i[p];if(!u){f("Property contains invalid attribute '"+y+"'.",t)}else if(A.isPropertyComplex(t)&&!u.forComplexProperty.allowed){f("Complex property contains invalid attribute '"+y+"'.",t)}else if(typeof u.type==="object"&&c&&typeof c==="object"){j(e,t,r,y,c,u.type)}else if(c!=null&&!d(u.type).isValid(c)){s("The value of '"+y+"' is invalid.",t)}else if(c&&typeof u.type==="string"&&u.type.startsWith("PropertyReference")){O(e,t,r,y,c,u)}}}function O(e,t,r,o,i,n){var a=n.type.endsWith("[]")?i:[i];var p=new Set(a);if(a.indexOf(t.name)>-1){s("Property references itself in the '"+o+"' attribute",t)}if(p.size!==a.length){s("Property contains duplicate names in the '"+o+"' attribute.",t)}for(var l=0;l<r.length;l++){if(p.has(r[l].name)){if(A.isPropertyComplex(r[l])){s("Property references complex properties in the '"+o+"' attribute.",t)}p.delete(r[l].name)}}if(p.size>0){s("Property references non-existing properties in the '"+o+"' attribute.",t)}}A.prototype.prepareProperty=function(e){var t=this.getPropertyMap();var r=g(this,e,t);r.forEach(function(r){var o=v(e,r.targetPath);if(o){var i=v(e,r.source);if(i==null){i=P(r.targetType)}o[r.targetAttribute]=i;if(typeof r.targetType==="string"&&r.targetType.startsWith("PropertyReference")){m(o,r.targetAttribute,t)}}})};A.prototype.getParent=function(){var e=l.get(this);return e?e.oParent:null};A.prototype.setProperties=function(e){C(this,e)};A.prototype.getProperties=function(){var e=l.get(this);return e?e.aProperties:[]};A.prototype.getPropertyMap=function(){var e=l.get(this);return e?e.mProperties:{}};A.prototype.getProperty=function(e){return this.getPropertyMap()[e]||null};A.prototype.hasProperty=function(e){return e in this.getPropertyMap()};A.isPropertyComplex=function(e){return e!=null&&typeof e==="object"?"propertyInfos"in e:false};A.prototype.getSortableProperties=function(){return this.getProperties().filter(function(e){return e.sortable})};A.prototype.getFilterableProperties=function(){return this.getProperties().filter(function(e){return e.filterable})};A.prototype.getVisibleProperties=function(){return this.getProperties().filter(function(e){return e.visible})};A.prototype.destroy=function(){e.prototype.destroy.apply(this,arguments);l.delete(this)};return A});