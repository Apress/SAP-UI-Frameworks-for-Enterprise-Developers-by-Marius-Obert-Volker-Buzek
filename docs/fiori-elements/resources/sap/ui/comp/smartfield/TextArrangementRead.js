/*
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/URI"],function(e){"use strict";var t;var r=function(){if(!t){t=this;this.mRequests=new Map;this._iMaxRequests=1e3;if(window.location.search.indexOf("data-sap-ui-xx-disableTextArrangementReadCache=true")!==-1){this.read=function(e,t,r){return this._createReadPromise({model:e,path:t,settings:r})}.bind(this)}}return t};r.prototype.read=function(e,t,r){var s,i={model:e,path:t,settings:r};try{s=this._calculateCacheKey(i)}catch(e){return this._createReadPromise(i)}return this._getPromise(s,i)};r.prototype._getPromise=function(e,t){var r,s;if(this.mRequests.has(e)){r=this.mRequests.get(e);s=this._validateCache(e,r,t);if(s===true){return r.promise}if(s instanceof Promise){return s}}return this._createReadPromise(t,e)};r.prototype._setPromise=function(e,t,r){var s;this.mRequests.set(e,{modelId:r.model.getId(),promise:t});if(this.mRequests.size>this._iMaxRequests){s=this.mRequests.getKeys().next().value;if(s){this.mRequests.delete(s)}}};r.prototype._validateCache=function(e,t,r){if(r&&r.model){if(t.modelId===r.model.getId()){return true}return new Promise(function(s){t.promise.then(function(i){if(i&&Array.isArray(i.results)&&this._probeLocalModelForLoadedData(r,i)){s(t.promise)}else{s(this._createReadPromise(r,e))}}.bind(this))}.bind(this))}return true};r.prototype._probeLocalModelForLoadedData=function(e,t){var r=e.model.getKey(t.results[0]);if(r){return!!e.model.getProperty("/"+r)}return false};r.prototype.exit=function(){this.mRequests.clear()};r.prototype.clearCache=function(){this.mRequests.clear()};r.prototype._createReadPromise=function(e,t){var r=new Promise(function(t,r){e.settings.success=t;e.settings.error=r;e.model.read(e.path,e.settings)}).then(function(e){var r=e&&Array.isArray(e.results)&&e.results.length===1;if(t&&!r){this.mRequests.delete(t)}return e}.bind(this));if(t){this._setPromise(t,r,e)}return r};r.prototype._calculateCacheKey=function(t){var r,s=t.model.sServiceUrl,i=t.model.aUrlParams;if(!s){throw"Can't access service URL. Opt out of value list caching."}s=new e(s).absoluteTo(document.baseURI).pathname().toString();r={path:t.path,service:s,filters:this._flattenFilters(t.settings.filters)};if(Array.isArray(i)&&i.length){r["urlParams"]=i}return JSON.stringify(r)};r.prototype._flattenFilters=function(e){var t=[],r=function(e){if(e.sPath){t.push({p:e.sPath,v:e.oValue1})}if(Array.isArray(e.aFilters)){e.aFilters.forEach(r)}};r(e[0]);return t};return r},false);