/*
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/library","sap/ui/comp/library","sap/ui/model/BindingMode","sap/ui/comp/util/FormatUtil","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider","sap/ui/comp/smartfield/BindingUtil","sap/ui/comp/odata/MetadataAnalyser","sap/m/HBox","sap/base/Log","sap/base/strings/capitalize","sap/ui/comp/smartfilterbar/SmartFilterBar"],function(t,e,a,i,o,n,r,s,l,d,u,p,g){"use strict";var h=a.smartfield.ControlContextType;var f=e.ValueState;var c=t.extend("sap.ui.comp.smartfield.ControlFactoryBase",{constructor:function(e,a){t.apply(this,arguments);this.sName="ControlFactoryBase";this._oModel=e;this._oParent=a;this._oBinding=new s;this._aProviders=[];this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp")}});c.prototype.bind=function(){return Promise.resolve()};c.prototype.createControl=function(t){var e,a;e=this._getCreator(t);if(e){a=this[e](t);this._addAriaLabelledBy(a);this._addAriaDescribedBy(a);if(a&&a.onCreate){this[a.onCreate](a.control,a.params)}}return a};c.prototype.updateControl=function(t){var e,a=t.mode,i=this._oParent,o=i.data("configdata");if(o&&o.configdata){e=i.getFirstInnerControl();if(o.configdata.onText&&a==="display"){o.configdata.onText(e)}else if(o.configdata.onInput&&a==="edit"){o.configdata.onInput(e)}}};c.prototype._addAriaLabelledBy=function(t){var e=this._getTargetControlForAccAttributes(t),a=this._oParent.getAriaLabelledBy();if(e&&e.addAriaLabelledBy&&a.length>0){e.removeAllAriaLabelledBy();a.forEach(function(t){e.addAriaLabelledBy(t)})}};c.prototype._addAriaDescribedBy=function(t){var e=this._getTargetControlForAccAttributes(t),a=this._oParent.getAriaDescribedBy();if(e&&e.addAriaDescribedBy&&a.length>0){e.removeAllAriaDescribedBy();a.forEach(function(t){e.addAriaDescribedBy(t)})}};c.prototype._getTargetControlForAccAttributes=function(t){var e,a=this._oParent.getControlContext();if(a===h.None||a===h.Form||a===h.SmartFormGrid){if(t){e=t.control;if(e instanceof d){if(e.getItems().length>0){e=e.getItems()[0]}}}}return e};c.prototype.addValidations=function(t,e){var a,i,o=this;a=function(t,a){var i,n,r=a.getParameter("targetControl")||a.getSource();if(r){if(r.setValueState){r.setValueState(t)}n=a.getParameter("exception");if(n){i=n.message}if(!i){i=a.getParameter("message")}if(r.setValueStateText){r.setValueStateText(i)}}if(e){o._oParent[e](t===f.Error)}};i=function(t){a(f.Error,t)};t.attachFormatError(i);t.attachParseError(i);t.attachValidationError(i);t.attachValidationSuccess(function(t){o._oParent.onValidation(t);a(f.None,t)})};c.prototype._getDisplayBehaviourConfiguration=function(t){var e=null,i,o=this._oParent.data("configdata"),n=o&&o.configdata,r=n&&n.isUOM&&n.isInnerControl,s=this._oParent._getComputedTextInEditModeSource()==="ValueListNoValidation";var o=this._oParent.getConfiguration();if(o){e=o.getDisplayBehaviour()}if(!e&&this._oMetaData&&this._oMetaData.entityType){e=this._oHelper.oAnnotation.getTextArrangement(this._oMetaData.property.property,this._oMetaData.entityType,s)}if(!e){if(!t&&this._oSelector){i=this._oSelector.checkComboBox({mode:"edit"});t=i&&i.combobox?"defaultDropDownDisplayBehaviour":"defaultInputFieldDisplayBehaviour"}e=this._oParent.data(t)}if(!e&&!r){e=a.DEFAULT_DISPLAY_BEHAVIOUR}return e};c.prototype._getPreventInitialDataFetchInVHDialog=function(t){var e=this._oParent.getConfiguration();if(e&&!e.isPropertyInitial("preventInitialDataFetchInValueHelpDialog")){return e.getPreventInitialDataFetchInValueHelpDialog()}if(l.isValueList(t)&&t["com.sap.vocabularies.Common.v1.ValueList"]&&t["com.sap.vocabularies.Common.v1.ValueList"].FetchValues){return t["com.sap.vocabularies.Common.v1.ValueList"].FetchValues.Int!=="1"}return false};c.prototype._formatDisplayBehaviour=function(t,e,a){var i=this._getDisplayBehaviourConfiguration(t);if(t==="defaultCheckBoxDisplayBehaviour"){return this._getFormattedExpressionFromDisplayBehaviour(i,e)}if(t==="defaultComboBoxReadOnlyDisplayBehaviour"&&!i){i="descriptionAndId"}return o.getFormattedExpressionFromDisplayBehaviour(i||"idOnly",e,a)};c.prototype._getFormattedExpressionFromDisplayBehaviour=function(t,e){var a="";switch(t){case"OnOff":a=e?"SMARTFIELD_CB_ON":"SMARTFIELD_CB_OFF";break;case"TrueFalse":a=e?"SMARTFIELD_CB_TRUE":"SMARTFIELD_CB_FALSE";break;default:a=e?"SMARTFIELD_CB_YES":"SMARTFIELD_CB_NO";break}return this._oRb.getText(a)};c.prototype.getDropdownItemKeyType=function(){};c.prototype.getValueStateBindingInfoForRecommendationStateAnnotation=function(){};c.prototype.createValueHelp=function(t){var e,a=t.edmProperty,i=t.valueHelp;if(i.annotation&&(a["sap:value-list"]||a["com.sap.vocabularies.Common.v1.ValueList"])){var o=i.displayBehaviour||this._getDisplayBehaviourConfiguration(),s=this._oParent.data("dateFormatSettings"),l=this._getPreventInitialDataFetchInVHDialog(a);if(typeof s==="string"){try{s=JSON.parse(s)}catch(t){}}var d,u,p=this._oParent.data("configdata"),h,f;if(typeof i.annotation==="string"){u=i.annotation}else if(i&&typeof i.annotation==="object"){if(p&&p.configdata){h=p.configdata.annotations;if(h&&h.valuelist&&typeof h.valuelist==="string"){u=h.valuelist}}f=h&&(h.valueListData&&h.valueListData.annotation||h.valuelist);d=i.analyser.getValueListAnnotationForFunctionImport({"":f||i.annotation},a.name).primaryValueListAnnotation}var c=t.control,y=t.model,m=t.onValueListChange;if(!i.noDialog){if(c.setFilterSuggests){c.setFilterSuggests(false)}var _=new n({context:"SmartField",fnAsyncWritePromise:this._oParent._isAsync&&this._oParent._isAsync()?this._oParent.checkValuesValidity.bind(this._oParent):null,selectedODataRowHandler:this._selectedODataRowHandler.bind(this),fieldName:a.name,control:c,model:y,dateFormatSettings:s,displayBehaviour:o,loadAnnotation:true,fullyQualifiedFieldName:u,metadataAnalyser:i.analyser,annotation:d,title:i.dialogtitle,preventInitialDataFetchInValueHelpDialog:l,supportMultiSelect:!!i.supportMultiSelect,supportRanges:!!i.supportRanges,takeOverInputValue:true,type:i.type,maxLength:a.maxLength,filterBarClass:g,enabledMultiSelectionPlugin:true});if(m){_.attachValueListChanged(m)}this._aProviders.push(_);if(c.setShowValueHelp){c.setShowValueHelp(true)}}var v=true,P=true;if(this._oParent._getHistoryEnabled){v=this._oParent._getHistoryEnabled();P=this._oParent.isPropertyInitial("historyEnabled")}if(!i.noTypeAhead||!c.isA("sap.m.Input")){e={control:c,model:y,dateFormatSettings:s,displayBehaviour:o,fieldViewMetadata:a,loadAnnotation:true,fullyQualifiedFieldName:u,metadataAnalyser:i.analyser,annotation:d,aggregation:i.aggregation,typeAheadEnabled:!i.noTypeAhead,dropdownItemKeyType:this.getDropdownItemKeyType(c),maxLength:a.maxLength,fieldHistoryEnabled:v,fieldHistoryEnabledInitial:P};var A=new r(this.getValueListProviderConfiguration(e));if(!i.noTypeAhead){if(c.setShowSuggestion){c.setShowSuggestion(true)}}if(m){A.attachValueListChanged(m)}this._aProviders.push(A)}}};c.prototype.getValueListProviderConfiguration=function(t){return{context:"SmartField",fnAsyncWritePromise:this._oParent._isAsync&&this._oParent._isAsync()?this._oParent.checkValuesValidity.bind(this._oParent):null,selectedODataRowHandler:this._selectedODataRowHandler.bind(this),control:t.control,model:t.model,dateFormatSettings:t.dateFormatSettings,displayBehaviour:t.displayBehaviour,fieldViewMetadata:t.fieldViewMetadata,loadAnnotation:true,fullyQualifiedFieldName:t.fullyQualifiedFieldName,metadataAnalyser:t.metadataAnalyser,annotation:t.annotation,aggregation:t.aggregation,typeAheadEnabled:t.typeAheadEnabled,dropdownItemKeyType:t.dropdownItemKeyType,maxLength:t.maxLength,fieldHistoryEnabled:t.fieldHistoryEnabled,fieldHistoryEnabledInitial:t.fieldHistoryEnabledInitial}};c.prototype._selectedODataRowHandler=function(t,e,a){if(this.oTextArrangementDelegate){this.oTextArrangementDelegate.setDataForNextDescriptionRequest(t,e);this.oTextArrangementDelegate.setAbsolutePathToVLProperty(a)}};c.prototype.getAttribute=function(t){var e=this._oParent.getBindingInfo(t);if(e){return this._oBinding.toBindingPath(e)}return this._oParent["get"+t.substring(0,1).toUpperCase()+t.substring(1)]()};c.prototype.getCustomDataConfiguration=function(){var t=this._oParent.data("configdata");return t&&t.configdata?t.configdata:null};c.prototype.createAttributes=function(t,e,a,i){var o=this,n,r={};for(var s in a){if(a.hasOwnProperty(s)){var l=this._oParent.getBindingInfo(s);if(l){r[s]=this._oBinding.toBinding(l)}else if(s==="valueState"&&this._oParent.isPropertyInitial("valueState")){l=this.getValueStateBindingInfoForRecommendationStateAnnotation();if(l){r[s]=l}else{r[s]=this._oParent["get"+p(s)]()}}else{r[s]=this._oParent["get"+p(s)]()}}}if(t){if(e&&e.property&&e.property.type==="Edm.String"&&(this._oHelper.oAnnotation.isStaticOptional(e.property)||this._oParent&&this._oParent._fieldControlValue===3)||this._oParent&&!this._oParent.getClientSideMandatoryCheck()){n={parseKeepsEmptyString:true}}r[t]={model:this._oMetaData.model,path:this._oMetaData.path,type:e?this._oTypes.getType(e,n):null,mode:this._oParent.getBindingMode("value")}}if(i){r[i.event]=function(t){try{var e=t.getParameters();var a={value:e[i.parameter],newValue:e[i.parameter]};o._oParent.fireChange(a)}catch(t){u.warning(t)}}}return r};c.prototype.mapBindings=function(t,e,a){var i,o;for(i in e){o=this._oParent.getBindingInfo(i);if(o){t[e[i]]=this._oBinding.toBinding(o)}else{t[e[i]]=a&&a[e[i]]||this._oParent["get"+i.substring(0,1).toUpperCase()+i.substring(1)]()}}};c.prototype.getFormatSettings=function(t){var e=null,a,i,o;if(t){e=this._oParent.data(t);if(!e){a=this._oParent.getCustomData();if(a){o=a.length;while(o--){i=a[o];if(i.getKey()===t){e=i.getValue();break}}}}if(e&&typeof e==="string"){try{e=JSON.parse(e)}catch(t){return null}}}return e};c.prototype.getValueListProvider=function(){return this._aProviders.find(function(t){return t.isA("sap.ui.comp.providers.ValueListProvider")})};c.prototype.destroyValueHelp=function(){this._aProviders.forEach(function(t){t.destroy()});this._aProviders=[]};c.prototype.destroy=function(){this.destroyValueHelp();if(this._oBinding){this._oBinding.destroy()}this._oBinding=null;this._oParent=null;this._oModel=null;this._oRb=null};return c},true);