/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/m/library","sap/m/VBox","sap/m/FlexItemData","sap/m/List","sap/m/Tree","sap/m/Title","sap/m/Toolbar","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/OverflowToolbarButton","sap/ui/comp/odata/ODataModelUtil","sap/ui/comp/util/FullScreenUtil","sap/ui/core/format/NumberFormat","sap/base/util/deepEqual"],function(t,e,i,s,o,r,a,n,l,h,u,d,p,_,c){"use strict";var g=e.ToolbarDesign;var f=i.extend("sap.ui.comp.smartlist.SmartList",{metadata:{library:"sap.ui.comp",properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},selectFields:{type:"string",group:"Misc",defaultValue:null},expandFields:{type:"string",group:"Misc",defaultValue:null},showRowCount:{type:"boolean",group:"Misc",defaultValue:true},header:{type:"string",group:"Misc",defaultValue:null},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:false},listBindingPath:{type:"string",group:"Misc",defaultValue:null},listType:{type:"sap.ui.comp.smartlist.ListType",group:"Misc",defaultValue:null},showFullScreenButton:{type:"boolean",group:"Misc",defaultValue:false}},associations:{smartFilter:{type:"sap.ui.core.Control"}},aggregations:{listItemTemplate:{type:"sap.m.ListItemBase",multiple:false}},events:{initialise:{},beforeRebindList:{},dataReceived:{}}},renderer:{apiVersion:2},constructor:function(){i.apply(this,arguments);this.addStyleClass("sapUiCompSmartList");this._createToolbar();this._createList();this.attachModelContextChange(this._initialiseMetadata,this)}});f.prototype._sAggregation="items";f.prototype.setHeader=function(t){this.setProperty("header",t,true);this._refreshHeaderText();return this};f.prototype.setShowRowCount=function(t){this.setProperty("showRowCount",t,true);this._refreshHeaderText();return this};f.prototype.setShowFullScreenButton=function(t){this.setProperty("showFullScreenButton",t,true);if(this._oFullScreenButton){this._oFullScreenButton.setVisible(this.getShowFullScreenButton())}return this};f.prototype.setEntitySet=function(t){this.setProperty("entitySet",t);this._initialiseMetadata();return this};f.prototype._refreshHeaderText=function(){if(!this._headerText){return}var t=this.getHeader();var e=!!t;this._headerText.setVisible(e);if(e&&this.getShowRowCount()){var i=parseInt(this._getRowCount(true));if(i>0){if(!this._oNumberFormatter){this._oNumberFormatter=_.getFloatInstance()}var s=this._oNumberFormatter.format(i);t+=" ("+s+")"}}this._headerText.setText(t)};f.prototype._addFullScreenButton=function(){if(this._oFullScreenButton){this._oToolbar.removeContent(this._oFullScreenButton)}if(this.getShowFullScreenButton()){if(!this._oFullScreenButton){this._oFullScreenButton=new u(this.getId()+"-btnFullScreen",{press:function(){this._toggleFullScreen(!this.bFullScreen)}.bind(this)})}this._toggleFullScreen(this.bFullScreen,true);this._oToolbar.addContent(this._oFullScreenButton)}};f.prototype._createToolbar=function(){var t,e,i;if(!this._oToolbar){t=this.getItems();e=t?t.length:0;while(e--){i=t[e];if(i instanceof n){break}i=null}if(i){this._oToolbar=i}else{this._oToolbar=new l(this.getId()+"-toolbar",{design:g.Transparent});this.insertItem(this._oToolbar,0)}if(!this._oToolbar.getLayoutData()){this._oToolbar.setLayoutData(new s({shrinkFactor:0}))}}};f.prototype._toggleFullScreen=function(t,e){var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp"),s;if(!this._oFullScreenButton||t===this.bFullScreen&&!e){return}this.bFullScreen=t;p.toggleFullScreen(this,this.bFullScreen,this._oFullScreenButton,this._toggleFullScreen);s=this.bFullScreen?i.getText("CHART_MINIMIZEBTN_TOOLTIP"):i.getText("CHART_MAXIMIZEBTN_TOOLTIP");this._oFullScreenButton.setTooltip(s);this._oFullScreenButton.setText(s);this._oFullScreenButton.setIcon(this.bFullScreen?"sap-icon://exit-full-screen":"sap-icon://full-screen")};f.prototype._createToolbarContent=function(){if(!this._oToolbar){this._createToolbar()}this._addHeaderToToolbar();this._addSpacerToToolbar();this._addFullScreenButton();this._oToolbar.addStyleClass("sapMTBHeader-CTX")};f.prototype._addHeaderToToolbar=function(){if(this._headerText){this._oToolbar.removeContent(this._headerText)}if(!this._headerText){this._headerText=new a(this.getId()+"-header");this._headerText.addStyleClass("sapMH4Style");this._headerText.addStyleClass("sapUiCompSmartTableHeader")}this._refreshHeaderText();this._oToolbar.insertContent(this._headerText,0)};f.prototype._addSpacerToToolbar=function(){var t=false,e=this._oToolbar.getContent(),i,s;if(e){s=e.length;i=0;for(i;i<s;i++){if(e[i]instanceof h){t=true;break}}}if(!t){this._oToolbar.addContent(new h(this.getId()+"-toolbarSpacer"))}};f.prototype._getRowCount=function(t){var e=this._getRowBinding();if(!e){return t?undefined:0}var i;if(!t){i=e.getLength()}else{if(typeof e.getCount==="function"){i=e.getCount()}else if(!e.isA("sap.ui.model.TreeBinding")&&typeof e.isLengthFinal==="function"&&e.isLengthFinal()){i=e.getLength()}}if(i<0||i==="0"){i=0}return i};f.prototype._getRowBinding=function(){if(this._oList){return this._oList.getBinding(this._sAggregation)}};f.prototype._initialiseMetadata=function(){if(!this.bIsInitialised){d.handleModelInit(this,this._onMetadataInitialised)}};f.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){this.detachModelContextChange(this._initialiseMetadata,this);this.bIsInitialised=true;this._listenToSmartFilter();this._createToolbarContent();this._createContent();this.fireInitialise();this._checkAndTriggerBinding()}};f.prototype._checkAndTriggerBinding=function(){if(!this._bAutoBindingTriggered){this._bAutoBindingTriggered=true;if(this.getEnableAutoBinding()){if(this._oSmartFilter){this._oSmartFilter.search()}else{this._reBindList()}}}};f.prototype._listenToSmartFilter=function(){var t=null;t=this.getSmartFilter();if(typeof t==="string"){this._oSmartFilter=sap.ui.getCore().byId(t)}else{this._oSmartFilter=t}if(this._oSmartFilter){this._oSmartFilter.attachSearch(this._reBindList,this);this._oSmartFilter.attachFilterChange(this._filterChangeEvent,this);this._oSmartFilter.attachCancel(this._cancelEvent,this);this._setNoDataText(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_DATA"))}};f.prototype._filterChangeEvent=function(){if(this._isListBound()&&this._oSmartFilter&&!this._oSmartFilter.getLiveMode()){this._showOverlay(true)}};f.prototype._cancelEvent=function(){if(this._oSmartFilter&&!this._oSmartFilter.getLiveMode()){this._showOverlay(false)}};f.prototype._showOverlay=function(t){};f.prototype.rebindList=function(t){this._reBindList(null,t)};f.prototype._reBindList=function(t,e){var i,s,o,r,a,n={},l={preventListBind:false};if(this._oSmartFilter){o=this._oSmartFilter.getFilters();n=this._oSmartFilter.getParameters()||{}}r=o;if(!a){a=[]}n["select"]=this.getSelectFields();n["expand"]=this.getExpandFields();n["useBatchRequests"]=true;l.filters=r;l.sorter=a;l.parameters=n;l.length=undefined;l.startIndex=undefined;this.fireBeforeRebindList({bindingParams:l});if(!l.preventListBind){a=l.sorter;r=l.filters;n=l.parameters;s=this.getListBindingPath()||"/"+this.getEntitySet();this._bDataLoadPending=true;this._bIgnoreChange=false;if(!e){i=this._oList.getBinding(this._sAggregation);if(i&&i.mParameters){e=!(c(n,i.mParameters,true)&&c(n.custom,i.mParameters.custom)&&!l.length&&!l.startIndex&&s===i.getPath())}}if(!i||!this._bIsListBound||e){this._oList.bindItems({path:s,filters:r,sorter:a,parameters:n,length:l.length,startIndex:l.startIndex,template:this._oTemplate,events:{dataRequested:function(){this._bIgnoreChange=true}.bind(this),dataReceived:function(t){this._bIgnoreChange=false;this._onDataLoadComplete(t,true);this.fireDataReceived(t)}.bind(this),change:function(t){if(this._bIgnoreChange){return}var e,i=false;e=t&&t.getParameter?t.getParameter("reason"):undefined;if(!e||e==="filter"||e==="context"){i=true}if(e==="change"||i){this._onDataLoadComplete(t,i)}}.bind(this)}});this._bIsListBound=true}else{i.sort(a);i.filter(r,"Application")}this._showOverlay(false)}};f.prototype._onDataLoadComplete=function(t,e){if(this._bDataLoadPending||e){this._bDataLoadPending=false;if(!this._bNoDataUpdated&&!this._getRowCount()){this._bNoDataUpdated=true;this._setNoDataText()}this._refreshHeaderText()}};f.prototype._isListBound=function(){if(this._bIsListBound){return true}if(this._oList){return this._oList.isBound(this._sAggregation)}return false};f.prototype._setNoDataText=function(t){if(this._oList){if(!t){t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_RESULTS")}this._oList.setNoDataText(t)}};f.prototype._createContent=function(){if(!this._oTemplate){this._oTemplate=this.getListItemTemplate()}};f.prototype._createList=function(){var t=this.getItems(),e=t?t.length:0,i,a;while(e--){i=t[e];if(i instanceof o||i instanceof r){break}i=null}if(i){this._oList=i;if(i instanceof r){this._isTree=true}else{this._isList=true}this._oTemplate=i.getItems()&&i.getItems().length>0?i.getItems()[0]:this.getListItemTemplate();i.removeAllItems()}else{a=this.getId()+"-ui5list";if(this.getListType()==="Tree"){this._oList=new r(a);this._isTree=true}else{this._oList=new o(a,{growing:true,growingScrollToLoad:true});this._isList=true}this.insertItem(this._oList,2)}if(!this._oList.getLayoutData()){this._oList.setLayoutData(new s({growFactor:1,baseSize:"auto"}))}};f.prototype.getList=function(){return this._oList};f.prototype.isInitialised=function(){return!!this.bIsInitialised};f.prototype.exit=function(){if(this._oSmartFilter){this._oSmartFilter.detachSearch(this._reBindList,this);this._oSmartFilter.detachFilterChange(this._filterChangeEvent,this);this._oSmartFilter.detachCancel(this._cancelEvent,this);this._oSmartFilter=null}p.cleanUpFullScreen(this);if(!this._bIsListBound&&this._oTemplate){this._oTemplate.destroy()}this._oTemplate=null;this._oToolbar=null;this._headerText=null;this._oFullScreenButton=null;this._oNumberFormatter=null;this._oList=null};return f});