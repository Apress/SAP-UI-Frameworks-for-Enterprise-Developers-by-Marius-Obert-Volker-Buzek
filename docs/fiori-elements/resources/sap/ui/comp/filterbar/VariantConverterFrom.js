/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/core/date/UI5Date","sap/ui/comp/util/DateTimeUtil","sap/m/DatePicker","sap/m/DateRangeSelection","sap/base/Log","sap/ui/core/format/DateFormat"],function(e,t,i,a,r,n,o){"use strict";var l=e.ANALYTICAL_PARAMETER_PREFIX;var s=e.smartfilterbar.FilterType;var f=e.valuehelpdialog.ValueHelpRangeOperation;var c=function(){};c.prototype.convert=function(e,t,i){var a=null,r=null,n;if(e){this._bStrictMode=i;n=JSON.parse(e);if(t&&t.getFilterBarViewMetadata&&n){this._sBasicSearchName=null;this._sBasicSearchValue=null;if(t.getBasicSearchName){this._sBasicSearchName=t.getBasicSearchName()}a={};if(n.Parameters){this._addParameters(n.Parameters,t,a)}if(n.SelectOptions){this._addSelectOptions(n.SelectOptions,t,a)}r={payload:null,variantId:null};r.payload=JSON.stringify(a);if(n.SelectionVariantID){r.variantId=n.SelectionVariantID}if(this._sBasicSearchValue){r.basicSearch=this._sBasicSearchValue}}}return r};c.prototype.retrieveVariantId=function(e){var t=null;var i;if(e){i=JSON.parse(e);if(i&&i.SelectionVariantID){t=i.SelectionVariantID}}return t};c.prototype._getParameterMetaData=function(e,t,i){if(this._bStrictMode){return this._getParameterMetaDataStrictMode(e,t)}return this._getParameterMetaDataNonStrictMode(e,t,i)};c.prototype._getFilter=function(e,t){var i,a,r,n;n=t.getFilterBarViewMetadata();if(n){for(i=0;i<n.length;i++){r=n[i];for(a=0;a<r.fields.length;a++){if(e===r.fields[a].fieldName){return r.fields[a]}}}}return null};c.prototype._getParameter=function(e,t){var i,a;if(t.getAnalyticalParameters){a=t.getAnalyticalParameters();if(a){for(i=0;i<a.length;i++){if(e===a[i].fieldName){return a[i]}}}}return null};c.prototype._getParameterWithInnerPrefix=function(e,t){var i=e;if(e.indexOf(l)!==0){i=l+e}return this._getParameter(i,t)};c.prototype._getParameterMetaDataStrictMode=function(e,t){var i=this._getExactFilterParameterMatch(e,t);if(i){return i}return null};c.prototype._getParameterMetaDataNonStrictMode=function(e,t,i){var a,r,n,o,s=e,f=false,c=function(){return f&&s===o||!f&&s!==o};if(e.indexOf(l)===0){s=e.substr(l.length);f=true}if(s.indexOf("P_")===0){r=s;n=s.substr(2)}else{r="P_"+s;n=s}if(s!==r){o=r}else if(s!==n){o=n}a=this._getExactParameterMatch(s,t);if(a){return a}a=this._getExactParameterMatch(o,t);if(a){return a}if(c()){a=this._getFilter(n,t);if(a){return a}}return null};c.prototype._getExactParameterMatch=function(e,t){var i;i=this._getParameterWithInnerPrefix(e,t);if(i){return i}return null};c.prototype._getExactFilterParameterMatch=function(e,t){var i,a;i=this._getFilter(e,t);if(i){return i}a=this._getParameterWithInnerPrefix(e,t);if(a){return a}return null};c.prototype._addParameters=function(e,t,i){var a;var r,o;var l;for(a=0;a<e.length;a++){o=e[a].PropertyValue;r=e[a].PropertyName;if(this._sBasicSearchName&&r===this._sBasicSearchName){this._sBasicSearchValue=o;continue}l=this._getParameterMetaData(r,t,true);if(l){t.determineControlByName(r);this._addAccordingMetaData(i,t,l,o)}else{n.error("neither metadata nor custom information for filter '"+r+"'")}}};c.prototype._addSelectOptions=function(e,t,i){var a;var r,o;var l,s;for(a=0;a<e.length;a++){r=e[a].PropertyName;o=e[a].Ranges;if(this._sBasicSearchName&&r===this._sBasicSearchName){if(o&&o.length>0){this._sBasicSearchValue=o[0].Low}continue}t.determineControlByName(r);l=this._getParameterMetaData(r,t,false);if(l){s=l.control;this._addRangesAccordingMetaData(i,t,l,o,s)}else{n.error("neither metadata nor custom information for filter '"+r+"'")}}};c.convertOption=function(e,t){var i;switch(e){case"CP":i=f.Contains;if(t){var a=t.indexOf("*");var r=t.lastIndexOf("*");if(a>-1){if(a===0&&r!==t.length-1){i=f.EndsWith;t=t.substring(1,t.length)}else if(a!==0&&r===t.length-1){i=f.StartsWith;t=t.substring(0,t.length-1)}else{t=t.substring(1,t.length-1)}}}break;case"EQ":if(t===""||t===null){i=f.Empty;t=null}else{i=e}break;case"BT":case"LE":case"GE":case"GT":case"LT":i=e;break;default:n.error("Suite Option is not supported '"+e+"'");i=undefined;t=undefined}return{op:i,v:t}};c.prototype._getYearMonthDatePattern=function(e){var t=e.match(/^([0-9]{4})([0-9]{2})([0-9]{2})$/);if(t){return[t[1],t[2],t[3]]}};c.prototype._getTimeZoneFormat=function(e){return e.split(/[\s+-]/)[0]};c.prototype._createDateObject=function(e){var i,a,r,n,o,l,s,f;if(!e){return}i=e.split(".");a=i[0];r=i[1];if(r){r=this._getTimeZoneFormat(r)}o=a.split("T");f=o[0].split("-");if(f.length===1){n=this._getYearMonthDatePattern(f[0]);if(n){f=n}}if(o.length<2){l=t.getInstance(f[0],f[1]-1,f[2])}else{s=o[1].split(":");l=t.getInstance(f[0],f[1]-1,f[2],s[0],s[1],s[2],r?r:0)}l.setFullYear(f[0]);return l};c.prototype._addRangesAccordingMetaData=function(e,t,l,u,d,m){var h,p;var g=function(e,t,a,r){if(t&&t.isInUTCMode&&a.indexOf("PT")===-1&&e.filterType==="date"){if(t.isInUTCMode()){a=a.split("T")[0]+"T00:00:00"}else if(!t.isInUTCMode()&&a.split("T").length===1){a+="T00:00:00"}}if(a.indexOf("Z")!==a.length-1){if(t&&t.isInUTCMode&&!t.isInUTCMode()){r=i.localToUtc(this._createDateObject(a)).toJSON()}else{r=this._createDateObject(a).toJSON()}}else{n.error("Property '"+e.fieldName+"' was added with zulu time zone information.")}return r}.bind(this);var v=function(e){var t=o.getTimeInstance({pattern:"'PT'hh'H'mm'M'ss'S'"});return t.parse(e)};var _=function(e){var i=e;if(e&&l){if(l.filterType==="numeric"){if(l.type==="Edm.Decimal"||l.type==="Edm.Float"||l.type==="Edm.Double"||l.type==="Edm.Single"){i=parseFloat(e)}else{i=parseInt(e)}}else{switch(l.type){case"Edm.DateTime":i=g(l,t,e,i);break;case"Edm.Time":if(e.indexOf("PT")===0){i=v(e)}else{i=g(l,t,e,i)}break;case"Edm.String":if(l.isCalendarDate&&!(l.filterType==="stringdate"&&l.controlType==="date")){i=g(l,t,e,i)}break;case"Edm.DateTimeOffset":i=e;break;case"Edm.Date":var a=e.split("T"),r=a[1];if(r){r=this._getTimeZoneFormat(r)}i=r?a[0]+"T"+r:e;break;default:i=e;break}}}return i};var y=function(t,i){var a,r,n;for(a=0;a<i.length;a++){n=c.convertOption(i[a].Option,i[a].Low);if(n&&n.op){r={exclude:i[a].Sign==="E",operation:n.op,keyField:t,value1:_(n.v),value2:_(i[a].High)};if(!e[t]){e[t]={ranges:[],items:[],value:null}}e[t].ranges.push(r)}}};var S=function(e){for(var t=0;t<e.length;t++){if(e[t].Sign==="E"){return true}}return false};if(u&&u.length>0){if(l.isCustomFilterField){if(!e._CUSTOM){e._CUSTOM={}}if(Array.isArray(u)&&u.length>1){e._CUSTOM[l.fieldName]=u.map(function(e){return e.Low})}else{e._CUSTOM[l.fieldName]=u[0].Low}return}if(l.conditionType){for(h=0;h<u.length;h++){if(!u[h].High){u[h].High=u[h].Low}}y(l.fieldName,u);return}if(l.filterRestriction===s.single){if(!u[0].Low&&d&&d instanceof a){e[l.fieldName]=null}else{e[l.fieldName]=_(u[0].Low)}}else if(l.filterRestriction===s.interval){if(d&&d instanceof r){if(u[0].Low&&u[0].High){e[l.fieldName]={low:_(u[0].Low),high:_(u[0].High)}}else if(u[0].Low&&!u[0].High){e[l.fieldName]={low:_(u[0].Low),high:_(u[0].Low)}}else if(!u[0].Low&&u[0].High){e[l.fieldName]={low:_(u[0].High),high:_(u[0].High)}}else{e[l.fieldName]={low:null,high:null}}}else{if(l.type==="Edm.Time"){y(l.fieldName,u)}else{e[l.fieldName]={low:u[0].Low===undefined?null:_(u[0].Low),high:u[0].High===undefined?null:_(u[0].High)}}}}else if(l.filterRestriction===s.multiple){e[l.fieldName]={ranges:[],items:[],value:null};var T=l.type==="Edm.DateTimeOffset"||l.isCalendarDate||l.type==="Edm.DateTime"||l.type==="Edm.Time";var M=d&&d.isA("sap.m.MultiInput")&&S(u);if(d&&!T&&(d.isA("sap.m.MultiComboBox")||d.isA("sap.m.MultiInput"))&&!M){var P;for(h=0;h<u.length;h++){P=_(u[h].Low);if(u[h].Option==="EQ"&&P===""){p={op:u[h].Option,v:P}}else{p=c.convertOption(u[h].Option,P)}if(p.op===f.EQ){e[l.fieldName].items.push({key:_(p.v)})}}}else{y(l.fieldName,u)}}else{y(l.fieldName,u)}n.warning("potential reduced information for filter '"+l.fieldName+"'")}else{n.warning("no Ranges-section found for filter '"+l.fieldName+"'")}};c.prototype._addAccordingMetaData=function(e,t,i,a){var r=i.type==="Edm.DateTime"?"":a;var n=[{Sign:"I",Low:a,High:r,Option:"EQ"}];this._addRangesAccordingMetaData(e,t,i,n)};return c},true);