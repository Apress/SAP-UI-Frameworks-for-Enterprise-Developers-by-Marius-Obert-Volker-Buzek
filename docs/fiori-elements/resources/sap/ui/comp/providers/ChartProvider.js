/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/odata/ChartMetadata","sap/ui/comp/odata/FiscalMetadata","sap/ui/comp/odata/CalendarMetadata","sap/ui/comp/odata/ODataType","./ControlProvider","sap/ui/core/format/DateFormat","sap/ui/core/date/UI5Date"],function(t,e,a,i,r,n,o,s){"use strict";var l=function(a){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");if(a){this._oParentODataModel=a.model;this.sEntitySet=a.entitySet;this._sIgnoredFields=a.ignoredFields;this._bSkipAnnotationParse=a.skipAnnotationParse==="true";this._sChartQualifier=a.chartQualifier;this._sPresentationVariantQualifier=a.presentationVariantQualifier;this._oDefaultDropDownDisplayBehaviour=a.defaultDropDownDisplayBehaviour;this._bUseTimeseries=a.useTimeSeries;this._sNotAssignedText=a.notAssignedText;try{this._oDateFormatSettings=a.dateFormatSettings?JSON.parse(a.dateFormatSettings):undefined;if(!this._oDateFormatSettings.hasOwnProperty("UTC")){this._oDateFormatSettings["UTC"]=true}}catch(t){}if(a.chartLibrary){e.feedWithChartLibrary(a.chartLibrary)}}this._aODataFieldMetadata=[];this._oChartViewMetadata=null;this._oChartDataPointMetadata=null;this._aIgnoredFields=[];this._oMetadataAnalyser=new t(this._oParentODataModel);this._intialiseMetadata()};l.prototype._intialiseMetadata=function(){var t,a=[],i,r,o=0;this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntitySet);this._sFullyQualifiedEntityTypeName=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.sEntitySet);if(!this._bSkipAnnotationParse){this._oPresentationVariant=this._oMetadataAnalyser.getPresentationVariantAnnotation(this._sFullyQualifiedEntityTypeName,this._sPresentationVariantQualifier);if(this._oPresentationVariant&&this._oPresentationVariant.chartAnnotation){this._oChartAnnotation=this._oPresentationVariant.chartAnnotation}else{this._oChartAnnotation=this._oMetadataAnalyser.getChartAnnotation(this._sFullyQualifiedEntityTypeName,this._sChartQualifier)}}if(!this._oDefaultDropDownDisplayBehaviour){this._oDefaultDropDownDisplayBehaviour=this._oMetadataAnalyser.getTextArrangementValue(this._sFullyQualifiedEntityTypeName)}this._generateIgnoredFieldsArray();this._oControlProvider=new n({metadataAnalyser:this._oMetadataAnalyser,model:this._oParentODataModel,fieldsMetadata:this._aODataFieldMetadata,dateFormatSettings:this._oDateFormatSettings,defaultDropDownDisplayBehaviour:this._oDefaultDropDownDisplayBehaviour,enableDescriptions:false,entitySet:this.sEntitySet});if(this._aODataFieldMetadata){this._prepareHierarchy();o=this._aODataFieldMetadata.length}for(r=0;r<o;r++){i=this._aODataFieldMetadata[r];if(this._aIgnoredFields.indexOf(i.name)>-1||!i.visible){continue}if(i.type.indexOf("Edm.")===0){t=this._getFieldViewMetadata(i);this._enrichWithChartViewMetadata(i,t);a.push(i)}}if(this._oChartAnnotation){this._oChartViewMetadata=Object.assign({},this._oChartAnnotation);this._oChartViewMetadata.chartType=e.getChartType(this._oChartViewMetadata.chartType);this._oChartViewMetadata.fields=a}};l.prototype._prepareHierarchy=function(){for(var t=0;t<this._aODataFieldMetadata.length;t++){if(this._aODataFieldMetadata[t].hierarchy){for(var e=0;e<this._aODataFieldMetadata.length;e++){this._aODataFieldMetadata[e].hierarchy=this._aODataFieldMetadata[e].hierarchy||{};this._aODataFieldMetadata[e].hierarchy.up=this._aODataFieldMetadata[e].hierarchy.up||{};if(this._aODataFieldMetadata[t].hierarchy.field===this._aODataFieldMetadata[e].name){this._aODataFieldMetadata[t].hierarchy.down=this._getFieldViewMetadata(this._aODataFieldMetadata[e]);this._aODataFieldMetadata[e].hierarchy.up[this._aODataFieldMetadata[t].hierarchy.type]=this._getFieldViewMetadata(this._aODataFieldMetadata[t])}}}}};l.prototype._setAnnotationMetadata=function(t){if(t&&t.fullName){var e=this._oMetadataAnalyser.getSemanticObjectsFromAnnotation(t.fullName);if(e){t.semanticObjects=e}}};l.prototype._getFieldViewMetadata=function(t){var e=this._oControlProvider.getFieldViewMetadata(t,false);this._setAnnotationMetadata(e);return e};l.prototype._generateIgnoredFieldsArray=function(){if(this._sIgnoredFields){this._aIgnoredFields=this._sIgnoredFields.split(",")}};l.prototype._enrichWithChartViewMetadata=function(e,a){function i(t,e,a){if(e.aggregationRole){return e.aggregationRole===t}if(a){var i=t=="dimension"?a.dimensionFields:a.measureFields;return i&&i.indexOf(e.name)!=-1}return false}e.isMeasure=i("measure",e,this._oChartAnnotation);e.isDimension=i("dimension",e,this._oChartAnnotation);e.isHierarchyDimension=e.hierarchy&&e.hierarchy.type===t.hierarchyType.nodeFor&&i("dimension",e.hierarchy.down,this._oChartAnnotation);e.quickInfo=a.quickInfo;e.modelType=a.modelType;e.hasValueListAnnotation=a.hasValueListAnnotation;e.fullName=a.fullName;e.timeUnitType=this._getTimeUnitType(e);e.dateFormatter=this._getDateFormatter(e);e.isTimeDimension=e.timeUnitType!==undefined;e.role=this._getRole(e);e.hierarchyLevel=this._getHierarchyLevel(e);e.dataPoint=this._getDataPoint(e);e.isNullable=t.isNullable(e);e.filterType=a.filterType;if(a.template){e.template=a.template}if(e.isDimension){e.displayBehaviour=a.displayBehaviour}else if(e.isHierarchyDimension){var r=e.hierarchy.up[t.hierarchyType.nodeExternalKeyFor]||a;e.displayBehaviour=r.displayBehaviour;e.description=r.description||r.name}e.isSemanticObject=a.semanticObjects?true:false;this._setInResult(e);this._setSortOrder(e)};l.prototype._getTimeUnitType=function(t){var e;switch(t.type){case"Edm.Date":e="Date";break;case"Edm.DateTime":case"Edm.DateTimeOffset":if(t.displayFormat==="Date"){e="Date"}break;case"Edm.String":if(t.isCalendarDate){e="yearmonthday";break}if(i.isYearWeek(t)){e="yearweek";break}if(i.isYearMonth(t)){e="yearmonth";break}if(i.isYearQuarter(t)){e="yearquarter";break}if(a.isFiscalYear(t)){e="fiscalyear";break}if(a.isFiscalYearPeriod(t)){e="fiscalyearperiod";break}break}return e};l.prototype._getDateFormatter=function(t){var e,a;switch(t.type){case"Edm.Date":a=o.getDateInstance(this._oDateFormatSettings);break;case"Edm.Time":a=o.getTimeInstance(this._oDateFormatSettings);break;case"Edm.DateTimeOffset":case"Edm.DateTime":if(t.displayFormat==="Date"){a=o.getDateInstance(this._oDateFormatSettings)}else{a=o.getDateTimeInstance(this._oDateFormatSettings)}break;case"Edm.String":if(t.isCalendarDate&&this._oDateFormatSettings){var i;var n={isCalendarDate:true};if(!e){var l=r.getType("Edm.String",this._oDateFormatSettings,i,n);e=function(t){return l.formatValue(t,"string")}}}else if(!this._bUseTimeseries){var i;var n={isCalendarDate:true};e=this._getDateFormatterForAnnotation(t,i,n)}break}if(a){e=function(t){if(t===""){return this._sNotAssignedText}if(!t){return null}var e=s.getInstance(t);return a.format(e)}.bind(this)}return e};l.prototype._getDateFormatterForAnnotation=function(t,e,a){var i={};var n=this._getParserSettingsForAnnotation(t);var s=this._getParserPrefixForAnnotation(t);if(this._oDateFormatSettings){Object.assign(i,this._oDateFormatSettings)}i.pattern=this._getFormatterPatternForAnnotation(t);if(i.pattern){var l=r.getType("Edm.String",i,e,a);var h=function(t){if(t==""){return this._sNotAssignedText}t=o.getInstance({pattern:n}).parse(t);return s+l.formatValue(t,"string")}.bind(this);return h}};l.prototype._getParserPrefixForAnnotation=function(t){if(i.isYearWeek(t)){return"CW "}else if(i.isYearQuarter(t)){return"Q"}return""};l.prototype._getParserSettingsForAnnotation=function(t){if(t.type==="Edm.String"){var e;if(i.isYearWeek(t)){e="yyyyww"}else if(i.isYearMonth(t)){e="yyyyMM"}else if(i.isYearQuarter(t)){e="yyyyQQQQQ"}return e}};l.prototype._getFormatterPatternForAnnotation=function(t){if(t.type==="Edm.String"){var e;if(t.isCalendarDate){e="d MMMM y"}else if(i.isYearWeek(t)){e="ww y"}else if(i.isYearMonth(t)){e="MMMM y"}else if(i.isYearQuarter(t)){e="Q y"}return e}};l.prototype._setInResult=function(t){if(this._oPresentationVariant){if(this._oPresentationVariant.requestAtLeastFields&&this._oPresentationVariant.requestAtLeastFields.indexOf(t.name)>-1){t.inResult=true}}};l.prototype._setSortOrder=function(t){t.sorted=false;t.sortOrder="Ascending";var e;if(this._oPresentationVariant&&this._oPresentationVariant.sortOrderFields){e=this._oPresentationVariant.sortOrderFields.length;for(var a=0;a<e;a++){if(this._oPresentationVariant.sortOrderFields[a].name===t.name){t.sorted=true;t.sortOrder=this._oPresentationVariant.sortOrderFields[a].descending?"Descending":"Ascending";t.sortIndex=a;break}}}};l.prototype._unmarkTextDimensions=function(t,e){var a,i;for(a=0;a<t.length;a++){i=t[a];if(i.isDimension){if(e.indexOf(i.name)>-1){i.isDimension=false}}}};l.prototype._getRole=function(t){if(this._oChartAnnotation){if((t.isDimension||t.isHierarchyDimension)&&this._oChartAnnotation.dimensionAttributes[t.name]){return e.getDimensionRole(this._oChartAnnotation.dimensionAttributes[t.name].role)}else if(t.isMeasure&&this._oChartAnnotation.measureAttributes[t.name]){return e.getMeasureRole(this._oChartAnnotation.measureAttributes[t.name].role)}}};l.prototype._getHierarchyLevel=function(t){if(this._oChartAnnotation){if(t.isHierarchyDimension&&this._oChartAnnotation.dimensionAttributes[t.name]){var e=null;try{e=parseInt(this._oChartAnnotation.dimensionAttributes[t.name].hierarchyLevel)}catch(t){e=0}return e}return 0}};l.prototype._getTextPropertyForHierachyDimension=function(e){var a=e.hierarchy.up[t.hierarchyType.nodeExternalKeyFor]||e;return a.description||a.name};l.prototype._getDataPoint=function(t){if(this._oChartAnnotation&&t.isMeasure&&this._oChartAnnotation.measureAttributes[t.name]&&this._oChartAnnotation.measureAttributes[t.name].dataPoint){var e=this._oChartAnnotation.measureAttributes[t.name].dataPoint;var a=e.split("#");var i=a.length===2?a[1]:"";return this._getMeasureDataPoint(i,t.name)}return null};l.prototype.getChartViewMetadata=function(){return this._oChartViewMetadata};l.prototype.getViewField=function(t){var e=this._oChartViewMetadata.fields.filter(function(e){return e.name===t})[0];return e};l.prototype.getChartDataPointMetadata=function(){if(!this._oChartDataPointMetadata&&this._sFullyQualifiedEntityTypeName){this._oChartDataPointMetadata=this._oMetadataAnalyser.getDataPointAnnotation(this._sFullyQualifiedEntityTypeName)}return this._oChartDataPointMetadata};l.prototype._getMeasureDataPoint=function(t,e){var a=this.getChartDataPointMetadata();if(a){var i=null;if(t){if(a.additionalAnnotations){i=a.additionalAnnotations[t]}}else if(a.primaryAnnotation){i=a.primaryAnnotation}if(i!=null&&i.Value&&i.Value.Path==e){return i}}return null};l.prototype.getIsUTCDateHandlingEnabled=function(){return this._oDateFormatSettings?this._oDateFormatSettings.UTC:false};l.prototype.destroy=function(){if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy()}this._oMetadataAnalyser=null;if(this._oControlProvider&&this._oControlProvider.destroy){this._oControlProvider.destroy()}this._oControlProvider=null;this._aODataFieldMetadata=null;this._oChartViewMetadata=null;this._oChartDataPointMetadata=null;this._sIgnoredFields=null;this.bIsDestroyed=true};l.prototype.provideSemanticColoring=function(t){var a={};if(t.Criticality){if(t.Criticality.Path){a={Calculated:t.Criticality.Path}}else{a={Static:e.getCriticalityType(t.Criticality.EnumMember)}}}else{var i={};var r=this._buildThresholds(i,t.CriticalityCalculation);if(r){a={ConstantThresholds:i}}else{a={DynamicThresholds:i}}}return a};l.prototype.calculateDimensionColoring=function(t){var a=e.getValueCriticality(t);if(!a){return null}var i,r,n={Positive:{Values:[]},Critical:{Values:[]},Negative:{Values:[]},Neutral:{Values:[]}};for(var o=0;o<a.length;o++){r=a[o];i=e.calculateValue(r.Value);if(r.Criticality.EnumMember.endsWith("Positive")){n.Positive.Values.push(i)}else if(r.Criticality.EnumMember.endsWith("Critical")){n.Critical.Values.push(i)}else if(r.Criticality.EnumMember.endsWith("Negative")){n.Negative.Values.push(i)}else{n.Neutral.Values.push(i)}}return n};l.prototype._buildThresholds=function(t,a){var i=true;t.ImprovementDirection=e.getImprovementDirectionType(a.ImprovementDirection.EnumMember);var r=e.getCriticalityThresholds();var n=r.length;var o={oneSupplied:false};var s={oneSupplied:false};for(var l=0;l<n;l++){o[r[l]]=a[r[l]]?a[r[l]].Path:undefined;o.oneSupplied=o.oneSupplied||o[r[l]];if(!o.oneSupplied){s[r[l]]=e.calculateConstantValue(a[r[l]]);s.oneSupplied=s.oneSupplied||s[r[l]]}}if(o.oneSupplied){i=false;for(var l=0;l<n;l++){if(o[r[l]]){t[r[l]]=o[r[l]]}}}else{var h;t.AggregationLevels=[];if(s.oneSupplied){h={VisibleDimensions:null};for(var l=0;l<n;l++){if(s[r[l]]){h[r[l]]=s[r[l]]}}t.AggregationLevels.push(h)}if(a.ConstantThresholds&&a.ConstantThresholds.length>0){for(var l=0;l<a.ConstantThresholds.length;l++){var d=a.ConstantThresholds[l];var u=d.AggregationLevel?[]:null;if(d.AggregationLevel&&d.AggregationLevel.length>0){for(var f=0;f<d.AggregationLevel.length;f++){u.push(d.AggregationLevel[f].PropertyPath)}}h={VisibleDimensions:u};for(var f=0;f<n;f++){var y=e.calculateConstantValue(d[r[f]]);if(y){h[r[f]]=y}}t.AggregationLevels.push(h)}}}return i};l.prototype.getMaxItems=function(){var t=-1;if(this._oPresentationVariant&&this._oPresentationVariant.maxItems){t=this._oPresentationVariant.maxItems}return t};return l},true);