/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/date/UI5Date","sap/ui/thirdparty/jquery","sap/ui/comp/library","sap/m/library","sap/m/List","sap/m/ResponsivePopover","sap/m/StandardListItem","sap/m/Token","sap/m/Table","sap/m/ColumnListItem","sap/m/Label","./BaseValueListProvider","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/util/FormatUtil","sap/ui/comp/util/DateTimeUtil","sap/ui/model/json/JSONModel","sap/ui/core/format/DateFormat","sap/ui/Device","sap/ui/model/Sorter","sap/base/util/merge","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/VariantItem","sap/base/strings/capitalize"],function(e,t,i,a,s,l,o,r,n,h,u,p,d,g,c,f,m,y,S,_,V,D,v){"use strict";var C=i.valuehelpdialog.ValueHelpRangeOperation;var F={DeprecatedCode:"W",RevokedCode:"E",ValidCode:""};var b;var H=p.extend("sap.ui.comp.providers.ValueHelpProvider",{constructor:function(e){if(e){this.preventInitialDataFetchInValueHelpDialog=!!e.preventInitialDataFetchInValueHelpDialog;this.sTitle=e.title;this.bSupportMultiselect=!!e.supportMultiSelect;this.bSupportRanges=!!e.supportRanges;this.bIsSingleIntervalRange=!!e.isSingleIntervalRange;this.bIsSearchExpressionFilterRestriction=!!e.isSearchExpressionFilterRestriction;this.bIsUnrestrictedFilter=!!e.isUnrestrictedFilter;this.bTakeOverInputValue=e.takeOverInputValue===false?false:true;this._sScale=e.scale;this._sPrecision=e.precision;this._defaultOperation=e.defaultOperation?e.defaultOperation:null;this.filterBarClass=e.filterBarClass;this._onBeforeOpenValueHelpDialog=e._onBeforeOpenValueHelpDialog||function(){};this.enabledMultiSelectionPlugin=!!e.enabledMultiSelectionPlugin;if(this.bIsSingleIntervalRange){this.bSupportRanges=true}}p.apply(this,arguments);this._onInitialise()}});H.prototype._onInitialise=function(){if(this.oControl.attachValueHelpRequest){this._fVHRequested=function(e){if(!this.bInitialised){return}var t=e.getParameter("_userInputValue");this.oControl=e.getSource();this.bForceTriggerDataRetreival=e.getParameter("fromSuggestions");if(this.bSupportBasicSearch&&(this.bTakeOverInputValue||this.bForceTriggerDataRetreival)&&(t||t==="")){this.sBasicSearchText=t}this._createValueHelpDialog()}.bind(this);this.oControl.attachValueHelpRequest(this._fVHRequested)}};H.prototype._getEntitiesLazy=function(){return sap.ui.getCore().loadLibrary("sap.ui.mdc",{async:true}).then(function(){return new Promise(function(e){sap.ui.require(["sap/ui/mdc/filterbar/vh/CollectiveSearchSelect","sap/ui/comp/valuehelpdialog/ValueHelpDialog"],function(t,i){e([i,t])})})})};H.prototype._createValueHelpDialog=function(){if(!this.bCreated){this.bCreated=true;if(!this._oValueHelpDialogClass||!this._oCollectiveSearchSelectClass){this._getEntitiesLazy().then(this._onValueHelpDialogRequired.bind(this))}else{this._onValueHelpDialogRequired([this._oValueHelpDialogClass,this._oCollectiveSearchSelectClass])}}};H.prototype._getTitle=function(){if(this.sTitle){return this.sTitle}else if(this.oFilterProvider){return this.oFilterProvider._determineFieldLabel(this._fieldViewMetadata)}return""};H.prototype.getValueListAnnotation=function(){var e;if(this._isContextDependent()){e=this.oControl.getBindingContext()&&this.oControl.getBindingContext().getPath()}return this._oMetadataAnalyser.getValueListAnnotationLazy(this._sFullyQualifiedFieldName,e)};H.prototype._onValueHelpDialogRequired=function(e){if(this.bInitialised&&this.bIsContextDependent){this._bValueListRequested=false;return this._loadAnnotation().then(function(){return this._onInitValueHelpDialog(e)}.bind(this))}else{return this._onInitValueHelpDialog(e)}};H.prototype._onInitValueHelpDialog=function(e){this._oValueHelpDialogClass=e[0];this._oCollectiveSearchSelectClass=e[1];var i=this.oControl.getId()+"-valueHelpDialog";this.oValueHelpDialog=new this._oValueHelpDialogClass(i,{stretch:y.system.phone,basicSearchText:this.sBasicSearchText,supportRangesOnly:this.bIsSingleIntervalRange||!this.oPrimaryValueListAnnotation,supportMultiselect:this.bSupportMultiselect,title:this._getTitle(),supportRanges:this.bSupportRanges,displayFormat:this.sDisplayFormat,enabledMultiSelectionPlugin:!!this.enabledMultiSelectionPlugin,ok:this._onOK.bind(this),cancel:this._onCancel.bind(this),beforeOpen:function(){this._onBeforeOpenValueHelpDialog({fieldName:this.sFieldName,_switchView:this._switchView.bind(this)})}.bind(this),afterClose:function(){if(this.oPrimaryValueListAnnotation){this._resolveAnnotationData(this.oPrimaryValueListAnnotation)}this.oValueHelpDialog.destroy();this.bCreated=false;if(this.oControl&&this.oControl.focus&&!y.system.phone){this.oControl.focus()}}.bind(this)});if(this.oValueHelpDialog&&this._defaultOperation&&C[this._defaultOperation]){this.oValueHelpDialog.setConditionPanelDefaultOperation(this._defaultOperation)}if(this.oValueHelpDialog._oColSearchBox){this.oValueHelpDialog._oColSearchBox.destroy();this.oValueHelpDialog._oColSearchBox=null}this.oValueHelpDialog._oColSearchBox=new this._oCollectiveSearchSelectClass({visible:false,title:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("COLLECTIVE_SEARCH_SELECTION_TITLE")}).addStyleClass("sapUiTinyMarginEnd");this.oValueHelpDialog.setProperty("_enhancedExcludeOperations",true);this.oControl.addDependent(this.oValueHelpDialog);this.oValueHelpDialog.suggest(function(e,t){if(this.oPrimaryValueListAnnotation){var i=function(i){e.setShowSuggestion(true);e.setFilterSuggests(false);e._oSuggestProvider=new i({fieldName:t,control:e,model:this.oODataModel,displayFormat:this.sDisplayFormat,resolveInOutParams:false,displayBehaviour:this.sTokenDisplayBehaviour,annotation:this.oPrimaryValueListAnnotation,fieldViewMetadata:this._fieldViewMetadata,maxLength:this._sMaxLength,filterModel:this.oFilterModel,aggregation:"suggestionRows",typeAheadEnabled:true,enableShowTableSuggestionValueHelp:false})}.bind(this);b=sap.ui.require("sap/ui/comp/providers/ValueListProvider");if(!b){sap.ui.require(["sap/ui/comp/providers/ValueListProvider"],i)}else{i(b);return e._oSuggestProvider}return null}}.bind(this));if(this.bIsSingleIntervalRange){this.oValueHelpDialog.setIncludeRangeOperations([C.BT,C.EQ],this._sType);this.oValueHelpDialog.setMaxIncludeRanges(1);this.oValueHelpDialog.setMaxExcludeRanges(0);this.oValueHelpDialog.setMaxConditions(1);this.oValueHelpDialog.bIsSingleIntervalRange=this.bIsSingleIntervalRange;this._updateInitialInterval()}else if((this._sType==="date"||this._sType==="time"||this._sType==="datetime")&&!this.bIsUnrestrictedFilter){this.oValueHelpDialog.setIncludeRangeOperations([C.EQ],this._sType);this.oValueHelpDialog.setMaxExcludeRanges(0)}else if(this.bIsSearchExpressionFilterRestriction){this.oValueHelpDialog.setIncludeRangeOperations(d._getSearchExpressionRangeOperationsKeys(),d._getSearchExpressionType());this.oValueHelpDialog.setExcludeRangeOperations(d._getSearchExpressionRangeOperationsKeys(),d._getSearchExpressionType())}if(this.oControl.$()&&this.oControl.$().closest(".sapUiSizeCompact").length>0){this.oValueHelpDialog.addStyleClass("sapUiSizeCompact")}else if(this.oControl.$()&&this.oControl.$().closest(".sapUiSizeCozy").length>0){this.oValueHelpDialog.addStyleClass("sapUiSizeCozy")}else if(t("body").hasClass("sapUiSizeCompact")){this.oValueHelpDialog.addStyleClass("sapUiSizeCompact")}else{this.oValueHelpDialog.addStyleClass("sapUiSizeCozy")}if(this.bSupportRanges){this.oValueHelpDialog.setRangeKeyFields([{label:this._getTitle(),key:this.sFieldName,typeInstance:this._fieldViewMetadata?this._fieldViewMetadata.ui5Type:null,type:this._sType,formatSettings:this._sType==="numc"?{isDigitSequence:true,maxLength:this._sMaxLength}:Object.assign({},this._oDateFormatSettings,{UTC:false}),scale:this._sScale,precision:this._sPrecision,maxLength:this._sMaxLength,nullable:this._fieldViewMetadata?this._fieldViewMetadata.nullable:false}])}if(!(this.bIsSingleIntervalRange||!this.oPrimaryValueListAnnotation)){this.oValueHelpDialog.setModel(this.oODataModel);this._createAdditionalValueHelpControls();this._createCollectiveSearchControls()}if(this.oControl.getTokens){var a=this.oControl.getTokens();if(a){a=this._adaptTokensFromFilterBar(a);this.oValueHelpDialog.setTokens(a)}}return Promise.resolve().then(this.oValueHelpDialog.open.bind(this.oValueHelpDialog))};H.prototype._isContextDependent=function(){var e,t;if(this.bIsContextDependent===undefined){t=this._oMetadataAnalyser.getPropertyContextByPath(this._sFullyQualifiedFieldName);if(t){e=t.getObject();if(d.hasValueListRelevantQualifiers(e)){this.bIsContextDependent=true}}}return this.bIsContextDependent};H.prototype._adaptTokensFromFilterBar=function(e){var t,i,a,s=e;if(this.oFilterProvider&&e&&this._sType==="time"){s=[];for(var l=0;l<e.length;l++){t=_({},e[l]);i=t.data("range");if(i){i=_({},i);if(i.value1 instanceof Date){a=c.localToUtc(i.value1);i.value1={__edmType:"Edm.Time",ms:a.getTime()}}if(i.value2 instanceof Date){a=c.localToUtc(i.value2);i.value2={__edmType:"Edm.Time",ms:a.getTime()}}t.data("range",i);s.push(t)}}}return s};H.prototype._updateInitialInterval=function(){var t=this.oControl.getValue(),i,a,s,l,o;if(t){i=new r;a={exclude:false,keyField:this.sFieldName};if(this._sType==="numeric"){s=g.parseFilterNumericIntervalData(t);if(s.length==0){s.push(t)}}else if(this._sType==="datetime"){s=g.parseDateTimeOffsetInterval(t);l=m.getDateTimeInstance(Object.assign({},this._oDateFormatSettings,{UTC:false}));o=l.parse(s[0]);s[0]=o?o:e.getInstance(s[0]);if(s.length===2){o=l.parse(s[1]);s[1]=o?o:e.getInstance(s[1])}}else{s=t.split("-")}if(s&&s.length===2){a.operation="BT";a.value1=s[0];a.value2=s[1]}else{a.operation="EQ";a.value1=s[0]}i.data("range",a)}if(i){this.oValueHelpDialog.setTokens([i])}};H.prototype._createCollectiveSearchControls=function(){var e,t=0,i=0,a,s;if(this.additionalAnnotations&&this.additionalAnnotations.length){a=function(e){var t,i,a,s=e.getParameter("key"),l=e.getSource(),o=l&&l.getItems();for(var r=0;r<o.length;r++){a=o[r];if(a.getKey()===s){t=a;break}}if(t){i=t.data("_annotation");if(i){this._triggerAnnotationChange(i)}}}.bind(this);e=new v({key:this.oPrimaryValueListAnnotation.keyField,text:this.oPrimaryValueListAnnotation.valueListTitle});e.data("_annotation",this.oPrimaryValueListAnnotation);this.oValueHelpDialog._oColSearchBox.addItem(e);this.oValueHelpDialog._oColSearchBox.setSelectedItemKey(this.oPrimaryValueListAnnotation.keyField);i=this.additionalAnnotations.length;for(t=0;t<i;t++){s=this.additionalAnnotations[t];e=new v({key:s.qualifier,text:s.valueListTitle});e.data("_annotation",s);this.oValueHelpDialog._oColSearchBox.addItem(e)}this.oValueHelpDialog._oColSearchBox.attachSelect(a);this.oValueHelpDialog._oColSearchBox.setVisible(true)}};H.prototype._triggerAnnotationChange=function(e){this.oValueHelpDialog.resetTableState();this._resolveAnnotationData(e);this._createAdditionalValueHelpControls()};H.prototype._createAdditionalValueHelpControls=function(){var e=null,t=this.filterBarClass;this.oValueHelpDialog.setKey(this.sKey);this.oValueHelpDialog.setKeys(this._aKeys);this.oValueHelpDialog.setDescriptionKey(this.sDescription);this.oValueHelpDialog.setTokenDisplayBehaviour(this.sTokenDisplayBehaviour);var i=new f;i.setData({cols:this._aCols});this.oValueHelpDialog.setModel(i,"columns");if(this.bSupportBasicSearch){e=this.sKey}if(this.oSmartFilterBar){this.oSmartFilterBar._setCollectiveSearch(null);this.oSmartFilterBar.destroy()}if(!t){t=sap.ui.require("sap/ui/comp/smartfilterbar/SmartFilterBar")}this.oSmartFilterBar=new t(this.oValueHelpDialog.getId()+"-smartFilterBar",{entitySet:this.sValueListEntitySetName,basicSearchFieldName:e,enableBasicSearch:this.bSupportBasicSearch,isRunningInValueHelpDialog:true,advancedMode:true,showGoOnFB:!y.system.phone,filterBarExpanded:false,search:this._onFilterBarSearchPressed.bind(this),reset:this._onFilterBarResetPressed.bind(this),filterChange:this._onFilterBarFilterChange.bind(this),initialise:this._onFilterBarInitialise.bind(this)});if(this._oDateFormatSettings){this.oSmartFilterBar.data("dateFormatSettings",this._oDateFormatSettings)}if(this.oPrimaryValueListAnnotation&&this.oPrimaryValueListAnnotation.constParams){this.oSmartFilterBar.data("hiddenFields",Object.keys(this.oPrimaryValueListAnnotation.constParams))}this.oValueHelpDialog.setFilterBar(this.oSmartFilterBar)};H.prototype._onFilterBarFilterChange=function(){if(!this._bIgnoreFilterChange){this.oValueHelpDialog.getTableAsync().then(function(e){e.setShowOverlay(true);this.oValueHelpDialog.TableStateSearchData()}.bind(this))}};H.prototype._expandFilterBar=function(){var e=this.oFilterProvider&&this.oFilterProvider._oAdditionalConfiguration,t=e?e.getControlConfigurationByKey(this._fieldViewMetadata.fieldName):null;if(this.oSmartFilterBar._hasMandatoryFields()){this.oSmartFilterBar.setFilterBarExpanded(true);this.oSmartFilterBar._bShowAllFilters=true;this.oSmartFilterBar.rerenderFilters()}else if(!this.bSupportBasicSearch||this.oFilterProvider&&this.oFilterProvider._getPreventInitialDataFetchInValueHelpDialog(this._fieldViewMetadata,t)){this.oSmartFilterBar.setFilterBarExpanded(true)}};H.prototype._onFilterBarSearchPressed=function(){this._rebindTable()};H.prototype._rebindTable=function(){var e,t,i,a;e=this.oSmartFilterBar.getFilters();a=this.oPrimaryValueListAnnotation.deprecationCodeField;if(a){if(e.length===0||e.length>0&&!this._checkForExistingRevokedFilters(e[0],a)){e.push(new V(a,D.NE,F.RevokedCode))}}t=this.oSmartFilterBar.getParameters()||{};if(this.aSelect&&this.aSelect.length){t["select"]=this.aSelect.toString()}i={path:"/"+this.sValueListEntitySetName,filters:e,parameters:t,events:{dataReceived:function(e){this.oValueHelpDialog.TableStateDataFilled();var t=e.getSource();this.oValueHelpDialog.getTableAsync().then(function(e){if(t&&this.oValueHelpDialog&&this.oValueHelpDialog.isOpen()){var i=t.getLength();if(i){this.oValueHelpDialog.update()}else{this.oValueHelpDialog._updateTitles()}}}.bind(this))}.bind(this)}};this.oValueHelpDialog.getTableAsync().then(function(e){e.setShowOverlay(false);this.oValueHelpDialog.TableStateDataSearching();e.setEnableBusyIndicator(true);if(e instanceof n){var t;if(this.sKey&&this._oMetadataAnalyser){t=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sValueListEntitySetName);for(var a=0;a<t.length;a++){if(t[a].name===this.sKey&&t[a].sortable!==false){i.sorter=new S(this.sKey);break}}}i.factory=function(t,i){var a=e.getModel("columns").getData().cols;return new h({cells:a.map(function(e){var t=e.template;return new u({text:"{"+t+"}"})})})};e.bindItems(i)}else{var s=e.getColumns();for(var a=0;a<s.length;a++){var l=s[a];l._appDefaults=null;if(i&&i.parameters&&i.parameters.custom){var o=i.parameters.custom.search?false:l.getBindingContext("columns").getProperty("sorted");l.setSorted(o)}}s=e.getSortedColumns();if(!s||s.length==0){s=e.getColumns()}for(var a=0;a<s.length;a++){var l=s[a];if(l.getSorted()){if(!i.sorter){i.sorter=[]}i.sorter.push(new S(l.getSortProperty(),l.getSortOrder()==="Descending"))}}e.bindRows(i)}}.bind(this))};H.prototype._checkForExistingRevokedFilters=function(e,t){var i=false;if(e.sPath===t&&e.sOperator===C.EQ&&e.oValue1===F.RevokedCode){i=true}else if(Array.isArray(e.aFilters)){for(var a=0;a<e.aFilters.length;a++){i=this._checkForExistingRevokedFilters(e.aFilters[a],t);if(i){break}}}return i};H.prototype._onFilterBarResetPressed=function(){this._calculateFilterInputData();if(this.oSmartFilterBar){this.oSmartFilterBar.setFilterData(this.mFilterInputData)}};H.prototype._onFilterBarInitialise=function(){var e=null;this._bIgnoreFilterChange=true;this._onFilterBarResetPressed();delete this._bIgnoreFilterChange;if(this.oSmartFilterBar&&this.oSmartFilterBar.getBasicSearchControl){e=this.oSmartFilterBar.getBasicSearchControl();if(e){e.setValue(this.sBasicSearchText);if(y.system.phone&&e.isA("sap.m.SearchField")){e.setShowSearchButton(true)}}}if(!this.preventInitialDataFetchInValueHelpDialog||this.bForceTriggerDataRetreival){this._rebindTable();this.bForceTriggerDataRetreival=false}if(y.system.desktop){this._expandFilterBar()}};H.prototype._onOK=function(t){var i=t.getParameter("_tokensHaveChanged"),a=t.getParameter("tokens"),s,l,o=0,r=[],n=null,h,u={},p;this._onCancel();if(!i){return}if(this.oControl.isA("sap.m.MultiInput")){this.oControl.setValue("");this.oControl.destroyTokens();this.oControl.setTokens(a);o=a.length;if(o>0){u.type="added";u.addedTokens=a}this.oControl.fireTokenUpdate(u);while(o--){n=a[o].data("row");if(n){r.push(n)}}}else{if(a[0]){if(this.bIsSingleIntervalRange){s=a[0].data("range");if(s){if(this._sType==="datetime"){h=m.getDateTimeInstance(Object.assign({},this._oDateFormatSettings,{UTC:false}));if(typeof s.value1==="string"){s.value1=e.getInstance(s.value1)}if(s.operation==="BT"){if(typeof s.value2==="string"){s.value2=e.getInstance(s.value2)}l=h.format(s.value1)+"-"+h.format(s.value2)}else{l=h.format(s.value1)}}else{if(s.operation==="BT"){l=s.value1+"-"+s.value2}else{l=s.value1}}}}else{l=a[0].getKey()}n=a[0].data("row");if(n){p="/"+encodeURIComponent(a[0].data("longKey"));r.push(n)}a[0].destroy()}if(this.sContext==="SmartField"&&this._selectedODataRowHandler){this._selectedODataRowHandler(l,r[0],p)}this.setValue(l);if(this.sContext==="SmartFilterBar"&&!this.bIsSingleIntervalRange){var d=r[0]&&r[0][this.sDescription];this.oControl.setValue(g.getFormattedExpressionFromDisplayBehaviour(this.sSingleFieldDisplayBehaviour,l,d));this.oControl.setValueState("None");this.oFilterProvider.oModel.setProperty("/"+this.sFieldName,l);this.oFilterProvider._setSingleInputsTextArrangementFieldData(this.sFieldName,l,d)}this.oControl.fireChange({value:l,validated:true})}if(this.fnAsyncWritePromise){this.fnAsyncWritePromise().then(this._calculateAndSetFilterOutputData.bind(this,r))}else{this._calculateAndSetFilterOutputData(r)}};H.prototype._onCancel=function(){this.oValueHelpDialog.close();this.oValueHelpDialog.setModel(null)};H.prototype._switchView=function(e){if(!(this.oValueHelpDialog&&this.oValueHelpDialog._oColSearchBox)){return}var t=this.oValueHelpDialog._oColSearchBox,i=t.getItems(),a=i.find(function(t){return t.getKey()===e});if(a){this._triggerAnnotationChange(a.data("_annotation"));this.oValueHelpDialog._oColSearchBox.setSelectedItemKey(a.getKey())}};H.prototype.destroy=function(){if(this.oControl&&this.oControl.detachValueHelpRequest){this.oControl.detachValueHelpRequest(this._fVHRequested);this._fVHRequested=null}p.prototype.destroy.apply(this,arguments);if(this.oValueHelpDialog){this.oValueHelpDialog.destroy();this.oValueHelpDialog=null}if(this.oSmartFilterBar){this.oSmartFilterBar.destroy();this.oSmartFilterBar=null}this.sTitle=null};return H});