/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["./BaseController","sap/m/library","sap/ui/comp/library","./Util","sap/ui/comp/odata/ChartMetadata","sap/m/MessageStrip"],function(e,t,i,a,n,r){"use strict";var o=e.extend("sap.ui.comp.personalization.DimeasureController",{constructor:function(i,a){e.apply(this,arguments);this.setType(t.P13nPanelType.dimeasure);this.setItemType(t.P13nPanelType.dimeasure+"Items");this.CHARTLAYOUT_AXIS1="axis1";this.CHARTLAYOUT_AXIS2="axis2";this.CHARTLAYOUT_AXIS3="axis3";this.CHARTLAYOUT_CATEGORY="category";this.CHARTLAYOUT_CATEGORY2="category2";this.CHARTLAYOUT_SERIES="series"},metadata:{events:{afterDimeasureModelDataChange:{}}}});o.prototype.setTable=function(t){e.prototype.setTable.apply(this,arguments);if(this.getTableType()!==i.personalization.TableType.ChartWrapper){throw"The provided object is incorrect. 'oTable' has to be an instance of sap.ui.comp.personalization.ChartWrapper. "}var a=t.getChartObject();a.detachDrilledDown(this._onDrilledDown,this);a.attachDrilledDown(this._onDrilledDown,this);a.detachDrilledUp(this._onDrilledUp,this);a.attachDrilledUp(this._onDrilledUp,this);this._monkeyPatchTable(a)};o.prototype._monkeyPatchTable=function(e){var t=this;var i=e.setChartType.bind(e);var a=function(e){i(e);t._onSetChartType(e)};if(e.setChartType.toString()===a.toString()){return}e.setChartType=a};o.prototype._onSetChartType=function(e){var t=this.getControlData();if(!e||e===t.dimeasure.chartTypeKey){return}this.fireBeforePotentialTableChange();t.dimeasure.chartTypeKey=e;this.updateControlDataBaseFromJson(t);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange()};o.prototype._onDrilledDown=function(e){this.fireBeforePotentialTableChange();this._addVisibleDimensions(e.getParameter("dimensions")||[]);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange()};o.prototype._addVisibleDimensions=function(e){if(!e.length){return}var t=this.getControlData();var n=t.dimeasure.dimeasureItems.filter(function(t){return t.visible&&t.aggregationRole===i.personalization.AggregationRole.Dimension&&e.indexOf(t.columnKey)<0}).reduce(function(e,t){return t.columnKey},"");e.forEach(function(e){var i=a.getIndexByKey("columnKey",n,t.dimeasure.dimeasureItems)+1;var r=a.getIndexByKey("columnKey",e,t.dimeasure.dimeasureItems);n=e;if(r<0||i<0||r>t.dimeasure.dimeasureItems.length-1||i>t.dimeasure.dimeasureItems.length-1){return}var o=t.dimeasure.dimeasureItems.splice(r,1);o[0].visible=true;t.dimeasure.dimeasureItems.splice(i,0,o[0]);var s=-1;t.dimeasure.dimeasureItems.forEach(function(e){if(e.index!==undefined){e.index=++s}});this.updateControlDataBaseFromJson(t)},this)};o.prototype._onDrilledUp=function(e){this.fireBeforePotentialTableChange();var t=this.getControlData();var i=e.getParameter("dimensions")||[];i.forEach(function(e){var i=a.getArrayElementByKey("columnKey",e,t.dimeasure.dimeasureItems);if(!i){throw"No entry found in 'controlDataBase' for columnKey '"+e+"'"}i.visible=false;this.updateControlDataBaseFromJson(t)},this);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange()};o.prototype.getColumn2Json=function(e,t,i){if(!a.isAggregatable(e)){return null}return{columnKey:t,index:i,visible:e.getVisible(),role:e.getRole(),aggregationRole:e.getAggregationRole()}};o.prototype.getAdditionalData2Json=function(e,t){var i=t.getChartObject();e.dimeasure.chartTypeKey=i.getChartType()};o.prototype.getColumn2JsonTransient=function(e,t,i,n){if(!a.isAggregatable(e)){return null}return{columnKey:t,text:i,tooltip:n!==i?n:undefined,aggregationRole:e.getAggregationRole()}};o.prototype.handleIgnore=function(e,t){e.dimeasure.dimeasureItems[t].visible=false};o.prototype.syncJson2Table=function(e){var t=this.getTable().getChartObject();var n=function(e,t,i,n){var r=a.copy(e);r.sort(o._sortByIndex);var s=[];r.forEach(function(e){if(e.visible===true){s.push(e.columnKey);var t=n(e.columnKey);if(t){t.setRole(e.role)}}});if(JSON.stringify(s)!==JSON.stringify(t)){i(s,true)}};this.fireBeforePotentialTableChange();var r=e.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Dimension});var s=e.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Measure});var u=t.getVisibleDimensions();n(r,u,t.setVisibleDimensions.bind(t),t.getDimensionByName.bind(t));var l=t.getVisibleMeasures();n(s,l,t.setVisibleMeasures.bind(t),t.getMeasureByName.bind(t));t.setChartType(e.dimeasure.chartTypeKey);this.fireAfterPotentialTableChange()};o.prototype.getDataSuiteFormat2Json=function(e){var t=this.createControlDataStructure();var r=function(e,i,n){var r=a.getIndexByKey("columnKey",e,t.dimeasure.dimeasureItems);if(r<0){r=t.dimeasure.dimeasureItems.length;t.dimeasure.dimeasureItems.splice(r,0,{columnKey:e})}t.dimeasure.dimeasureItems[r][i]=n};this.getControlDataInitial().dimeasure.dimeasureItems.filter(function(e){return e.visible===true}).forEach(function(e){r(e.columnKey,"visible",false)});if(e.Visualizations&&e.Visualizations.length){var o=e.Visualizations.filter(function(e){return e.Type==="Chart"});if(o.length){var s=0;if(o[0].Content.Dimensions.length){s=o[0].Content.Dimensions.length;o[0].Content.Dimensions.forEach(function(e,t){var s=a.getArrayElementByKey("Dimension",e,o[0].Content.DimensionAttributes);r(e,"visible",true);r(e,"index",t);if(s&&s.Role){r(e,"role",n.getDimensionRole(s.Role))}r(e,"aggregationRole",i.personalization.AggregationRole.Dimension)},this)}if(o[0].Content.Measures.length){o[0].Content.Measures.forEach(function(e,t){var u=a.getArrayElementByKey("Measure",e,o[0].Content.MeasureAttributes);r(e,"visible",true);r(e,"index",s+t);if(u&&u.Role){r(e,"role",n.getMeasureRole(u.Role))}r(e,"aggregationRole",i.personalization.AggregationRole.Measure)},this)}}t.dimeasure.chartTypeKey=n.getChartType(o[0].Content.ChartType)}return t};o.prototype.getDataSuiteFormatSnapshot=function(e){var t=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!t.dimeasure||!t.dimeasure.dimeasureItems||!t.dimeasure.dimeasureItems.length){return}var a=t.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Dimension}).filter(function(e){return e.visible===true});var r=t.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Measure}).filter(function(e){return e.visible===true});if(a.length||r.length){if(!e.Visualizations){e.Visualizations=[]}e.Visualizations.push({Type:"Chart",Content:{ChartType:n.getAnnotationChartType(t.dimeasure.chartTypeKey),Dimensions:a.sort(function(e,t){return e.index-t.index}).map(function(e){return e.columnKey}),DimensionAttributes:a.sort(function(e,t){return e.index-t.index}).map(function(e){return{Dimension:e.columnKey,Role:n.getAnnotationDimensionRole(e.role)}}),Measures:r.sort(function(e,t){return e.index-t.index}).map(function(e){return e.columnKey}),MeasureAttributes:r.sort(function(e,t){return e.index-t.index}).map(function(e){return{Measure:e.columnKey,Role:n.getAnnotationMeasureRole(e.role)}})}})}};o.prototype.getPanel=function(e){if(!a.hasAggregatableColumns(this.getColumnMap())){return null}var t=e&&e.availableChartTypes?e.availableChartTypes:[];return new Promise(function(e){sap.ui.require(["sap/m/P13nDimMeasurePanel","sap/m/P13nItem","sap/m/P13nDimMeasureItem","sap/ui/core/ResizeHandler"],function(i,n,r,o){var s=new i({availableChartTypes:t,chartTypeKey:"{$sapmP13nPanel>/controlDataReduce/dimeasure/chartTypeKey}",items:{path:"$sapmP13nPanel>/transientData/dimeasure/dimeasureItems",template:new n({columnKey:"{$sapmP13nPanel>columnKey}",text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",aggregationRole:"{$sapmP13nPanel>aggregationRole}"})},dimMeasureItems:{path:"$sapmP13nPanel>/controlDataReduce/dimeasure/dimeasureItems",template:new r({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",role:"{$sapmP13nPanel>role}"})},beforeNavigationTo:this.setModelFunction(),changeChartType:function(e){var t=this.getControlDataReduce();t.dimeasure.chartTypeKey=e.getParameter("chartTypeKey");this.setControlDataReduce2Model(t);this.fireAfterPotentialModelChange({json:t})}.bind(this),changeDimMeasureItems:function(e){if(!e.getParameter("items")){return}var t=e.getParameter("items");var i=this.getControlDataReduce();i.dimeasure.dimeasureItems.forEach(function(e){var i=a.getArrayElementByKey("columnKey",e.columnKey,t);if(!i){return}e.index=i.index;e.visible=i.visible;e.role=i.role});this.setControlDataReduce2Model(i);this.fireAfterPotentialModelChange({json:i})}.bind(this)});o.deregister(s._sContainerResizeListener);return e(s)}.bind(this))}.bind(this))};o.prototype.getChartTypeLayoutConfig=function(){if(this._aChartTypeLayout){return this._aChartTypeLayout}var e=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];var t=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_AXIS2,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];var i=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_CATEGORY2];var a=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_AXIS2,this.CHARTLAYOUT_AXIS3,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];this._aChartTypeLayout=[{key:"column",allowedLayoutOptions:e},{key:"bar",allowedLayoutOptions:e},{key:"line",allowedLayoutOptions:e},{key:"combination",allowedLayoutOptions:e},{key:"pie",allowedLayoutOptions:e},{key:"donut",allowedLayoutOptions:e},{key:"dual_column",allowedLayoutOptions:t},{key:"dual_bar",allowedLayoutOptions:t},{key:"dual_line",allowedLayoutOptions:t},{key:"stacked_bar",allowedLayoutOptions:e},{key:"scatter",allowedLayoutOptions:t},{key:"bubble",allowedLayoutOptions:a},{key:"heatmap",allowedLayoutOptions:i},{key:"bullet",allowedLayoutOptions:e},{key:"vertical_bullet",allowedLayoutOptions:e},{key:"dual_stacked_bar",allowedLayoutOptions:t},{key:"100_stacked_bar",allowedLayoutOptions:e},{key:"stacked_column",allowedLayoutOptions:e},{key:"dual_stacked_column",allowedLayoutOptions:t},{key:"100_stacked_column",allowedLayoutOptions:e},{key:"dual_combination",allowedLayoutOptions:t},{key:"dual_horizontal_combination",allowedLayoutOptions:t},{key:"dual_horizontal_combination",allowedLayoutOptions:t},{key:"dual_stacked_combination",allowedLayoutOptions:t},{key:"dual_horizontal_stacked_combination",allowedLayoutOptions:t},{key:"stacked_combination",allowedLayoutOptions:e},{key:"100_dual_stacked_bar",allowedLayoutOptions:e},{key:"100_dual_stacked_column",allowedLayoutOptions:e},{key:"horizontal_stacked_combination",allowedLayoutOptions:e},{key:"waterfall",allowedLayoutOptions:i},{key:"horizontal_waterfall",allowedLayoutOptions:i}];return this._aChartTypeLayout};o.prototype._getTimeseriesSpecificPanelLayout=function(e){if(e.includes("timeseries")){var t=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];this._aChartTypeLayoutTimeseries=[{key:"timeseries_scatter",allowedLayoutOptions:t}];var i=this._aChartTypeLayoutTimeseries.find(function(t){return t.key===e});if(i){return i}else{var a=e.replace("timeseries_","");return this.getChartTypeLayoutConfig().find(function(e){return e.key===a})}}return undefined};o.prototype.retrieveAdaptationUI=function(e){function t(e,t){if(!e.hasOwnProperty("index")||!t.hasOwnProperty("index")){return 0}if(e.index<t.index){return-1}if(e.index>t.index){return 1}return 0}var i;var n=new Promise(function(e,t){i=e});sap.ui.require(["sap/ui/mdc/p13n/panels/ChartItemPanel"],function(e){var n,o=this.getControlDataReduce().dimeasure.chartTypeKey;var s=[{kind:"Dimension"},{kind:"Measure"}];if(o.includes("timeseries")){n=this._getTimeseriesSpecificPanelLayout(o)}if(!n){n=this.getChartTypeLayoutConfig().find(function(e){return e.key===o})}if(!n){var u=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_AXIS2,this.CHARTLAYOUT_AXIS3,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_CATEGORY2,this.CHARTLAYOUT_SERIES];n={key:o,allowedLayoutOptions:u}}n.templateConfig=s;var l=new e({panelConfig:n,changeItems:function(e){if(!e.getParameter("items")){return}var t=e.getParameter("items");var i=this.getControlDataReduce();i.dimeasure.dimeasureItems.forEach(function(e){var i=a.getArrayElementByKey("columnKey",e.columnKey,t);if(!i){return}e.index=i.index;e.visible=i.visible;e.role=i.role});this.setControlDataReduce2Model(i);this.fireAfterPotentialModelChange({json:i})}.bind(this)});var d=this.getAdaptationData().sort(t);l.setP13nData(d);this.oPanel=l;if(o==="heatmap"||o==="timeseries_heatmap"){var m=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");l.setMessageStrip(new r({text:m.getText("chart.PERSONALIZATION_DIALOG_MEASURE_WARNING"),type:"Warning"}))}i(l)}.bind(this));return n};o.prototype._transformAdaptationData=function(t,i){var a=e.prototype._transformAdaptationData.apply(this,arguments);a.visible=t.visible;a.role=t.role;a.kind=t.aggregationRole;a.index=t.index;return a};o.prototype._isDimMeasureItemEqual=function(e,t){if(!e&&!t){return true}if(e&&!t){if(e.index===-1&&e.visible===false){return true}return false}if(t&&!e){if(t.index===-1&&t.visible===false){return true}return false}for(var i in e){if(t[i]===undefined||e[i]!==t[i]){return false}}return true};o.prototype._isSemanticEqual=function(e,t){if(e.dimeasure.chartTypeKey!==t.dimeasure.chartTypeKey){return false}var i=function(e,t){if(e.visible===true&&(t.visible===false||t.visible===undefined)){return-1}else if((e.visible===false||e.visible===undefined)&&t.visible===true){return 1}else if(e.visible===true&&t.visible===true){if(e.index<t.index){return-1}else if(e.index>t.index){return 1}else{return 0}}else if((e.visible===false||e.visible===undefined)&&(t.visible===false||t.visible===undefined)){if(e.columnKey<t.columnKey){return-1}else if(e.columnKey>t.columnKey){return 1}else{return 0}}};var n=a.copy(e.dimeasure.dimeasureItems).sort(i);var r=a.copy(t.dimeasure.dimeasureItems).sort(i);var o=true;n.some(function(e,t){if(!this._isDimMeasureItemEqual(e,r[t])){o=false;return true}},this);return o};o.prototype.getChangeType=function(e,t){if(!t||!t.dimeasure||!t.dimeasure.dimeasureItems){return i.personalization.ChangeType.Unchanged}return this._isSemanticEqual(e,t)?i.personalization.ChangeType.Unchanged:i.personalization.ChangeType.ModelChanged};o.prototype.getChangeData=function(e,t){if(!e||!e.dimeasure||!e.dimeasure.dimeasureItems){return this.createControlDataStructure()}if(!t||!t.dimeasure||!t.dimeasure.dimeasureItems){return{chartTypeKey:e.dimeasure.chartTypeKey,dimeasure:a.copy(e.dimeasure)}}if(!this._isSemanticEqual(e,t)){return{chartTypeKey:e.dimeasure.chartTypeKey,dimeasure:a.copy(e.dimeasure)}}return null};o.prototype.getUnionData=function(e,t){if(!t||!t.dimeasure||!t.dimeasure.dimeasureItems){return a.copy(e)}var i=a.copy(t);Object.keys(e.dimeasure).forEach(function(t){if(Array.isArray(e.dimeasure[t])){e.dimeasure[t].forEach(function(e){var n=a.getArrayElementByKey("columnKey",e.columnKey,i.dimeasure[t]);if(!n){i.dimeasure[t].push(e);return}if(n.visible===undefined&&e.visible!==undefined){n.visible=e.visible}if(n.role===undefined&&e.role!==undefined){n.role=e.role}if(n.index===undefined&&e.index!==undefined){n.index=e.index}if(n.aggregationRole===undefined&&e.aggregationRole!==undefined){n.aggregationRole=e.aggregationRole}});return}if(i.dimeasure[t]===undefined&&e.dimeasure[t]!==undefined){i.dimeasure[t]=e.dimeasure[t]}},this);return i};o._sortByIndex=function(e,t){if(e.index!==undefined&&t.index===undefined){return-1}if(t.index!==undefined&&e.index===undefined){return 1}if(e.index<t.index){return-1}if(e.index>t.index){return 1}return 0};o.prototype.isChartConsistent=function(e){var t=this.getTable();if(!t){return Promise.resolve(true)}var i=t.getChartObject();if(!i){return Promise.resolve(true)}return sap.ui.getCore().loadLibrary("sap.chart",{async:true}).then(function(){try{var t=sap.ui.require("sap/chart/library");var a=t.api.getChartTypeLayout(e.dimeasure.chartTypeKey,i.getDimensions(),i.getMeasures());return a.errors.length===0}catch(e){return false}})};o.prototype.exit=function(){e.prototype.exit.apply(this,arguments);var t=this.getTable();if(t){var i=t.getChartObject();if(i){i.detachDrilledDown(this._onDrilledDown,this);i.detachDrilledUp(this._onDrilledUp,this)}}};return o});