/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ColumnMenu","./utils/TableUtils","./menus/ColumnHeaderMenuAdapter","./library","sap/ui/core/Core","sap/ui/core/Element","sap/ui/core/Popup","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/Type","sap/ui/model/type/String","sap/base/util/ObjectPath","sap/base/util/JSTokenizer","sap/base/Log"],function(e,t,r,i,n,o,a,s,l,u,p,f,g,h,d,y,c){"use strict";var m=s.HorizontalAlign,b=i.SortOrder,v=s.ValueState;var _={Standard:"Standard",Creation:"Creation"};var C=t.createWeakMapFacade();var T=new window.WeakMap;var M=o.extend("sap.ui.table.Column",{metadata:{library:"sap.ui.table",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},minWidth:{type:"int",group:"Dimension",defaultValue:0},flexible:{type:"boolean",group:"Behavior",defaultValue:true,deprecated:true},resizable:{type:"boolean",group:"Behavior",defaultValue:true},hAlign:{type:"sap.ui.core.HorizontalAlign",group:"Appearance",defaultValue:m.Begin},sorted:{type:"boolean",group:"Appearance",defaultValue:false},sortOrder:{type:"sap.ui.table.SortOrder",group:"Appearance",defaultValue:b.Ascending},sortProperty:{type:"string",group:"Behavior",defaultValue:null},filtered:{type:"boolean",group:"Appearance",defaultValue:false},filterProperty:{type:"string",group:"Behavior",defaultValue:null},filterValue:{type:"string",group:"Behavior",defaultValue:null},filterOperator:{type:"string",group:"Behavior",defaultValue:null},defaultFilterOperator:{type:"string",group:"Behavior",defaultValue:null},filterType:{type:"any",group:"Misc",defaultValue:null},grouped:{type:"boolean",group:"Appearance",defaultValue:false},visible:{type:"boolean",group:"Appearance",defaultValue:true},name:{type:"string",group:"Appearance",defaultValue:null},showFilterMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},showSortMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},headerSpan:{type:"any",group:"Behavior",defaultValue:1},autoResizable:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"label",aggregations:{label:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},multiLabels:{type:"sap.ui.core.Control",multiple:true,singularName:"multiLabel"},template:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},creationTemplate:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},menu:{type:"sap.ui.unified.Menu",multiple:false}},associations:{headerMenu:{type:"sap.ui.core.IColumnHeaderMenu",multiple:false}},events:{columnMenuOpen:{allowPreventDefault:true,parameters:{menu:{type:"sap.ui.unified.Menu"}}}}}});M._DEFAULT_FILTER_TYPE=new h;M.prototype.init=function(){this.mSkipPropagation={template:true,creationTemplate:true};C(this).oSorter=null;C(this).mCellContentVisibilitySettings=H(this);C(this).bHasDefaultLabel=false;C(this).bHasDefaultTemplate=false;this._initTemplateClonePool()};M.prototype._initTemplateClonePool=function(){this._mTemplateClones=Object.keys(_).reduce(function(e,t){e[t]=[];return e},{})};M.prototype.exit=function(){this._destroyTemplateClones();r.unlink(this)};M.prototype.setParent=function(){var e=o.prototype.setParent.apply(this,arguments);var t=this.getAggregation("menu");if(t&&typeof t._updateReferences==="function"){t._updateReferences(this)}return e};M.prototype.invalidate=function(e){if(e!==this.getTemplate()&&e!==this.getCreationTemplate()&&!t.isA(e,"sap.ui.table.ColumnMenu")){o.prototype.invalidate.apply(this,arguments)}};M.prototype.setLabel=function(e){var t=e;if(typeof e==="string"){if(C(this).bHasDefaultLabel){this.getLabel().setText(e);return this}t=i.TableHelper.createLabel({text:e});C(this).bHasDefaultLabel=true}else if(C(this).bHasDefaultLabel){this.destroyLabel();C(this).bHasDefaultLabel=false}if(t&&t.setIsInColumnHeaderContext){t.setIsInColumnHeaderContext(true)}var r=this.getLabel();if(r&&t!==r&&r.setIsInColumnHeaderContext){r.setIsInColumnHeaderContext(false)}return this.setAggregation("label",t)};M.prototype.setTemplate=function(e){var t=e;var r=this._getTable();var n=this.getTemplate();var o=true;if(typeof e==="string"){if(C(this).bHasDefaulTemplate){this.getTemplate().bindProperty("text",e);o=false}else{t=i.TableHelper.createTextView().bindProperty("text",e);C(this).bHasDefaulTemplate=true}}else if(C(this).bHasDefaulTemplate){this.destroyTemplate();C(this).bHasDefaulTemplate=false}if(o){this.setAggregation("template",t,true)}if(this.getVisible()){this.invalidate()}this._destroyTemplateClones("Standard");if(r&&this.getVisible()){if(t){r.invalidateRowsAggregation()}if(!n||!t){var a=r.getCreationRow();if(a){a._update()}}}return this};M.prototype.destroyTemplate=function(){this.destroyAggregation("template");this._destroyTemplateClones("Standard");var e=this._getTable();var t=e?e.getCreationRow():null;if(t){t._update()}return this};M.prototype.setCreationTemplate=function(e){var t=this._getTable();this.setAggregation("creationTemplate",e,true);this._destroyTemplateClones("Creation");if(e&&t&&this.getVisible()){var r=t.getCreationRow();if(r){r._update()}}return this};M.prototype.getCreationTemplate=function(){return this.getAggregation("creationTemplate")};M.prototype.destroyCreationTemplate=function(){this.destroyAggregation("creationTemplate",true);this._destroyTemplateClones("Creation");return this};M.prototype.getMenu=function(){var e=this.getAggregation("menu");if(!e){e=this._createMenu();this.setMenu(e)}return e};M.prototype._invalidateMenu=function(){var e=this.getAggregation("menu");if(e&&this._bMenuIsColumnMenu){e._invalidate()}};M.prototype._menuHasItems=function(){var e=this.getAggregation("menu");var r=this._getTable();var i=(e?e.getItems().length>0:false)||(r?r.getEnableColumnFreeze():false)||(r?r.getShowColumnVisibilityMenu():false)||this.isSortableByMenu()||this.isFilterableByMenu()||this.isGroupableByMenu();if(i){return true}return t.Hook.call(r,t.Hook.Keys.Column.MenuItemNotification,this).some(function(e){return e})};M.prototype.isFilterableByMenu=function(){return!!(this.getFilterProperty()&&this.getShowFilterMenuEntry())};M.prototype.isSortableByMenu=function(){return!!(this.getSortProperty()&&this.getShowSortMenuEntry())};M.prototype.isGroupableByMenu=function(){var e=this.getParent();return!!(e&&e.getEnableGrouping&&e.getEnableGrouping()&&this.getSortProperty())};M.prototype.setMenu=function(e){this.setAggregation("menu",e,true);this._bMenuIsColumnMenu=t.isA(e,"sap.ui.table.ColumnMenu");return this};M.prototype._createMenu=function(){if(!this._defaultMenu){this._defaultMenu=new e(this.getId()+"-menu",{ariaLabelledBy:this})}return this._defaultMenu};M.prototype.setSortProperty=function(e){this.setProperty("sortProperty",e);this._invalidateMenu();return this};M.prototype.setShowSortMenuEntry=function(e){if(this.getShowSortMenuEntry()!=e){this._invalidateMenu()}return this.setProperty("showSortMenuEntry",e)};M.prototype.setSorted=function(e){this.setProperty("sorted",e,true);this._updateIcons();return this};M.prototype.setSortOrder=function(e){this.setProperty("sortOrder",e,true);this._updateIcons();return this};M.prototype.setFilterProperty=function(e){this._invalidateMenu();return this.setProperty("filterProperty",e)};M.prototype.setShowFilterMenuEntry=function(e){if(this.getShowFilterMenuEntry()!=e){this._invalidateMenu()}return this.setProperty("showFilterMenuEntry",e)};M.prototype.setFiltered=function(e){this.setProperty("filtered",e,true);this._updateIcons();return this};M.prototype.setFilterValue=function(e){this.setProperty("filterValue",e,true);var t=this.getMenu();if(this._bMenuIsColumnMenu){t._setFilterValue(e)}return this};M.prototype.setFilterOperator=function(e){return this.setProperty("filterOperator",e,true)};M.prototype._openMenu=function(e){var t=this.getMenu();if(!this._menuHasItems()){return false}var r=this.fireColumnMenuOpen({menu:t});if(r){var i=a.Dock;var n=e;if(!e){e=this.getDomRef();n=this.getFocusDomRef()}t.open(null,n,i.BeginTop,i.BeginBottom,e);return true}else{return true}};M.prototype._openHeaderMenu=function(e){var t=this.getHeaderMenuInstance();if(t){r.activateFor(this).then(function(){t.openBy(e)})}};M.prototype._isHeaderMenuOpen=function(){var e=this.getHeaderMenuInstance();if(e){return e.isOpen()}var t=this.getAggregation("menu");return t?t.bOpen:false};M.prototype._setGrouped=function(e){var t=this._getTable();t.setGroupBy(e?this:null)};M.prototype._isAggregatableByMenu=function(){return false};M.prototype.toggleSort=function(){this.sort(this.getSorted()&&this.getSortOrder()===b.Ascending)};M.prototype.sort=function(e,t){var r=this.getParent();if(r){r.pushSortedColumn(this,t);var i=e?b.Descending:b.Ascending;var n=r.fireSort({column:this,sortOrder:i,columnAdded:t});if(n){this.setProperty("sorted",true,true);this.setProperty("sortOrder",i,true);C(this).oSorter=new f(this.getSortProperty(),this.getSortOrder()===b.Descending);this._applySorters(i,t)}}return this};M.prototype._unsort=function(){var e=this.getParent();if(e){e._removeSortedColumn(this);this._applySorters()}return this};M.prototype._applySorters=function(e,t){var r=this.getParent();var i=r.getSortedColumns();var n=r.getColumns();for(var o=0,a=n.length;o<a;o++){if(i.indexOf(n[o])<0){n[o].setProperty("sorted",false,true);n[o].setProperty("sortOrder",b.Ascending,true);n[o]._updateIcons(true);delete C(n[o]).oSorter}}var s=[];for(var o=0,a=i.length;o<a;o++){i[o]._updateIcons(true);s.push(C(i[o]).oSorter)}r._resetColumnHeaderHeights();r._updateRowHeights(r._collectRowHeights(true),true);var l=r.getBinding();if(l){if(this._updateTableAnalyticalInfo){this._updateTableAnalyticalInfo(true)}l.sort(s)}else{c.warning("Sorting not performed because no binding present",this)}};M.prototype._updateIcons=function(e){var t=this.getParent(),r=this.getSorted(),i=this.getFiltered();if(!t||!t.getDomRef()){return}this.$().parents(".sapUiTableCHT").find('td[data-sap-ui-colindex="'+this.getIndex()+'"]:not([colspan]):not(.sapUiTableHidden):first').toggleClass("sapUiTableColFiltered",i).toggleClass("sapUiTableColSorted",r).toggleClass("sapUiTableColSortedD",r&&this.getSortOrder()===b.Descending);t._getAccExtension().updateAriaStateOfColumn(this);if(!e){t._resetColumnHeaderHeights();t._updateRowHeights(t._collectRowHeights(true),true)}};M.prototype._renderSortIcon=function(){this._updateIcons()};M.prototype._getFilterState=function(){try{this._getFilter();return v.None}catch(e){return v.Error}};M.prototype._getFilter=function(){var e,t=this.getFilterProperty(),r=this.getFilterValue(),i=this.getFilterOperator(),n,o,a=this.getFilterType()||M._DEFAULT_FILTER_TYPE,s=a instanceof h,p;if(r){if(!i){p=r.match(/(.*)\s*\.\.\s*(.*)/);if(r.indexOf("=")==0){i=u.EQ;n=r.substr(1)}else if(r.indexOf("!=")==0){i=u.NE;n=r.substr(2)}else if(r.indexOf("<=")==0){i=u.LE;n=r.substr(2)}else if(r.indexOf("<")==0){i=u.LT;n=r.substr(1)}else if(r.indexOf(">=")==0){i=u.GE;n=r.substr(2)}else if(r.indexOf(">")==0){i=u.GT;n=r.substr(1)}else if(p){if(p[1]&&p[2]){i=u.BT;n=p[1];o=p[2]}else if(p[1]&&!p[2]){i=u.GE;n=p[1]}else{i=u.LE;n=p[2]}}else if(s&&r.indexOf("*")==0&&r.lastIndexOf("*")==r.length-1){i=u.Contains;n=r.substr(1,r.length-2)}else if(s&&r.indexOf("*")==0){i=u.EndsWith;n=r.substr(1)}else if(s&&r.lastIndexOf("*")==r.length-1){i=u.StartsWith;n=r.substr(0,r.length-1)}else{if(this.getDefaultFilterOperator()){i=this.getDefaultFilterOperator()}else if(s){i=u.Contains}else{i=u.EQ}n=r.substr(0)}if(!o){e=new l(t,i,this._parseFilterValue(n))}else{e=new l(t,i,this._parseFilterValue(n),this._parseFilterValue(o))}}else{e=new l(t,i,this._parseFilterValue(r))}}return e};M.prototype.filter=function(e){var t=this.getParent();if(t&&t.isBound("rows")){var r=t.fireFilter({column:this,value:e});if(r){this.setProperty("filtered",!!e,true);this.setProperty("filterValue",e,true);var i=this.getMenu();if(this._bMenuIsColumnMenu){i._setFilterValue(e)}var n=[];var o=t.getColumns();for(var a=0,s=o.length;a<s;a++){var l=o[a],u;i=l.getMenu();try{u=l._getFilter();if(l._bMenuIsColumnMenu){i._setFilterState(v.None)}}catch(e){if(l._bMenuIsColumnMenu){i._setFilterState(v.Error)}continue}if(u){n.push(u)}}t.getBinding().filter(n,p.Control);this._updateIcons()}}return this};M.prototype._parseFilterValue=function(e){var t=this.getFilterType();if(t){if(typeof t==="function"){e=t(e)}else{e=t.parseValue(e,"string")}}return e};M.prototype.shouldRender=function(){return this.getVisible()&&!this.getGrouped()&&this.getTemplate()!=null};M.prototype.setProperty=function(e,t){var r=this._getTable();var i=r&&this.getProperty(e)!=t;var n=i&&e==="visible";var a=i&&(e==="visible"||e==="headerSpan");var s=o.prototype.setProperty.apply(this,arguments);if(n){r.invalidateRowsAggregation();var l=r.getCreationRow();if(l){l._update()}}if(a){r._invalidateComputedFixedColumnCount()}return s};M.prototype.setFilterType=function(e){var t=e;if(typeof e==="string"){try{var r=y.parseJS(e);if(typeof r.type==="string"){var i=d.get(r.type);t=i&&new i(r.formatOptions,r.constraints)}}catch(r){var i=d.get(e);t=i&&new i}if(!(t instanceof g)){c.error("The filter type is not an instance of sap.ui.model.Type! Ignoring the filter type!");t=undefined}}this.setProperty("filterType",t,true);return this};M.prototype.getIndex=function(){var e=this.getParent();if(e){return e.indexOfColumn(this)}else{return-1}};M.prototype.isDragAllowed=function(e){return t.Column.isColumnMovable(this,true)};M.prototype._getFreeTemplateClone=function(e){var t=this._mTemplateClones[e];var r=null;if(!t){return null}for(var i=0;i<t.length;i++){if(!t[i]||t[i].bIsDestroyed){t.splice(i,1);i--}else if(!r&&!t[i].getParent()){r=t[i]}}return r};M.prototype.getTemplateClone=function(e,t){if(typeof e!=="number"||this.getTemplate()==null){return null}var r=t==null?"Standard":t;var i=this._getFreeTemplateClone(r);if(!i&&_.hasOwnProperty(r)){var n=this["get"+(r==="Standard"?"":r)+"Template"];var o=n.call(this);if(o){i=o.clone();this._mTemplateClones[r].push(i)}}if(i){T.set(i,this);var a=this.getParent();if(a){a._getAccExtension().addColumnHeaderLabel(this,i)}}return i};function S(e){for(var t=0;t<e.length;t++){if(e[t]!=null&&!e[t].bIsDestroyed){e[t].destroy()}}}M.prototype._destroyTemplateClones=function(e){if(e==null){for(var t in _){S(this._mTemplateClones[t])}this._initTemplateClonePool()}else{S(this._mTemplateClones[e]);this._mTemplateClones[e]=[]}};M.prototype._closeMenu=function(){var e=this.getAggregation("menu");if(e){e.close()}};M.prototype._getTable=function(){var e=this.getParent();return t.isA(e,"sap.ui.table.Table")?e:null};M.prototype._setCellContentVisibilitySettings=function(e){P(e);C(this).mCellContentVisibilitySettings=H(this,e)};M.prototype._getCellContentVisibilitySettings=function(){return C(this).mCellContentVisibilitySettings};M.prototype.getHeaderMenuInstance=function(){return n.byId(this.getHeaderMenu())};function P(e){if(e==null){return}F(e,null,false,["standard","groupHeader","summary"]);F(e.standard,"standard",true);F(e.groupHeader,"groupHeader",true,["nonExpandable","expanded","collapsed"]);F(e.summary,"summary",true,["group","total"])}function F(e,t,r,i){if(e!=null&&!(r&&typeof e==="boolean"||i&&typeof e==="object")){throw new Error("Invalid value"+(t?" for '"+t+"'":""))}if(i&&e!=null&&typeof e==="object"){Object.keys(e).forEach(function(r){if(i.includes(r)){if(t!=null){F(e[r],t+"."+r,true)}}else{throw new Error("Unsupported setting '"+(t?t+".":"")+r+"'")}})}}function H(e,t){t=t?t:{};return{standard:A(t.standard),groupHeader:{nonExpandable:A(t.groupHeader,"nonExpandable"),expanded:A(t.groupHeader,"expanded"),collapsed:A(t.groupHeader,"collapsed")},summary:{group:A(t.summary,"group"),total:A(t.summary,"total")}}}function A(e,t){if(typeof e==="boolean"){return e}else if(t&&e){return e[t]!==false}else{return true}}M.ofCell=function(e){return T.get(e)||null};return M});