/*
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","../utils/TableUtils","sap/base/util/deepClone"],function(t,e,o){"use strict";function i(t,o){var i="TBL_ROW_GROUP_TITLE";var a=[o.property.label,t.getProperty(o.property.path,true)];if(o.textProperty){i="TBL_ROW_GROUP_TITLE_FULL";a.push(t.getProperty(o.textProperty.path,true))}return e.getResourceText(i,a)}var a=t.extend("sap.ui.table.plugins.V4Aggregation",{metadata:{library:"sap.ui.table",properties:{totalSummaryOnTop:{type:"string",defaultValue:"Off"},totalSummaryOnBottom:{type:"string",defaultValue:"Fixed"},groupSummary:{type:"string",defaultValue:"Bottom"},groupHeaderFormatter:{type:"function"}}}});a.prototype.isApplicable=function(e){return t.prototype.isApplicable.apply(this,arguments)&&e.getMetadata().getName()==="sap.ui.table.Table"};a.prototype.activate=function(){var e=this.getTableBinding();if(e&&!e.isA("sap.ui.model.odata.v4.ODataListBinding")){return}t.prototype.activate.apply(this,arguments)};a.prototype.onActivate=function(t){this.setRowCountConstraints({fixedTop:false,fixedBottom:false});e.Grouping.setToDefaultGroupMode(t);e.Hook.register(t,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.register(t,e.Hook.Keys.Row.Expand,u,this);e.Hook.register(t,e.Hook.Keys.Row.Collapse,g,this)};a.prototype.onDeactivate=function(t){this._mGroup=undefined;this._mAggregate=undefined;this._aGroupLevels=undefined;this._mColumnState=undefined;this.setRowCountConstraints();r(this);e.Grouping.setToDefaultFlatMode(t);e.Hook.deregister(t,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.deregister(this,e.Hook.Keys.Row.Expand,u,this);e.Hook.deregister(this,e.Hook.Keys.Row.Collapse,g,this);var o=t.getBinding();if(o){o.setAggregation()}};function r(t){var e=t.getTable();if(e){e.getColumns().forEach(function(t){t._setCellContentVisibilitySettings()})}}function n(t){var e=t.getTable();var o=t.getGroupSummary();if(!e||!t._mColumnState){return}e.getColumns().forEach(function(e){var i=t._mColumnState[e.getId()];if(i){e._setCellContentVisibilitySettings({groupHeader:{expanded:!!i.subtotals&&(o==="Top"||o==="TopAndBottom"),collapsed:!!i.subtotals&&(o==="Bottom"||o==="TopAndBottom")},summary:{group:!!i.subtotals,total:!!i.grandTotal}})}else{e._setCellContentVisibilitySettings()}})}a.prototype.onTableRowsBound=function(t){if(!t.getModel().isA("sap.ui.model.odata.v4.ODataModel")){this.deactivate()}};a.prototype.onTableBindRows=function(t){t.parameters=t.parameters||{};t.parameters.$$aggregation=this.getAggregationInfo()};a.prototype.updateRowState=function(t){var e=t.context.getValue("@$ui5.node.level");var o=t.context.getValue("@$ui5.node.isTotal");var a=t.context.getValue("@$ui5.node.isExpanded")===undefined;var r=e===0&&o;var n=e>0&&!a;var s=!n&&o;t.level=e;t.expandable=n;t.expanded=t.context.getValue("@$ui5.node.isExpanded")===true;if(r||s){t.type=t.Type.Summary;t.level++}else if(n){t.type=t.Type.GroupHeader}if(n){var u=this._aGroupLevels[e-1];var g=this.getGroupHeaderFormatter();var p=g?g(t.context,u.property.name):undefined;if(p===undefined){t.title=i(t.context,u)}else if(typeof p!=="string"){throw new Error("The group header title must be a string or undefined")}else{t.title=p}}};a.prototype.setPropertyInfos=function(t){this._aPropertyInfos=t};a.prototype.getPropertyInfos=function(){return this._aPropertyInfos||[]};a.prototype.findPropertyInfo=function(t){return this.getPropertyInfos().find(function(e){return e.name===t})};a.prototype.setAggregationInfo=function(t){t=Object.assign({columnState:{}},t);if(!Array.isArray(t.visible)){this._mGroup=undefined;this._mAggregate=undefined;this._aGroupLevels=undefined;this._sSearch=undefined}else{var e=[];var o=[];var i;this._mGroup=this.getPropertyInfos().reduce(function(t,e){if(e.key){t[e.path]={};i=s(this,e);if(i){t[e.path].additionally=i;o.concat(i)}}return t}.bind(this),{});this._mAggregate={};var a=t.visible.concat();if(t.groupLevels){t.groupLevels.forEach(function(t){if(a.indexOf(t)<0){a.push(t)}})}a.forEach(function(a){var r=this.findPropertyInfo(a);if(!r){return}if(r.groupable){this._mGroup[r.path]={};i=s(this,r);if(i){this._mGroup[r.path].additionally=i;o=o.concat(i)}}if(r.aggregatable){this._mAggregate[r.path]={};if(t.grandTotal&&t.grandTotal.indexOf(a)>=0){this._mAggregate[r.path].grandTotal=true}if(t.subtotals&&t.subtotals.indexOf(a)>=0){this._mAggregate[r.path].subtotals=true}if(r.unit){var n=this.findPropertyInfo(r.unit);if(n){this._mAggregate[r.path].unit=n.path;e.push(n.path)}}if(r.aggregationDetails&&r.aggregationDetails.customAggregate&&r.aggregationDetails.customAggregate.contextDefiningProperties){r.aggregationDetails.customAggregate.contextDefiningProperties.forEach(function(t){var e=this.findPropertyInfo(t);if(e){this._mGroup[e.path]={};i=s(this,r);if(i){this._mGroup[e.path].additionally=i;o=o.concat(i)}}}.bind(this))}}}.bind(this));this._aGroupLevels=[];if(t.groupLevels){t.groupLevels.forEach(function(t){var e=this.findPropertyInfo(t);this._aGroupLevels.push({property:e,textProperty:this.findPropertyInfo(e.text)})}.bind(this))}Object.keys(this._mGroup).forEach(function(t){if(this._mAggregate.hasOwnProperty(t)){if(this._mAggregate[t].grandTotal||this._mAggregate[t].subtotals){delete this._mGroup[t];return}else{delete this._mAggregate[t]}}if(this._mGroup[t].additionally){this._mGroup[t].additionally=this._mGroup[t].additionally.filter(function(t){return e.indexOf(t)===-1})}if(o.indexOf(t)>-1){delete this._mGroup[t]}}.bind(this));this._sSearch=t.search}this._mColumnState=t.columnState;n(this);this.updateAggregation()};a.prototype.getAggregationInfo=function(){if(!Object.keys(this._mGroup||{}).length&&!Object.keys(this._mAggregate||{}).length){return}var t={aggregate:o(this._mAggregate),group:o(this._mGroup),groupLevels:this._aGroupLevels?this._aGroupLevels.map(function(t){return t.property.path}):undefined,search:this._sSearch};if(t.aggregate){p(this,t);l(this,t)}return t};function s(t,e){if(e.text){var o=t.findPropertyInfo(e.text);if(o){return[o.path]}}return null}function u(t){var e=t.getRowBindingContext();if(e){e.expand()}}function g(t){var e=t.getRowBindingContext();if(e){e.collapse()}}a.prototype.setTotalSummaryOnTop=function(t){this.setProperty("totalSummaryOnTop",t,true);this.updateAggregation()};a.prototype.setTotalSummaryOnBottom=function(t){this.setProperty("totalSummaryOnBottom",t,true);this.updateAggregation()};a.prototype.setGroupSummary=function(t){this.setProperty("groupSummary",t,true);n(this);this.updateAggregation()};a.prototype.updateAggregation=function(){var t=this.getTableBinding();if(t){t.setAggregation(this.getAggregationInfo())}};function p(t,e){var o=t.getTotalSummaryOnTop();var i=t.getTotalSummaryOnBottom();var a=o==="On"||o==="Fixed";var r=i==="On"||i==="Fixed";var n=Object.keys(e.aggregate).some(function(t){return e.aggregate[t].grandTotal});if(a&&r){e.grandTotalAtBottomOnly=false}else if(r){e.grandTotalAtBottomOnly=true}else if(a){e.grandTotalAtBottomOnly=undefined}else{Object.keys(e.aggregate).forEach(function(t){delete e.aggregate[t].grandTotal})}t.setRowCountConstraints({fixedTop:o==="Fixed"&&n,fixedBottom:i==="Fixed"&&n})}function l(t,e){var o=t.getGroupSummary();if(o==="Top"){e.subtotalsAtBottomOnly=undefined}else if(o==="Bottom"){e.subtotalsAtBottomOnly=true}else if(o==="TopAndBottom"){e.subtotalsAtBottomOnly=false}else{Object.keys(e.aggregate).forEach(function(t){delete e.aggregate[t].subtotals})}}return a});