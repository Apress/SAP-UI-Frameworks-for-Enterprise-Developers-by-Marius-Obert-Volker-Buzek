sap.ui.define(["sap/suite/ui/commons/library","./LayoutAlgorithm","./Geometry","./LayoutTask"],function(e,o,t,i){"use strict";var r=e.networkgraph.LayoutRenderType;var n=15,s=75,a=32,u=42,h=160,p=100,d=50,l=25,f=10,_=.6,g=20;var G=o.extend("sap.suite.ui.commons.networkgraph.layout.TwoColumnsLayout");G.prototype.getLayoutRenderType=function(){return r.TwoColumns};G.prototype.layout=function(){return new i(function(e,o,t){var i=this.getParent(),r;if(!i){o("The algorithm must be associated with a graph.");return}this.oGraph=i;this.oLeftColumn=undefined;this.oRightColumn=undefined;r=this._validateGraphDefinition();if(r){o(r)}this._preprocessGroupsAndNodes();r=this._validateLines();if(r){o(r)}this._calcLanesProperties();this._createNodesGrid();this._calcNodeEndingAndStartingPoints();this._setNodesCoordinates();this._setGroupCoordinates();this._setLinesCoordinates();this._cutLinesAtBoxNodeBorders();if(this.oGraph._bIsRtl){this._verticalMirror()}e()}.bind(this))};G.prototype._validateGraphDefinition=function(){var e=[];this.oGraph.getNodes().forEach(function(o){if(!o.getGroup()){e.push(o.getKey())}});if(e.length>0){return"Some nodes are missing group: "+e.join()}return null};G.prototype._preprocessGroupsAndNodes=function(){if(this.oGraph.getGroups().some(function(e){e._oFirstNode=null;e._oLastNode=null;e._bNestedSet=false;if(!e._oParentGroup){if(!this.oLeftColumn){this.oLeftColumn=e}else if(!this.oRightColumn){this.oRightColumn=e}else{return true}}return false}.bind(this))){return"There are too many columns, ie. groups without a parent group. Expected exactly 2."}if(!this.oRightColumn||!this.oLeftColumn){return"There are too few columns, ie. groups without a parent group. Expected exactly 2."}this.oGraph.getNodes().forEach(function(e){e._iStartingGroupCount=0;e._iEndingGroupCount=0})};G.prototype._validateLines=function(){var e,o;if(this.oGraph.getLines().some(function(t){e=t.getFromNode()._oGroup._oTopParentGroup;o=t.getToNode()._oGroup._oTopParentGroup;return!(e===this.oLeftColumn&&o===this.oRightColumn||o===this.oLeftColumn&&e===this.oRightColumn)}.bind(this))){return"For Two columns layout all lines have to go from one column to the other."}else{return null}};G.prototype._calcLanesProperties=function(){var e;this.aLanes=[];this.oGraph.getGroups().forEach(function(e){if(!e.getParentGroupKey()){this.aLanes.push(e.getKey())}}.bind(this));this.aLanes.sort();var o=this.aLanes.map(Number.prototype.valueOf,0);this.oGraph.getNodes().forEach(function(t){var i=t._oGroup,r=i._oTopParentGroup&&i._oTopParentGroup.getKey()||t.getGroup();e=this.aLanes.indexOf(r);t._iGroupIndex=i._iLaneIndex=e;if(i._iNestedLevel>o[e]){o[e]=i._iNestedLevel}}.bind(this));this.oGraph.getGroups().forEach(function(e){var o=e._oTopParentGroup&&e._oTopParentGroup.getKey()||e.getKey();e._iLaneIndex=this.aLanes.indexOf(o)}.bind(this));this.aLaneWidths=[];this.oGraph.getNodes().forEach(function(e){if(!this.aLaneWidths[e._iGroupIndex]||this.aLaneWidths[e._iGroupIndex]<e._iWidth){this.aLaneWidths[e._iGroupIndex]=e._iWidth}}.bind(this));this.aLaneWidths=this.aLaneWidths.map(function(e,o){var t=this.oGraph.mGroups[this.aLanes[o]],i=t.getMinWidth()||h;return Math.max(i,e)}.bind(this));this.aLaneGroupWidths=this.aLaneWidths.map(function(e,t){return e+o[t]*n*2});var t=this.oGraph.$("innerscroller").width();t=Math.max(this.aLaneGroupWidths[0]+this.aLaneGroupWidths[1]+p+l*2,t);this.aLaneCenters=[l+this.aLaneGroupWidths[0]/2+(this.oGraph._bIsRtl?30:0),t-this.aLaneGroupWidths[1]/2-l*1.5]};G.prototype._createNodesGrid=function(){var e=this.oGraph.getGroups(),o=0;var t=e.filter(function(e){return e._iNestedLevel===0});this.aGrid=this.aLanes.map(function(e){return[]});var i=function(e){e.aNodes.forEach(function(t){var i=t._oGroup._oCollapsedByParent,r=i||e;if(!e.getCollapsed()&&!i){this.aGrid[o].push(t)}else if(r.getCollapsed()){while(r._oCollapsedByParent){r=r._oCollapsedByParent}if(!r._bNestedSet){r._bNestedSet=true;this.aGrid[o].push(t)}}}.bind(this));e.aChildGroups.forEach(function(e){i(e)})}.bind(this);t.forEach(function(e,t){e._iTopGroupIndex=t;i(e);o++})};G.prototype._calcNodeEndingAndStartingPoints=function(){var e=function(e,o,t,i,r){var n=e._oParentGroup;while(n&&n._iNestedLevel>0){if(!n[t]||r){n[t]=o;if(!n._oCollapsedByParent&&!n.getCollapsed()){o[i]++}}else{return}n=n._oParentGroup}};var o=function(o){if(!o._oGroup._oLastNode){o._oGroup._oLastNode=o;if(!o._oGroup._oCollapsedByParent&&!o._oGroup.getCollapsed()){o._iEndingGroupCount++}e(o._oGroup,o,"_oLastNode","_iEndingGroupCount",false)}};var t=function(o){if(!o._oGroup._oFirstNode){o._oGroup._oFirstNode=o;if(!o._oGroup._oCollapsedByParent&&!o._oGroup.getCollapsed()){o._iStartingGroupCount++}e(o._oGroup,o,"_oFirstNode","_iStartingGroupCount",false)}};for(var i=0;i<this.aGrid.length;i++){var r=null;for(var n=0;n<this.aGrid[i].length;n++){var s=this.aGrid[i][n];if(s._oGroup!==r){t(s);r=s._oGroup}}r=null;for(var n=this.aGrid[i].length-1;n>=0;n--){var s=this.aGrid[i][n];if(s._oGroup!==r){o(s);r=s._oGroup}}}};G.prototype._setGroupCoordinates=function(){var e=this.aLanes.map(Number.prototype.valueOf,0);var o=function(e,o){var t=o._oGroup._oCollapsedByParent||o._oGroup.getCollapsed()?0:1,i=o._oGroup._oParentGroup;if(e===o._oGroup){return t}while(i){if(!i._oCollapsedByParent&&!i.getCollapsed()){t++}if(e===i){break}i=i._oParentGroup}return t};var t=function(e,o){var t=0,i=o._oGroup._oParentGroup;if(e===o._oGroup){return t}while(i){if(!i._oCollapsedByParent&&!i.getCollapsed()){t++}if(e===i){break}i=i._oParentGroup}return t};this.oGraph.getGroups().forEach(function(o){e[o._iLaneIndex]=o._iNestedLevel>e[o._iLaneIndex]?o._iNestedLevel:e[o._iLaneIndex]});this.oGraph.getGroups().forEach(function(i){if(i._iNestedLevel===0){i.setX(this.aLaneCenters[i._iLaneIndex]-this.aLaneWidths[i._iLaneIndex]);i.setY(0)}else if(i._oLastNode&&i._oFirstNode){i._iWidth=this.aLaneWidths[i._iLaneIndex]+(e[i._iLaneIndex]-i._iNestedLevel)*n*2+n*2;i.setX(this.aLaneCenters[i._iLaneIndex]-i._iWidth/2);var r=t(i,i._oLastNode),s=r*(n/2)+n/2,h=o(i,i._oFirstNode),p=h*u;var d=i._oFirstNode.getY()-p,l=i._oLastNode._oGroup.getCollapsed()||i._oLastNode._oGroup._oCollapsedByParent?a:i._oLastNode._iHeight;i.setY(d);i._iHeight=i.getCollapsed()?a:i._oLastNode.getY()+l-d+s}}.bind(this))};G.prototype._setNodesCoordinates=function(){this.aGrid.forEach(function(e){var o=d;e.forEach(function(e){var t=e._oGroup._oCollapsedByParent||e._oGroup;e.setX(this.aLaneCenters[e._iGroupIndex]-e._iWidth/2);o+=e._iStartingGroupCount*u;e.setY(o);o+=s/2;o+=e._iEndingGroupCount*n/2;o+=t.getCollapsed()?a:e._iHeight}.bind(this))}.bind(this))};G.prototype._setLinesCoordinates=function(){var e,o,t,i,r=[],n=[],s=[],a=function(e){var o;if(!e._oGroup){return null}o=e._oGroup;while(o&&o._isCollapsed()){if(!o._oParentGroup||!o._oParentGroup._isCollapsed()){return o}o=o._oParentGroup}return null},u=function(e){var o;if(e._oTopParentGroup===this.oLeftColumn){o=e.getX()+e._iWidth+2*e._getBorderSize()}else{o=e.getX()}return{x:o,y:e.getY()+e._iHeight/2}},h=function(e){var o,t,i;if(e.groupDelegate){e.anchors.forEach(function(o){e.groupDelegate.anchors.push({node:e,line:o.line,oppositeY:o.oppositeY});if(e.isLeftie){s.push(o.line)}});return}o=(e._iHeight-2*f)/(e.anchors.length-1);t=e.anchors.length===1?e.getCenterPosition().y:e.getY()+f;i=t;e.anchors.sort(function(e,o){return e.oppositeY-o.oppositeY}).forEach(function(t){var r=t.line,n=e.getCenterPosition().x;if(e===r.getFromNode()){r.setSource({x:n,y:i})}else if(e===r.getToNode()){r.setTarget({x:n,y:i})}i+=o;if(e.isLeftie){s.push(r)}})},p=function(e){var o=u.bind(this)(e),t=(e._iHeight-2*f)/(e.anchors.length-1),i=e.anchors.length===1?u.bind(this)(e).y:e.getY()+f,r=i;e.anchors.sort(function(e,o){return e.oppositeY-o.oppositeY}).forEach(function(e){var i=e.line;if(e.node===i.getFromNode()){i.setSource({x:o.x,y:r})}else if(e.node===i.getToNode()){i.setTarget({x:o.x,y:r})}r+=t})},d=function(){var e=_*(this.oRightColumn.getX()-(this.oLeftColumn.getX()+this.oLeftColumn._iWidth)),o=this.oGraph.getLines().length-1,t=e/o,i=t<g?t:g,a=(r[0].getCenterPosition().x+n[0].getCenterPosition().x)/2,u=a-o*i/2,h=u,p=u;s.forEach(function(e){if(h>=n[0]._oGroup.getX()-i){h=p}else{h+=i}e.addBend({x:h,y:e.getSource().getY()});e.addBend({x:h,y:e.getTarget().getY()})})}.bind(this);this.oGraph.getNodes().forEach(function(e){if(e._oGroup){if(e._oGroup._oTopParentGroup===this.oLeftColumn){e.isLeftie=true;r.push(e)}else if(e._oGroup._oTopParentGroup===this.oRightColumn){e.isLeftie=false;n.push(e)}}e.groupDelegate=a(e);e.anchors=[]}.bind(this));this.oGraph.getLines().forEach(function(r){e=r.getFromNode();o=r.getToNode();t=e.getCenterPosition();i=o.getCenterPosition();e.anchors.push({line:r,oppositeY:i.y});o.anchors.push({line:r,oppositeY:t.y});r.setSource({x:0,y:0});r.clearBends()});this.oGraph.getGroups().forEach(function(e){e.anchors=[]});r.sort(function(e,o){return e.getY()-o.getY()}).forEach(h);n.sort(function(e,o){return e.getY()-o.getY()}).forEach(h);this.oGraph.getGroups().sort(function(e,o){return e.getY()-o.getY()}).forEach(p.bind(this));d()};return G});