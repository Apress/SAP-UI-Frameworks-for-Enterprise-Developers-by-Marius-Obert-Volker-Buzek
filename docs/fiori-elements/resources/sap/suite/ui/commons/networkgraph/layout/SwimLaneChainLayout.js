sap.ui.define(["sap/suite/ui/commons/library","./LayoutAlgorithm","./Geometry","./LayoutTask"],function(e,t,i,n){"use strict";var s=e.networkgraph.Orientation;var o=e.networkgraph.LayoutRenderType,a=32,r=50,h=75,d=75,f=75,g=32,p=10,c=25;var u=t.extend("sap.suite.ui.commons.networkgraph.layout.SwimlaneChainLayout",{metadata:{library:"sap.suite.ui.commons",properties:{}}});u.prototype.getLayoutRenderType=function(){return o.SwimLanes};u.prototype.layout=function(){return new n(function(e,t,i){var n=this.getParent(),o;if(!n){t("The algorithm must be associated with a graph.");return}this.oGraph=n;o=this._validateGraphDefinition();if(o){t(o)}this.bVertLane=n.getOrientation()===s.LeftRight||n.getOrientation()===s.RightLeft;this._calcLanesProperties();this._findRoots();this._initGrid();this._traceAndStackNodes();this._calcRowsProperties();this._calcNodesCoordinates();this.oGraph.getLines().forEach(function(e){this._traceSingleLine(e);this._calcLineCentroid(e);e._aNipples=[]}.bind(this));this._indexAllLineFragments();this._cutLinesAtBoxNodeBorders();this._removeLineOverlays(this.aHorizontalFragments,true);this._removeLineOverlays(this.aVerticalFragments,false);this._calcLanesWidthsAndPositions();this._collapseShiftNodesAndLines();this._alignCoordinatesWithView();this._beautify();this._findAllNipples();this._cullLineFragmentsInCollapsedGroups();if(!this.oGraph._bIsRtl&&n.getOrientation()===s.RightLeft||this.oGraph._bIsRtl&&n.getOrientation()===s.LeftRight){this._verticalMirror()}else if(n.getOrientation()===s.BottomTop){this._horizontalMirror()}e()}.bind(this))};u.prototype._validateGraphDefinition=function(){var e=[];this.oGraph.getNodes().forEach(function(t){if(!t.getGroup()){e.push(t.getKey())}});if(e.length>0){return"Some nodes are missing swim lanes: "+e.join()}if(this._hasHierarchicalGroups()){return"Swim lane layout algorithm doesn't support hierarchical groups."}return null};u.prototype._calcLanesProperties=function(){this.aLanes=[];this.oGraph.getGroups().forEach(function(e){if(this.bVertLane){e.setY(0)}else{e.setX(0)}this.aLanes.push(e.getKey())}.bind(this));this.aLanes.sort();this.oGraph.getNodes().forEach(function(e){e._iGroupIndex=this.aLanes.indexOf(e.getGroup())}.bind(this));var e;this.aLaneWidths={};this.aLaneOffsets={};this.oGraph.getNodes().forEach(function(t){e=this.bVertLane?t._iWidth:t._iHeight;if(!this.aLaneWidths[t._iGroupIndex]||this.aLaneWidths[t._iGroupIndex]<e){this.aLaneWidths[t._iGroupIndex]=e}}.bind(this));var t;this.aLaneGroups={};this.oGraph.getGroups().forEach(function(e){t=this.aLanes.indexOf(e.getKey());if(this.aLaneWidths[t]<e.getMinWidth()){this.aLaneWidths[t]=e.getMinWidth()}this.aLaneGroups[t]=e}.bind(this));var i=0;Object.keys(this.aLaneWidths).forEach(function(e){if(i>0){i+=d}this.aLaneOffsets[e]=i;i+=this.aLaneWidths[e]}.bind(this))};u.prototype._findRoots=function(){this.aRoots=[];this.oGraph.getNodes().forEach(function(e){if(e._iGroupIndex===0&&e.aParents.length===0){this.aRoots.push(e)}}.bind(this));this.oGraph.getNodes().forEach(function(e){if(e._iGroupIndex>0&&e.aParents.length===0){this.aRoots.push(e)}}.bind(this));this.oGraph.getNodes().forEach(function(e){this.aRoots.push(e)}.bind(this))};u.prototype._initGrid=function(){this.aGrid=[];this.oGraph.getNodes().forEach(function(e){if(!this.aGrid[e._iGroupIndex]){this.aGrid[e._iGroupIndex]=[]}e._bChainTraced=false}.bind(this))};u.prototype._traceAndStackNodes=function(){this.aRoots.forEach(function(e){if(!e._bChainTraced){this.aGrid[e._iGroupIndex].push(e);e._bChainTraced=true;this._traceNodeChainDepthFirst(e)}}.bind(this))};u.prototype._traceNodeChainDepthFirst=function(e){e.aChildren.forEach(function(e){if(!e._bChainTraced){e._bChainTraced=true;this.aGrid[e._iGroupIndex].push(e);this._traceNodeChainDepthFirst(e)}}.bind(this))};u.prototype._calcRowsProperties=function(){var e=0,t;this.aGrid.forEach(function(t){if(t.length>e){e=t.length}});this.aRowHeights=[];this.aRowOffsets=[];for(var i=0;i<e;i++){this.aGrid.forEach(function(e){if(!e[i]){return}t=this.bVertLane?e[i]._iHeight:e[i]._iWidth;if(!this.aRowHeights[i]||this.aRowHeights[i]<t){this.aRowHeights[i]=t}}.bind(this))}var n=-1,s=0;this.aRowHeights.forEach(function(e){n++;if(n>0){s+=d}this.aRowOffsets[n]=s;s+=e}.bind(this));this.fGridHeight=this.aRowOffsets[e-1]+this.aRowHeights[e-1];if(this.bVertLane){this.fGridHeight+=r}else{this.fGridHeight+=h}this.oGraph.getGroups().forEach(function(e){if(this.bVertLane){e._iHeight=this.fGridHeight}else{e._iWidth=this.fGridHeight}}.bind(this))};u.prototype._calcNodesCoordinates=function(){var e;this.aGrid.forEach(function(t){e=-1;t.forEach(function(t){e++;if(this.bVertLane){t.setX(this.aLaneOffsets[t._iGroupIndex]+this.aLaneWidths[t._iGroupIndex]/2-t._iWidth/2+d/2);t.setY(this.aRowOffsets[e]+this.aRowHeights[e]/2-t._iHeight/2+f/2)}else{t.setX(this.aRowOffsets[e]+this.aRowHeights[e]/2-t._iWidth/2+f/2);t.setY(this.aLaneOffsets[t._iGroupIndex]+this.aLaneWidths[t._iGroupIndex]/2-t._iHeight/2+d/2)}t.iRow=e}.bind(this))}.bind(this))};u.prototype._calcLineCentroid=function(e){var t=e.getBends().length+2,i=e.getSource().getX()+e.getTarget().getX(),n=e.getSource().getY()+e.getTarget().getY();e.getBends().forEach(function(e){i+=e.getX();n+=e.getY()});e._oCentroid={x:i/t,y:n/t}};u.prototype._indexAllLineFragments=function(){this.aVerticalFragments=[];this.aHorizontalFragments=[];this.oGraph.getLines().forEach(function(e){this._indexLineFragments(e)}.bind(this))};u.prototype._indexLineFragments=function(e){var t=this._getLinePointsList(e),i,n;for(var s=0;s<t.length-1;s++){i=t[s];n=t[s+1];if(i.x===n.x){if(i.y<n.y){this.aVerticalFragments.push({line:e,index:s,cc:i.x,c1:i.y,c2:n.y})}else{this.aVerticalFragments.push({line:e,index:s,cc:i.x,c1:n.y,c2:i.y,invert:true})}}else if(i.y===n.y){if(i.x<n.x){this.aHorizontalFragments.push({line:e,index:s,cc:i.y,c1:i.x,c2:n.x})}else{this.aHorizontalFragments.push({line:e,index:s,cc:i.y,c1:n.x,c2:i.x,invert:true})}}}};u.prototype._removeLineOverlays=function(e,t){var i,n,s,o,a;for(var r=0;r<e.length;r++){i=e[r];n=[i];for(var h=r+1;h<e.length;h++){if(this._doFragmentsIntersect(i,e[h])){n.push(e[h])}}if(n.length===1){continue}n.sort(function(e,i){if(t){return e.line._oCentroid.y-i.line._oCentroid.y}else{return e.line._oCentroid.x-i.line._oCentroid.x}});s=(n.length-1)*p;if(s>c){s=c}o=s/(n.length-1);a=i.cc-s/2;for(h=0;h<n.length;h++){this._shiftLineFragment(n[h],a,!t);a+=o}}};u.prototype._shiftLineFragment=function(e,t,i){var n=e.line.getCoordinates()[e.index],s=e.line.getCoordinates()[e.index+1];e.cc=t;if(i){n.setX(t);s.setX(t)}else{n.setY(t);s.setY(t)}};u.prototype._doFragmentsIntersect=function(e,t){return e.cc===t.cc&&!(e.c1<t.c1&&e.c1<t.c2&&e.c2<t.c1&&e.c2<t.c2||e.c1>t.c1&&e.c1>t.c2&&e.c2>t.c1&&e.c2>t.c2)};u.prototype._getLinePointsList=function(e){var t=[];t.push({x:e.getSource().getX(),y:e.getSource().getY()});e.getBends().forEach(function(e){t.push({x:e.getX(),y:e.getY()})});t.push({x:e.getTarget().getX(),y:e.getTarget().getY()});return t};u.prototype._calcLanesWidthsAndPositions=function(){var e,t=0;this.aLanes.forEach(function(i,n){e=this.oGraph.mGroups[i];e._fExpandedWidth=this.aLaneWidths[n]+d;e._fExpandedPosition=this.aLaneOffsets[n];if(this.bVertLane){e.setX(this.aLaneOffsets[n]+t)}else{e.setY(this.aLaneOffsets[n]+t)}if(e.getCollapsed()){if(this.bVertLane){e._iWidth=g}else{e._iHeight=g}if(e.getNodes().length>0){t+=g-(this.aLaneWidths[n]+d)}}else{if(this.bVertLane){e._iWidth=e._fExpandedWidth}else{e._iHeight=e._fExpandedWidth}}}.bind(this))};u.prototype._collapseShiftNodesAndLines=function(){var e,t,i;this.aLanes.forEach(function(n){i=this.oGraph.mGroups[n];t=g/i._fExpandedWidth;this.oGraph.getNodes().forEach(function(t){if(this.bVertLane){if(t.getCenterPosition().x>i._fExpandedPosition&&t.getCenterPosition().x<=i._fExpandedPosition+i._fExpandedWidth){e=i.getX()-i._fExpandedPosition;if(i.getCollapsed()){e+=(g-i._fExpandedWidth)/2}t.setX(t.getX()+e)}}else{if(t.getCenterPosition().y>i._fExpandedPosition&&t.getCenterPosition().y<=i._fExpandedPosition+i._fExpandedWidth){e=i.getY()-i._fExpandedPosition;if(i.getCollapsed()){e+=(g-i._fExpandedWidth)/2}t.setY(t.getY()+e)}}}.bind(this));this.oGraph.getLines().forEach(function(n){n.getCoordinates().forEach(function(n){if(this.bVertLane){if(n.getX()>i._fExpandedPosition&&n.getX()<=i._fExpandedPosition+i._fExpandedWidth){e=i.getX()-i._fExpandedPosition;if(i.getCollapsed()){e-=(n.getX()-i._fExpandedPosition)*(1-t)}n.setX(n.getX()+e)}}else{if(n.getY()>i._fExpandedPosition&&n.getY()<=i._fExpandedPosition+i._fExpandedWidth){e=i.getY()-i._fExpandedPosition;if(i.getCollapsed()){e-=(n.getY()-i._fExpandedPosition)*(1-t)}n.setY(n.getY()+e)}}}.bind(this))}.bind(this))}.bind(this))};u.prototype._traceSingleLine=function(e){var t,i,n,s;t=e.getFromNode();i=e.getToNode();n=t.getCenterPosition();s=i.getCenterPosition();e.setSource({x:n.x,y:n.y});e.setTarget({x:s.x,y:s.y});e.clearBends();var o=(this.aLaneWidths[t._iGroupIndex]+d)/2,a=(this.aLaneWidths[i._iGroupIndex]+d)/2,r=(this.aRowHeights[t.iRow]+f)/2,h=(this.aRowHeights[i.iRow]+f)/2;if(t._iGroupIndex===i._iGroupIndex&&Math.abs(t.iRow-i.iRow)===1||t.iRow===i.iRow&&Math.abs(t._iGroupIndex-i._iGroupIndex)===1){}else if(t._iGroupIndex===i._iGroupIndex){if(this.bVertLane){e.addBend({x:n.x+o,y:n.y});e.addBend({x:s.x+a,y:s.y})}else{e.addBend({x:n.x,y:n.y+o});e.addBend({x:s.x,y:s.y+a})}}else if(t.iRow===i.iRow){var g=true,p=Math.min(t._iGroupIndex,i._iGroupIndex),c=Math.max(t._iGroupIndex,i._iGroupIndex);for(var u=p+1;u<c;u++){if(this.aGrid[u]&&this.aGrid[u].length>t.iRow){g=false}}if(!g){if(this.bVertLane){e.addBend({x:n.x,y:n.y+r});e.addBend({x:s.x,y:s.y+h})}else{e.addBend({x:n.x+r,y:n.y});e.addBend({x:s.x+h,y:s.y})}}}else if(Math.abs(t.iRow-i.iRow)===1){if(this.bVertLane){if(t.iRow<i.iRow){e.addBend({x:n.x,y:n.y+r});e.addBend({x:s.x,y:s.y-h})}else{e.addBend({x:n.x,y:n.y-r});e.addBend({x:s.x,y:s.y+h})}}else{if(t.iRow<i.iRow){e.addBend({x:n.x+r,y:n.y});e.addBend({x:s.x-h,y:s.y})}else{e.addBend({x:n.x-r,y:n.y});e.addBend({x:s.x+h,y:s.y})}}}else if(Math.abs(t._iGroupIndex-i._iGroupIndex)===1){if(this.bVertLane){if(t._iGroupIndex<i._iGroupIndex){e.addBend({x:n.x+o,y:n.y});e.addBend({x:s.x-a,y:s.y})}else{e.addBend({x:n.x-o,y:n.y});e.addBend({x:s.x+a,y:s.y})}}else{if(t._iGroupIndex<i._iGroupIndex){e.addBend({x:n.x,y:n.y+o});e.addBend({x:s.x,y:s.y-a})}else{e.addBend({x:n.x,y:n.y-o});e.addBend({x:s.x,y:s.y+a})}}}else{var l,x;if(this.bVertLane){l=t._iGroupIndex<i._iGroupIndex?n.x+o:n.x-o;e.addBend({x:l,y:n.y});x=t.iRow<i.iRow?s.y-h:s.y+h;e.addBend({x:l,y:x});e.addBend({x:s.x,y:x})}else{x=t._iGroupIndex<i._iGroupIndex?n.y+o:n.y-o;e.addBend({x:n.x,y:x});l=t.iRow<i.iRow?s.x-h:s.x+h;e.addBend({x:l,y:x});e.addBend({x:l,y:s.y})}}var _,y;if(e.getBends().length>0){y=e.getBends()[e.getBends().length-1];_={x:y.getX(),y:y.getY()}}else{_=n}if(s.x===_.x){if(s.y<_.y){e.setTarget({x:s.x,y:s.y+i._iHeight/2})}else{e.setTarget({x:s.x,y:s.y-i._iHeight/2})}}else{if(s.x<_.x){e.setTarget({x:s.x+i._iWidth/2,y:s.y})}else{e.setTarget({x:s.x-i._iWidth/2,y:s.y})}}};u.prototype._beautify=function(){if(this.bVertLane){this.oGraph.getGroups().forEach(function(e){e._iHeight+=a;this._shiftGraph(0,4,true)}.bind(this))}else{this._shiftGraph(a/2,0,true)}};u.prototype._alignCoordinatesWithView=function(){var e=this._getGraphBoundingBox();this._shiftGraph(-e.p1.x,-e.p1.y)};u.prototype._findAllNipples=function(){var e,t,i,n,o,a,r,h,d,f,g,p;this._indexAllLineFragments();e=this.bVertLane?this.aHorizontalFragments:this.aVerticalFragments;e.forEach(function(e){t=Object.keys(this.aLaneOffsets).length-1;Object.keys(this.aLaneOffsets).forEach(function(c,u){if(u===t){return}i=this.aLaneGroups[c];n=this.aLaneGroups[Object.keys(this.aLaneOffsets)[u+1]];if(!i.getCollapsed()&&!n.getCollapsed()){return}o=e.line.getFromNode()._oGroup;a=e.line.getToNode()._oGroup;if(i.getCollapsed()&&n.getCollapsed()&&o===i&&a===n){return}r=i.getCollapsed()&&(i.getKey()===o.getKey()||i.getKey()===a.getKey());h=n.getCollapsed()&&(n.getKey()===o.getKey()||n.getKey()===a.getKey());g=undefined;d=i.getX()+i._iWidth;f=i.getY()+i._iHeight;if(this.bVertLane){if((r&&e.c1<=d&&e.c2>d||h&&e.c1<d&&e.c2>=d)&&e.cc>i.getY()&&e.cc<f){g={x:d,y:e.cc}}}else{if((r&&e.c1<=f&&e.c2>f||h&&e.c1<f&&e.c2>=f)&&e.cc>i.getX()&&e.cc<d){g={x:e.cc,y:f}}}if(g){if(r){if(this.bVertLane){p=s.LeftRight}else{p=s.TopBottom}}else if(h){if(this.bVertLane){p=s.RightLeft}else{p=s.BottomTop}}else{return}e.line._aNipples.push({x:g.x,y:g.y,orientation:p})}}.bind(this))}.bind(this))};u.prototype._cullLineFragmentsInCollapsedGroups=function(){var e,t,i=function(e,t){return e.getX()>=t.getX()&&e.getX()<=t.getX()+t._iWidth&&e.getY()>=t.getY()&&e.getY()<=t.getY()+t._iHeight},n=function(n,s){var o=s?n.getToNode():n.getFromNode(),a=function(){return s?n.getCoordinates().length-1:0},r;if(!o._isInCollapsedGroup()){return}r=o._oGroup;while(n.getCoordinates().length>0&&i(n.getCoordinates()[a()],r)){e=n.getCoordinates()[a()];t=n.getCoordinates()[a()+(s?-1:1)];if(t&&!i(t,r)){if(this.bVertLane){if(t.getX()<e.getX()){e.setX(r.getX())}else{e.setX(r.getX()+r._iWidth)}}else{if(t.getY()<e.getY()){e.setY(r.getY())}else{e.setY(r.getY()+r._iHeight)}}break}else{n.removeAggregation("coordinates",a(),true)}}}.bind(this);this.oGraph.getLines().forEach(function(e){n(e,false);n(e,true)})};return u});