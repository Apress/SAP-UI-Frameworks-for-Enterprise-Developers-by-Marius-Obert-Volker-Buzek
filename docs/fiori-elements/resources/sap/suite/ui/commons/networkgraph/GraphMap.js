/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./SvgBase","sap/ui/core/ResizeHandler","./GraphMapRenderer"],function(t,e,i,r){"use strict";var s=4;var o=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var a=e.extend("sap.suite.ui.commons.networkgraph.GraphMap",{metadata:{library:"sap.suite.ui.commons",properties:{height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},directRenderNodeLimit:{type:"int",group:"Behavior",defaultValue:250},title:{type:"string",group:"Misc",defaultValue:""}},associations:{graph:{type:"sap.suite.ui.commons.networkgraph.Graph",multiple:false,singularName:"graph"}},events:{mapReady:{}}}});a.prototype.init=function(){this._oResizeListener=null;this.setBusyIndicatorDelay(0)};a.prototype.onAfterRendering=function(){var t=this.getGraph();if(t&&t._bIsLayedOut){this._renderMap()}else{this.setBusy(true)}};a.prototype._renderMap=function(){var t=this.getGraph();if(!t){return}var e,i,r,o,a,h,n,p=this,d=t._fZoomLevel,u=t.getNodes().length===0,g=t._isUseNodeHtml();var f=function(t){var e="";t.forEach(function(t){e+=t._render({mapRender:true,idSufix:p.getId()})});return e};var l=function(t,e){var i=sap.ui.getCore().createRenderManager();t.forEach(function(t){t._render({mapRender:true,renderManager:i,idSufix:p.getId()})});i.flush(e);i.destroy()};var c=function(){var e=sap.ui.getCore().createRenderManager();t.getGroups().forEach(function(t){t._render({mapRender:true,renderManager:e,idSufix:p.getId()})});e.flush(this.getDomRef("divgroups"));e.destroy()}.bind(this);var m=function(e){o+=this._renderControl("rect",{x:s/2,y:s/2,width:Math.min((t.$scroller.width()-s/2)/d,(t.$svg.width()-s/2)/d),height:Math.min((t.$scroller.height()-s/2)/d,(t.$svg.height()-s/2)/d),class:e,id:this._getDomId("mapNavigator")})}.bind(this);if(!t._iWidth||!t._iHeight||u){if(t._bIsInvalid||u){this.setBusy(false);this.$().find(".sapSuiteUiCommonsNetworkGraphMapContent").html("");this.fireMapReady()}return}e=t.$("networkGraphSvg").attr("viewBox");if(!e){e="0 0 "+t._iWidth+" "+t._iHeight}o='<svg class="sapSuiteUiCommonsNetworkGraphMapSvg" width="100%" height="100%" aria-hidden="true" viewBox="'+e+'" '+'id="'+this._getDomId("svg")+'"';if(t._bIsRtl){o+=' direction ="rtl"'}o+=" >";if(this._useGraphClone()){o+=this._renderControl("use",{"xlink:href":"#"+t._getDomId("svgbody")})}else{o+=f(t.getLines());if(!g){o+=f(t.getNodes())}}o+=this._renderControl("rect",{x:0,y:0,width:t._iWidth,height:t._iHeight,class:"sapSuiteUiCommonsNetworkGraphMapBoundary","pointer-events":"fill"});if(!g){m("sapSuiteUiCommonsNetworkGraphMapNavigator")}o+="</svg>";o+='<div id="'+this._getDomId("divgroups")+'" class="sapSuiteUiCommonsNetworkGraphMapDivGroups';if(sap.ui.getCore().getConfiguration().getRTL()){o+=" sapSuiteUiCommonsNetworkGraphMapDivGroupsLeft"}o+='"></div>';if(g){o+='<div id="'+this._getDomId("divnodes")+'" class="sapSuiteUiCommonsNetworkGraphMapDivNodes';if(sap.ui.getCore().getConfiguration().getRTL()){o+=" sapSuiteUiCommonsNetworkGraphMapDivGroupsLeft"}o+='">';o+="</div>";o+='<svg class="sapSuiteUiCommonsNetworkGraphSvgNavigator" width="100%" height="100%" viewBox="'+e+'">';m("sapSuiteUiCommonsNetworkGraphMapNavigator");o+="</svg>"}this.$().find(".sapSuiteUiCommonsNetworkGraphMapContent").html(o);c();if(g){var v=this.getDomRef("divnodes");l(t.getNodes(),v)}a=this.$("svg");i=t._iWidth;r=t._iHeight;h=Math.max(i/a.width(),r/a.height());this._setHtmlNodesPosition(h);n=Math.ceil(h/5);this._iStrokeWidth=n;this._correctLineWidth();this.$("svg").find("circle").css("stroke-width",n+"px");this._setupEvents();this._correctPosition();this.setBusy(false);this.fireMapReady()};a.prototype._setHtmlNodesPosition=function(t){var e=this.getGraph(),i=this.$("svg"),r=1/t,s,o;s=Math.floor(i.width()/2-e._iWidth/2*r);o=Math.floor(i.height()/2-e._iHeight/2*r);this.$("divgroups").css("transform","matrix("+r+", 0, 0, "+r+", "+s+", "+o+")");if(e._isUseNodeHtml){this.$("divnodes").css("transform","matrix("+r+", 0, 0, "+r+", "+s+", "+o+")")}};a.prototype._useGraphClone=function(){var t=this.getDirectRenderNodeLimit(),e=this.getGraph();if(e){return t>e.getNodes().length&&!e._isUseNodeHtml()}return false};a.prototype._correctLineWidth=function(t){var t=this.getGraph(),e=this._isMSBrowser()||(!this._useGraphClone()||t._preventZoomToChangeLineWidth());this.$("svg").css("stroke-width",e?this._iStrokeWidth+"px":"1px")};a.prototype._correctMapNavigator=function(){var t=this.$("mapNavigator"),e=parseFloat(t.attr("width")),i=parseFloat(t.attr("height")),r=parseFloat(t.attr("x")),s=parseFloat(t.attr("y")),o=this.getGraph(),a=o._iWidth,h=o._iHeight;if(e+r>a){t.attr("width",a-r)}if(i+s>h){t.attr("height",h-s)}};a.prototype._resize=function(){var t=this.getGraph(),e=t.$scroller,i=this.$("mapNavigator");i.attr("x",Math.max(s/2,e[0].scrollLeft/t._fZoomLevel));i.attr("y",Math.max(s/2,e[0].scrollTop/t._fZoomLevel));i.attr("width",e.width()/t._fZoomLevel);i.attr("height",e.height()/t._fZoomLevel);this._correctLineWidth();this._correctMapNavigator()};a.prototype._resizeHandler=function(){this._resize();var t=this.getGraph();if(t._isUseNodeHtml()){var e=this.$("svg"),i=this.getGraph().$svg;if(i){var r=Math.max(i.width()/e.width(),i.height()/e.height())*(1/t._fZoomLevel);this._setHtmlNodesPosition(r)}}};a.prototype._correctPosition=function(){var t=this.getGraph(),e=t&&t.$scroller,i=this.$("mapNavigator");if(t&&e[0]){i.attr("x",Math.max(s/2,e[0].scrollLeft/t._fZoomLevel));i.attr("y",Math.max(s/2,e[0].scrollTop/t._fZoomLevel));this._correctMapNavigator()}};a.prototype._setupEvents=function(){var t=false,e=this.getGraph(),i=this.$("svg"),r=e.$scroller;var s=function(t){var s=e.$svg,o=Math.max(s.width()/i.width(),s.height()/i.height()),a=i.find(".sapSuiteUiCommonsNetworkGraphMapBoundary"),h=r[0],n=a.offset().left,p=a.offset().top;h.scrollLeft=(t.pageX-n)*o-r.width()/2;h.scrollTop=(t.pageY-p)*o-r.height()/2};var o=function(){i.removeClass("sapSuiteUiCommonsNetworkGraphPanning");t=false};r.on("scroll",function(){this._correctPosition()}.bind(this));i.off();i.on("mousedown",function(e){t=true;s(e);e.preventDefault()});i.on("mousemove",function(e){if(t){if(!i.hasClass("sapSuiteUiCommonsNetworkGraphPanning")){i.addClass("sapSuiteUiCommonsNetworkGraphPanning")}s(e)}});i.on("mouseleave",function(t){o()});i.on("mouseup",function(t){o()})};a.prototype._onBeforeDataProcess=function(){if(this.getDomRef("svg")){this.$("svg").html("");this.setBusy(true)}};a.prototype._onGraphReady=function(){if(this.getVisible()){setTimeout(this._renderMap.bind(this),0);if(this._oResizeListener){i.deregister(this._oResizeListener)}this._oResizeListener=i.register(this.getGraph().$("wrapper")[0],t.proxy(this._resizeHandler,this))}};a.prototype._removeListeners=function(){var t=this.getGraph();if(t){t.detachBeforeLayouting(this._onBeforeDataProcess,this);t.detachGraphReady(this._onGraphReady,this);t.detachZoomChanged(this._resize,this)}};a.prototype.destroy=function(){this._removeListeners();e.prototype.destroy.apply(this,arguments)};a.prototype.exit=function(){if(this._oResizeListener){i.deregister(this._oResizeListener);this._oResizeListener=null}};a.prototype.getTitle=function(){var t=this.getProperty("title");return t?t:o.getText("NETWORK_GRAPH_MAP_TITLE")};a.prototype.getGraph=function(){var t=this.getAssociation("graph");return t?sap.ui.getCore().byId(t):null||null};a.prototype.setGraph=function(t){this._removeListeners();this.setAssociation("graph",t);var e=this.getGraph();if(e){e.attachBeforeLayouting(this._onBeforeDataProcess,this);e.attachGraphReady(this._onGraphReady,this);e.attachZoomChanged(this._resize,this);if(e._isLayedOut()){this._onGraphReady()}}return this};return a});