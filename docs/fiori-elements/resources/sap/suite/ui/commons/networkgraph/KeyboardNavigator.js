/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","./Group","./Node","./Line","sap/ui/events/KeyCodes","sap/ui/dom/containsOrEquals","sap/base/Log"],function(t,e,o,i,s,n,r,u){"use strict";var a={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down"};var l=/^on.*|setFocus|setItems$/;function h(t){var e,o=t.prototype;for(e in o){if(o.hasOwnProperty(e)&&typeof o[e]==="function"&&l.test(e)){o[e]=f(o[e])}}}function f(t){return function(){try{return t.apply(this,arguments)}catch(t){this._handleError(t)}return undefined}}var p=e.extend("sap.suite.ui.commons.networkgraph.KeyboardNavigator",{constructor:function(t){e.apply(this,arguments);this._oGraph=t;this._aItems=[[]];this._iRows=0;this._iColumns=0;this._iPageSize=5;this._oFocus=null;this._oFocusPosition=null;this._oWrapperDom=null}});p.prototype.getFocus=function(){var t=this._oGraph.getFocus();if(this._oFocus!==t){this._oFocus=t?{item:t.item,button:t.button}:null;this._oFocusPosition=null}if(this._oFocus!=null&&this._oFocus.item===null&&this._oFocus.button===null){return null}return this._oFocus?{item:this._oFocus.item,button:this._oFocus.button}:null};p.prototype.getFocusPosition=function(){var t=this.getFocus();if(!this._oFocusPosition){var e,o;this._oFocusPosition={iX:null,iY:null};if(!t){return this._oFocusPosition}for(o=0;o<this._aItems.length;o++){for(e=0;e<this._aItems[o].length;e++){if(this._aItems[o][e]===t.item){this._oFocusPosition={iX:e,iY:o};return this._oFocusPosition}}}}return this._oFocusPosition};p.prototype.setItems=function(t){this._aItems=t;this._iRows=t.length;this._iColumns=0;t.forEach(function(t){if(this._iColumns<t.length){this._iColumns=t.length}},this)};p.prototype.setWrapperDom=function(t){this._oWrapperDom=t};p.prototype.setPageSize=function(t){this._iPageSize=t};p.prototype.onsapend=function(t){this._moveThroughMatrix(t,true,true)};p.prototype.onsaphome=function(t){this._moveThroughMatrix(t,true,false)};p.prototype.onsapendmodifiers=function(t){if(t.ctrlKey){this._moveThroughMatrix(t,false,true)}};p.prototype.onsaphomemodifiers=function(t){if(t.ctrlKey){this._moveThroughMatrix(t,false,false)}};p.prototype.onsappagedown=function(t){this._moveThroughMatrix(t,false,true,this._iPageSize)};p.prototype.onsappageup=function(t){this._moveThroughMatrix(t,false,false,this._iPageSize)};p.prototype.onsappagedownmodifiers=function(t){if(t.altKey){this._moveThroughMatrix(t,true,true,this._iPageSize)}};p.prototype.onsappageupmodifiers=function(t){if(t.altKey){this._moveThroughMatrix(t,true,false,this._iPageSize)}};p.prototype.onsapspace=function(t){this._handleEnter();if(this._oGraph.getFocusDomRef()===document.activeElement){t.stopPropagation();t.preventDefault()}};p.prototype.onsapspacemodifiers=function(t){if(t.ctrlKey&&this._oGraph.getFocusDomRef()===document.activeElement){this._selectElement(true);t.stopPropagation();t.preventDefault()}};p.prototype.onsapenter=function(t){this._handleEnter()};p.prototype.onsaptabnext=function(t){this._handleTab(t,a.RIGHT)};p.prototype.onsaptabprevious=function(t){this._handleTab(t,a.LEFT)};p.prototype.onsapleft=function(t){this._handleArrow(t,a.LEFT)};p.prototype.onsapright=function(t){this._handleArrow(t,a.RIGHT)};p.prototype.onsapup=function(t){this._handleArrow(t,a.UP)};p.prototype.onsapdown=function(t){this._handleArrow(t,a.DOWN)};p.prototype.onkeydown=function(t){var e,r,u=this.getFocus();if(!u){return}e=u.item;r=u.button;if(t.ctrlKey&&t.keyCode===n.A){this._onCtrlA(t)}else if(t.keyCode===n.F2){if(e instanceof i){if(e.hasVisibleActionButtons()&&e.getShowDetailButton()){e._detailClick(e.getDomRef().querySelector("#"+e.getId()+"-actionDetail").querySelector(".sapSuiteUiCommonsNetworkGraphDivActionButton"))}}else if(e instanceof s){e.getParent()._tooltip.openDetail({item:e,point:e._getArrowFragmentVector().apex})}else if(e instanceof o){e._openDetail()}t.stopPropagation()}else if(t.keyCode===n.F6){if(e&&r){u.button=null;this._oGraph.setFocus(u)}this._handleArrow(t,t.shiftKey?a.LEFT:a.RIGHT)}else if(t.keyCode===n.F7&&!t.shiftKey){if(e&&r){u.button=null;this._oGraph.setFocus(u)}}else if(t.ctrlKey&&(t.keyCode===n.DIGIT_0||t.keyCode===n.NUMPAD_0)){this._onCtrl0(t)}else if(t.ctrlKey&&(t.keyCode===n.PLUS||t.keyCode===n.NUMPAD_PLUS)){this._onCtrlPlus(t)}else if(t.ctrlKey&&(t.keyCode===n.SLASH||t.keyCode===n.NUMPAD_MINUS)){this._onCtrlMinus(t)}};p.prototype._handleEnter=function(){var e,n,r=this.getFocus();if(!r){return}if(r.button=="menu"){r.item._setMenuButtonFocus(false)}e=r.item;n=r.button;if(e instanceof i){if(n){this._oGraph._isUseNodeHtml()?t(n).trigger("click"):t(n).children().first().trigger("click")}else{e._onClick(false);if(!e.getSelected()){e.$().removeClass(e.HIGHLIGHT_CLASS);e._setStatusColors("")}}}else if(e instanceof s){var u=e._getArrowFragmentVector();e._click({ctrlKey:false,clientX:u.apex.x,clientY:u.apex.y,skipConversion:true})}else if(e instanceof o){if(n===o.BUTTONS.MENU){e._openDetail()}else if(n===o.BUTTONS.COLLAPSE){e._collapse()}else{e._openDetail()}}};p.prototype._handleTab=function(t,e){var o=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");this._oWrapperDom.setAttribute("aria-live","assertive");this._oGraph._setAriaLabelForWrapper(o.getText("NETWORK_GRAPH_ACCESSIBILITY_LABEL"));if(this._ignoreEvent(t)){this._oWrapperDom.setAttribute("aria-live","off");this._oWrapperDom.classList.remove("sapSuiteUiCommonsNetworkGraphContentFocusHidden");return}else{this._oWrapperDom.classList.add("sapSuiteUiCommonsNetworkGraphContentFocusHidden")}if(this._handleTabOverNodeWithButtons(t,e)||this._handleTabOverGroupWithButtons(t,e)){t.preventDefault();t.stopPropagation();return}this._moveItemFocus(t,e)};p.prototype._handleTabOverNodeWithButtons=function(t,e){var o=this.getFocus(),s,n,r,u=false,l;if(!o){return false}s=o.item;n=o.button;r=s&&s.getEnabledActionButtons?s.getEnabledActionButtons():[];if(!(s instanceof i)||!s.hasVisibleActionButtons()||r.length===0){return false}if(n){l=0;for(var h=0;h<r.length;h++){if(r[h].isEqualNode(n)){l=h;break}}if(e===a.RIGHT){if(l===r.length-1){return false}else{this._setActionButtonFocus(r[l+1])}u=true}else if(e===a.LEFT){if(l===0){this._moveItemFocus(t,this.getFocusPosition())}else{this._setActionButtonFocus(r[l-1])}u=true}}else if(e===a.RIGHT){this._setActionButtonFocus(r[0]);u=true}return u};p.prototype._handleTabOverGroupWithButtons=function(t,e){var i=this.getFocus(),s,n;if(!i){return false}s=i.item;n=i.button;if(s instanceof o){if(!n){n=o.BUTTONS.MENU}if(n){if(n===o.BUTTONS.MENU){if(e===a.RIGHT){i.button=o.BUTTONS.COLLAPSE;this._oGraph.setFocus(i);return true}else if(e===a.LEFT){return false}}else if(n===o.BUTTONS.COLLAPSE){if(e===a.RIGHT){return false}else if(e===a.LEFT){i.button=o.BUTTONS.MENU;this._oGraph.setFocus(i);return true}}}}return false};p.prototype._setActionButtonFocus=function(t){var e=this.getFocus();if(!e){return}e.button=t;this._oGraph.setFocus(e)};p.prototype._selectElement=function(t){var e=this.getFocus(),o;if(!e){return}o=e.item;if(o instanceof i){o.getParent()._selectNode({element:o,setFocus:false,renderActionButtons:false,preventDeselect:t})}else if(o instanceof s){o.getParent()._selectLine({element:o,setFocus:false,preventDeselect:t})}};p.prototype._moveThroughMatrix=function(t,e,o,i){var s=this.getFocus(),n,r,u,a,l=this.getFocusPosition().iX,h=this.getFocusPosition().iY;if(this._ignoreEvent(t)||!s){return}n=s.item;u=0;i=i||Number.POSITIVE_INFINITY;do{for(var f=(e?l:h)+(o?1:-1);o&&f<(e?this._iColumns:this._iRows)||!o&&f>=0;f+=o?1:-1){r=e&&h>=0&&h<this._iRows||!e&&l>=0&&l<this._iColumns?this._aItems[e?h:f][e?f:l]:null;if(r&&u<i){a=r;u++;if(u>=i){break}}}if(i<Number.POSITIVE_INFINITY&&u<i){if(e){if(o){l=-1;h++}else{l=this._iColumns;h--}}else if(o){l++;h=-1}else{l--;h=this._iRows}}}while(i<Number.POSITIVE_INFINITY&&u<i&&h>=-1&&h<=this._iRows&&l>=-1&&l<=this._iColumns);if(a&&a!==n){s.item=a;s.button=null;this._oGraph.setFocus(s);t.stopPropagation()}};p.prototype._handleArrow=function(t,e){if(this._ignoreEvent(t)||!this.getFocus()){return}this._moveItemFocus(t,e,true)};p.prototype._moveItemFocus=function(t,e,s){var n,r=e===a.LEFT&&t.key==="Tab",u,l,h;if(typeof e==="string"){u=this._findNextPosition(e)}else{u=e}l=this._getItemAtPosition(u);n={item:l,button:null};if(r&&l!==null){if(l instanceof i&&l.hasVisibleActionButtons()){h=l.getEnabledActionButtons();if(h.length>0){n.button=h[h.length-1]}}else if(l instanceof o){n.button=o.BUTTONS.COLLAPSE}}if(l||!s){this._oGraph.setFocus(n)}if(t&&l){t.preventDefault();t.stopPropagation()}};p.prototype._getItemAtPosition=function(t){var e;if(!t||t.iX===null){return null}else{e=this._aItems[t.iY];return e?e[t.iX]:null}};p.prototype._findNextPosition=function(t){var e,o;if(this.getFocusPosition().iX===null){if(t===a.LEFT){e=this._iColumns-1;o=this._iRows-1}else{e=0;o=0}if(this._aItems[o][e]!==null){return{iX:e,iY:o}}}else{e=this.getFocusPosition().iX;o=this.getFocusPosition().iY}do{switch(t){case a.RIGHT:e+=1;if(e>=this._iColumns){o+=1;e=0}break;case a.LEFT:e-=1;if(e<0){o-=1;e=this._iColumns-1}break;case a.UP:o-=1;if(o<0&&e>0){e-=1;o=this._iRows-1}break;case a.DOWN:o+=1;if(o>=this._iRows&&e<this._iColumns-1){e+=1;o=0}break;default:throw new Error("Unexpected direction: "+t)}}while(o>=0&&o<this._iRows&&this._aItems[o][e]===null);if(o<0||o>=this._iRows){return null}else{return{iX:e,iY:o}}};p.prototype._onCtrlA=function(t){if(this._ignoreEvent(t)){return}var e=true;this._forEach(function(t){if(t instanceof o){return false}if(!t.getSelected()){e=false;return true}return false});e=!e;this._forEach(function(t){if(!(t instanceof o)){t.setSelected(e)}});t.preventDefault();t.stopPropagation()};p.prototype._forEach=function(t){var e,o,i,s;for(o=0;o<this._iRows;o++){for(e=0;e<this._iColumns;e++){i=this._aItems[o][e];if(i){s=t.call(this,i,e,o);if(s){return}}}}};p.prototype._onCtrl0=function(t){this._oGraph._zoom({zoomLevel:this._oGraph.ZOOM_100});t.preventDefault();t.stopPropagation()};p.prototype._onCtrlPlus=function(t){this._oGraph._zoom({deltaY:1});t.preventDefault();t.stopPropagation()};p.prototype._onCtrlMinus=function(t){this._oGraph._zoom({deltaY:-1});t.preventDefault();t.stopPropagation()};p.prototype._ignoreEvent=function(t){return!r(this._oWrapperDom,t.target)};p.prototype._handleError=function(t){u.error("An error in KeyboardNavigator: "+t)};h(p);return p});