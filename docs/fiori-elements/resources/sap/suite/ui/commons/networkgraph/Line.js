/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/suite/ui/commons/library","./ElementBase","./layout/Geometry","./Coordinate","./Utils"],function(t,e,o,i,r){"use strict";var s=t.networkgraph.LineArrowPosition,n=t.networkgraph.LineType,a=t.networkgraph.LineArrowOrientation,h=t.networkgraph.NodeShape,g=t.networkgraph.Orientation;var p=6,u=5,d=.45,l=15,c={Apex:{x:5.5,y:0},Second:{x:-5.5,y:-7.5},Third:{x:-5.5,y:7.5}},f={Apex:{x:16,y:0},Second:{x:5,y:-7.5},Third:{x:5,y:7.5}},y={Apex:{x:-12,y:0},Second:{x:-1,y:-7.5},Third:{x:-1,y:7.5}},_=5;var m=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var C=e.extend("sap.suite.ui.commons.networkgraph.Line",{metadata:{library:"sap.suite.ui.commons",properties:{selected:{type:"boolean",group:"Misc",defaultValue:false},from:{type:"string",group:"Misc",defaultValue:null},to:{type:"string",group:"Misc",defaultValue:null},lineType:{type:"sap.suite.ui.commons.networkgraph.LineType",group:"Appearance",defaultValue:n.Solid},arrowPosition:{type:"sap.suite.ui.commons.networkgraph.LineArrowPosition",group:"Appearance",defaultValue:s.End},arrowOrientation:{type:"sap.suite.ui.commons.networkgraph.LineArrowOrientation",group:"Appearance",defaultValue:a.ParentOf},stretchToCenter:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{coordinates:{type:"sap.suite.ui.commons.networkgraph.Coordinate",multiple:true,singularName:"coordinate"},actionButtons:{type:"sap.suite.ui.commons.networkgraph.ActionButton",multiple:true,singularName:"actionButton"}},events:{hover:{},press:{parameters:{point:"Object",opener:"Object"}}}},renderer:function(t,e){t.write(e._render())},onAfterRendering:function(){this._afterRenderingBase()},init:function(){this._oFrom=null;this._oTo=null;this._bFocusRendered=false;this._sKey="";this._bIsHidden=false}});C.prototype.aProcessRequiredProperties=["from","to"];C.prototype._afterRendering=function(){this._setupEvents();if(this.getFromNode()._bIsHidden||this.getToNode()._bIsHidden){this.$().hide()}this._removeFromInvalidatedControls()};C.prototype._render=function(t){var o="",i=this.getSelected()?" "+this.SELECT_CLASS+" ":"",r=this._getElementId(t&&t.idSufix),n;var h=this._getStatusStyle({stroke:e.ColorType.Border,"stroke-width":e.ColorType.BorderWidth,"stroke-dasharray":e.ColorType.BorderStyle});var p=this._getStatusStyle({fill:e.ColorType.Background,stroke:e.ColorType.Border});var u=function(t,e,o){return this._renderControl("path",{d:n,class:t||this._getLineClass(),style:o?"":h,from:this.getFromNode().getKey(),to:this.getToNode().getKey(),id:r?r+"-"+e:""})}.bind(this);var d=function(t,e,o){return{id:r+"-"+o,class:"sapSuiteUiCommonsNetworkLineArrow",style:p,d:"M "+e[t+0].x+","+e[t+0].y+" L "+e[t+1].x+","+e[t+1].y+" L "+e[t+2].x+","+e[t+2].y+" Z"}};var l=function(t,e,o){var i=this._getArrowPoints(t,e),r=this._renderControl("path",d(0,i,o||"arrow"));if(this._isBothMiddleArrow()){r+=this._renderControl("path",d(3,i,"arrow1"))}return r}.bind(this);var c=function(t,e,o){var i=t,r=e,s=" 0 0 0 ";if(o===g.LeftRight||o===g.RightLeft){e-=_;r+=_}if(o===g.TopBottom||o===g.BottomTop){t-=_;i+=_}if(o===g.BottomTop||o===g.LeftRight){s=" 0 0 1 "}return"M"+t+" "+e+"A"+_+" "+_+s+" "+i+" "+r};this._bFocusRendered=false;if(this._isIgnored()){return""}if(!this.getVisible()){return'<g style="display:none" id="'+r+'" data-sap-ui="'+r+'"></g>'}n=this._createPath();o+=this._renderControl("g",{class:"sapSuiteUiCommonsNetworkLine "+this._getStatusClass()+i,id:r,"data-sap-ui":r},false);o+=u("sapSuiteUiCommonsNetworkLineInvisibleWrapper","invisibleWrapper",true);o+=u("","path");if(this.getArrowOrientation()!==a.None&&this.getCoordinates().length>=2){if(this.getArrowOrientation()===a.Both){if(this.getArrowPosition()===s.Middle){o+=l(a.ParentOf,s.Middle)}else{o+=l(a.ChildOf,s.Start,"arrow");o+=l(a.ParentOf,s.End,"arrow1")}}else{o+=l()}}if(this._aNipples){var f=p?'style="'+p+'"':"";this._aNipples.forEach(function(t){o+="<path "+f+' class="sapSuiteUiCommonsNetworkLineNipple" d="'+c(t.x,t.y,t.orientation)+'" />'})}o+="</g>";return o};C.prototype._renderFocusWrapper=function(){var t=function(t){var e=this._createElement("path",{d:this._createPath(t),class:"sapSuiteUiCommonsNetworkLineFocus"});this.$()[0].appendChild(e)}.bind(this);if(!this._bFocusRendered){t(u);t(-u);this._bFocusRendered=true}};C.prototype._resetLayoutData=function(){this._aNipples=null};C.prototype._createPath=function(t){if(!this.getSource()||!this.getTarget()){return}var e=[{x:this.getSource().getX(),y:this.getSource().getY()}],i="M"+this.getSource().getX()+","+this.getSource().getY(),r,s,n=this._isTopBottom(),a=n?"x":"y",h=n?"getX":"getY",g=this.getBends().concat([this.getTarget()]);for(var u=0;u<g.length;u++){r=e[u-1]?e[u-1][a]:NaN;s=g[u][h]();if(Math.abs(r-g[u][h]())<2){e.pop();s=r}e.push({x:n?s:g[u].getX(),y:!n?s:g[u].getY()})}for(var d=1;d<e.length;d++){i+=" L"+e[d].x+","+e[d].y}return o.getBezierPathCorners(i,p,t)};C.prototype._getLineClass=function(){var t=function(){switch(this.getLineType()){case n.Dashed:return"sapSuiteUiCommonsNetworkDashedLine";case n.Dotted:return"sapSuiteUiCommonsNetworkDottedLine";default:return""}}.bind(this);return"sapSuiteUiCommonsNetworkLinePath "+t()};C.prototype._getArrowFragmentVector=function(t){var e=this.getCoordinates(),i=e.length-1,r=0,n=function(t){return Math.abs(e[t].getX()-e[t+1].getX())+Math.abs(e[t].getY()-e[t+1].getY())};t=t||this.getArrowPosition();if(this.getBends().length===0){r=0}else if(t===s.Start){while(r<i-1&&this._doesLineFragmentCrossCollapsedGroup(r)){r++}if(n(r)<l){r++}if(this._doesLineFragmentCrossCollapsedGroup(r)){r=0}}else if(t===s.End){r=i-1;while(r>0&&this._doesLineFragmentCrossCollapsedGroup(r)){r--}if(n(r)<l){r--}}else{var a=[],h=0;for(var g=0;g<i;g++){if(e[g].getX()===e[g+1].getX()){h+=Math.abs(e[g+1].getY()-e[g].getY())}else if(e[g].getY()===e[g+1].getY()){h+=Math.abs(e[g+1].getX()-e[g].getX())}else{h+=o.getPointsDistance({x:e[g].getX(),y:e[g].getY()},{x:e[g+1].getX(),y:e[g+1].getY()})}a.push(h)}h=h/2;for(g=0;g<i&&r===0;g++){if(a[g]>=h&&!this._doesLineFragmentCrossCollapsedGroup(g)){r=g}}}if(r<0||r>i-1){r=0}return{center:{x:e[r].getX(),y:e[r].getY()},apex:{x:e[r+1].getX(),y:e[r+1].getY()}}};C.prototype._doesLineFragmentCrossCollapsedGroup=function(t){var e=this.getParent(),i=this.getCoordinates()[t],r=this.getCoordinates()[t+1];return e.getGroups().some(function(t){return t.getCollapsed()&&o.doLineRectangleIntersect({p1:{x:Math.min(i.getX(),r.getX())+1,y:Math.min(i.getY(),r.getY())+1},p2:{x:Math.max(i.getX(),r.getX())-1,y:Math.max(i.getY(),r.getY())-1}},{p1:{x:t.getX(),y:t.getY()},p2:{x:t.getX()+t._iWidth,y:t.getY()+t._iHeight}})})};C.prototype._getArrowPoints=function(t,e){var i,r,n,g,p=[];t=t||this.getArrowOrientation();e=e||this.getArrowPosition();var u=function(u){var c=l;if(e===s.Middle){n={x:(r.apex.x-r.center.x)*d+r.center.x,y:(r.apex.y-r.center.y)*d+r.center.y}}else{if(!(this.getToNode()._oGroup&&this.getToNode()._oGroup.getCollapsed())&&this.getToNode().getShape()===h.Circle&&e===s.End){c+=this.getToNode()._getCircleSize()/2}else if(!(this.getFromNode()._oGroup&&this.getFromNode()._oGroup.getCollapsed())&&this.getFromNode().getShape()===h.Circle&&e===s.Start){c+=this.getFromNode()._getCircleSize()/2}i=o.getNormalizedVector(r,c);if(e===s.Start){n=r.center}else if(e===s.End){i=o.getRotatedVector(i,Math.PI);n=r.apex}n=o.getPointSum(n,i.apex)}g=o.getAngleOfVector(r);if(t===a.ChildOf){g+=Math.PI}p.push(o.getPointSum(n,o.getRotatedPoint(u,g)))}.bind(this);r=this._getArrowFragmentVector(e);if(this._isBothMiddleArrow()){u(f.Apex);u(f.Second);u(f.Third);u(y.Apex);u(y.Second);u(y.Third)}else{u(c.Apex);u(c.Second);u(c.Third)}return p};C.prototype._getAccessibilityLabel=function(){var t=this.getFromNode().getTitle();var e=t?t:this.getFromNode().getAltText();var o=this.getToNode().getTitle();var i=o?o:this.getToNode().getAltText();return m.getText("NETWORK_GRAPH_ACCESSIBILITY_LINE_LABEL",[e,i])+" "+this.getTitle()};C.prototype.getFromNode=function(){this._checkForProcessData();if(!this._oFrom&&this.getParent()){this._oFrom=this.getParent().getNodeByKey(this.getFrom())}return this._oFrom};C.prototype.getToNode=function(){this._checkForProcessData();if(!this._oTo&&this.getParent()){this._oTo=this.getParent().getNodeByKey(this.getTo())}return this._oTo};C.prototype.setSource=function(t){var e;if(this.getCoordinates().length===0){e=new i;this.addAggregation("coordinates",e,true)}e=this.getCoordinates()[0];if(t.x||t.x===0){e.setX(t.x)}if(t.y||t.y===0){e.setY(t.y)}};C.prototype.getSource=function(){return this.getCoordinates()[0]};C.prototype.getTarget=function(){return this.getCoordinates().length>0?this.getCoordinates()[this.getCoordinates().length-1]:null};C.prototype.setTarget=function(t){var e;if(this.getCoordinates().length<2){e=new i;this.addAggregation("coordinates",e,true)}e=this.getCoordinates()[this.getCoordinates().length-1];if(t.x||t.x===0){e.setX(t.x)}if(t.y||t.y===0){e.setY(t.y)}};C.prototype.getBends=function(){return this.getCoordinates().filter(function(t,e){return e>0&&e<this.getCoordinates().length-1},this)};C.prototype.clearBends=function(){this.getBends().forEach(function(t){this.removeAggregation("coordinates",t,true)},this)};C.prototype.addBend=function(t){var e=new i;e.setX(t.x);e.setY(t.y);this.insertAggregation("coordinates",e,this.getCoordinates().length-1,true);return e};C.prototype.isHidden=function(){return this._bIsHidden};C.prototype.getKey=function(){return this._getLineId()};C.prototype.setHidden=function(t){this.$()[t?"hide":"show"]()};C.prototype._isIgnored=function(){var t=this.getFromNode(),e=this.getToNode(),o=t._oGroup&&t._oGroup.getCollapsed()&&e._oGroup&&e._oGroup.getCollapsed()&&t._oGroup===e._oGroup,i=!t._useInLayout()||!e._useInLayout();return!this._useInLayout||o||this._isLoop()||i};C.prototype._isLoop=function(){return this.getFromNode().getId()===this.getToNode().getId()};C.prototype._getLineId=function(){return this._sKey?this._sKey:"line_"+this.getFrom()+"-"+this.getTo()};C.prototype._setupEvents=function(){var t=this.$().find(".sapSuiteUiCommonsNetworkLineInvisibleWrapper");t.on("click",function(t){this._click({ctrlKey:t.ctrlKey,clientX:t.clientX,clientY:t.clientY})}.bind(this));t.on("mouseover",function(t){this._mouseOver()}.bind(this));t.on("mouseout",function(t){this._mouseOut()}.bind(this))};C.prototype._mouseOut=function(){this.$().removeClass(this.HIGHLIGHT_CLASS);if(!this.getSelected()){this._setStatusColors("")}};C.prototype._mouseOver=function(){var t=this.fireEvent("hover",{},true);if(!this.getSelected()&&t){this._setStatusColors("Hover");this.$().addClass(this.HIGHLIGHT_CLASS)}};C.prototype._setStatusColors=function(t){var o=this.$().find(".sapSuiteUiCommonsNetworkLineArrow"),i=this._getColor(e.ColorType[t+"Border"]),r=this._getColor(e.ColorType[t+"Background"]);o.css("fill",r);o.css("stroke",i);this.$("path").css("stroke",i);if(this.getParent()&&this.getParent()._isSwimLane()){var s=this.$().find(".sapSuiteUiCommonsNetworkLineNipple");s.css("fill",r);s.css("stroke",i)}};C.prototype._showActionButtons=function(t){var e=function(t,e,o){var r=i(t,e,o);if(r){t._setNodeOpacity(true);a._aShadedNodes.push(t)}return r};var i=function(t,e,i){return o.hasRectangleRectangleIntersection({p1:{x:v,y:C},p2:{x:i,y:e}},t._getContentRect())};var r=function(t,e){return{p1:{x:t.x,y:t.y},p2:{x:e.x,y:e.y}}};var s=0;var n=function(t,e){if(s<2){var o=jQuery("<div></div>",{class:t,css:{top:e.top,left:e.left,right:e.right,bottom:e.bottom}});g.append(o);s++}};var a=this.getParent(),h=a.$("divlinebuttons"),g=a.$("linetooltip"),p=a.$("linetooltipbuttons");var u=this.getFromNode(),d=this.getToNode();var l=10;a._aShadedNodes=[];var c=u.getTitle();var f=c?c:u.getAltText();var y='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipText">'+f+"</span>";if(this._isBothArrow()){y+='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipArrow sapSuiteUiCommonsNetworkGraphLineTooltipDualArrow"></span>'}var _=d.getTitle();var m=_?_:d.getAltText();y+='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipArrow"></span>'+"</br>"+'<span class="sapSuiteUiCommonsNetworkGraphLineTooltipText">'+m+"</span>";g.html(y);p.html("");this.getActionButtons().forEach(function(t){this._appendActionButton({icon:t.getIcon(),enable:t.getEnabled(),title:t.getTitle(),id:t.getId(),click:function(e){t.firePress({buttonElement:e.target})}},p)}.bind(this));h.show();var C=t.y-g.outerHeight()/2,v=t.x-g.outerWidth()/2,S=C+g.outerHeight(),T=v+g.outerWidth();e(d,S,v+h.width());var x=e(u,C+g.height(),v),w=e(d,S,v+g.outerWidth()+l);if(a._isLayered()){var A={x:v,y:C};var N={x:T,y:C};var L={x:T,y:S};var P={x:v,y:S};var F=this.getCoordinates();for(var b=0;b<F.length-1&&s<2;b++){var B=F[b],k=F[b+1];var I={x:B.getX(),y:B.getY()};var Y={x:k.getX(),y:k.getY()};var X=r(I,Y);var O=o.getSegmentsIntersection(X,r(A,P));if(O&&!x){n("sapSuiteUiCommonsNetworkGraphTooltipLeftArrow",{top:O.y-C-l})}O=o.getSegmentsIntersection(X,r(N,L));if(O&&!w){n("sapSuiteUiCommonsNetworkGraphTooltipRightArrow",{top:O.y-C-l})}O=o.getSegmentsIntersection(X,r(P,L));if(O){n("sapSuiteUiCommonsNetworkGraphTooltipBottomArrow",{left:O.x-v-l})}O=o.getSegmentsIntersection(X,r(A,N));if(O){n("sapSuiteUiCommonsNetworkGraphTooltipTopArrow",{left:O.x-v-l})}}h.css("top",C+"px");h.css("left",v+"px")}};C.prototype._setActionButtonFocus=function(t,e){var o=this.getParent().$("divlinebuttons");o.removeClass(this.FOCUS_CLASS);o.find("."+this.FOCUS_CLASS).removeClass(this.FOCUS_CLASS);jQuery(t).toggleClass(this.FOCUS_CLASS,e)};C.prototype._click=function(t){var e=this.getParent(),o=t.skipConversion?{x:t.clientX,y:t.clientY}:e.getCorrectMousePosition({x:t.clientX,y:t.clientY}),i=e._tooltip._getOpener(this,o),r;e._selectLine({element:this,forceFocus:true,preventDeselect:t.ctrlKey});r=this.fireEvent("press",{opener:i,point:o},true);if(this.getSelected()&&r){this.getActionButtons().length===0?e._tooltip.openDetail({item:this,opener:i,point:o}):this._showActionButtons(o)}};C.prototype._setFocus=function(t){e.prototype._setFocus.call(this,t);if(t){this._renderFocusWrapper()}};C.prototype._isEndPosition=function(){return this.getArrowPosition()===s.End&&this.getArrowOrientation()===a.ParentOf||this.getArrowPosition()===s.Start&&this.getArrowOrientation()===a.ChildOf};C.prototype._moveToEnd=function(){return this._isEndPosition()||this.getArrowPosition()===s.Middle&&this.getArrowOrientation()===a.ParentOf};C.prototype._hideShow=function(t){if(t){this.$().hide();this._bIsHidden=true}else if(!this.getToNode()._bIsHidden&&!this.getFromNode()._bIsHidden){this.$().show();this._bIsHidden=false}};C.prototype._shift=function(t){this.getBends().forEach(function(e){e.setX(e.getX()+t.x);e.setY(e.getY()+t.y)});if(this.getSource()){this.setSource({x:this.getSource().getX()+t.x,y:this.getSource().getY()+t.y})}if(this.getTarget()){this.setTarget({x:this.getTarget().getX()+t.x,y:this.getTarget().getY()+t.y})}if(this._aNipples){this._aNipples.forEach(function(e){e.x+=t.x;e.y+=t.y})}};C.prototype._normalizePath=function(){var t,e;t=this.getFromNode().getCenterPosition();this.setSource({x:t.x,y:t.y});e=this.getToNode().getCenterPosition();this.setTarget({x:e.x,y:e.y});this.clearBends()};C.prototype._validateLayout=function(){return(!this.getSource()||isFinite(this.getSource().getX())&&isFinite(this.getSource().getY()))&&(!this.getTarget()||isFinite(this.getTarget().getX())&&isFinite(this.getTarget().getY()))&&!this.getBends().some(function(t){return!isFinite(t.getX())||!isFinite(t.getY())})};C.prototype.setSelected=function(t){var e=this.getParent(),o=t?"addClass":"removeClass";this._setStatusColors(t?"Selected":"");this.setProperty("selected",t,true);this.$()[o](this.SELECT_CLASS);if(e){if(t){e._mSelectedLines[this._getLineId()]=this}else{this._setStatusColors("");delete e._mSelectedLines[this._getLineId()]}}return this};C.prototype.setFrom=function(t){var e=this.getParent();this.setProperty("from",t,true);if(e){e.invalidate()}return this};C.prototype.setTo=function(t){var e=this.getParent();this.setProperty("to",t,true);if(e){e.invalidate()}return this};C.prototype._isTopBottom=function(){var t=this.getParent();return t&&t._isTopBottom()};C.prototype.getFocusDomRef=function(){return this.getDomRef("invisibleWrapper")};C.prototype._createSuggestionHelpText=function(){var t=25;var e=this.getTitle()?this.getTitle()+" ":"";var o=this.getFromNode().getTitle();var i=o?o:this.getFromNode().getAltText();var s=this.getToNode().getTitle();var n=s?s:this.getToNode().getAltText();return e+"("+r.trimText(i,t)+" -> "+r.trimText(n,t)+")"};C.prototype._isInCollapsedGroup=function(){var t=this.getFromNode(),e=this.getToNode();return t._oGroup===e._oGroup&&t._isInCollapsedGroup()};C.prototype._isBothMiddleArrow=function(){return this.getArrowOrientation()===a.Both&&this.getArrowPosition()===s.Middle};C.prototype._isBothArrow=function(){return this.getArrowOrientation()===a.Both};C.prototype._isOnScreen=function(t,o,i,r){var s=this.getCoordinates(),n,a;for(n=1;n<s.length;n++){a=e._isRectOnScreen(s[n-1].getX(),s[n].getX(),s[n-1].getY(),s[n].getY(),t,o,i,r);if(a){return true}}return false};return C});