/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/delegate/ItemNavigation","sap/base/assert","sap/ui/dom/containsOrEquals","sap/ui/events/KeyCodes"],function(t,e,i,s,o){"use strict";function n(t,e){var i=t.length-e.length;return i>=0&&t.lastIndexOf(e)===i}var a=e.extend("sap.suite.ui.commons.TimelineNavigator",{constructor:function(t,i,s,o){e.apply(this,arguments);this.setDisabledModifiers({sapnext:["alt"],sapprevious:["alt"]});this.setCycling(false);this._aRows=o;this.iActiveTabIndex=0;this.iTabIndex=0;this.bRefocusOnNextUpdate=false;this.oLastFocused=null}});a.prototype.updateReferences=function(t,e,i){this.oDomRef=t;this.setItemDomRefs(e);this._aRows=i;if(this.bRefocusOnNextUpdate){this._refocusItem();this.bRefocusOnNextUpdate=false}this.setBeforeAfterTabIndex()};a.prototype.refocusOnNextUpdate=function(){this.bRefocusOnNextUpdate=true};a.prototype._refocusItem=function(){var e=this.iFocusedIndex;if(e<0){return}while(!t(this.aItemDomRefs[e]).is(":visible")){e++;if(e>=this.aItemDomRefs.length){e=0}if(e===this.iFocusedIndex){break}}setTimeout(function(){if(this.aItemDomRefs){this.focusItem(e)}}.bind(this),0)};a.prototype.setItemDomRefs=function(e){i(Array.isArray(e),"aItemDomRefs must be an array of DOM elements");this.aItemDomRefs=e;if(this.iFocusedIndex>e.length-1){this.iFocusedIndex=e.length-1}for(var s=0;s<this.aItemDomRefs.length;s++){if(this.aItemDomRefs[s]){var o=t(this.aItemDomRefs[s]);if(s==this.iFocusedIndex&&!o.data("sap.INRoot")){o.attr("tabIndex",this.iActiveTabIndex)}else if(o.attr("tabindex")=="0"){o.attr("tabIndex",this.iTabIndex)}o.data("sap.INItem",true);o.data("sap.InNavArea",true);if(o.data("sap.INRoot")&&s!=this.iFocusedIndex){o.data("sap.INRoot").setNestedItemsTabindex()}}}return this};a.prototype.setItemsTabindex=function(){for(var e=0;e<this.aItemDomRefs.length;e++){if(this.aItemDomRefs[e]){var i=t(this.aItemDomRefs[e]);if(i.is(":sapFocusable")){if(e==this.iFocusedIndex&&!i.data("sap.INRoot")){i.attr("tabIndex",this.iActiveTabIndex)}else{i.attr("tabIndex",this.iTabIndex)}}}}return this};a.prototype.setBeforeAfterTabIndex=function(){if(this.oDomRef){var e=this.oDomRef.id+"-after";t(window.document.getElementById(e)).attr("tabindex",-1);e=this.oDomRef.id+"-before";t(window.document.getElementById(e)).attr("tabindex",-1);t(this.oDomRef).attr("tabindex",-1)}};a.prototype.setFocusedIndex=function(e){var i;if(this.aItemDomRefs.length<0){this.iFocusedIndex=-1;return this}if(e<0){e=0}if(e>this.aItemDomRefs.length-1){e=this.aItemDomRefs.length-1}if(this.iFocusedIndex!==-1&&this.aItemDomRefs.length>this.iFocusedIndex){t(this.aItemDomRefs[this.iFocusedIndex]).attr("tabIndex",this.iTabIndex);i=t(this.aItemDomRefs[this.iFocusedIndex]);if(i.data("sap.INRoot")&&e!=this.iFocusedIndex){t(i.data("sap.INRoot").aItemDomRefs[i.data("sap.INRoot").iFocusedIndex]).attr("tabIndex",this.iTabIndex)}}this.iFocusedIndex=e;var s=this.aItemDomRefs[this.iFocusedIndex];i=t(this.aItemDomRefs[this.iFocusedIndex]);if(!i.data("sap.INRoot")){t(s).attr("tabIndex",this.iActiveTabIndex)}return this};a.prototype._callParent=function(t,i){if(typeof e.prototype[t]==="function"){e.prototype[t].apply(this,i)}};a.prototype._onF7=function(t){if(!s(this.oDomRef,t.target)){return}var e=this.getFocusedIndex();if(e>=0){this.focusItem(e,t);t.preventDefault();t.stopPropagation()}};a.prototype.onsapspace=function(t){this.onsapenter(t)};a.prototype.onsapenter=function(e){var i,s;if(this._skipNavigation(e,false,true)){return}s=t(this.getFocusedDomRef());i=s.attr("id");if(n(i,"-outline")){if(s.hasClass("sapSuiteUiCommonsTimelineGroupHeaderMainWrapper")){i=i.substr(0,i.length-"outline".length)+"groupCollapseIcon";s.find("#"+i).keyup()}else{s.find("div[role='toolbar']").children().first().mousedown().mouseup().click();this.fireEvent("Enter",{domRef:s.get(0)})}e.preventDefault();e.stopPropagation()}};a.prototype.onsaphome=function(t){if(this.aItemDomRefs.length===0){return}if(this._skipNavigation(t,false,false)){return}this._callParent("onsaphome",arguments)};a.prototype.onkeydown=function(t){this._callParent("onkeydown",arguments);if(t.keyCode===o.F7){this._onF7(t)}};a.prototype.onmousedown=function(e){var i=e.target;var o=function(e,i){var s=false;var o=t(e);while(!o.is(":sapFocusable")&&o.get(0)!=i){o=o.parent()}if(o.get(0)!=i){s=true}return s};if(s(this.oDomRef,i)){for(var n=0;n<this.aItemDomRefs.length;n++){var a=this.aItemDomRefs[n];if(s(a,i)){if(a===i||!o(i,a)){this.focusItem(n,e)}return}}this._bMouseDownHappened=true;setTimeout(function(){this._bMouseDownHappened=false}.bind(this),20)}};a.prototype.onsapnext=function(e){var i,s=true,n,a,r;if(!this._aRows){this._callParent("onsapnext",arguments);return}if(this._skipNavigation(e,true,false)){return}e.preventDefault();e.stopPropagation();if(this.getFocusedIndex()<0){return}n=this._findPosition(this.iFocusedIndex);if(n===null){throw new Error("TimelineNavigation cannot obtain a position of focused item and hance it cannot senect next.")}a=Object.assign({},n);do{if(e.keyCode===o.ARROW_DOWN){a.iY++;if(a.iY>=this._aRows.length){if(a.iX+1>=this._aRows[this._aRows.length-1].length){return}a.iY=0;a.iX++}}else{a.iX++;if(a.iX>=this._aRows[a.iY].length){if(a.iY+1>=this._aRows.length){return}a.iX=0;a.iY++}}if(a.iX===n.iX&&a.iY===n.iY){if(s){s=false}else{return}}r=this._aRows[a.iY][a.iX]}while(!r||!t(r).is(":sapFocusable"));i=this._findIndex(a);this.focusItem(i,e)};a.prototype.onsapprevious=function(e){var i,s=true,n,a,r;if(!this._aRows){this._callParent("onsapprevious",arguments);return}if(this._skipNavigation(e,true,false)){return}e.preventDefault();e.stopPropagation();if(this.getFocusedIndex()<0){return}n=this._findPosition(this.iFocusedIndex);if(n===null){throw new Error("TimelineNavigation cannot obtain a position of focused item and hance it cannot senect next.")}a=Object.assign({},n);do{if(e.keyCode===o.ARROW_UP){a.iY--;if(a.iY<0){if(a.iX<=0){return}a.iY=this._aRows.length-1;a.iX--}}else{a.iX--;if(a.iX<0){if(a.iY<=0){return}a.iX=this._aRows[a.iY].length-1;a.iY--}}if(a.iX===n.iX&&a.iY===n.iY){if(s){s=false}else{return}}r=this._aRows[a.iY][a.iX]}while(!r||!t(r).is(":sapFocusable"));i=this._findIndex(a);this.focusItem(i,e)};a.prototype._isInDomRefs=function(t){return this.aItemDomRefs.indexOf(t)>-1};a.prototype._isInTimeline=function(t){while(t){if(this._isInDomRefs(t)){return true}t=t.parentElement}return false};a.prototype._hasTabbableChildren=function(e){var i=t(e.closest(".sapSuiteUiCommonsTimelineItemOutline")).find(":sapTabbable");if(i&&i.index(e)>=0){if(i.index(e)==i.length-1){return false}else{return true}}else if(i.length==0){return false}else{return true}};a.prototype._isLastChildInTimeline=function(t){return this._isInTimeline(t.target)&&!this._hasTabbableChildren(t.target)};a.prototype.onsaptabnext=function(t){if(t.target.id&&this._isLastChildInTimeline(t)){if(t.target.closest(".sapSuiteUiCommonsTimelineItemOutline")){t.target.closest(".sapSuiteUiCommonsTimelineItemOutline").focus();t.preventDefault()}}};a.prototype.onsaptabprevious=function(e){if(this._isInDomRefs(e.target)){var i=t(e.target).find(":sapTabbable");if(this.aItemDomRefs.indexOf(e.target)==0){var s=this.oDomRef.id+"-before";t(window.document.getElementById(s)).focus();return}if(i.length){i[i.length-1].focus();e.preventDefault()}else{e.target.focus();e.preventDefault();return}}};a.prototype.onfocusin=function(e){if(this._isInTimeline(e.target)){this.oLastFocused=e.target}if(!e.relatedTarget||!this._isInTimeline(e.relatedTarget)){if(this._isInTimeline(e.target)&&this.oLastFocused&&this.oLastFocused!==e.target){t(this.oLastFocused).focus()}}};a.prototype._findPosition=function(t){var e,i,s=this.aItemDomRefs[t];for(i=0;i<this._aRows.length;i++){for(e=0;e<this._aRows[i].length;e++){if(s===this._aRows[i][e]){return{iX:e,iY:i}}}}return null};a.prototype._findIndex=function(t){var e=this._aRows[t.iY][t.iX],i;for(i=0;i<this.aItemDomRefs.length;i++){if(e===this.aItemDomRefs[i]){return i}}return null};a.prototype._skipNavigation=function(e,i,o){return!s(this.oDomRef,e.target)||this.getFocusedIndex()<0&&o||this.aItemDomRefs&&Array.prototype.indexOf.call(this.aItemDomRefs,e.target)===-1||t(this.oDomRef).data("sap.InNavArea")&&i};return a});