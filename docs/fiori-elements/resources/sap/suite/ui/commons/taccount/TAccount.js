sap.ui.define(["sap/suite/ui/commons/library","sap/ui/Device","sap/ui/core/Control","sap/ui/core/delegate/ItemNavigation","./TAccountGroup","./TAccountPanel","sap/ui/core/IconPool","sap/ui/core/Icon","sap/ui/core/InvisibleText","sap/base/security/encodeXML","./TAccountUtils","sap/suite/ui/commons/Utils","sap/ui/thirdparty/bignumber","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(t,e,i,o,n,s,a,r,p,u,c,d,l){"use strict";var g=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var m=Object.freeze({UP:"UP",DOWN:"DOWN",PREVIOUS:"PREVIOUS",NEXT:"NEXT"});var h=e.os.macintosh?"metaKey":"ctrlKey";var f=i.extend("sap.suite.ui.commons.taccount.TAccount",{metadata:{library:"sap.suite.ui.commons",properties:{measureOfUnit:{type:"string",group:"Misc",defaultValue:""},collapsed:{type:"boolean",group:"Misc",defaultValue:false},title:{type:"string",group:"Misc",defaultValue:null},subtitle:{type:"string",group:"Misc",defaultValue:null},orderBy:{type:"string",group:"Misc",defaultValue:""},opening:{type:"boolean",group:"Misc",defaultValue:false},openingDebit:{type:"any",group:"Misc",defaultValue:0},openingCredit:{type:"any",group:"Misc",defaultValue:0}},aggregations:{debit:{type:"sap.suite.ui.commons.taccount.TAccountItem",multiple:true,singularName:"debit"},credit:{type:"sap.suite.ui.commons.taccount.TAccountItem",multiple:true,singularName:"credit"}}},renderer:{apiVersion:2,render:function(t,e){var i=function(e,i){e.forEach(function(o,n){o._bIsDebit=i;o._index=n+1;o._indexSize=e.length;t.renderControl(o)})};var o=function(i){var o=e.getOrderBy();i.forEach(function(t){var e=t.getProperties();t._sOrderBy="";for(var i=0;i<e.length;i++){if(e[i].getKey().toLowerCase()===o.toLowerCase()){t._sOrderBy=e[i].getValue();break}}});i.sort(function(t,e){return new Date(t._sOrderBy)>=new Date(e._sOrderBy)?1:-1});e._setItemsAttrs(i);i.forEach(function(e){t.renderControl(e.addStyleClass(e._bIsDebit?"sapSuiteUiCommonsAccountItemLeft":"sapSuiteUiCommonsAccountItemRight"))})};var n=e._getPanel();var s=function(t){var i=t?e.getDebit():e.getCredit(),o=new l(t?e.getOpeningDebit():e.getOpeningCredit());i.forEach(function(t){o=o.plus(new l(t.getValue()))});return c.formatCurrency(o,e.getMeasureOfUnit(),n?n.getMaxFractionDigits():0)};var a=e.getMeasureOfUnit(),r=c.formatCurrency(e.getOpeningDebit(),a,n?n.getMaxFractionDigits():0),p=c.formatCurrency(e.getOpeningCredit(),a,n?n.getMaxFractionDigits():0),d=e.getDebit().length>0||e.getCredit().length>0;t.openStart("div",e);if(e.getCollapsed()){t.class("sapSuiteUiCommonsAccountCollapsed")}t.class("sapSuiteUiCommonsAccount");if(!d){t.class("sapSuiteUiCommonsAccountEmpty")}t.attr("role","region");t.attr("aria-describedby",e.getId());t.attr("aria-label",e._getAriaLabelText());t.attr("tabindex","0");t.openEnd();t.openStart("div").class("sapSuiteUiCommonsTAccountDropZoneTop").openEnd().close("div");t.openStart("div").class("sapSuiteUiCommonsTAccountDropZoneBottom").openEnd().close("div");t.openStart("div").class("sapSuiteUiCommonsTAccountInfoIconWrapper").class("sapSuiteUiCommonsTAccountBaseInfoIconWrapper").attr("aria-labelledby",e.getId()+"-mark-text").attr("title",g.getText("TACCOUNT_SELECTED")).openEnd();t.renderControl(e._getAriaMarkText());t.openStart("div").class("sapSuiteUiCommonsInfoIcon").openEnd();t.text("!");t.close("div");t.close("div");t.openStart("div").class("sapSuiteUiCommonsAccountHeader").openEnd();t.openStart("div").class("sapSuiteUiCommonsAccountHeaderFirst").openEnd();t.openStart("div").class("sapSuiteUiCommonsAccountHeaderExpandWrapper").openEnd();t.renderControl(e._getDownArrow());t.close("div");var m=u(e.getTitle()).replace(/&#xa;|\n/g,"<br>");if(e.getSubtitle()){var h=u(e.getSubtitle()).replace(/&#xa;|\n/g,"<br>");t.openStart("div").class("sapSuiteUiCommonsAccountHeaderTitleWrapper").openEnd();t.openStart("div").class("sapSuiteUiCommonsAccountHeaderTitleWithSubtitle").attr("id",e.getId()+"-title").openEnd().unsafeHtml(m).close("div");t.openStart("div").class("sapSuiteUiCommonsAccountHeaderSubtitle").openEnd().unsafeHtml(h).close("div");t.close("div")}else{t.openStart("span").attr("id",e.getId()+"-title").class("sapSuiteUiCommonsAccountHeaderTitle").openEnd().unsafeHtml(m).close("span")}t.close("div");t.openStart("div").class("sapSuiteUiCommonsAccountHeaderSecond").openEnd();t.openStart("span").attr("id",e.getId()+"-sum").class("sapSuiteUiCommonsAccountHeaderSUM").openEnd().text(e._getSumText()).close("span");t.close("div");t.close("div");t.openStart("div").attr("id",e.getId()+"-content").class("sapSuiteUiCommonsAccountTWrapper");if(e.getCollapsed()){t.style("display","none")}t.openEnd();if(d||e.getOpening()){t.openStart("div");t.class("sapSuiteUiCommonsAccountTHeader");if(e.getOpening()){t.class("sapSuiteUiCommonsAccountTHeaderOpening")}t.openEnd();t.openStart("span").attr("id",e.getId()+"-debit-text").class("sapSuiteUiCommonsAccountTHeaderTitle").openEnd().text(g.getText("TACCOUNT_DEBIT")).close("span");t.openStart("span").attr("id",e.getId()+"-credit-text").class("sapSuiteUiCommonsAccountTHeaderTitle").openEnd().text(g.getText("TACCOUNT_CREDIT")).close("span");t.close("div");if(d){if(e.getOpening()){t.openStart("div").class("sapSuiteUiCommonsAccountOpeningHeader").openEnd();t.openStart("span").attr("id",e.getId()+"-opening-debit-text").class("sapSuiteUiCommonsAccountTHeaderOpeningDebitTitle").openEnd().text(r+" "+a).close("span");t.openStart("span").attr("id",e.getId()+"-opening-credit-text").class("sapSuiteUiCommonsAccountTHeaderOpeningCreditTitle").openEnd().text(p+" "+a).close("span");t.close("div")}t.openStart("div").class("sapSuiteUiCommonsAccountTBody").attr("role","listbox").openEnd();if(e._isOrdered()){t.openStart("div").class("sapSuiteUiCommonsAccountDebitCredit").attr("role","listbox").attr("aria-labelledby",e.getId()+"-debit-text "+e.getId()+"-credit-text").openEnd();t.openStart("div").class("sapSuiteUiCommonsAccountMiddleBorder").openEnd().close("div");o(e.getDebit().concat(e.getCredit()))}else{t.openStart("div").class("sapSuiteUiCommonsAccountDebit").attr("role","listbox").attr("aria-labelledby",e.getId()+"-debit-text").openEnd();i(e.getDebit(),true)}t.close("div");if(!e._isOrdered()){t.openStart("div").class("sapSuiteUiCommonsAccountCredit").attr("role","listbox").attr("aria-labelledby",e.getId()+"-credit-text").openEnd();i(e.getCredit(),false);t.close("div")}t.close("div")}}else{t.openStart("div").class("sapSuiteUiCommonsAccountNoData").openEnd();t.text(g.getText("TACCOUNT_NO_DATA"));t.close("div")}if(e.getOpening()){t.openStart("div").class("sapSuiteUiCommonsAccountClosingHeaderLine").openEnd().close("div");t.openStart("div").class("sapSuiteUiCommonsAccountClosingHeader").openEnd();t.openStart("span").attr("id",e.getId()+"-closing-debit-text").class("sapSuiteUiCommonsAccountTHeaderOpeningDebitTitle").openEnd().text(s(true)+" "+a).close("span");t.openStart("span").attr("id",e.getId()+"-closing-credit-text").class("sapSuiteUiCommonsAccountTHeaderOpeningCreditTitle").openEnd().text(s(false)+" "+a).close("span");t.close("div")}t.close("div");t.close("div")}}});f.prototype.onBeforeRendering=function(){this._bRendered=false;this._iOldSum=this._iSum;this._iSum=null};f.prototype.onAfterRendering=function(){var t=this.getParent();this._bRendered=true;this._setupDraggable();this._setupKeyboard();if(t&&this._hasGroupParent(t)){if(!t._bRendered){t.addEventDelegate({onAfterRendering:this._setupTooltips.bind(this)})}if(t._bRendered&&this._iOldSum!=null){var e=this._iSum-this._iOldSum;t._valueChanged(e)}}else{this._setupTooltips()}this.$().find(".sapSuiteUiCommonsAccountGroupCollapseIcon").attr("aria-pressed",!this.getCollapsed())};f.prototype.onsapdownmodifiers=function(t){if(t[h]){this._handleArrowMoveEvent(t,m.DOWN)}};f.prototype.onsapupmodifiers=function(t){if(t[h]){this._handleArrowMoveEvent(t,m.UP)}};f.prototype.onsappreviousmodifiers=function(t){if(t[h]){this._handleArrowMoveEvent(t,m.PREVIOUS)}};f.prototype.onsapnextmodifiers=function(t){if(t[h]){this._handleArrowMoveEvent(t,m.NEXT)}};f.prototype.reset=function(){this._oSum=null};f.prototype._isOrdered=function(){return!!this.getOrderBy()};f.prototype._setupKeyboard=function(){if(!this._oItemNavigation){this._oItemNavigation=new o;this.addDelegate(this._oItemNavigation)}this._oItemNavigation.setRootDomRef(this.$().find(".sapSuiteUiCommonsAccountTBody")[0]);this._oItemNavigation.setItemDomRefs(this.$().find(".sapSuiteUiCommonsAccountItem"));this._oItemNavigation.setCycling(true)};f.prototype._isInGroup=function(){return this.getParent()instanceof n};f.prototype._getPanel=function(){if(this._isInGroup()){var t=this.getParent().getParent();if(t instanceof s){return t}}return null};f.prototype._setupDraggable=function(){if(this._isInGroup()){var t=this.$(),e=this.getParent();t.draggable({revert:"invalid",delay:100,helper:function(){return t.clone().width(t.width()).css("z-index",500)},opacity:.6,scope:e.getId()+"-content",handle:".sapSuiteUiCommonsAccountHeader",start:function(){t.addClass("sapSuiteUiCommonsAccountItemDragging");e.$().find(".sapSuiteUiCommonsAccountGroupDroppingArea").addClass("sapSuiteUiCommonsAccountGroupDroppingAreaHighlight");e.$().find(".sapSuiteUiCommonsAccountHeader").css("cursor","grabbing")},stop:function(){t.removeClass("sapSuiteUiCommonsAccountItemDragging");e.$().find(".sapSuiteUiCommonsAccountGroupDroppingArea").removeClass("sapSuiteUiCommonsAccountGroupDroppingAreaHighlight");e.$().find(".sapSuiteUiCommonsAccountHeader").css("cursor","grab")}});d._setupMobileDraggable(t)}};f.prototype._setItemsAttrs=function(t){t.forEach(function(e,i){e._index=i+1;e._indexSize=t.length});this.getDebit().forEach(function(t){t._bIsDebit=true})};f.prototype._getExpandAltText=function(t){return(t?g.getText("TACCOUNT_COLLAPSE"):g.getText("TACCOUNT_EXPAND"))+(" "+g.getText("TACCOUNT_TITLE"))};f.prototype._getDownArrow=function(){var t=this.getCollapsed();if(!this._oArrowDown){this._oArrowDown=new r({alt:this._getExpandAltText(!t),tooltip:this._getExpandAltText(!t),decorative:false,src:t?"sap-icon://navigation-right-arrow":"sap-icon://navigation-down-arrow",press:function(){this.setCollapsed(!this.getCollapsed())}.bind(this)}).addStyleClass("sapSuiteUiCommonsAccountGroupCollapseIcon")}this._oArrowDown.$().attr("aria-pressed",!this.getCollapsed());return this._oArrowDown};f.prototype._getAriaMarkText=function(){if(!this._oMarkText){this._oMarkText=new p({id:this.getId()+"-mark-text",text:g.getText("TACCOUNT_SELECTED")});this.addDependent(this._oMarkText)}return this._oMarkText};f.prototype._getSum=function(){if(this._iSum==null){var t=new l("0");this.getCredit().forEach(function(e){t=t.plus(new l(e.getValue()))});this.getDebit().forEach(function(e){t=t.minus(new l(e.getValue()))});if(this.getOpening()){t=t.plus(new l(this.getOpeningCredit()));t=t.minus(new l(this.getOpeningDebit()))}this._iSum=t}return this._iSum};f.prototype._getAriaLabelText=function(){return this.getTitle()+" "+this.getSubtitle()+" "+this._getSumText()+" "+g.getText("TACCOUNT_NAVIGATION")};f.prototype._getSumText=function(){var t=this.getMeasureOfUnit();var e=this._getSum();e=e.isLessThan(0)?e.times(-1):e;var i=this._getPanel();var o=c.formatCurrency(e,t,i?i.getMaxFractionDigits():0);return(this._getSum().isGreaterThan(0)?g.getText("TACCOUNT_CREDIT"):g.getText("TACCOUNT_DEBIT"))+": "+o+" "+u(t)};f.prototype._valueChanged=function(t,e){if(this._bRendered){if(e){this._iSum=this._getSum().minus(t)}else{this._iSum=this._getSum().plus(t)}this.$("sum").text(this._getSumText());var i=this.getParent();if(this._hasGroupParent(i)){i._valueChanged(t,e)}}};f.prototype._hasGroupParent=function(t){return(t||this.getParent())instanceof n};f.prototype._handleArrowMoveEvent=function(t,e){this._moveTAccount(e);t.preventDefault();t.stopImmediatePropagation()};f.prototype._moveTAccount=function(t){var e,i,o,n,s=t===m.UP,a=true,r=this.$();var p=function(t){if(o.length===0){a=false;return}r.detach();e.detach();o[t](r);o[t](e)};if(s||t===m.DOWN){n=s?["next","prev","insertBefore","append"]:["prev","next","insertAfter","prepend"];e=r[n[0]](".sapSuiteUiCommonsAccountGroupDroppingArea");i=r[n[1]]()[n[1]](".sapSuiteUiCommonsAccount");if(i.length!==0){r.detach()[n[2]](i);e.detach()[n[2]](i)}else{o=r.parent()[n[1]](".sapSuiteUiCommonsAccountGroupColumn");p(n[3])}}else{e=r.prev(".sapSuiteUiCommonsAccountGroupDroppingArea");o=r.parent()[t===m.NEXT?"next":"prev"](".sapSuiteUiCommonsAccountGroupColumn");p("append")}if(a){r.focus()}};f.prototype._setControlKeyName=function(t){h=t};f.prototype._setupTooltips=function(){var t=function(t){var e=this.$().find(t);if(e[0]&&e[0].clientHeight<e[0].scrollHeight){e.attr("title",e.html())}}.bind(this);if(this.getSubtitle()){t(".sapSuiteUiCommonsAccountHeaderTitleWithSubtitle");t(".sapSuiteUiCommonsAccountHeaderSubtitle")}else{t(".sapSuiteUiCommonsAccountHeaderTitle")}};f.prototype.updateBindingContext=function(){this.reset();return i.prototype.updateBindingContext.apply(this,arguments)};f.prototype.setMeasureOfUnit=function(t){this.setProperty("measureOfUnit",t,true);if(this._bRendered){this.$("sum").text(this._getSumText());var e=this.getParent();if(this._hasGroupParent(e)){e._measureChanged(t)}}this.invalidate();return this};f.prototype.invalidate=function(){this._bRendered=false;i.prototype.invalidate.apply(this,arguments)};f.prototype.setCollapsed=function(t){this.setProperty("collapsed",t);var e=this._getExpandAltText(!t);this._getDownArrow().setTooltip(e);this._getDownArrow().setAlt(e);this._getDownArrow().setSrc(!t?"sap-icon://navigation-down-arrow":"sap-icon://navigation-right-arrow");this.$()[t?"addClass":"removeClass"]("sapSuiteUiCommonsAccountCollapsed");this.$().find(".sapSuiteUiCommonsAccountGroupCollapseIcon").attr("aria-pressed",!t);if(this.getDomRef()){this.$("content")[t?"hide":"show"]("medium")}return this};return f});