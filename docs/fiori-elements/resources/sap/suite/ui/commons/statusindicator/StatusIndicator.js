/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["../library","sap/m/library","sap/ui/core/Control","sap/ui/core/Core","sap/suite/ui/commons/statusindicator/util/AnimationPropertiesResolver","sap/suite/ui/commons/statusindicator/util/ThemingUtil","sap/m/Text","sap/base/Log","./StatusIndicatorRenderer"],function(e,t,r,o,s,i,a,u,n){"use strict";var l=e.statusindicator.SizeType;var h=e.statusindicator.LabelPositionType;var p=t.ValueColor;var d=r.extend("sap.suite.ui.commons.statusindicator.StatusIndicator",{metadata:{library:"sap.suite.ui.commons",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension"},height:{type:"sap.ui.core.CSSSize",group:"Dimension"},value:{type:"int",defaultValue:0},viewBox:{type:"string",defaultValue:null},ariaLabel:{type:"string",defaultValue:null},size:{type:"sap.suite.ui.commons.statusindicator.SizeType",defaultValue:l.None},labelPosition:{type:"sap.suite.ui.commons.statusindicator.LabelPositionType",defaultValue:h.Left},showLabel:{type:"boolean",defaultValue:false}},defaultAggregation:"groups",aggregations:{groups:{type:"sap.suite.ui.commons.statusindicator.ShapeGroup",multiple:true},propertyThresholds:{type:"sap.suite.ui.commons.statusindicator.PropertyThreshold",multiple:true},discreteThresholds:{type:"sap.suite.ui.commons.statusindicator.DiscreteThreshold",multiple:true},label:{type:"sap.m.Text",multiple:false}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{press:{}}}});d.prototype.init=function(){if(r.prototype.init){r.prototype.init.apply(this,arguments)}this._sortedPropertyThresholds=[];this._sortedDiscreteThresholds=[];this._bStarted=false;this._oCurrentAnimationPromise=null;this._oAnimationPropertiesResolver=new s(this);this._oDefaultLabel=null;if(!sap.ui.getCore().isInitialized()){sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this))}else{this._handleCoreInitialized()}};d.prototype._handleCoreInitialized=function(){sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this)};d.prototype._handleThemeApplied=function(){this.invalidate()};d.prototype._internalIds=Object.freeze({svgNodeId:"svg"});d.prototype.getLabel=function(){var e=this.getAggregation("label");if(e!==null){return e}if(this._oDefaultLabel!==null){return this._oDefaultLabel}this._oDefaultLabel=new a(this.getId()+"-label");this.addDependent(this._oDefaultLabel);return this._oDefaultLabel};d.prototype.addPropertyThreshold=function(e){this.addAggregation("propertyThresholds",e,true);if(this._sortedPropertyThresholds.filter(function(t){return t.getToValue()===e.getToValue()}).length>0){u.fatal("There are two or more property thresholds with the same toValue in thresholds "+"aggregation. The last threshold from them has the highest priority")}this._sortedPropertyThresholds.push(e);this._sortedPropertyThresholds.sort(function(e,t){return e.getToValue()-t.getToValue()});return this};d.prototype.addDiscreteThreshold=function(e){this.addAggregation("discreteThresholds",e,true);if(this._sortedDiscreteThresholds.filter(function(t){return t.getValue()===e.getValue()}).length>0){u.fatal("There are two or more discrete thresholds with the same value in thresholds "+"aggregation. The last threshold from them has the highest priority")}this._sortedDiscreteThresholds.push(e);this._sortedDiscreteThresholds.sort(function(e,t){return e.getValue()-t.getValue()});return this};d.prototype._discreteThresholdsEnabled=function(){return this._sortedDiscreteThresholds.length>0};d.prototype._getDiscreteThresholdForValue=function(e){var t=null;this._sortedDiscreteThresholds.every(function(r){if(e>=r.getValue()){t=r;return true}return false});return t};d.prototype._propertyThresholdsEnabled=function(){return this._sortedPropertyThresholds.length>0};d.prototype._getPropertyThresholdForValue=function(e){var t=null;this._sortedPropertyThresholds.some(function(r){if(e<=r.getToValue()){t=r;return true}return false});return t};d.prototype._getFullId=function(e){return this.getId()+"-"+e};d.prototype.onBeforeRendering=function(){var e=this;this.getGroups().forEach(function(t){t._injectAnimationPropertiesResolver(e._oAnimationPropertiesResolver)})};d.prototype.onAfterRendering=function(){this._setValueToLabel(this.getValue());this._start()};d.prototype._start=function(){this._bStarted=true;this._propagateValueToGroups()};d.prototype._shouldInvertGroupUpdateOrder=function(e){var t;e.some(function(e,r){t=r;return e.newValue!==100});var r;this.getGroups().some(function(e,t){r=t;return!e._showsFullProgress()});return t<r};d.prototype._propagateValueToGroups=function(){var e=this.getSize()===l.Small;var t=this._computeGroupValueDistribution();var r=this._shouldInvertGroupUpdateOrder(t);if(r){t=t.reverse()}this._updateAccessibilityDOM();this._oCurrentAnimationPromise=t.reduce(function(t,r){return t.then(function(t){if(t&&t.cancelled){u.debug("Group animation cancelled.");return t}else{return r.group._setValue(r.newValue,e)}})},Promise.resolve());return this._oCurrentAnimationPromise};d.prototype._computeGroupValueDistribution=function(){var e=this.getValue();var t=this._getTotalWeight();return this.getGroups().map(function(r){var o=r.getWeight()/t;var s;if(e===0){s=0}else if(e>=100*o){s=100}else{s=e/o}e-=s*o;return{group:r,newValue:Number(s.toFixed(3))}})};d.prototype.setValue=function(e){e=Math.round(e);if(e>100){e=100}if(e<0){e=0}this.setProperty("value",e,true);this._setValueToLabel(e);if(this._bStarted){this._propagateValueToGroups()}return this};d.prototype._setValueToLabel=function(e){var t=this.getLabel();var r;t.setText(Math.floor(e)+"%");r=i.resolveColor(p.Neutral);if(this._propertyThresholdsEnabled()){var o=this._getPropertyThresholdForValue(e);if(o){r=o._getCssFillColor()}}var s=t.$();if(s){s.css("color",r)}};d.prototype._getTotalWeight=function(){return this.getGroups().reduce(function(e,t){return e+t.getWeight()},0)};d.prototype.ontap=d.prototype.firePress;d.prototype.onsapenter=d.prototype.firePress;d.prototype.onsapspace=d.prototype.firePress;d.prototype._getGroupShapes=function(){return this.getGroups().reduce(function(e,t){return e.concat(t.getShapes())},[])};d.prototype._updateAccessibilityDOM=function(){var e=this.getValue();this.$().attr("aria-valuenow",e);this.$().attr("aria-valuetext",this._createValueTextMessage(e))};d.prototype._createValueTextMessage=function(e){var t=null;var r=null;var o=null;var s=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");if(this._discreteThresholdsEnabled()){var i=this._getDiscreteThresholdForValue(e);if(i){t=i.getAriaLabel();r=true}else{t=this._sortedDiscreteThresholds[0].getAriaLabel();r=false}}if(this._propertyThresholdsEnabled()){var a=this._getPropertyThresholdForValue(e);if(a){o=a.getAriaLabel()}}var u;if(t){if(o){if(r){u=s.getText("STATUS_INDICATOR_VALUE_ABOVE_THRESHOLD_COLOR",[e,t,o])}else{u=s.getText("STATUS_INDICATOR_VALUE_BELOW_THRESHOLD_COLOR",[e,t,o])}}else{if(r){u=s.getText("STATUS_INDICATOR_VALUE_ABOVE_THRESHOLD",[e,t])}else{u=s.getText("STATUS_INDICATOR_VALUE_BELOW_THRESHOLD",[e,t])}}}else if(o){u=s.getText("STATUS_INDICATOR_VALUE_COLOR",[e,o])}else{u=s.getText("STATUS_INDICATOR_VALUE",[e])}return u};return d});