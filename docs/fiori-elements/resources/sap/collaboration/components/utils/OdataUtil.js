/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/security/encodeURL","sap/base/util/each","./CommonUtil","sap/ui/base/Object"],function(t,a,e,n,o){"use strict";var r=o.extend("sap.collaboration.components.utils.OdataUtil",{OdataUtilConstants:{HttpStatusCode:{success:200,created:201},EndPoint:{AssignedGroups:"AssignedGroups",BusinessObjects:"BusinessObjects",ContentItems:"ContentItems",PostContentItem:"PostContentItem",Feed:"Feed",Folders:"Folders",GetCollaborationHostUrl:"GetCollaborationHostURL",MapInternalBOToExternalBO:"MapInternalBOToExternalBO",GetExternalODataURL:"GetExternalODataURL",GetSingleUseToken:"GetSingleUseToken",Groups:"Groups",GroupsCount:"Groups/$count",GetNotificationUnreadCount:"GetNoticeUnreadCount",Notifications:"Notices",FeaturedExternalObjects:"FeaturedExternalObjects",GroupsAsFeatured:"GroupsAsFeatured",ExternalObjects:"ExternalObjects",Activities:"Activities",ExternalObjects_FindByExidAndObjectType:"ExternalObjects_FindByExidAndObjectType"},HttpMethod:{GET:"GET",POST:"POST"},ResponseType:{blob:"blob",arraybuffer:"arraybuffer"}},constructor:function(){this.oCommonUtil=new n;this.bError=false},getJamUrl:function(a,e,n){var o="";var r="";var s=function(t,a){if(e){e.resolve(t.GetCollaborationHostURL.URL)}else{r=t.GetCollaborationHostURL.URL}};var i=function(a){t.error(JSON.stringify(a));o=a.response.statusCode;if(e){e.reject(o)}};a.read("/"+this.OdataUtilConstants.EndPoint.GetCollaborationHostUrl,{success:s,error:i,async:n});if(!e){return r}},createJamUrlBatchOperation:function(a){var e=null;var n=null;var o;try{o=a.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetCollaborationHostUrl,this.OdataUtilConstants.HttpMethod.GET,e,n)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createJamUrlBatchOperation()");throw a}return o},getJamToken:function(a){var e="";var n="";var o=function(t,a){e=t.GetSingleUseToken.Id};var r=function(a){t.error(JSON.stringify(a));n=a.response.statusCode};a.read("/"+this.OdataUtilConstants.EndPoint.GetSingleUseToken,null,null,false,o,r);if(n){throw new Error(n)}return e},createJamTokenBatchOperation:function(a){var e=null;var n=null;var o;try{o=a.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetSingleUseToken,this.OdataUtilConstants.HttpMethod.GET,e,n)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createJamTokenBatchOperation()");throw a}return o},getGroupsData:function(a,e){var n;var o="";var r=function(t,a){n=this.oCommonUtil.getODataResult(t)}.bind(this);var s=function(a){t.error(JSON.stringify(a));o=a.response.statusCode};a.read(e,null,null,false,r,s);if(o){throw new Error(o)}return n},createGetGroupsDataBatchOperation:function(a){var e=null;var n=null;var o;try{o=a.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.Groups,this.OdataUtilConstants.HttpMethod.GET,e,n)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createGetGroupsDataBatchOperation()");throw a}return o},createGetGroupsCountBatchOperation:function(a){var e=null;var n=null;var o;try{o=a.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GroupsCount,this.OdataUtilConstants.HttpMethod.GET,e,n)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createGetGroupsCountDataBatchOperation()");throw a}return o},createGetGroupsLinkedToBOBatchOperation:function(t,e){var n=null;var o=null;var r;var s="/"+this.OdataUtilConstants.EndPoint.ExternalObjects+"(ApplicationContext='"+a(e.appContext.replace(/'/g,"''"))+"',"+"OdataServicePath='"+a(e.odataServicePath.replace(/'/g,"''"))+"',"+"OdataCollection='"+a(e.collection.replace(/'/g,"''"))+"',"+"OdataKey='"+a(e.key.replace(/'/g,"''"))+"')/"+this.OdataUtilConstants.EndPoint.GroupsAsFeatured;r=t.createBatchOperation(s,this.OdataUtilConstants.HttpMethod.GET,n,o);return r},createGetObjectGroupsBatchOperation:function(e,n){var o=null;var r=null;var s;try{s=e.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.BusinessObjects+"('"+a(n)+"')/"+this.OdataUtilConstants.EndPoint.AssignedGroups,this.OdataUtilConstants.HttpMethod.GET,o,r)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createGetObjectGroupsBatchOperation()");throw a}return s},getGroupIds:function(t){var a="";for(var e=0;e<t.length;e++){if(e==0){a+=t[e].Id}else{a+=","+t[e].Id}}return a},createGroupFeed:function(e,n,o){var r="/"+this.OdataUtilConstants.EndPoint.Groups+"("+a(n)+")/"+this.OdataUtilConstants.EndPoint.Feed;var s={Text:o};var i=undefined;var l=function(){i=true};var c=function(a){t.error(JSON.stringify(a.response.body));i=false};e.create(r,s,null,l,c);return i},executeODataBatchRequest:function(a,e,n,o,r){var s=this;var i;var l=function(t){i=s.parseBatchResponse(t.__batchResponses);n(i)};var c=function(a){if(a.response){t.error(JSON.stringify(a.response.body))}else{t.error(JSON.stringify(a.message))}r(a)};var u=[];var d=[];for(var p in e){if(e[p].method==this.OdataUtilConstants.HttpMethod.GET){u.push(e[p])}else if(e[p].method==this.OdataUtilConstants.HttpMethod.POST){d.push(e[p])}}if(u.length>0){a.addBatchReadOperations(u)}for(var p=0;p<d.length;p++){a.addBatchChangeOperations([d[p]])}if(o===true){a.submitBatch(l,c,true)}else{a.submitBatch(l,c,false)}},parseBatchResponse:function(a){var n=this;var o=[];e(a,function(a,e){if(e.statusCode&&e.statusCode.match(n.OdataUtilConstants.HttpStatusCode.success)){o.push(e.data)}else if(e.__changeResponses){for(var a=0;a<e.__changeResponses.length;a++){if(e.__changeResponses[a].statusCode&&(e.__changeResponses[a].statusCode.match(n.OdataUtilConstants.HttpStatusCode.created)||e.__changeResponses[a].statusCode.match(n.OdataUtilConstants.HttpStatusCode.success))){o.push(e.__changeResponses[a].data)}else{o.push({error:e.__changeResponses[a].response.body});t.error(JSON.stringify(e.__changeResponses[a].response.body),"sap.collaboration.components.utils.OdataUtil.parseBatchResponse()")}}}else{o.push({error:e.response.body});t.error(JSON.stringify(e.response.body),"sap.collaboration.components.utils.OdataUtil.parseBatchResponse()")}});return o},createExternalOdataUrlBatchOperation:function(e,n){var o=null;var r=null;var s;try{s=e.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetExternalODataURL+"/?RelativePath='"+a(n)+"'",this.OdataUtilConstants.HttpMethod.GET,r,o)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createExternalOdataUrlBatchOperation()");throw a}return s},getExternalOdataUrl:function(a,e){var n="";var o="";var r={};r["RelativePath"]="'"+e+"'";var s=function(t,a){n=t.GetExternalODataURL.URL};var i=function(a){t.error(JSON.stringify(a));o=a.response.statusCode};a.read("/"+this.OdataUtilConstants.EndPoint.GetExternalODataURL,null,r,false,s,i);if(o){throw new Error(o)}return n},createNotificationUnreadCountBatchOperation:function(a){var e=null;var n=null;var o;try{o=a.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetNotificationUnreadCount,this.OdataUtilConstants.HttpMethod.GET,e,n)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createNotificationUnreadCountBatchOperation()");throw a}return o},createNotificationBatchOperation:function(e,n){var o=null;var r=null;var s;try{s=e.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.Notifications+"?$top="+a(n.toString()),this.OdataUtilConstants.HttpMethod.GET,o,r)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createNotificationBatchOperation()");throw a}return s},createGroupFeedBatchOperation:function(e,n,o){var r="/"+this.OdataUtilConstants.EndPoint.Groups+"("+a(n)+")/"+this.OdataUtilConstants.EndPoint.Feed;var s={Text:o.note,UiUrl:o.uiUrl};var i=null;var l;try{l=e.createBatchOperation(r,this.OdataUtilConstants.HttpMethod.POST,s,i)}catch(a){t.error(a,"","sap.collaboration.components.utils.OdataUtil.createGroupFeedBatchOperation()");throw a}return l},createUploadFileBatchOperation:function(t,e,n,o){var r=null;var s=null;var i;i=t.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.PostContentItem+"/?name='"+a(e.name)+"'&"+"groupId='"+a(n)+"'&"+"mimeType='"+a(e.mimeType)+"'&"+"folderId='"+a(o)+"'&"+"url='"+a(e.url)+"'",this.OdataUtilConstants.HttpMethod.POST,r,s);return i},uploadFile:function(a,e,n,o,r,s,i){var l=this.OdataUtilConstants.EndPoint.PostContentItem;var c=function(){r()};var u=function(){t.error(e.name+" was not uploaded","","sap.collaboration.components.utils.OdataUtil.uploadFile()");s()};a.callFunction(l,"POST",{name:e.name,groupId:n,mimeType:e.mimeType,url:e.url,folderId:o},null,c,u,i)},getSubFolders:function(e,n,o,r,s){var i;if(!o&&n){i="/"+this.OdataUtilConstants.EndPoint.Groups+"('"+a(n)+"')/"+this.OdataUtilConstants.EndPoint.Folders}else{i="/"+this.OdataUtilConstants.EndPoint.Folders+"(Id='"+a(o)+"',FolderType='Folder')/"+this.OdataUtilConstants.EndPoint.Folders}i=i+"?$skip="+r+"&$top="+s+"&$inlinecount=allpages";var l=[];var c=0;var u="";var d=function(t,a){if(t){l=this.oCommonUtil.getODataResult(t);c=parseInt(JSON.parse(a.body).d.__count)}}.bind(this);var p=function(a){t.error(JSON.stringify(a));u=a.response.statusCode};e.read(i,null,null,false,d,p);if(u){throw new Error(u)}return{folders:l,count:c}},createShareFeaturedObjectBatchOperation:function(t,e,n){var o="/"+this.OdataUtilConstants.EndPoint.Groups+"("+a(n)+")/"+this.OdataUtilConstants.EndPoint.FeaturedExternalObjects;var r={ApplicationContext:e.appContext,OdataServicePath:e.odataServicePath,OdataCollection:e.collection,OdataKey:e.key,Name:e.name,Summary:e.summary,UiUrl:e.uiUrl,Comment:e.note};var s=null;var i;i=t.createBatchOperation(o,this.OdataUtilConstants.HttpMethod.POST,r,s);return i},getExternalObjectMapping:function(a,e,n){var o="/"+this.OdataUtilConstants.EndPoint.MapInternalBOToExternalBO;var r={};r["ApplicationContext"]="'"+e.appContext+"'";r["ODataCollection"]="'"+e.collection+"'";r["ODataKeyPredicate"]="'"+e.key+"'";r["ODataServicePath"]="'"+e.odataServicePath+"'";var s="";var i=function(t,a){n.resolve(t.MapInternalBOToExternalBO)};var l=function(a){t.error(JSON.stringify(a));s=a.response.statusCode;n.reject(s)};a.read(o,null,r,true,i,l)},_GetJamExternalObject:function(e,n,o,r,s){var i="/"+this.OdataUtilConstants.EndPoint.ExternalObjects_FindByExidAndObjectType+"/?Exid='"+a(n)+"'&"+"ObjectType='"+a(o);var l=function(){r()};var c=function(a){t.error(JSON.stringify(a.response.body));s()};e.read(i,null,null,false,l,c)}});return r});