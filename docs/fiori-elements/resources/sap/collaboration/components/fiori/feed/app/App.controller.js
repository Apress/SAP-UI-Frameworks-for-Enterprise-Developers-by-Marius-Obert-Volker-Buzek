/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/Controller","sap/collaboration/components/utils/OdataUtil","sap/collaboration/components/utils/CommonUtil","sap/ui/core/mvc/View","sap/ui/core/library","sap/collaboration/library"],function(t,e,a,o,s,i,r){"use strict";var n=r.FeedType;var p=i.mvc.ViewType;sap.ui.controller("sap.collaboration.components.fiori.feed.app.App",{onInit:function(){this.oApp=this.getView().oApp;this.oOdataModel=this.getView().getViewData().odataModel;this.oLangBundle=this.getView().getViewData().langBundle;this.sPrefixId=this.getView().getViewData().controlId;this.sAppType=this.getView().getViewData().appType;this.sFeedType=this.getView().getViewData().feedType;this.sGroupIds=this.getView().getViewData().groupIds;this.oBusinessObject=this.getView().getViewData().object},onBeforeRendering:function(){try{this.initializeUtils();this.createDetailPage()}catch(e){t.error(e,"","sap.collaboration.components.fiori.feed.app.App.controller.onBeforeRendering()");this.oCommonUtil.displayError()}},initializeUtils:function(){if(!this.oODataUtil){this.oODataUtil=new a}if(!this.oCommonUtil){this.oCommonUtil=this.oCommonUtil=new o}},createDetailPage:function(){try{var e=this.sPrefixId+"detailView";if(!this.oApp.getPage(e)){this.initOData();var a=sap.ui.view({id:e,viewData:{controlId:this.sPrefixId,jamURL:this.sJamUrl,jamToken:this.sJamToken,appType:this.sAppType,feedType:this.sFeedType,groupIds:this.sGroupIds,object:this.oBusinessObject,langBundle:this.oLangBundle},type:p.JS,viewName:"sap.collaboration.components.fiori.feed.commons.Detail"});this.oApp.addPage(a);this.oApp.setInitialPage(a)}}catch(e){t.error(e,"","sap.collaboration.components.fiori.feed.app.App.controller.createDetailPage()");throw e}},getGroupIds:function(){var t;if(this.sFeedType===n.group&&(this.sGroupIds===undefined||this.sGroupIds==="")){t=this.oODataUtil.getGroupsData(this.oOdataModel,"/Groups");this.sGroupIds=this.oODataUtil.getGroupIds(t)}else if(this.sFeedType===n.objectGroup&&(this.sGroupIds===undefined||this.sGroupIds==="")){t=this.oODataUtil.getGroupsData(this.oOdataModel,"/BusinessObjects('"+this.oBusinessObject.id+"')/AssignedGroups");this.sGroupIds=this.oODataUtil.getGroupIds(t)}else if(this.sFeedType===n.objectGroup&&!(this.sGroupIds===undefined||this.sGroupIds==="")){t=this.oODataUtil.getGroupsData(this.oOdataModel,"/BusinessObjects('"+this.oBusinessObject.id+"')/AssignedGroups");var e=this.oODataUtil.getGroupIds(t);this.sGroupIds=this.filterGroupIds(e)}},filterGroupIds:function(t){var e;var a=t.split(",");var o=this.sGroupIds.split(",");for(var s=0;s<o.length;s++){if(a.indexOf(o[s])===-1){o.splice(s,1);s=s-1}}if(o.length!==0){e=o.join()}else{e=""}return e},initOData:function(){var e=this;var a=[];var o=false;var s=function(t){e.parseBatchResults(t)};var i=function(e){t.error(e,"","sap.collaboration.components.fiori.feed.dialog.Component.initOdata(), fnBatchErrorCallback()");throw e};try{a=this.createBatchRequests();this.oODataUtil.executeODataBatchRequest(this.oOdataModel,a,s,o,i)}catch(e){t.error(e,"","sap.collaboration.components.fiori.feed.app.App.controller.initOdata()");throw e}},createBatchRequests:function(){var e=this;var a=[];try{if(!e.sJamUrl){a.push(e.oODataUtil.createJamUrlBatchOperation(e.oOdataModel))}a.push(e.oODataUtil.createJamTokenBatchOperation(e.oOdataModel));switch(e.sFeedType){case n.object:a=a.concat(e.createExternalUrlBatchRequest(e.oODataUtil,e.oBusinessObject));break;case n.group:a.push(e.oODataUtil.createGetGroupsDataBatchOperation(e.oOdataModel));break;case n.objectGroup:a.push(e.createObjectGroupBatchRequest(e.oODataUtil,e.oBusinessObject));break}}catch(e){t.error(e,"","sap.collaboration.components.fiori.feed.app.App.controller.createBatchRequests()");throw e}return a},createExternalUrlBatchRequest:function(t,e){var a=this;var o=[];if(t&&e){if(e.id){o.push(t.createExternalOdataUrlBatchOperation(a.oOdataModel,e.id))}if(e.type){o.push(t.createExternalOdataUrlBatchOperation(a.oOdataModel,e.type))}}return o},createObjectGroupBatchRequest:function(e,a){var o=this;var s;if(e&&a&&a.id){s=e.createGetObjectGroupsBatchOperation(o.oOdataModel,a.id)}else{var i=new Error("Missing parameters. Cannot create a batch request for Object Group.");t.error(i,"","sap.collaboration.components.fiori.feed.app.App.controller.createObjectGroupBatchRequest()");throw i}return s},parseBatchResults:function(t){var e=this;var a=0;if(!e.sJamUrl){if(t[a].error){throw new Error(t[a].error)}else{e.sJamUrl=t[a][e.oODataUtil.OdataUtilConstants.EndPoint.GetCollaborationHostUrl].Url}a++}if(t[a].error){throw new Error(t[a].error)}else{e.sJamToken=t[a][e.oODataUtil.OdataUtilConstants.EndPoint.GetSingleUseToken].Id}a++;if(e.sFeedType==n.object){if(t[a].error){throw new Error(t[a].error)}else{e.oBusinessObject.id=t[a][e.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;e.oBusinessObject.odata_url=e.oBusinessObject.id}a++;if(t[a].error){throw new Error(t[a].error)}else{e.oBusinessObject.type=t[a][e.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;e.oBusinessObject.metadata_url=e.oBusinessObject.type}}else if(e.sFeedType==n.group||e.sFeedType==n.objectGroup){if(t[a].error){throw new Error(t[a].error)}else{var o=e.oODataUtil.getGroupIds(t[a].results);if(!e.sGroupIds){e.sGroupIds=o}else{e.sGroupIds=e.filterGroupIds(o)}}}}})});