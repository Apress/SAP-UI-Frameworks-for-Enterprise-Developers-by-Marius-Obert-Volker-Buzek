/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/collaboration/components/utils/CommonUtil","sap/collaboration/components/utils/JamUtil","sap/collaboration/components/utils/OdataUtil","sap/collaboration/library","sap/ui/core/UIComponent","sap/ui/thirdparty/jquery","sap/ui/model/odata/ODataModel","sap/ui/core/mvc/View","sap/ui/core/library","sap/m/Dialog","sap/m/Button","sap/ui/Device"],function(e,t,i,o,s,a,r,n,l,d,c,u,p,h){"use strict";var g=c.mvc.ViewType;var f=a.AppType;var O=a.FeedType;var b=r.extend("sap.collaboration.components.fiori.feed.dialog.Component",{metadata:{includes:["../../../resources/css/Sharing.css"],properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"575px"},height:{type:"sap.ui.core.CSSSize",defaultValue:"605px"},feedType:{type:"string",defaultValue:O.object},groupIds:{type:"string"},object:{type:"object"},businessObject:{type:"object"}},aggregations:{},events:{}},systemSettings:{oDataServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV",oCollaborationHostRestService:"/sap/bc/ui2/smi/rest_tunnel/Jam//v1",oCollaborationHostODataService:"/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData"},init:function(){this.oCommonUtil=new i;this.oJamUtil=new o;this.oLangBundle=this.oCommonUtil.getLanguageBundle();this.sJamUrl=undefined;this.sJamToken=undefined;this.oOdataModel=undefined;this.oODataUtil=undefined;this.oBusinessObject={};r.prototype.init.apply(this)},setSettings:function(t){if(t){this.setFeedType(t.feedType);this.setGroupIds(t.groupIds);this.setObject(t.object);this.setBusinessObject(t.businessObject)}else{var i=new Error("Settings object is undefined");e.error(i.stack)}},open:function(){this._logComponentProperties();try{this._validateInputParameters(this.mProperties);this._createFeedDialog();this._requestWidgetData();this.oFeedDialog.open()}catch(t){e.error(t.stack);this.oCommonUtil.displayError()}},onBeforeRendering:function(){},onAfterRendering:function(){},render:function(e){},_requestWidgetData:function(){var t=this._getCSRFToken();var i=this;var o=true;var s=this.systemSettings.oCollaborationHostRestService;this._initOData();if(this.getObject()){this._getObjectWithoutMapping()}else if(this.getBusinessObject()){this._getObjectWithMapping()}var a=function(){if(this.readyState==4){if(this.status==201){i.sJamToken=this.responseXML.getElementsByTagName("single_use_token")[0].attributes[0].value;if(i.sJamUrl&&i.oBusinessObject.odata_url&&i.oBusinessObject.metadata_url){i._createFeedView();i.oFeedDialog.addContent(i.oFeedView);setTimeout(function(){i.oFeedDialog.setBusy(false)},3e3)}}else{var t="The single use token from SAP Jam was not returned successfully";e.error(t,"","sap.collaboration.components.utils.JamUtil.getJamSinglelUseTokens()");if(i.oFeedDialog.isOpen()===true){i.oFeedDialog.close()}i.oCommonUtil.displayError()}}};this.oJamUtil.getJamSinglelUseTokens(s,a,o,t)},_getObjectWithoutMapping:function(){var t=this;var i=true;var o=[];var s=function(e){t._parseBatchResults(e);if(t.sJamToken){t._createFeedView();t.oFeedDialog.addContent(t.oFeedView);setTimeout(function(){t.oFeedDialog.setBusy(false)},3e3)}};var a=function(t){e.error(t,"","sap.collaboration.components.fiori.feed.dialog.Component._getObjectWithoutMapping(), fnBatchErrorCallback()");throw t};o=this._createBatchRequests();this.oODataUtil.executeODataBatchRequest(this.oOdataModel,o,s,i,a)},_getObjectWithMapping:function(){var e=this;var t=new n.Deferred;t.done(function(t){e.sJamUrl=t});var i=new n.Deferred;i.done(function(t){e._setMappedObject(t)});n.when(t,i).fail(function(t){if(e.oFeedDialog&&e.oFeedDialog.isOpen()){e.oFeedDialog.close()}e.oCommonUtil.displayError()});this.oODataUtil.getJamUrl(this.oOdataModel,t);this.oODataUtil.getExternalObjectMapping(this.oOdataModel,this.getBusinessObject(),i)},_setMappedObject:function(e){var t=this;this.oBusinessObject.id=e.Exid;this.oBusinessObject.type=e.ObjectType;this.oBusinessObject.odata_url=this.oBusinessObject.id;this.oBusinessObject.metadata_url=this.oBusinessObject.type;if(this.sJamToken){this._createFeedView();this.oFeedDialog.addContent(this.oFeedView);setTimeout(function(){t.oFeedDialog.setBusy(false)},3e3)}},_initOData:function(){var t=true;var i=this.systemSettings.oDataServiceUrl;if(!this.oOdataModel){this.oOdataModel=new l(i,t)}if(!this.oOdataModel.oMetadata.oMetadata){var o=new Error("Metadata is undefined");e.error(o,"","sap.collaboration.components.fiori.feed.dialog.Component._requestWidgetData()");throw o}if(!this.oODataUtil){this.oODataUtil=new s}},_getCSRFToken:function(){var e="";var t=this.systemSettings.oCollaborationHostODataService;var i=function(t){if(this.readyState==4){if(this.status==200){e=this.getResponseHeader("x-csrf-token")}}};this.oJamUtil.getCSRFToken(t,i,false);return e},_createBatchRequests:function(){var e=this;var t=[];if(!e.sJamUrl){t.push(e.oODataUtil.createJamUrlBatchOperation(e.oOdataModel))}t=t.concat(e._createExternalUrlBatchRequest(e.oODataUtil,e.getObject()));return t},_createExternalUrlBatchRequest:function(e,t){var i=this;var o=[];if(e&&t){if(t.id){o.push(e.createExternalOdataUrlBatchOperation(i.oOdataModel,t.id))}if(t.type){o.push(e.createExternalOdataUrlBatchOperation(i.oOdataModel,t.type))}}return o},_parseBatchResults:function(e){var t=this;var i=0;if(!t.sJamUrl){if(e[i].error){throw new Error(e[i].error)}else{t.sJamUrl=e[i][t.oODataUtil.OdataUtilConstants.EndPoint.GetCollaborationHostUrl].URL}i++}if(e[i].error){throw new Error(e[i].error)}else{t.oBusinessObject.id=e[i][t.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;t.oBusinessObject.odata_url=t.oBusinessObject.id}i++;if(e[i].error){throw new Error(e[i].error)}else{t.oBusinessObject.type=e[i][t.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;t.oBusinessObject.metadata_url=t.oBusinessObject.type}},_createFeedView:function(){var e=this;if(!e.oFeedView){e.oFeedView=sap.ui.view({id:e.getId()+"_FeedView",height:"100%",viewData:{controlId:e.getId(),jamURL:e.sJamUrl,jamToken:e.sJamToken,appType:f.widget,feedType:e.getFeedType(),groupIds:e.getGroupIds(),businessObject:e.oBusinessObject,langBundle:e.oLangBundle},type:g.JS,viewName:"sap.collaboration.components.fiori.feed.commons.Detail"})}else{e.oFeedView.getController().sFeedType=e.getFeedType();e.oFeedView.getViewData().groupIds=e.getGroupIds();e.oFeedView.getController().oBusinessObject=e.oBusinessObject}},_createFeedDialog:function(){var e=this;if(!this.oFeedDialog){this.oFeedDialog=new u(this.getId()+"FeedDialog",{title:this.oLangBundle.getText("FEED_DIALOG_TITLE"),stretch:false,contentWidth:this.getWidth(),contentHeight:this.getHeight(),content:[],endButton:new p({text:this.oLangBundle.getText("CLOSE_BUTTON_TEXT"),press:function(){e.oFeedDialog.close()}})});if(h.system.phone){this.oFeedDialog.setStretch(true)}}this.oFeedDialog.setBusy(true)},_validateInputParameters:function(i){var o;if(!i){o=new Error("Input paremeters are undefined");e.error(o.stack);throw o}else if(i.businessObject){var s=i.businessObject;if(t(s)){o=new Error("Business Object is empty");e.error(o.stack);throw o}if(!s.appContext){o=new Error("Application context is undefined");e.error(o.stack);throw o}if(!s.odataServicePath){o=new Error("OData Service Path is undefined");e.error(o.stack);throw o}if(!s.collection){o=new Error("Collection is undefined");e.error(o.stack);throw o}if(!s.key){o=new Error("Key is undefined");e.error(o.stack);throw o}if(!s.name){o=new Error("Name is undefined");e.error(o.stack);throw o}}else if(i.object){var a=i.object;if(t(a)){o=new Error("Business Object is empty");e.error(o.stack);throw o}if(!a.id){o=new Error("Object is undefined");e.error(o.stack);throw o}if(!a.type){o=new Error("Missing Object Type");e.error(o.stack);throw o}}else{o=new Error("Neither an Object nor a Business Object was passed");throw o}},_logComponentProperties:function(){e.debug("Share Component properties:","","sap.collaboration.components.fiori.dialog.Component._logComponentProperties()");e.debug("width: "+this.getWidth());e.debug("height: "+this.getHeight());e.debug("oDataServiceUrl: "+this.systemSettings.oDataServiceUrl);e.debug("feedType: "+this.getFeedType());e.debug("groupIds: "+this.getGroupIds());e.debug("object: "+JSON.stringify(this.getObject()));e.debug("businessObject: "+JSON.stringify(this.getBusinessObject()))}});return b});