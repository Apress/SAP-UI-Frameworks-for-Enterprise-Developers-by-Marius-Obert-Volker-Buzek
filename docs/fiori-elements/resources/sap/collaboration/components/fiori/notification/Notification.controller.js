/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/collaboration/components/utils/CommonUtil","sap/collaboration/components/utils/NotificationTypeUtil","sap/collaboration/components/utils/OdataUtil","sap/ui/core/mvc/Controller","sap/ui/model/odata/ODataModel","sap/ui/Global"],function(t,i,e,o,a,s){"use strict";sap.ui.controller("sap.collaboration.components.fiori.notification.Notification",{onInit:function(){this.initializeRefreshAndTransitionState();this.sPrefixId=this.getView().getViewData().controlId;this.oView=this.getView();this.oLangBundle=this.oView.oLangBundle;this.sOdataServiceUrl=this.getView().getViewData().oDataServiceUrl;this.iTransitionInterval=this.getView().getViewData().transitionInterval;this.iRefreshInterval=this.getView().getViewData().refreshInterval;this.sProfilePhotoHiddenStyleClass=this.oView.sStyleClassPrefix+"ProfileImageHidden";this.sLoadingAnimationDummyTextStyleClass=this.oView.sStyleClassPrefix+"LoadingText";this.sNewNotificationTextStyleClass=this.oView.sStyleClassPrefix+"NewNotificationText";this.sErrorTextStyleClass=this.oView.sStyleClassPrefix+"ErrorText";this.oView.oNotificationNewNotificationOrErrorText.addStyleClass(this.sLoadingAnimationDummyTextStyleClass);this.oView.oNotificationNewNotificationOrErrorText.setText(". . . . . . . . . . . .");this.oView.oNotificationNewNotificationOrErrorText.setBusy(true);this.oNotificationTypeUtil=new i},initializeRefreshAndTransitionState:function(){this.bErrorInUnreadCountODataResponse=true;this.bErrorInNoticesODataResponse=true;this.bErrorInODataResponse=true;this.iNotificationCurrentIndex=undefined;this.iNotificationPreviousIndex=undefined;this.aNotifications=undefined;this.bIsTransitionActive=false;this.iNotificationsTransitionCallbackRegistrationId=undefined;this.bIsRefreshActive=false;this.iNotificationsRefreshCallbackRegistrationId=undefined;this.iNotificationUnreadCount=undefined;this.iMaxNotificationsToDisplay=this.getView().getViewData().numberOfNotifications;this.aImageControls=this.getView().getViewData().aProfilePhotos;this.iNotificationsToDisplay=undefined;this.aUsedImageControls=[]},onBeforeRendering:function(){this.initializeCommonUtil();this.initializeOdataModel();this.initializeOdataUtils()},onAfterRendering:function(){this.fetchNotificationData()},initializeOdataModel:function(){var t=true;this.oOdataModel=new a(this.sOdataServiceUrl,t)},initializeOdataUtils:function(){this.oODataUtil=new e},initializeCommonUtil:function(){this.oCommonUtil=new t},fetchNotificationData:function(){var t=[];var i=this.oODataUtil.createNotificationUnreadCountBatchOperation(this.oOdataModel);var e=this.oODataUtil.createNotificationBatchOperation(this.oOdataModel,this.iMaxNotificationsToDisplay);t.push(i);t.push(e);var o=this.getFunctionParseResult();var a=this.getFunctionErrorCallBack();this.oODataUtil.executeODataBatchRequest(this.oOdataModel,t,o,true,a)},getFunctionParseResult:function(){var t=this;return function(i){t.oView.oNotificationNewNotificationOrErrorText.setBusy(false);t.oView.oNotificationNewNotificationOrErrorText.setText("");t.oView.oNotificationNewNotificationOrErrorText.removeStyleClass(t.sLoadingAnimationDummyTextStyleClass);t.initializeRefreshAndTransitionState();if(i[0].error&&!i[1].error){t.bErrorInNoticesODataResponse=false;t.aNotifications=i[1].results;t.clearAllUiTexts();t.hideAllProfilePhotoControls();t.setUiContent();t.activateNotificationRefresh()}else if(!i[0].error&&i[1].error){t.bErrorInUnreadCountODataResponse=false;t.iNotificationUnreadCount=i[0].GetNoticeUnreadCount.UnreadCount;t.clearAllUiTexts();t.hideAllProfilePhotoControls();t.setUiContent();t.activateNotificationRefresh()}else if(i[0].error&&i[1].error){t.clearAllUiTexts();t.hideAllProfilePhotoControls();t.setUiContent();t.activateNotificationRefresh()}else{t.bErrorInUnreadCountODataResponse=false;t.bErrorInNoticesODataResponse=false;t.bErrorInODataResponse=false;t.aNotifications=i[1].results;t.iNotificationUnreadCount=i[0].GetNoticeUnreadCount.UnreadCount;if(t.iMaxNotificationsToDisplay>0){if(t.aNotifications.length>0){if(t.iNotificationUnreadCount>0){t.iNotificationsToDisplay=Math.min(t.iMaxNotificationsToDisplay,t.aNotifications.length,t.iNotificationUnreadCount);t.iNotificationCurrentIndex=0;t.iNotificationPreviousIndex=t.iNotificationsToDisplay-1;t.clearAllUiTexts();t.hideAllProfilePhotoControls();t.setProfilePhotosSrc();t.setUiContent();t.activateNotificationTransition();t.activateNotificationRefresh()}else{t.iNotificationsToDisplay=1;t.iNotificationCurrentIndex=0;t.iNotificationPreviousIndex=t.iNotificationsToDisplay-1;t.clearAllUiTexts();t.hideAllProfilePhotoControls();t.setProfilePhotosSrc();t.setUiContent();t.activateNotificationRefresh()}}else{t.iNotificationsToDisplay=0;t.clearAllUiTexts();t.hideAllProfilePhotoControls();t.activateNotificationRefresh()}}else{t.iNotificationsToDisplay=0;t.clearAllUiTexts();t.hideAllProfilePhotoControls()}}}},getFunctionErrorCallBack:function(){var t=this;return function(i){t.initializeRefreshAndTransitionState();t.clearAllUiTexts();t.hideAllProfilePhotoControls();t.setUiContent();t.activateNotificationRefresh()}},setProfilePhotosSrc:function(){var t;var i;var e;for(var o=0;o<this.iNotificationsToDisplay;++o){t=this.aNotifications[o].SenderId;i=this.aNotifications[o].SenderFullName;e=this.getProfilePhotoURL(i,t);this.oView.aProfilePhotos[o].addStyleClass(this.sProfilePhotoHiddenStyleClass);this.oView.aProfilePhotos[o].setSrc(e)}},getProfilePhotoURL:function(t,i){if(t!==""){return this.sOdataServiceUrl+"/Members("+i+")/ProfilePhoto/$value"}else{return sap.ui.resource("sap.collaboration.components","images/Anonymous.png")}},hideAllProfilePhotoControls:function(){for(var t=0;t<this.oView.aProfilePhotos.length;++t){this.oView.aProfilePhotos[t].addStyleClass(this.sProfilePhotoHiddenStyleClass)}},clearAllUiTexts:function(){this.oView.oNotificationTypeText.setText("");this.oView.oNotificationMessageText.setText("");this.oView.oNotificationUnreadCountText.setText("");this.oView.oNotificationNewNotificationOrErrorText.setText("");this.oView.oNotificationAgeText.setText("");this.oView.oNotificationGroupText.setText("")},setUiContent:function(){if(this.bErrorInODataResponse){this.oView.oNotificationNewNotificationOrErrorText.removeStyleClass(this.sNewNotificationTextStyleClass);this.oView.oNotificationNewNotificationOrErrorText.addStyleClass(this.sErrorTextStyleClass);this.oView.oNotificationNewNotificationOrErrorText.setText(this.oLangBundle.getText("NOTIF_ERROR_MESSAGE"))}else{var t=this.aNotifications[this.iNotificationCurrentIndex];var i="NOTIF_"+t.EventType.toUpperCase();var e=t.Message;var o;if(this.iNotificationUnreadCount>999){o=this.oLangBundle.getText("NOTIF_MORE_THAN_999_NEW_NOTIFICATIONS")}else{o=this.iNotificationUnreadCount}var a=t.CreatedAt;var s=t.GroupName;var n=this.oNotificationTypeUtil.getRequiredNotificationPropertyNames(t.EventType);var r=this.getNotificationPropertyValues(n,t);this.oView.oNotificationTypeText.setText(this.oLangBundle.getText(i,r));this.oView.oNotificationMessageText.setText(e);this.oView.aProfilePhotos[this.iNotificationPreviousIndex].addStyleClass(this.sProfilePhotoHiddenStyleClass);this.oView.aProfilePhotos[this.iNotificationCurrentIndex].removeStyleClass(this.sProfilePhotoHiddenStyleClass);this.oView.oNotificationUnreadCountText.setText(o);this.oView.oNotificationNewNotificationOrErrorText.removeStyleClass(this.sErrorTextStyleClass);this.oView.oNotificationNewNotificationOrErrorText.addStyleClass(this.sNewNotificationTextStyleClass);this.oView.oNotificationNewNotificationOrErrorText.setText(this.oLangBundle.getText("NOTIF_NEW_NOTIFICATIONS"));var l=this.calculateNotificationAge(a,s).split("\n");var f=l[0];var c="";if(l.length>1){c=l[1]}this.oView.oNotificationAgeText.setText(f);this.oView.oNotificationGroupText.setText(c);this.iNotificationPreviousIndex=this.iNotificationCurrentIndex;this.iNotificationCurrentIndex=(this.iNotificationCurrentIndex+1)%this.iNotificationsToDisplay}},getNotificationPropertyValues:function(t,i){var e=[];for(var o=0;o<t.length;o++){e.push(i[t[o]])}return e},calculateNotificationAge:function(t,i){if(!this.oCommonUtil.isValidDate(t)){return""}var e=new Date;t.setMilliseconds(0);e.setMilliseconds(0);var o=6e4;var a=o*60;var s=a*24;var n=e.getTime()-t.getTime();if(n>=s){var r=Math.round(parseFloat(n/s,10));if(r===1){if(i!==""){return this.oLangBundle.getText("NOTIF_DAY_AGO_GRP",[r.toString(),i])}else{return this.oLangBundle.getText("NOTIF_DAY_AGO_NO_GRP",[r.toString()])}}else{if(i!==""){return this.oLangBundle.getText("NOTIF_DAYS_AGO_GRP",[r.toString(),i])}else{return this.oLangBundle.getText("NOTIF_DAYS_AGO_NO_GRP",[r.toString()])}}}else if(n>=a){var l=Math.round(parseFloat(n/a,10));if(l===1){if(i!==""){return this.oLangBundle.getText("NOTIF_HOUR_AGO_GRP",[l.toString(),i])}else{return this.oLangBundle.getText("NOTIF_HOUR_AGO_NO_GRP",[l.toString()])}}else{if(i!==""){return this.oLangBundle.getText("NOTIF_HOURS_AGO_GRP",[l.toString(),i])}else{return this.oLangBundle.getText("NOTIF_HOURS_AGO_NO_GRP",[l.toString()])}}}else{var f=Math.round(parseFloat(n/o,10));if(f===1){if(i!==""){return this.oLangBundle.getText("NOTIF_MINUTE_AGO_GRP",[f.toString(),i])}else{return this.oLangBundle.getText("NOTIF_MINUTE_AGO_NO_GRP",[f.toString()])}}else{if(i!==""){return this.oLangBundle.getText("NOTIF_MINUTES_AGO_GRP",[f.toString(),i])}else{return this.oLangBundle.getText("NOTIF_MINUTES_AGO_NO_GRP",[f.toString()])}}}},activateNotificationTransition:function(){if(!this.bIsTransitionActive){this.iNotificationsTransitionCallbackRegistrationId=this.getTransitionRegistrationId();this.bIsTransitionActive=true}},getTransitionRegistrationId:function(){return setInterval(this.setUiContent.bind(this),this.iTransitionInterval)},deactivateNotificationTransition:function(){if(this.bIsTransitionActive){clearInterval(this.iNotificationsTransitionCallbackRegistrationId);this.bIsTransitionActive=false}},activateNotificationRefresh:function(){if(!this.bIsRefreshActive){this.iNotificationsRefreshCallbackRegistrationId=this.getRefreshRegistrationId();this.bIsRefreshActive=true}},getRefreshRegistrationId:function(){return setInterval(this.refreshNotification.bind(this),this.iRefreshInterval)},deactivateNotificationRefresh:function(){if(this.bIsRefreshActive){clearInterval(this.iNotificationsRefreshCallbackRegistrationId);this.bIsRefreshActive=false}},refreshNotification:function(){this.deactivateNotificationTransition();this.deactivateNotificationRefresh();this.fetchNotificationData()}})});