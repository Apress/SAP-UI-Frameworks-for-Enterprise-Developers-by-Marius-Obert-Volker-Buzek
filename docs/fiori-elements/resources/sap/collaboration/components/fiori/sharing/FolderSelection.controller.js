/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/StandardListItem","sap/m/library"],function(e,t,o,r){"use strict";var i=r.ListType;sap.ui.controller("sap.collaboration.components.fiori.sharing.FolderSelection",{constants:{top:20},onInit:function(){this.oLangBundle=this.getView().getViewData().languageBundle;this.oODataModel=this.getView().getViewData().oDataModel;this.oODataUtil=this.getView().getViewData().oDataUtil;this.sGroupId=this.getView().getViewData().groupId;this.oFolderSelectionDialog=this.getView().getViewData().folderSelectionDialog;this.sCurrentFolderId="";this.aFolderBuffer=[]},onBeforeRendering:function(){this.refreshFolderSelection(this.sCurrentFolderId)},onAfterRendering:function(){},refreshFolderSelection:function(e){var t=this.buildFolderList(e);this.setViewModel(t);this.bindFoldersList();this.refreshHeaderBar(e)},buildFolderList:function(e){var t=[];var o=this.getFolder(e);t=this.getSubFolders(o);if(o.subFolderCount>t.length){var r=o.subFolderCount-t.length;for(var i=0;i<r;i++){t.push({})}}return t},setViewModel:function(e){this.oViewData={folders:e};this.oViewModel=new t(this.oViewData);this.getView().setModel(this.oViewModel)},bindFoldersList:function(){var e=this;var t=new o({title:"{name}",icon:"{icon}",type:i.Navigation,press:e.selectFolder()});this.getView().oFoldersList.bindAggregation("items","/folders",t)},refreshHeaderBar:function(e){if(!e==""){var t=this.getFolder(e);this.setFolderSelectionDialogTitle(t.name);this.setFolderSelectionDialogBackButtonVisibility(true)}else{this.setFolderSelectionDialogTitle(this.oLangBundle.getText("TARGET_FOLDER_FIELD_TEXT"));this.setFolderSelectionDialogBackButtonVisibility(false)}},selectFolder:function(e){var t=this;return function(e){var o=e.oSource.getBindingContext().getObject().id;t.refreshFolderSelection(o);t.sCurrentFolderId=o}},navigateBack:function(e){var t=this.getFolder(this.sCurrentFolderId);var o=t.parent;this.refreshFolderSelection(o);this.sCurrentFolderId=o},setFolderSelectionDialogTitle:function(e){var t=this.oFolderSelectionDialog.getCustomHeader();var o=t.getContentMiddle()[0];o.setText(e)},setFolderSelectionDialogBackButtonVisibility:function(e){var t=this.oFolderSelectionDialog.getCustomHeader();var o=t.getContentLeft()[0];o.setVisible(e)},getCurrentFolder:function(){if(this.sCurrentFolderId===""){return{name:this.oLangBundle.getText("TARGET_FOLDER_FIELD_TEXT"),id:""}}return this.getFolder(this.sCurrentFolderId)},updateStarted:function(e){if(e.mParameters.reason=="Growing"){var t=[];var o=this.getFolderFromBuffer(this.sCurrentFolderId);var r=this.getSubFoldersFromBuffer(this.sCurrentFolderId).length;if(o.subFolderCount!=r){t=this.fetchSubFolders(this.sCurrentFolderId,r)}if(t.length>0){this.addFoldersToBuffer(t);for(var i=0;i<t.length;i++){this.oViewData.folders[i+r]=t[i]}}}},addFoldersToBuffer:function(e){if(!this.aFolderBuffer){this.aFolderBuffer=[]}for(var t=0;t<e.length;t++){this.aFolderBuffer.push(e[t])}},getSubFoldersFromBuffer:function(e){var t="";if(e){t=e}var o=function(e){return e.parent==t};return this.aFolderBuffer.filter(o)},getFolderFromBuffer:function(e){var t=function(t){return t.id==e};var o=this.aFolderBuffer.filter(t);return o[0]},getFolder:function(e){var t=this.getFolderFromBuffer(e);if(!t&&e==""){var o=this.oODataUtil.getSubFolders(this.oODataModel,this.sGroupId,null,"0",this.constants.top);t={name:this.oLangBundle.getText("TARGET_FOLDER_FIELD_TEXT"),id:"",parent:"0",subFolderCount:o.count,icon:"sap-icon://folder"};this.addFoldersToBuffer([t]);var r=this.convertFolderEntities(o.folders,"");this.addFoldersToBuffer(r)}if(t.subFolderCount==undefined){var o=this.oODataUtil.getSubFolders(this.oODataModel,null,e,"0",this.constants.top);t.subFolderCount=o.count;var r=this.convertFolderEntities(o.folders,e);this.addFoldersToBuffer(r)}return t},getSubFolders:function(e){var t=[];if(e.subFolderCount>0){t=this.getSubFoldersFromBuffer(e.id)}return t},convertFolderEntities:function(e,t){var o=[];for(var r=0;r<e.length;r++){o.push({name:e[r].Name,id:e[r].Id,parent:t,icon:"sap-icon://folder"})}return o},fetchSubFolders:function(e,t){var o=[];if(!e||e==""){o=this.oODataUtil.getSubFolders(this.oODataModel,this.sGroupId,null,t,this.constants.top).folders;o=this.convertFolderEntities(o,"")}else{o=this.oODataUtil.getSubFolders(this.oODataModel,null,e,t,this.constants.top).folders;o=this.convertFolderEntities(o,e)}return o},clearFolderBuffer:function(){this.oFolderSelectionDialog.getContent()[0].getController().clearFolderBuffer()}})});