/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ui/thirdparty/jquery","sap/collaboration/components/socialtimeline/filter/FilterType"],function(e,t,i,n){"use strict";var r=t.extend("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler",{constructor:function(t,i,r,s,a,o,l,u){this._oLogger=e.getLogger("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");this._oFilterConstants=new n;this._oBusinessObjectMap=t;this._oJamDataHandler=i;this._oServiceDataHandler=s;this._oTimelineTermsUtility=a;this._oSMIntegrationDataHandler=r;this._bSocialFeaturesEnabled=l;this._bBackendFeaturesEnabled=u;this._iPageSize=o;this._iPageSize=o;this._iTimelineEntriesPageSize=o;this._iTimelineEntriesSkip=0;this._iFeedEntriesPageSize=o*2;this._sBusinessObjectKey="";this._sFeedEntriesNextLink="";this._fCustomActionCallBack=t.customActionCallback;this._aTimelineEntries=[];this._aFeedEntries=[];this._oExternalBO={};this._oMemberDataBuffer={};this._oExternalBOMapping={}},setBusinessObject:function(e){this._setBusinessObjectValues(e);this._resetBusinessObjectData();this.getExternalBOMapping()},reset:function(){this._iTimelineEntriesSkip=0;this._iTimelineEntriesPageSize=this._iPageSize;this._sFeedEntriesNextLink="";this._aTimelineEntries=[];this._aFeedEntries=[]},getTimelineData:function(e,t){var n=i.Deferred();var r=this;if(e.type===this._oFilterConstants.FILTER_TYPE.feedUpdates){if(t){this._setBusinessObjectValues(t);this._resetBusinessObjectData();n=this.getExternalBOMapping().then(function(){return r._getExternalObjectJamOnlyFeedEntries()})}else{n=this._getExternalObjectFeedEntries()}}else if(e.type===this._oFilterConstants.FILTER_TYPE.systemUpdates||e.type===this._oFilterConstants.FILTER_TYPE.custom){n=this._getTimelineEntries(e)}else{this._oLogger.error("The filter type is invalid.");n.resolve([])}return n.promise()},getExternalBOMapping:function(){var e={appContext:this._oBusinessObjectMap.applicationContext,collection:this._oBusinessObjectMap.collection,name:this._sBusinessObjectName,key:this._sBusinessObjectKey,odataServicePath:this._oBusinessObjectMap.servicePath};var t=this._oSMIntegrationDataHandler.mapInternalBOToExternalBO(e).then(function(e){this._oExternalBOMapping=e;this._oExternalBOMapping.Name=this._sBusinessObjectName}.bind(this));return t.promise()},_setBusinessObjectValues:function(e){this._sBusinessObjectKey=e.key;this._sBusinessObjectName=e.name},_resetBusinessObjectData:function(){this.reset();if(this._oTimelineEntriesReadRequest){this._oTimelineEntriesReadRequest.abort()}if(this._oFeedEntriesReadRequest){this._oFeedEntriesReadRequest.abort()}},_getExternalObjectFeedEntries:function(){var e=this;var t=this._oJamDataHandler.getExternalObject(this._oExternalBOMapping).then(function(t){e._oExternalBO=t;if(e._sFeedEntriesNextLink==undefined){var n=i.Deferred();n.resolve({results:[]},null);return{request:null,promise:n}}else if(e._sFeedEntriesNextLink==""){return e._oJamDataHandler.getFeedEntries(t.Id)}else{return e._oJamDataHandler.getFeedEntries(null,e._sFeedEntriesNextLink)}}).then(function(t){e._oFeedEntriesReadRequest=t.request;return t.promise}).then(function(t){e._sFeedEntriesNextLink=t.__next;return t.results}).then(function(t){return e._mapFeedEntriesToTimelineItems(t)});return t.promise()},_getExternalObjectJamOnlyFeedEntries:function(){var e=function(){var e=i.Deferred();if(this._sFeedEntriesNextLink===undefined){var t=i.Deferred();t.resolve({results:[]},null);e={request:null,promise:t}}else if(this._sFeedEntriesNextLink===""){e=this._oJamDataHandler.getExternalObjectByExidAndObjectType(this._oExternalBOMapping)}else{e=this._oJamDataHandler.getExternalObjectByExidAndObjectType(null,this._sFeedEntriesNextLink)}return e.promise}.bind(this);var t=e().then(function(e){this._oExternalBO=e.results;var t=e.results.FeedEntries;this._sFeedEntriesNextLink=t.__next;return this._mapFeedEntriesToTimelineItems(t.results)}.bind(this));return t.promise()},_getTimelineEntries:function(e){var t=this;var i=e.type;if(i!==this._oFilterConstants.FILTER_TYPE.custom){i=undefined}else{i=e.value}var n=this._oServiceDataHandler.readTimelineEntries(this._oBusinessObjectMap.collection,this._sBusinessObjectKey,i,this._iTimelineEntriesSkip,this._iTimelineEntriesPageSize);this._oTimelineEntriesReadRequest=n.request;var r=n.promise.then(function(e){var i=e.results;t._iTimelineEntriesPageSize=i.length;t._iTimelineEntriesSkip+=t._iTimelineEntriesPageSize;return t._mapTimelineEntriesToTimelineItems(i)}).then(function(e){if(t._bSocialFeaturesEnabled===true){return t._fillPicturesForTimelineItems(e)}return e});return r.promise()},_fillPicturesForTimelineItems:function(e){var t=this;var n=i.Deferred();var r=[];e.forEach(function(e){if(!e.timelineItemData.userPicture){r.push(e.timelineItemData.userEmail)}});var s=r.filter(function(e,t){return r.indexOf(e)==t});if(s.length>0){var a=this._oJamDataHandler.getUserInfoBatch(s);a.promise.done(function(r){var s=i.grep(r,function(e){return e.results.length>0});s.forEach(function(e){t.addUserInfoToBuffer(e.results[0])});e.forEach(function(e){if(!e.timelineItemData.userPicture){e.timelineItemData.userPicture=t.getUserPicture(e.timelineItemData.userEmail)}});n.resolve(e)});a.promise.fail(function(t){n.resolve(e)})}else{n.resolve(e)}return n.promise()},_getAtMentions:function(e){var t={};var i=this._oJamDataHandler.getAtMentions(e.Id);i.promise.done(function(e,i){var n=e.results;for(var r=0;r<n.length;r++){if(n[r]){t[r]=n[r]}}});i.promise.fail(function(){this._oLogger.error("Failed to get the @mentions.")});return t},_mapFeedEntriesToTimelineItems:function(e){var t=this;var i=[];e.forEach(function(e){var n={};n.timelineItemData=t._mapFeedEntryToTimelineItem(e);n._feedEntryData=e;if(e.ConsolidatedCount>1){n._feedEntryData._consolidatedUrl="<collaboration_host_url>"+e.Id}i.push(n)});return i},_mapFeedEntryToTimelineItem:function(e){var t="sap-icon://post";if(!this.getUserInfoFromBuffer(e.Creator.Email)){this.addUserInfoToBuffer(e.Creator)}var i={feedId:e.Id,dateTime:e.CreatedAt,userName:e.Creator.FullName,userEmail:e.Creator.Email,title:e.Action,text:e.Text,textWithPlaceholders:e.TextWithPlaceholders,replyCount:e.RepliesCount,icon:t};i.userPicture=this.getUserPicture(i.userEmail);return i},_mapTimelineEntriesToTimelineItems:function(e){var t=this;var i=[];e.forEach(function(e){var n={};n.timelineItemData=t._mapTimelineEntryToTimelineItem(e);var r=undefined;if(t._fCustomActionCallBack){r=t._fCustomActionCallBack(e);if(r){var s=true;if(!Array.isArray(r)){t._oLogger.error("The type defined for the return statement of the function 'customActionCallback' is "+typeof r+", expected type is array. Custom actions have been removed.");s=false}else{for(var a=0;a<r.length;a++){if(typeof r[a]!=="object"){t._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(r[a])+" of type "+typeof r[a]+", expected type is object. Custom actions have been removed.");s=false;break}else if(!r[a].key||!r[a].value){t._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(r[a])+" with the property 'key' or 'value' as undefined. Custom actions have been removed.");s=false;break}else if(typeof r[a].value!=="string"){t._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(r[a])+" with the property 'value' as type "+typeof r[a].value+", expected type is string. Custom actions have been removed.");s=false;break}}}if(s){r.oDataEntry=e;n.timelineItemData.customActionData=r}}}i.push(n)});return i},_mapTimelineEntryToTimelineItem:function(e){var t=this._oTimelineTermsUtility.getTimelineEntryFields(this._oBusinessObjectMap.collection);var i={dateTime:e[t.TimeStamp],userName:e[t.ActorName],userEmail:e[t.ActorExtID].toLowerCase(),title:e[t.ActionText],text:e[t.SummaryText],icon:e[t.Icon],timelineEntryDetails:this._processTimelineEntryDetails(e[t.TimelineDetailNavigationPath].results,this._oBusinessObjectMap.collection)};i.userPicture=this.getUserPicture(i.userEmail);return i},_processTimelineEntryDetails:function(e,t){var i=this;var n=[];var r=i._oTimelineTermsUtility.getTimelineEntryDetailFields(t);e.forEach(function(e){var t={};t.afterValue=e[r.AfterValue];t.beforeValue=e[r.BeforeValue];t.changeType=e[r.ChangeType];t.propertyLabel=e[r.PropertyLabel];n.push(t)});return n},getUserPicture:function(e){var t=this.getUserInfoFromBuffer(e);if(!t){return""}return t.picture},buildImageUrl:function(e){return this._oJamDataHandler._oCollabModel.sServiceUrl+"/"+e.__metadata.uri+"/ThumbnailImage/$value"},addUserInfoToBuffer:function(e){var t=this.buildImageUrl(e);var i=e.Email.toLowerCase();this._oMemberDataBuffer[i]={email:i,fullname:e.FullName,id:e.Id,address:e.MemberProfile.Address,title:e.Title,role:e.Role,picture:t}},getUserInfoFromBuffer:function(e){var t=e.toLowerCase();return this._oMemberDataBuffer[t]},getCurrentExternalBO:function(){return this._oExternalBO}});return r});