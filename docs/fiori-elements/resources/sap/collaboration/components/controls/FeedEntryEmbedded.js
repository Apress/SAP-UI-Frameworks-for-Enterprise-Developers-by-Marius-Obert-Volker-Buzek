/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","sap/ui/dom/includeStylesheet","sap/ui/core/Control","sap/collaboration/components/utils/LanguageBundle","sap/collaboration/components/controls/FeedEntryEmbeddedRenderer","sap/collaboration/components/controls/PlaceholderUtility","sap/collaboration/components/utils/MediaTypeToSAPIcon","sap/m/Link","sap/ui/model/json/JSONModel","sap/m/VBox","sap/m/Image","sap/ui/core/Icon","sap/m/HBox"],function(e,t,n,i,r,s,o,a,l,d,c,p,h,u){"use strict";var m=i.extend("sap.collaboration.components.controls.FeedEntryEmbedded",{metadata:{interfaces:[],library:"sap.collaboration",properties:{feedEntry:{type:"object",group:"data"},serviceUrl:{type:"string",group:"data"}},events:{atMentionClick:{parameters:{link:{type:"object"}}},expandCollapseClick:{},previewLoad:{}}},renderer:s});m.prototype.init=function(){this.nMaxCollapsedLength=200;this.CONTENT_MAX_HEIGHT=128;this._oLangBundle=new r;this._oTimelineItemContent;n(sap.ui.require.toUrl("sap/collaboration/components/resources/css/EmbeddedControl.css"))};m.prototype.onBeforeRendering=function(){};m.prototype.onAfterRendering=function(){this._$ExpandedTextDiv=this.$("expanded-text");var t=this._$ExpandedTextDiv.html();if(t!=undefined){this._$ExpandedTextDiv.html(this._renderLinks(t))}if(this.oExpandLink&&this.oCollapseLink){this._$FeedEntryDiv=this.$();this._$CollapsedTextDiv=this.$("collapsed-text");var n=this._$CollapsedTextDiv.html();if(n!=undefined){this._$CollapsedTextDiv.html(this._renderLinks(n))}e(this._$ExpandedTextDiv).detach()}if(this._oTimelineItemContent.getItems()[0]&&this._oTimelineItemContent.getItems()[0].getMetadata().getName()==="sap.m.Image"){var i=this._oTimelineItemContent.getItems()[0];i.getDomRef().addEventListener("load",function(){var e=this._oTimelineItemContent.getDomRef().clientWidth;var t=this.CONTENT_MAX_HEIGHT;var n=i.getDomRef().width;var r=i.getDomRef().height;var s=n/r;if(!(r<=t&&n<=e)){if(r>t){n=s*t;r=t}if(n>e){r=e/s;n=e}i.setWidth(n+"px");i.setHeight(r+"px");i.rerender()}this.firePreviewLoad()}.bind(this))}};m.prototype.exit=function(){this._destroyAtMentionLinks();if(this.oExpandLink){this.oExpandLink.destroy()}if(this.oCollapseLink){this.oCollapseLink.destroy()}if(this._oTimelineItemContent){this._oTimelineItemContent.destroy()}};m.prototype.setFeedEntry=function(e){this.setProperty("feedEntry",e);this._sText=e.Text;this._sTextWithPlaceholders=e.TextWithPlaceholders;this._destroyAtMentionLinks();this._mAtMentionsLinks={};var t=o.getAtMentionsValues(this._sText,this._sTextWithPlaceholders);for(var n=0;n<t.length;n++){this._mAtMentionsLinks[t[n].placeholder]=this._createAtMentionLink(t[n],e)}this._oTimelineItemContent=this._createTimelineItemContent();return this};m.prototype.getCollapsedText=function(){this.oExpandLink;this.oCollapseLink;var e=0;var t=0;var n=0;var i="";var r=/@@.\{\d+\}/;var s=this._splitByPlaceholders(this._sTextWithPlaceholders);var a=o.getAtMentionsValues(this._sText,this._sTextWithPlaceholders);do{if(r.test(s[n])){if(a[t].placeholder===s[n]){e+=a[t].value.length;i+=a[t].placeholder;t++}}else{e+=s[n].length;i+=s[n]}n++}while(e<=this.nMaxCollapsedLength);i=i.substring(0,this.nMaxCollapsedLength);var l=i.lastIndexOf(" ");if(l>0){this._sCollapsedTextWithPlaceholders=i.substr(0,l)}else{this._sCollapsedTextWithPlaceholders=i}};m.prototype.createExpandCollapseLink=function(t){var n=new l({id:this.getId()+"-"+t,text:this._oLangBundle.getText(t),press:[function(t){var n=t.getSource().getId();if(n.indexOf("-TE_MORE")>-1){e(this._$CollapsedTextDiv).detach();e(this._$ExpandedTextDiv).prependTo(this._$FeedEntryDiv)}else{e(this._$ExpandedTextDiv).detach();e(this._$CollapsedTextDiv).prependTo(this._$FeedEntryDiv)}this.fireExpandCollapseClick()},this]}).addStyleClass("alignMiddle");return n};m.prototype._shouldTextBeRendered=function(){var e=this.getFeedEntry();if(e.Text==undefined||e.Text==""||e.ConsolidatedCount>1||!t(e.TargetObjectReference)&&(e.TargetObjectReference.Type=="Task"||e.TargetObjectReference.Type=="ForumItem"||e.TargetObjectReference.Type=="Event"||e.TargetObjectReference.FullPath=="ContentItem/BlogEntry"||e.TargetObjectReference.FullPath=="ContentItem/Page"||e.TargetObjectReference.FullPath=="ContentItem/Poll")){return false}else{return true}};m.prototype._shouldContentBeRendered=function(){return this._oTimelineItemContent.getItems().length>0};m.prototype._splitByPlaceholders=function(e){return o.splitByPlaceholders(e)};m.prototype._renderLinks=function(e){var t=/(^|[\s\n]|<br\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi;return e.replace(t,"$1<a href='$2' target='_blank'>$2</a>")};m.prototype._createAtMentionLink=function(e,t){var n=e.value.slice(1);var i=e.placeholder.replace(/[@a-z{}]/g,"");var r=new d({feedId:t.Id,placeholderIndex:i,placeholderValue:e.value});var s=new l({id:"at_mention_link-"+this.getId()+"-"+i,text:"{/placeholderValue}",press:[function(e){this.fireAtMentionClick({link:e.getSource()})},this]}).addStyleClass("sapCollaborationAtMentionLink");s.setModel(r);return s};m.prototype._destroyAtMentionLinks=function(){if(this._mAtMentionsLinks){for(var e in this._mAtMentionsLinks){if(this._mAtMentionsLinks.hasOwnProperty(e)){this._mAtMentionsLinks[e].destroy()}}this._mAtMentionsLinks=undefined}};m.prototype._createTimelineItemContent=function(){var e=new c(this.getId()+"-content",{}).addStyleClass("sapUiTinyMarginTopBottom");var n=this.getFeedEntry();if(!t(n.TargetObjectReference)&&n.TargetObjectReference.Type!==undefined&&n.TargetObjectReference.Type!=="FeedEntry"||n.ConsolidatedCount>1){e.addItem(this._createFeedEntryContent(n))}return e};m.prototype._createFeedEntryContent=function(e){var t="";var n="";var i="";if(e.ConsolidatedCount>1){t="sap-icon://documents";n=this._oLangBundle.getText("TE_CONSOLIDATED_FEED_TEXT");i=e.WebURL}else{i=e.TargetObjectReference.WebURL;switch(e.TargetObjectReference.Type){case"ContentItem":if(e.TargetObjectReference.ContentType){if(e.TargetObjectReference.ContentType.indexOf("image")>-1){var r=new p(this.getId()+"-preview",{src:this.getServiceUrl()+"/FeedEntries('"+e.Id+"')/PreviewImage/$value",press:[function(e){window.open(i,"_blank")},this]});return r}t=a.getSAPIconForMediaType(e.TargetObjectReference.ContentType);n=o.getContentItemName(e.Action,e.ActionWithPlaceholders)}else{switch(e.TargetObjectReference.FullPath){case"ContentItem/Poll":t="sap-icon://horizontal-bar-chart";break;case"ContentItem/Page":t="sap-icon://e-learning";break;case"ContentItem/BlogEntry":t="sap-icon://request";break;default:t="";break}n=e.TargetObjectReference.Title}break;case"ForumItem":t=this._getForumItemIconSrc(e.TargetObjectReference);n=e.TargetObjectReference.Title;break;case"Task":t="sap-icon://task";n=e.TargetObjectReference.Title;break;case"Event":t="sap-icon://calendar";n=e.TargetObjectReference.Title;break;default:t="sap-icon://action";n=e.TargetObjectReference.Title;break}}var s="2.5em";var d=new h({src:t,size:s}).addStyleClass("sapUiTinyMarginBeginEnd");var m=new l({text:n,target:"_blank",href:i,tooltip:n,wrapping:true,width:"95%"}).addStyleClass("RightToLeftParenthesisStyling");var T=new u({});T.addItem(d);var f=new c({width:"100%"}).addStyleClass("sapUiTinyMarginBeginEnd");f.addItem(m);T.addItem(f);return T};m.prototype._getForumItemIconSrc=function(e){var t=e.FullPath;switch(t){case"ForumItem/Inquiry":case"ForumItem/Question":return"sap-icon://question-mark";case"ForumItem/Idea":return"sap-icon://lightbulb";case"ForumItem/Discussion":return"sap-icon://discussion";default:return""}};return m});