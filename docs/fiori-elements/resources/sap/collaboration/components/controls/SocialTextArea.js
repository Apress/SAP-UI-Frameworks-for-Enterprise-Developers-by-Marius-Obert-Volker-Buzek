/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/dom/includeStylesheet","sap/ui/model/json/JSONModel","sap/m/TextArea","sap/m/Popover","sap/m/List","sap/m/StandardListItem","./SuggestionUtility","../utils/LanguageBundle","sap/m/library","sap/ui/Device"],function(e,t,i,n,s,r,o,a,u,h,l){"use strict";var f=h.ListSeparators;var g=h.ListMode;var d=h.PlacementType;t(sap.ui.require.toUrl("sap/collaboration/components/resources/css/SocialTextArea.css"));var _=n.extend("sap.collaboration.components.controls.SocialTextArea",{metadata:{library:"sap.collaboration",properties:{initialValue:{type:"string",group:"Data",defaultValue:null},enableNotifyAll:{type:"boolean",group:"Behavior",defaultValue:true},suggestionPlacement:{type:"sap.m.PlacementType",group:"Misc",defaultValue:d.VerticalPreferedBottom},suggestionHeight:{type:"sap.ui.core.CSSSize",group:"Appearance"}},events:{suggest:{parameters:{value:{type:"string"}}},afterSuggestionClose:{}}},renderer:{apiVersion:2}});_.prototype.init=function(){n.prototype.init.apply(this);this.addStyleClass("sapCollaborationSocialTextArea");this._sTextAreaOldValue="";this._sTextAreaCurrentValue="";this._aAtMentionBuffer=[];this._mCurrentAtMention=undefined;this._oModel=new i;var e=new o({title:"{fullName}",description:"{email}",icon:"{userImage}"});this._oList=new r(this.getId()+"-list",{mode:g.SingleSelectMaster,rememberSelections:false,showSeparators:f.None}).setModel(this._oModel).bindItems("/",e);this._oPop=new s(this.getId()+"-pop",{showHeader:false,showArrow:false,content:[this._oList]}).setInitialFocus(this);this._oSuggestionUtil=a;this._oLangBundle=new u;this._oList.attachSelectionChange(this.onSelectionChange.bind(this))};_.prototype.exit=function(){this._oPop.destroy();this._oPop=undefined;this._oSuggestionUtil=undefined};_.prototype.onBeforeRendering=function(){this._oPop.setPlacement(this.getSuggestionPlacement());this.getEnableNotifyAll()?this._oList.setProperty("noDataText",this._oLangBundle.getText("ST_NO_SUGGESTIONS",["@@notify"])):this._oList.setProperty("noDataText",this._oLangBundle.getText("ST_ADD_POST_NO_SUGGESTIONS"))};_.prototype.onAfterRendering=function(){n.prototype.onAfterRendering.apply(this);this._oPop.setContentWidth(this.$().width()+"px");var t=this.$().children()[0];if(t){e("#"+t.id).css({height:"100%"})}this.$().css({"padding-top":"0","padding-bottom":"0"})};_.prototype.oninput=function(e){n.prototype.oninput.apply(this,[e]);if(e.isMarked("invalid")){return}this._sTextAreaCurrentValue=this.getValue();if(this._sTextAreaCurrentValue.trim()===""){this._aAtMentionBuffer=[];this.closeSuggestionPopover()}else{this._triggerSuggestions(this._sTextAreaCurrentValue,this._sTextAreaOldValue)}this._sTextAreaOldValue=this._sTextAreaCurrentValue};_.prototype.onSelectionChange=function(e){var t=e.getParameter("listItem");var i=t.getProperty("title");var n=t.getProperty("description");this._sTextAreaCurrentValue=this._oSuggestionUtil.getTextAreaValueAfterSuggestionSelected(i,n,this._mCurrentAtMention,this._aAtMentionBuffer,this._sTextAreaCurrentValue,i==="@@notify");this.setValue(this._sTextAreaCurrentValue);this._sTextAreaOldValue=this._sTextAreaCurrentValue;this.closeSuggestionPopover();this.selectText(this._mCurrentAtMention.endIndex+2,this._mCurrentAtMention.endIndex+2);this._oList.removeSelections()};_.prototype.showSuggestions=function(e){if(e.length!==0&&e[e.length-1].fullName!=="@@notify"&&this.getEnableNotifyAll()){e.push({fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"})}if(e.length!==0){this._oPop.close()}this._oModel.setData(e);this._oPop.openBy(this);return this};_.prototype.setInitialValue=function(e){this.setProperty("initialValue",e,true);this.setValue(e);this._aAtMentionBuffer=[];this._sTextAreaCurrentValue=e;this._sTextAreaOldValue=e;return this};_.prototype.setSuggestionHeight=function(e){this.setProperty("suggestionHeight",e,true);this._oPop.setContentHeight(e);return this};_.prototype.closeSuggestionPopover=function(){this._oPop.close();this.fireAfterSuggestionClose();return this};_.prototype.clearText=function(){this._sTextAreaCurrentValue="";this._sTextAreaOldValue="";this._aAtMentionBuffer=[];this.setValue("");return this};_.prototype.convertTextWithFullNamesToEmailAliases=function(){return this._oSuggestionUtil.convertTextWithFullNamesToEmailAliases(this.getValue(),this._aAtMentionBuffer)};_.prototype.atMentionsButtonPressed=function(){var e=this.getDomRef("inner").selectionStart;var t=this._oSuggestionUtil.atMentionsButtonPressed(this.getValue(),e);this.setValue(t.newValue);this._sTextAreaCurrentValue=this.getValue();this.focus();this.selectText(t.cursorPosition,t.cursorPosition);this._triggerSuggestions(this._sTextAreaCurrentValue,this._sTextAreaOldValue);this._sTextAreaOldValue=this._sTextAreaCurrentValue;return this};_.prototype._triggerSuggestions=function(e,t){if(!l.system.phone){var i=this._oSuggestionUtil.getChangesInTextArea(e,t);if(i.operation==="addChar"){this._handleAddedCharacters(i,e)}else if(i.operation==="deleteChar"){this._handleDeletedCharacters(i,e,this._aAtMentionBuffer)}}};_.prototype._handleAddedCharacters=function(e,t){var i=e.changeIndex;var n=e.charactersChanged;var s=this._aAtMentionBuffer.length;var r=this.getEnableNotifyAll();if(r&&n[0]==="@"&&t[i-1]==="@"&&(t[i-2]===" "||t[i-2]==="\n"||t[i-2]===undefined)){this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);for(var o=0;o<s;o++){if(this._aAtMentionBuffer[o].startIndex===i-1){this._aAtMentionBuffer[o].endIndex+=n.length}else if(i<this._aAtMentionBuffer[o].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[o],n.length)}}}else if(n[0]==="@"||n[0]===" "&&n[1]==="@"){if(n[1]==="@"){i+=1}var a=this._oSuggestionUtil.addToAtMentionBuffer(this._aAtMentionBuffer,i,n);this._mCurrentAtMention=this._aAtMentionBuffer[a];if(n==="@ "){this._mCurrentAtMention.endIndex-=1}var u=t[this._mCurrentAtMention.startIndex-1];var h=this._mCurrentAtMention.endIndex+1;if(u===" "||u===undefined||u==="\n"){var l=t[h];while(l!==" "&&l!==undefined&&l!=="\n"){h+=1;l=t[h]}this._mCurrentAtMention.endIndex=h-1;this.fireSuggest({value:t.substring(i+1,h)})}else{this.closeSuggestionPopover()}}else{for(var o=s-1;o>=0;o--){if(i>this._aAtMentionBuffer[o].startIndex){var f=this._oSuggestionUtil.getStringAfterAtMention(i+n.length-1,t,this._aAtMentionBuffer[o]);var g=this._oSuggestionUtil.getStringBeforeAtMention(this._aAtMentionBuffer[o],t,i);var d=g+n+f;var _=new RegExp("^"+d);if(r&&_.test("@notify")){this._aAtMentionBuffer[o].endIndex=this._aAtMentionBuffer[o].endIndex+n.length;this._mCurrentAtMention=this._aAtMentionBuffer[o];this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}])}else if(!d.match(/ /g)||d.match(/ /g)&&d.match(/ /g).length===1){if((this._aAtMentionBuffer[o].atMentioned===true||this._aAtMentionBuffer[o].notifyAll===true)&&i<=this._aAtMentionBuffer[o].endIndex){var p=this._aAtMentionBuffer[o].startIndex;var A=t.slice(0,p)+" "+t.slice(p+1,t.length);this.setValue(A);this._sTextAreaCurrentValue=A;this._aAtMentionBuffer.splice(o,1);this.selectText(i+1,i+1);this.closeSuggestionPopover()}else if(d.search("\n")===-1&&d.search("@")===-1){this._aAtMentionBuffer[o].endIndex=this._aAtMentionBuffer[o].startIndex+d.length;this._mCurrentAtMention=this._aAtMentionBuffer[o];var u=t[this._mCurrentAtMention.startIndex-1];if(u===" "||u===undefined||u==="\n"){this.fireSuggest({value:d})}}else{this.closeSuggestionPopover()}}else{this.closeSuggestionPopover()}break}this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[o],n.length);if(o===0){this.closeSuggestionPopover()}}}};_.prototype._handleDeletedCharacters=function(e,t){var i=e.changeIndex;var n=e.charactersChanged;var s=undefined;var r=this._oSuggestionUtil.isDeletedCharPartOfAtMentioned(this._aAtMentionBuffer,i);if(r!==undefined){if(this._aAtMentionBuffer[r].atMentioned===true||this._aAtMentionBuffer[r].notifyAll===true){this.closeSuggestionPopover();this._sTextAreaCurrentValue=this._sTextAreaCurrentValue.substr(0,this._aAtMentionBuffer[r].startIndex)+this._sTextAreaCurrentValue.substr(this._aAtMentionBuffer[r].endIndex-e.numberOfCharsChanged+1);this.setValue(this._sTextAreaCurrentValue);this.selectText(this._aAtMentionBuffer[r].startIndex,this._aAtMentionBuffer[r].startIndex);this._sTextAreaOldValue=this._sTextAreaCurrentValue;s=1+this._aAtMentionBuffer[r].endIndex-this._aAtMentionBuffer[r].startIndex;this._aAtMentionBuffer.splice(r,1)}else{s=e.numberOfCharsChanged;var o=t[this._aAtMentionBuffer[r].startIndex-1];if(n.search("@")!==-1&&t[e.changeIndex-1]!=="@"){this.closeSuggestionPopover();this._aAtMentionBuffer.splice(r,1)}else if(o===" "||o===undefined||o==="\n"){this._aAtMentionBuffer[r].endIndex-=s;var a=t.substring(this._aAtMentionBuffer[r].startIndex+1,this._aAtMentionBuffer[r].endIndex+1);var u=new RegExp("^"+a);if(a!==""&&u.test("@notify")){this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}])}else{this.fireSuggest({value:a})}}}}r=r||0;s=s||e.numberOfCharsChanged;for(var h=r;h<this._aAtMentionBuffer.length;h++){if(i<this._aAtMentionBuffer[h].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[h],-s)}}};return _});