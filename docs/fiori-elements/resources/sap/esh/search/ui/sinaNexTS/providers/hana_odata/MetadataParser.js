/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../../core/Log","../../sina/AttributeType","../../sina/AttributeFormatType","../../sina/MatchingStrategy","../../core/errors"],function(e,t,a,r,i){function n(e){"@babel/helpers - typeof";return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function o(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function s(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function l(e,t,a){if(t)s(e.prototype,t);if(a)s(e,a);Object.defineProperty(e,"prototype",{writable:false});return e}var u=e["Log"];var c=t["AttributeType"];var d=a["AttributeFormatType"];var y=r["MatchingStrategy"];var f=i["UnknownAttributeTypeError"];var p=i["UnknownPresentationUsageError"];var m;(function(e){e[e["AUTO_FACET"]=0]="AUTO_FACET";e[e["SUGGESTION"]=1]="SUGGESTION"})(m||(m={}));var v;(function(e){e[e["TITLE"]=0]="TITLE";e[e["SUMMARY"]=1]="SUMMARY";e[e["DETAIL"]=2]="DETAIL";e[e["IMAGE"]=3]="IMAGE";e[e["THUMBNAIL"]=4]="THUMBNAIL";e[e["HIDDEN"]=5]="HIDDEN"})(v||(v={}));var h=function(){function e(t){o(this,e);this.log=new u("hana_odata metadata parser");this.provider=t;this.sina=t.sina}l(e,[{key:"_setAnnotationValue",value:function e(t,a,r){var i=a.split(".");var o;var s=t;var l="___temporaryDummyEntriesForArrays___";var u;for(u=0;u<i.length-1;u++){o=i[u];if(s[o]===undefined){s[o]={};s=s[o]}else if(Array.isArray(s[o])){s[l]=s[l]||{};if(!s[l][o]){s[l][o]={};s[o].push(s[l][o])}s=s[l][o]}else if(n(s[o])==="object"){s=s[o]}else if(typeof s[o]==="boolean"){s[o]={};s=s[o]}else{return}}if(u<i.length){o=i[u];if(s[o]===undefined){s[o]=r}else if(Array.isArray(s[o])){if(Array.isArray(r)){s[o]=s[o].concat(r)}else{s[l]=s[l]||{};if(!s[l][o]){s[l][o]=r;s[o].push(s[l][o])}else{for(var c in r){if(!s[l][o][c]){s[l][o][c]=r[c]}}}}}}}},{key:"fillMetadataBuffer",value:function e(t,a){if(t.attributesMetadata[0].id!=="dummy"){return}t.attributesMetadata=[];t.attributeMetadataMap={};var r={dataSourceAnnotations:{},attributeAnnotations:{}};r.dataSourceAnnotations=t.annotations;for(var i in a.attributeMap){try{this.fillPublicMetadataBuffer(t,a.attributeMap[i],r)}catch(e){this.log.error("Attribue "+i+" of DataSource "+t.label+" can not be filled in meta data"+e.toString())}}var n=this.sina._createCDSAnnotationsParser({dataSource:t,cdsAnnotations:r});n.parseCDSAnnotationsForDataSource()}},{key:"fillPublicMetadataBuffer",value:function e(t,a,r){var i=a.displayOrder;var n=r.attributeAnnotations[a.labelRaw]={};for(var o in a.annotationsAttr){n[o]=a.annotationsAttr[o]}var s=this._parseAttributeTypeAndFormat(a,t,a.labelRaw);if(s&&s.type){var l,u,c;var d=this.sina._createAttributeMetadata({id:a.labelRaw,label:a.label||a.labelRaw,isKey:a.isKey||false,isSortable:a.isSortable,usage:this._parseUsage(a,i)||{},type:s.type,format:s.format,matchingStrategy:this._parseMatchingStrategy(a),isHierarchy:!!a.hierarchyDefinition,hierarchyName:a===null||a===void 0?void 0:(l=a.hierarchyDefinition)===null||l===void 0?void 0:l.name,hierarchyDisplayType:a===null||a===void 0?void 0:(u=a.hierarchyDefinition)===null||u===void 0?void 0:u.displayType});if((c=a.hierarchyDefinition)!==null&&c!==void 0&&c.isHierarchyDefinition){var y,f,p,m;t.isHierarchyDefinition=(y=a.hierarchyDefinition)===null||y===void 0?void 0:y.isHierarchyDefinition;t.hierarchyName=(f=a.hierarchyDefinition)===null||f===void 0?void 0:f.name;t.hierarchyAttribute=(p=a.hierarchyDefinition)===null||p===void 0?void 0:p.attributeName;t.hierarchyDisplayType=(m=a.hierarchyDefinition)===null||m===void 0?void 0:m.displayType}else{var v;var h=(v=a.hierarchyDefinition)===null||v===void 0?void 0:v.name;if(h&&h!==t.id){t.hierarchyHelperDatasource=this.sina.getDataSource(h)}}d._private.semanticObjectType=a.SemanticObjectTypeId;t.attributesMetadata.push(d);t.attributeMetadataMap[d.id]=d}}},{key:"_parseMatchingStrategy",value:function e(t){if(t.supportsTextSearch===true){return y.Text}return y.Exact}},{key:"_parseAttributeTypeAndFormat",value:function e(t,a,r){for(var i=0;i<t.presentationUsage.length;i++){var n=t.presentationUsage[i]||"";switch(n.toUpperCase()){case"SUMMARY":continue;case"DETAIL":continue;case"TITLE":continue;case"HIDDEN":continue;case"FACTSHEET":continue;case"THUMBNAIL":case"IMAGE":return{type:c.ImageUrl};case"LONGTEXT":return{type:c.String,format:d.LongText};default:throw new p("Unknown presentation usage "+n)}}switch(t.type){case"Edm.Binary":if(t.annotationsAttr){if(t.annotationsAttr.SEMANTICS&&t.annotationsAttr.SEMANTICS.CONTACT&&t.annotationsAttr.SEMANTICS.CONTACT.PHOTO||t.annotationsAttr.SEMANTICS&&t.annotationsAttr.SEMANTICS.IMAGEURL){return{type:c.ImageBlob}}}return{type:c.String};break;case"Edm.String":case"Edm.PrimitiveType":case"Edm.Boolean":case"Edm.Byte":case"Edm.Guid":return{type:c.String};case"Edm.Double":case"Edm.Decimal":case"Edm.Float":case"Edm.Single":case"Edm.SingleRange":return{type:c.Double};case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":return{type:c.Integer};case"Edm.Time":return{type:c.Time};case"Edm.Date":return{type:c.Date};case"Edm.DateTime":case"Edm.DateTimeOffset":if(t.TypeLength!==undefined&&t.TypeLength<=8){return{type:c.Date}}return{type:c.Timestamp};case"Collection(Edm.String)":return{type:c.String};case"Edm.GeometryPoint":return{type:c.GeoJson};case"Edm.GeographyPoint":return{type:c.GeoJson};case"GeoJson":return{type:c.GeoJson};default:if(t.type&&t.type.startsWith("Collection")){this.log.warn("Unsupported data type "+t.type+" of attribute "+t.labelRaw+" in "+a.label);return{type:c.String}}throw new f("Unsupported oData type "+t.type+" of attribute "+(t.labelRaw||r)+" in "+a.label+". "+"Please only use supported oData types in search model: "+"Edm.String, Edm.Boolean, "+"Edm.Double, Edm.Decimal, Edm.Float, Edm.Single, Edm.SingleRange, Edm.Int16, Edm.Int32, Edm.Int63, "+"Edm.Time, Edm.Date, Edm.DateTime, Edm.DateTimeOffset, "+"Edm.Byte, Edm.Binary, Edm.Guid, Edm.GeometryPoint, GeoJson.")}}},{key:"_parseUsage",value:function e(t,a){var r={};for(var i=0;i<t.presentationUsage.length;i++){var n=t.presentationUsage[i].toUpperCase()||"";if(n==="TITLE"){r.Title={displayOrder:a}}if(n==="SUMMARY"||n==="DETAIL"||n==="IMAGE"||n==="THUMBNAIL"||n==="LONGTEXT"){r.Detail={displayOrder:a}}}if(t.isFacet){r.AdvancedSearch={displayOrder:t.facetPosition||a||100,iconUrlAttributeName:t.facetIconUrlAttributeName};r.Facet={displayOrder:t.facetPosition||a||100,iconUrlAttributeName:t.facetIconUrlAttributeName}}if(t.isFilteringAttribute){r.AdvancedSearch={displayOrder:t.facetPosition||a||100,iconUrlAttributeName:t.facetIconUrlAttributeName}}return r}},{key:"parseDynamicMetadata",value:function e(t){var a=t.data;if(!a){return}var r=a["@com.sap.vocabularies.Search.v1.Metadata"];if(!r){return}for(var i in r){var n=r[i];for(var o in n){if(o==="$Kind"){continue}var s=n[o];this.parseDynamicAttributeMetadata(this.sina.getDataSource(i),o,s)}}}},{key:"parseDynamicAttributeMetadata",value:function e(t,a,r){var i=this._parseAttributeTypeAndFormat({presentationUsage:[],type:r.$Type},t,a);var n;try{n=t.getAttributeMetadata(a)}catch(e){}if(n){var o,s;if(!n._private.dynamic){return}n.label=r["@SAP.Common.Label"];n.type=i.type;n.format=i===null||i===void 0?void 0:i.format;n.usage=r["@EnterpriseSearch.filteringFacet.default"]===true?{Facet:{displayOrder:r["@EnterpriseSearch.filteringFacet.displayPosition"]||((o=n.usage)===null||o===void 0?void 0:(s=o.Facet)===null||s===void 0?void 0:s.displayOrder)||20,iconUrlAttributeName:r["@EnterpriseSearch.filteringFacet.iconUrl"]||n.iconUrlAttributeName||""}}:{};n.isSortable=r["@EnterpriseSearchHana.isSortable"]||n.isSortable||false}else{n=this.sina._createAttributeMetadata({id:a,label:r["@SAP.Common.Label"],isKey:false,isSortable:r["@EnterpriseSearchHana.isSortable"]||false,usage:r["@EnterpriseSearch.filteringFacet.default"]===true?{Facet:{displayOrder:r["@EnterpriseSearch.filteringFacet.displayPosition"]||20,iconUrlAttributeName:r["@EnterpriseSearch.filteringFacet.iconUrl"]||""}}:{},type:i.type,format:i===null||i===void 0?void 0:i.format,matchingStrategy:y.Exact,_private:{dynamic:true}});t.attributesMetadata.push(n);t.attributeMetadataMap[n.id]=n}}},{key:"getUniqueDataSourceFromSearchResult",value:function e(t){var a=t.data;if(!a){return}var r=a.value;if(!r){return}var i,n;for(var o=0;o<r.length;++o){var s=r[o];var l=s["@odata.context"];if(!l){return}i=l.split("#")[1];if(!i){return}if(n&&n!==i){return}n=i}return this.sina.getDataSource(i)}}]);return e}();var b={__esModule:true};b.MetadataParser=h;return b})})();