/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../../sina/SearchQuery","./typeConverter","../../sina/LogicalOperator","../../sina/ComparisonOperator","../../core/Log","../../core/errors","./HierarchyParser"],function(e,a,r,t,o,i,n){function s(e){"@babel/helpers - typeof";return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function c(e,a){if(!(e instanceof a)){throw new TypeError("Cannot call a class as a function")}}function u(e,a){for(var r=0;r<a.length;r++){var t=a[r];t.enumerable=t.enumerable||false;t.configurable=true;if("value"in t)t.writable=true;Object.defineProperty(e,t.key,t)}}function l(e,a,r){if(a)u(e.prototype,a);if(r)u(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}
/*!
   * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
   */var v=e["SearchQuery"];var p=r["LogicalOperator"];var m=t["ComparisonOperator"];var f=o["Log"];var d=i["FacetsParseError"];var y=i["InternalServerError"];var h=n["HierarchyParser"];var b=function(){function e(a){c(this,e);this.provider=a;this.sina=a.sina;this.log=new f("hana_odata facet parser")}l(e,[{key:"parse",value:function e(a,r){try{const e=this;var t=new h;var o=r["@com.sap.vocabularies.Search.v1.Facets"];if(r.error&&!o){return Promise.reject(new y(r.error.message))}if(!o){return Promise.resolve([])}if(r.error){e.log.warn("Server-side Warning: "+r.error.message)}var i=[];for(var n=0;n<o.length;n++){var s=o[n];var c=void 0;if(a.filter.dataSource===a.sina.getAllDataSource()){try{c=e.parseDataSourceFacet(a,s)}catch(a){e.log.warn("Error occurred by parsing dataource item number "+n+": "+a.message);continue}}else{if(a.filter.dataSource.type===a.sina.DataSourceType.Category){continue}if(s["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyType==="GeometryPolygonFacet"){continue}try{var u=e.parseFacetAttribute(a,s);if(u.isHierarchy){c=t.parseHierarchyFacet(a,u,s)}else{c=e.parseChartFacet(a,u,s)}}catch(a){var l="";if(s.Items&&Array.isArray(s.Items)){l=JSON.stringify(s)}e.log.warn("Error occurred by parsing facet "+(s["@com.sap.vocabularies.Common.v1.Label"]||"")+"', facet position: "+n+": "+a.message+"; item data: "+l);continue}}i.push(c)}return Promise.all(i)}catch(e){return Promise.reject(e)}}},{key:"parseDataSourceFacet",value:function e(a,r){var t=a;if(a instanceof v){t=this.sina.createDataSourceQuery({dataSource:a.filter.dataSource,filter:a.filter.clone()})}var o=[];for(var i=0;i<r.Items.length;i++){var n=r.Items[i];var s=this.sina.getDataSource(n.scope);if(!s){s=this.sina.createDataSource({type:this.sina.DataSourceType.Category,id:n.ValueLow,label:n.Description})}o.push(this.sina._createDataSourceResultSetItem({dataSource:s,dimensionValueFormatted:s.labelPlural,measureValue:n._Count,measureValueFormatted:n._Count.toString()}))}var c=this.sina._createDataSourceResultSet({title:a.filter.dataSource.label,items:o,query:t});if(a instanceof v){return t._setResultSet(c)}return c}},{key:"createAttributeFilterCondition",value:function e(r,t,o){if(s(o[r])==="object"&&(Object.prototype.hasOwnProperty.call(o[r],"From")||Object.prototype.hasOwnProperty.call(o[r],"From"))){var i=this.sina.createComplexCondition({attributeLabel:t.label,valueLabel:this.formatFacetValue(o[r]),operator:p.And,conditions:[]});var n,c;if(!o[r].From){c=this.sina.createSimpleCondition({attribute:r,operator:m.Le,value:a.odata2Sina(t.type,o[r].To)});i.conditions.push(c)}else if(!o[r].To){n=this.sina.createSimpleCondition({attribute:r,operator:m.Ge,value:a.odata2Sina(t.type,o[r].From)});i.conditions.push(n)}else{n=this.sina.createSimpleCondition({attribute:r,operator:m.Ge,value:a.odata2Sina(t.type,o[r].From)});i.conditions.push(n);c=this.sina.createSimpleCondition({attribute:r,operator:m.Le,value:a.odata2Sina(t.type,o[r].To)});i.conditions.push(c)}return i}var u=a.odata2Sina(t.type,o[r]);var l=o[r+"@com.sap.vocabularies.Common.v1.Text"];if(typeof l==="string"&&l.length>0){if(l.startsWith("sap-icon://")===false){u=l}}return this.sina.createSimpleCondition({attributeLabel:t.label,attribute:r,value:o[r],valueLabel:u})}},{key:"formatFacetValue",value:function e(a){var r="";if(a["@com.sap.vocabularies.Common.v1.Label"]){return a["@com.sap.vocabularies.Common.v1.Label"]}if(s(a)==="object"&&(Object.prototype.hasOwnProperty.call(a,"From")||Object.prototype.hasOwnProperty.call(a,"To"))){a=(a.From||r)+"..."+(a.To||r)}return a}},{key:"parseFacetAttribute",value:function e(a,r){var t=a.filter.dataSource;var o="";if(a.dimension){o=a.dimension}else{if(r["@com.sap.vocabularies.Search.v1.Facet"]&&r["@com.sap.vocabularies.Search.v1.Facet"].Dimensions&&r["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0]&&r["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName){o=r["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName}else{throw new d("parse error facets")}}var i=t.getAttributeMetadata(o);return i}},{key:"parseChartFacet",value:function e(a,r,t){var o,i;var n=a.filter.dataSource;var s=[];var c=a;var u=a.filter.clone();u.setDataSource(n);u.setRootCondition(a.filter.rootCondition.clone());c=this.sina.createChartQuery({filter:u,dimension:r.id});var l=((o=r.usage)===null||o===void 0?void 0:(i=o.AdvancedSearch)===null||i===void 0?void 0:i.iconUrlAttributeName)||r.id+"@com.sap.vocabularies.Common.v1.Text";var p=t.Items.findIndex(function(e){var a;return(a=e[l])===null||a===void 0?void 0:a.startsWith("sap-icon://")})>-1;for(var m=0;m<t.Items.length;m++){var f=t.Items[m];var d=f[r.id+"@com.sap.vocabularies.Common.v1.Text"];var y="";if(p===true){y="sap-icon://none"}var h=this.formatFacetValue(f[r.id]);if(typeof d==="string"&&d.length>0){if(d.startsWith("sap-icon://")){y=d}else{var b,S;h=d;y=f[(b=r.usage)===null||b===void 0?void 0:(S=b.AdvancedSearch)===null||S===void 0?void 0:S.iconUrlAttributeName]||y}}else{var g,C;y=f[(g=r.usage)===null||g===void 0?void 0:(C=g.AdvancedSearch)===null||C===void 0?void 0:C.iconUrlAttributeName]||y}s.push(this.sina._createChartResultSetItem({filterCondition:this.createAttributeFilterCondition(r.id,r,f),dimensionValueFormatted:h,measureValue:f._Count,measureValueFormatted:f._Count,icon:y}))}var F=this.sina._createChartResultSet({title:r.label,items:s,query:c});if(a instanceof v){return c._setResultSet(F)}return F}}]);return e}();var S={__esModule:true};S.FacetParser=b;return S})})();