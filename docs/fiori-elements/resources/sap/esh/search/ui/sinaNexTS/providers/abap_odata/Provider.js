/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["./ajax","./ajaxTemplates","./conditionSerializer","../../core/core","./dataSourceSerializer","./labelCalculation","./suggestionTermSplitter","../AbstractProvider","./FacetParser","./ItemParser","./NlqParser","./suggestionParser","./UserEventLogger","./MetadataParser","../../core/errors"],function(e,t,r,i,a,n,s,o,u,l,c,d,f,h,v){function p(e){return b(e)||g(e)||y(e)||S()}function S(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function y(e,t){if(!e)return;if(typeof e==="string")return m(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return m(e,t)}function g(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function b(e){if(Array.isArray(e))return m(e)}function m(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function P(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function O(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||false;i.configurable=true;if("value"in i)i.writable=true;Object.defineProperty(e,i.key,i)}}function C(e,t,r){if(t)O(e.prototype,t);if(r)O(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}function E(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)x(e,t)}function x(e,t){x=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return x(e,t)}function Q(e){var t=T();return function r(){var i=I(e),a;if(t){var n=I(this).constructor;a=Reflect.construct(i,arguments,n)}else{a=i.apply(this,arguments)}return j(this,a)}}function j(e,t){if(t&&(typeof t==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return A(e)}function A(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function T(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function I(e){I=Object.setPrototypeOf?Object.getPrototypeOf.bind():function e(t){return t.__proto__||Object.getPrototypeOf(t)};return I(e)}function N(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}
/*!
   * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
   */var w=e["createAjaxClient"];var R=o["AbstractProvider"];var q=u["FacetParser"];var _=l["ItemParser"];var F=c["NlqParser"];var k=d["SuggestionParser"];var D=f["UserEventLogger"];var H=h["MetadataParser"];var z=v["ESHNotActiveError"];var M=v["NotImplementedError"];var V=function(e){E(u,e);var o=Q(u);function u(){var e;P(this,u);for(var t=arguments.length,r=new Array(t),i=0;i<t;i++){r[i]=arguments[i]}e=o.call.apply(o,[this].concat(r));N(A(e),"id","abap_odata");return e}C(u,[{key:"initAsync",value:function e(t){var r,a=this;this.contentProviderId=t.contentProviderId;this.requestPrefix=t.url||"/sap/opu/odata/sap/ESH_SEARCH_SRV";this.sina=t.sina;this.ajaxClient=(r=t.ajaxClient)!==null&&r!==void 0?r:w();this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=n.createLabelCalculator();this.userEventLogger=new D(this);this.metadataParser=new H(this);this.itemParser=new _(this);this.nlqParser=new F(this);this.facetParser=new q(this);this.suggestionParser=new k(this,this.itemParser);this.sessionId=i.generateGuid();this.sorsNavigationTargetGenerator=this.sina._createSorsNavigationTargetGenerator({urlPrefix:"#Action-search&/top=10&filter=",getPropertyMetadata:function e(t){return{name:t.id,label:t.label,semanticObjectType:t._private.semanticObjectType,response:!!(t.usage&&(t.usage.Detail||t.usage.Title)),request:true}}});return this.loadServerInfo().then(function(e){a.serverInfo=e.d.results[0];if(!a.supports("Search")){return Promise.reject(new z("Enterprise Search is not active"))}return a.loadBusinessObjectDataSources()}).then(function(){return{capabilities:a.sina._createCapabilities({fuzzy:false})}})}},{key:"supports",value:function e(t,r){if(t==="misc"){var i="";if(r==="InteractionEventLists"){i="Schema[Namespace=ESH_SEARCH_SRV]>EntityContainer[Name=ESH_SEARCH_SRV_Entities]>EntitySet[Name=InteractionEventLists]"}if(r==="NavigationEvents"){i="Schema[Namespace=ESH_SEARCH_SRV]>EntityContainer[Name=ESH_SEARCH_SRV_Entities]>EntitySet[Name=NavigationEvents]"}if(i.length!==0){var a=this.serviceXML.querySelectorAll(i);return a.length>0}}for(var n=0;n<this.serverInfo.Services.results.length;++n){var s=this.serverInfo.Services.results[n];if(s.Id==t){if(!r){return true}for(var o=0;o<s.Capabilities.results.length;++o){var u=s.Capabilities[o];if(u.Capability===r){return true}}}}return false}},{key:"loadServerInfo",value:function e(){var t=this;var r=this.buildQueryUrl(this.requestPrefix,"/ServerInfos?$expand=Services/Capabilities");var i=this.buildQueryUrl(this.requestPrefix,"/$metadata");var a=this.ajaxClient.getJson(r);var n=this.ajaxClient.getXML(i);return Promise.all([a,n]).then(function(e){var r=e[0];var i=e[1];if(typeof window!=="undefined"){var a=new DOMParser;var n=a.parseFromString(i,"text/xml");if(n.documentElement.nodeName!="parsererror"){t.serviceXML=n}}else{var s=require("jsdom");var o=new s.JSDOM(i);t.serviceXML=o.window.document}return r.data})}},{key:"loadBusinessObjectDataSources",value:function e(){var t="/DataSources?$expand=Annotations,Attributes/UIAreas,Attributes/Annotations&$filter=Type eq 'View'";if(this.serviceXML){var r="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>NavigationProperty[Name=Annotations],"+"Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSourceAttribute]>NavigationProperty[Name=Annotations]";var i=this.serviceXML.querySelectorAll(r);if(i.length!=2){t="/DataSources?$expand=Attributes/UIAreas&$filter=Type eq 'View'"}var a="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>Property[Name=IsInternal]";if(this.isQueryPropertySupported(a)){t=t+" and IsInternal eq false"}}var n=this.buildQueryUrl(this.requestPrefix,t);return this.ajaxClient.getJson(n).then(function(e){var t=e.data.d.results;this.metadataParser.parseDataSourceData(t,this.sorsNavigationTargetGenerator);this.sorsNavigationTargetGenerator.finishRegistration()}.bind(this))}},{key:"assembleOrderBy",value:function e(t){var r=[];for(var i=0;i<t.sortOrder.length;++i){var a=t.sortOrder[i];var n=a.order===this.sina.SortOrder.Descending?"desc":"asc";r.push({AttributeId:a.id,SortOrder:n})}return r}},{key:"executeSearchQuery",value:function e(i){var n,s;var o=t.searchRequest;if(i.nlq){o=t.nlqSearchRequest}var u="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=SearchOptions]>Property[Name=ClientServiceName]";if(!this.isQueryPropertySupported(u)){delete o.d.QueryOptions.ClientServiceName}o=JSON.parse(JSON.stringify(o));var l=i.filter.rootCondition.clone();var c=r.serialize(i.filter.dataSource,l);if(c.SubFilters.length!==0){o.d.Filter=c}else{delete o.d.Filter}o.d.DataSources=a.serialize(i.filter.dataSource);o.d.QueryOptions.SearchTerms=i.filter.searchTerm;o.d.QueryOptions.Top=i.top;o.d.QueryOptions.Skip=i.skip;o.d.OrderBy=this.assembleOrderBy(i);this.addSessionId(o);if(!i.calculateFacets){delete o.d.MaxFacetValues;delete o.d.Facets}else{o.d.MaxFacetValues=5;o.d.Facets=[{Values:[]}]}var d=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");return this.ajaxClient.postJson(d,o).then(function(e){s=e;return this.metadataParser.parseDynamicMetadata(s.data.d)}.bind(this)).then(function(){return this.itemParser.parse(i,s.data.d)}.bind(this)).then(function(e){n=e;return this.facetParser.parse(i,s.data.d)}.bind(this)).then(function(e){var t=this.nlqParser.parse(s.data.d);var r=t.success?t.description:"Search Result List";return this.sina._createSearchResultSet({id:s.data.d.ResultList.ExecutionID,title:r,query:i,items:n,nlqSuccess:t.success,totalCount:s.data.d.ResultList.TotalHits,facets:e})}.bind(this)).then(function(e){this.sorsNavigationTargetGenerator.generateNavigationTargets(e);return e}.bind(this))}},{key:"executeChartQuery",value:function e(i){var n="";var s;var o=i.filter.rootCondition.clone();var u;if(this.decideValueHelp(i)){s=JSON.parse(JSON.stringify(t.valueHelperRequest));this.removeClientOptions(s);s.d.ValueHelpAttribute=i.dimension;u=r.serialize(i.filter.dataSource,o);if(u.SubFilters.length!==0){s.d.Filter=u}else{delete s.d.Filter}s.d.ValueFilter=this.getFilterValueFromConditionTree(i.dimension,u);s.d.QueryOptions.SearchTerms=i.filter.searchTerm;s.d.DataSources=a.serialize(i.filter.dataSource);n=this.buildQueryUrl(this.requestPrefix,"/ValueHelpQueries")}else{s=JSON.parse(JSON.stringify(t.chartRequest));u=r.serialize(i.filter.dataSource,o);if(u.SubFilters.length!==0){s.d.Filter=u}else{delete s.d.Filter}s.d.DataSources=a.serialize(i.filter.dataSource);s.d.QueryOptions.SearchTerms=i.filter.searchTerm;s.d.QueryOptions.Skip=0;this.addSessionId(s);s.d.FacetRequests=[{DataSourceAttribute:i.dimension}];s.d.MaxFacetValues=i.top;n=this.buildQueryUrl(this.requestPrefix,"/SearchQueries")}return this.ajaxClient.postJson(n,s).then(function(e){return this.facetParser.parse(i,e.data.d)}.bind(this)).then(function(e){if(e.length>0){return e[0]}return this.sina._createChartResultSet({title:i.filter.dataSource.getAttributeMetadata(i.dimension).label,items:[],query:i})}.bind(this))}},{key:"executeHierarchyQuery",value:function e(t){throw new M}},{key:"decideValueHelp",value:function e(t){var r=t.filter.rootCondition.conditions;for(var i=0;i<r.length;i++){if(t.filter._getAttribute(r[i])===t.dimension){return true}}return false}},{key:"executeSuggestionQuery",value:function e(t){try{const e=this;return Promise.all([e.executeRegularSuggestionQuery(t),e.executeObjectSuggestionQuery(t)]).then(function(e){var r=[];r.push.apply(r,p(e[1]));r.push.apply(r,p(e[0]));return this.sina._createSuggestionResultSet({title:"Suggestions",query:t,items:r})}.bind(e))}catch(e){return Promise.reject(e)}}},{key:"isObjectSuggestionQuery",value:function e(t){return t.types.indexOf("Object")>=0&&t.filter.dataSource.type===t.sina.DataSourceType.BusinessObject}},{key:"executeObjectSuggestionQuery",value:function e(i){var n=this;if(!this.supports("ObjectSuggestions")||!this.isObjectSuggestionQuery(i)){return Promise.resolve([])}var s=JSON.parse(JSON.stringify(t.objectSuggestionRequest));var o=i.filter.rootCondition.clone();var u=r.serialize(i.filter.dataSource,o);if(u.SubFilters.length!==0){s.d.Filter=u}else{delete s.d.Filter}s.d.DataSources=a.serialize(i.filter.dataSource);s.d.QueryOptions.Top=i.top;s.d.QueryOptions.Skip=i.skip;s.d.QueryOptions.SearchTerms=i.filter.searchTerm;this.addSessionId(s);var l=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(l,s).then(function(e){return n.suggestionParser.parseObjectSuggestions(i,e.data)})}},{key:"executeRegularSuggestionQuery",value:function e(i){var n=this;var o=JSON.parse(JSON.stringify(t.suggestionRequest));var u=i.filter.searchTerm;var l=s.split(this,u);var c=i.filter.rootCondition.clone();var d=r.serialize(i.filter.dataSource,c);if(d.SubFilters.length!==0){o.d.Filter=d}else{delete o.d.Filter}o.d.DataSources=a.serialize(i.filter.dataSource);o.d.QueryOptions.Top=i.top;o.d.QueryOptions.Skip=i.skip;o.d.SuggestionInput=l.suggestionTerm;o.d.QueryOptions.SearchTerms=l.searchTerm===null?"":l.searchTerm;if(!this.includeSuggestionTypes(i,o)){return[]}this.addSessionId(o);var f=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(f,o).then(function(e){return n.suggestionParser.parseRegularSuggestions(i,e.data)}).then(function(e){s.concatenate(n,l,e);return e})}},{key:"includeSuggestionTypes",value:function e(t,r){var i={SearchTerm:{Data:"IncludeAttributeSuggestions",History:"IncludeHistorySuggestions"},Object:{},DataSource:{Data:"IncludeDataSourceSuggestions"}};var a=t.types;var n=t.calculationModes;var s=false;for(var o=0;o<a.length;o++){var u=a[o];for(var l=0;l<n.length;l++){var c=n[l];var d=i[u][c];if(typeof d==="undefined"){continue}r.d[d]=true;s=true}}return s}},{key:"addSessionId",value:function e(t){t.d.QueryOptions.ClientSessionID=this.sessionId;var r=(new Date).getTime();t.d.QueryOptions.ClientCallTimestamp="\\/Date("+r+")\\/"}},{key:"removeClientOptions",value:function e(t){delete t.d.QueryOptions.ClientSessionID;delete t.d.QueryOptions.ClientCallTimestamp;delete t.d.QueryOptions.ClientServiceName;delete t.d.QueryOptions.ClientLastExecutionID}},{key:"getFilterValueFromConditionTree",value:function e(t,r){if(r.ConditionAttribute&&r.ConditionAttribute===t){return r.ConditionValue}else if(r.SubFilters){var i;var a=null;for(i=0;a===null&&i<r.SubFilters.length;i++){a=this.getFilterValueFromConditionTree(t,r.SubFilters[i])}return a}return null}},{key:"getConfigurationAsync",value:function e(){var t=this;var r=this.buildQueryUrl(this.requestPrefix,"/PersonalizedSearchMainSwitches?$filter=Selected eq true");return this.ajaxClient.getJson(r).then(function(e){var i={personalizedSearch:false,isPersonalizedSearchEditable:false};switch(e.data.d.results[0].MainSwitch){case 3:i.isPersonalizedSearchEditable=true;break;case 4:i.isPersonalizedSearchEditable=true;break;case 2:i.isPersonalizedSearchEditable=false;break;case 1:i.isPersonalizedSearchEditable=false;break}r=t.buildQueryUrl(t.requestPrefix,"/Users('<current>')");return t.ajaxClient.getJson(r).then(function(e){if(e.data.d.IsEnabledForPersonalizedSearch){i.personalizedSearch=true}return this.sina._createConfiguration(i)}.bind(t))})}},{key:"saveConfigurationAsync",value:function e(t){var r={IsEnabledForPersonalizedSearch:t.personalizedSearch};var i=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(i,r)}},{key:"resetPersonalizedSearchDataAsync",value:function e(){var t={ClearPersonalizedSearchHistory:true};var r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,t)}},{key:"logUserEvent",value:function e(t){return this.userEventLogger.logUserEvent(t)}},{key:"buildQueryUrl",value:function e(t,r){if(typeof window==="undefined"){return t+r}var i=window.location.href;var a="";var n;var s="";var o="";n=i.indexOf("esh-system=sid(");if(n!==-1){var u=i.substring(n).indexOf(")");if(u!==-1){s=i.substring(n+15,n+u);if(s.length!==0){o=";o=sid("+s+")"}}}if(s.length===0){n=i.indexOf("esh-system=");if(n!==-1){var l=i.substring(n).indexOf("&");var c=i.substring(n).indexOf("#");if(l!==-1&&c!==-1){if(l<c){s=i.substring(n+11,n+l)}else{s=i.substring(n+11,n+c)}}if(l!==-1&&c===-1){s=i.substring(n+11,n+l)}if(l===-1&&c!==-1){s=i.substring(n+11,n+c)}if(l===-1&&c===-1){s=i.substring(n+11)}}if(s.length!==0){o=";o="+s}}a=t+o+r;return a}},{key:"getDebugInfo",value:function e(){return"Searchsystem: ".concat(this.serverInfo.SystemId," Client: ").concat(this.serverInfo.Client," ESH Search API Provider: ").concat(this.id)}},{key:"isQueryPropertySupported",value:function e(t){if(this.serviceXML===undefined){return false}var r=this.serviceXML.querySelectorAll(t);if(r.length>0){return true}return false}}]);return u}(R);var U={__esModule:true};U.Provider=V;return U})})();