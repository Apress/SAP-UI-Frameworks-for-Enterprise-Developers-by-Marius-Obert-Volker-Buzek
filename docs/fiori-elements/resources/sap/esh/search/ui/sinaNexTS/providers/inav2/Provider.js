/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){function e(e,t,r){if(r){return t?t(e):e}if(!e||!e.then){e=Promise.resolve(e)}return t?e.then(t):e}sap.ui.define(["../AbstractProvider","../../core/core","./conditionSerializer","./dataSourceSerializer","../../core/util","../../core/lang","../../core/ajax","./ajaxTemplates","./labelCalculation","./pivotTableParser","./suggestionParser","./suggestionTermSplitter","./UserEventLogger","./MetadataParser","./ItemParser","./FacetParser","../../sina/AttributeType","../../core/errors"],function(t,r,a,s,i,n,o,u,c,l,d,f,h,p,g,v,S,y){function b(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function m(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}function R(e,t,r){if(t)m(e.prototype,t);if(r)m(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}function P(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)C(e,t)}function C(e,t){C=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return C(e,t)}function D(e){var t=I();return function r(){var a=T(e),s;if(t){var i=T(this).constructor;s=Reflect.construct(a,arguments,i)}else{s=a.apply(this,arguments)}return O(this,s)}}function O(e,t){if(t&&(typeof t==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return q(e)}function q(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function I(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function T(e){T=Object.setPrototypeOf?Object.getPrototypeOf.bind():function e(t){return t.__proto__||Object.getPrototypeOf(t)};return T(e)}function j(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}
/*!
   * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
   */var k=t["AbstractProvider"];var E=o["Client"];var x=h["UserEventLogger"];var L=p["MetadataParser"];var z=g["ItemParser"];var M=v["FacetParser"];var A=S["AttributeType"];var _=y["ESHNotActiveError"];var w=y["NotImplementedError"];var N=function(t){P(h,t);var o=D(h);function h(){var e;b(this,h);for(var t=arguments.length,r=new Array(t),a=0;a<t;a++){r[a]=arguments[a]}e=o.call.apply(o,[this].concat(r));j(q(e),"id","inav2");return e}R(h,[{key:"initAsync",value:function e(t){var a,s=this;this.urlPrefix="/sap/es/ina";this.getServerInfoUrl=this.urlPrefix+"/GetServerInfo";this.getResponseUrl=this.urlPrefix+"/GetResponse";this.sina=t.sina;var i;if(typeof t.getLanguage==="function"){i={csrf:true,csrfByPassCache:true,getLanguage:t.getLanguage}}else{i={csrf:true,csrfByPassCache:true}}this.ajaxClient=(a=t.ajaxClient)!==null&&a!==void 0?a:new E(i);this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=c.createLabelCalculator();this.userEventLogger=new x(this);this.metadataParser=new L(this);this.itemParser=new z(this);this.facetParser=new M(this);this.executeSearchQuery=this.addMetadataLoadDecorator(this.executeSearchQuery);this.executeChartQuery=this.addMetadataLoadDecorator(this.executeChartQuery);this.executeSuggestionQuery=this.addMetadataLoadDecorator(this.executeSuggestionQuery);this.sessionId=r.generateGuid();return this.loadServerInfo().then(function(e){s.serverInfo=e;s.userEventLogger.delayedInit();if(!s.supports("Search")){return Promise.reject(new _("Enterprise Search is not active"))}return s.loadBusinessObjectDataSources()}).then(function(){return{capabilities:s.sina._createCapabilities({fuzzy:s.supports("Search","OptionFuzzy")})}})}},{key:"addMetadataLoadDecorator",value:function e(t){return function(){for(var e=arguments.length,r=new Array(e),a=0;a<e;a++){r[a]=arguments[a]}var s=r[0];var i=s.filter.dataSource;return Promise.resolve().then(function(){return this.loadMetadata(i)}.bind(this)).then(function(){return t.apply(this,r)}.bind(this))}.bind(this)}},{key:"loadMetadata",value:function e(t){if(t.type===this.sina.DataSourceType.Category){return Promise.resolve()}var r=this.metadataLoadPromises[t.id];if(r){return r}u.loadDataSourceMetadataRequest.DataSource.ObjectName=t.id;this.addLanguagePreferences(u.loadDataSourceMetadataRequest);r=this.ajaxClient.postJson(this.getResponseUrl,u.loadDataSourceMetadataRequest).then(function(e){this.metadataParser.parseMetadataRequestMetadata(t,e.data)}.bind(this));this.metadataLoadPromises[t.id]=r;return r}},{key:"supports",value:function e(t,r){for(var a=0;a<this.serverInfo.Services.length;++a){var s=this.serverInfo.Services[a];if(s.Service==t){if(!r){return true}for(var i=0;i<s.Capabilities.length;++i){var n=s.Capabilities[i];if(n.Capability===r){return true}}}}return false}},{key:"loadServerInfo",value:function e(){return this.ajaxClient.getJson(this.getServerInfoUrl).then(function(e){return e.data})}},{key:"loadBusinessObjectDataSources",value:function e(){var t=this;t.addLanguagePreferences(u.loadDataSourcesRequest);if(t.supports("Search","PluralDescriptionForDataSource")){u.loadDataSourcesRequest.Search.NamedValues.push({AttributeName:"DescriptionPlural",Name:"DescriptionPlural"})}return t.ajaxClient.postJson(t.getResponseUrl,u.loadDataSourcesRequest).then(function(e){t._processDataSourcesResponse(e,false)},function(){var e=t.serverInfo.ServerInfo.SystemId+t.serverInfo.ServerInfo.Client+"~ESH_CONNECTOR~";u.fallbackLoadDataSourcesRequest.DataSource.ObjectName=e;return t.ajaxClient.postJson(t.getResponseUrl,u.fallbackLoadDataSourcesRequest).then(function(e){t._processDataSourcesResponse(e,true)})})}},{key:"_processDataSourcesResponse",value:function e(t,a){var s=l.parse(t.data);var i=s.axes[0];for(var n=0;n<i.length;++n){var o=i[n];var u="";var c="";var d="";if(!a){if(r.isObject(o.Description)){u=o.Description.Value}else{u=o.Description}if(r.isObject(o.DescriptionPlural)){c=o.DescriptionPlural.Value}else{c=o.DescriptionPlural}if(r.isObject(o.ObjectName)){d=o.ObjectName.Value}else{d=o.ObjectName}}else{o.$$ResultItemAttributes$$.forEach(function(e){if(e.Name==="DESCRIPTION"){u=e.Value}if(e.Name==="DESCRIPTION_PLURAL"){c=e.Value}if(e.Name==="OBJECT_NAME"){d=e.Value}})}if(!u){u=d}if(!c){c=u}var f=this.sina._createDataSource({id:d,label:u,labelPlural:c,type:this.sina.DataSourceType.BusinessObject});this.labelCalculator.calculateLabel(f)}}},{key:"getInternalMetadataAttributes",value:function e(t){var r=[];var a=this.internalMetadata[t.id];if(!a){return r}for(var s in a.data){r.push(a.data[s])}return r}},{key:"getInternalMetadataAttribute",value:function e(t,r){return this.internalMetadata[t.id].data[r]}},{key:"getInternalMetadataLoadStatus",value:function e(t){var r=this.internalMetadata[t.id];if(!r){return{}}return r.loadStatus}},{key:"fillInternalMetadata",value:function e(t,r,a){var s=this.internalMetadata[t.id];if(!s){s={loadStatus:{},data:{}};this.internalMetadata[t.id]=s}for(var i=0;i<a.length;++i){var n=a[i];var o=s.data[n.Name];if(!o){o={};s.data[n.Name]=o}for(var u in n){o[u]=n[u]}}s.loadStatus[r]=true}},{key:"addTemplateConditions",value:function e(t){t.addCondition({attribute:"$$RenderingTemplatePlatform$$",operator:this.sina.ComparisonOperator.Eq,value:"html"});t.addCondition({attribute:"$$RenderingTemplateTechnology$$",operator:this.sina.ComparisonOperator.Eq,value:"Tempo"});t.addCondition({attribute:"$$RenderingTemplateType$$",operator:this.sina.ComparisonOperator.Eq,value:"ResultItem"});t.addCondition({attribute:"$$RenderingTemplateType$$",operator:this.sina.ComparisonOperator.Eq,value:"ItemDetails"})}},{key:"assembleOrderBy",value:function e(t){var r=[];for(var a=0;a<t.sortOrder.length;++a){var s=t.sortOrder[a];var i=s.order===this.sina.SortOrder.Descending?"DESC":"ASC";r.push({AttributeName:s.id,SortOrder:i})}return r}},{key:"executeSearchQuery",value:function e(t){var r,i;var n=t.filter.rootCondition.clone();this.addTemplateConditions(n);u.searchRequest.Search.Filter=a.serialize(t.filter.dataSource,n);u.searchRequest.DataSource=s.serialize(t.filter.dataSource);u.searchRequest.Search.SearchTerms=t.filter.searchTerm;u.searchRequest.Search.Top=t.top;u.searchRequest.Search.Skip=t.skip;u.searchRequest.Options=this.assembleRequestOptions(t);u.searchRequest.Search.OrderBy=this.assembleOrderBy(t);u.searchRequest.Search.Expand=["Grid","Items","TotalCount"];this.addLanguagePreferences(u.searchRequest);this.addSessionId(u.searchRequest);if(t.calculateFacets){u.searchRequest.Search.Expand.push("ResultsetFacets")}return this.ajaxClient.postJson(this.getResponseUrl,u.searchRequest).then(function(e){i=e;return this.itemParser.parse(t,i.data)}.bind(this)).then(function(e){r=e;return this.facetParser.parse(t,i.data)}.bind(this)).then(function(e){return this.sina._createSearchResultSet({id:i.data.ExecutionID,title:"Search Result List",query:t,items:r.items,totalCount:r.totalCount,facets:e})}.bind(this))}},{key:"executeChartQuery",value:function e(t){var r=t.filter.rootCondition.clone();this.addTemplateConditions(r);u.chartRequest.Search.Filter=a.serialize(t.filter.dataSource,r);u.chartRequest.DataSource=s.serialize(t.filter.dataSource);u.chartRequest.Search.SearchTerms=t.filter.searchTerm;u.chartRequest.Search.Top=1;u.chartRequest.Search.Skip=0;u.chartRequest.Facets.Attributes=[t.dimension];u.chartRequest.Facets.MaxNumberOfReturnValues=t.top;u.chartRequest.Options=this.assembleRequestOptions(t);this.addLanguagePreferences(u.chartRequest);this.addSessionId(u.chartRequest);return this.ajaxClient.postJson(this.getResponseUrl,u.chartRequest).then(function(e){return this.facetParser.parse(t,e.data)}.bind(this)).then(function(e){if(e.length>0){return e[0]}return this.sina._createChartResultSet({title:t.filter.dataSource.getAttributeMetadata(t.dimension).label,items:[],query:t})}.bind(this))}},{key:"executeHierarchyQuery",value:function e(t){throw new w}},{key:"executeSuggestionQuery",value:function t(r){try{const t=this;var i=r.filter.searchTerm;var n=f.split(t,i);var o=r.filter.rootCondition.clone();if(n.searchTerm){o.addCondition(r.sina.createSimpleCondition({attribute:A.INAV2_SearchTerms,value:n.searchTerm}))}o.addCondition(r.sina.createSimpleCondition({attribute:A.INAV2_SuggestionTerms,value:n.suggestionTerm}));u.suggestionRequest.Suggestions2.Filter=a.serialize(r.filter.dataSource,o);u.suggestionRequest.DataSource=s.serialize(r.filter.dataSource);u.suggestionRequest.Options=t.assembleSuggestionOptions(r);if(u.suggestionRequest.Options.length===0){return e(t.sina._createSuggestionResultSet({title:"Suggestions",query:r,items:[]}))}u.suggestionRequest.Suggestions2.Top=r.top;u.suggestionRequest.Suggestions2.Skip=r.skip;t.addLanguagePreferences(u.suggestionRequest);t.addSessionId(u.suggestionRequest);return e(t.ajaxClient.postJson(t.getResponseUrl,u.suggestionRequest).then(function(e){var t=d.parse(this,r,e.data);f.concatenate(this,n,t);return this.sina._createSuggestionResultSet({title:"Suggestions",query:r,items:t})}.bind(t)))}catch(e){return Promise.reject(e)}}},{key:"addSessionId",value:function e(t){if(!this.supports("Search","SessionHandling")){delete t.SessionID;delete t.SessionTimestamp;return}t.SessionID=this.sessionId;t.SessionTimestamp=parseInt(i.generateTimestamp(),10)}},{key:"addLanguagePreferences",value:function e(t){if(!this.supports("Search","LanguagePreferences")){delete t.LanguagePreferences;return}t.LanguagePreferences=n.getLanguagePreferences()}},{key:"assembleSuggestionOptions",value:function e(t){var r={SearchTerm:{Data:"SuggestObjectData",History:"SuggestSearchHistory"},Object:{},DataSource:{Data:"SuggestDataSources"}};if(!this.supports("Suggestions2","ScopeTypes")){delete r.SearchTerm.History;delete r.DataSource.Data}var a=[];var s=t.types;var i=t.calculationModes;for(var n=0;n<s.length;n++){var o=s[n];for(var u=0;u<i.length;u++){var c=i[u];var l=r[o][c];if(!l){continue}a.push(l)}}return a}},{key:"assembleRequestOptions",value:function e(t){var r=["SynchronousRun"];if(this.decideValueHelp(t)){r.push("ValueHelpMode")}return r}},{key:"decideValueHelp",value:function e(t){var r=t.filter.rootCondition.conditions;for(var a=0;a<r.length;a++){if(t.filter._getAttribute(r[a])===t["dimension"]){return true}}return false}},{key:"getConfigurationAsync",value:function t(){try{const t=this;if(!t.supports("PersonalizedSearch","SetUserStatus")){return Promise.resolve(t.sina._createConfiguration({personalizedSearch:false,isPersonalizedSearchEditable:false}))}return e(t.ajaxClient.postJson(t.getResponseUrl,u.getConfigurationRequest).then(function(e){var t={personalizedSearch:false,isPersonalizedSearchEditable:false};t.personalizedSearch=e.data.Data.PersonalizedSearch.SessionUserActive;switch(e.data.Data.PersonalizedSearch.PersonalizationPolicy){case"Opt-In":t.isPersonalizedSearchEditable=true;break;case"Opt-Out":t.isPersonalizedSearchEditable=true;break;case"Enforced":t.isPersonalizedSearchEditable=false;break;case"Disabled":t.isPersonalizedSearchEditable=false;break}return this.sina._createConfiguration(t)}.bind(t)))}catch(e){return Promise.reject(e)}}},{key:"saveConfigurationAsync",value:function t(r){try{const t=this;if(!t.supports("PersonalizedSearch","SetUserStatus")){return Promise.resolve()}u.saveConfigurationRequest.SearchConfiguration.Data.PersonalizedSearch.SessionUserActive=r.personalizedSearch;return e(t.ajaxClient.postJson(t.getResponseUrl,u.saveConfigurationRequest))}catch(e){return Promise.reject(e)}}},{key:"resetPersonalizedSearchDataAsync",value:function e(){if(!this.supports("PersonalizedSearch","ResetUserData")){return Promise.resolve()}return this.ajaxClient.postJson(this.getResponseUrl,u.resetPersonalizedSearchDataRequest)}},{key:"logUserEvent",value:function e(t){return this.userEventLogger.logUserEvent(t)}},{key:"getDebugInfo",value:function e(){return"Searchsystem: ".concat(this.serverInfo.ServerInfo.SystemId," Client: ").concat(this.serverInfo.ServerInfo.Client," ESH API Provider: ").concat(this.id)}}]);return h}(k);var U={__esModule:true};U.Provider=N;return U})})();