/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../../../sina/SinaObject","../../../sina/AttributeGroupTextArrangement","../../../sina/AttributeType","../../../sina/AttributeFormatType","../../../sina/AttributeSemanticsType","../../../core/Log"],function(t,e,r,i,a,s){function n(t,e){if(!(t instanceof e)){throw new TypeError("Cannot call a class as a function")}}function u(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||false;i.configurable=true;if("value"in i)i.writable=true;Object.defineProperty(t,i.key,i)}}function o(t,e,r){if(e)u(t.prototype,e);if(r)u(t,r);Object.defineProperty(t,"prototype",{writable:false});return t}function f(t,e){if(typeof e!=="function"&&e!==null){throw new TypeError("Super expression must either be null or a function")}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}});Object.defineProperty(t,"prototype",{writable:false});if(e)p(t,e)}function p(t,e){p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){e.__proto__=r;return e};return p(t,e)}function l(t){var e=A();return function r(){var i=b(t),a;if(e){var s=b(this).constructor;a=Reflect.construct(i,arguments,s)}else{a=i.apply(this,arguments)}return d(this,a)}}function d(t,e){if(e&&(typeof e==="object"||typeof e==="function")){return e}else if(e!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return c(t)}function c(t){if(t===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t}function A(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(t){return false}}function b(t){b=Object.setPrototypeOf?Object.getPrototypeOf.bind():function t(e){return e.__proto__||Object.getPrototypeOf(e)};return b(t)}function _(t,e,r){if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}
/*!
   * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
   */var h=t["SinaObject"];var v=e["AttributeGroupTextArrangement"];var g=r["AttributeType"];var y=i["AttributeFormatType"];var E=a["AttributeSemanticsType"];var T=s["Log"];var U=function(t){f(r,t);var e=l(r);function r(t){var i;n(this,r);i=e.call(this,t);_(c(i),"log",new T("hana odata cds annotations parser"));i._datasource=t.dataSource;i._cdsAnnotations=t.cdsAnnotations;i._parsedAttributes={};i._knownAttributeGroups={};i._knownAttributeGroupsArray=[];i._attributeGroupReplacements={};i._AttributeUsagePrio={HIGH:"HIGH",MEDIUM:"MEDIUM",NONE:"NONE"};i._detailUsageStubsMap={};i._detailUsageStubsPrioHigh=[];i._detailUsageStubsPrioMedium=[];i._detailUsageStubsPrioNone=[];i._defaultTextArrangement=v.TextLast;return i}o(r,[{key:"parseCDSAnnotationsForDataSource",value:function t(){this._parsingResult={dataSourceIsCdsBased:false,detailAttributesAreSorted:false,titleAttributesAreSorted:false};this._parseDefaultTextArrangement();this._parseAttributeAnnotations();this._parseDataSourceAnnotations();return this._parsingResult}},{key:"_addDetailUsageStub",value:function t(e,r,i){var a;if(typeof e==="string"){a=e;e=undefined}else{a=e.id}var s={attribute:e,displayOrder:r,prio:i,obsolete:false};this._detailUsageStubsMap[a]=s;if(i===this._AttributeUsagePrio.HIGH){this._detailUsageStubsPrioHigh.push(s)}else if(i===this._AttributeUsagePrio.MEDIUM){this._detailUsageStubsPrioMedium.push(s)}else{this._detailUsageStubsPrioNone.push(s)}}},{key:"_getDetailUsageStub",value:function t(e){if(!e){return undefined}var r;if(typeof e==="string"){r=e}else{r=e.id}return this._detailUsageStubsMap[r]}},{key:"_setParsedAttribute",value:function t(e,r){this._parsedAttributes[e.toUpperCase()]=r}},{key:"_getParsedAttribute",value:function t(e){return this._parsedAttributes[e.toUpperCase()]}},{key:"_setknownAttributeGroup",value:function t(e,r){this._knownAttributeGroups[e.toUpperCase()]=r}},{key:"_getknownAttributeGroup",value:function t(e){return this._knownAttributeGroups[e.toUpperCase()]}},{key:"_parseDefaultTextArrangement",value:function t(){try{var e=this._deriveTextArrangementFromCdsAnnotation(this._cdsAnnotations.dataSourceAnnotations.UI&&this._cdsAnnotations.dataSourceAnnotations.UI.TEXTARRANGEMENT);this._defaultTextArrangement=e||this._defaultTextArrangement}catch(t){}}},{key:"_parseDataSourceAnnotations",value:function t(){if(Object.keys(this._cdsAnnotations.dataSourceAnnotations).length>0){try{var e=this._cdsAnnotations.dataSourceAnnotations.UI;var r=e&&e.HEADERINFO;var i=r&&r.TITLE;var a,s,n;if(i){a=i.TYPE&&i.TYPE.toUpperCase();if(a==="AS_CONNECTED_FIELDS"){s=i.VALUEQUALIFIER;if(s&&s.trim().length>0){n=this._getknownAttributeGroup(s);if(n){n.usage.Title={displayOrder:1}}}}else if(!a){var u=i.VALUE;if(u){var o=this._getParsedAttribute(u);if(o){o.usage.Title={displayOrder:1}}}}var f=i.URL;if(f){var p=this._getParsedAttribute(f);if(p){p.usage.Navigation={mainNavigation:true}}}}var l=r&&r.DESCRIPTION;if(l){a=l.TYPE;if(a==="AS_CONNECTED_FIELDS"){s=l.VALUEQUALIFIER;if(s&&s.trim().length>0){n=this._getknownAttributeGroup(s);if(n){n.usage.TitleDescription={displayOrder:1}}}}else if(!a){var d=l.VALUE;if(d){var c=this._getParsedAttribute(d);if(c){c.usage.TitleDescription={}}}}}var A=r&&r.IMAGEURL;if(A){var b=this._getParsedAttribute(A);if(b){b.usage.Title={};b.type=this.sina.AttributeType.ImageUrl}}}catch(t){this.log.warn("Could not parse attribute for datasource: "+t)}}}},{key:"_parseAttributeAnnotations",value:function t(){for(var e in this._datasource.attributeMetadataMap){this._parseSingleAttribute(e)}this._datasource.attributesMetadata=this._datasource.attributesMetadata.concat(this._knownAttributeGroupsArray);this._datasource.attributeMetadataMap=Object.assign(this._datasource.attributeMetadataMap,this._knownAttributeGroups);this._sortAttributes()}},{key:"_parseSingleAttribute",value:function t(e){var r=this._getParsedAttribute(e);if(!r){r=this._getPropertyFromObject(this._datasource.attributeMetadataMap,e);if(r&&r.id){this._setParsedAttribute(r.id,r);var i=this._cdsAnnotations.attributeAnnotations[r.id]||{};if(Object.keys(i).length>0){this._parsingResult.dataSourceIsCdsBased=true;try{if(i.UI!==undefined){this._parseSingleAnnotationOrArray(r,i.UI.IDENTIFICATION,this._parseIdentification);this._parseSingleAnnotationOrArray(r,i.UI.CONNECTEDFIELDS,this._parseConnectedFields);this._parseURLsForDocumentResultItemThumbnail(r,i.UI.IDENTIFICATION,i.SEMANTICS);if(i.UI.MULTILINETEXT!==undefined){r.format=y.MultilineText}}this._parseSemantics(r,i.SEMANTICS);this._parseDescriptionAttribute(r,i.OBJECTMODEL,i.UI)}catch(t){}}}}return r}},{key:"_parseConnectedFields",value:function t(e,r){var i=r.QUALIFIER;if(i){var a={};if(r.NAME){a[r.NAME]=e}this._createAttributeGroup(i,r.GROUPLABEL,r.TEMPLATE,a)}}},{key:"_createAttributeGroup",value:function t(e,r,i,a,s){var n=this._getknownAttributeGroup(e);if(!n){n=this.sina._createAttributeGroupMetadata({id:e,label:r||"",type:g.Group,template:i||"",attributes:[],usage:{},displayAttributes:s||[]});this._setknownAttributeGroup(e,n);this._knownAttributeGroupsArray.push(n);this._datasource.attributeGroupsMetadata.push(n);this._datasource.attributeGroupMetadataMap[e]=n;var u=this._getDetailUsageStub(e);if(u){u.attribute=n}}else{if(r&&!n.label){n.label=r}if(i&&!n.template){n.template=i}if(s&&!n.displayAttributes){n.displayAttributes=s}}if(a){for(var o in a){var f=a[o];var p=this.sina._createAttributeGroupMembership({group:n,attribute:f,nameInGroup:o});n.attributes.push(p);f.groups.push(p)}}return n}},{key:"_parseIdentification",value:function t(e,r){this._parseAttributePositions(e,r);this._parseIconUrlAttributeName(e,r)}},{key:"_parseIconUrlAttributeName",value:function t(e,r){if(r){if(Array.isArray(r)){for(var i=0;i<r.length;i++){if(r[i].ICONURL){e.iconUrlAttibuteName=r[i].ICONURL;break}}}else if(r.ICONURL){e.iconUrlAttributeName=r.ICONURL}}}},{key:"_parseAttributePositions",value:function t(e,r){var i=r.IMPORTANCE&&r.IMPORTANCE.toUpperCase();var a=r.POSITION;if(i&&!a){a=Number.MAX_VALUE}if(a!==undefined){switch(i){case"HIGH":case"MEDIUM":case undefined:{a=this._parsePosition(a);var s=r.TYPE&&r.TYPE.toUpperCase();switch(s){case"AS_CONNECTED_FIELDS":{var n=r.VALUEQUALIFIER;if(n){var u=this._getknownAttributeGroup(n);if(u){e=u}else{e=n}}}case undefined:{var o=this._getDetailUsageStub(e);if(o){if(!o.attribute&&typeof e!=="string"){o.attribute=e}}else{var f;if(i==="HIGH"){f=this._AttributeUsagePrio.HIGH}else if(i==="MEDIUM"){f=this._AttributeUsagePrio.MEDIUM}else{f=this._AttributeUsagePrio.NONE}this._addDetailUsageStub(e,a,f)}}}}}}}},{key:"_parseURLsForDocumentResultItemThumbnail",value:function t(e,r,i){if(!(i&&i.IMAGEURL)){return}var a;if(r){if(Array.isArray(r)){for(var s=0;s<r.length;s++){if(r[s].URL){a=r[s].URL;break}}}else{a=r.URL}}if(a&&i&&i.IMAGEURL){var n=this._getPropertyFromObject(this._cdsAnnotations.attributeAnnotations,a);if(n){var u=n.SEMANTICS&&n.SEMANTICS.URL&&n.SEMANTICS.URL.MIMETYPE;if(u){var o=this._getPropertyFromObject(this._datasource.attributeMetadataMap,a);var f=this._getPropertyFromObject(this._datasource.attributeMetadataMap,u);e.suvUrlAttribute=o;e.suvMimeTypeAttribute=f;e.format=y.DocumentThumbnail}}}}},{key:"_parseSemantics",value:function t(e,r){if(r){if(r.CONTACT&&r.CONTACT.PHOTO!==undefined){e.format=y.Round;if(e.type!==g.ImageBlob){e.type=g.ImageUrl}}if(r.IMAGEURL!==undefined){if(e.type!==g.ImageBlob){e.type=g.ImageUrl}}if(r.NAME!==undefined){if(r.NAME.GIVENNAME!==undefined){e.semantics=E.FirstName}if(r.NAME.FAMILYNAME!==undefined){e.semantics=E.LastName}}if(r.EMAIL&&r.EMAIL.ADDRESS!==undefined){e.semantics=E.EmailAddress}if(r.TELEPHONE&&r.TELEPHONE.TYPE!==undefined){e.semantics=E.PhoneNr}if(r&&r.URL!==undefined){e.semantics=E.HTTPURL}if(r&&r.CURRENCYCODE!==undefined){e._private.isCurrency=true}if(r&&r.UNITOFMEASURE!==undefined){e._private.isUnitOfMeasure=true}var i,a,s;var n;var u=r.QUANTITY&&r.QUANTITY.UNITOFMEASURE;if(u){n=[];e._private.isQuantity=true;i=this._parseSingleAttribute(u);if(i){if(i._private.isUnitOfMeasure){s="{"+e.id+"} {"+i.id+"}";n.push(e.id);n.push(i.id);this._createAttributeGroupForParentChildAttributes(e,i,"____UnitOfMeasureGroup",s,n)}}}var o=r.AMOUNT&&r.AMOUNT.CURRENCYCODE;if(o){n=[];a=this._parseSingleAttribute(o);if(a){if(a._private.isCurrency){s="{"+e.id+"} {"+a.id+"}";n.push(e.id);n.push(a.id);this._createAttributeGroupForParentChildAttributes(e,a,"____CurrencyGroup",s,n)}}}}}},{key:"_parseDescriptionAttribute",value:function t(e,r,i){var a=r&&r.TEXT&&r.TEXT.ELEMENT;if(a){if(Array.isArray(a)){if(a.length>0){a=a[0]}else{return}}var s=this._parseSingleAttribute(a);if(s){var n=this._deriveTextArrangementFromCdsAnnotation(i&&i.TEXTARRANGEMENT)||this._defaultTextArrangement;var u=!(e.semantics==E.FirstName&&s.semantics==E.LastName||s.semantics==E.FirstName&&e.semantics==E.LastName);var o=u?"(":"";var f=u?")":"";var p;if(n===v.TextFirst){p="{"+s.id+"} "+o+"{"+e.id+"}"+f}else if(n===v.TextLast){p="{"+e.id+"} "+o+"{"+s.id+"}"+f}else if(n===v.TextOnly){p="{"+s.id+"}"}else{p="{"+e.id+"} "+o+"{"+s.id+"}"+f}var l=[];if(n===v.TextOnly){l.push(s.id)}else{l.push(e.id);l.push(s.id)}var d=this._createAttributeGroupForParentChildAttributes(e,s,"____Description",p,l);d._private.isDescription=true;d._private.textArrangement=n;if(e._private.isUnitOfMeasure||s._private.isUnitOfMeasure){d._private.isUnitOfMeasure=true}if(e._private.isCurrency||s._private.isCurrency){d._private.isCurrency=true}}}}},{key:"_deriveTextArrangementFromCdsAnnotation",value:function t(e){if(e){switch(e.toUpperCase()){case"TEXT_FIRST":return v.TextFirst;case"TEXT_LAST":return v.TextLast;case"TEXT_ONLY":case"#TEXT_ONLY":return v.TextOnly;case"TEXT_SEPARATE":return v.TextSeparate}}return undefined}},{key:"_createAttributeGroupForParentChildAttributes",value:function t(e,r,i,a,s){var n=e.id+i;var u={};u[e.id]=e;u[r.id]=r;var o=this._createAttributeGroup(n,e.label,a,u,s);var f=this._getDetailUsageStub(e);if(f){f.obsolete=true;this._addDetailUsageStub(o,f.displayOrder,f.prio)}this._replaceAttributeWithGroup(e,o);o._private.parentAttribute=e;o._private.childAttribute=r;if(r._private&&r._private.isCurrency){o._private.isCurrency=true}if(r._private&&r._private.isUnitOfMeasure){o._private.isUnitOfMeasure=true}return o}},{key:"_replaceAttributeWithGroup",value:function t(e,r){this._setParsedAttribute(e.id,r);for(var i=0;i<e.groups.length;i++){var a=e.groups[i];if(a.group!=r){a.attribute=r}}}},{key:"_sortAttributes",value:function t(){var e=function t(e,r){if(e.displayOrder<r.displayOrder){return-1}else if(e.displayOrder>r.displayOrder){return 1}return 0};var r,i;if(this._detailUsageStubsPrioHigh.length>0||this._detailUsageStubsPrioMedium.length>0){this._detailUsageStubsPrioHigh.sort(e);this._detailUsageStubsPrioMedium.sort(e);var a=this._detailUsageStubsPrioHigh.concat(this._detailUsageStubsPrioMedium);for(r=0;r<a.length;r++){if(!a[r].obsolete){i=a;break}}}if(!i){i=this._detailUsageStubsPrioNone.sort(e)}for(r=0;r<i.length;r++){var s=i[r];if(!s.obsolete&&s.attribute&&typeof s.attribute!=="string"){s.attribute.usage=s.attribute.usage||{};s.attribute.usage.Detail={displayOrder:r}}}this._parsingResult.detailAttributesAreSorted=true}},{key:"_parseSingleAnnotationOrArray",value:function t(e,r,i){if(r!==undefined){if(Array.isArray(r)){for(var a=0;a<r.length;a++){i.apply(this,[e,r[a]])}}else{i.apply(this,[e,r])}}}},{key:"_parsePosition",value:function t(e){if(typeof e==="string"){try{e=parseInt(e,10)}catch(t){e=Number.MAX_VALUE}}if(typeof e!=="number"||isNaN(e)){e=Number.MAX_VALUE}return e}},{key:"_getPropertyFromObject",value:function t(e,r){if(e[r]){return e[r]}r=r.toLowerCase();for(var i in e){if(i.toLowerCase()===r){return e[i]}}return undefined}}]);return r}(h);var I={__esModule:true};I.CDSAnnotationsParser=U;return I})})();