/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){function e(e,r,t){if(t){return r?r(e):e}if(!e||!e.then){e=Promise.resolve(e)}return r?e.then(r):e}function r(e,r){var t=e();if(t&&t.then){return t.then(r)}return r(t)}sap.ui.define(["../../core/core","../../core/ajax","./MetadataParserXML","./MetadataParserJson","./ItemParser","./FacetParser","./suggestionParser","./eshObjects/src/index","./conditionSerializerEshObj","../../core/Log","../../sina/SearchQuery","../../sina/SortOrder","../AbstractProvider","../../sina/SuggestionType","../../sina/ComplexCondition","../../core/errors","./HierarchyParser","./HierarchyNodePathParser","../../sina/SuggestionCalculationMode","../../sina/DataSource"],function(t,a,i,n,u,s,o,c,f,l,y,v,h,p,d,g,S,b,m,P){function x(e){return C(e)||O(e)||A(e)||j()}function j(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function A(e,r){if(!e)return;if(typeof e==="string")return w(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);if(t==="Object"&&e.constructor)t=e.constructor.name;if(t==="Map"||t==="Set")return Array.from(e);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return w(e,r)}function O(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function C(e){if(Array.isArray(e))return w(e)}function w(e,r){if(r==null||r>e.length)r=e.length;for(var t=0,a=new Array(r);t<r;t++)a[t]=e[t];return a}function q(e,r){if(!(e instanceof r)){throw new TypeError("Cannot call a class as a function")}}function Q(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}function _(e,r,t){if(r)Q(e.prototype,r);if(t)Q(e,t);Object.defineProperty(e,"prototype",{writable:false});return e}function k(e,r){if(typeof r!=="function"&&r!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(r)D(e,r)}function D(e,r){D=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(r,t){r.__proto__=t;return r};return D(e,r)}function T(e){var r=M();return function t(){var a=E(e),i;if(r){var n=E(this).constructor;i=Reflect.construct(a,arguments,n)}else{i=a.apply(this,arguments)}return R(this,i)}}function R(e,r){if(r&&(typeof r==="object"||typeof r==="function")){return r}else if(r!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return I(e)}function I(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function M(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function E(e){E=Object.setPrototypeOf?Object.getPrototypeOf.bind():function e(r){return r.__proto__||Object.getPrototypeOf(r)};return E(e)}function B(e,r,t){if(r in e){Object.defineProperty(e,r,{value:t,enumerable:true,configurable:true,writable:true})}else{e[r]=t}return e}var $=a["Client"];var F=i["MetadataParserXML"];var H=n["MetadataParserJson"];var N=u["ItemParser"];var L=s["FacetParser"];var z=o["SuggestionParser"];var J=c["getEshSearchQuery"];var G=c["Comparison"];var V=c["Phrase"];var U=c["Term"];var X=c["SearchQueryComparisonOperator"];var K=c["ESOrderType"];var W=c["HierarchyFacet"];var Y=l["Log"];var Z=y["SearchQuery"];var ee=v["SortOrder"];var re=h["AbstractProvider"];var te=p["SuggestionType"];var ae=d["ComplexCondition"];var ie=g["ESHNotActiveError"];var ne=S["HierarchyParser"];var ue=b["HierarchyNodePathParser"];var se=m["SuggestionCalculationMode"];var oe=P["DataSource"];var ce=function(a){k(n,a);var i=T(n);function n(){var e;q(this,n);for(var r=arguments.length,t=new Array(r),a=0;a<r;a++){t[a]=arguments[a]}e=i.call.apply(i,[this].concat(t));B(I(e),"id","hana_odata");return e}_(n,[{key:"initAsync",value:function r(t){try{const r=this;var a,i;r.requestPrefix=t.url;r.odataVersion=t.odataVersion;r.responseAttributes=t===null||t===void 0?void 0:t.responseAttributes;r.facetAttributes=t===null||t===void 0?void 0:t.facetAttributes;r.sina=t.sina;r.querySuffix=r.convertQuerySuffixToExpression(t.querySuffix);r.metaDataSuffix=(a=t.metaDataSuffix)!==null&&a!==void 0?a:"";var n;if(typeof t.getLanguage==="function"){n={csrf:false,getLanguage:t.getLanguage}}else{n={csrf:false}}r.ajaxClient=(i=t.ajaxClient)!==null&&i!==void 0?i:new $(n);var u=t.metaDataJsonType;if(u){r.metadataParser=new H(r)}else{r.metadataParser=new F(r)}r.itemParser=new N(r);r.facetParser=new L(r);r.suggestionParser=new z(r);r.hierarchyNodePathParser=new ue(r.sina);return e(r.loadServerInfo(),function(t){r.serverInfo=t;if(!r.supports("Search")){throw new ie}return e(r.loadBusinessObjectDataSources(),function(){return r.sina.dataSources.length===0?Promise.reject(new ie("Enterprise Search is not active - no datasources")):{capabilities:r.sina._createCapabilities({fuzzy:false})}})})}catch(e){return Promise.reject(e)}}},{key:"supports",value:function e(r,t){var a=this.serverInfo.services;for(var i in a){if(i===r){if(!t){return true}var n=a[i].Capabilities;for(var u=0;u<n.length;++u){var s=n[u];if(s===t){return true}}}}return false}},{key:"loadServerInfo",value:function r(){try{var t={rawServerInfo:{Services:[{Service:"Search",Capabilities:[{Capability:"SemanticObjectType"}]},{Service:"Suggestions2",Capabilities:[{Capability:"ScopeTypes"}]}]},services:{Suggestions:{suggestionTypes:["objectdata"]},Search:{capabilities:["SemanticObjectType"]}}};return e(t)}catch(e){return Promise.reject(e)}}},{key:"_prepareMetadataRequest",value:function e(){var r={metadataCall:true,resourcePath:this.getPrefix()+"/$metadata"};if(typeof this.metaDataSuffix==="string"&&this.metaDataSuffix.length>0){r.metadataObjects={entitySets:this.metaDataSuffix}}return J(r)}},{key:"loadBusinessObjectDataSources",value:function r(){try{const r=this;var t=r._prepareMetadataRequest();return e(r.metadataParser.fireRequest(r.ajaxClient,t),function(t){return e(r.metadataParser.parseResponse(t),function(e){for(var t=0;t<e.dataSourcesList.length;++t){var a=e.dataSourcesList[t];r.metadataParser.fillMetadataBuffer(a,e.businessObjectMap[a.id])}})})}catch(e){return Promise.reject(e)}}},{key:"assembleOrderBy",value:function e(r){var t=[];if(Array.isArray(r.sortOrder)){for(var a=0;a<r.sortOrder.length;++a){var i=r.sortOrder[a];var n=i.order===ee.Descending?K.Descending:K.Ascending;t.push({key:i.id,order:n})}}return t}},{key:"assembleGroupBy",value:function e(r){var t=null;if(r.groupBy&&r.groupBy.attributeName&&r.groupBy.attributeName.length>0){t.properties=r.groupBy.attributeName;if(r.groupBy.aggregateCountAlias&&r.groupBy.aggregateCountAlias!==""){t.aggregateCountAlias=r.groupBy.aggregateCountAlias}}return t}},{key:"executeSearchQuery",value:function e(r){var t=this._prepareSearchObjectSuggestionRequest(r);return this._fireSearchQuery(t)}},{key:"_prepareSearchObjectSuggestionRequest",value:function e(r){var t,a;var i=r.filter.rootCondition.clone();var n=f.serialize(r.filter.dataSource,i);if(!Array.isArray(n.items)){n.items=[]}var u=r.filter.searchTerm||"*";if(this.querySuffix&&r.filter.dataSource.id==="SEARCH_DESIGN"){n.items.push(this.querySuffix)}var s=r.filter.dataSource;var o=r.top||10;var c=r.skip||0;var l=this.assembleOrderBy(r);var y={resourcePath:this.getPrefix()+"/$all",$top:o,$skip:c,whyfound:true,$count:true,$orderby:l,freeStyleText:u,searchQueryFilter:n};if(s!==this.sina.getAllDataSource()){y.scope=s.id}if(((t=this.sina)===null||t===void 0?void 0:(a=t.configuration)===null||a===void 0?void 0:a.useValueHierarchy)===true&&o<100){var v=s.hierarchyAttribute;if(s.hierarchyHelperDatasource instanceof oe){v=s.hierarchyHelperDatasource.hierarchyAttribute}if(v){y.valuehierarchy=v}}if(r instanceof Z){if(typeof this.responseAttributes!=="undefined"){y.$select=this.responseAttributes}if(r.calculateFacets){if(typeof this.facetAttributes!=="undefined"){y.facets=this.facetAttributes}else{y.facets=["all"]}y.facetlimit=r.facetTop||5}var h=this.assembleGroupBy(r);if(h){y.groupby=h;y.whyfound=false}}var p={url:this.assembleEshSearchQuery(y),query:r};return p}},{key:"assembleEshSearchQuery",value:function e(r){var t,a;if(!((t=this.sina)!==null&&t!==void 0&&(a=t.configuration)!==null&&a!==void 0&&a.enableQueryLanguage)||!r.freeStyleText){return J(r)}var i="FDGhfdhgfHFGHrdthfgcvgzjmbvndf";var n=r.freeStyleText;r.freeStyleText=i;var u=J(r);var s=u.replace(i,encodeURIComponent("("+n+")"));return s}},{key:"_fireSearchQuery",value:function t(a){try{const t=this;var i;return e(t.ajaxClient.getJson(a.url),function(n){t.metadataParser.parseDynamicMetadata(n);var u=t.hierarchyNodePathParser.parse(n,a.query);return e(t.itemParser.parse(a.query,n.data),function(s){var o;var c=(i=n.data["@com.sap.vocabularies.Search.v1.SearchStatistics"])===null||i===void 0?void 0:i.ConnectorStatistics;return r(function(){if(a.query.getDataSource()===t.sina.getAllDataSource()&&c&&Array.isArray(c)&&c.length===1){var r={"@com.sap.vocabularies.Search.v1.Facets":[{"@com.sap.vocabularies.Search.v1.Facet":{PropertyName:"scope",isConnectorFacet:true},Items:[{scope:c[0].OdataID,_Count:n.data["@odata.count"]}]}]};return e(t.facetParser.parse(a.query,r),function(e){o=e})}else{return e(t.facetParser.parse(a.query,n.data),function(e){o=e})}},function(){return t.sina._createSearchResultSet({title:"Search Result List",query:a.query,items:s,totalCount:n.data["@odata.count"]||0,facets:o,hierarchyNodePaths:u})})})})}catch(e){return Promise.reject(e)}}},{key:"_fireObjectSuggestionsQuery",value:function r(t){try{const r=this;return e(r.ajaxClient.getJson(t.url),function(a){r.metadataParser.parseDynamicMetadata(a);return e(r.itemParser.parse(t.query,a.data),function(e){return r.suggestionParser.parseObjectSuggestions(t.query,e)})})}catch(e){return Promise.reject(e)}}},{key:"_prepareChartQueryRequest",value:function e(r,t,a){var i=r.filter.searchTerm;var n=r.filter.dataSource;var u=15;var s=a.deleted||false;var o=f.serialize(n,t);if(!Array.isArray(o.items)){o.items=[]}var c=r.top||5;if(s===true){var l=a.value;if(!a.value||a.value===""||l.match(/^[*\s]+$/g)!==null){a.value="*";o.items.push(new G({property:a.attribute,operator:X.Search,value:new U({term:"*"})}))}else{o.items.push(new G({property:a.attribute,operator:X.EqualCaseInsensitive,value:new V({phrase:a.value+"*"})}))}}if(this.querySuffix){o.items.push(this.querySuffix)}var y={resourcePath:this.getPrefix()+"/$all",$top:0,$count:true,searchQueryFilter:o,freeStyleText:i};if(n!==this.sina.getAllDataSource()){y.scope=n.id}var v=[];y.facetlimit=c;if(r.dimension){v.push(r.dimension);var h=r.filter.dataSource.getAttributeMetadata(r.dimension);if(h&&(h.type==="Double"||h.type==="Integer")&&c>=20){y.facetlimit=u}}y.facets=v;return J(y)}},{key:"executeChartQuery",value:function e(r){var t=new Y;var a=r.filter.rootCondition.clone();var i=a.removeAttributeConditions(r.dimension);var n=this._prepareChartQueryRequest(r,a,i);return this.ajaxClient.getJson(n).then(function(e){var a=this.facetParser.parse(r,e.data,t);return a}.bind(this)).then(function(e){if(e.length>0){return e[0]}var a="";var i=r.filter.dataSource.getAttributeMetadata(r.dimension);if(i&&i.label){a=i.label}return this.sina._createChartResultSet({title:a,items:[],query:r,log:t})}.bind(this))}},{key:"executeHierarchyQuery",value:function r(a){try{const r=this;var i=new ne;var n=f.serialize(a.filter.dataSource,a.filter.rootCondition);if(!Array.isArray(n.items)){n.items=[]}if(r.querySuffix){n.items.push(r.querySuffix)}var u=J({resourcePath:r.getPrefix()+"/$all",$top:0,searchQueryFilter:n,freeStyleText:a.filter.searchTerm,scope:a.filter.dataSource.id,facets:[a.attributeId],facetroot:[new W({facetColumn:a.attributeId,rootIds:[a.nodeId],levels:1})]});return e(r.ajaxClient.getJson(u),function(e){var r=a.filter.dataSource.getAttributeMetadata(a.attributeId);var n=e.data["@com.sap.vocabularies.Search.v1.Facets"]||[];var u=n.find(function(e){var r=t.getProperty(e,["@com.sap.vocabularies.Search.v1.Facet","Dimensions",0,"PropertyName"]);return r===a.attributeId});return i.parseHierarchyFacet(a,r,u||{})})}catch(e){return Promise.reject(e)}}},{key:"executeSuggestionQuery",value:function e(r){try{const e=this;return Promise.all([e.executeRegularSuggestionQuery(r),e.executeObjectSuggestionQuery(r)]).then(function(e){var t=[];t.push.apply(t,x(e[1]));t.push.apply(t,x(e[0]));return this.sina._createSuggestionResultSet({title:"Suggestions",query:r,items:t})}.bind(e))}catch(e){return Promise.reject(e)}}},{key:"isObjectSuggestionQuery",value:function e(r){return r.types.indexOf(te.Object)>=0&&r.filter.dataSource.type===r.sina.DataSourceType.BusinessObject}},{key:"executeObjectSuggestionQuery",value:function r(t){try{const r=this;if(!r.isObjectSuggestionQuery(t)){return Promise.resolve([])}return e(r._prepareSearchObjectSuggestionRequest(t),function(e){return r._fireObjectSuggestionsQuery(e)})}catch(e){return Promise.reject(e)}}},{key:"executeRegularSuggestionQuery",value:function e(r){if(r.calculationModes.includes(se.Data)&&r.types.includes(te.SearchTerm)){return this._fireSuggestionQuery(r)}return Promise.resolve([])}},{key:"_prepareSuggestionQueryRequest",value:function e(r){var t=r.filter.searchTerm;var a=r.filter.dataSource;var i=r.filter.rootCondition.clone();var n=f.serialize(r.filter.dataSource,i);if(!Array.isArray(n.items)){n.items=[]}var u=r.top||10;var s=r.skip||0;if(this.querySuffix){n.items.push(this.querySuffix)}var o={suggestTerm:t,resourcePath:this.getPrefix()+"/$all",$top:u,$skip:s,searchQueryFilter:n};if(a!==this.sina.getAllDataSource()){o.scope=a.id}return J(o)}},{key:"_fireSuggestionQuery",value:function e(r){var t=this._prepareSuggestionQueryRequest(r);return this.ajaxClient.getJson(t).then(function(e){var t=[];if(e.data.value){t=this.suggestionParser.parse(r,e.data.value)}return t}.bind(this))}},{key:"getPrefix",value:function e(){var r,t;var a=(r=this.odataVersion)!==null&&r!==void 0?r:"/v20411";var i=(t=this.requestPrefix)!==null&&t!==void 0?t:"/sap/es/odata";var n=i+a;return n}},{key:"convertQuerySuffixToExpression",value:function e(r){var t=null;if(r&&r instanceof ae){t=f.serialize(null,r)}return t}},{key:"getDebugInfo",value:function e(){return"ESH API Provider: "+this.id}}]);return n}(re);var fe={__esModule:true};fe.Provider=ce;return fe})})();