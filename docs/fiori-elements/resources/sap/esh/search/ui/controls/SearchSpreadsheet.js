/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../i18n","sap/ui/export/Spreadsheet","sap/m/MessageBox","sap/ui/core/mvc/Controller","sap/esh/search/ui/SearchResultFormatter"],function(t,e,r,i,s){function a(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}var o=a(t);var u=r["Action"];var n=i.extend("sap.esh.search.ui.controls.SearchSpreadsheet",{onExport:function t(){var e=this;if(this.table===undefined){var i=document.querySelectorAll('[id$="-ushell-search-result-table"]')[0].id;i=i.replace("sap-ui-invisible-","");this.table=sap.ui.getCore().byId(i);this.model=this.table.getModel()}if(this.exportButton===undefined){var s=document.querySelectorAll('[id$="-dataExportButton"]')[0].id;this.exportButton=sap.ui.getCore().byId(s)}this.exportButton.setEnabled(false);if(this.model.getProperty("/boCount")>1e3){r.information(o.getText("exportDataInfo"),{actions:[u.OK,u.CANCEL],onClose:function t(r){if(r==u.OK){e.startExport()}if(r==u.CANCEL){e.restoreUI()}}})}else{this.startExport()}},startExport:function t(){var e=this;this.exportColumns=[];this.exportRows=[];this.model.busyIndicator.setBusy(true);var r=this.model.query.clone();r.setCalculateFacets(false);r.setTop(1e3);var i=function t(i){e.resultsRaw=i.items;var a=new s(e.model);e.resultsFormatted=a.format(i,r.filter.searchTerm,{suppressHighlightedValues:true});e.parseExportColumns();e.parseExportRows();e.doExport()};var a=function t(r){e.restoreUI()};r.getResultSetAsync().then(i,a)},restoreUI:function t(){this.exportButton.setEnabled(true);this.model.busyIndicator.setBusy(false)},parseExportColumns:function t(){var e=this;var r=this.resultsRaw[0];var i=this.resultsFormatted[0];var s={label:i.dataSource.labelPlural,property:"EXPORT_COLUMN_TITLE",type:"string"};var a={label:i.titleDescriptionLabel+" ("+o.getText("titleDescription")+")",property:"EXPORT_COLUMN_TITLE_DESCRIPTION",type:"string"};if(this.model.getResultViewType()!=="searchResultTable"){if(r.titleAttributes.length>0){this.exportColumns.push(s)}if(r.titleDescriptionAttributes.length>0){this.exportColumns.push(a)}for(var u=0;u<i.itemattributes.length&&u<12;u++){var n=this.getAttributeRaw(i.itemattributes[u].key);this.pushExportColumns(n)}}else{var l=[];this.table.getColumns().forEach(function(t){if(t.getVisible()){l.push(t)}});l.sort(function(t,e){if(t.getOrder()<e.getOrder()){return-1}if(t.getOrder()>e.getOrder()){return 1}return 0});l.forEach(function(t){var r=t.getBindingContext().getObject().attributeId;if(r==="TABLE_COLUMN_TITLE"){e.exportColumns.push(s);return}if(r==="TABLE_COLUMN_TITLE_DESCRIPTION"){e.exportColumns.push(a);return}var i=e.getAttributeRaw(r);e.pushExportColumns(i)})}},getAttributeRaw:function t(e){var r=this.resultsRaw[0];var i=undefined;for(var s=0;s<r.detailAttributes.length;s++){if(r.detailAttributes[s].id===e){i=r.detailAttributes[s];break}}return i},pushExportColumns:function t(e){var r=this;if(e===undefined){return}if("value"in e){if(this.formatExportColumn(e)!==undefined){this.exportColumns.push(this.formatExportColumn(e))}}if("attributes"in e){e.attributes.forEach(function(t){return r.pushExportColumns(t.attribute)})}return},formatExportColumn:function t(e){if("label"in e&&"id"in e&&"metadata"in e){var r={label:e.label,property:e.id};if(e.metadata.type===undefined){r.type="string";return r}switch(e.metadata.type){case this.model.sinaNext.AttributeType.Double:r.type="number";r.scale=2;break;case this.model.sinaNext.AttributeType.Integer:r.type="number";r.scale=0;break;default:r.type="string"}return r}return undefined},parseExportRows:function t(){var e=[];for(var r=0;r<this.resultsRaw.length;r++){var i=this.resultsRaw[r];var s=this.resultsFormatted[r];var a={};a["EXPORT_COLUMN_TITLE"]=s.title;a["EXPORT_COLUMN_TITLE_DESCRIPTION"]=s.titleDescription;for(var o=0;o<i.attributes.length;o++){var u=i.attributes[o];if(!u.metadata){continue}if(u.valueHighlighted&&u.valueHighlighted.length>0){if(u.value.length===0){u.value=this.convertValueHighlighted2Value(u.valueHighlighted,u.metadata.type)}if(u.valueFormatted.length===0){u.valueFormatted=this.convertValueHighlighted2Value(u.valueHighlighted,undefined)}}if(u.metadata.type===this.model.sinaNext.AttributeType.Double||u.metadata.type===this.model.sinaNext.AttributeType.Integer){a[u.id]=u.value}else{a[u.id]=u.valueFormatted}}e.push(a)}this.exportRows=e},convertValueHighlighted2Value:function t(e,r){var i=e;i=i.replace(/<b>/g,"");i=i.replace(/<\/b>/g,"");if(r===this.model.sinaNext.AttributeType.Double||r===this.model.sinaNext.AttributeType.Integer){return Number(i)}else{return i}},doExport:function t(){var r=this;var i={workbook:{columns:this.exportColumns},fileName:o.getText("exportFileName"),dataSource:this.exportRows};new e(i).build().then(function(){r.restoreUI()},function(){r.restoreUI()})}});return n})})();