/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/util/JSTokenizer","sap/fe/core/CommonUtils","sap/fe/core/controls/filterbar/utils/VisualFilterUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/CriticalityFormatters","sap/fe/core/templating/FilterHelper","sap/fe/core/type/TypeUtil","sap/fe/macros/CommonHelper","sap/fe/macros/filter/FilterFieldHelper","sap/m/library","sap/ui/core/Core","sap/ui/core/format/NumberFormat","sap/ui/mdc/condition/ConditionConverter","sap/ui/model/odata/v4/ODataUtils","../field/FieldTemplating"],function(e,t,i,n,o,a,r,l,s,u,d,c,v,g,f,p,m){"use strict";var y=m.getTextBinding;var h=d.formatOptions;var C=d.constraints;var M=l.getFiltersConditionsFromSelectionVariant;var P=r.buildExpressionForCriticalityColorMicroChart;var T=a.isNavigationProperty;var b=a.isEntitySet;var $=o.generate;var D=n.getInvolvedDataModelObjects;const E={getChartDisplayedValue:function(e,t,i){const n=$([i]);return"{parts:[{path:'"+e+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"+(t&&t.ScaleFactor?",{value:'"+t.ScaleFactor.valueOf()+"'}":",{path:'internal>scalefactorNumber/"+n+"'}")+(t&&t.NumberOfFractionalDigits?",{value:'"+t.NumberOfFractionalDigits+"'}":",{value:'0'}")+",{path:'internal>currency/"+n+"'}"+",{path:'"+e+"',type:'sap.ui.model.odata.type.String', constraints:{'nullable':false}}"+"], formatter:'VisualFilterRuntime.scaleVisualFilterValue'}"},getChartValue:function(e){return"{path:'"+e+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"},_getCollectionName:function(e,t,i){const n=e.targetObject;if(T(n)){return i?t.getPath():n.name}else if(b(n)){return"/"+n.name}else{return n.name}},_getBindingPathForParameters:function(n,o,a,r,l){const u=[];const d=i.convertFilterCondions(n);const c=t.getParameterInfo(o,a).parameterProperties;if(c){for(const t in r){const i=r[t];const n=c[i];const a=l.split("/")[1];const v=o.createBindingContext(`/${a}/${i}`);const g=s.getTypeConfig(n.$Type,e.parseJS(h(n,{context:v})||"{}"),e.parseJS(C(n,{context:v})||"{}"));const m=d[i];const y=m?m[0]:undefined;if(y){const e=f.toType(y,g,s);const t=n.$Type;let o=encodeURIComponent(p.formatLiteral(e.values[0],t));o=o.replaceAll("'","\\'");u.push(`${i}=${o}`)}}}const v=a.slice(0,a.lastIndexOf("/"));const g=a.substring(a.lastIndexOf("/")+1);return`${v}(${u.toString()})/${g}`},_getUOMAggregationExpression:function(e,t,i,n){let o,a;const r=i&&typeof i!="string"&&i.path;if(e){if(t){o=r?`{ 'unit' : '${r}' }`:"{}";a=""}else{o="{}";a=r?`, '${r}' : {}`:""}}else if(n&&n.AggregatableProperty&&n.AggregatableProperty.value&&n.AggregationMethod){o="{ 'name' : '"+n.AggregatableProperty.value+"', 'with' : '"+n.AggregationMethod+"'}";a=r?", '"+r+"' : {}":""}return{aggregationExpression:o,UOMExpression:a}},getAggregationBinding:function(e,t,n,o,a,r,l,s,u,d,c,v,g,f){const p=l===null||l===void 0?void 0:l.targetObject;const m=v?v.getPath():"";const y=n.getPath();const h=e.Dimensions[0].value;const C=[];let P;let T=this._getCollectionName(t,n,c);const b=E.getUoM(e,t,undefined,s,u);const $=n.getModel();if(g){C.push({operator:"EQ",value1:"true",value2:null,path:"IsActiveEntity",isParameter:true})}if(p){P=M(y,$,p,i.getCustomConditions.bind(i));for(const e in P){const t=P[e];t.forEach(function(e){if(!e.isParameter){C.push(e)}})}}if(m!==`${T}/`&&c&&c.length&&P){const e=this._getBindingPathForParameters(P,$,T,c,y);T=e}const D=this._getUOMAggregationExpression(s,d,b,u);const O=D.aggregationExpression;const I=D.UOMExpression;const A=o?"' : { 'additionally' : ['"+o.path+"'] }":"' : { }";const F=JSON.stringify(C);return"{path: '"+T+"', templateShareable: true, suspended : true, 'filters' : "+F+",'parameters' : {"+E.getSortOrder(e,a,r,f)+", '$$aggregation' : {'aggregate' : {'"+f+"' : "+O+"},'group' : {'"+h+A+I+"} } }"+E.getMaxItems(e)+"}"},_getOrderExpressionFromMeasure:function(e,t){let i;if(e&&e.length){if(e[0].DynamicProperty){var n;i=(n=e[0].DynamicProperty.$target)===null||n===void 0?void 0:n.Name}else{var o;i=(o=e[0].Property)===null||o===void 0?void 0:o.value}if(i===t){return"'$orderby' : '"+t+(e[0].Descending?" desc'":"'")}return"'$orderby' : '"+t+" desc'"}return"'$orderby' : '"+t+" desc'"},getSortOrder:function(e,t,i,n){var o,a;if(e.ChartType==="UI.ChartType/Donut"||e.ChartType==="UI.ChartType/Bar"){return this._getOrderExpressionFromMeasure(i,n)}else if(t==="Edm.Date"||t==="Edm.Time"||t==="Edm.DateTimeOffset"){return"'$orderby' : '"+e.Dimensions[0].value+"'"}else if(i&&i.length&&((o=i[0].Property)===null||o===void 0?void 0:(a=o.$target)===null||a===void 0?void 0:a.path)===e.Dimensions[0].value){var r,l;return"'$orderby' : '"+((r=i[0].Property)===null||r===void 0?void 0:(l=r.$target)===null||l===void 0?void 0:l.name)+(i[0].Descending?" desc'":"'")}else{var s;return"'$orderby' : '"+((s=e.Dimensions[0].$target)===null||s===void 0?void 0:s.name)+"'"}},getMaxItems:function(e){if(e.ChartType==="UI.ChartType/Bar"){return",'startIndex' : 0,'length' : 3"}else if(e.ChartType==="UI.ChartType/Line"){return",'startIndex' : 0,'length' : 6"}else{return""}},getColorBinding:function(e,t){var i,n,o;const a=t===null||t===void 0?void 0:(i=t.$target)===null||i===void 0?void 0:(n=i.annotations)===null||n===void 0?void 0:(o=n.UI)===null||o===void 0?void 0:o.ValueCriticality;if(e!==null&&e!==void 0&&e.Criticality){return P(e)}else if(e!==null&&e!==void 0&&e.CriticalityCalculation){const t=e.CriticalityCalculation.ImprovementDirection;const i=e.Value;const n=e.CriticalityCalculation.DeviationRangeLowValue.valueOf();const o=e.CriticalityCalculation.ToleranceRangeLowValue.valueOf();const a=e.CriticalityCalculation.AcceptanceRangeLowValue.valueOf();const r=e.CriticalityCalculation.AcceptanceRangeHighValue.valueOf();const l=e.CriticalityCalculation.ToleranceRangeHighValue.valueOf();const s=e.CriticalityCalculation.DeviationRangeHighValue.valueOf();return u.getCriticalityCalculationBinding(t,i,n,o,a,r,l,s)}else if(a&&a.length){return E.getValueCriticality(t.value,a)}else{return undefined}},getValueCriticality:function(e,t){let i;const n=[];if(t&&t.length>0){t.forEach(function(t){if(t.Value&&t.Criticality){const i="${"+e+"} === '"+t.Value+"' ? '"+E._getCriticalityFromEnum(t.Criticality)+"'";n.push(i)}});i=n.length>0&&n.join(" : ")+" : undefined"}return i?"{= "+i+" }":undefined},_getCriticalityFromEnum:function(e){const t=c.ValueColor;let i;if(e==="UI.CriticalityType/Negative"){i=t.Error}else if(e==="UI.CriticalityType/Positive"){i=t.Good}else if(e==="UI.CriticalityType/Critical"){i=t.Critical}else{i=t.Neutral}return i},getScaleUoMTitle:function(e,t,i,n,o,a,r){var l,s,u,d,c;const v=e!==null&&e!==void 0&&e.MeasureAttributes?(l=e.MeasureAttributes[0])===null||l===void 0?void 0:(s=l.DataPoint)===null||s===void 0?void 0:(u=s.$target)===null||u===void 0?void 0:(d=u.ValueFormat)===null||d===void 0?void 0:(c=d.ScaleFactor)===null||c===void 0?void 0:c.valueOf():undefined;const f=$([i]);const p=g.getIntegerInstance({style:"short",showScale:false,shortRefNumber:v});let m=p.getScale();let y=E.getUoM(e,t,undefined,n,o);y=y&&(y.path?"${internal>uom/"+f+"}":"'"+y+"'");m=m?"'"+m+"'":"${internal>scalefactor/"+f+"}";if(!a){a="|"}a="' "+a+" ' + ";const h=m&&y?a+m+" + ' ' + "+y:a+(m||y);return r?h:"{= "+h+"}"},getMeasureDimensionTitle:function(e,t,i){var n,o,a,r,l;let s;let u;if(t){var d,c;u=e===null||e===void 0?void 0:(d=e.Measures[0])===null||d===void 0?void 0:(c=d.$target)===null||c===void 0?void 0:c.name}if(e!==null&&e!==void 0&&e.DynamicMeasures&&e.DynamicMeasures.length>0){var g,f,p;u=(g=e.DynamicMeasures[0])===null||g===void 0?void 0:(f=g.$target)===null||f===void 0?void 0:(p=f.AggregatableProperty)===null||p===void 0?void 0:p.value}else if(!t&&e!==null&&e!==void 0&&e.Measures&&(e===null||e===void 0?void 0:e.Measures.length)>0){var m,y;u=(m=e.Measures[0])===null||m===void 0?void 0:(y=m.$target)===null||y===void 0?void 0:y.name}const h=e===null||e===void 0?void 0:(n=e.Dimensions[0])===null||n===void 0?void 0:n.value;let C=e===null||e===void 0?void 0:(o=e.Dimensions[0])===null||o===void 0?void 0:(a=o.$target)===null||a===void 0?void 0:(r=a.annotations)===null||r===void 0?void 0:(l=r.Common)===null||l===void 0?void 0:l.Label;if(!t&&i){s=i.annotations&&i.annotations.Common&&i.annotations.Common.Label;if(s===undefined){var M,P,T,b;s=e===null||e===void 0?void 0:(M=e.Measures[0])===null||M===void 0?void 0:(P=M.$target)===null||P===void 0?void 0:(T=P.annotations)===null||T===void 0?void 0:(b=T.Common)===null||b===void 0?void 0:b.Label}}else{var $,D,E,O;s=e===null||e===void 0?void 0:($=e.Measures[0])===null||$===void 0?void 0:(D=$.$target)===null||D===void 0?void 0:(E=D.annotations)===null||E===void 0?void 0:(O=E.Common)===null||O===void 0?void 0:O.Label}if(s===undefined){s=u}if(C===undefined){C=h}return v.getLibraryResourceBundle("sap.fe.macros").getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_MEASURE_DIMENSION_TITLE",[s,C])},getToolTip:function(e,t,i,n,o,a){const r=e&&e["ChartType"];let l=E.getMeasureDimensionTitle(e,n,o);l=u.escapeSingleQuotes(l);if(a==="false"&&r==="UI.ChartType/Line"){return`{= '${l}'}`}const s=v.getLibraryResourceBundle("sap.fe.macros").getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_TOOLTIP_SEPERATOR");const d=$([i]);const c=E.getScaleUoMTitle(e,t,d,n,o,s,true);return"{= '"+l+(c?"' + "+c:"'")+"}"},_getUOM:function(e,t,i,n,o){const a={};const r=i===null||i===void 0?void 0:i.targetObject;if(e&&t){a[t]={$Path:e.path};return n&&e.path?JSON.stringify(a):e}else if(o){var l,s;const i=r.entityType?r.entityType.entityProperties:(l=r.targetType)===null||l===void 0?void 0:l.entityProperties;const c=i===null||i===void 0?void 0:i.find(e=>e.name==o);if(c!==null&&c!==void 0&&(s=c.annotations)!==null&&s!==void 0&&s.Measures&&t){var u,d;e=c===null||c===void 0?void 0:(u=c.annotations)===null||u===void 0?void 0:u.Measures[t];a[t]={$Path:(d=e)===null||d===void 0?void 0:d.path}}return e&&n&&e.path?JSON.stringify(a):e}},getUoM:function(e,t,i,n,o){var a,r;let l={};if(n){l=e===null||e===void 0?void 0:e.Measures[0]}if(e!==null&&e!==void 0&&e.DynamicMeasures&&e.DynamicMeasures.length>0){var s,u,d,c,v;l=(s=e.DynamicMeasures[0])===null||s===void 0?void 0:(u=s.$target)===null||u===void 0?void 0:(d=u.AggregatableProperty)===null||d===void 0?void 0:(c=d.$target)===null||c===void 0?void 0:(v=c.annotations)===null||v===void 0?void 0:v.Measures}else if(!n&&e!==null&&e!==void 0&&e.Measures&&e.Measures.length>0){l=e.Measures[0]}const g=(a=l)===null||a===void 0?void 0:a.ISOCurrency;const f=(r=l)===null||r===void 0?void 0:r.Unit;let p;if(!n&&o){p=o.AggregatableProperty&&o.AggregatableProperty.value}else{var m;p=(m=l)===null||m===void 0?void 0:m.value}return this._getUOM(g,"ISOCurrency",t,i,p)||this._getUOM(f,"Unit",t,i,p)},getScaleFactor:function(e){if(e&&e.ScaleFactor){return e.ScaleFactor.valueOf()}return undefined},getUoMVisiblity:function(e,t){const i=e&&e["ChartType"];if(t){return false}else if(!(i==="UI.ChartType/Bar"||i==="UI.ChartType/Line")){return false}else{return true}},getInParameterFiltersBinding:function(e){if(e.length>0){const t=[];let i="";e.forEach(function(e){if(e.localDataProperty){t.push(`{path:'$filters>/conditions/${e.localDataProperty}'}`)}});if(t.length>0){i=t.join();return`{parts:[${i}], formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFiltersFromConditions'}`}else{return undefined}}else{return undefined}},getfilterCountBinding:function(e){var t,i;const n=e===null||e===void 0?void 0:(t=e.Dimensions[0])===null||t===void 0?void 0:(i=t.$target)===null||i===void 0?void 0:i.name;return"{path:'$filters>/conditions/"+n+"', formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFilterCounts'}"},getInteractiveChartProperties:function(e){const t=e.chartAnnotation;const i={};if(e.chartMeasure&&t!==null&&t!==void 0&&t.Dimensions&&t.Dimensions[0]){var n,o,a,r,l,s,d,c,v;const f=$([(n=e.metaPath)===null||n===void 0?void 0:n.getPath()]);i.showErrorExpression="${internal>"+f+"/showError}";i.errorMessageExpression="{internal>"+f+"/errorMessage}";i.errorMessageTitleExpression="{internal>"+f+"/errorMessageTitle}";let p;if(t!==null&&t!==void 0&&t.MeasureAttributes&&t!==null&&t!==void 0&&t.MeasureAttributes[0]){var g;p=t!==null&&t!==void 0&&(g=t.MeasureAttributes[0])!==null&&g!==void 0&&g.DataPoint?t===null||t===void 0?void 0:t.MeasureAttributes[0].DataPoint.$target:t===null||t===void 0?void 0:t.MeasureAttributes[0]}const m=t===null||t===void 0?void 0:t.Dimensions[0];const h=u.getParameters(e.contextPath.getObject(),{context:e.contextPath});const C=m===null||m===void 0?void 0:(o=m.$target)===null||o===void 0?void 0:(a=o.annotations)===null||a===void 0?void 0:(r=a.Common)===null||r===void 0?void 0:r.Text;const M=D(e.metaPath,e.contextPath).targetObject;const P=D(e.contextPath);const T=e.selectionVariantAnnotation?D(e.selectionVariantAnnotation):undefined;const b=M.SortOrder;i.aggregationBinding=E.getAggregationBinding(t,P,e.contextPath,C,m.$target.type,b,T,e.customAggregate,e.aggregateProperties,e.UoMHasCustomAggregate,h,e.filterBarEntityType,e.draftSupported,e.chartMeasure);i.scalefactor=E.getScaleFactor((l=p)===null||l===void 0?void 0:l.ValueFormat);i.uom=E.getUoM(t,P,true,e.customAggregate,e.aggregateProperties);i.inParameters=u.stringifyCustomData(e.inParameters);i.inParameterFilters=e.inParameters?E.getInParameterFiltersBinding(e.inParameters):undefined;i.selectionVariantAnnotation=e.selectionVariantAnnotation?u.stringifyCustomData(e.selectionVariantAnnotation):undefined;i.stringifiedParameters=u.stringifyCustomData(h);const O=(s=e.metaPath)===null||s===void 0?void 0:(d=s.getModel())===null||d===void 0?void 0:d.createBindingContext(e.contextPath.getPath()+"/@"+m.fullyQualifiedName.split("@")[1]);if(O){const t=D(O,e.contextPath);i.chartLabel=y(t,{})}i.measure=E.getChartValue(e.chartMeasure);i.displayedValue=E.getChartDisplayedValue(e.chartMeasure,(c=p)===null||c===void 0?void 0:c.ValueFormat,(v=e.metaPath)===null||v===void 0?void 0:v.getPath());i.color=E.getColorBinding(p,m)}return i}};return E},false);