/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/buildingBlocks/BuildingBlockBase","sap/fe/core/buildingBlocks/BuildingBlockSupport","sap/fe/core/buildingBlocks/BuildingBlockTemplateProcessor","sap/fe/core/converters/controls/Common/DataVisualization","sap/fe/core/converters/helpers/Aggregation","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/StableIdHelper","./fragments/InteractiveBarChart","./fragments/InteractiveChartWithError","./fragments/InteractiveLineChart","./InteractiveChartHelper"],function(e,t,r,i,a,n,o,l,u,s,c,g,p){"use strict";var d,h,f,v,m,b,y,T,A,M,w,C,P,I,V,E,S,U,D,x,z,H,B,L,O,_,$,F,R,q,N,k,j,W,Y,G,J,K,Q,X,Z,ee,te,re,ie,ae,ne,oe,le,ue,se;var ce={};var ge=g.getInteractiveLineChartTemplate;var pe=c.getInteractiveChartWithErrorTemplate;var de=s.getInteractiveBarChartTemplate;var he=u.generate;var fe=o.getInvolvedDataModelObjects;var ve=n.AggregationHelper;var me=a.getDefaultSelectionVariant;var be=i.xml;var ye=r.defineBuildingBlock;var Te=r.blockAttribute;function Ae(e,t,r,i){if(!r)return;Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(i):void 0})}function Me(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function we(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;Ce(e,t)}function Ce(e,t){Ce=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return Ce(e,t)}function Pe(e,t,r,i,a){var n={};Object.keys(i).forEach(function(e){n[e]=i[e]});n.enumerable=!!n.enumerable;n.configurable=!!n.configurable;if("value"in n||n.initializer){n.writable=true}n=r.slice().reverse().reduce(function(r,i){return i(e,t,r)||r},n);if(a&&n.initializer!==void 0){n.value=n.initializer?n.initializer.call(a):void 0;n.initializer=undefined}if(n.initializer===void 0){Object.defineProperty(e,t,n);n=null}return n}function Ie(e,t){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}let Ve=(d=ye({name:"VisualFilter",namespace:"sap.fe.macros"}),h=Te({type:"string",required:true}),f=Te({type:"string"}),v=Te({type:"sap.ui.model.Context",required:true,expectedTypes:["EntitySet","NavigationProperty"]}),m=Te({type:"sap.ui.model.Context",required:true}),b=Te({type:"string"}),y=Te({type:"string"}),T=Te({type:"sap.ui.model.Context"}),A=Te({type:"array"}),M=Te({type:"boolean"}),w=Te({type:"boolean"}),C=Te({type:"boolean"}),P=Te({type:"string"}),I=Te({type:"string"}),V=Te({type:"sap.ui.model.Context"}),E=Te({type:"boolean"}),S=Te({type:"string"}),U=Te({type:"boolean"}),D=Te({type:"boolean"}),x=Te({type:"boolean"}),z=Te({type:"string"}),H=Te({type:"string"}),B=Te({type:"string"}),L=Te({type:"boolean"}),O=Te({type:"boolean"}),d(_=($=function(t){we(r,t);function r(r,i,a){var n,o,u,s,c,g,d,h,f,v,m,b,y,T,A,M,w,C,P;var I;I=t.call(this,r,i,a)||this;Ae(I,"id",F,Me(I));Ae(I,"title",R,Me(I));Ae(I,"contextPath",q,Me(I));Ae(I,"metaPath",N,Me(I));Ae(I,"outParameter",k,Me(I));Ae(I,"valuelistProperty",j,Me(I));Ae(I,"selectionVariantAnnotation",W,Me(I));Ae(I,"inParameters",Y,Me(I));Ae(I,"multipleSelectionAllowed",G,Me(I));Ae(I,"required",J,Me(I));Ae(I,"showOverlayInitially",K,Me(I));Ae(I,"renderLineChart",Q,Me(I));Ae(I,"requiredProperties",X,Me(I));Ae(I,"filterBarEntityType",Z,Me(I));Ae(I,"showError",ee,Me(I));Ae(I,"chartMeasure",te,Me(I));Ae(I,"UoMHasCustomAggregate",re,Me(I));Ae(I,"showValueHelp",ie,Me(I));Ae(I,"customAggregate",ae,Me(I));Ae(I,"groupId",ne,Me(I));Ae(I,"errorMessageTitle",oe,Me(I));Ae(I,"errorMessage",le,Me(I));Ae(I,"draftSupported",ue,Me(I));Ae(I,"isValueListWithFixedValues",se,Me(I));I.groupId="$auto.visualFilters";I.path=(n=I.metaPath)===null||n===void 0?void 0:n.getPath();const V=fe(I.metaPath,I.contextPath);const E=I.getConverterContext(V,undefined,a);const S=new ve(E.getEntityType(),E);const U=S.getCustomAggregateDefinitions();const D=V.targetObject;let x;const z=D&&D.Visualizations;I.getChartAnnotation(z,E);let H,B=[];if((o=I.chartAnnotation)!==null&&o!==void 0&&(u=o.Measures)!==null&&u!==void 0&&u.length){B=U.filter(e=>{var t;return e.qualifier===((t=I.chartAnnotation)===null||t===void 0?void 0:t.Measures[0].value)});x=B.length>0?B[0].qualifier:I.chartAnnotation.Measures[0].value;H=S.getAggregatedProperties("AggregatedProperties")[0]}if(H&&H.length>0&&!((s=I.chartAnnotation)!==null&&s!==void 0&&s.DynamicMeasures)&&B.length===0&&(c=I.chartAnnotation)!==null&&c!==void 0&&c.Measures&&((g=I.chartAnnotation)===null||g===void 0?void 0:g.Measures.length)>0){e.warning("The transformational aggregate measures are configured as Chart.Measures but should be configured as Chart.DynamicMeasures instead. Please check the SAP Help documentation and correct the configuration accordingly.")}if((d=I.chartAnnotation)!==null&&d!==void 0&&d.DynamicMeasures){if(B.length===0){x=E.getConverterContextFor(E.getAbsoluteAnnotationPath(I.chartAnnotation.DynamicMeasures[0].value)).getDataModelObjectPath().targetObject.Name;H=S.getAggregatedProperties("AggregatedProperty")}else{e.warning("The dynamic measures have been ignored as visual filters can deal with only 1 measure and the first (custom aggregate) measure defined under Chart.Measures is considered.")}}if(U.some(function(e){return e.qualifier===x})){I.customAggregate=true}const L=me(E.getEntityType());I.checkSelectionVariant(L);const O=I.getAggregateProperties(H,x);if(O){I.aggregateProperties=O}const _=z&&((h=z[0])===null||h===void 0?void 0:(f=h.$target)===null||f===void 0?void 0:f.Measures)&&((v=z[0])===null||v===void 0?void 0:(m=v.$target)===null||m===void 0?void 0:(b=m.Measures[0])===null||b===void 0?void 0:(y=b.$target)===null||y===void 0?void 0:y.annotations);const $=O===null||O===void 0?void 0:(T=O.AggregatableProperty)===null||T===void 0?void 0:(A=T.$target)===null||A===void 0?void 0:A.annotations;I.checkIfUOMHasCustomAggregate(U,_,$);const ce=_===null||_===void 0?void 0:(M=_.UI)===null||M===void 0?void 0:M.Hidden;const ge=$===null||$===void 0?void 0:(w=$.UI)===null||w===void 0?void 0:w.Hidden;const pe=I.getHiddenMeasure(ce,ge,I.customAggregate);const de=(C=I.chartAnnotation)===null||C===void 0?void 0:C.ChartType;I.chartType=de;I.showValueHelp=I.getShowValueHelp(de,pe);I.draftSupported=l.isDraftSupported(a.models.metaModel,(P=I.contextPath)===null||P===void 0?void 0:P.getPath());I.errorMessage=I.getErrorMessage(pe,x);I.chartMeasure=x;I.measureDimensionTitle=p.getMeasureDimensionTitle(I.chartAnnotation,I.customAggregate,I.aggregateProperties);const he=fe(I.contextPath);I.toolTip=p.getToolTip(I.chartAnnotation,he,I.path,I.customAggregate,I.aggregateProperties,I.renderLineChart);I.UoMVisibility=p.getUoMVisiblity(I.chartAnnotation,I.showError);I.scaleUoMTitle=p.getScaleUoMTitle(I.chartAnnotation,he,I.path,I.customAggregate,I.aggregateProperties);I.filterCountBinding=p.getfilterCountBinding(I.chartAnnotation);return I}ce=r;var i=r.prototype;i.checkIfUOMHasCustomAggregate=function e(t,r,i){const a=r===null||r===void 0?void 0:r.Measures;const n=i===null||i===void 0?void 0:i.Measures;const o=this.getUoM(a,n);if(o&&t.some(function(e){return e.qualifier===o})){this.UoMHasCustomAggregate=true}else{this.UoMHasCustomAggregate=false}};i.getChartAnnotation=function e(t,r){if(t){for(let e=0;e<t.length;e++){const i=t[e]&&t[e].value;this.chartAnnotation=r.getEntityTypeAnnotation(i)&&r.getEntityTypeAnnotation(i).annotation}}};i.getErrorMessage=function e(t,r){let i;if(this.chartAnnotation){if(this.chartAnnotation.ChartType==="UI.ChartType/Line"||this.chartAnnotation.ChartType==="UI.ChartType/Bar"){i=true}else{i=false}}if(typeof t==="boolean"&&t||!i||this.renderLineChart==="false"){this.showError=true;this.errorMessageTitle=t||!i?this.getTranslatedText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"):this.getTranslatedText("M_VISUAL_FILTER_LINE_CHART_INVALID_DATATYPE");if(t){return this.getTranslatedText("M_VISUAL_FILTER_HIDDEN_MEASURE",[r])}else if(!i){return this.getTranslatedText("M_VISUAL_FILTER_UNSUPPORTED_CHART_TYPE")}else{return this.getTranslatedText("M_VISUAL_FILTER_LINE_CHART_UNSUPPORTED_DIMENSION")}}};i.getShowValueHelp=function e(t,r){var i,a;const n=((i=this.chartAnnotation)===null||i===void 0?void 0:i.Dimensions[0])&&((a=this.chartAnnotation)===null||a===void 0?void 0:a.Dimensions[0].$target)&&this.chartAnnotation.Dimensions[0].$target.type;if(n==="Edm.Date"||n==="Edm.Time"||n==="Edm.DateTimeOffset"){return false}else if(typeof r==="boolean"&&r){return false}else if(!(t==="UI.ChartType/Bar"||t==="UI.ChartType/Line")){return false}else if(this.renderLineChart==="false"&&t==="UI.ChartType/Line"){return false}else if(this.isValueListWithFixedValues===true){return false}else{return true}};i.checkSelectionVariant=function t(r){let i;if(this.selectionVariantAnnotation){var a;const e=(a=this.metaPath)===null||a===void 0?void 0:a.getModel().createBindingContext(this.selectionVariantAnnotation.getPath());i=e&&fe(e,this.contextPath).targetObject}if(!i&&r){i=r}if(i&&i.SelectOptions&&!this.multipleSelectionAllowed){for(const t of i.SelectOptions){var n;if(t.PropertyName.value===((n=this.chartAnnotation)===null||n===void 0?void 0:n.Dimensions[0].value)){if(t.Ranges.length>1){e.error("Multiple SelectOptions for FilterField having SingleValue Allowed Expression")}}}}};i.getAggregateProperties=function e(t,r){let i;if(!t){return}t.some(function(e){if(e.Name===r){i=e;return true}});return i};i.getUoM=function e(t,r){var i,a;let n=t===null||t===void 0?void 0:t.ISOCurrency;let o=t===null||t===void 0?void 0:t.Unit;if(!n&&!o&&r){n=r.ISOCurrency;o=r.Unit}return((i=n)===null||i===void 0?void 0:i.path)||((a=o)===null||a===void 0?void 0:a.path)};i.getHiddenMeasure=function e(t,r,i){if(!i&&r){return r.valueOf()}else{return t===null||t===void 0?void 0:t.valueOf()}};i.getRequired=function e(){if(this.required){return be`<Label text="" width="0.5rem" required="true">
							<layoutData>
								<OverflowToolbarLayoutData priority="Never" />
							</layoutData>
						</Label>`}else{return be``}};i.getUoMTitle=function e(t){if(this.UoMVisibility){return be`<Title
							id="${he([this.id,"ScaleUoMTitle"])}"
							visible="{= !${t}}"
							text="${this.scaleUoMTitle}"
							titleStyle="H6"
							level="H3"
							width="4.15rem"
						/>`}else{return be``}};i.getValueHelp=function e(t){if(this.showValueHelp){return be`<ToolbarSpacer />
						<Button
							id="${he([this.id,"VisualFilterValueHelpButton"])}"
							type="Transparent"
							ariaHasPopup="Dialog"
							text="${this.filterCountBinding}"
							press="VisualFilterRuntime.fireValueHelp"
							enabled="{= !${t}}"
							customData:multipleSelectionAllowed="${this.multipleSelectionAllowed}"
						>
							<layoutData>
								<OverflowToolbarLayoutData priority="Never" />
							</layoutData>
						</Button>`}else{return be``}};i.getInteractiveChartFragment=function e(){if(this.showError){return pe(this)}else if(this.chartType==="UI.ChartType/Bar"){return de(this)}else if(this.chartType==="UI.ChartType/Line"){return ge(this)}return be``};i.getTemplate=function e(){const t=he([this.path]);const r="${internal>"+t+"/showError}";return be`
		<control:VisualFilter
		core:require="{VisualFilterRuntime: 'sap/fe/macros/visualfilters/VisualFilterRuntime'}"
		xmlns="sap.m"
		xmlns:control="sap.fe.core.controls.filterbar"
		xmlns:customData="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1"
		xmlns:core="sap.ui.core"
		id="${this.id}"
		height="13rem"
		width="20.5rem"
		class="sapUiSmallMarginBeginEnd"
		customData:infoPath="${he([this.path])}"
	>
		<VBox height="2rem" class="sapUiSmallMarginBottom">
			<OverflowToolbar style="Clear">
				${this.getRequired()}
				<Title
					id="${he([this.id,"MeasureDimensionTitle"])}"
					text="${this.measureDimensionTitle}"
					tooltip="${this.toolTip}"
					titleStyle="H6"
					level="H3"
					class="sapUiTinyMarginEnd sapUiNoMarginBegin"
				/>
				${this.getUoMTitle(r)}
				${this.getValueHelp(r)}
			</OverflowToolbar>
		</VBox>
		<VBox height="100%" width="100%">
			${this.getInteractiveChartFragment()}
		</VBox>
	</control:VisualFilter>`};return r}(t),F=Pe($.prototype,"id",[h],{configurable:true,enumerable:true,writable:true,initializer:null}),R=Pe($.prototype,"title",[f],{configurable:true,enumerable:true,writable:true,initializer:function(){return""}}),q=Pe($.prototype,"contextPath",[v],{configurable:true,enumerable:true,writable:true,initializer:null}),N=Pe($.prototype,"metaPath",[m],{configurable:true,enumerable:true,writable:true,initializer:null}),k=Pe($.prototype,"outParameter",[b],{configurable:true,enumerable:true,writable:true,initializer:null}),j=Pe($.prototype,"valuelistProperty",[y],{configurable:true,enumerable:true,writable:true,initializer:null}),W=Pe($.prototype,"selectionVariantAnnotation",[T],{configurable:true,enumerable:true,writable:true,initializer:null}),Y=Pe($.prototype,"inParameters",[A],{configurable:true,enumerable:true,writable:true,initializer:null}),G=Pe($.prototype,"multipleSelectionAllowed",[M],{configurable:true,enumerable:true,writable:true,initializer:null}),J=Pe($.prototype,"required",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),K=Pe($.prototype,"showOverlayInitially",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),Q=Pe($.prototype,"renderLineChart",[P],{configurable:true,enumerable:true,writable:true,initializer:null}),X=Pe($.prototype,"requiredProperties",[I],{configurable:true,enumerable:true,writable:true,initializer:null}),Z=Pe($.prototype,"filterBarEntityType",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),ee=Pe($.prototype,"showError",[E],{configurable:true,enumerable:true,writable:true,initializer:null}),te=Pe($.prototype,"chartMeasure",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),re=Pe($.prototype,"UoMHasCustomAggregate",[U],{configurable:true,enumerable:true,writable:true,initializer:null}),ie=Pe($.prototype,"showValueHelp",[D],{configurable:true,enumerable:true,writable:true,initializer:null}),ae=Pe($.prototype,"customAggregate",[x],{configurable:true,enumerable:true,writable:true,initializer:function(){return false}}),ne=Pe($.prototype,"groupId",[z],{configurable:true,enumerable:true,writable:true,initializer:function(){return"$auto.visualFilters"}}),oe=Pe($.prototype,"errorMessageTitle",[H],{configurable:true,enumerable:true,writable:true,initializer:null}),le=Pe($.prototype,"errorMessage",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),ue=Pe($.prototype,"draftSupported",[L],{configurable:true,enumerable:true,writable:true,initializer:null}),se=Pe($.prototype,"isValueListWithFixedValues",[O],{configurable:true,enumerable:true,writable:true,initializer:null}),$))||_);ce=Ve;return ce},false);