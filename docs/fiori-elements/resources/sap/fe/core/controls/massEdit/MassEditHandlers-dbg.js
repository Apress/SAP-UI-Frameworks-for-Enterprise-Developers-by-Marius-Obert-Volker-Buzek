/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/helpers/ModelHelper","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/ui/core/Core"],function(e,t,n,a){"use strict";const l={contextPropertyChange:function(e,t,n){const s=a.byId(n);const o=s&&s.getBindingContext();const i=s&&s.getModel("fieldsInfo");const u=i.getProperty(`/values/${t}`)||i.getProperty(`/unitData/${t}`)||[];if(o&&(u.inputType==="InputWithValueHelp"||u.inputType==="InputWithUnit")&&!u.valueListInfo){l._setValueListInfo(o,s,i,t)}const r=i&&i.getProperty("/isOpen");if(!r||!s.getVisible()){return}l._updateSelectKey(s,t,e)},handleMDCFieldChange:function(t,n){const a=t&&t.getSource();const s=t&&t.getParameter("promise");const o=a.getContent();if(!o||!n){return}s.then(l._updateSelectKeyForMDCFieldChange.bind(l,a,n)).catch(t=>{e.warning(`VHD selection couldn't be populated in the mass edit field.${t}`)})},handleSelectionChange:function(e){const t=e&&e.getSource();const n=t.getSelectedKey();const a=t&&n&&n.split("/");let s;if(a[0]==="UseValueHelpValue"){const n=e.getParameter("previousSelectedItem");const o=n.getKey();s=a.slice(1).join("/");l._onVHSelect(t,s,o);return}const o=t&&t.getModel("fieldsInfo");s=l._getPropertyNameFromKey(n);l._updateSuggestionForFieldsWithInParameters(o,s,n.startsWith("Default/")||n.startsWith("ClearFieldValue/"),true);l._updateSuggestionForFieldsWithOutParameters(o,s,n.startsWith("Default/")||n.startsWith("ClearFieldValue/"),false);l._updateResults(t,a,true)},_updateSelectKeyForMDCFieldChange:function(e,t,n){const a=e&&e.getBindingContext();const s=e&&e.getModel("fieldsInfo");const o=s.getProperty(`/values/${t}`)||s.getProperty(`/unitData/${t}`)||[];if(a&&(o.inputType==="InputWithValueHelp"||o.inputType==="InputWithUnit")&&!o.valueListInfo){l._setValueListInfo(a,e,s,t)}l._updateSuggestionForFieldsWithOutParameters(s,t,false,true);l._updateSuggestionForFieldsWithInParameters(s,t,false,true);const i=e.getFormFormattedValue();l._updateSelectKey(e,t,n,i)},_updateSuggestionForFieldsWithInParameters:function(e,t,n,a){const s=e.getProperty("/values");const o=e.getProperty("/unitData");const i=Object.keys(s);const u=Object.keys(o);i.forEach(l._updateInParameterSuggetions.bind(l,e,"/values/",t,n,a));u.forEach(l._updateInParameterSuggetions.bind(l,e,"/unitData/",t,n,a))},_updateInParameterSuggetions:function(e,t,n,a,s,o){const i=e.getProperty(`${t+o}/valueListInfo`);if(i&&n!=o){const u=i.inParameters;if(u&&u.length>0&&u.includes(n)){l._updateFieldPathSuggestions(e,t+o,a,s)}}},_updateSuggestionForFieldsWithOutParameters:function(e,t,n,a){const s=e.getProperty(`/values/${t}/valueListInfo`)||e.getProperty(`/unitData/${t}/valueListInfo`);if(s&&s.outParameters){const o=s.outParameters;if(o.length&&o.length>0){l._updateOutParameterSuggetions(o,e,n,a);const s=e.getProperty(`/values/${t}`)&&`/values/${t}`||e.getProperty(`/unitData/${t}`)&&`/unitData/${t}`;if(s){l._updateFieldPathSuggestions(e,s,false,true)}}}},_updateOutParameterSuggetions:function(e,t,n,a){const s=t.getProperty("/values");const o=t.getProperty("/unitData");const i=Object.keys(s);const u=Object.keys(o);e.forEach(e=>{if(i.includes(e)){l._updateFieldPathSuggestions(t,`/values/${e}`,n,a)}else if(u.includes(e)){l._updateFieldPathSuggestions(t,`/unitData/${e}`,n,a)}})},_updateFieldPathSuggestions:function(e,t,n,a){const l=e.getProperty(t);const s=l.defaultOptions;const o=e.getProperty(`${t}/selectedKey`);const i=a&&l.find(e=>e.key===o);if(n){const e=l.selectOptions;l.length=0;s.forEach(e=>l.push(e));e.forEach(e=>l.push(e))}else{l.length=0;s.forEach(e=>l.push(e))}e.setProperty(t,l);if(i&&!l.includes(i)){l.push(i);e.setProperty(`${t}/selectedKey`,o)}},_setValueListInfo:function(e,t,n,a){const s=n.getProperty(`/values/${a}`)&&"/values/"||n.getProperty(`/unitData/${a}`)&&"/unitData/";if(n.getProperty(`${s}${a}/valueListInfo`)){return}const o=n.getProperty(`${s}${a}/valueListInfo`);if(!o){l._requestValueList(e,t,n,a)}},_requestValueList:function(a,s,o,i){var u;const r=t.getMetaPathForContext(a);const d=r&&`${r}/${i}`;const c=s===null||s===void 0?void 0:s.getDependents();const g=s===null||s===void 0?void 0:s.getFieldHelp();const p=c===null||c===void 0?void 0:c.find(e=>e.getId()===g);const f=(u=p.getDelegate())===null||u===void 0?void 0:u.payload;if(!(p!==null&&p!==void 0&&p.getBindingContext())){p===null||p===void 0?void 0:p.setBindingContext(a)}const y=a.getModel().getMetaModel();n.createVHUIModel(p,d,y);const P=n.getValueListInfo(p,d,f);P.then(e=>{const t=e[0];const a=o.getProperty(`/values/${i}`)&&"/values/"||o.getProperty(`/unitData/${i}`)&&"/unitData/";const s={inParameters:t.vhParameters&&n.getInParameters(t.vhParameters).map(e=>e.helpPath),outParameters:t.vhParameters&&n.getOutParameters(t.vhParameters).map(e=>e.helpPath)};o.setProperty(`${a}${i}/valueListInfo`,s);if(s.outParameters.length>0){l._updateFieldPathSuggestions(o,`/values/${i}`,false,true)}}).catch(()=>{e.warning(`Mass Edit: Couldn't load valueList info for ${d}`)})},_getValueHelp:function(e,t){const n=t===null||t===void 0?void 0:t.getDependents();const a=t===null||t===void 0?void 0:t.getFieldHelp();return n===null||n===void 0?void 0:n.find(e=>e.getId()===a)},_onVHSelect:function(e,t,n){const a=e&&e.getModel("fieldsInfo");const s=a.getProperty(`/values/${t}`)&&"/values/"||a.getProperty(`/unitData/${t}`)&&"/unitData/";const o=e.getBindingContext();const i=l._getValueHelp(o,e.getParent());if(!(i!==null&&i!==void 0&&i.getBindingContext())){i===null||i===void 0?void 0:i.setBindingContext(o)}e.fireValueHelpRequest();a.setProperty(`${s+t}/selectedKey`,n)},_getPropertyNameFromKey:function(e){let t="";if(e.startsWith("Default/")||e.startsWith("ClearFieldValue/")||e.startsWith("UseValueHelpValue/")){t=e.substring(e.indexOf("/")+1)}else{t=e.substring(0,e.lastIndexOf("/"))}return t},_updateSelectKey:function(e,t,n,a){const s=e.getContent();if(!s||!t){return}let o=s.getSelectedKey();if((o.startsWith("Default/")||o.startsWith("ClearFieldValue/"))&&!n){return}const i=l._valueExists(a)?a:n;const u=e&&e.getModel("fieldsInfo");const r=u.getProperty(`/values/${t}`)||u.getProperty(`/unitData/${t}`)||[];const d=u.getProperty(`/values/${t}`)&&"/values/"||u.getProperty(`/unitData/${t}`)&&"/unitData/";const c=r.find(e=>{var t;return(e===null||e===void 0?void 0:(t=e.textInfo)===null||t===void 0?void 0:t.value)===n||e.text===n});if(c){if(a&&c.textInfo&&c.textInfo.descriptionPath&&(c.text!=i||c.textInfo.fullText!=i)){c.text=i;c.textInfo.fullText=i;c.textInfo.description=e.getAdditionalValue()}if(c.key===o){u.setProperty(`${d+t}/selectedKey`,o);return}o=c.key}else if([undefined,null,""].indexOf(n)===-1){o=`${t}/${n}`;const a={text:i,key:o,textInfo:{description:e.getAdditionalValue(),descriptionPath:r&&r.textInfo&&r.textInfo.descriptionPath,fullText:i,textArrangement:e.getDisplay(),value:e.getValue(),valuePath:t}};r.push(a);r.selectOptions=r.selectOptions||[];r.selectOptions.push(a);u.setProperty(d+t,r)}else{o=`Default/${t}`}u.setProperty(`${d+t}/selectedKey`,o);l._updateResults(s)},_getValue:function(e){var t;return e.getMetadata().getName()==="sap.fe.core.controls.MassEditSelect"?(t=e.getSelectedItem())===null||t===void 0?void 0:t.getText():e.getValue()},_getValueOnEmpty:function(e,t,n,a){if(!n){const l=t.getProperty(`/values/${a}`)||t.getProperty(`/unitData/${a}`)||[];if(l.unitProperty){n=0;e.setValue(n)}else if(l.inputType==="CheckBox"){n=false}}return n},_valueExists:function(e){return e!=undefined&&e!=null},_updateResults:function(e){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let n=arguments.length>2?arguments[2]:undefined;const a=e&&e.getModel("fieldsInfo");const s=a&&a.getData();let o=l._getValue(e);t=t.length>0?t:e&&e.getSelectedKey()&&e.getSelectedKey().split("/");let i;const u=e.data("fieldPath");const r=e.data("propertyFullyQualifiedName");if(t[0]==="Default"){i={keyValue:t[1],propertyFullyQualifiedName:r,value:t[0]}}else if(t[0]==="ClearFieldValue"){o="";o=l._getValueOnEmpty(e,a,o,u);i={keyValue:t[1],propertyFullyQualifiedName:r,value:o}}else if(!t){o=l._getValueOnEmpty(e,a,o,u);i={keyValue:u,propertyFullyQualifiedName:r,value:o}}else{const e=t.slice(0,-1).join("/");const n=a.getProperty(`/values/${e}`)||a.getProperty(`/unitData/${e}`)||[];const s=(n||[]).find(function(e){var t;return(e===null||e===void 0?void 0:(t=e.textInfo)===null||t===void 0?void 0:t.value)===o||e.text===o});i={keyValue:e,propertyFullyQualifiedName:r,value:s.textInfo&&l._valueExists(s.textInfo.value)?s.textInfo.value:s.text}}let d=-1;for(let e=0;e<s.results.length;e++){if(s.results[e].keyValue===i.keyValue){d=e}}if(d!==-1){s.results[d]=i}else{s.results.push(i)}if(n&&!i.keyValue.includes("/")){const n=e.getBindingContext();if(t[0]==="Default"||t[0]==="ClearFieldValue"){n.setProperty(i.keyValue,null)}else if(i){n.setProperty(i.keyValue,i.value)}}}};return l},false);