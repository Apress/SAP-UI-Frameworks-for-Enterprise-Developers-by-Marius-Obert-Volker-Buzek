/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/formatters/TableFormatterTypes","sap/m/Popover","sap/ui/core/Core","sap/ui/core/format/DateFormat","sap/ui/core/format/NumberFormat","sap/ui/core/Locale","sap/ui/core/mvc/ControllerExtension","sap/ui/model/Filter","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","../helpers/ClassSupport"],function(e,t,a,n,i,r,o,s,l,d,u,c){"use strict";var p,f,g,m,h,y;var P=c.publicExtension;var b=c.methodOverride;var v=c.defineUI5Class;var D=t.MessageType;function C(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;I(e,t)}function I(e,t){I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,a){t.__proto__=a;return t};return I(e,t)}function N(e,t,a,n,i){var r={};Object.keys(n).forEach(function(e){r[e]=n[e]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=a.slice().reverse().reduce(function(a,n){return n(e,t,a)||a},r);if(i&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(i):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(e,t,r);r=null}return r}const $={1:D.Error,2:D.Warning,3:D.Success,5:D.Information};const T={Error:"Error",Warning:"Critical",Success:"Good",Information:"None",None:"None"};function S(e,t){let a;if(t[0]!==undefined&&t[0]!==null&&e<t[0]){a=D.Error}else if(t[1]!==undefined&&t[1]!==null&&e<t[1]){a=D.Warning}else if(t[2]!==undefined&&t[2]!==null&&e<t[2]){a=D.None}else if(t[5]!==undefined&&t[5]!==null&&e>t[5]){a=D.Error}else if(t[4]!==undefined&&t[4]!==null&&e>t[4]){a=D.Warning}else if(t[3]!==undefined&&t[3]!==null&&e>t[3]){a=D.None}else{a=D.Success}return a}function j(e,t){let a;if(t[2]!==undefined&&t[2]!==null&&e>t[2]){a=D.Error}else if(t[1]!==undefined&&t[1]!==null&&e>t[1]){a=D.Warning}else if(t[0]!==undefined&&t[0]!==null&&e>t[0]){a=D.None}else{a=D.Success}return a}function w(e,t){let a;if(t[0]!==undefined&&t[0]!==null&&e<t[0]){a=D.Error}else if(t[1]!==undefined&&t[1]!==null&&e<t[1]){a=D.Warning}else if(t[2]!==undefined&&t[2]!==null&&e<t[2]){a=D.None}else{a=D.Success}return a}function x(e){let t;switch(e){case 1:case"1":case 2:case"2":t="Up";break;case 4:case"4":case 5:case"5":t="Down";break;default:t="None"}return t}function A(e,t,a,n){let i;if(!n||a&&!t){return"None"}const r=a?(e-t)/t:e-t;if(n[0]!==undefined&&n[0]!==null&&r<=n[0]){i="Down"}else if(n[1]!==undefined&&n[1]!==null&&r<=n[1]){i="Down"}else if(n[3]!==undefined&&n[3]!==null&&r>=n[3]){i="Up"}else if(n[2]!==undefined&&n[2]!==null&&r>=n[2]){i="Up"}else{i="None"}return i}function F(e){if(e.ranges.length===0){return undefined}else if(e.ranges.length===1){return new l(e.propertyPath,e.ranges[0].operator,e.ranges[0].rangeLow,e.ranges[0].rangeHigh)}else{const t=e.ranges.map(t=>new l(e.propertyPath,t.operator,t.rangeLow,t.rangeHigh));return new l({filters:t,and:false})}}function V(e){const t=new o(sap.ui.getCore().getConfiguration().getLanguage());const a=n.getLibraryResourceBundle("sap.fe.core");const r=i.getDateInstance({style:"medium"},t);function s(t){const n=e.propertyType.indexOf("Edm.Date")===0?r.format(new Date(t.rangeLow)):t.rangeLow;const i=e.propertyType.indexOf("Edm.Date")===0?r.format(new Date(t.rangeHigh)):t.rangeHigh;switch(t.operator){case"BT":return`[${n} - ${i}]`;case"Contains":return`*${n}*`;case"GE":return`≥${n}`;case"GT":return`>${n}`;case"LE":return`≤${n}`;case"LT":return`<${n}`;case"NB":return a.getText("C_KPICARD_FILTERSTRING_NOT",[`[${n} - ${i}]`]);case"NE":return`≠${n}`;case"NotContains":return a.getText("C_KPICARD_FILTERSTRING_NOT",[`*${n}*`]);case"EQ":default:return n}}if(e.ranges.length===0){return""}else if(e.ranges.length===1){return s(e.ranges[0])}else{return`(${e.ranges.map(s).join(",")})`}}function O(e){const t=n.getLibraryResourceBundle("sap.fe.core");function a(e){if(e.length===0){return""}else if(e.length===1){return e[0].label}else{let a=e[0].label;for(let t=1;t<e.length-1;t++){a+=`, ${e[t].label}`}return t.getText("C_KPICARD_ITEMSLIST",[a,e[e.length-1].label])}}return t.getText("C_KPICARD_CHARTTITLE",[a(e.chart.measures),a(e.chart.dimensions)])}function E(e,t){switch(e.chartType){case"Donut":t.categoryAxis={title:{visible:false}};t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:true,type:"value",formatString:"ShortFloat_MFD2"};break;case"bubble":t.valueAxis={title:{visible:true},label:{formatString:"ShortFloat"}};t.valueAxis2={title:{visible:true},label:{formatString:"ShortFloat"}};t.legendGroup={layout:{position:"bottom",alignment:"topLeft"}};t.sizeLegend={visible:true};t.plotArea.dataLabel={visible:false};break;case"scatter":t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.valueAxis2={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:false};break;default:t.categoryAxis={title:{visible:false}};t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:false}}}function L(e,t){if(t&&t.length){return e.filter(e=>t.indexOf(e.role)>=0).map(e=>e.label)}else{return e.map(e=>e.label)}}function M(e){const t=L(e.measures,["Axis1"]);const a=L(e.measures,["Axis2"]);const n=L(e.measures,["Axis3"]);const i=L(e.measures,[undefined]);const r=L(e.dimensions,["Series"]);const o=e.dimensions.find(e=>e.role==="Category");const s=t.shift()||a.shift()||n.shift()||i.shift()||"";const l=a.shift()||t.shift()||n.shift()||i.shift()||"";const d=[{uid:"valueAxis",type:"Measure",values:[s]},{uid:"valueAxis2",type:"Measure",values:[l]}];if(e.chartType==="bubble"){const e=n.shift()||t.shift()||a.shift()||i.shift()||"";d.push({uid:"bubbleWidth",type:"Measure",values:[e]})}if(r.length){d.push({uid:"color",type:"Dimension",values:r})}if(o){d.push({uid:"shape",type:"Dimension",values:[o.label]})}return d}function R(e){let t;switch(e.chartType){case"Donut":t=[{uid:"size",type:"Measure",values:L(e.measures)},{uid:"color",type:"Dimension",values:L(e.dimensions)}];break;case"bubble":case"scatter":t=M(e);break;case"vertical_bullet":t=[{uid:"actualValues",type:"Measure",values:L(e.measures,[undefined,"Axis1"])},{uid:"targetValues",type:"Measure",values:L(e.measures,["Axis2"])},{uid:"categoryAxis",type:"Dimension",values:L(e.dimensions,[undefined,"Category"])},{uid:"color",type:"Dimension",values:L(e.dimensions,["Series"])}];break;default:t=[{uid:"valueAxis",type:"Measure",values:L(e.measures)},{uid:"categoryAxis",type:"Dimension",values:L(e.dimensions,[undefined,"Category"])},{uid:"color",type:"Dimension",values:L(e.dimensions,["Series"])}]}return t}function _(e,t){if(e.semanticObject){if(e.action){return t.getLinks({semanticObject:e.semanticObject,action:e.action}).then(t=>t.length?{semanticObject:e.semanticObject,action:e.action}:undefined)}else{return t.getPrimaryIntent(e.semanticObject).then(a=>{if(!a){return undefined}const n=t.parseShellHash(a.intent);return e.unavailableActions&&e.unavailableActions.indexOf(n.action)>=0?undefined:{semanticObject:n.semanticObject,action:n.action}})}}else{return e.outboundNavigation?Promise.resolve({outbound:e.outboundNavigation}):Promise.resolve(undefined)}}let K=(p=v("sap.fe.core.controllerextensions.KPIManagement"),f=b(),g=b(),m=P(),p(h=(y=function(t){C(i,t);function i(){return t.apply(this,arguments)||this}var s=i.prototype;s.initCardManifest=function e(t,a){var i;const r={"sap.app":{id:"sap.fe",type:"card"},"sap.ui":{technology:"UI5"},"sap.card":{type:"Analytical",data:{json:{}},header:{type:"Numeric",title:t.datapoint.title,subTitle:t.datapoint.description,unitOfMeasurement:"{mainUnit}",mainIndicator:{number:"{mainValueNoScale}",unit:"{mainValueScale}",state:"{mainState}",trend:"{trend}"}},content:{minHeight:"25rem",chartProperties:{plotArea:{},title:{visible:true,alignment:"left"}},data:{path:"/chartData"}}}};if(t.datapoint.targetPath||t.datapoint.targetValue!==undefined){const e=n.getLibraryResourceBundle("sap.fe.core");r["sap.card"].header.sideIndicators=[{title:e.getText("C_KPICARD_INDICATOR_TARGET"),number:"{targetNumber}",unit:"{targetUnit}"},{title:e.getText("C_KPICARD_INDICATOR_DEVIATION"),number:"{deviationNumber}",unit:"%"}]}if((i=t.selectionVariantFilterDefinitions)!==null&&i!==void 0&&i.length){const e=[];t.selectionVariantFilterDefinitions.forEach(t=>{const a=V(t);if(a){e.push(a)}});if(e.length){r["sap.card"].header.details=e.join(", ")}}r["sap.card"].content.chartType=t.chart.chartType;E(t.chart,r["sap.card"].content.chartProperties);r["sap.card"].content.chartProperties.title.text=O(t);r["sap.card"].content.dimensions=t.chart.dimensions.map(e=>({label:e.label,value:`{${e.name}}`}));r["sap.card"].content.measures=t.chart.measures.map(e=>({label:e.label,value:`{${e.name}}`}));r["sap.card"].content.feeds=R(t.chart);a.setProperty(`/${t.id}`,{manifest:r})};s.initNavigationInfo=function e(t,a,n){if(t.navigation){return _(t.navigation,n).then(e=>{if(e){a.setProperty(`/${t.id}/manifest/sap.card/header/actions`,[{type:"Navigation",parameters:e}])}})}else{return Promise.resolve()}};s.onInit=function t(){var a;this.aKPIDefinitions=(a=this.getView().getController()._getPageModel())===null||a===void 0?void 0:a.getProperty("/kpiDefinitions");if(this.aKPIDefinitions&&this.aKPIDefinitions.length){const t=this.getView();const a=t.getController().getAppComponent();const n=new d;t.setModel(n,"kpiModel");this.aKPIDefinitions.forEach(t=>{this.initCardManifest(t,n);this.initNavigationInfo(t,n,a.getShellServices()).catch(function(t){e.error(t)});this.loadKPITagData(t,a.getModel(),n).catch(function(t){e.error(t)})})}};s.onExit=function e(){const t=this.getView().getModel("kpiModel");if(t){t.destroy()}};s.updateDatapointValueAndCurrency=function e(t,a,n){var i,s,l;const d=new o(sap.ui.getCore().getConfiguration().getLanguage());const u=(i=t.datapoint.unit)!==null&&i!==void 0&&i.isPath?a.getProperty(t.datapoint.unit.value):(s=t.datapoint.unit)===null||s===void 0?void 0:s.value;const c=((l=t.datapoint.unit)===null||l===void 0?void 0:l.isCurrency)===false&&u==="%";const p=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));const f=r.getFloatInstance({style:c?undefined:"short",minFractionDigits:0,maxFractionDigits:1,showScale:!c},d).format(p);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValue`,f);const g=r.getFloatInstance({maxFractionDigits:2,showScale:false,groupingEnabled:true},d).format(p);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueUnscaled`,g);const m=r.getFloatInstance({style:c?undefined:"short",minFractionDigits:0,maxFractionDigits:1,showScale:false},d).format(p);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueNoScale`,m);const h=r.getFloatInstance({style:c?undefined:"short",decimals:0,maxIntegerDigits:0,showScale:true},d).format(p);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueScale`,h);if(t.datapoint.unit&&u){if(t.datapoint.unit.isCurrency){n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainUnit`,u)}else{const e=r.getUnitInstance({showNumber:false},d).format(p,u);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainUnit`,e)}}};s.updateDatapointCriticality=function e(t,a,n){const i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));let r=D.None;if(t.datapoint.criticalityValue){r=t.datapoint.criticalityValue}else if(t.datapoint.criticalityPath){r=$[a.getProperty(t.datapoint.criticalityPath)]||D.None}else if(t.datapoint.criticalityCalculationThresholds&&t.datapoint.criticalityCalculationMode){switch(t.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":r=S(i,t.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Minimize":r=j(i,t.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Maximize":default:r=w(i,t.datapoint.criticalityCalculationThresholds);break}}n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainCriticality`,r);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainState`,T[r]||"None")};s.updateDatapointTrend=function e(t,a,n){const i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));let r="None";if(t.datapoint.trendValue){r=t.datapoint.trendValue}else if(t.datapoint.trendPath){r=x(a.getProperty(t.datapoint.trendPath))}else if(t.datapoint.trendCalculationReferenceValue!==undefined||t.datapoint.trendCalculationReferencePath){let e;if(t.datapoint.trendCalculationReferenceValue!==undefined){e=t.datapoint.trendCalculationReferenceValue}else{e=Number.parseFloat(a.getProperty(t.datapoint.trendCalculationReferencePath||""))}r=A(i,e,!!t.datapoint.trendCalculationIsRelative,t.datapoint.trendCalculationTresholds)}n.setProperty(`/${t.id}/manifest/sap.card/data/json/trend`,r)};s.updateTargetValue=function e(t,a,n){if(t.datapoint.targetValue===undefined&&t.datapoint.targetPath===undefined){return}const i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));const s=new o(sap.ui.getCore().getConfiguration().getLanguage());let l;if(t.datapoint.targetValue!==undefined){l=t.datapoint.targetValue}else{l=Number.parseFloat(a.getProperty(t.datapoint.targetPath||""))}const d=l!==0?(i-l)/l*100:undefined;const u=r.getFloatInstance({style:"short",minFractionDigits:0,maxFractionDigits:1,showScale:false},s).format(l);const c=r.getFloatInstance({style:"short",decimals:0,maxIntegerDigits:0,showScale:true},s).format(l);n.setProperty(`/${t.id}/manifest/sap.card/data/json/targetNumber`,u);n.setProperty(`/${t.id}/manifest/sap.card/data/json/targetUnit`,c);if(d!==undefined){const e=r.getFloatInstance({minFractionDigits:0,maxFractionDigits:1,showScale:false},s).format(d);n.setProperty(`/${t.id}/manifest/sap.card/data/json/deviationNumber`,e)}else{n.setProperty(`/${t.id}/manifest/sap.card/data/json/deviationNumber`,"N/A")}};s.loadKPITagData=function e(t,a,n,i){var r,o;const s=i?a.bindList(`/${t.entitySet}`,undefined,undefined,undefined,{$$groupId:"$auto.Workers"}):a.bindList(`/${t.entitySet}`,undefined,undefined,undefined,{$$groupId:"$auto.LongRunners"});const l={};if((r=t.datapoint.unit)!==null&&r!==void 0&&r.isPath){l[t.datapoint.propertyPath]={unit:t.datapoint.unit.value}}else{l[t.datapoint.propertyPath]={}}if(t.datapoint.criticalityPath){l[t.datapoint.criticalityPath]={}}if(i){if(t.datapoint.trendPath){l[t.datapoint.trendPath]={}}if(t.datapoint.trendCalculationReferencePath){l[t.datapoint.trendCalculationReferencePath]={}}if(t.datapoint.targetPath){l[t.datapoint.targetPath]={}}}s.setAggregation({aggregate:l});if((o=t.selectionVariantFilterDefinitions)!==null&&o!==void 0&&o.length){const e=t.selectionVariantFilterDefinitions.map(F).filter(e=>e!==undefined);s.filter(e)}return s.requestContexts(0,1).then(e=>{if(e.length){var a,r;const o=(a=t.datapoint.unit)!==null&&a!==void 0&&a.isPath?e[0].getProperty(t.datapoint.unit.value):(r=t.datapoint.unit)===null||r===void 0?void 0:r.value;if(t.datapoint.unit&&!o){n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValue`,"*");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueUnscaled`,"*");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueNoScale`,"*");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueScale`,"");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainUnit`,undefined);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainCriticality`,D.None);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainState`,"None");n.setProperty(`/${t.id}/manifest/sap.card/data/json/trend`,"None");n.setProperty(`/${t.id}/manifest/sap.card/data/json/targetNumber`,undefined);n.setProperty(`/${t.id}/manifest/sap.card/data/json/targetUnit`,undefined);n.setProperty(`/${t.id}/manifest/sap.card/data/json/deviationNumber`,undefined)}else{this.updateDatapointValueAndCurrency(t,e[0],n);this.updateDatapointCriticality(t,e[0],n);if(i){this.updateDatapointTrend(t,e[0],n);this.updateTargetValue(t,e[0],n)}}}})};s.loadKPICardData=function e(t,a,n){var i;const r=a.bindList(`/${t.entitySet}`,undefined,undefined,undefined,{$$groupId:"$auto.Workers"});const o={};const s={};t.chart.dimensions.forEach(e=>{o[e.name]={}});t.chart.measures.forEach(e=>{s[e.name]={}});r.setAggregation({group:o,aggregate:s});if((i=t.selectionVariantFilterDefinitions)!==null&&i!==void 0&&i.length){const e=t.selectionVariantFilterDefinitions.map(F).filter(e=>e!==undefined);r.filter(e)}if(t.chart.sortOrder){r.sort(t.chart.sortOrder.map(e=>new u(e.name,e.descending)))}return r.requestContexts(0,t.chart.maxItems).then(e=>{const a=e.map(function(e){const a={};t.chart.dimensions.forEach(t=>{a[t.name]=e.getProperty(t.name)});t.chart.measures.forEach(t=>{a[t.name]=e.getProperty(t.name)});return a});n.setProperty(`/${t.id}/manifest/sap.card/data/json/chartData`,a)})};s.getPopover=function e(t){if(!this.oPopover){return new Promise((e,i)=>{n.loadLibrary("sap/ui/integration",{async:true}).then(()=>{sap.ui.require(["sap/ui/integration/widgets/Card","sap/ui/integration/Host"],(n,i)=>{const r=new i;r.attachAction(e=>{const t=e.getParameter("type");const a=e.getParameter("parameters");if(t==="Navigation"){if(a.semanticObject){this.getView().getController()._intentBasedNavigation.navigate(a.semanticObject,a.action)}else{this.getView().getController()._intentBasedNavigation.navigateOutbound(a.outbound)}}});this.oCard=new n({width:"25rem",height:"auto"});this.oCard.setHost(r);this.oPopover=new a("kpi-Popover",{showHeader:false,placement:"Auto",content:[this.oCard]});t.addDependent(this.oPopover);e(this.oPopover)})}).catch(function(){i()})})}else{return Promise.resolve(this.oPopover)}};s.onKPIPressed=function t(a,n){const i=a.getModel("kpiModel");if(this.aKPIDefinitions&&this.aKPIDefinitions.length){const t=this.aKPIDefinitions.find(function(e){return e.id===n});if(t){const r=a.getModel();const o=[this.loadKPITagData(t,r,i,true),this.loadKPICardData(t,r,i),this.getPopover(a)];Promise.all(o).then(e=>{this.oCard.setManifest(i.getProperty(`/${n}/manifest`));this.oCard.refresh();const t=e[2];t.openBy(a,false)}).catch(t=>{e.error(t)})}}};return i}(s),N(y.prototype,"onInit",[f],Object.getOwnPropertyDescriptor(y.prototype,"onInit"),y.prototype),N(y.prototype,"onExit",[g],Object.getOwnPropertyDescriptor(y.prototype,"onExit"),y.prototype),N(y.prototype,"onKPIPressed",[m],Object.getOwnPropertyDescriptor(y.prototype,"onKPIPressed"),y.prototype),y))||h);return K},false);