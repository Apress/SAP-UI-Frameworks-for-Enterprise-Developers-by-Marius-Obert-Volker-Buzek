/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","sap/ui/core/util/XMLPreprocessor"],function(t,e,n){"use strict";var r=e.bindingParser;const i=[];const o="http://schemas.sap.com/sapui5/extension/sap.fe.info/1",a="http://www.w3.org/2000/xmlns/",s=location.search.indexOf("sap-ui-xx-feTraceInfo=true")>-1,c=["sap.m","sap.uxap","sap.ui.unified","sap.f","sap.ui.table","sap.suite.ui.microchart","sap.ui.layout.form","sap.ui.mdc","sap.ui.mdc.link","sap.ui.mdc.field","sap.fe.fpm"],u={};function f(t){return JSON.parse(JSON.stringify(t))}async function l(t,e,n,i){let o;const a=[];try{o=r(t,undefined,false,true)||[]}catch(t){o=[]}o=Array.isArray(o)?o:[o];o.filter(function(t){return t.path||t.parts}).forEach(function(t){const r=t.parts||[t];r.filter(function(t){return t.path}).forEach(function(t){const r=e[t.model]=e[t.model]||{};const o=t.path.indexOf(">")<0?(t.model&&`${t.model}>`)+t.path:t.path;let s;let c;if(typeof t.model==="undefined"&&o.indexOf(">")>-1){c=o.split(">");t.model=c[0];t.path=c[1]}try{s=n.getContext(o);const e=n.getResult(`{${o}}`,i);a.push(e.then(function(e){var n;if(((n=s)===null||n===void 0?void 0:n.getModel().getMetadata().getName())==="sap.ui.model.json.JSONModel"){if(!e.getModel()){r[t.path]=e}else{r[t.path]=`Context from ${e.getPath()}`}}else{r[t.path]={path:s.getPath(),data:typeof e==="object"?"[ctrl/cmd-click] on path to see data":e}}return}).catch(function(){r[t.path]={bindingFor:"Runtime"}}))}catch(e){r[t.path]={bindingFor:"Runtime"}}})});return Promise.all(a)}async function p(t,e,n,r){return t.then(function(t){e[n]=r!==t?{originalValue:r,resolvedValue:t}:r;return}).catch(function(t){const i=t;e[n]={originalValue:r,error:i.stack&&i.stack.toString()||t}})}async function h(t,e){const n={};const r=[];const i={};let o;for(let a=t.attributes.length>>>0;a--;){const s=t.attributes[a],c=s.nodeName,u=t.getAttribute(c);if(!["core:require"].includes(c)){r.push(l(u,i,e,t));o=e.getResult(u,t);if(o){r.push(p(o,n,c,u))}else{}}}return Promise.all(r).then(function(){return{properties:n,contexts:i}})}async function d(e,n){try{const t=e.nodeName.split(":")[1]||e.nodeName,r=/^[A-Z]/.test(t),s={isError:false,control:`${e.namespaceURI}.${e.nodeName.split(":")[1]||e.nodeName}`,metaDataContexts:[],properties:{}};if(r){const t=[...e.ownerDocument.children].find(t=>!t.nodeName.startsWith("#"));if(t&&!t.getAttribute("xmlns:trace")){t.setAttributeNS(a,"xmlns:trace",o);t.setAttributeNS(o,"trace:is","on")}return await h(e,n).then(async function(t){const r=Object.keys(t.contexts).length>0;if(r){Object.assign(s,t);s.viewInfo=n.getViewInfo();s.macroInfo=n.getSettings()["_macroInfo"];s.traceID=i.length;e.setAttributeNS(o,"trace:traceID",s.traceID.toString());i.push(s)}return n.visitAttributes(e)}).then(async function(){return n.visitChildNodes(e)}).catch(function(t){s.error={exception:t,node:(new XMLSerializer).serializeToString(e)}})}else{await n.visitAttributes(e);await n.visitChildNodes(e)}}catch(r){t.error(`Error while tracing '${e===null||e===void 0?void 0:e.nodeName}': ${r.message}`,"TraceInfo");return n.visitAttributes(e).then(async function(){return n.visitChildNodes(e)})}}if(s){c.forEach(function(t){u[t]=n.plugIn(d.bind(t),t)})}function m(t,e,n,r,s){try{let c=e.metadataContexts&&Object.keys(e.metadataContexts)||[];const u=e.properties&&Object.keys(e.properties)||[];const l=f(s.getSettings()["_macroInfo"]||{});const p={isError:false,macro:t,metaDataContexts:[],properties:{}};if(c.length===0){c=Object.keys(n).filter(function(t){return t!=="this"})}if(!r.getAttribute("xmlns:trace")){r.setAttributeNS(a,"xmlns:trace",o)}if(c.length>0){c.forEach(function(t){const e=n[t],r=e&&{name:t,path:e.getPath()};if(r){p.metaDataContexts.push(r)}});u.forEach(function(t){const e=n.this.getObject(t);if(e){p.properties[t]=e}});p.viewInfo=s.getViewInfo();p.traceID=i.length;l.parentMacroID=l.macroID;l.macroID=p.traceID.toString();p.macroInfo=l;r.setAttributeNS(o,"trace:macroID",p.traceID.toString());i.push(p);return p}}catch(e){var c;return{isError:true,error:e,name:t,node:(new XMLSerializer).serializeToString(r),contextPath:s===null||s===void 0?void 0:(c=s.getContext())===null||c===void 0?void 0:c.getPath()}}}function g(t){if(t){return i[t]}const e=i.filter(function(t){return t.error});return e.length>0&&e||i}function b(){return s}return{isTraceInfoActive:b,traceMacroCalls:m,getTraceInfo:g}},true);