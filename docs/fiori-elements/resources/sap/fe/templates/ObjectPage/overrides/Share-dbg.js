/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/core/routing/HashChanger","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,n,i,s,o){"use strict";let r;function l(e,t){const n=Object.keys(e);const i=n.map(function(t){const n=e[t];if(n!==undefined){return new s(t,o.EQ,n)}});if(t){const e=new s({filters:[new s("SiblingEntity/IsActiveEntity",o.EQ,true)],and:false});i.push(e)}return new s(i,true)}function a(e,t,n){const i=e.getView().getBindingContext().getModel().bindList(`/${t}`,undefined,undefined,n,{$$groupId:"$auto.Heroes"});return i.requestContexts(0,2).then(function(e){if(e&&e.length){return e[0].getPath()}})}function c(e,t,n){const s=[];const o=[];let r=e.getModel().getMetaModel().getMetaPath(e.getPath());if(r.indexOf("/")===0){r=r.substring(1)}const c=r.split("/");const u=i.getInstance().getHash().split("?")[0];const g=u.split("/");const f={};const d=[];g.forEach(function(t){const n=t.substring(t.indexOf("(")+1,t.length-1).split(",");const i={};const s=t.split("(")[0];f[s]={};d.push(s);f[s]["bIsActiveEntityDefined"]=true;for(let s=0;s<n.length;s++){const o=n[s];const r=o.split("=");let l=r[1];let a=r[0];if(o.indexOf("=")===-1){const n=e.getModel().getMetaModel();const i=n.getObject(`/${d.join("/")}/$Type/$Key`);l=r[0];a=i[0];f[t.split("(")[0]]["bIsActiveEntityDefined"]=false}if(a!=="IsActiveEntity"){if(l.indexOf("'")===0&&l.lastIndexOf("'")===l.length-1){l=decodeURIComponent(l.substring(1,l.length-1))}i[a]=l}}f[s].mKeyValues=i});let p=n;c.forEach(function(t){const i={};const s=p.$NavigationPropertyBinding&&p.$NavigationPropertyBinding[t];if(s){i.pageEntityName=p.$NavigationPropertyBinding[t];p=e.getModel().getMetaModel().getObject(`/${s}`)||n}else{i.pageEntityName=t}i.mKeyValues=f[t].mKeyValues;i.bIsActiveEntityDefined=f[t].bIsActiveEntityDefined;o.push(i)});o.forEach(function(e){const n=l(e.mKeyValues,e.bIsActiveEntityDefined);s.push(a(t,e.pageEntityName,n))});return s}function u(t,n){const s=i.getInstance().getHash().split("?")[0];let o=s&&s.substr(0,s.indexOf("("));if(o.indexOf("/")===0){o=o.substring(1)}const r=t.getModel().getMetaModel().getObject(`/${o}`);const l=t;const a=c(t,n,r);if(a.length>0){return Promise.all(a).then(function(e){const t=[];let n=r;if(e[0].indexOf("/")===0){t.push(e[0].substring(1))}else{t.push(e[0])}for(let i=1;i<e.length;i++){let s=e[i];let o="";let a=s&&s.substr(0,s.indexOf("("));if(a.indexOf("/")===0){a=a.substring(1)}if(s.indexOf("/")===0){s=s.substring(1)}o=Object.keys(n.$NavigationPropertyBinding)[Object.values(n.$NavigationPropertyBinding).indexOf(a)];if(o){t.push(s.replace(a,o));n=l.getModel().getMetaModel().getObject(`/${a}`)||r}else{t.push(s)}}return t}).catch(function(t){e.info("Failed to retrieve one or more active context path's",t)})}else{return Promise.resolve()}}function g(e,s){let o,l;const a=i.getInstance().getHash().split("?")[0];if(e){const i=e.getModel();const s=i.getMetaModel();r=t.isStickySessionSupported(s);let o=a&&a.substr(0,a.indexOf("("));if(o.indexOf("/")===0){o=o.substring(1)}l=n.getSemanticKeys(s,o)}const c=s.getView().getViewData();if(e&&!r&&(c.viewLevel===1&&!l||c.viewLevel>=2)){o=u(e,s);return o}else{return Promise.resolve()}}function f(e,t,n){let s;const o=i.getInstance().getHash();const r=i.getInstance().hrefForAppSpecificHash?i.getInstance().hrefForAppSpecificHash(""):"";if(e&&!t&&n){s=r+n.join("/")}else{s=o?r+o:window.location.hash}return window.location.origin+window.location.pathname+window.location.search+s}function d(){const t=sap.ushell&&sap.ushell.Container;if(t){return t.getFLPUrlAsync(true).then(function(e){return e}).catch(function(t){e.error("Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)",t)})}else{return Promise.resolve(document.URL)}}function p(t,n,s){let o;const r=i.getInstance().getHash();const l=i.getInstance().hrefForAppSpecificHash?i.getInstance().hrefForAppSpecificHash(""):"";if(t&&!n&&s){o=l+s.join("/")}else{o=r?l+r:window.location.hash}if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.runningInIframe&&sap.ushell.Container.runningInIframe()){sap.ushell.Container.getFLPUrl(true).then(function(e){return e.substr(0,e.indexOf("#"))+o}).catch(function(t){e.error("Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)",t)})}else{return Promise.resolve(window.location.origin+window.location.pathname+o)}}const h={adaptShareMetadata:async function(t){const n=this.base.getView().getBindingContext();const i=this.base.getView().getModel("ui");const s=i.getProperty("/isEditable");try{const e=await g(n,this.base.getView().getController());const i=this.base.getView().getController()._getPageTitleInformation();const o=await Promise.all([p(s,r,e),f(s,r,e),d()]);let l=i.title;const a=i.subtitle?i.subtitle.toString():"";if(a){l=`${l} - ${a}`}t.tile={title:i.title,subtitle:a};t.email.title=l;t.title=l;t.jam.url=o[0];t.url=o[1];t.email.url=o[2];const c=this.base.getView().getModel("collaborationInfo");c.setProperty("/url",t.url);c.setProperty("/appTitle",t.title);c.setProperty("/subTitle",a)}catch(t){e.error(t)}return t}};return h},false);