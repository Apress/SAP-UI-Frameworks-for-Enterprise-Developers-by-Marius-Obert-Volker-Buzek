/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/library","sap/fe/core/templating/PropertyFormatters","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/FilterUtils","sap/fe/navigation/library","sap/ui/Device","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/p13n/StateUtil"],function(t,e,a,n,i,r,o,s,l,d,c,f,u){"use strict";var h=d.system;const g=l.NavType,p=i.VariantManagement,V=i.TemplateContentView,C=i.InitialLoadMode,_=/\+|\*/g;const y={_bSearchTriggered:false,applyInitialStateOnly:function(){return true},onBeforeStateApplied:function(t){const e=this.getView(),a=e.getController(),n=a._getFilterBarControl(),i=a._getControls("table");if(n){n.setSuspendSelection(true);t.push(n.waitForInitialization())}i.forEach(function(e){t.push(e.initialized())});delete this._bSearchTriggered},onAfterStateApplied:function(){const t=this.getView().getController();const e=t._getFilterBarControl();if(e){e.setSuspendSelection(false)}else if(t._isFilterBarHidden()){const e=t.getView().getBindingContext("internal");e.setProperty("hasPendingFilters",false);if(t._isMultiMode()){t._getMultiModeControl().setCountsOutDated(true)}}},adaptBindingRefreshControls:function(t){const e=this.getView(),n=e.getController(),i=n._getControls(),r=a.getControlsForRefresh(e,i);Array.prototype.push.apply(t,r)},adaptStateControls:function(t){const e=this.getView(),a=e.getController(),n=e.getViewData(),i=n.variantManagement===p.Control;const r=this._getFilterBarVM(e);if(r){t.push(r)}if(a._isMultiMode()){t.push(a._getMultiModeControl())}a._getControls("table").forEach(function(e){const a=e.getQuickFilter();if(a){t.push(a)}if(i){t.push(e.getVariant())}t.push(e)});if(a._getControls("Chart")){a._getControls("Chart").forEach(function(e){if(i){t.push(e.getVariant())}t.push(e)})}if(a._hasMultiVisualizations()){t.push(a._getSegmentedButton(V.Chart));t.push(a._getSegmentedButton(V.Table))}const o=a._getFilterBarControl();if(o){t.push(o)}t.push(e.byId("fe::ListReport"))},retrieveAdditionalStates:function(t){const e=this.getView(),a=e.getController(),n=e.getBindingContext("internal").getProperty("hasPendingFilters");t.dataLoaded=!n||!!this._bSearchTriggered;if(a._hasMultiVisualizations()){const a=e.getBindingContext("internal").getProperty("alpContentView");t.alpContentView=a}delete this._bSearchTriggered},applyAdditionalStates:function(t){const e=this.getView(),a=e.getController(),n=a._getFilterBarControl();if(t){if(t.dataLoaded===false&&n){n._bSearchTriggered=false}else if(t.dataLoaded===true){if(n){n.triggerSearch()}this._bSearchTriggered=true}if(a._hasMultiVisualizations()){const a=e.getBindingContext("internal");if(!h.desktop&&t.alpContentView==V.Hybrid){t.alpContentView=V.Chart}a.getModel().setProperty(`${a.getPath()}/alpContentView`,t.alpContentView)}}},_applyNavigationParametersToFilterbar:function(e,a){const n=this.getView();const i=n.getController();const r=i.getAppComponent();const o=r.getComponentData();const s=o&&o.startupParameters||{};const l=this.handleVariantIdPassedViaURLParams(s);let d;a.push(l.then(t=>{if(t&&t.length>0){if(t[0]===true||t[1]===true){d=true}}return this._applySelectionVariant(n,e,d)}).then(()=>{const t=i._getDynamicListReportControl();let a=false;const r=this._getFilterBarVM(n);const o=i._getFilterBarControl();if(o){if(e.navigationType!==g.initial&&e.requiresStandardVariant||!r&&n.getViewData().initialLoad===C.Enabled||i._shouldAutoTriggerSearch(r)){o.triggerSearch()}else{a=this._preventInitialSearch(r)}o.setSuspendSelection(false);this._bSearchTriggered=!a;t.setHeaderExpanded(h.desktop||a)}}).catch(function(){t.error("Variant ID cannot be applied")}))},handleVariantIdPassedViaURLParams:function(t){const e=t["sap-ui-fe-variant-id"],a=t["sap-ui-fe-filterbar-variant-id"],n=t["sap-ui-fe-table-variant-id"],i=t["sap-ui-fe-chart-variant-id"];let r;if(e||a||n||i){r={sPageVariantId:e&&e[0],sFilterBarVariantId:a&&a[0],sTableVariantId:n&&n[0],sChartVariantId:i&&i[0]}}return this._handleControlVariantId(r)},_handleControlVariantId:function(t){let e;const a=this.getView(),n=[];const i=a.getViewData().variantManagement;if(t&&t.sPageVariantId&&i==="Page"){e=a.byId("fe::PageVariantManagement");this._handlePageVariantId(t,e,n)}else if(t&&i==="Control"){if(t.sFilterBarVariantId){e=a.getController()._getFilterBarVariantControl();this._handleFilterBarVariantControlId(t,e,n)}if(t.sTableVariantId){const e=a.getController();this._handleTableControlVariantId(t,e,n)}if(t.sChartVariantId){const e=a.getController();this._handleChartControlVariantId(t,e,n)}}return Promise.all(n)},_handlePageVariantId:function(t,e,a){e.getVariants().forEach(n=>{this._findAndPushVariantToPromise(n,t.sPageVariantId,e,a,true)})},_handleFilterBarVariantControlId:function(t,e,a){if(e){e.getVariants().forEach(n=>{this._findAndPushVariantToPromise(n,t.sFilterBarVariantId,e,a,true)})}},_handleTableControlVariantId:function(t,e,a){const n=e._getControls("table");n.forEach(e=>{const n=e.getVariant();if(e&&n){n.getVariants().forEach(e=>{this._findAndPushVariantToPromise(e,t.sTableVariantId,n,a)})}})},_handleChartControlVariantId:function(t,e,a){const n=e._getControls("Chart");n.forEach(e=>{const n=e.getVariant();const i=n.getVariants();if(i){i.forEach(e=>{this._findAndPushVariantToPromise(e,t.sChartVariantId,n,a)})}})},_findAndPushVariantToPromise:function(t,e,a,n,i){if(t.key===e){n.push(this._applyControlVariant(a,e,i))}},_applyControlVariant:function(t,e,a){const n=this._checkIfVariantIdIsAvailable(t,e)?e:t.getStandardVariantKey();const i=c.activateVariant({element:t,variantReference:n});return i.then(function(){return a})},_getFilterBarVM:function(t){const e=t.getViewData();switch(e.variantManagement){case p.Page:return t.byId("fe::PageVariantManagement");case p.Control:return t.getController()._getFilterBarVariantControl();case p.None:return null;default:throw new Error(`unhandled variant setting: ${e.variantManagement}`)}},_preventInitialSearch:function(t){if(!t){return true}const e=t.getVariants();const a=e.find(function(e){return e.key===t.getCurrentVariantKey()});return!a.executeOnSelect},_applySelectionVariant:function(t,a,n){const i=t.getController()._getFilterBarControl(),r=a.selectionVariant,o=a.selectionVariantDefaults;if(!i||!r){return Promise.resolve()}let s={};const l=t.getModel().getMetaModel();const d=t.getViewData();const c=d.contextPath||`/${d.entitySet}`;const f=e.getMandatoryFilterFields(l,c);const u=i.data("useSemanticDateRange");let h;switch(d.variantManagement){case p.Page:h=t.byId("fe::PageVariantManagement");break;case p.Control:h=t.getController()._getFilterBarVariantControl();break;case p.None:default:break}const g=a.requiresStandardVariant;const V=o&&o.getSelectOptionsPropertyNames().length>0&&h.getDefaultVariantKey()===h.getStandardVariantKey()&&a.bNavSelVarHasDefaultsOnly;if(n||V){s=i.getConditions()}e.addDefaultDisplayCurrency(f,r,o);e.addSelectionVariantToConditions(r,s,l,c,V,u,d);return this._activateSelectionVariant(i,s,h,g,n,V)},_activateSelectionVariant:function(t,e,a,n,i,r){let o;if(a&&!i){let t=n?a.getStandardVariantKey():a.getDefaultVariantKey();if(t===null){t=a.getId()}o=c.activateVariant({element:a,variantReference:t}).then(function(){return n||a.getDefaultVariantKey()===a.getStandardVariantKey()})}else{o=Promise.resolve(true)}return o.then(a=>{if(a){return this._fnApplyConditions(t,e,r)}})},_fnClearStateBeforexAppNav:async function(e){return await u.retrieveExternalState(e).then(t=>{const e=t.filter;for(const t in e){if(t!=="$editState"&&t!=="$search"&&e[t]){e[t].forEach(t=>{t["filtered"]=false})}}return Promise.resolve(e)}).catch(function(e){t.error("Error while retrieving the external state",e)})},_fnApplyConditions:async function(t,a,i){const l={},d=[],c=function(t){t.validated=f.Validated;if(t.operator==="Empty"){t.operator="EQ";t.values=[""]}else if(t.operator==="NotEmpty"){t.operator="NE";t.values=[""]}delete t.isEmpty};const h=function(t,a){const i=n.getEntitySetPath(a),o=t.getModel().getMetaModel(),l=e.getFilterRestrictionsByPath(i,o),d=l.NonFilterableProperties,c=s.getConvertedFilterFields(t,a),f=[];c.forEach(function(t){const e=t.conditionPath.replace(_,"");if(d.indexOf(e)===-1){const e=t.annotationPath;const a=o.createBindingContext(e);f.push({path:t.conditionPath,hiddenFilter:t.availability==="Hidden",hasValueHelp:!e?false:r.hasValueHelp(a.getObject(),{context:a})})}});return f};return t.waitForInitialization().then(async()=>{const e=o.getCustomData(t,"entityType");if(!i){const e=await this._fnClearStateBeforexAppNav(t);await u.applyExternalState(t,{filter:e,items:d})}const n=h(t,e);n.filter(function(t){return t.path!=="$editState"&&t.path!=="$search"}).forEach(t=>{if(t.path in a){l[t.path]=this._fnDecodeConditionsValues(a[t.path]);if(!t.hiddenFilter){d.push({name:t.path})}if(t.hasValueHelp){l[t.path].forEach(c)}else{l[t.path].forEach(function(t){t.validated=t.filtered?f.NotValidated:t.validated})}}else{l[t.path]=[]}});return u.applyExternalState(t,{filter:l,items:d})})},_isEncoded:function(t){return decodeURI(t)!==t},_decodeValue:function(t){let e=t;let a="";while(this._isEncoded(e)&&e!==a){a=e;e=decodeURI(e)}return e},_fnDecodeConditionsValues:function(t){const e=t.filter(t=>t.values);e.forEach(t=>{t.values=t.values.map(t=>{if(typeof t==="string"){return this._decodeValue(t)}else{return t}})});return t}};return y},false);